rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // --- Legacy rules (commented out for shows, tasks, props) ---
    /*
    // match /tasks/{taskId} {
    //   allow read, write: if request.auth != null && (
    //     request.auth.uid == resource.data.ownerId ||
    //     request.auth.uid == resource.data.assignedTo
    //   );
    // }
    // match /shows/{showId} {
    //   allow read, write: if request.auth != null && request.auth.uid == resource.data.ownerId;
    // }
    // match /props/{propId} {
    //   allow read: if request.auth != null;
    //   allow write: if request.auth != null && request.auth.uid == resource.data.userId;
    // }
    */
    // --- End legacy rules ---

    match /tasks/{taskId}/comments/{commentId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && request.auth.uid == resource.data.ownerId);
    }
    match /shows/{showId}/notes/{noteId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && request.auth.uid == resource.data.ownerId);
    }
    match /userProfiles/{userId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && request.auth.uid == userId);
    }
    match /users/{userId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && request.auth.uid == userId);
    }
    match /packingBoxes/{boxId} {
      allow read, write: if isSystemAdmin() || (request.auth != null &&
        get(/databases/$(database)/documents/shows/$(resource.data.showId)).data.ownerId == request.auth.uid);
    }
    match /packLists/{packListId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && request.auth.uid == resource.data.ownerId);
    }
    match /packs/{packId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && request.auth.uid == resource.data.ownerId);
    }
    match /locations/{locationId} {
      allow read, write: if isSystemAdmin() || (request.auth != null &&
        get(/databases/$(database)/documents/shows/$(resource.data.showId)).data.ownerId == request.auth.uid);
    }
    match /labels/{labelId} {
      allow read, write: if isSystemAdmin() || (request.auth != null &&
        get(/databases/$(database)/documents/shows/$(resource.data.showId)).data.ownerId == request.auth.uid);
    }
    match /todo_boards/{boardId} {
      // User must be in sharedWith to read/update/delete.
      allow read, update, delete: if isSystemAdmin() || (
        request.auth != null &&
        resource.data.sharedWith != null &&
        request.auth.uid in resource.data.sharedWith
      );
      // On create, creator must be owner and be in sharedWith.
      allow create: if isSystemAdmin() || (
        request.auth != null &&
        request.resource.data.ownerId == request.auth.uid &&
        request.resource.data.sharedWith != null &&
        request.auth.uid in request.resource.data.sharedWith
      );
    }
    match /todo_boards/{boardId}/lists/{listId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && isBoardMember(boardId));
    }
    match /todo_boards/{boardId}/lists/{listId}/cards/{cardId} {
      allow read: if isSystemAdmin() || (request.auth != null && isBoardMember(boardId));
      allow update, delete: if isSystemAdmin() || (request.auth != null && isBoardMember(boardId));
      allow create: if isSystemAdmin() || (request.auth != null && isBoardMember(boardId));
    }
    match /todo_boards/{boardId}/members/{memberId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && isBoardMember(boardId));
    }
    match /propsTab/{docId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && request.auth.uid == resource.data.userId);
    }
    match /props_native/{docId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && request.auth.uid == resource.data.userId);
    }
    match /props_shared_details/{docId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && request.auth.uid == resource.data.userId);
    }
    match /shows/{showId} {
      allow read: if isSystemAdmin() || (request.auth != null);
      allow update, delete: if isSystemAdmin() || (request.auth != null && (
        request.auth.uid == resource.data.ownerId ||
        request.auth.uid == resource.data.userId ||
        resource.data.team[request.auth.uid] == "god" ||
        resource.data.team[request.auth.uid] == "props_supervisor"
      ));
      allow create: if isSystemAdmin() || request.auth != null;
    
      match /team/{teamMemberId} {
        allow read: if isSystemAdmin() || (request.auth != null && get(/databases/$(database)/documents/shows/$(showId)).data.team[request.auth.uid] != null);
        allow write: if isSystemAdmin() || (request.auth != null && (
          get(/databases/$(database)/documents/shows/$(showId)).data.team[request.auth.uid] == "god" ||
          get(/databases/$(database)/documents/shows/$(showId)).data.team[request.auth.uid] == "props_supervisor"
        ));
      }
    }
    match /invitations/{inviteId} {
      // Create allowed for inviter, show owner, or team admins
      allow create: if isSystemAdmin() || (request.auth != null && (
        // The user creating the invite is the inviter
        request.resource.data.inviterId == request.auth.uid ||
        // Or the user owns the show
        request.auth.uid == get(/databases/$(database)/documents/shows/$(request.resource.data.showId)).data.ownerId ||
        request.auth.uid == get(/databases/$(database)/documents/shows/$(request.resource.data.showId)).data.userId ||
        // Or the user is an admin on the show
        hasTeamRole(request.resource.data.showId, 'god') ||
        hasTeamRole(request.resource.data.showId, 'props_supervisor')
      ));

      // Read public so recipients can open the link without being on the team yet
      allow read: if true;

      // Update/delete allowed for inviter or show admins
      allow update, delete: if isSystemAdmin() || (request.auth != null && (
        request.auth.uid == resource.data.inviterId ||
        hasTeamRole(resource.data.showId, 'god') ||
        hasTeamRole(resource.data.showId, 'props_supervisor')
      ));
    }
    match /tasks/{taskId} {
      allow read, write: if isSystemAdmin() || (request.auth != null && (
          get(/databases/$(database)/documents/shows/$(resource.data.showId)).data.team[request.auth.uid] != null ||
          resource.data.createdBy == request.auth.uid ||
          request.auth.uid in resource.data.assignedTo
      ));
      allow update, delete: if isSystemAdmin() || (request.auth != null && (
        resource.data.assignedTo == request.auth.uid ||
        resource.data.createdBy == request.auth.uid ||
        get(/databases/$(database)/documents/shows/$(resource.data.showId)).data.team[request.auth.uid] == "god" ||
        get(/databases/$(database)/documents/shows/$(resource.data.showId)).data.team[request.auth.uid] == "props_supervisor"
      ));
    }
    match /props/{propId} {
      allow read, write: if isSystemAdmin() ||
        (request.auth != null &&
          (
            isTeamMember(resource.data.showId) ||
            get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == "god"
          )
        );

      allow update, delete: if isSystemAdmin() ||
        (request.auth != null &&
          (
            hasTeamRole(resource.data.showId, 'god') ||
            hasTeamRole(resource.data.showId, 'props_supervisor') ||
            get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == "god"
          )
        );
    }

    // --- Collaborative Team & Role-Based Access Rules (ACTIVE) ---
    // These rules assume each show document has a 'team' map: { [userId]: role }
    // Remove or comment out any function definitions and .where() usage (not supported in Firestore rules)

    function isBoardMember(boardId) {
      return get(/databases/$(database)/documents/todo_boards/$(boardId)).data.ownerId == request.auth.uid || 
             request.auth.uid in get(/databases/$(database)/documents/todo_boards/$(boardId)).data.sharedWith;
    }

    // Safely checks for system-admin role by providing default empty maps/values
    // to prevent null reference errors if the fields don't exist.
    function isSystemAdmin() {
      return request.auth.uid != null &&
        get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.get('groups', {})
          .get('system-admin', false) == true;
    }

    // Function to check if a user is a member of the show's team
    function isTeamMember(showId) {
      // A user is a team member if their UID exists as a key in the show's 'team' map.
      return get(/databases/$(database)/documents/shows/$(showId)).data.team[request.auth.uid] != null;
    }

    // Function to check if a user has a specific role in the show's team
    function hasTeamRole(showId, role) {
      return get(/databases/$(database)/documents/shows/$(showId)).data.team[request.auth.uid] == role;
    }

    // Function to check if a user is an owner of a document
    function isOwner(docId, collectionName) {
      // Checks if the requesting user's UID matches the 'ownerId' field of the specified document.
      return get(/databases/$(database)/documents/$(collectionName)/$(docId)).data.ownerId == request.auth.uid;
    }

    // Function to check user role from their profile
    function getUserRole() {
      // Safely gets the role from the user's profile, returns null if not found.
      return get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.get('role', null);
    }

    // THIS RULE MUST BE LAST to act as a catch-all deny.
    match /{document=**} {
      allow read, write: if false;
    }
  }
} 