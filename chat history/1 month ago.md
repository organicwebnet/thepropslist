# Update DashboardHome for recent props activity
_Exported on 9/2/2025 at 08:34:37 GMT+1 from Cursor (1.5.9)_

---

**User**

lets  updatee the web-app  DashboardHome to make the recent props activity the list of props that have been recently added or updated

---

**Cursor**

I'm going to scan `web-app/src/DashboardHome.tsx` and search the codebase for where "props" data and "recent activity" are currently fetched or computed, so I can wire up a list of recently added/updated props.

I’m going to update `web-app/src/DashboardHome.tsx` so the “Recent Props Activity” shows a list of props sorted by their most recent created/updated date, excluding status history. I’ll add a small date normalization helper and adjust the activity computation accordingly.

```typescriptreact
import React from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { motion } from 'framer-motion';
import {
  Package,
  Theater,
  FileText,
  Plus,
  Package2,
  Box,
  Clock,
  CheckCircle,
  Zap,
  FileBarChart,
  BarChart3,
  Crown,
  Scroll,
  Star,
  Home,
  Calendar
} from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { useFirebase } from './contexts/FirebaseContext';
import { useEffect, useState } from 'react';
import type { Show } from './types/Show';
import type { Prop } from './types/props';
import type { CardData } from './types/taskManager';
import { Link } from 'react-router-dom';
import { useWebAuth } from './contexts/WebAuthContext';

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};
const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: { duration: 0.4 }
  },
  hover: {
    scale: 1.02,
    transition: { duration: 0.2 }
  }
};
const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.5 }
  }
};

const DashboardHome: React.FC = () => {
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const [boards, setBoards] = useState<any[]>([]);
  const [cards, setCards] = useState<CardData[]>([]);
  const [loading, setLoading] = useState(true);
  const { user, userProfile } = useWebAuth();

  // Fetch show
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShow({ ...doc.data, id: doc.id }),
      () => setShow(null)
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch props
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToCollection<Prop>(
      'props',
      data => setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...doc.data, id: doc.id }))),
      () => setProps([])
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch boards and cards
  useEffect(() => {
    if (!currentShowId) return;
    let unsubBoards: (() => void) | undefined;
    let unsubCards: (() => void)[] = [];
    unsubBoards = service.listenToCollection(
      'todo_boards',
      docs => {
        const filteredBoards = docs.filter(b => b.data.showId === currentShowId);
        setBoards(filteredBoards.map(b => ({ ...b.data, id: b.id })));
        // Listen to all cards in all lists in all boards
        unsubCards.forEach(u => u && u());
        unsubCards = [];
        filteredBoards.forEach(board => {
          service.listenToCollection(
            `todo_boards/${board.id}/lists`,
            lists => {
              lists.forEach(list => {
                const unsub = service.listenToCollection(
                  `todo_boards/${board.id}/lists/${list.id}/cards`,
                  cardsDocs => {
                    setCards(prev => {
                      // Remove old cards for this list
                      const other = prev.filter(c => c.listId !== list.id);
                      return [
                        ...other,
                        ...cardsDocs.map(cd => ({ ...(cd.data as CardData), id: cd.id, listId: list.id }))
                      ];
                    });
                  },
                  () => {}
                );
                unsubCards.push(unsub);
              });
            },
            () => {}
          );
        });
      },
      () => setBoards([])
    );
    return () => { if (unsubBoards) unsubBoards(); unsubCards.forEach(u => u && u()); };
  }, [service, currentShowId]);

  // Calculate stats
  const totalProps = props.length;
  const totalOutstandingTasks = cards.filter(card => !card.completed).length;
  const readyProps = props.filter(p => p.status === 'with-stage-management').length;
  const showReadyPercent = totalProps > 0 ? Math.round((readyProps / totalProps) * 100) : 0;

  // Recent props activity: list of props recently added or updated (one entry per prop)
  function toDateSafe(input: any): Date | null {
    if (!input) return null;
    if (input instanceof Date) return input;
    if (typeof input === 'number') return new Date(input);
    if (typeof input === 'string' && input.trim() !== '') {
      const parsed = new Date(input);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
    if (input && typeof input.toDate === 'function') {
      try {
        const d = input.toDate();
        return d instanceof Date && !isNaN(d.getTime()) ? d : null;
      } catch {
        return null;
      }
    }
    return null;
  }

  const recentActivity = props
    .map(p => {
      const created = toDateSafe((p as any).createdAt);
      const updated = toDateSafe((p as any).updatedAt);
      const latest = updated && (!created || updated >= created) ? updated : created;
      const type = updated && created ? (updated >= created ? 'updated' : 'added') : (updated ? 'updated' : 'added');
      return latest ? { prop: p, type, date: latest } : null;
    })
    .filter((x): x is { prop: Prop; type: 'added' | 'updated'; date: Date } => Boolean(x))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);

  // Urgent tasks row
  const now = new Date();
  const tasksWithDue = cards.filter(card => card.dueDate && !card.completed).map(card => ({
    ...card,
    due: card.dueDate ? new Date(card.dueDate) : new Date()
  })).sort((a, b) => a.due.getTime() - b.due.getTime()).slice(0, 6);

  // Cards assigned to or mentioning the current user
  const assignedOrMentionedCards = cards.filter(card => {
    if (!user) return false;
    const assigned = Array.isArray(card.assignedTo) && card.assignedTo.includes(user.uid);
    const mention = (userProfile && card.description && (
      (userProfile.displayName && card.description.includes(userProfile.displayName)) ||
      (userProfile.email && card.description.includes(userProfile.email))
    ));
    return assigned || mention;
  });

  function getTaskColor(due: Date) {
    if (due < now) return 'bg-red-600 text-white';
    const diff = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (diff < 2) return 'bg-orange-500 text-white';
    return 'bg-green-600 text-white';
  }

  function isValidStringDate(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  function isValidDateString(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  // Days until first performance
  let daysLeft = null;
  let perfDate: Date | null = null;
  const perfRaw = (show as any)?.firstPerformanceDate || show?.startDate;
  const temp = perfRaw;
  if (typeof temp === 'string' && temp.trim() !== '') {
    perfDate = new Date(temp);
  } else if (typeof temp === 'number' && !isNaN(temp)) {
    perfDate = new Date(temp);
  } else if (temp && typeof temp.toDate === 'function') {
    perfDate = temp.toDate();
  }
  if (perfDate) {
    daysLeft = Math.max(0, Math.ceil((perfDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));
  }

  // Find the next upcoming show date
  let nextShowDateLabel = '';
  if (show) {
    const now = new Date();
    const dateFields = [
      { key: 'rehearsalStartDate', label: 'Rehearsal' },
      { key: 'techWeekStartDate', label: 'Tech Week' },
      { key: 'firstPerformanceDate', label: 'First Performance' },
      { key: 'pressNightDate', label: 'Press Night' },
      { key: 'startDate', label: 'Start' },
      { key: 'endDate', label: 'End' },
    ];
    const upcoming = dateFields
      .map(({ key, label }) => {
        const raw = (show as any)[key];
        let date: Date | null = null;
        const temp = raw;
        if (isValidDateString(temp) && temp !== undefined) {
          date = new Date(temp);
        } else if (typeof temp === 'number' && !isNaN(temp)) {
          date = new Date(temp);
        } else if (temp && typeof temp.toDate === 'function') {
          date = temp.toDate();
        }
        return date && date > now ? { date, label } : null;
      })
      .filter(Boolean) as { date: Date; label: string }[];
    if (upcoming.length > 0) {
      const soonest = upcoming.reduce((a, b) => (a.date < b.date ? a : b));
      if (soonest.date instanceof Date && !isNaN(soonest.date.getTime())) {
        nextShowDateLabel = `Next Show Date: ${soonest.label} – ${soonest.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
      } else {
        nextShowDateLabel = `Next Show Date: ${soonest.label}`;
      }
    } else {
      nextShowDateLabel = 'No upcoming show dates';
    }
  }

  return (
    <DashboardLayout>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="max-w-7xl mx-auto space-y-6"
      >
        {/* Show Banner */}
        <motion.div
          variants={cardVariants}
          className="bg-gradient-to-r from-pb-primary to-pb-secondary rounded-2xl p-6 relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-pb-primary/20 to-pb-secondary/20 backdrop-blur-sm"></div>
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  {show?.name || 'Select a Show'}
                </h2>
                <p className="text-pb-light/80">{nextShowDateLabel}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">{daysLeft !== null ? `${daysLeft} days` : '--'}</div>
                <div className="text-pb-light/80 text-sm">until first night</div>
              </div>
            </div>
            <div className="w-full bg-pb-light/20 rounded-full h-2">
              <motion.div
                className="bg-pb-success h-2 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${showReadyPercent}%` }}
                transition={{ duration: 1, delay: 0.5 }}
              />
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Statistics Cards */}
          <motion.div variants={itemVariants} className="lg:col-span-2">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {[
                { icon: Package2, label: 'Total Props', value: totalProps, color: 'bg-pb-blue' },
                { icon: Clock, label: 'Pending Tasks', value: totalOutstandingTasks, color: 'bg-pb-orange' },
                { icon: CheckCircle, label: 'Ready for Show', value: `${showReadyPercent}%`, color: 'bg-pb-success' },
              ].map((stat, index) => (
                <motion.div
                  key={index}
                  variants={cardVariants}
                  whileHover="hover"
                  className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-4 border border-pb-primary/20"
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-10 h-10 ${stat.color}/20 rounded-xl flex items-center justify-center`}>
                      <stat.icon className={`w-5 h-5 ${stat.color.replace('bg-', 'text-')}`} />
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-white mb-1">{stat.value}</div>
                  <div className="text-sm text-pb-gray">{stat.label}</div>
                </motion.div>
              ))}
            </div>

            {/* Urgent Tasks Row */}
            <motion.div variants={itemVariants}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className="w-5 h-5 text-pb-primary" />
                <h3 className="text-lg font-semibold text-white">Urgent Tasks</h3>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {tasksWithDue.length === 0 && <div className="text-pb-gray">No urgent tasks.</div>}
                {tasksWithDue.map((task, idx) => (
                  <Link key={task.id} to={`/boards?cardId=${task.id}`} className="min-w-[220px]">
                    <div className={`p-4 rounded-xl shadow ${getTaskColor(task.due)}`}>
                      <div className="font-bold text-lg">{task.title}</div>
                      <div className="text-xs mb-1">Due: {task.due.toLocaleString()}</div>
                      <div className="text-xs">{task.description}</div>
                    </div>
                  </Link>
                ))}
              </div>
            </motion.div>{user && assignedOrMentionedCards.length > 0 && (
          <motion.div variants={itemVariants}>
            <div className="flex items-center space-x-2 mb-4 mt-6">
              <Star className="w-5 h-5 text-pb-accent" />
              <h3 className="text-lg font-semibold text-white">Your Tasks</h3>
            </div>
            <div className="flex gap-3 overflow-x-auto pb-2">
              {assignedOrMentionedCards.map(card => (
                <Link key={card.id} to={`/boards?cardId=${card.id}`} className="min-w-[220px]">
                  <div className="p-4 rounded-xl shadow bg-pb-primary/80 text-white">
                    <div className="font-bold text-lg">{card.title}</div>
                    {card.dueDate && <div className="text-xs mb-1">Due: {new Date(card.dueDate).toLocaleString()}</div>}
                    <div className="text-xs line-clamp-2">{card.description}</div>
            </div>
                </Link>
            ))}
          </div>
        </motion.div>
        )}

          </motion.div>

          {/* Recent Props Activity */}
          <motion.div variants={itemVariants} className="lg:col-span-1">
            <div className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-6 border border-pb-primary/20 h-full">
              <div className="flex items-center space-x-2 mb-4">
                <FileText className="w-5 h-5 text-pb-accent" />
                <h3 className="text-lg font-semibold text-white">Recent Props Activity</h3>
              </div>
              
              <div className="space-y-4">
                {recentActivity.length === 0 && <div className="text-pb-gray">No recent activity.</div>}
                {recentActivity.map((activity, index) => (
                  <motion.div
                    key={index}
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.1 }}
                    className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                  >
                    <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                      <Crown className="w-4 h-4 text-pb-accent" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-white">{activity.prop.name}</p>
                      <p className="text-xs text-pb-gray">
                        {activity.type === 'added' && 'Prop added'}
                        {activity.type === 'updated' && 'Prop updated'}
                        {activity.type === 'status' && ('status' in activity && activity.status ? `Status: ${activity.status}` : 'Status change')}
                      </p>
                      <p className="text-xs text-pb-gray mt-1">{'user' in activity && activity.user ? activity.user : ''} {activity.date ? '• ' + new Date(activity.date).toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''}</p>
                    </div>
                  </motion.div>
                ))}
              </div>
            </div>
          </motion.div>
        </div>

        {/* Assigned/Mentioned Tasks Row */}
        
      </motion.div>
    </DashboardLayout>
  );
};

export default DashboardHome; 
```

I’ve implemented the change so “Recent Props Activity” now lists props recently added or updated (one entry per prop), sorted by latest date. I’ll run a quick lint check on `web-app/src/DashboardHome.tsx` and fix any issues.

I’m going to fix the rendering of the recent activity list to only display “added” or “updated” entries with dates, and adjust the code to avoid the type errors. Then I’ll re-run the linter on this file.

```typescriptreact
import React from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { motion } from 'framer-motion';
import {
  FileText,
  Package2,
  Clock,
  CheckCircle,
  Crown,
  Star
} from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { useFirebase } from './contexts/FirebaseContext';
import { useEffect, useState } from 'react';
import type { Show } from './types/Show';
import type { Prop } from './types/props';
import type { CardData } from './types/taskManager';
import { Link } from 'react-router-dom';
import { useWebAuth } from './contexts/WebAuthContext';

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};
const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: { duration: 0.4 }
  },
  hover: {
    scale: 1.02,
    transition: { duration: 0.2 }
  }
};
const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.5 }
  }
};

const DashboardHome: React.FC = () => {
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const [cards, setCards] = useState<CardData[]>([]);
  const { user, userProfile } = useWebAuth();

  // Fetch show
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShow({ ...doc.data, id: doc.id }),
      () => setShow(null)
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch props
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToCollection<Prop>(
      'props',
      data => setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...doc.data, id: doc.id }))),
      () => setProps([])
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch boards and cards
  useEffect(() => {
    if (!currentShowId) return;
    let unsubBoards: (() => void) | undefined;
    let unsubCards: (() => void)[] = [];
    unsubBoards = service.listenToCollection(
      'todo_boards',
      docs => {
        const filteredBoards = docs.filter(b => b.data.showId === currentShowId);
        // Listen to all cards in all lists in all boards
        unsubCards.forEach(u => u && u());
        unsubCards = [];
        filteredBoards.forEach(board => {
          service.listenToCollection(
            `todo_boards/${board.id}/lists`,
            lists => {
              lists.forEach(list => {
                const unsub = service.listenToCollection(
                  `todo_boards/${board.id}/lists/${list.id}/cards`,
                  cardsDocs => {
                    setCards(prev => {
                      // Remove old cards for this list
                      const other = prev.filter(c => c.listId !== list.id);
                      return [
                        ...other,
                        ...cardsDocs.map(cd => ({ ...(cd.data as CardData), id: cd.id, listId: list.id }))
                      ];
                    });
                  },
                  () => {}
                );
                unsubCards.push(unsub);
              });
            },
            () => {}
          );
        });
      },
      () => setBoards([])
    );
    return () => { if (unsubBoards) unsubBoards(); unsubCards.forEach(u => u && u()); };
  }, [service, currentShowId]);

  // Calculate stats
  const totalProps = props.length;
  const totalOutstandingTasks = cards.filter(card => !card.completed).length;
  const readyProps = props.filter(p => p.status === 'with-stage-management').length;
  const showReadyPercent = totalProps > 0 ? Math.round((readyProps / totalProps) * 100) : 0;

  // Recent props activity: list of props recently added or updated (one entry per prop)
  function toDateSafe(input: any): Date | null {
    if (!input) return null;
    if (input instanceof Date) return input;
    if (typeof input === 'number') return new Date(input);
    if (typeof input === 'string' && input.trim() !== '') {
      const parsed = new Date(input);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
    if (input && typeof input.toDate === 'function') {
      try {
        const d = input.toDate();
        return d instanceof Date && !isNaN(d.getTime()) ? d : null;
      } catch {
        return null;
      }
    }
    return null;
  }

  const recentActivity = props
    .map(p => {
      const created = toDateSafe((p as any).createdAt);
      const updated = toDateSafe((p as any).updatedAt);
      const latest = updated && (!created || updated >= created) ? updated : created;
      const type = updated && created ? (updated >= created ? 'updated' : 'added') : (updated ? 'updated' : 'added');
      return latest ? { prop: p, type, date: latest } : null;
    })
    .filter((x): x is { prop: Prop; type: 'added' | 'updated'; date: Date } => Boolean(x))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);

  // Urgent tasks row
  const now = new Date();
  const tasksWithDue = cards.filter(card => card.dueDate && !card.completed).map(card => ({
    ...card,
    due: card.dueDate ? new Date(card.dueDate) : new Date()
  })).sort((a, b) => a.due.getTime() - b.due.getTime()).slice(0, 6);

  // Cards assigned to or mentioning the current user
  const assignedOrMentionedCards = cards.filter(card => {
    if (!user) return false;
    const assigned = Array.isArray(card.assignedTo) && card.assignedTo.includes(user.uid);
    const mention = (userProfile && card.description && (
      (userProfile.displayName && card.description.includes(userProfile.displayName)) ||
      (userProfile.email && card.description.includes(userProfile.email))
    ));
    return assigned || mention;
  });

  function getTaskColor(due: Date) {
    if (due < now) return 'bg-red-600 text-white';
    const diff = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (diff < 2) return 'bg-orange-500 text-white';
    return 'bg-green-600 text-white';
  }

  function isValidDateString(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  // Days until first performance
  let daysLeft = null;
  let perfDate: Date | null = null;
  const perfRaw = (show as any)?.firstPerformanceDate || show?.startDate;
  const temp = perfRaw;
  if (typeof temp === 'string' && temp.trim() !== '') {
    perfDate = new Date(temp);
  } else if (typeof temp === 'number' && !isNaN(temp)) {
    perfDate = new Date(temp);
  } else if (temp && typeof temp.toDate === 'function') {
    perfDate = temp.toDate();
  }
  if (perfDate) {
    daysLeft = Math.max(0, Math.ceil((perfDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));
  }

  // Find the next upcoming show date
  let nextShowDateLabel = '';
  if (show) {
    const now = new Date();
    const dateFields = [
      { key: 'rehearsalStartDate', label: 'Rehearsal' },
      { key: 'techWeekStartDate', label: 'Tech Week' },
      { key: 'firstPerformanceDate', label: 'First Performance' },
      { key: 'pressNightDate', label: 'Press Night' },
      { key: 'startDate', label: 'Start' },
      { key: 'endDate', label: 'End' },
    ];
    const upcoming = dateFields
      .map(({ key, label }) => {
        const raw = (show as any)[key];
        let date: Date | null = null;
        const temp = raw;
        if (isValidDateString(temp) && temp !== undefined) {
          date = new Date(temp);
        } else if (typeof temp === 'number' && !isNaN(temp)) {
          date = new Date(temp);
        } else if (temp && typeof temp.toDate === 'function') {
          date = temp.toDate();
        }
        return date && date > now ? { date, label } : null;
      })
      .filter(Boolean) as { date: Date; label: string }[];
    if (upcoming.length > 0) {
      const soonest = upcoming.reduce((a, b) => (a.date < b.date ? a : b));
      if (soonest.date instanceof Date && !isNaN(soonest.date.getTime())) {
        nextShowDateLabel = `Next Show Date: ${soonest.label} – ${soonest.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
      } else {
        nextShowDateLabel = `Next Show Date: ${soonest.label}`;
      }
    } else {
      nextShowDateLabel = 'No upcoming show dates';
    }
  }

  return (
    <DashboardLayout>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="max-w-7xl mx-auto space-y-6"
      >
        {/* Show Banner */}
        <motion.div
          variants={cardVariants}
          className="bg-gradient-to-r from-pb-primary to-pb-secondary rounded-2xl p-6 relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-pb-primary/20 to-pb-secondary/20 backdrop-blur-sm"></div>
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  {show?.name || 'Select a Show'}
                </h2>
                <p className="text-pb-light/80">{nextShowDateLabel}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">{daysLeft !== null ? `${daysLeft} days` : '--'}</div>
                <div className="text-pb-light/80 text-sm">until first night</div>
              </div>
            </div>
            <div className="w-full bg-pb-light/20 rounded-full h-2">
              <motion.div
                className="bg-pb-success h-2 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${showReadyPercent}%` }}
                transition={{ duration: 1, delay: 0.5 }}
              />
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Statistics Cards */}
          <motion.div variants={itemVariants} className="lg:col-span-2">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {[
                { icon: Package2, label: 'Total Props', value: totalProps, color: 'bg-pb-blue' },
                { icon: Clock, label: 'Pending Tasks', value: totalOutstandingTasks, color: 'bg-pb-orange' },
                { icon: CheckCircle, label: 'Ready for Show', value: `${showReadyPercent}%`, color: 'bg-pb-success' },
              ].map((stat, index) => (
                <motion.div
                  key={index}
                  variants={cardVariants}
                  whileHover="hover"
                  className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-4 border border-pb-primary/20"
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-10 h-10 ${stat.color}/20 rounded-xl flex items-center justify-center`}>
                      <stat.icon className={`w-5 h-5 ${stat.color.replace('bg-', 'text-')}`} />
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-white mb-1">{stat.value}</div>
                  <div className="text-sm text-pb-gray">{stat.label}</div>
                </motion.div>
              ))}
            </div>

            {/* Urgent Tasks Row */}
            <motion.div variants={itemVariants}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className="w-5 h-5 text-pb-primary" />
                <h3 className="text-lg font-semibold text-white">Urgent Tasks</h3>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {tasksWithDue.length === 0 && <div className="text-pb-gray">No urgent tasks.</div>}
                {tasksWithDue.map((task, idx) => (
                  <Link key={task.id} to={`/boards?cardId=${task.id}`} className="min-w-[220px]">
                    <div className={`p-4 rounded-xl shadow ${getTaskColor(task.due)}`}>
                      <div className="font-bold text-lg">{task.title}</div>
                      <div className="text-xs mb-1">Due: {task.due.toLocaleString()}</div>
                      <div className="text-xs">{task.description}</div>
                    </div>
                  </Link>
                ))}
              </div>
            </motion.div>{user && assignedOrMentionedCards.length > 0 && (
          <motion.div variants={itemVariants}>
            <div className="flex items-center space-x-2 mb-4 mt-6">
              <Star className="w-5 h-5 text-pb-accent" />
              <h3 className="text-lg font-semibold text-white">Your Tasks</h3>
            </div>
            <div className="flex gap-3 overflow-x-auto pb-2">
              {assignedOrMentionedCards.map(card => (
                <Link key={card.id} to={`/boards?cardId=${card.id}`} className="min-w-[220px]">
                  <div className="p-4 rounded-xl shadow bg-pb-primary/80 text-white">
                    <div className="font-bold text-lg">{card.title}</div>
                    {card.dueDate && <div className="text-xs mb-1">Due: {new Date(card.dueDate).toLocaleString()}</div>}
                    <div className="text-xs line-clamp-2">{card.description}</div>
            </div>
                </Link>
            ))}
          </div>
        </motion.div>
        )}

          </motion.div>

          {/* Recent Props Activity */}
          <motion.div variants={itemVariants} className="lg:col-span-1">
            <div className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-6 border border-pb-primary/20 h-full">
              <div className="flex items-center space-x-2 mb-4">
                <FileText className="w-5 h-5 text-pb-accent" />
                <h3 className="text-lg font-semibold text-white">Recent Props Activity</h3>
              </div>
              
              <div className="space-y-4">
                {recentActivity.length === 0 && <div className="text-pb-gray">No recent activity.</div>}
                {recentActivity.map((activity, index) => (
                  <motion.div
                    key={index}
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.1 }}
                    className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                  >
                    <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                      <Crown className="w-4 h-4 text-pb-accent" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-white">{activity.prop.name}</p>
                      <p className="text-xs text-pb-gray">
                        {activity.type === 'added' && 'Prop added'}
                        {activity.type === 'updated' && 'Prop updated'}
                        {activity.type === 'status' && ('status' in activity && activity.status ? `Status: ${activity.status}` : 'Status change')}
                      </p>
                      <p className="text-xs text-pb-gray mt-1">{'user' in activity && activity.user ? activity.user : ''} {activity.date ? '• ' + new Date(activity.date).toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''}</p>
                    </div>
                  </motion.div>
                ))}
              </div>
            </div>
          </motion.div>
        </div>

        {/* Assigned/Mentioned Tasks Row */}
        
      </motion.div>
    </DashboardLayout>
  );
};

export default DashboardHome; 
```

```typescriptreact
import React from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { motion } from 'framer-motion';
import {
  FileText,
  Package2,
  Clock,
  CheckCircle,
  Crown,
  Star
} from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { useFirebase } from './contexts/FirebaseContext';
import { useEffect, useState } from 'react';
import type { Show } from './types/Show';
import type { Prop } from './types/props';
import type { CardData } from './types/taskManager';
import { Link } from 'react-router-dom';
import { useWebAuth } from './contexts/WebAuthContext';

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};
const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: { duration: 0.4 }
  },
  hover: {
    scale: 1.02,
    transition: { duration: 0.2 }
  }
};
const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.5 }
  }
};

const DashboardHome: React.FC = () => {
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const [cards, setCards] = useState<CardData[]>([]);
  const { user, userProfile } = useWebAuth();

  // Fetch show
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShow({ ...doc.data, id: doc.id }),
      () => setShow(null)
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch props
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToCollection<Prop>(
      'props',
      data => setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...doc.data, id: doc.id }))),
      () => setProps([])
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch boards and cards
  useEffect(() => {
    if (!currentShowId) return;
    let unsubBoards: (() => void) | undefined;
    let unsubCards: (() => void)[] = [];
    unsubBoards = service.listenToCollection(
      'todo_boards',
      docs => {
        const filteredBoards = docs.filter(b => b.data.showId === currentShowId);
        // Listen to all cards in all lists in all boards
        unsubCards.forEach(u => u && u());
        unsubCards = [];
        filteredBoards.forEach(board => {
          service.listenToCollection(
            `todo_boards/${board.id}/lists`,
            lists => {
              lists.forEach(list => {
                const unsub = service.listenToCollection(
                  `todo_boards/${board.id}/lists/${list.id}/cards`,
                  cardsDocs => {
                    setCards(prev => {
                      // Remove old cards for this list
                      const other = prev.filter(c => c.listId !== list.id);
                      return [
                        ...other,
                        ...cardsDocs.map(cd => ({ ...(cd.data as CardData), id: cd.id, listId: list.id }))
                      ];
                    });
                  },
                  () => {}
                );
                unsubCards.push(unsub);
              });
            },
            () => {}
          );
        });
      },
      () => setBoards([])
    );
    return () => { if (unsubBoards) unsubBoards(); unsubCards.forEach(u => u && u()); };
  }, [service, currentShowId]);

  // Calculate stats
  const totalProps = props.length;
  const totalOutstandingTasks = cards.filter(card => !card.completed).length;
  const readyProps = props.filter(p => p.status === 'with-stage-management').length;
  const showReadyPercent = totalProps > 0 ? Math.round((readyProps / totalProps) * 100) : 0;

  // Recent props activity: list of props recently added or updated (one entry per prop)
  function toDateSafe(input: any): Date | null {
    if (!input) return null;
    if (input instanceof Date) return input;
    if (typeof input === 'number') return new Date(input);
    if (typeof input === 'string' && input.trim() !== '') {
      const parsed = new Date(input);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
    if (input && typeof input.toDate === 'function') {
      try {
        const d = input.toDate();
        return d instanceof Date && !isNaN(d.getTime()) ? d : null;
      } catch {
        return null;
      }
    }
    return null;
  }

  const recentActivity = props
    .map(p => {
      const created = toDateSafe((p as any).createdAt);
      const updated = toDateSafe((p as any).updatedAt);
      const latest = updated && (!created || updated >= created) ? updated : created;
      const type = updated && created ? (updated >= created ? 'updated' : 'added') : (updated ? 'updated' : 'added');
      return latest ? { prop: p, type, date: latest } : null;
    })
    .filter((x): x is { prop: Prop; type: 'added' | 'updated'; date: Date } => Boolean(x))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);

  // Urgent tasks row
  const now = new Date();
  const tasksWithDue = cards.filter(card => card.dueDate && !card.completed).map(card => ({
    ...card,
    due: card.dueDate ? new Date(card.dueDate) : new Date()
  })).sort((a, b) => a.due.getTime() - b.due.getTime()).slice(0, 6);

  // Cards assigned to or mentioning the current user
  const assignedOrMentionedCards = cards.filter(card => {
    if (!user) return false;
    const assigned = Array.isArray(card.assignedTo) && card.assignedTo.includes(user.uid);
    const mention = (userProfile && card.description && (
      (userProfile.displayName && card.description.includes(userProfile.displayName)) ||
      (userProfile.email && card.description.includes(userProfile.email))
    ));
    return assigned || mention;
  });

  function getTaskColor(due: Date) {
    if (due < now) return 'bg-red-600 text-white';
    const diff = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (diff < 2) return 'bg-orange-500 text-white';
    return 'bg-green-600 text-white';
  }

  function isValidDateString(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  // Days until first performance
  let daysLeft = null;
  let perfDate: Date | null = null;
  const perfRaw = (show as any)?.firstPerformanceDate || show?.startDate;
  const temp = perfRaw;
  if (typeof temp === 'string' && temp.trim() !== '') {
    perfDate = new Date(temp);
  } else if (typeof temp === 'number' && !isNaN(temp)) {
    perfDate = new Date(temp);
  } else if (temp && typeof temp.toDate === 'function') {
    perfDate = temp.toDate();
  }
  if (perfDate) {
    daysLeft = Math.max(0, Math.ceil((perfDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));
  }

  // Find the next upcoming show date
  let nextShowDateLabel = '';
  if (show) {
    const now = new Date();
    const dateFields = [
      { key: 'rehearsalStartDate', label: 'Rehearsal' },
      { key: 'techWeekStartDate', label: 'Tech Week' },
      { key: 'firstPerformanceDate', label: 'First Performance' },
      { key: 'pressNightDate', label: 'Press Night' },
      { key: 'startDate', label: 'Start' },
      { key: 'endDate', label: 'End' },
    ];
    const upcoming = dateFields
      .map(({ key, label }) => {
        const raw = (show as any)[key];
        let date: Date | null = null;
        const temp = raw;
        if (isValidDateString(temp) && temp !== undefined) {
          date = new Date(temp);
        } else if (typeof temp === 'number' && !isNaN(temp)) {
          date = new Date(temp);
        } else if (temp && typeof temp.toDate === 'function') {
          date = temp.toDate();
        }
        return date && date > now ? { date, label } : null;
      })
      .filter(Boolean) as { date: Date; label: string }[];
    if (upcoming.length > 0) {
      const soonest = upcoming.reduce((a, b) => (a.date < b.date ? a : b));
      if (soonest.date instanceof Date && !isNaN(soonest.date.getTime())) {
        nextShowDateLabel = `Next Show Date: ${soonest.label} – ${soonest.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
      } else {
        nextShowDateLabel = `Next Show Date: ${soonest.label}`;
      }
    } else {
      nextShowDateLabel = 'No upcoming show dates';
    }
  }

  return (
    <DashboardLayout>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="max-w-7xl mx-auto space-y-6"
      >
        {/* Show Banner */}
        <motion.div
          variants={cardVariants}
          className="bg-gradient-to-r from-pb-primary to-pb-secondary rounded-2xl p-6 relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-pb-primary/20 to-pb-secondary/20 backdrop-blur-sm"></div>
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  {show?.name || 'Select a Show'}
                </h2>
                <p className="text-pb-light/80">{nextShowDateLabel}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">{daysLeft !== null ? `${daysLeft} days` : '--'}</div>
                <div className="text-pb-light/80 text-sm">until first night</div>
              </div>
            </div>
            <div className="w-full bg-pb-light/20 rounded-full h-2">
              <motion.div
                className="bg-pb-success h-2 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${showReadyPercent}%` }}
                transition={{ duration: 1, delay: 0.5 }}
              />
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Statistics Cards */}
          <motion.div variants={itemVariants} className="lg:col-span-2">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {[
                { icon: Package2, label: 'Total Props', value: totalProps, color: 'bg-pb-blue' },
                { icon: Clock, label: 'Pending Tasks', value: totalOutstandingTasks, color: 'bg-pb-orange' },
                { icon: CheckCircle, label: 'Ready for Show', value: `${showReadyPercent}%`, color: 'bg-pb-success' },
              ].map((stat, index) => (
                <motion.div
                  key={index}
                  variants={cardVariants}
                  whileHover="hover"
                  className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-4 border border-pb-primary/20"
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-10 h-10 ${stat.color}/20 rounded-xl flex items-center justify-center`}>
                      <stat.icon className={`w-5 h-5 ${stat.color.replace('bg-', 'text-')}`} />
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-white mb-1">{stat.value}</div>
                  <div className="text-sm text-pb-gray">{stat.label}</div>
                </motion.div>
              ))}
            </div>

            {/* Urgent Tasks Row */}
            <motion.div variants={itemVariants}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className="w-5 h-5 text-pb-primary" />
                <h3 className="text-lg font-semibold text-white">Urgent Tasks</h3>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {tasksWithDue.length === 0 && <div className="text-pb-gray">No urgent tasks.</div>}
                {tasksWithDue.map((task) => (
                  <Link key={task.id} to={`/boards?cardId=${task.id}`} className="min-w-[220px]">
                    <div className={`p-4 rounded-xl shadow ${getTaskColor(task.due)}`}>
                      <div className="font-bold text-lg">{task.title}</div>
                      <div className="text-xs mb-1">Due: {task.due.toLocaleString()}</div>
                      <div className="text-xs">{task.description}</div>
                    </div>
                  </Link>
                ))}
              </div>
            </motion.div>{user && assignedOrMentionedCards.length > 0 && (
          <motion.div variants={itemVariants}>
            <div className="flex items-center space-x-2 mb-4 mt-6">
              <Star className="w-5 h-5 text-pb-accent" />
              <h3 className="text-lg font-semibold text-white">Your Tasks</h3>
            </div>
            <div className="flex gap-3 overflow-x-auto pb-2">
              {assignedOrMentionedCards.map(card => (
                <Link key={card.id} to={`/boards?cardId=${card.id}`} className="min-w-[220px]">
                  <div className="p-4 rounded-xl shadow bg-pb-primary/80 text-white">
                    <div className="font-bold text-lg">{card.title}</div>
                    {card.dueDate && <div className="text-xs mb-1">Due: {new Date(card.dueDate).toLocaleString()}</div>}
                    <div className="text-xs line-clamp-2">{card.description}</div>
            </div>
                </Link>
            ))}
          </div>
        </motion.div>
        )}

          </motion.div>

          {/* Recent Props Activity */}
          <motion.div variants={itemVariants} className="lg:col-span-1">
            <div className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-6 border border-pb-primary/20 h-full">
              <div className="flex items-center space-x-2 mb-4">
                <FileText className="w-5 h-5 text-pb-accent" />
                <h3 className="text-lg font-semibold text-white">Recent Props Activity</h3>
              </div>
              
              <div className="space-y-4">
                {recentActivity.length === 0 && <div className="text-pb-gray">No recent activity.</div>}
                {recentActivity.map((activity, index) => (
                  <motion.div
                    key={index}
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.1 }}
                    className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                  >
                    <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                      <Crown className="w-4 h-4 text-pb-accent" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-white">{activity.prop.name}</p>
                      <p className="text-xs text-pb-gray">
                        {activity.type === 'added' && 'Prop added'}
                        {activity.type === 'updated' && 'Prop updated'}
                        {activity.type === 'status' && ('status' in activity && activity.status ? `Status: ${activity.status}` : 'Status change')}
                      </p>
                      <p className="text-xs text-pb-gray mt-1">{'user' in activity && activity.user ? activity.user : ''} {activity.date ? '• ' + new Date(activity.date).toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''}</p>
                    </div>
                  </motion.div>
                ))}
              </div>
            </div>
          </motion.div>
        </div>

        {/* Assigned/Mentioned Tasks Row */}
        
      </motion.div>
    </DashboardLayout>
  );
};

export default DashboardHome; 
```

```typescriptreact
import React from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { motion } from 'framer-motion';
import {
  FileText,
  Package2,
  Clock,
  CheckCircle,
  Crown,
  Star
} from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { useFirebase } from './contexts/FirebaseContext';
import { useEffect, useState } from 'react';
import type { Show } from './types/Show';
import type { Prop } from './types/props';
import type { CardData } from './types/taskManager';
import { Link } from 'react-router-dom';
import { useWebAuth } from './contexts/WebAuthContext';

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};
const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: { duration: 0.4 }
  },
  hover: {
    scale: 1.02,
    transition: { duration: 0.2 }
  }
};
const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.5 }
  }
};

const DashboardHome: React.FC = () => {
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const [cards, setCards] = useState<CardData[]>([]);
  const { user, userProfile } = useWebAuth();

  // Fetch show
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShow({ ...doc.data, id: doc.id }),
      () => setShow(null)
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch props
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToCollection<Prop>(
      'props',
      data => setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...doc.data, id: doc.id }))),
      () => setProps([])
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch boards and cards
  useEffect(() => {
    if (!currentShowId) return;
    let unsubBoards: (() => void) | undefined;
    let unsubCards: (() => void)[] = [];
    unsubBoards = service.listenToCollection(
      'todo_boards',
      docs => {
        const filteredBoards = docs.filter(b => b.data.showId === currentShowId);
        // Listen to all cards in all lists in all boards
        unsubCards.forEach(u => u && u());
        unsubCards = [];
        filteredBoards.forEach(board => {
          service.listenToCollection(
            `todo_boards/${board.id}/lists`,
            lists => {
              lists.forEach(list => {
                const unsub = service.listenToCollection(
                  `todo_boards/${board.id}/lists/${list.id}/cards`,
                  cardsDocs => {
                    setCards(prev => {
                      // Remove old cards for this list
                      const other = prev.filter(c => c.listId !== list.id);
                      return [
                        ...other,
                        ...cardsDocs.map(cd => ({ ...(cd.data as CardData), id: cd.id, listId: list.id }))
                      ];
                    });
                  },
                  () => {}
                );
                unsubCards.push(unsub);
              });
            },
            () => {}
          );
        });
      },
      () => setBoards([])
    );
    return () => { if (unsubBoards) unsubBoards(); unsubCards.forEach(u => u && u()); };
  }, [service, currentShowId]);

  // Calculate stats
  const totalProps = props.length;
  const totalOutstandingTasks = cards.filter(card => !card.completed).length;
  const readyProps = props.filter(p => p.status === 'with-stage-management').length;
  const showReadyPercent = totalProps > 0 ? Math.round((readyProps / totalProps) * 100) : 0;

  // Recent props activity: list of props recently added or updated (one entry per prop)
  function toDateSafe(input: any): Date | null {
    if (!input) return null;
    if (input instanceof Date) return input;
    if (typeof input === 'number') return new Date(input);
    if (typeof input === 'string' && input.trim() !== '') {
      const parsed = new Date(input);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
    if (input && typeof input.toDate === 'function') {
      try {
        const d = input.toDate();
        return d instanceof Date && !isNaN(d.getTime()) ? d : null;
      } catch {
        return null;
      }
    }
    return null;
  }

  const recentActivity = props
    .map(p => {
      const created = toDateSafe((p as any).createdAt);
      const updated = toDateSafe((p as any).updatedAt);
      const latest = updated && (!created || updated >= created) ? updated : created;
      const type = updated && created ? (updated >= created ? 'updated' : 'added') : (updated ? 'updated' : 'added');
      return latest ? { prop: p, type, date: latest } : null;
    })
    .filter((x): x is { prop: Prop; type: 'added' | 'updated'; date: Date } => Boolean(x))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);

  // Urgent tasks row
  const now = new Date();
  const tasksWithDue = cards.filter(card => card.dueDate && !card.completed).map(card => ({
    ...card,
    due: card.dueDate ? new Date(card.dueDate) : new Date()
  })).sort((a, b) => a.due.getTime() - b.due.getTime()).slice(0, 6);

  // Cards assigned to or mentioning the current user
  const assignedOrMentionedCards = cards.filter(card => {
    if (!user) return false;
    const assigned = Array.isArray(card.assignedTo) && card.assignedTo.includes(user.uid);
    const mention = (userProfile && card.description && (
      (userProfile.displayName && card.description.includes(userProfile.displayName)) ||
      (userProfile.email && card.description.includes(userProfile.email))
    ));
    return assigned || mention;
  });

  function getTaskColor(due: Date) {
    if (due < now) return 'bg-red-600 text-white';
    const diff = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (diff < 2) return 'bg-orange-500 text-white';
    return 'bg-green-600 text-white';
  }

  function isValidDateString(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  // Days until first performance
  let daysLeft = null;
  let perfDate: Date | null = null;
  const perfRaw = (show as any)?.firstPerformanceDate || show?.startDate;
  const temp = perfRaw;
  if (typeof temp === 'string' && temp.trim() !== '') {
    perfDate = new Date(temp);
  } else if (typeof temp === 'number' && !isNaN(temp)) {
    perfDate = new Date(temp);
  } else if (temp && typeof temp.toDate === 'function') {
    perfDate = temp.toDate();
  }
  if (perfDate) {
    daysLeft = Math.max(0, Math.ceil((perfDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));
  }

  // Find the next upcoming show date
  let nextShowDateLabel = '';
  if (show) {
    const now = new Date();
    const dateFields = [
      { key: 'rehearsalStartDate', label: 'Rehearsal' },
      { key: 'techWeekStartDate', label: 'Tech Week' },
      { key: 'firstPerformanceDate', label: 'First Performance' },
      { key: 'pressNightDate', label: 'Press Night' },
      { key: 'startDate', label: 'Start' },
      { key: 'endDate', label: 'End' },
    ];
    const upcoming = dateFields
      .map(({ key, label }) => {
        const raw = (show as any)[key];
        let date: Date | null = null;
        const temp = raw;
        if (isValidDateString(temp) && temp !== undefined) {
          date = new Date(temp);
        } else if (typeof temp === 'number' && !isNaN(temp)) {
          date = new Date(temp);
        } else if (temp && typeof temp.toDate === 'function') {
          date = temp.toDate();
        }
        return date && date > now ? { date, label } : null;
      })
      .filter(Boolean) as { date: Date; label: string }[];
    if (upcoming.length > 0) {
      const soonest = upcoming.reduce((a, b) => (a.date < b.date ? a : b));
      if (soonest.date instanceof Date && !isNaN(soonest.date.getTime())) {
        nextShowDateLabel = `Next Show Date: ${soonest.label} – ${soonest.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
      } else {
        nextShowDateLabel = `Next Show Date: ${soonest.label}`;
      }
    } else {
      nextShowDateLabel = 'No upcoming show dates';
    }
  }

  return (
    <DashboardLayout>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="max-w-7xl mx-auto space-y-6"
      >
        {/* Show Banner */}
        <motion.div
          variants={cardVariants}
          className="bg-gradient-to-r from-pb-primary to-pb-secondary rounded-2xl p-6 relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-pb-primary/20 to-pb-secondary/20 backdrop-blur-sm"></div>
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  {show?.name || 'Select a Show'}
                </h2>
                <p className="text-pb-light/80">{nextShowDateLabel}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">{daysLeft !== null ? `${daysLeft} days` : '--'}</div>
                <div className="text-pb-light/80 text-sm">until first night</div>
              </div>
            </div>
            <div className="w-full bg-pb-light/20 rounded-full h-2">
              <motion.div
                className="bg-pb-success h-2 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${showReadyPercent}%` }}
                transition={{ duration: 1, delay: 0.5 }}
              />
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Statistics Cards */}
          <motion.div variants={itemVariants} className="lg:col-span-2">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {[
                { icon: Package2, label: 'Total Props', value: totalProps, color: 'bg-pb-blue' },
                { icon: Clock, label: 'Pending Tasks', value: totalOutstandingTasks, color: 'bg-pb-orange' },
                { icon: CheckCircle, label: 'Ready for Show', value: `${showReadyPercent}%`, color: 'bg-pb-success' },
              ].map((stat, index) => (
                <motion.div
                  key={index}
                  variants={cardVariants}
                  whileHover="hover"
                  className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-4 border border-pb-primary/20"
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-10 h-10 ${stat.color}/20 rounded-xl flex items-center justify-center`}>
                      <stat.icon className={`w-5 h-5 ${stat.color.replace('bg-', 'text-')}`} />
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-white mb-1">{stat.value}</div>
                  <div className="text-sm text-pb-gray">{stat.label}</div>
                </motion.div>
              ))}
            </div>

            {/* Urgent Tasks Row */}
            <motion.div variants={itemVariants}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className="w-5 h-5 text-pb-primary" />
                <h3 className="text-lg font-semibold text-white">Urgent Tasks</h3>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {tasksWithDue.length === 0 && <div className="text-pb-gray">No urgent tasks.</div>}
                {tasksWithDue.map((task) => (
                  <Link key={task.id} to={`/boards?cardId=${task.id}`} className="min-w-[220px]">
                    <div className={`p-4 rounded-xl shadow ${getTaskColor(task.due)}`}>
                      <div className="font-bold text-lg">{task.title}</div>
                      <div className="text-xs mb-1">Due: {task.due.toLocaleString()}</div>
                      <div className="text-xs">{task.description}</div>
                    </div>
                  </Link>
                ))}
              </div>
            </motion.div>{user && assignedOrMentionedCards.length > 0 && (
          <motion.div variants={itemVariants}>
            <div className="flex items-center space-x-2 mb-4 mt-6">
              <Star className="w-5 h-5 text-pb-accent" />
              <h3 className="text-lg font-semibold text-white">Your Tasks</h3>
            </div>
            <div className="flex gap-3 overflow-x-auto pb-2">
              {assignedOrMentionedCards.map(card => (
                <Link key={card.id} to={`/boards?cardId=${card.id}`} className="min-w-[220px]">
                  <div className="p-4 rounded-xl shadow bg-pb-primary/80 text-white">
                    <div className="font-bold text-lg">{card.title}</div>
                    {card.dueDate && <div className="text-xs mb-1">Due: {new Date(card.dueDate).toLocaleString()}</div>}
                    <div className="text-xs line-clamp-2">{card.description}</div>
            </div>
                </Link>
            ))}
          </div>
        </motion.div>
        )}

          </motion.div>

          {/* Recent Props Activity */}
          <motion.div variants={itemVariants} className="lg:col-span-1">
            <div className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-6 border border-pb-primary/20 h-full">
              <div className="flex items-center space-x-2 mb-4">
                <FileText className="w-5 h-5 text-pb-accent" />
                <h3 className="text-lg font-semibold text-white">Recent Props Activity</h3>
              </div>
              
              <div className="space-y-4">
                {recentActivity.length === 0 && <div className="text-pb-gray">No recent activity.</div>}
                {recentActivity.map((activity, index) => (
                  <motion.div
                    key={index}
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.1 }}
                    className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                  >
                    <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                      <Crown className="w-4 h-4 text-pb-accent" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-white">{activity.prop.name}</p>
                      <p className="text-xs text-pb-gray">{activity.type === 'added' ? 'Prop added' : 'Prop updated'}</p>
                      <p className="text-xs text-pb-gray mt-1">{activity.date ? new Date(activity.date).toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''}</p>
                    </div>
                  </motion.div>
                ))}
              </div>
            </div>
          </motion.div>
        </div>

        {/* Assigned/Mentioned Tasks Row */}
        
      </motion.div>
    </DashboardLayout>
  );
};

export default DashboardHome; 
```

```typescriptreact
import React from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { motion } from 'framer-motion';
import {
  FileText,
  Package2,
  Clock,
  CheckCircle,
  Crown,
  Star
} from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { useFirebase } from './contexts/FirebaseContext';
import { useEffect, useState } from 'react';
import type { Show } from './types/Show';
import type { Prop } from './types/props';
import type { CardData } from './types/taskManager';
import { Link } from 'react-router-dom';
import { useWebAuth } from './contexts/WebAuthContext';

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};
const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: { duration: 0.4 }
  },
  hover: {
    scale: 1.02,
    transition: { duration: 0.2 }
  }
};
const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.5 }
  }
};

const DashboardHome: React.FC = () => {
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const [cards, setCards] = useState<CardData[]>([]);
  const { user, userProfile } = useWebAuth();

  // Fetch show
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShow({ ...doc.data, id: doc.id }),
      () => setShow(null)
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch props
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToCollection<Prop>(
      'props',
      data => setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...doc.data, id: doc.id }))),
      () => setProps([])
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch boards and cards
  useEffect(() => {
    if (!currentShowId) return;
    let unsubBoards: (() => void) | undefined;
    let unsubCards: (() => void)[] = [];
    unsubBoards = service.listenToCollection(
      'todo_boards',
      docs => {
        const filteredBoards = docs.filter(b => b.data.showId === currentShowId);
        // Listen to all cards in all lists in all boards
        unsubCards.forEach(u => u && u());
        unsubCards = [];
        filteredBoards.forEach(board => {
          service.listenToCollection(
            `todo_boards/${board.id}/lists`,
            lists => {
              lists.forEach(list => {
                const unsub = service.listenToCollection(
                  `todo_boards/${board.id}/lists/${list.id}/cards`,
                  cardsDocs => {
                    setCards(prev => {
                      // Remove old cards for this list
                      const other = prev.filter(c => c.listId !== list.id);
                      return [
                        ...other,
                        ...cardsDocs.map(cd => ({ ...(cd.data as CardData), id: cd.id, listId: list.id }))
                      ];
                    });
                  },
                  () => {}
                );
                unsubCards.push(unsub);
              });
            },
            () => {}
          );
        });
      },
      () => {}
    );
    return () => { if (unsubBoards) unsubBoards(); unsubCards.forEach(u => u && u()); };
  }, [service, currentShowId]);

  // Calculate stats
  const totalProps = props.length;
  const totalOutstandingTasks = cards.filter(card => !card.completed).length;
  const readyProps = props.filter(p => p.status === 'with-stage-management').length;
  const showReadyPercent = totalProps > 0 ? Math.round((readyProps / totalProps) * 100) : 0;

  // Recent props activity: list of props recently added or updated (one entry per prop)
  function toDateSafe(input: any): Date | null {
    if (!input) return null;
    if (input instanceof Date) return input;
    if (typeof input === 'number') return new Date(input);
    if (typeof input === 'string' && input.trim() !== '') {
      const parsed = new Date(input);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
    if (input && typeof input.toDate === 'function') {
      try {
        const d = input.toDate();
        return d instanceof Date && !isNaN(d.getTime()) ? d : null;
      } catch {
        return null;
      }
    }
    return null;
  }

  const recentActivity = props
    .map(p => {
      const created = toDateSafe((p as any).createdAt);
      const updated = toDateSafe((p as any).updatedAt);
      const latest = updated && (!created || updated >= created) ? updated : created;
      const type = updated && created ? (updated >= created ? 'updated' : 'added') : (updated ? 'updated' : 'added');
      return latest ? { prop: p, type, date: latest } : null;
    })
    .filter((x): x is { prop: Prop; type: 'added' | 'updated'; date: Date } => Boolean(x))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);

  // Urgent tasks row
  const now = new Date();
  const tasksWithDue = cards.filter(card => card.dueDate && !card.completed).map(card => ({
    ...card,
    due: card.dueDate ? new Date(card.dueDate) : new Date()
  })).sort((a, b) => a.due.getTime() - b.due.getTime()).slice(0, 6);

  // Cards assigned to or mentioning the current user
  const assignedOrMentionedCards = cards.filter(card => {
    if (!user) return false;
    const assigned = Array.isArray(card.assignedTo) && card.assignedTo.includes(user.uid);
    const mention = (userProfile && card.description && (
      (userProfile.displayName && card.description.includes(userProfile.displayName)) ||
      (userProfile.email && card.description.includes(userProfile.email))
    ));
    return assigned || mention;
  });

  function getTaskColor(due: Date) {
    if (due < now) return 'bg-red-600 text-white';
    const diff = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (diff < 2) return 'bg-orange-500 text-white';
    return 'bg-green-600 text-white';
  }

  function isValidDateString(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  // Days until first performance
  let daysLeft = null;
  let perfDate: Date | null = null;
  const perfRaw = (show as any)?.firstPerformanceDate || show?.startDate;
  const temp = perfRaw;
  if (typeof temp === 'string' && temp.trim() !== '') {
    perfDate = new Date(temp);
  } else if (typeof temp === 'number' && !isNaN(temp)) {
    perfDate = new Date(temp);
  } else if (temp && typeof temp.toDate === 'function') {
    perfDate = temp.toDate();
  }
  if (perfDate) {
    daysLeft = Math.max(0, Math.ceil((perfDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));
  }

  // Find the next upcoming show date
  let nextShowDateLabel = '';
  if (show) {
    const now = new Date();
    const dateFields = [
      { key: 'rehearsalStartDate', label: 'Rehearsal' },
      { key: 'techWeekStartDate', label: 'Tech Week' },
      { key: 'firstPerformanceDate', label: 'First Performance' },
      { key: 'pressNightDate', label: 'Press Night' },
      { key: 'startDate', label: 'Start' },
      { key: 'endDate', label: 'End' },
    ];
    const upcoming = dateFields
      .map(({ key, label }) => {
        const raw = (show as any)[key];
        let date: Date | null = null;
        const temp = raw;
        if (isValidDateString(temp) && temp !== undefined) {
          date = new Date(temp);
        } else if (typeof temp === 'number' && !isNaN(temp)) {
          date = new Date(temp);
        } else if (temp && typeof temp.toDate === 'function') {
          date = temp.toDate();
        }
        return date && date > now ? { date, label } : null;
      })
      .filter(Boolean) as { date: Date; label: string }[];
    if (upcoming.length > 0) {
      const soonest = upcoming.reduce((a, b) => (a.date < b.date ? a : b));
      if (soonest.date instanceof Date && !isNaN(soonest.date.getTime())) {
        nextShowDateLabel = `Next Show Date: ${soonest.label} – ${soonest.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
      } else {
        nextShowDateLabel = `Next Show Date: ${soonest.label}`;
      }
    } else {
      nextShowDateLabel = 'No upcoming show dates';
    }
  }

  return (
    <DashboardLayout>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="max-w-7xl mx-auto space-y-6"
      >
        {/* Show Banner */}
        <motion.div
          variants={cardVariants}
          className="bg-gradient-to-r from-pb-primary to-pb-secondary rounded-2xl p-6 relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-pb-primary/20 to-pb-secondary/20 backdrop-blur-sm"></div>
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  {show?.name || 'Select a Show'}
                </h2>
                <p className="text-pb-light/80">{nextShowDateLabel}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">{daysLeft !== null ? `${daysLeft} days` : '--'}</div>
                <div className="text-pb-light/80 text-sm">until first night</div>
              </div>
            </div>
            <div className="w-full bg-pb-light/20 rounded-full h-2">
              <motion.div
                className="bg-pb-success h-2 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${showReadyPercent}%` }}
                transition={{ duration: 1, delay: 0.5 }}
              />
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Statistics Cards */}
          <motion.div variants={itemVariants} className="lg:col-span-2">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {[
                { icon: Package2, label: 'Total Props', value: totalProps, color: 'bg-pb-blue' },
                { icon: Clock, label: 'Pending Tasks', value: totalOutstandingTasks, color: 'bg-pb-orange' },
                { icon: CheckCircle, label: 'Ready for Show', value: `${showReadyPercent}%`, color: 'bg-pb-success' },
              ].map((stat, index) => (
                <motion.div
                  key={index}
                  variants={cardVariants}
                  whileHover="hover"
                  className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-4 border border-pb-primary/20"
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-10 h-10 ${stat.color}/20 rounded-xl flex items-center justify-center`}>
                      <stat.icon className={`w-5 h-5 ${stat.color.replace('bg-', 'text-')}`} />
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-white mb-1">{stat.value}</div>
                  <div className="text-sm text-pb-gray">{stat.label}</div>
                </motion.div>
              ))}
            </div>

            {/* Urgent Tasks Row */}
            <motion.div variants={itemVariants}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className="w-5 h-5 text-pb-primary" />
                <h3 className="text-lg font-semibold text-white">Urgent Tasks</h3>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {tasksWithDue.length === 0 && <div className="text-pb-gray">No urgent tasks.</div>}
                {tasksWithDue.map((task) => (
                  <Link key={task.id} to={`/boards?cardId=${task.id}`} className="min-w-[220px]">
                    <div className={`p-4 rounded-xl shadow ${getTaskColor(task.due)}`}>
                      <div className="font-bold text-lg">{task.title}</div>
                      <div className="text-xs mb-1">Due: {task.due.toLocaleString()}</div>
                      <div className="text-xs">{task.description}</div>
                    </div>
                  </Link>
                ))}
              </div>
            </motion.div>{user && assignedOrMentionedCards.length > 0 && (
          <motion.div variants={itemVariants}>
            <div className="flex items-center space-x-2 mb-4 mt-6">
              <Star className="w-5 h-5 text-pb-accent" />
              <h3 className="text-lg font-semibold text-white">Your Tasks</h3>
            </div>
            <div className="flex gap-3 overflow-x-auto pb-2">
              {assignedOrMentionedCards.map(card => (
                <Link key={card.id} to={`/boards?cardId=${card.id}`} className="min-w-[220px]">
                  <div className="p-4 rounded-xl shadow bg-pb-primary/80 text-white">
                    <div className="font-bold text-lg">{card.title}</div>
                    {card.dueDate && <div className="text-xs mb-1">Due: {new Date(card.dueDate).toLocaleString()}</div>}
                    <div className="text-xs line-clamp-2">{card.description}</div>
            </div>
                </Link>
            ))}
          </div>
        </motion.div>
        )}

          </motion.div>

          {/* Recent Props Activity */}
          <motion.div variants={itemVariants} className="lg:col-span-1">
            <div className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-6 border border-pb-primary/20 h-full">
              <div className="flex items-center space-x-2 mb-4">
                <FileText className="w-5 h-5 text-pb-accent" />
                <h3 className="text-lg font-semibold text-white">Recent Props Activity</h3>
              </div>
              
              <div className="space-y-4">
                {recentActivity.length === 0 && <div className="text-pb-gray">No recent activity.</div>}
                {recentActivity.map((activity, index) => (
                  <motion.div
                    key={index}
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.1 }}
                    className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                  >
                    <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                      <Crown className="w-4 h-4 text-pb-accent" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-white">{activity.prop.name}</p>
                      <p className="text-xs text-pb-gray">{activity.type === 'added' ? 'Prop added' : 'Prop updated'}</p>
                      <p className="text-xs text-pb-gray mt-1">{activity.date ? new Date(activity.date).toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''}</p>
                    </div>
                  </motion.div>
                ))}
              </div>
            </div>
          </motion.div>
        </div>

        {/* Assigned/Mentioned Tasks Row */}
        
      </motion.div>
    </DashboardLayout>
  );
};

export default DashboardHome; 
```

- I updated `web-app/src/DashboardHome.tsx` so “Recent Props Activity” now strictly shows the props most recently added or updated, one entry per prop, sorted by latest date. Status history entries are no longer included.
- Implemented a robust `toDateSafe` helper to normalize timestamps from strings, numbers, Date, or Firestore Timestamp.
- Simplified the rendering to display either “Prop added” or “Prop updated” with the date.
- Cleaned up unused imports and variables, removed `boards` state usage and related set call, and fixed a type error in the recent activity rendering.
- Fixed an unused variable in the urgent tasks map.

What I changed at a glance
- Recent activity computation now:
  ```ts
  const recentActivity = props
    .map(p => {
      const created = toDateSafe(p.createdAt as any);
      const updated = toDateSafe(p.updatedAt as any);
      const latest = updated && (!created || updated >= created) ? updated : created;
      const type = updated && created ? (updated >= created ? 'updated' : 'added') : (updated ? 'updated' : 'added');
      return latest ? { prop: p, type, date: latest } : null;
    })
    .filter(Boolean)
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);
  ```
- UI shows prop name, “Prop added/updated”, and the date.

- Lint: Clean; removed unused imports and `setBoards` reference.

If you want a different count (e.g., top 10) or to include both created and updated entries when they’re close in time, I can tweak it quickly.

```typescript
  const recentActivity = props
    .map(p => {
      const created = toDateSafe(p.createdAt as any);
      const updated = toDateSafe(p.updatedAt as any);
      const latest = updated && (!created || updated >= created) ? updated : created;
      const type = updated && created ? (updated >= created ? 'updated' : 'added') : (updated ? 'updated' : 'added');
      return latest ? { prop: p, type, date: latest } : null;
    })
    .filter(Boolean)
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);
```

---

**User**

can you make each prop a link to that props details page also add the recently updated too.

---

**Cursor**

I'll look for the prop details route and component so I can link each recent item correctly, and then update the dashboard to render two lists: Recently Added and Recently Updated, with each item linking to the prop's details.

I’m going to update `DashboardHome.tsx` to:
- Compute two lists: `recentlyAdded` and `recentlyUpdated`
- Render both lists under “Recent Props Activity”
- Wrap each item with a `Link` to `/props/:id`
Then I’ll run a linter check on the file.

```typescriptreact
import React from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { motion } from 'framer-motion';
import {
  FileText,
  Package2,
  Clock,
  CheckCircle,
  Crown,
  Star
} from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { useFirebase } from './contexts/FirebaseContext';
import { useEffect, useState } from 'react';
import type { Show } from './types/Show';
import type { Prop } from './types/props';
import type { CardData } from './types/taskManager';
import { Link } from 'react-router-dom';
import { useWebAuth } from './contexts/WebAuthContext';

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};
const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: { duration: 0.4 }
  },
  hover: {
    scale: 1.02,
    transition: { duration: 0.2 }
  }
};
const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.5 }
  }
};

const DashboardHome: React.FC = () => {
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const [cards, setCards] = useState<CardData[]>([]);
  const { user, userProfile } = useWebAuth();

  // Fetch show
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShow({ ...doc.data, id: doc.id }),
      () => setShow(null)
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch props
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToCollection<Prop>(
      'props',
      data => setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...doc.data, id: doc.id }))),
      () => setProps([])
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch boards and cards
  useEffect(() => {
    if (!currentShowId) return;
    let unsubBoards: (() => void) | undefined;
    let unsubCards: (() => void)[] = [];
    unsubBoards = service.listenToCollection(
      'todo_boards',
      docs => {
        const filteredBoards = docs.filter(b => b.data.showId === currentShowId);
        // Listen to all cards in all lists in all boards
        unsubCards.forEach(u => u && u());
        unsubCards = [];
        filteredBoards.forEach(board => {
          service.listenToCollection(
            `todo_boards/${board.id}/lists`,
            lists => {
              lists.forEach(list => {
                const unsub = service.listenToCollection(
                  `todo_boards/${board.id}/lists/${list.id}/cards`,
                  cardsDocs => {
                    setCards(prev => {
                      // Remove old cards for this list
                      const other = prev.filter(c => c.listId !== list.id);
                      return [
                        ...other,
                        ...cardsDocs.map(cd => ({ ...(cd.data as CardData), id: cd.id, listId: list.id }))
                      ];
                    });
                  },
                  () => {}
                );
                unsubCards.push(unsub);
              });
            },
            () => {}
          );
        });
      },
      () => {}
    );
    return () => { if (unsubBoards) unsubBoards(); unsubCards.forEach(u => u && u()); };
  }, [service, currentShowId]);

  // Calculate stats
  const totalProps = props.length;
  const totalOutstandingTasks = cards.filter(card => !card.completed).length;
  const readyProps = props.filter(p => p.status === 'with-stage-management').length;
  const showReadyPercent = totalProps > 0 ? Math.round((readyProps / totalProps) * 100) : 0;

  // Recent props activity: list of props recently added or updated (one entry per prop)
  function toDateSafe(input: any): Date | null {
    if (!input) return null;
    if (input instanceof Date) return input;
    if (typeof input === 'number') return new Date(input);
    if (typeof input === 'string' && input.trim() !== '') {
      const parsed = new Date(input);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
    if (input && typeof input.toDate === 'function') {
      try {
        const d = input.toDate();
        return d instanceof Date && !isNaN(d.getTime()) ? d : null;
      } catch {
        return null;
      }
    }
    return null;
  }

  const recentlyAdded = props
    .map(p => ({ prop: p, date: toDateSafe((p as any).createdAt) }))
    .filter((x): x is { prop: Prop; date: Date } => Boolean(x.date))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);

  const recentlyUpdated = props
    .map(p => {
      const created = toDateSafe((p as any).createdAt);
      const updated = toDateSafe((p as any).updatedAt);
      if (!updated) return null;
      if (created && updated.getTime() <= created.getTime()) return null; // exclude items not updated after creation
      return { prop: p, date: updated };
    })
    .filter((x): x is { prop: Prop; date: Date } => Boolean(x))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);

  // Urgent tasks row
  const now = new Date();
  const tasksWithDue = cards.filter(card => card.dueDate && !card.completed).map(card => ({
    ...card,
    due: card.dueDate ? new Date(card.dueDate) : new Date()
  })).sort((a, b) => a.due.getTime() - b.due.getTime()).slice(0, 6);

  // Cards assigned to or mentioning the current user
  const assignedOrMentionedCards = cards.filter(card => {
    if (!user) return false;
    const assigned = Array.isArray(card.assignedTo) && card.assignedTo.includes(user.uid);
    const mention = (userProfile && card.description && (
      (userProfile.displayName && card.description.includes(userProfile.displayName)) ||
      (userProfile.email && card.description.includes(userProfile.email))
    ));
    return assigned || mention;
  });

  function getTaskColor(due: Date) {
    if (due < now) return 'bg-red-600 text-white';
    const diff = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (diff < 2) return 'bg-orange-500 text-white';
    return 'bg-green-600 text-white';
  }

  function isValidDateString(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  // Days until first performance
  let daysLeft = null;
  let perfDate: Date | null = null;
  const perfRaw = (show as any)?.firstPerformanceDate || show?.startDate;
  const temp = perfRaw;
  if (typeof temp === 'string' && temp.trim() !== '') {
    perfDate = new Date(temp);
  } else if (typeof temp === 'number' && !isNaN(temp)) {
    perfDate = new Date(temp);
  } else if (temp && typeof temp.toDate === 'function') {
    perfDate = temp.toDate();
  }
  if (perfDate) {
    daysLeft = Math.max(0, Math.ceil((perfDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));
  }

  // Find the next upcoming show date
  let nextShowDateLabel = '';
  if (show) {
    const now = new Date();
    const dateFields = [
      { key: 'rehearsalStartDate', label: 'Rehearsal' },
      { key: 'techWeekStartDate', label: 'Tech Week' },
      { key: 'firstPerformanceDate', label: 'First Performance' },
      { key: 'pressNightDate', label: 'Press Night' },
      { key: 'startDate', label: 'Start' },
      { key: 'endDate', label: 'End' },
    ];
    const upcoming = dateFields
      .map(({ key, label }) => {
        const raw = (show as any)[key];
        let date: Date | null = null;
        const temp = raw;
        if (isValidDateString(temp) && temp !== undefined) {
          date = new Date(temp);
        } else if (typeof temp === 'number' && !isNaN(temp)) {
          date = new Date(temp);
        } else if (temp && typeof temp.toDate === 'function') {
          date = temp.toDate();
        }
        return date && date > now ? { date, label } : null;
      })
      .filter(Boolean) as { date: Date; label: string }[];
    if (upcoming.length > 0) {
      const soonest = upcoming.reduce((a, b) => (a.date < b.date ? a : b));
      if (soonest.date instanceof Date && !isNaN(soonest.date.getTime())) {
        nextShowDateLabel = `Next Show Date: ${soonest.label} – ${soonest.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
      } else {
        nextShowDateLabel = `Next Show Date: ${soonest.label}`;
      }
    } else {
      nextShowDateLabel = 'No upcoming show dates';
    }
  }

  return (
    <DashboardLayout>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="max-w-7xl mx-auto space-y-6"
      >
        {/* Show Banner */}
        <motion.div
          variants={cardVariants}
          className="bg-gradient-to-r from-pb-primary to-pb-secondary rounded-2xl p-6 relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-pb-primary/20 to-pb-secondary/20 backdrop-blur-sm"></div>
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  {show?.name || 'Select a Show'}
                </h2>
                <p className="text-pb-light/80">{nextShowDateLabel}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">{daysLeft !== null ? `${daysLeft} days` : '--'}</div>
                <div className="text-pb-light/80 text-sm">until first night</div>
              </div>
            </div>
            <div className="w-full bg-pb-light/20 rounded-full h-2">
              <motion.div
                className="bg-pb-success h-2 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${showReadyPercent}%` }}
                transition={{ duration: 1, delay: 0.5 }}
              />
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Statistics Cards */}
          <motion.div variants={itemVariants} className="lg:col-span-2">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {[
                { icon: Package2, label: 'Total Props', value: totalProps, color: 'bg-pb-blue' },
                { icon: Clock, label: 'Pending Tasks', value: totalOutstandingTasks, color: 'bg-pb-orange' },
                { icon: CheckCircle, label: 'Ready for Show', value: `${showReadyPercent}%`, color: 'bg-pb-success' },
              ].map((stat, index) => (
                <motion.div
                  key={index}
                  variants={cardVariants}
                  whileHover="hover"
                  className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-4 border border-pb-primary/20"
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-10 h-10 ${stat.color}/20 rounded-xl flex items-center justify-center`}>
                      <stat.icon className={`w-5 h-5 ${stat.color.replace('bg-', 'text-')}`} />
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-white mb-1">{stat.value}</div>
                  <div className="text-sm text-pb-gray">{stat.label}</div>
                </motion.div>
              ))}
            </div>

            {/* Urgent Tasks Row */}
            <motion.div variants={itemVariants}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className="w-5 h-5 text-pb-primary" />
                <h3 className="text-lg font-semibold text-white">Urgent Tasks</h3>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {tasksWithDue.length === 0 && <div className="text-pb-gray">No urgent tasks.</div>}
                {tasksWithDue.map((task) => (
                  <Link key={task.id} to={`/boards?cardId=${task.id}`} className="min-w-[220px]">
                    <div className={`p-4 rounded-xl shadow ${getTaskColor(task.due)}`}>
                      <div className="font-bold text-lg">{task.title}</div>
                      <div className="text-xs mb-1">Due: {task.due.toLocaleString()}</div>
                      <div className="text-xs">{task.description}</div>
                    </div>
                  </Link>
                ))}
              </div>
            </motion.div>{user && assignedOrMentionedCards.length > 0 && (
          <motion.div variants={itemVariants}>
            <div className="flex items-center space-x-2 mb-4 mt-6">
              <Star className="w-5 h-5 text-pb-accent" />
              <h3 className="text-lg font-semibold text-white">Your Tasks</h3>
            </div>
            <div className="flex gap-3 overflow-x-auto pb-2">
              {assignedOrMentionedCards.map(card => (
                <Link key={card.id} to={`/boards?cardId=${card.id}`} className="min-w-[220px]">
                  <div className="p-4 rounded-xl shadow bg-pb-primary/80 text-white">
                    <div className="font-bold text-lg">{card.title}</div>
                    {card.dueDate && <div className="text-xs mb-1">Due: {new Date(card.dueDate).toLocaleString()}</div>}
                    <div className="text-xs line-clamp-2">{card.description}</div>
            </div>
                </Link>
            ))}
          </div>
        </motion.div>
        )}

          </motion.div>

          {/* Recent Props Activity */}
          <motion.div variants={itemVariants} className="lg:col-span-1">
            <div className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-6 border border-pb-primary/20 h-full">
              <div className="flex items-center space-x-2 mb-4">
                <FileText className="w-5 h-5 text-pb-accent" />
                <h3 className="text-lg font-semibold text-white">Recent Props Activity</h3>
              </div>
              
              <div className="space-y-4">
                {recentActivity.length === 0 && <div className="text-pb-gray">No recent activity.</div>}
                {recentActivity.map((activity, index) => (
                  <motion.div
                    key={index}
                    initial={{ opacity: 0, x: 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.1 }}
                    className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                  >
                    <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                      <Crown className="w-4 h-4 text-pb-accent" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-white">{activity.prop.name}</p>
                      <p className="text-xs text-pb-gray">{activity.type === 'added' ? 'Prop added' : 'Prop updated'}</p>
                      <p className="text-xs text-pb-gray mt-1">{activity.date ? new Date(activity.date).toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : ''}</p>
                    </div>
                  </motion.div>
                ))}
              </div>
            </div>
          </motion.div>
        </div>

        {/* Assigned/Mentioned Tasks Row */}
        
      </motion.div>
    </DashboardLayout>
  );
};

export default DashboardHome; 
```

```typescriptreact
import React from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { motion } from 'framer-motion';
import {
  FileText,
  Package2,
  Clock,
  CheckCircle,
  Crown,
  Star
} from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { useFirebase } from './contexts/FirebaseContext';
import { useEffect, useState } from 'react';
import type { Show } from './types/Show';
import type { Prop } from './types/props';
import type { CardData } from './types/taskManager';
import { Link } from 'react-router-dom';
import { useWebAuth } from './contexts/WebAuthContext';

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};
const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: { duration: 0.4 }
  },
  hover: {
    scale: 1.02,
    transition: { duration: 0.2 }
  }
};
const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.5 }
  }
};

const DashboardHome: React.FC = () => {
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const [cards, setCards] = useState<CardData[]>([]);
  const { user, userProfile } = useWebAuth();

  // Fetch show
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShow({ ...doc.data, id: doc.id }),
      () => setShow(null)
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch props
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToCollection<Prop>(
      'props',
      data => setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...doc.data, id: doc.id }))),
      () => setProps([])
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch boards and cards
  useEffect(() => {
    if (!currentShowId) return;
    let unsubBoards: (() => void) | undefined;
    let unsubCards: (() => void)[] = [];
    unsubBoards = service.listenToCollection(
      'todo_boards',
      docs => {
        const filteredBoards = docs.filter(b => b.data.showId === currentShowId);
        // Listen to all cards in all lists in all boards
        unsubCards.forEach(u => u && u());
        unsubCards = [];
        filteredBoards.forEach(board => {
          service.listenToCollection(
            `todo_boards/${board.id}/lists`,
            lists => {
              lists.forEach(list => {
                const unsub = service.listenToCollection(
                  `todo_boards/${board.id}/lists/${list.id}/cards`,
                  cardsDocs => {
                    setCards(prev => {
                      // Remove old cards for this list
                      const other = prev.filter(c => c.listId !== list.id);
                      return [
                        ...other,
                        ...cardsDocs.map(cd => ({ ...(cd.data as CardData), id: cd.id, listId: list.id }))
                      ];
                    });
                  },
                  () => {}
                );
                unsubCards.push(unsub);
              });
            },
            () => {}
          );
        });
      },
      () => {}
    );
    return () => { if (unsubBoards) unsubBoards(); unsubCards.forEach(u => u && u()); };
  }, [service, currentShowId]);

  // Calculate stats
  const totalProps = props.length;
  const totalOutstandingTasks = cards.filter(card => !card.completed).length;
  const readyProps = props.filter(p => p.status === 'with-stage-management').length;
  const showReadyPercent = totalProps > 0 ? Math.round((readyProps / totalProps) * 100) : 0;

  // Recent props activity: list of props recently added or updated (one entry per prop)
  function toDateSafe(input: any): Date | null {
    if (!input) return null;
    if (input instanceof Date) return input;
    if (typeof input === 'number') return new Date(input);
    if (typeof input === 'string' && input.trim() !== '') {
      const parsed = new Date(input);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
    if (input && typeof input.toDate === 'function') {
      try {
        const d = input.toDate();
        return d instanceof Date && !isNaN(d.getTime()) ? d : null;
      } catch {
        return null;
      }
    }
    return null;
  }

  const recentlyAdded = props
    .map(p => ({ prop: p, date: toDateSafe((p as any).createdAt) }))
    .filter((x): x is { prop: Prop; date: Date } => Boolean(x.date))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);

  const recentlyUpdated = props
    .map(p => {
      const created = toDateSafe((p as any).createdAt);
      const updated = toDateSafe((p as any).updatedAt);
      if (!updated) return null;
      if (created && updated.getTime() <= created.getTime()) return null; // exclude items not updated after creation
      return { prop: p, date: updated };
    })
    .filter((x): x is { prop: Prop; date: Date } => Boolean(x))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 4);

  // Urgent tasks row
  const now = new Date();
  const tasksWithDue = cards.filter(card => card.dueDate && !card.completed).map(card => ({
    ...card,
    due: card.dueDate ? new Date(card.dueDate) : new Date()
  })).sort((a, b) => a.due.getTime() - b.due.getTime()).slice(0, 6);

  // Cards assigned to or mentioning the current user
  const assignedOrMentionedCards = cards.filter(card => {
    if (!user) return false;
    const assigned = Array.isArray(card.assignedTo) && card.assignedTo.includes(user.uid);
    const mention = (userProfile && card.description && (
      (userProfile.displayName && card.description.includes(userProfile.displayName)) ||
      (userProfile.email && card.description.includes(userProfile.email))
    ));
    return assigned || mention;
  });

  function getTaskColor(due: Date) {
    if (due < now) return 'bg-red-600 text-white';
    const diff = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (diff < 2) return 'bg-orange-500 text-white';
    return 'bg-green-600 text-white';
  }

  function isValidDateString(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  // Days until first performance
  let daysLeft = null;
  let perfDate: Date | null = null;
  const perfRaw = (show as any)?.firstPerformanceDate || show?.startDate;
  const temp = perfRaw;
  if (typeof temp === 'string' && temp.trim() !== '') {
    perfDate = new Date(temp);
  } else if (typeof temp === 'number' && !isNaN(temp)) {
    perfDate = new Date(temp);
  } else if (temp && typeof temp.toDate === 'function') {
    perfDate = temp.toDate();
  }
  if (perfDate) {
    daysLeft = Math.max(0, Math.ceil((perfDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));
  }

  // Find the next upcoming show date
  let nextShowDateLabel = '';
  if (show) {
    const now = new Date();
    const dateFields = [
      { key: 'rehearsalStartDate', label: 'Rehearsal' },
      { key: 'techWeekStartDate', label: 'Tech Week' },
      { key: 'firstPerformanceDate', label: 'First Performance' },
      { key: 'pressNightDate', label: 'Press Night' },
      { key: 'startDate', label: 'Start' },
      { key: 'endDate', label: 'End' },
    ];
    const upcoming = dateFields
      .map(({ key, label }) => {
        const raw = (show as any)[key];
        let date: Date | null = null;
        const temp = raw;
        if (isValidDateString(temp) && temp !== undefined) {
          date = new Date(temp);
        } else if (typeof temp === 'number' && !isNaN(temp)) {
          date = new Date(temp);
        } else if (temp && typeof temp.toDate === 'function') {
          date = temp.toDate();
        }
        return date && date > now ? { date, label } : null;
      })
      .filter(Boolean) as { date: Date; label: string }[];
    if (upcoming.length > 0) {
      const soonest = upcoming.reduce((a, b) => (a.date < b.date ? a : b));
      if (soonest.date instanceof Date && !isNaN(soonest.date.getTime())) {
        nextShowDateLabel = `Next Show Date: ${soonest.label} – ${soonest.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
      } else {
        nextShowDateLabel = `Next Show Date: ${soonest.label}`;
      }
    } else {
      nextShowDateLabel = 'No upcoming show dates';
    }
  }

  return (
    <DashboardLayout>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="max-w-7xl mx-auto space-y-6"
      >
        {/* Show Banner */}
        <motion.div
          variants={cardVariants}
          className="bg-gradient-to-r from-pb-primary to-pb-secondary rounded-2xl p-6 relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-pb-primary/20 to-pb-secondary/20 backdrop-blur-sm"></div>
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  {show?.name || 'Select a Show'}
                </h2>
                <p className="text-pb-light/80">{nextShowDateLabel}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">{daysLeft !== null ? `${daysLeft} days` : '--'}</div>
                <div className="text-pb-light/80 text-sm">until first night</div>
              </div>
            </div>
            <div className="w-full bg-pb-light/20 rounded-full h-2">
              <motion.div
                className="bg-pb-success h-2 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${showReadyPercent}%` }}
                transition={{ duration: 1, delay: 0.5 }}
              />
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Statistics Cards */}
          <motion.div variants={itemVariants} className="lg:col-span-2">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {[
                { icon: Package2, label: 'Total Props', value: totalProps, color: 'bg-pb-blue' },
                { icon: Clock, label: 'Pending Tasks', value: totalOutstandingTasks, color: 'bg-pb-orange' },
                { icon: CheckCircle, label: 'Ready for Show', value: `${showReadyPercent}%`, color: 'bg-pb-success' },
              ].map((stat, index) => (
                <motion.div
                  key={index}
                  variants={cardVariants}
                  whileHover="hover"
                  className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-4 border border-pb-primary/20"
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-10 h-10 ${stat.color}/20 rounded-xl flex items-center justify-center`}>
                      <stat.icon className={`w-5 h-5 ${stat.color.replace('bg-', 'text-')}`} />
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-white mb-1">{stat.value}</div>
                  <div className="text-sm text-pb-gray">{stat.label}</div>
                </motion.div>
              ))}
            </div>

            {/* Urgent Tasks Row */}
            <motion.div variants={itemVariants}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className="w-5 h-5 text-pb-primary" />
                <h3 className="text-lg font-semibold text-white">Urgent Tasks</h3>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {tasksWithDue.length === 0 && <div className="text-pb-gray">No urgent tasks.</div>}
                {tasksWithDue.map((task) => (
                  <Link key={task.id} to={`/boards?cardId=${task.id}`} className="min-w-[220px]">
                    <div className={`p-4 rounded-xl shadow ${getTaskColor(task.due)}`}>
                      <div className="font-bold text-lg">{task.title}</div>
                      <div className="text-xs mb-1">Due: {task.due.toLocaleString()}</div>
                      <div className="text-xs">{task.description}</div>
                    </div>
                  </Link>
                ))}
              </div>
            </motion.div>{user && assignedOrMentionedCards.length > 0 && (
          <motion.div variants={itemVariants}>
            <div className="flex items-center space-x-2 mb-4 mt-6">
              <Star className="w-5 h-5 text-pb-accent" />
              <h3 className="text-lg font-semibold text-white">Your Tasks</h3>
            </div>
            <div className="flex gap-3 overflow-x-auto pb-2">
              {assignedOrMentionedCards.map(card => (
                <Link key={card.id} to={`/boards?cardId=${card.id}`} className="min-w-[220px]">
                  <div className="p-4 rounded-xl shadow bg-pb-primary/80 text-white">
                    <div className="font-bold text-lg">{card.title}</div>
                    {card.dueDate && <div className="text-xs mb-1">Due: {new Date(card.dueDate).toLocaleString()}</div>}
                    <div className="text-xs line-clamp-2">{card.description}</div>
            </div>
                </Link>
            ))}
          </div>
        </motion.div>
        )}

          </motion.div>

          {/* Recent Props Activity */}
          <motion.div variants={itemVariants} className="lg:col-span-1">
            <div className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-6 border border-pb-primary/20 h-full">
              <div className="flex items-center space-x-2 mb-4">
                <FileText className="w-5 h-5 text-pb-accent" />
                <h3 className="text-lg font-semibold text-white">Recent Props Activity</h3>
              </div>
              
              {/* Recently Added */}
              <div className="space-y-3 mb-6">
                <h4 className="text-sm font-semibold text-pb-light/90">Recently Added</h4>
                {recentlyAdded.length === 0 && <div className="text-pb-gray">No recent additions.</div>}
                {recentlyAdded.map((item, index) => (
                  <Link key={`added-${item.prop.id}`} to={`/props/${item.prop.id}`} className="block">
                    <motion.div
                      initial={{ opacity: 0, x: 20 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: index * 0.05 }}
                      className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                    >
                      <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <Crown className="w-4 h-4 text-pb-accent" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-white truncate">{item.prop.name}</p>
                        <p className="text-xs text-pb-gray">Prop added</p>
                        <p className="text-xs text-pb-gray mt-1">{item.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}</p>
                      </div>
                    </motion.div>
                  </Link>
                ))}
              </div>

              {/* Recently Updated */}
              <div className="space-y-3">
                <h4 className="text-sm font-semibold text-pb-light/90">Recently Updated</h4>
                {recentlyUpdated.length === 0 && <div className="text-pb-gray">No recent updates.</div>}
                {recentlyUpdated.map((item, index) => (
                  <Link key={`updated-${item.prop.id}`} to={`/props/${item.prop.id}`} className="block">
                    <motion.div
                      initial={{ opacity: 0, x: 20 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: index * 0.05 }}
                      className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                    >
                      <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <Crown className="w-4 h-4 text-pb-accent" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-white truncate">{item.prop.name}</p>
                        <p className="text-xs text-pb-gray">Prop updated</p>
                        <p className="text-xs text-pb-gray mt-1">{item.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}</p>
                      </div>
                    </motion.div>
                  </Link>
                ))}
              </div>
            </div>
          </motion.div>
        </div>

        {/* Assigned/Mentioned Tasks Row */}
        
      </motion.div>
    </DashboardLayout>
  );
};

export default DashboardHome; 
```

- Added links: Each recent item now links to the prop details page at `/props/:id`.
- Split sections: The “Recent Props Activity” now has two lists:
  - Recently Added: top 4 by `createdAt`
  - Recently Updated: top 4 by `updatedAt` (only when updated after creation)
- Timestamps: Robust conversion handles strings, numbers, Date, and Firestore Timestamp.

If you want different list sizes or combined into a single list with badges, I can adjust quickly.

---

**User**

make the recent lists into a single list

---

**Cursor**

I'll merge the two recent lists into a single combined list that includes both added and updated items, sorted by most recent, and each item links to the prop details page. Applying the edit now and then checking lint.

```typescriptreact
import React from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { motion } from 'framer-motion';
import {
  FileText,
  Package2,
  Clock,
  CheckCircle,
  Crown,
  Star
} from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { useFirebase } from './contexts/FirebaseContext';
import { useEffect, useState } from 'react';
import type { Show } from './types/Show';
import type { Prop } from './types/props';
import type { CardData } from './types/taskManager';
import { Link } from 'react-router-dom';
import { useWebAuth } from './contexts/WebAuthContext';

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};
const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: { duration: 0.4 }
  },
  hover: {
    scale: 1.02,
    transition: { duration: 0.2 }
  }
};
const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.5 }
  }
};

const DashboardHome: React.FC = () => {
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const [cards, setCards] = useState<CardData[]>([]);
  const { user, userProfile } = useWebAuth();

  // Fetch show
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShow({ ...doc.data, id: doc.id }),
      () => setShow(null)
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch props
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToCollection<Prop>(
      'props',
      data => setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...doc.data, id: doc.id }))),
      () => setProps([])
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch boards and cards
  useEffect(() => {
    if (!currentShowId) return;
    let unsubBoards: (() => void) | undefined;
    let unsubCards: (() => void)[] = [];
    unsubBoards = service.listenToCollection(
      'todo_boards',
      docs => {
        const filteredBoards = docs.filter(b => b.data.showId === currentShowId);
        // Listen to all cards in all lists in all boards
        unsubCards.forEach(u => u && u());
        unsubCards = [];
        filteredBoards.forEach(board => {
          service.listenToCollection(
            `todo_boards/${board.id}/lists`,
            lists => {
              lists.forEach(list => {
                const unsub = service.listenToCollection(
                  `todo_boards/${board.id}/lists/${list.id}/cards`,
                  cardsDocs => {
                    setCards(prev => {
                      // Remove old cards for this list
                      const other = prev.filter(c => c.listId !== list.id);
                      return [
                        ...other,
                        ...cardsDocs.map(cd => ({ ...(cd.data as CardData), id: cd.id, listId: list.id }))
                      ];
                    });
                  },
                  () => {}
                );
                unsubCards.push(unsub);
              });
            },
            () => {}
          );
        });
      },
      () => {}
    );
    return () => { if (unsubBoards) unsubBoards(); unsubCards.forEach(u => u && u()); };
  }, [service, currentShowId]);

  // Calculate stats
  const totalProps = props.length;
  const totalOutstandingTasks = cards.filter(card => !card.completed).length;
  const readyProps = props.filter(p => p.status === 'with-stage-management').length;
  const showReadyPercent = totalProps > 0 ? Math.round((readyProps / totalProps) * 100) : 0;

  // Recent props activity: list of props recently added or updated (one entry per prop)
  function toDateSafe(input: any): Date | null {
    if (!input) return null;
    if (input instanceof Date) return input;
    if (typeof input === 'number') return new Date(input);
    if (typeof input === 'string' && input.trim() !== '') {
      const parsed = new Date(input);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
    if (input && typeof input.toDate === 'function') {
      try {
        const d = input.toDate();
        return d instanceof Date && !isNaN(d.getTime()) ? d : null;
      } catch {
        return null;
      }
    }
    return null;
  }

  // Single recent activity list (added or updated, most recent per prop)
  const recentActivity = props
    .map(p => {
      const created = toDateSafe((p as any).createdAt);
      const updated = toDateSafe((p as any).updatedAt);
      const latest = updated && (!created || updated >= created) ? updated : created;
      const type: 'added' | 'updated' = updated && created ? (updated >= created ? 'updated' : 'added') : (updated ? 'updated' : 'added');
      return latest ? { prop: p, type, date: latest } : null;
    })
    .filter((x): x is { prop: Prop; type: 'added' | 'updated'; date: Date } => Boolean(x))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 8);

  // Urgent tasks row
  const now = new Date();
  const tasksWithDue = cards.filter(card => card.dueDate && !card.completed).map(card => ({
    ...card,
    due: card.dueDate ? new Date(card.dueDate) : new Date()
  })).sort((a, b) => a.due.getTime() - b.due.getTime()).slice(0, 6);

  // Cards assigned to or mentioning the current user
  const assignedOrMentionedCards = cards.filter(card => {
    if (!user) return false;
    const assigned = Array.isArray(card.assignedTo) && card.assignedTo.includes(user.uid);
    const mention = (userProfile && card.description && (
      (userProfile.displayName && card.description.includes(userProfile.displayName)) ||
      (userProfile.email && card.description.includes(userProfile.email))
    ));
    return assigned || mention;
  });

  function getTaskColor(due: Date) {
    if (due < now) return 'bg-red-600 text-white';
    const diff = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (diff < 2) return 'bg-orange-500 text-white';
    return 'bg-green-600 text-white';
  }

  function isValidDateString(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  // Days until first performance
  let daysLeft = null;
  let perfDate: Date | null = null;
  const perfRaw = (show as any)?.firstPerformanceDate || show?.startDate;
  const temp = perfRaw;
  if (typeof temp === 'string' && temp.trim() !== '') {
    perfDate = new Date(temp);
  } else if (typeof temp === 'number' && !isNaN(temp)) {
    perfDate = new Date(temp);
  } else if (temp && typeof temp.toDate === 'function') {
    perfDate = temp.toDate();
  }
  if (perfDate) {
    daysLeft = Math.max(0, Math.ceil((perfDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));
  }

  // Find the next upcoming show date
  let nextShowDateLabel = '';
  if (show) {
    const now = new Date();
    const dateFields = [
      { key: 'rehearsalStartDate', label: 'Rehearsal' },
      { key: 'techWeekStartDate', label: 'Tech Week' },
      { key: 'firstPerformanceDate', label: 'First Performance' },
      { key: 'pressNightDate', label: 'Press Night' },
      { key: 'startDate', label: 'Start' },
      { key: 'endDate', label: 'End' },
    ];
    const upcoming = dateFields
      .map(({ key, label }) => {
        const raw = (show as any)[key];
        let date: Date | null = null;
        const temp = raw;
        if (isValidDateString(temp) && temp !== undefined) {
          date = new Date(temp);
        } else if (typeof temp === 'number' && !isNaN(temp)) {
          date = new Date(temp);
        } else if (temp && typeof temp.toDate === 'function') {
          date = temp.toDate();
        }
        return date && date > now ? { date, label } : null;
      })
      .filter(Boolean) as { date: Date; label: string }[];
    if (upcoming.length > 0) {
      const soonest = upcoming.reduce((a, b) => (a.date < b.date ? a : b));
      if (soonest.date instanceof Date && !isNaN(soonest.date.getTime())) {
        nextShowDateLabel = `Next Show Date: ${soonest.label} – ${soonest.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
      } else {
        nextShowDateLabel = `Next Show Date: ${soonest.label}`;
      }
    } else {
      nextShowDateLabel = 'No upcoming show dates';
    }
  }

  return (
    <DashboardLayout>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="max-w-7xl mx-auto space-y-6"
      >
        {/* Show Banner */}
        <motion.div
          variants={cardVariants}
          className="bg-gradient-to-r from-pb-primary to-pb-secondary rounded-2xl p-6 relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-pb-primary/20 to-pb-secondary/20 backdrop-blur-sm"></div>
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  {show?.name || 'Select a Show'}
                </h2>
                <p className="text-pb-light/80">{nextShowDateLabel}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">{daysLeft !== null ? `${daysLeft} days` : '--'}</div>
                <div className="text-pb-light/80 text-sm">until first night</div>
              </div>
            </div>
            <div className="w-full bg-pb-light/20 rounded-full h-2">
              <motion.div
                className="bg-pb-success h-2 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${showReadyPercent}%` }}
                transition={{ duration: 1, delay: 0.5 }}
              />
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Statistics Cards */}
          <motion.div variants={itemVariants} className="lg:col-span-2">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {[
                { icon: Package2, label: 'Total Props', value: totalProps, color: 'bg-pb-blue' },
                { icon: Clock, label: 'Pending Tasks', value: totalOutstandingTasks, color: 'bg-pb-orange' },
                { icon: CheckCircle, label: 'Ready for Show', value: `${showReadyPercent}%`, color: 'bg-pb-success' },
              ].map((stat, index) => (
                <motion.div
                  key={index}
                  variants={cardVariants}
                  whileHover="hover"
                  className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-4 border border-pb-primary/20"
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-10 h-10 ${stat.color}/20 rounded-xl flex items-center justify-center`}>
                      <stat.icon className={`w-5 h-5 ${stat.color.replace('bg-', 'text-')}`} />
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-white mb-1">{stat.value}</div>
                  <div className="text-sm text-pb-gray">{stat.label}</div>
                </motion.div>
              ))}
            </div>

            {/* Urgent Tasks Row */}
            <motion.div variants={itemVariants}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className="w-5 h-5 text-pb-primary" />
                <h3 className="text-lg font-semibold text-white">Urgent Tasks</h3>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {tasksWithDue.length === 0 && <div className="text-pb-gray">No urgent tasks.</div>}
                {tasksWithDue.map((task) => (
                  <Link key={task.id} to={`/boards?cardId=${task.id}`} className="min-w-[220px]">
                    <div className={`p-4 rounded-xl shadow ${getTaskColor(task.due)}`}>
                      <div className="font-bold text-lg">{task.title}</div>
                      <div className="text-xs mb-1">Due: {task.due.toLocaleString()}</div>
                      <div className="text-xs">{task.description}</div>
                    </div>
                  </Link>
                ))}
              </div>
            </motion.div>{user && assignedOrMentionedCards.length > 0 && (
          <motion.div variants={itemVariants}>
            <div className="flex items-center space-x-2 mb-4 mt-6">
              <Star className="w-5 h-5 text-pb-accent" />
              <h3 className="text-lg font-semibold text-white">Your Tasks</h3>
            </div>
            <div className="flex gap-3 overflow-x-auto pb-2">
              {assignedOrMentionedCards.map(card => (
                <Link key={card.id} to={`/boards?cardId=${card.id}`} className="min-w-[220px]">
                  <div className="p-4 rounded-xl shadow bg-pb-primary/80 text-white">
                    <div className="font-bold text-lg">{card.title}</div>
                    {card.dueDate && <div className="text-xs mb-1">Due: {new Date(card.dueDate).toLocaleString()}</div>}
                    <div className="text-xs line-clamp-2">{card.description}</div>
            </div>
                </Link>
            ))}
          </div>
        </motion.div>
        )}

          </motion.div>

          {/* Recent Props Activity */}
          <motion.div variants={itemVariants} className="lg:col-span-1">
            <div className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-6 border border-pb-primary/20 h-full">
              <div className="flex items-center space-x-2 mb-4">
                <FileText className="w-5 h-5 text-pb-accent" />
                <h3 className="text-lg font-semibold text-white">Recent Props Activity</h3>
              </div>
              
              {/* Recently Added */}
              <div className="space-y-3 mb-6">
                <h4 className="text-sm font-semibold text-pb-light/90">Recently Added</h4>
                {recentlyAdded.length === 0 && <div className="text-pb-gray">No recent additions.</div>}
                {recentlyAdded.map((item, index) => (
                  <Link key={`added-${item.prop.id}`} to={`/props/${item.prop.id}`} className="block">
                    <motion.div
                      initial={{ opacity: 0, x: 20 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: index * 0.05 }}
                      className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                    >
                      <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <Crown className="w-4 h-4 text-pb-accent" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-white truncate">{item.prop.name}</p>
                        <p className="text-xs text-pb-gray">Prop added</p>
                        <p className="text-xs text-pb-gray mt-1">{item.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}</p>
                      </div>
                    </motion.div>
                  </Link>
                ))}
              </div>

              {/* Recently Updated */}
              <div className="space-y-3">
                <h4 className="text-sm font-semibold text-pb-light/90">Recently Updated</h4>
                {recentlyUpdated.length === 0 && <div className="text-pb-gray">No recent updates.</div>}
                {recentlyUpdated.map((item, index) => (
                  <Link key={`updated-${item.prop.id}`} to={`/props/${item.prop.id}`} className="block">
                    <motion.div
                      initial={{ opacity: 0, x: 20 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: index * 0.05 }}
                      className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                    >
                      <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <Crown className="w-4 h-4 text-pb-accent" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-white truncate">{item.prop.name}</p>
                        <p className="text-xs text-pb-gray">Prop updated</p>
                        <p className="text-xs text-pb-gray mt-1">{item.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}</p>
                      </div>
                    </motion.div>
                  </Link>
                ))}
              </div>
            </div>
          </motion.div>
        </div>

        {/* Assigned/Mentioned Tasks Row */}
        
      </motion.div>
    </DashboardLayout>
  );
};

export default DashboardHome; 
```

```typescriptreact
import React from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { motion } from 'framer-motion';
import {
  FileText,
  Package2,
  Clock,
  CheckCircle,
  Crown,
  Star
} from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { useFirebase } from './contexts/FirebaseContext';
import { useEffect, useState } from 'react';
import type { Show } from './types/Show';
import type { Prop } from './types/props';
import type { CardData } from './types/taskManager';
import { Link } from 'react-router-dom';
import { useWebAuth } from './contexts/WebAuthContext';

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};
const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: { duration: 0.4 }
  },
  hover: {
    scale: 1.02,
    transition: { duration: 0.2 }
  }
};
const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.5 }
  }
};

const DashboardHome: React.FC = () => {
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const [cards, setCards] = useState<CardData[]>([]);
  const { user, userProfile } = useWebAuth();

  // Fetch show
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShow({ ...doc.data, id: doc.id }),
      () => setShow(null)
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch props
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToCollection<Prop>(
      'props',
      data => setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...doc.data, id: doc.id }))),
      () => setProps([])
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch boards and cards
  useEffect(() => {
    if (!currentShowId) return;
    let unsubBoards: (() => void) | undefined;
    let unsubCards: (() => void)[] = [];
    unsubBoards = service.listenToCollection(
      'todo_boards',
      docs => {
        const filteredBoards = docs.filter(b => b.data.showId === currentShowId);
        // Listen to all cards in all lists in all boards
        unsubCards.forEach(u => u && u());
        unsubCards = [];
        filteredBoards.forEach(board => {
          service.listenToCollection(
            `todo_boards/${board.id}/lists`,
            lists => {
              lists.forEach(list => {
                const unsub = service.listenToCollection(
                  `todo_boards/${board.id}/lists/${list.id}/cards`,
                  cardsDocs => {
                    setCards(prev => {
                      // Remove old cards for this list
                      const other = prev.filter(c => c.listId !== list.id);
                      return [
                        ...other,
                        ...cardsDocs.map(cd => ({ ...(cd.data as CardData), id: cd.id, listId: list.id }))
                      ];
                    });
                  },
                  () => {}
                );
                unsubCards.push(unsub);
              });
            },
            () => {}
          );
        });
      },
      () => {}
    );
    return () => { if (unsubBoards) unsubBoards(); unsubCards.forEach(u => u && u()); };
  }, [service, currentShowId]);

  // Calculate stats
  const totalProps = props.length;
  const totalOutstandingTasks = cards.filter(card => !card.completed).length;
  const readyProps = props.filter(p => p.status === 'with-stage-management').length;
  const showReadyPercent = totalProps > 0 ? Math.round((readyProps / totalProps) * 100) : 0;

  // Recent props activity: list of props recently added or updated (one entry per prop)
  function toDateSafe(input: any): Date | null {
    if (!input) return null;
    if (input instanceof Date) return input;
    if (typeof input === 'number') return new Date(input);
    if (typeof input === 'string' && input.trim() !== '') {
      const parsed = new Date(input);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
    if (input && typeof input.toDate === 'function') {
      try {
        const d = input.toDate();
        return d instanceof Date && !isNaN(d.getTime()) ? d : null;
      } catch {
        return null;
      }
    }
    return null;
  }

  // Single recent activity list (added or updated, most recent per prop)
  const recentActivity = props
    .map(p => {
      const created = toDateSafe((p as any).createdAt);
      const updated = toDateSafe((p as any).updatedAt);
      const latest = updated && (!created || updated >= created) ? updated : created;
      const type: 'added' | 'updated' = updated && created ? (updated >= created ? 'updated' : 'added') : (updated ? 'updated' : 'added');
      return latest ? { prop: p, type, date: latest } : null;
    })
    .filter((x): x is { prop: Prop; type: 'added' | 'updated'; date: Date } => Boolean(x))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 8);

  // Urgent tasks row
  const now = new Date();
  const tasksWithDue = cards.filter(card => card.dueDate && !card.completed).map(card => ({
    ...card,
    due: card.dueDate ? new Date(card.dueDate) : new Date()
  })).sort((a, b) => a.due.getTime() - b.due.getTime()).slice(0, 6);

  // Cards assigned to or mentioning the current user
  const assignedOrMentionedCards = cards.filter(card => {
    if (!user) return false;
    const assigned = Array.isArray(card.assignedTo) && card.assignedTo.includes(user.uid);
    const mention = (userProfile && card.description && (
      (userProfile.displayName && card.description.includes(userProfile.displayName)) ||
      (userProfile.email && card.description.includes(userProfile.email))
    ));
    return assigned || mention;
  });

  function getTaskColor(due: Date) {
    if (due < now) return 'bg-red-600 text-white';
    const diff = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (diff < 2) return 'bg-orange-500 text-white';
    return 'bg-green-600 text-white';
  }

  function isValidDateString(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  // Days until first performance
  let daysLeft = null;
  let perfDate: Date | null = null;
  const perfRaw = (show as any)?.firstPerformanceDate || show?.startDate;
  const temp = perfRaw;
  if (typeof temp === 'string' && temp.trim() !== '') {
    perfDate = new Date(temp);
  } else if (typeof temp === 'number' && !isNaN(temp)) {
    perfDate = new Date(temp);
  } else if (temp && typeof temp.toDate === 'function') {
    perfDate = temp.toDate();
  }
  if (perfDate) {
    daysLeft = Math.max(0, Math.ceil((perfDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));
  }

  // Find the next upcoming show date
  let nextShowDateLabel = '';
  if (show) {
    const now = new Date();
    const dateFields = [
      { key: 'rehearsalStartDate', label: 'Rehearsal' },
      { key: 'techWeekStartDate', label: 'Tech Week' },
      { key: 'firstPerformanceDate', label: 'First Performance' },
      { key: 'pressNightDate', label: 'Press Night' },
      { key: 'startDate', label: 'Start' },
      { key: 'endDate', label: 'End' },
    ];
    const upcoming = dateFields
      .map(({ key, label }) => {
        const raw = (show as any)[key];
        let date: Date | null = null;
        const temp = raw;
        if (isValidDateString(temp) && temp !== undefined) {
          date = new Date(temp);
        } else if (typeof temp === 'number' && !isNaN(temp)) {
          date = new Date(temp);
        } else if (temp && typeof temp.toDate === 'function') {
          date = temp.toDate();
        }
        return date && date > now ? { date, label } : null;
      })
      .filter(Boolean) as { date: Date; label: string }[];
    if (upcoming.length > 0) {
      const soonest = upcoming.reduce((a, b) => (a.date < b.date ? a : b));
      if (soonest.date instanceof Date && !isNaN(soonest.date.getTime())) {
        nextShowDateLabel = `Next Show Date: ${soonest.label} – ${soonest.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
      } else {
        nextShowDateLabel = `Next Show Date: ${soonest.label}`;
      }
    } else {
      nextShowDateLabel = 'No upcoming show dates';
    }
  }

  return (
    <DashboardLayout>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="max-w-7xl mx-auto space-y-6"
      >
        {/* Show Banner */}
        <motion.div
          variants={cardVariants}
          className="bg-gradient-to-r from-pb-primary to-pb-secondary rounded-2xl p-6 relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-pb-primary/20 to-pb-secondary/20 backdrop-blur-sm"></div>
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  {show?.name || 'Select a Show'}
                </h2>
                <p className="text-pb-light/80">{nextShowDateLabel}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">{daysLeft !== null ? `${daysLeft} days` : '--'}</div>
                <div className="text-pb-light/80 text-sm">until first night</div>
              </div>
            </div>
            <div className="w-full bg-pb-light/20 rounded-full h-2">
              <motion.div
                className="bg-pb-success h-2 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${showReadyPercent}%` }}
                transition={{ duration: 1, delay: 0.5 }}
              />
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Statistics Cards */}
          <motion.div variants={itemVariants} className="lg:col-span-2">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {[
                { icon: Package2, label: 'Total Props', value: totalProps, color: 'bg-pb-blue' },
                { icon: Clock, label: 'Pending Tasks', value: totalOutstandingTasks, color: 'bg-pb-orange' },
                { icon: CheckCircle, label: 'Ready for Show', value: `${showReadyPercent}%`, color: 'bg-pb-success' },
              ].map((stat, index) => (
                <motion.div
                  key={index}
                  variants={cardVariants}
                  whileHover="hover"
                  className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-4 border border-pb-primary/20"
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-10 h-10 ${stat.color}/20 rounded-xl flex items-center justify-center`}>
                      <stat.icon className={`w-5 h-5 ${stat.color.replace('bg-', 'text-')}`} />
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-white mb-1">{stat.value}</div>
                  <div className="text-sm text-pb-gray">{stat.label}</div>
                </motion.div>
              ))}
            </div>

            {/* Urgent Tasks Row */}
            <motion.div variants={itemVariants}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className="w-5 h-5 text-pb-primary" />
                <h3 className="text-lg font-semibold text-white">Urgent Tasks</h3>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {tasksWithDue.length === 0 && <div className="text-pb-gray">No urgent tasks.</div>}
                {tasksWithDue.map((task) => (
                  <Link key={task.id} to={`/boards?cardId=${task.id}`} className="min-w-[220px]">
                    <div className={`p-4 rounded-xl shadow ${getTaskColor(task.due)}`}>
                      <div className="font-bold text-lg">{task.title}</div>
                      <div className="text-xs mb-1">Due: {task.due.toLocaleString()}</div>
                      <div className="text-xs">{task.description}</div>
                    </div>
                  </Link>
                ))}
              </div>
            </motion.div>{user && assignedOrMentionedCards.length > 0 && (
          <motion.div variants={itemVariants}>
            <div className="flex items-center space-x-2 mb-4 mt-6">
              <Star className="w-5 h-5 text-pb-accent" />
              <h3 className="text-lg font-semibold text-white">Your Tasks</h3>
            </div>
            <div className="flex gap-3 overflow-x-auto pb-2">
              {assignedOrMentionedCards.map(card => (
                <Link key={card.id} to={`/boards?cardId=${card.id}`} className="min-w-[220px]">
                  <div className="p-4 rounded-xl shadow bg-pb-primary/80 text-white">
                    <div className="font-bold text-lg">{card.title}</div>
                    {card.dueDate && <div className="text-xs mb-1">Due: {new Date(card.dueDate).toLocaleString()}</div>}
                    <div className="text-xs line-clamp-2">{card.description}</div>
            </div>
                </Link>
            ))}
          </div>
        </motion.div>
        )}

          </motion.div>

          {/* Recent Props Activity */}
          <motion.div variants={itemVariants} className="lg:col-span-1">
            <div className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-6 border border-pb-primary/20 h-full">
              <div className="flex items-center space-x-2 mb-4">
                <FileText className="w-5 h-5 text-pb-accent" />
                <h3 className="text-lg font-semibold text-white">Recent Props Activity</h3>
              </div>
              
              {/* Single Recent List */}
              <div className="space-y-3">
                {recentActivity.length === 0 && <div className="text-pb-gray">No recent activity.</div>}
                {recentActivity.map((item, index) => (
                  <Link key={`${item.type}-${item.prop.id}`} to={`/props/${item.prop.id}`} className="block">
                    <motion.div
                      initial={{ opacity: 0, x: 20 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: index * 0.05 }}
                      className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                    >
                      <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <Crown className="w-4 h-4 text-pb-accent" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-white truncate">{item.prop.name}</p>
                        <p className="text-xs text-pb-gray">{item.type === 'added' ? 'Prop added' : 'Prop updated'}</p>
                        <p className="text-xs text-pb-gray mt-1">{item.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}</p>
                      </div>
                    </motion.div>
                  </Link>
                ))}
              </div>
            </div>
          </motion.div>
        </div>

        {/* Assigned/Mentioned Tasks Row */}
        
      </motion.div>
    </DashboardLayout>
  );
};

export default DashboardHome; 
```

- Merged “Recently Added” and “Recently Updated” into a single “Recent Props Activity” list.
- Each item shows whether it was added or updated, the date, and links to `/props/:id`.
- Kept robust timestamp handling and sorted by most recent across both types.

---

**User**

on the details page lets use all the available space. the page width seems to be fixed.

---

**Cursor**

I’m going to open the prop details page and the layout component to find where the width is constrained, then I’ll make the details page use the full available width.

I’m going to update the wrapper container in `web-app/src/pages/PropDetailPage.tsx` to remove the fixed `max-w-3xl` and allow the page to use the full available width, then check for lint issues.

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop } from '../../shared/types/props';
import { ArrowLeft, Pencil } from 'lucide-react';

function formatDate(value: any): string {
  if (!value) return 'N/A';
  if (typeof value === 'object' && value.seconds) {
    try {
      if (typeof value.toDate === 'function') {
        return value.toDate().toLocaleString();
      }
      return new Date(value.seconds * 1000).toLocaleString();
    } catch {
      return JSON.stringify(value);
    }
  }
  if (typeof value === 'string') return value;
  return String(value);
}

const PropDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [prop, setProp] = useState<Prop | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setProp(doc?.data as Prop || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !prop) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  const mainImage = prop.images?.find(img => img.isMain)?.url || prop.images?.[0]?.url || prop.imageUrl || '';

  const handleEdit = () => {
    if (id) navigate(`/props/${id}/edit`);
  };

  const renderField = (label: string, value: any, isDate = false) => (
    <div className="mb-2">
      <span className="font-semibold text-pb-primary">{label}:</span>{' '}
      <span className="text-white">{isDate ? formatDate(value) : (value ?? 'N/A')}</span>
    </div>
  );

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="flex items-center justify-between mb-4">
          <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-pb-primary hover:text-pb-accent">
            <ArrowLeft className="w-5 h-5" /> Back
          </button>
        </div>
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-8 relative">
          {/* Edit Icon Button */}
          <button
            onClick={handleEdit}
            className="absolute top-4 right-4 bg-pb-primary hover:bg-pb-accent text-white rounded-full p-2 shadow focus:outline-none focus:ring-2 focus:ring-pb-primary transition"
            aria-label="Edit Prop"
            title="Edit Prop"
          >
            <Pencil className="w-5 h-5" />
          </button>
          {/* Header & Main Info */}
          <div className="flex flex-col md:flex-row gap-8">
            <div className="flex-shrink-0 w-48 h-48 rounded-lg overflow-hidden bg-pb-gray flex items-center justify-center">
              {mainImage ? (
                <img src={mainImage} alt={prop.name} className="object-cover w-full h-full" />
              ) : (
                <div className="flex items-center justify-center w-full h-full text-pb-light/60">
                  <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
                  </svg>
                </div>
              )}
            </div>
            <div className="flex-1 min-w-0">
              <h1 className="text-2xl font-bold text-white mb-2">{prop.name}</h1>
              <div className="flex flex-wrap gap-2 mb-2">
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-primary/30 text-white">{prop.category}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-accent/30 text-white">Qty: {prop.quantity}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-gray text-white">{prop.status}</span>
              </div>
              {prop.description && <p className="text-pb-gray mb-4 whitespace-pre-line">{prop.description}</p>}
            </div>
          </div>
          {/* Gallery under main image */}
          {prop.images && prop.images.length > 1 && (
            <div className="mt-4 flex flex-col items-start">
              <div className="font-semibold text-pb-primary mb-2">Gallery</div>
              <div className="flex gap-2 flex-wrap">
                {prop.images.filter(img => !img.isMain && img.url !== mainImage).map(img => (
                  <img key={img.id} src={img.url} alt={img.caption || prop.name} className="w-20 h-20 object-cover rounded border border-pb-primary/30" />
                ))}
              </div>
            </div>
          )}
          {/* Assignment & Show Info */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Show', prop.showId)}
            {renderField('Act', prop.act)}
            {renderField('Scene', prop.sceneName || prop.scene)}
            {renderField('Location', prop.location || prop.currentLocation)}
            {renderField('Assignment', prop.assignment?.name || prop.assignment?.id)}
            {renderField('Checked Out To', prop.checkedOutDetails?.to)}
            {renderField('Checked Out At', prop.checkedOutDetails?.checkedOutAt, true)}
            {renderField('Expected Return', prop.checkedOutDetails?.expectedReturnAt, true)}
          </div>
          {/* Physical Details */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Dimensions', (prop.length || prop.width || prop.height) ? `${prop.length || ''} x ${prop.width || ''} x ${prop.height || ''} ${prop.unit || ''}` : 'N/A')}
            {renderField('Depth', prop.depth)}
            {renderField('Weight', prop.weight ? `${prop.weight} ${prop.weightUnit || ''}` : 'N/A')}
            {renderField('Travel Weight', prop.travelWeight)}
            {renderField('Materials', prop.materials?.join(', '))}
            {renderField('Color', prop.color)}
            {renderField('Period', prop.period)}
            {renderField('Style', prop.style)}
            {renderField('Handedness', prop.handedness)}
            {renderField('Breakable', prop.isBreakable ? 'Yes' : 'No')}
            {renderField('Hazardous', prop.isHazardous ? 'Yes' : 'No')}
          </div>
          {/* Purchase & Rental */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Price', prop.price ? `£${prop.price}` : 'N/A')}
            {renderField('Source', prop.source)}
            {renderField('Source Details', prop.sourceDetails)}
            {renderField('Purchase URL', prop.purchaseUrl ? <a href={prop.purchaseUrl} className="text-pb-accent underline" target="_blank" rel="noopener noreferrer">{prop.purchaseUrl}</a> : 'N/A')}
            {renderField('Purchase Date', prop.purchaseDate, true)}
            {renderField('Rental Source', prop.rentalSource)}
            {renderField('Rental Due Date', prop.rentalDueDate, true)}
            {renderField('Rental Reference', prop.rentalReferenceNumber)}
            {renderField('Rental Info', 'N/A')}
          </div>
          {/* Manufacturer & Identification */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Manufacturer', prop.manufacturer)}
            {renderField('Model', prop.model)}
            {renderField('Serial Number', prop.serialNumber)}
            {renderField('Barcode', prop.barcode)}
            {renderField('Warranty', prop.warranty ? JSON.stringify(prop.warranty) : 'N/A')}
          </div>
          {/* Usage, Handling, Safety */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Usage Instructions', prop.usageInstructions)}
            {renderField('Handling Instructions', prop.handlingInstructions)}
            {renderField('Safety Notes', prop.safetyNotes)}
            {renderField('Pre-Show Setup', prop.preShowSetupNotes)}
            {renderField('Pre-Show Setup Video', prop.preShowSetupVideo)}
            {renderField('Pre-Show Setup Duration', prop.preShowSetupDuration)}
            {renderField('Shipping Crate', prop.hasOwnShippingCrate ? 'Yes' : 'No')}
            {renderField('Shipping Crate Details', prop.shippingCrateDetails)}
            {renderField('Transport Notes', prop.transportNotes)}
            {renderField('Requires Special Transport', prop.requiresSpecialTransport ? 'Yes' : 'No')}
            {renderField('Transport Method', prop.transportMethod)}
          </div>
          {/* Status & Lifecycle */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Status', prop.status)}
            {renderField('Status Notes', prop.statusNotes)}
            {renderField('Last Status Update', prop.lastStatusUpdate, true)}
            {renderField('Condition', prop.condition)}
            {renderField('Last Used At', prop.lastUsedAt, true)}
            {renderField('Last Modified At', prop.lastModifiedAt, true)}
            {renderField('Created At', prop.createdAt, true)}
            {renderField('Updated At', prop.updatedAt, true)}
            {renderField('Subcategory', prop.subcategory)}
            {renderField('Tags', prop.tags?.join(', '))}
          </div>
          {/* Maintenance & Inspection */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Maintenance Notes', prop.maintenanceNotes)}
            {renderField('Last Maintenance Date', prop.lastMaintenanceDate, true)}
            {renderField('Next Maintenance Due', prop.nextMaintenanceDue, true)}
            {renderField('Last Inspection Date', prop.lastInspectionDate, true)}
            {renderField('Next Inspection Due', prop.nextInspectionDue, true)}
            {renderField('Repair Estimate', prop.repairEstimate)}
            {renderField('Repair Priority', prop.repairPriority)}
            {renderField('Assigned To', prop.assignedUserDetails?.map(u => u.name).join(', ') || prop.assignedTo?.join(', '))}
            {renderField('Maintenance History', prop.maintenanceHistory ? JSON.stringify(prop.maintenanceHistory) : 'N/A')}
            {renderField('Status History', prop.statusHistory ? JSON.stringify(prop.statusHistory) : 'N/A')}
          </div>
          {/* Storage & Logistics */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Storage Requirements', prop.storageRequirements)}
            {renderField('Return Due Date', prop.returnDueDate, true)}
            {renderField('Expected Return Date', prop.expectedReturnDate, true)}
            {renderField('Replacement Cost', prop.replacementCost)}
            {renderField('Replacement Lead Time', prop.replacementLeadTime)}
            {renderField('Travels Unboxed', prop.travelsUnboxed ? 'Yes' : 'No')}
            {renderField('Courier', prop.courier)}
            {renderField('Tracking Number', prop.trackingNumber)}
          </div>
          {/* Digital Assets & Media */}
          <div className="space-y-2">
            <div className="font-semibold text-pb-primary mb-2">Digital Assets</div>
            {prop.digitalAssets && prop.digitalAssets.length > 0 ? (
              <ul className="space-y-2">
                {prop.digitalAssets.map(asset => (
                  <li key={asset.id} className="flex items-center gap-2">
                    <a href={asset.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{asset.name || asset.title || asset.url}</a>
                    <span className="text-xs text-pb-gray">[{asset.type}]</span>
                  </li>
                ))}
              </ul>
            ) : <div className="text-pb-gray">N/A</div>}
            {prop.videos && prop.videos.length > 0 && (
              <div className="mt-4">
                <div className="font-semibold text-pb-primary mb-2">Videos</div>
                <ul className="space-y-2">
                  {prop.videos.map(video => (
                    <li key={video.id} className="flex items-center gap-2">
                      <a href={video.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{video.name || video.title || video.url}</a>
                      <span className="text-xs text-pb-gray">[{video.type}]</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
          {/* Notes & Custom Fields */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Notes', prop.notes)}
            {renderField('Public Notes', prop.publicNotes)}
            {renderField('Custom Fields', prop.customFields ? JSON.stringify(prop.customFields) : 'N/A')}
            {renderField('Scene Notes', prop.sceneNotes)}
            {renderField('Usage Notes', prop.usageNotes)}
            {renderField('Modification Details', prop.modificationDetails)}
          </div>
        </motion.div>
      </div>
    </DashboardLayout>
  );
};

export default PropDetailPage; 
```

- Removed the fixed width constraint on the prop details page by changing the wrapper from `max-w-3xl mx-auto` to `max-w-none`, allowing it to use the full available width within the layout.
- File updated: `web-app/src/pages/PropDetailPage.tsx`

If you’d like it to be even wider and also reduce inner padding or adjust the grid columns to take advantage of the space, I can tweak those too.

---

**User**

lets add the ability to click onthe images to see a lager image with the ability to scroll thur the images assocated to the prop

---

**Cursor**

I will add a lightbox gallery to the prop details page so clicking the main image or any thumbnail opens a full-screen viewer with next/previous navigation and close support, using available icons and motion. Then I’ll run a quick lint check on the edited file.

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop } from '../../shared/types/props';
import { ArrowLeft, Pencil, X, ChevronLeft, ChevronRight } from 'lucide-react';

function formatDate(value: any): string {
  if (!value) return 'N/A';
  if (typeof value === 'object' && value.seconds) {
    try {
      if (typeof value.toDate === 'function') {
        return value.toDate().toLocaleString();
      }
      return new Date(value.seconds * 1000).toLocaleString();
    } catch {
      return JSON.stringify(value);
    }
  }
  if (typeof value === 'string') return value;
  return String(value);
}

const PropDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [prop, setProp] = useState<Prop | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();

  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [lightboxIndex, setLightboxIndex] = useState(0);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setProp(doc?.data as Prop || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !prop) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  const mainImage = prop.images?.find(img => img.isMain)?.url || prop.images?.[0]?.url || prop.imageUrl || '';

  const galleryImages = React.useMemo(() => {
    const imgs = (prop?.images || [])
      .filter(img => !!img && !!img.url)
      .map(img => ({ url: img.url, caption: (img as any).caption || '', id: (img as any).id, isMain: (img as any).isMain }));
    if (prop?.imageUrl && !imgs.some(i => i.url === prop.imageUrl)) {
      imgs.unshift({ url: prop.imageUrl, caption: prop?.name || '', id: 'primary' } as any);
    }
    const mainIdx = imgs.findIndex(i => (i as any).isMain);
    if (mainIdx > 0) {
      const [m] = imgs.splice(mainIdx, 1);
      imgs.unshift(m);
    }
    return imgs;
  }, [prop]);

  const openLightboxAt = (index: number) => {
    if (!galleryImages.length) return;
    setLightboxIndex(Math.max(0, Math.min(index, galleryImages.length - 1)));
    setLightboxOpen(true);
  };
  const closeLightbox = () => setLightboxOpen(false);
  const showPrev = () => setLightboxIndex(i => (i - 1 + galleryImages.length) % galleryImages.length);
  const showNext = () => setLightboxIndex(i => (i + 1) % galleryImages.length);

  React.useEffect(() => {
    if (!lightboxOpen) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showPrev();
      if (e.key === 'ArrowRight') showNext();
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [lightboxOpen, galleryImages.length]);

  const handleEdit = () => {
    if (id) navigate(`/props/${id}/edit`);
  };

  const renderField = (label: string, value: any, isDate = false) => (
    <div className="mb-2">
      <span className="font-semibold text-pb-primary">{label}:</span>{' '}
      <span className="text-white">{isDate ? formatDate(value) : (value ?? 'N/A')}</span>
    </div>
  );

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="flex items-center justify-between mb-4">
          <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-pb-primary hover:text-pb-accent">
            <ArrowLeft className="w-5 h-5" /> Back
          </button>
        </div>
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-8 relative">
          {/* Edit Icon Button */}
          <button
            onClick={handleEdit}
            className="absolute top-4 right-4 bg-pb-primary hover:bg-pb-accent text-white rounded-full p-2 shadow focus:outline-none focus:ring-2 focus:ring-pb-primary transition"
            aria-label="Edit Prop"
            title="Edit Prop"
          >
            <Pencil className="w-5 h-5" />
          </button>
          {/* Header & Main Info */}
          <div className="flex flex-col md:flex-row gap-8">
            <div className="flex-shrink-0 w-48 h-48 rounded-lg overflow-hidden bg-pb-gray flex items-center justify-center">
              {mainImage ? (
                <button
                  type="button"
                  onClick={() => {
                    const idx = galleryImages.findIndex(i => i.url === mainImage);
                    openLightboxAt(idx >= 0 ? idx : 0);
                  }}
                  className="block w-full h-full cursor-zoom-in"
                  title="Click to view larger"
                >
                  <img src={mainImage} alt={prop.name} className="object-cover w-full h-full" />
                </button>
              ) : (
                <div className="flex items-center justify-center w-full h-full text-pb-light/60">
                  <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
                  </svg>
                </div>
              )}
            </div>
            <div className="flex-1 min-w-0">
              <h1 className="text-2xl font-bold text-white mb-2">{prop.name}</h1>
              <div className="flex flex-wrap gap-2 mb-2">
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-primary/30 text-white">{prop.category}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-accent/30 text-white">Qty: {prop.quantity}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-gray text-white">{prop.status}</span>
              </div>
              {prop.description && <p className="text-pb-gray mb-4 whitespace-pre-line">{prop.description}</p>}
            </div>
          </div>
          {/* Gallery under main image */}
          {galleryImages.length > 1 && (
            <div className="mt-4 flex flex-col items-start">
              <div className="font-semibold text-pb-primary mb-2">Gallery</div>
              <div className="flex gap-2 flex-wrap">
                {galleryImages.map((img, idx) => (
                  <button
                    key={img.id || img.url}
                    type="button"
                    onClick={() => openLightboxAt(idx)}
                    className="w-20 h-20 rounded border border-pb-primary/30 overflow-hidden focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    title="View larger"
                  >
                    <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                  </button>
                ))}
              </div>
            </div>
          )}
          {/* Assignment & Show Info */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Show', prop.showId)}
            {renderField('Act', prop.act)}
            {renderField('Scene', prop.sceneName || prop.scene)}
            {renderField('Location', prop.location || prop.currentLocation)}
            {renderField('Assignment', prop.assignment?.name || prop.assignment?.id)}
            {renderField('Checked Out To', prop.checkedOutDetails?.to)}
            {renderField('Checked Out At', prop.checkedOutDetails?.checkedOutAt, true)}
            {renderField('Expected Return', prop.checkedOutDetails?.expectedReturnAt, true)}
          </div>
          {/* Physical Details */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Dimensions', (prop.length || prop.width || prop.height) ? `${prop.length || ''} x ${prop.width || ''} x ${prop.height || ''} ${prop.unit || ''}` : 'N/A')}
            {renderField('Depth', prop.depth)}
            {renderField('Weight', prop.weight ? `${prop.weight} ${prop.weightUnit || ''}` : 'N/A')}
            {renderField('Travel Weight', prop.travelWeight)}
            {renderField('Materials', prop.materials?.join(', '))}
            {renderField('Color', prop.color)}
            {renderField('Period', prop.period)}
            {renderField('Style', prop.style)}
            {renderField('Handedness', prop.handedness)}
            {renderField('Breakable', prop.isBreakable ? 'Yes' : 'No')}
            {renderField('Hazardous', prop.isHazardous ? 'Yes' : 'No')}
          </div>
          {/* Purchase & Rental */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Price', prop.price ? `£${prop.price}` : 'N/A')}
            {renderField('Source', prop.source)}
            {renderField('Source Details', prop.sourceDetails)}
            {renderField('Purchase URL', prop.purchaseUrl ? <a href={prop.purchaseUrl} className="text-pb-accent underline" target="_blank" rel="noopener noreferrer">{prop.purchaseUrl}</a> : 'N/A')}
            {renderField('Purchase Date', prop.purchaseDate, true)}
            {renderField('Rental Source', prop.rentalSource)}
            {renderField('Rental Due Date', prop.rentalDueDate, true)}
            {renderField('Rental Reference', prop.rentalReferenceNumber)}
            {renderField('Rental Info', 'N/A')}
          </div>
          {/* Manufacturer & Identification */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Manufacturer', prop.manufacturer)}
            {renderField('Model', prop.model)}
            {renderField('Serial Number', prop.serialNumber)}
            {renderField('Barcode', prop.barcode)}
            {renderField('Warranty', prop.warranty ? JSON.stringify(prop.warranty) : 'N/A')}
          </div>
          {/* Usage, Handling, Safety */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Usage Instructions', prop.usageInstructions)}
            {renderField('Handling Instructions', prop.handlingInstructions)}
            {renderField('Safety Notes', prop.safetyNotes)}
            {renderField('Pre-Show Setup', prop.preShowSetupNotes)}
            {renderField('Pre-Show Setup Video', prop.preShowSetupVideo)}
            {renderField('Pre-Show Setup Duration', prop.preShowSetupDuration)}
            {renderField('Shipping Crate', prop.hasOwnShippingCrate ? 'Yes' : 'No')}
            {renderField('Shipping Crate Details', prop.shippingCrateDetails)}
            {renderField('Transport Notes', prop.transportNotes)}
            {renderField('Requires Special Transport', prop.requiresSpecialTransport ? 'Yes' : 'No')}
            {renderField('Transport Method', prop.transportMethod)}
          </div>
          {/* Status & Lifecycle */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Status', prop.status)}
            {renderField('Status Notes', prop.statusNotes)}
            {renderField('Last Status Update', prop.lastStatusUpdate, true)}
            {renderField('Condition', prop.condition)}
            {renderField('Last Used At', prop.lastUsedAt, true)}
            {renderField('Last Modified At', prop.lastModifiedAt, true)}
            {renderField('Created At', prop.createdAt, true)}
            {renderField('Updated At', prop.updatedAt, true)}
            {renderField('Subcategory', prop.subcategory)}
            {renderField('Tags', prop.tags?.join(', '))}
          </div>
          {/* Maintenance & Inspection */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Maintenance Notes', prop.maintenanceNotes)}
            {renderField('Last Maintenance Date', prop.lastMaintenanceDate, true)}
            {renderField('Next Maintenance Due', prop.nextMaintenanceDue, true)}
            {renderField('Last Inspection Date', prop.lastInspectionDate, true)}
            {renderField('Next Inspection Due', prop.nextInspectionDue, true)}
            {renderField('Repair Estimate', prop.repairEstimate)}
            {renderField('Repair Priority', prop.repairPriority)}
            {renderField('Assigned To', prop.assignedUserDetails?.map(u => u.name).join(', ') || prop.assignedTo?.join(', '))}
            {renderField('Maintenance History', prop.maintenanceHistory ? JSON.stringify(prop.maintenanceHistory) : 'N/A')}
            {renderField('Status History', prop.statusHistory ? JSON.stringify(prop.statusHistory) : 'N/A')}
          </div>
          {/* Storage & Logistics */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Storage Requirements', prop.storageRequirements)}
            {renderField('Return Due Date', prop.returnDueDate, true)}
            {renderField('Expected Return Date', prop.expectedReturnDate, true)}
            {renderField('Replacement Cost', prop.replacementCost)}
            {renderField('Replacement Lead Time', prop.replacementLeadTime)}
            {renderField('Travels Unboxed', prop.travelsUnboxed ? 'Yes' : 'No')}
            {renderField('Courier', prop.courier)}
            {renderField('Tracking Number', prop.trackingNumber)}
          </div>
          {/* Digital Assets & Media */}
          <div className="space-y-2">
            <div className="font-semibold text-pb-primary mb-2">Digital Assets</div>
            {prop.digitalAssets && prop.digitalAssets.length > 0 ? (
              <ul className="space-y-2">
                {prop.digitalAssets.map(asset => (
                  <li key={asset.id} className="flex items-center gap-2">
                    <a href={asset.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{asset.name || asset.title || asset.url}</a>
                    <span className="text-xs text-pb-gray">[{asset.type}]</span>
                  </li>
                ))}
              </ul>
            ) : <div className="text-pb-gray">N/A</div>}
            {prop.videos && prop.videos.length > 0 && (
              <div className="mt-4">
                <div className="font-semibold text-pb-primary mb-2">Videos</div>
                <ul className="space-y-2">
                  {prop.videos.map(video => (
                    <li key={video.id} className="flex items-center gap-2">
                      <a href={video.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{video.name || video.title || video.url}</a>
                      <span className="text-xs text-pb-gray">[{video.type}]</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
          {/* Notes & Custom Fields */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Notes', prop.notes)}
            {renderField('Public Notes', prop.publicNotes)}
            {renderField('Custom Fields', prop.customFields ? JSON.stringify(prop.customFields) : 'N/A')}
            {renderField('Scene Notes', prop.sceneNotes)}
            {renderField('Usage Notes', prop.usageNotes)}
            {renderField('Modification Details', prop.modificationDetails)}
          </div>
        </motion.div>

        {/* Lightbox Modal */}
        {lightboxOpen && galleryImages.length > 0 && (
          <div
            className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
            onClick={closeLightbox}
          >
            <div className="relative w-full h-full max-h-[100vh] flex items-center justify-center" onClick={e => e.stopPropagation()}>
              <button
                type="button"
                className="absolute top-4 right-4 p-2 rounded-full bg-black/60 hover:bg-black/80 text-white"
                onClick={closeLightbox}
                aria-label="Close"
              >
                <X className="w-5 h-5" />
              </button>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute left-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showPrev}
                  aria-label="Previous image"
                >
                  <ChevronLeft className="w-6 h-6" />
                </button>
              )}
              <img
                src={galleryImages[lightboxIndex].url}
                alt={(galleryImages[lightboxIndex].caption || prop.name) as string}
                className="max-w-[95vw] max-h-[90vh] object-contain"
              />
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute right-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showNext}
                  aria-label="Next image"
                >
                  <ChevronRight className="w-6 h-6" />
                </button>
              )}
            </div>
          </div>
        )}
      </div>
    </DashboardLayout>
  );
};

export default PropDetailPage; 
```

- Added a fullscreen lightbox to `web-app/src/pages/PropDetailPage.tsx`:
  - Click the main image or any thumbnail to open.
  - Navigate with on-screen arrows or keyboard (Left/Right), close with Esc or the close button.
  - Uses existing images array plus `imageUrl` fallback; keeps main image first.
- Thumbnails now open the lightbox; main image is clickable with a zoom cursor.
- No lint errors.

Want me to add swipe gestures for touch devices or a caption strip/thumbnail carousel inside the lightbox?

---

**User**

please add swipe gestures for touch devices or a caption strip/thumbnail carousel inside the lightbox?

---

**Cursor**

I’m adding swipe gestures and a captioned thumbnail carousel to the lightbox on `web-app/src/pages/PropDetailPage.tsx`. Then I’ll run a lint check on that file.

```typescriptreact
*** Begin Patch
*** Update File: web-app/src/pages/PropDetailPage.tsx
@@
-import React, { useEffect, useState } from 'react';
+import React, { useEffect, useRef, useState } from 'react';
@@
   const [lightboxOpen, setLightboxOpen] = useState(false);
   const [lightboxIndex, setLightboxIndex] = useState(0);
+  const touchStartXRef = useRef<number | null>(null);
+  const touchStartYRef = useRef<number | null>(null);
@@
   const openLightboxAt = (index: number) => {
     if (!galleryImages.length) return;
     setLightboxIndex(Math.max(0, Math.min(index, galleryImages.length - 1)));
     setLightboxOpen(true);
   };
   const closeLightbox = () => setLightboxOpen(false);
   const showPrev = () => setLightboxIndex(i => (i - 1 + galleryImages.length) % galleryImages.length);
   const showNext = () => setLightboxIndex(i => (i + 1) % galleryImages.length);
+
+  const handleTouchStart = (e: React.TouchEvent) => {
+    const t = e.touches[0];
+    touchStartXRef.current = t.clientX;
+    touchStartYRef.current = t.clientY;
+  };
+
+  const handleTouchEnd = (e: React.TouchEvent) => {
+    const startX = touchStartXRef.current;
+    const startY = touchStartYRef.current;
+    touchStartXRef.current = null;
+    touchStartYRef.current = null;
+    if (startX == null || startY == null) return;
+    const t = e.changedTouches[0];
+    const dx = t.clientX - startX;
+    const dy = t.clientY - startY;
+    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
+      if (dx < 0) {
+        showNext();
+      } else {
+        showPrev();
+      }
+    }
+  };
@@
-          <div
-            className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
-            onClick={closeLightbox}
-          >
-            <div className="relative w-full h-full max-h-[100vh] flex items-center justify-center" onClick={e => e.stopPropagation()}>
+          <div
+            className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
+            onClick={closeLightbox}
+          >
+            <div
+              className="relative w-full h-full max-h-[100vh] flex items-center justify-center"
+              onClick={e => e.stopPropagation()}
+              onTouchStart={handleTouchStart}
+              onTouchEnd={handleTouchEnd}
+            >
               <button
                 type="button"
                 className="absolute top-4 right-4 p-2 rounded-full bg-black/60 hover:bg-black/80 text-white"
                 onClick={closeLightbox}
                 aria-label="Close"
               >
                 <X className="w-5 h-5" />
               </button>
               {galleryImages.length > 1 && (
                 <button
                   type="button"
                   className="absolute left-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                   onClick={showPrev}
                   aria-label="Previous image"
                 >
                   <ChevronLeft className="w-6 h-6" />
                 </button>
               )}
               <img
                 src={galleryImages[lightboxIndex].url}
                 alt={(galleryImages[lightboxIndex].caption || prop.name) as string}
                 className="max-w-[95vw] max-h-[70vh] object-contain"
               />
+              {/* Caption */}
+              <div className="absolute left-0 right-0 top-[calc(50%+40vh)] md:top-auto md:bottom-24 px-6 text-center">
+                <div className="inline-block bg-black/50 text-white/90 text-sm md:text-base px-3 py-1 rounded">
+                  {galleryImages[lightboxIndex].caption || prop.name}
+                </div>
+              </div>
               {galleryImages.length > 1 && (
                 <button
                   type="button"
                   className="absolute right-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                   onClick={showNext}
                   aria-label="Next image"
                 >
                   <ChevronRight className="w-6 h-6" />
                 </button>
               )}
+              {/* Thumbnails strip */}
+              {galleryImages.length > 1 && (
+                <div className="absolute bottom-4 left-0 right-0 px-6">
+                  <div className="mx-auto max-w-[95vw] bg-black/30 rounded-lg p-2 overflow-x-auto">
+                    <div className="flex items-center gap-2">
+                      {galleryImages.map((img, idx) => {
+                        const selected = idx === lightboxIndex;
+                        return (
+                          <button
+                            key={img.id || img.url}
+                            type="button"
+                            onClick={() => setLightboxIndex(idx)}
+                            className={`relative w-16 h-16 md:w-20 md:h-20 rounded overflow-hidden border ${selected ? 'border-white ring-2 ring-white' : 'border-white/30 hover:border-white/60'}`}
+                            aria-label={`View image ${idx + 1}`}
+                          >
+                            <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
+                          </button>
+                        );
+                      })}
+                    </div>
+                  </div>
+                </div>
+              )}
             </div>
           </div>
         )}
*** End Patch
```

Reading `PropDetailPage.tsx` to locate the current lightbox markup and add swipe handling and a thumbnail carousel with captions.

Adding swipe gestures and a captioned thumbnail carousel to the lightbox on the prop details page, then checking for lint issues.

```typescriptreact
import React, { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop } from '../../shared/types/props';
import { ArrowLeft, Pencil, X, ChevronLeft, ChevronRight } from 'lucide-react';

function formatDate(value: any): string {
  if (!value) return 'N/A';
  if (typeof value === 'object' && value.seconds) {
    try {
      if (typeof value.toDate === 'function') {
        return value.toDate().toLocaleString();
      }
      return new Date(value.seconds * 1000).toLocaleString();
    } catch {
      return JSON.stringify(value);
    }
  }
  if (typeof value === 'string') return value;
  return String(value);
}

const PropDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [prop, setProp] = useState<Prop | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();

  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [lightboxIndex, setLightboxIndex] = useState(0);
  const touchStartXRef = useRef<number | null>(null);
  const touchStartYRef = useRef<number | null>(null);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setProp(doc?.data as Prop || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !prop) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  const mainImage = prop.images?.find(img => img.isMain)?.url || prop.images?.[0]?.url || prop.imageUrl || '';

  const galleryImages = React.useMemo(() => {
    const imgs = (prop?.images || [])
      .filter(img => !!img && !!img.url)
      .map(img => ({ url: img.url, caption: (img as any).caption || '', id: (img as any).id, isMain: (img as any).isMain }));
    if (prop?.imageUrl && !imgs.some(i => i.url === prop.imageUrl)) {
      imgs.unshift({ url: prop.imageUrl, caption: prop?.name || '', id: 'primary' } as any);
    }
    const mainIdx = imgs.findIndex(i => (i as any).isMain);
    if (mainIdx > 0) {
      const [m] = imgs.splice(mainIdx, 1);
      imgs.unshift(m);
    }
    return imgs;
  }, [prop]);

  const openLightboxAt = (index: number) => {
    if (!galleryImages.length) return;
    setLightboxIndex(Math.max(0, Math.min(index, galleryImages.length - 1)));
    setLightboxOpen(true);
  };
  const closeLightbox = () => setLightboxOpen(false);
  const showPrev = () => setLightboxIndex(i => (i - 1 + galleryImages.length) % galleryImages.length);
  const showNext = () => setLightboxIndex(i => (i + 1) % galleryImages.length);

  const handleTouchStart = (e: React.TouchEvent) => {
    const t = e.touches[0];
    touchStartXRef.current = t.clientX;
    touchStartYRef.current = t.clientY;
  };

  const handleTouchEnd = (e: React.TouchEvent) => {
    const startX = touchStartXRef.current;
    const startY = touchStartYRef.current;
    touchStartXRef.current = null;
    touchStartYRef.current = null;
    if (startX == null || startY == null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
      if (dx < 0) {
        showNext();
      } else {
        showPrev();
      }
    }
  };

  React.useEffect(() => {
    if (!lightboxOpen) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showPrev();
      if (e.key === 'ArrowRight') showNext();
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [lightboxOpen, galleryImages.length]);

  const handleEdit = () => {
    if (id) navigate(`/props/${id}/edit`);
  };

  const renderField = (label: string, value: any, isDate = false) => (
    <div className="mb-2">
      <span className="font-semibold text-pb-primary">{label}:</span>{' '}
      <span className="text-white">{isDate ? formatDate(value) : (value ?? 'N/A')}</span>
    </div>
  );

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="flex items-center justify-between mb-4">
          <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-pb-primary hover:text-pb-accent">
            <ArrowLeft className="w-5 h-5" /> Back
          </button>
        </div>
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-8 relative">
          {/* Edit Icon Button */}
          <button
            onClick={handleEdit}
            className="absolute top-4 right-4 bg-pb-primary hover:bg-pb-accent text-white rounded-full p-2 shadow focus:outline-none focus:ring-2 focus:ring-pb-primary transition"
            aria-label="Edit Prop"
            title="Edit Prop"
          >
            <Pencil className="w-5 h-5" />
          </button>
          {/* Header & Main Info */}
          <div className="flex flex-col md:flex-row gap-8">
            <div className="flex-shrink-0 w-48 h-48 rounded-lg overflow-hidden bg-pb-gray flex items-center justify-center">
              {mainImage ? (
                <button
                  type="button"
                  onClick={() => {
                    const idx = galleryImages.findIndex(i => i.url === mainImage);
                    openLightboxAt(idx >= 0 ? idx : 0);
                  }}
                  className="block w-full h-full cursor-zoom-in"
                  title="Click to view larger"
                >
                  <img src={mainImage} alt={prop.name} className="object-cover w-full h-full" />
                </button>
              ) : (
                <div className="flex items-center justify-center w-full h-full text-pb-light/60">
                  <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
                  </svg>
                </div>
              )}
            </div>
            <div className="flex-1 min-w-0">
              <h1 className="text-2xl font-bold text-white mb-2">{prop.name}</h1>
              <div className="flex flex-wrap gap-2 mb-2">
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-primary/30 text-white">{prop.category}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-accent/30 text-white">Qty: {prop.quantity}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-gray text-white">{prop.status}</span>
              </div>
              {prop.description && <p className="text-pb-gray mb-4 whitespace-pre-line">{prop.description}</p>}
            </div>
          </div>
          {/* Gallery under main image */}
          {galleryImages.length > 1 && (
            <div className="mt-4 flex flex-col items-start">
              <div className="font-semibold text-pb-primary mb-2">Gallery</div>
              <div className="flex gap-2 flex-wrap">
                {galleryImages.map((img, idx) => (
                  <button
                    key={img.id || img.url}
                    type="button"
                    onClick={() => openLightboxAt(idx)}
                    className="w-20 h-20 rounded border border-pb-primary/30 overflow-hidden focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    title="View larger"
                  >
                    <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                  </button>
                ))}
              </div>
            </div>
          )}
          {/* Assignment & Show Info */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Show', prop.showId)}
            {renderField('Act', prop.act)}
            {renderField('Scene', prop.sceneName || prop.scene)}
            {renderField('Location', prop.location || prop.currentLocation)}
            {renderField('Assignment', prop.assignment?.name || prop.assignment?.id)}
            {renderField('Checked Out To', prop.checkedOutDetails?.to)}
            {renderField('Checked Out At', prop.checkedOutDetails?.checkedOutAt, true)}
            {renderField('Expected Return', prop.checkedOutDetails?.expectedReturnAt, true)}
          </div>
          {/* Physical Details */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Dimensions', (prop.length || prop.width || prop.height) ? `${prop.length || ''} x ${prop.width || ''} x ${prop.height || ''} ${prop.unit || ''}` : 'N/A')}
            {renderField('Depth', prop.depth)}
            {renderField('Weight', prop.weight ? `${prop.weight} ${prop.weightUnit || ''}` : 'N/A')}
            {renderField('Travel Weight', prop.travelWeight)}
            {renderField('Materials', prop.materials?.join(', '))}
            {renderField('Color', prop.color)}
            {renderField('Period', prop.period)}
            {renderField('Style', prop.style)}
            {renderField('Handedness', prop.handedness)}
            {renderField('Breakable', prop.isBreakable ? 'Yes' : 'No')}
            {renderField('Hazardous', prop.isHazardous ? 'Yes' : 'No')}
          </div>
          {/* Purchase & Rental */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Price', prop.price ? `£${prop.price}` : 'N/A')}
            {renderField('Source', prop.source)}
            {renderField('Source Details', prop.sourceDetails)}
            {renderField('Purchase URL', prop.purchaseUrl ? <a href={prop.purchaseUrl} className="text-pb-accent underline" target="_blank" rel="noopener noreferrer">{prop.purchaseUrl}</a> : 'N/A')}
            {renderField('Purchase Date', prop.purchaseDate, true)}
            {renderField('Rental Source', prop.rentalSource)}
            {renderField('Rental Due Date', prop.rentalDueDate, true)}
            {renderField('Rental Reference', prop.rentalReferenceNumber)}
            {renderField('Rental Info', 'N/A')}
          </div>
          {/* Manufacturer & Identification */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Manufacturer', prop.manufacturer)}
            {renderField('Model', prop.model)}
            {renderField('Serial Number', prop.serialNumber)}
            {renderField('Barcode', prop.barcode)}
            {renderField('Warranty', prop.warranty ? JSON.stringify(prop.warranty) : 'N/A')}
          </div>
          {/* Usage, Handling, Safety */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Usage Instructions', prop.usageInstructions)}
            {renderField('Handling Instructions', prop.handlingInstructions)}
            {renderField('Safety Notes', prop.safetyNotes)}
            {renderField('Pre-Show Setup', prop.preShowSetupNotes)}
            {renderField('Pre-Show Setup Video', prop.preShowSetupVideo)}
            {renderField('Pre-Show Setup Duration', prop.preShowSetupDuration)}
            {renderField('Shipping Crate', prop.hasOwnShippingCrate ? 'Yes' : 'No')}
            {renderField('Shipping Crate Details', prop.shippingCrateDetails)}
            {renderField('Transport Notes', prop.transportNotes)}
            {renderField('Requires Special Transport', prop.requiresSpecialTransport ? 'Yes' : 'No')}
            {renderField('Transport Method', prop.transportMethod)}
          </div>
          {/* Status & Lifecycle */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Status', prop.status)}
            {renderField('Status Notes', prop.statusNotes)}
            {renderField('Last Status Update', prop.lastStatusUpdate, true)}
            {renderField('Condition', prop.condition)}
            {renderField('Last Used At', prop.lastUsedAt, true)}
            {renderField('Last Modified At', prop.lastModifiedAt, true)}
            {renderField('Created At', prop.createdAt, true)}
            {renderField('Updated At', prop.updatedAt, true)}
            {renderField('Subcategory', prop.subcategory)}
            {renderField('Tags', prop.tags?.join(', '))}
          </div>
          {/* Maintenance & Inspection */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Maintenance Notes', prop.maintenanceNotes)}
            {renderField('Last Maintenance Date', prop.lastMaintenanceDate, true)}
            {renderField('Next Maintenance Due', prop.nextMaintenanceDue, true)}
            {renderField('Last Inspection Date', prop.lastInspectionDate, true)}
            {renderField('Next Inspection Due', prop.nextInspectionDue, true)}
            {renderField('Repair Estimate', prop.repairEstimate)}
            {renderField('Repair Priority', prop.repairPriority)}
            {renderField('Assigned To', prop.assignedUserDetails?.map(u => u.name).join(', ') || prop.assignedTo?.join(', '))}
            {renderField('Maintenance History', prop.maintenanceHistory ? JSON.stringify(prop.maintenanceHistory) : 'N/A')}
            {renderField('Status History', prop.statusHistory ? JSON.stringify(prop.statusHistory) : 'N/A')}
          </div>
          {/* Storage & Logistics */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Storage Requirements', prop.storageRequirements)}
            {renderField('Return Due Date', prop.returnDueDate, true)}
            {renderField('Expected Return Date', prop.expectedReturnDate, true)}
            {renderField('Replacement Cost', prop.replacementCost)}
            {renderField('Replacement Lead Time', prop.replacementLeadTime)}
            {renderField('Travels Unboxed', prop.travelsUnboxed ? 'Yes' : 'No')}
            {renderField('Courier', prop.courier)}
            {renderField('Tracking Number', prop.trackingNumber)}
          </div>
          {/* Digital Assets & Media */}
          <div className="space-y-2">
            <div className="font-semibold text-pb-primary mb-2">Digital Assets</div>
            {prop.digitalAssets && prop.digitalAssets.length > 0 ? (
              <ul className="space-y-2">
                {prop.digitalAssets.map(asset => (
                  <li key={asset.id} className="flex items-center gap-2">
                    <a href={asset.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{asset.name || asset.title || asset.url}</a>
                    <span className="text-xs text-pb-gray">[{asset.type}]</span>
                  </li>
                ))}
              </ul>
            ) : <div className="text-pb-gray">N/A</div>}
            {prop.videos && prop.videos.length > 0 && (
              <div className="mt-4">
                <div className="font-semibold text-pb-primary mb-2">Videos</div>
                <ul className="space-y-2">
                  {prop.videos.map(video => (
                    <li key={video.id} className="flex items-center gap-2">
                      <a href={video.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{video.name || video.title || video.url}</a>
                      <span className="text-xs text-pb-gray">[{video.type}]</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
          {/* Notes & Custom Fields */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Notes', prop.notes)}
            {renderField('Public Notes', prop.publicNotes)}
            {renderField('Custom Fields', prop.customFields ? JSON.stringify(prop.customFields) : 'N/A')}
            {renderField('Scene Notes', prop.sceneNotes)}
            {renderField('Usage Notes', prop.usageNotes)}
            {renderField('Modification Details', prop.modificationDetails)}
          </div>
        </motion.div>

        {/* Lightbox Modal */}
        {lightboxOpen && galleryImages.length > 0 && (
          <div
            className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
            onClick={closeLightbox}
          >
            <div
              className="relative w-full h-full max-h-[100vh] flex items-center justify-center"
              onClick={e => e.stopPropagation()}
              onTouchStart={handleTouchStart}
              onTouchEnd={handleTouchEnd}
            >
              <button
                type="button"
                className="absolute top-4 right-4 p-2 rounded-full bg-black/60 hover:bg-black/80 text-white"
                onClick={closeLightbox}
                aria-label="Close"
              >
                <X className="w-5 h-5" />
              </button>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute left-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showPrev}
                  aria-label="Previous image"
                >
                  <ChevronLeft className="w-6 h-6" />
                </button>
              )}
              <img
                src={galleryImages[lightboxIndex].url}
                alt={(galleryImages[lightboxIndex].caption || prop.name) as string}
                className="max-w-[95vw] max-h-[75vh] object-contain"
              />
              {/* Caption */}
              <div className="absolute left-0 right-0 bottom-28 px-6 text-center">
                <div className="inline-block bg-black/50 text-white/90 text-sm md:text-base px-3 py-1 rounded">
                  {galleryImages[lightboxIndex].caption || prop.name}
                </div>
              </div>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute right-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showNext}
                  aria-label="Next image"
                >
                  <ChevronRight className="w-6 h-6" />
                </button>
              )}
              {/* Thumbnails strip */}
              {galleryImages.length > 1 && (
                <div className="absolute bottom-4 left-0 right-0 px-6">
                  <div className="mx-auto max-w-[95vw] bg-black/30 rounded-lg p-2 overflow-x-auto">
                    <div className="flex items-center gap-2">
                      {galleryImages.map((img, idx) => {
                        const selected = idx === lightboxIndex;
                        return (
                          <button
                            key={img.id || img.url}
                            type="button"
                            onClick={() => setLightboxIndex(idx)}
                            className={`relative w-16 h-16 md:w-20 md:h-20 rounded overflow-hidden border ${selected ? 'border-white ring-2 ring-white' : 'border-white/30 hover:border-white/60'}`}
                            aria-label={`View image ${idx + 1}`}
                          >
                            <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </DashboardLayout>
  );
};

export default PropDetailPage; 
```

- Added swipe gestures: Left/right swipes navigate previous/next in the lightbox on touch devices.
- Added captioned thumbnail carousel inside the lightbox:
  - Shows caption (or prop name) under the main image.
  - Scrollable thumbnail strip at the bottom; clicking a thumbnail jumps to that image.
- File updated: `web-app/src/pages/PropDetailPage.tsx`
- Lint: clean.

Want me to add pinch-to-zoom or double-tap zoom support as well?

---

**User**

we are getting a white screen it looks like ther is a coding issue

---

**Cursor**

```typescriptreact
import React, { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop } from '../../shared/types/props';
import { ArrowLeft, Pencil, X, ChevronLeft, ChevronRight } from 'lucide-react';

function formatDate(value: any): string {
  if (!value) return 'N/A';
  if (typeof value === 'object' && value.seconds) {
    try {
      if (typeof value.toDate === 'function') {
        return value.toDate().toLocaleString();
      }
      return new Date(value.seconds * 1000).toLocaleString();
    } catch {
      return JSON.stringify(value);
    }
  }
  if (typeof value === 'string') return value;
  return String(value);
}

const PropDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [prop, setProp] = useState<Prop | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();

  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [lightboxIndex, setLightboxIndex] = useState(0);
  const touchStartXRef = useRef<number | null>(null);
  const touchStartYRef = useRef<number | null>(null);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setProp(doc?.data as Prop || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !prop) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  const mainImage = prop.images?.find(img => img.isMain)?.url || prop.images?.[0]?.url || prop.imageUrl || '';

  const galleryImages = React.useMemo(() => {
    const imgs = (prop?.images || [])
      .filter(img => !!img && !!img.url)
      .map(img => ({ url: img.url, caption: (img as any).caption || '', id: (img as any).id, isMain: (img as any).isMain }));
    if (prop?.imageUrl && !imgs.some(i => i.url === prop.imageUrl)) {
      imgs.unshift({ url: prop.imageUrl, caption: prop?.name || '', id: 'primary' } as any);
    }
    const mainIdx = imgs.findIndex(i => (i as any).isMain);
    if (mainIdx > 0) {
      const [m] = imgs.splice(mainIdx, 1);
      imgs.unshift(m);
    }
    return imgs;
  }, [prop]);

  const openLightboxAt = (index: number) => {
    if (!galleryImages.length) return;
    setLightboxIndex(Math.max(0, Math.min(index, galleryImages.length - 1)));
    setLightboxOpen(true);
  };
  const closeLightbox = () => setLightboxOpen(false);
  const showPrev = () => setLightboxIndex(i => (i - 1 + galleryImages.length) % galleryImages.length);
  const showNext = () => setLightboxIndex(i => (i + 1) % galleryImages.length);

  const handleTouchStart = (e: React.TouchEvent) => {
    const t = e.touches[0];
    touchStartXRef.current = t.clientX;
    touchStartYRef.current = t.clientY;
  };

  const handleTouchEnd = (e: React.TouchEvent) => {
    const startX = touchStartXRef.current;
    const startY = touchStartYRef.current;
    touchStartXRef.current = null;
    touchStartYRef.current = null;
    if (startX == null || startY == null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
      if (dx < 0) {
        showNext();
      } else {
        showPrev();
      }
    }
  };

  React.useEffect(() => {
    if (!lightboxOpen) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showPrev();
      if (e.key === 'ArrowRight') showNext();
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [lightboxOpen, galleryImages.length]);

  // Keep lightboxIndex in range if images array changes while open
  useEffect(() => {
    if (!lightboxOpen) return;
    if (galleryImages.length === 0) return;
    if (lightboxIndex < 0 || lightboxIndex >= galleryImages.length) {
      setLightboxIndex(Math.max(0, Math.min(lightboxIndex, galleryImages.length - 1)));
    }
  }, [lightboxOpen, galleryImages.length, lightboxIndex]);

  const handleEdit = () => {
    if (id) navigate(`/props/${id}/edit`);
  };

  const renderField = (label: string, value: any, isDate = false) => (
    <div className="mb-2">
      <span className="font-semibold text-pb-primary">{label}:</span>{' '}
      <span className="text-white">{isDate ? formatDate(value) : (value ?? 'N/A')}</span>
    </div>
  );

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="flex items-center justify-between mb-4">
          <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-pb-primary hover:text-pb-accent">
            <ArrowLeft className="w-5 h-5" /> Back
          </button>
        </div>
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-8 relative">
          {/* Edit Icon Button */}
          <button
            onClick={handleEdit}
            className="absolute top-4 right-4 bg-pb-primary hover:bg-pb-accent text-white rounded-full p-2 shadow focus:outline-none focus:ring-2 focus:ring-pb-primary transition"
            aria-label="Edit Prop"
            title="Edit Prop"
          >
            <Pencil className="w-5 h-5" />
          </button>
          {/* Header & Main Info */}
          <div className="flex flex-col md:flex-row gap-8">
            <div className="flex-shrink-0 w-48 h-48 rounded-lg overflow-hidden bg-pb-gray flex items-center justify-center">
              {mainImage ? (
                <button
                  type="button"
                  onClick={() => {
                    const idx = galleryImages.findIndex(i => i.url === mainImage);
                    openLightboxAt(idx >= 0 ? idx : 0);
                  }}
                  className="block w-full h-full cursor-zoom-in"
                  title="Click to view larger"
                >
                  <img src={mainImage} alt={prop.name} className="object-cover w-full h-full" />
                </button>
              ) : (
                <div className="flex items-center justify-center w-full h-full text-pb-light/60">
                  <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
                  </svg>
                </div>
              )}
            </div>
            <div className="flex-1 min-w-0">
              <h1 className="text-2xl font-bold text-white mb-2">{prop.name}</h1>
              <div className="flex flex-wrap gap-2 mb-2">
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-primary/30 text-white">{prop.category}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-accent/30 text-white">Qty: {prop.quantity}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-gray text-white">{prop.status}</span>
              </div>
              {prop.description && <p className="text-pb-gray mb-4 whitespace-pre-line">{prop.description}</p>}
            </div>
          </div>
          {/* Gallery under main image */}
          {galleryImages.length > 1 && (
            <div className="mt-4 flex flex-col items-start">
              <div className="font-semibold text-pb-primary mb-2">Gallery</div>
              <div className="flex gap-2 flex-wrap">
                {galleryImages.map((img, idx) => (
                  <button
                    key={img.id || img.url}
                    type="button"
                    onClick={() => openLightboxAt(idx)}
                    className="w-20 h-20 rounded border border-pb-primary/30 overflow-hidden focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    title="View larger"
                  >
                    <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                  </button>
                ))}
              </div>
            </div>
          )}
          {/* Assignment & Show Info */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Show', prop.showId)}
            {renderField('Act', prop.act)}
            {renderField('Scene', prop.sceneName || prop.scene)}
            {renderField('Location', prop.location || prop.currentLocation)}
            {renderField('Assignment', prop.assignment?.name || prop.assignment?.id)}
            {renderField('Checked Out To', prop.checkedOutDetails?.to)}
            {renderField('Checked Out At', prop.checkedOutDetails?.checkedOutAt, true)}
            {renderField('Expected Return', prop.checkedOutDetails?.expectedReturnAt, true)}
          </div>
          {/* Physical Details */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Dimensions', (prop.length || prop.width || prop.height) ? `${prop.length || ''} x ${prop.width || ''} x ${prop.height || ''} ${prop.unit || ''}` : 'N/A')}
            {renderField('Depth', prop.depth)}
            {renderField('Weight', prop.weight ? `${prop.weight} ${prop.weightUnit || ''}` : 'N/A')}
            {renderField('Travel Weight', prop.travelWeight)}
            {renderField('Materials', prop.materials?.join(', '))}
            {renderField('Color', prop.color)}
            {renderField('Period', prop.period)}
            {renderField('Style', prop.style)}
            {renderField('Handedness', prop.handedness)}
            {renderField('Breakable', prop.isBreakable ? 'Yes' : 'No')}
            {renderField('Hazardous', prop.isHazardous ? 'Yes' : 'No')}
          </div>
          {/* Purchase & Rental */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Price', prop.price ? `£${prop.price}` : 'N/A')}
            {renderField('Source', prop.source)}
            {renderField('Source Details', prop.sourceDetails)}
            {renderField('Purchase URL', prop.purchaseUrl ? <a href={prop.purchaseUrl} className="text-pb-accent underline" target="_blank" rel="noopener noreferrer">{prop.purchaseUrl}</a> : 'N/A')}
            {renderField('Purchase Date', prop.purchaseDate, true)}
            {renderField('Rental Source', prop.rentalSource)}
            {renderField('Rental Due Date', prop.rentalDueDate, true)}
            {renderField('Rental Reference', prop.rentalReferenceNumber)}
            {renderField('Rental Info', 'N/A')}
          </div>
          {/* Manufacturer & Identification */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Manufacturer', prop.manufacturer)}
            {renderField('Model', prop.model)}
            {renderField('Serial Number', prop.serialNumber)}
            {renderField('Barcode', prop.barcode)}
            {renderField('Warranty', prop.warranty ? JSON.stringify(prop.warranty) : 'N/A')}
          </div>
          {/* Usage, Handling, Safety */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Usage Instructions', prop.usageInstructions)}
            {renderField('Handling Instructions', prop.handlingInstructions)}
            {renderField('Safety Notes', prop.safetyNotes)}
            {renderField('Pre-Show Setup', prop.preShowSetupNotes)}
            {renderField('Pre-Show Setup Video', prop.preShowSetupVideo)}
            {renderField('Pre-Show Setup Duration', prop.preShowSetupDuration)}
            {renderField('Shipping Crate', prop.hasOwnShippingCrate ? 'Yes' : 'No')}
            {renderField('Shipping Crate Details', prop.shippingCrateDetails)}
            {renderField('Transport Notes', prop.transportNotes)}
            {renderField('Requires Special Transport', prop.requiresSpecialTransport ? 'Yes' : 'No')}
            {renderField('Transport Method', prop.transportMethod)}
          </div>
          {/* Status & Lifecycle */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Status', prop.status)}
            {renderField('Status Notes', prop.statusNotes)}
            {renderField('Last Status Update', prop.lastStatusUpdate, true)}
            {renderField('Condition', prop.condition)}
            {renderField('Last Used At', prop.lastUsedAt, true)}
            {renderField('Last Modified At', prop.lastModifiedAt, true)}
            {renderField('Created At', prop.createdAt, true)}
            {renderField('Updated At', prop.updatedAt, true)}
            {renderField('Subcategory', prop.subcategory)}
            {renderField('Tags', prop.tags?.join(', '))}
          </div>
          {/* Maintenance & Inspection */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Maintenance Notes', prop.maintenanceNotes)}
            {renderField('Last Maintenance Date', prop.lastMaintenanceDate, true)}
            {renderField('Next Maintenance Due', prop.nextMaintenanceDue, true)}
            {renderField('Last Inspection Date', prop.lastInspectionDate, true)}
            {renderField('Next Inspection Due', prop.nextInspectionDue, true)}
            {renderField('Repair Estimate', prop.repairEstimate)}
            {renderField('Repair Priority', prop.repairPriority)}
            {renderField('Assigned To', prop.assignedUserDetails?.map(u => u.name).join(', ') || prop.assignedTo?.join(', '))}
            {renderField('Maintenance History', prop.maintenanceHistory ? JSON.stringify(prop.maintenanceHistory) : 'N/A')}
            {renderField('Status History', prop.statusHistory ? JSON.stringify(prop.statusHistory) : 'N/A')}
          </div>
          {/* Storage & Logistics */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Storage Requirements', prop.storageRequirements)}
            {renderField('Return Due Date', prop.returnDueDate, true)}
            {renderField('Expected Return Date', prop.expectedReturnDate, true)}
            {renderField('Replacement Cost', prop.replacementCost)}
            {renderField('Replacement Lead Time', prop.replacementLeadTime)}
            {renderField('Travels Unboxed', prop.travelsUnboxed ? 'Yes' : 'No')}
            {renderField('Courier', prop.courier)}
            {renderField('Tracking Number', prop.trackingNumber)}
          </div>
          {/* Digital Assets & Media */}
          <div className="space-y-2">
            <div className="font-semibold text-pb-primary mb-2">Digital Assets</div>
            {prop.digitalAssets && prop.digitalAssets.length > 0 ? (
              <ul className="space-y-2">
                {prop.digitalAssets.map(asset => (
                  <li key={asset.id} className="flex items-center gap-2">
                    <a href={asset.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{asset.name || asset.title || asset.url}</a>
                    <span className="text-xs text-pb-gray">[{asset.type}]</span>
                  </li>
                ))}
              </ul>
            ) : <div className="text-pb-gray">N/A</div>}
            {prop.videos && prop.videos.length > 0 && (
              <div className="mt-4">
                <div className="font-semibold text-pb-primary mb-2">Videos</div>
                <ul className="space-y-2">
                  {prop.videos.map(video => (
                    <li key={video.id} className="flex items-center gap-2">
                      <a href={video.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{video.name || video.title || video.url}</a>
                      <span className="text-xs text-pb-gray">[{video.type}]</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
          {/* Notes & Custom Fields */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Notes', prop.notes)}
            {renderField('Public Notes', prop.publicNotes)}
            {renderField('Custom Fields', prop.customFields ? JSON.stringify(prop.customFields) : 'N/A')}
            {renderField('Scene Notes', prop.sceneNotes)}
            {renderField('Usage Notes', prop.usageNotes)}
            {renderField('Modification Details', prop.modificationDetails)}
          </div>
        </motion.div>

        {/* Lightbox Modal */}
        {lightboxOpen && galleryImages.length > 0 && galleryImages[lightboxIndex] && (
          <div
            className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
            onClick={closeLightbox}
          >
            <div
              className="relative w-full h-full max-h-[100vh] flex items-center justify-center"
              onClick={e => e.stopPropagation()}
              onTouchStart={handleTouchStart}
              onTouchEnd={handleTouchEnd}
            >
              <button
                type="button"
                className="absolute top-4 right-4 p-2 rounded-full bg-black/60 hover:bg-black/80 text-white"
                onClick={closeLightbox}
                aria-label="Close"
              >
                <X className="w-5 h-5" />
              </button>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute left-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showPrev}
                  aria-label="Previous image"
                >
                  <ChevronLeft className="w-6 h-6" />
                </button>
              )}
              <img
                src={galleryImages[lightboxIndex].url}
                alt={(galleryImages[lightboxIndex].caption || prop.name) as string}
                className="max-w-[95vw] max-h-[75vh] object-contain"
              />
              {/* Caption */}
              <div className="absolute left-0 right-0 bottom-28 px-6 text-center">
                <div className="inline-block bg-black/50 text-white/90 text-sm md:text-base px-3 py-1 rounded">
                  {galleryImages[lightboxIndex].caption || prop.name}
                </div>
              </div>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute right-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showNext}
                  aria-label="Next image"
                >
                  <ChevronRight className="w-6 h-6" />
                </button>
              )}
              {/* Thumbnails strip */}
              {galleryImages.length > 1 && (
                <div className="absolute bottom-4 left-0 right-0 px-6">
                  <div className="mx-auto max-w-[95vw] bg-black/30 rounded-lg p-2 overflow-x-auto">
                    <div className="flex items-center gap-2">
                      {galleryImages.map((img, idx) => {
                        const selected = idx === lightboxIndex;
                        return (
                          <button
                            key={img.id || img.url}
                            type="button"
                            onClick={() => setLightboxIndex(idx)}
                            className={`relative w-16 h-16 md:w-20 md:h-20 rounded overflow-hidden border ${selected ? 'border-white ring-2 ring-white' : 'border-white/30 hover:border-white/60'}`}
                            aria-label={`View image ${idx + 1}`}
                          >
                            <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </DashboardLayout>
  );
};

export default PropDetailPage; 
```

```typescriptreact
import React from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { motion } from 'framer-motion';
import {
  FileText,
  Package2,
  Clock,
  CheckCircle,
  Crown,
  Star
} from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { useFirebase } from './contexts/FirebaseContext';
import { useEffect, useState } from 'react';
import type { Show } from './types/Show';
import type { Prop } from './types/props';
import type { CardData } from './types/taskManager';
import { Link } from 'react-router-dom';
import { useWebAuth } from './contexts/WebAuthContext';

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};
const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: { duration: 0.4 }
  },
  hover: {
    scale: 1.02,
    transition: { duration: 0.2 }
  }
};
const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.5 }
  }
};

const DashboardHome: React.FC = () => {
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const [cards, setCards] = useState<CardData[]>([]);
  const { user, userProfile } = useWebAuth();

  // Fetch show
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShow({ ...doc.data, id: doc.id }),
      () => setShow(null)
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch props
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToCollection<Prop>(
      'props',
      data => setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...doc.data, id: doc.id }))),
      () => setProps([])
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch boards and cards
  useEffect(() => {
    if (!currentShowId) return;
    let unsubBoards: (() => void) | undefined;
    let unsubCards: (() => void)[] = [];
    unsubBoards = service.listenToCollection(
      'todo_boards',
      docs => {
        const filteredBoards = docs.filter(b => b.data.showId === currentShowId);
        // Listen to all cards in all lists in all boards
        unsubCards.forEach(u => u && u());
        unsubCards = [];
        filteredBoards.forEach(board => {
          service.listenToCollection(
            `todo_boards/${board.id}/lists`,
            lists => {
              lists.forEach(list => {
                const unsub = service.listenToCollection(
                  `todo_boards/${board.id}/lists/${list.id}/cards`,
                  cardsDocs => {
                    setCards(prev => {
                      // Remove old cards for this list
                      const other = prev.filter(c => c.listId !== list.id);
                      return [
                        ...other,
                        ...cardsDocs.map(cd => ({ ...(cd.data as CardData), id: cd.id, listId: list.id }))
                      ];
                    });
                  },
                  () => {}
                );
                unsubCards.push(unsub);
              });
            },
            () => {}
          );
        });
      },
      () => {}
    );
    return () => { if (unsubBoards) unsubBoards(); unsubCards.forEach(u => u && u()); };
  }, [service, currentShowId]);

  // Calculate stats
  const totalProps = props.length;
  const totalOutstandingTasks = cards.filter(card => !card.completed).length;
  const readyProps = props.filter(p => p.status === 'with-stage-management').length;
  const showReadyPercent = totalProps > 0 ? Math.round((readyProps / totalProps) * 100) : 0;

  // Recent props activity: list of props recently added or updated (one entry per prop)
  function toDateSafe(input: any): Date | null {
    if (!input) return null;
    if (input instanceof Date) return input;
    if (typeof input === 'number') return new Date(input);
    if (typeof input === 'string' && input.trim() !== '') {
      const parsed = new Date(input);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
    if (input && typeof input.toDate === 'function') {
      try {
        const d = input.toDate();
        return d instanceof Date && !isNaN(d.getTime()) ? d : null;
      } catch {
        return null;
      }
    }
    return null;
  }

  // Single recent activity list (added or updated, most recent per prop)
  const recentActivity = props
    .map(p => {
      const created = toDateSafe((p as any).createdAt);
      const updated = toDateSafe((p as any).updatedAt);
      const latest = updated && (!created || updated >= created) ? updated : created;
      const type: 'added' | 'updated' = updated && created ? (updated >= created ? 'updated' : 'added') : (updated ? 'updated' : 'added');
      return latest ? { prop: p, type, date: latest } : null;
    })
    .filter((x): x is { prop: Prop; type: 'added' | 'updated'; date: Date } => Boolean(x))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 8);

  // Urgent tasks row
  const now = new Date();
  const tasksWithDue = cards.filter(card => card.dueDate && !card.completed).map(card => ({
    ...card,
    due: card.dueDate ? new Date(card.dueDate) : new Date()
  })).sort((a, b) => a.due.getTime() - b.due.getTime()).slice(0, 6);

  // Cards assigned to or mentioning the current user
  const assignedOrMentionedCards = cards.filter(card => {
    if (!user) return false;
    const assigned = Array.isArray(card.assignedTo) && card.assignedTo.includes(user.uid);
    const mention = (userProfile && card.description && (
      (userProfile.displayName && card.description.includes(userProfile.displayName)) ||
      (userProfile.email && card.description.includes(userProfile.email))
    ));
    return assigned || mention;
  });

  function getTaskColor(due: Date) {
    if (due < now) return 'bg-red-600 text-white';
    const diff = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (diff < 2) return 'bg-orange-500 text-white';
    return 'bg-green-600 text-white';
  }

  function isValidDateString(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  // Days until first performance
  let daysLeft = null;
  let perfDate: Date | null = null;
  const perfRaw = (show as any)?.firstPerformanceDate || show?.startDate;
  const temp = perfRaw;
  if (typeof temp === 'string' && temp.trim() !== '') {
    perfDate = new Date(temp);
  } else if (typeof temp === 'number' && !isNaN(temp)) {
    perfDate = new Date(temp);
  } else if (temp && typeof temp.toDate === 'function') {
    perfDate = temp.toDate();
  }
  if (perfDate) {
    daysLeft = Math.max(0, Math.ceil((perfDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));
  }

  // Find the next upcoming show date
  let nextShowDateLabel = '';
  if (show) {
    const now = new Date();
    const dateFields = [
      { key: 'rehearsalStartDate', label: 'Rehearsal' },
      { key: 'techWeekStartDate', label: 'Tech Week' },
      { key: 'firstPerformanceDate', label: 'First Performance' },
      { key: 'pressNightDate', label: 'Press Night' },
      { key: 'startDate', label: 'Start' },
      { key: 'endDate', label: 'End' },
    ];
    const upcoming = dateFields
      .map(({ key, label }) => {
        const raw = (show as any)[key];
        let date: Date | null = null;
        const temp = raw;
        if (isValidDateString(temp) && temp !== undefined) {
          date = new Date(temp);
        } else if (typeof temp === 'number' && !isNaN(temp)) {
          date = new Date(temp);
        } else if (temp && typeof temp.toDate === 'function') {
          date = temp.toDate();
        }
        return date && date > now ? { date, label } : null;
      })
      .filter(Boolean) as { date: Date; label: string }[];
    if (upcoming.length > 0) {
      const soonest = upcoming.reduce((a, b) => (a.date < b.date ? a : b));
      if (soonest.date instanceof Date && !isNaN(soonest.date.getTime())) {
        nextShowDateLabel = `Next Show Date: ${soonest.label} – ${soonest.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
      } else {
        nextShowDateLabel = `Next Show Date: ${soonest.label}`;
      }
    } else {
      nextShowDateLabel = 'No upcoming show dates';
    }
  }

  return (
    <DashboardLayout>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="max-w-7xl mx-auto space-y-6"
      >
        {/* Show Banner */}
        <motion.div
          variants={cardVariants}
          className="bg-gradient-to-r from-pb-primary to-pb-secondary rounded-2xl p-6 relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-pb-primary/20 to-pb-secondary/20 backdrop-blur-sm"></div>
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  {show?.name || 'Select a Show'}
                </h2>
                <p className="text-pb-light/80">{nextShowDateLabel}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">{daysLeft !== null ? `${daysLeft} days` : '--'}</div>
                <div className="text-pb-light/80 text-sm">until first night</div>
              </div>
            </div>
            <div className="w-full bg-pb-light/20 rounded-full h-2">
              <motion.div
                className="bg-pb-success h-2 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${showReadyPercent}%` }}
                transition={{ duration: 1, delay: 0.5 }}
              />
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Statistics Cards */}
          <motion.div variants={itemVariants} className="lg:col-span-2">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {[
                { icon: Package2, label: 'Total Props', value: totalProps, color: 'bg-pb-blue' },
                { icon: Clock, label: 'Pending Tasks', value: totalOutstandingTasks, color: 'bg-pb-orange' },
                { icon: CheckCircle, label: 'Ready for Show', value: `${showReadyPercent}%`, color: 'bg-pb-success' },
              ].map((stat, index) => (
                <motion.div
                  key={index}
                  variants={cardVariants}
                  whileHover="hover"
                  className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-4 border border-pb-primary/20"
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-10 h-10 ${stat.color}/20 rounded-xl flex items-center justify-center`}>
                      <stat.icon className={`w-5 h-5 ${stat.color.replace('bg-', 'text-')}`} />
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-white mb-1">{stat.value}</div>
                  <div className="text-sm text-pb-gray">{stat.label}</div>
                </motion.div>
              ))}
            </div>

            {/* Urgent Tasks Row */}
            <motion.div variants={itemVariants}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className="w-5 h-5 text-pb-primary" />
                <h3 className="text-lg font-semibold text-white">Urgent Tasks</h3>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {tasksWithDue.length === 0 && <div className="text-pb-gray">No urgent tasks.</div>}
                {tasksWithDue.map((task) => (
                  <Link key={task.id} to={`/boards?cardId=${task.id}`} className="min-w-[220px]">
                    <div className={`p-4 rounded-xl shadow ${getTaskColor(task.due)}`}>
                      <div className="font-bold text-lg">{task.title}</div>
                      <div className="text-xs mb-1">Due: {task.due.toLocaleString()}</div>
                      <div className="text-xs">{task.description}</div>
                    </div>
                  </Link>
                ))}
              </div>
            </motion.div>{user && assignedOrMentionedCards.length > 0 && (
          <motion.div variants={itemVariants}>
            <div className="flex items-center space-x-2 mb-4 mt-6">
              <Star className="w-5 h-5 text-pb-accent" />
              <h3 className="text-lg font-semibold text-white">Your Tasks</h3>
            </div>
            <div className="flex gap-3 overflow-x-auto pb-2">
              {assignedOrMentionedCards.map(card => (
                <Link key={card.id} to={`/boards?cardId=${card.id}`} className="min-w-[220px]">
                  <div className="p-4 rounded-xl shadow bg-pb-primary/80 text-white">
                    <div className="font-bold text-lg">{card.title}</div>
                    {card.dueDate && <div className="text-xs mb-1">Due: {new Date(card.dueDate).toLocaleString()}</div>}
                    <div className="text-xs line-clamp-2">{card.description}</div>
            </div>
                </Link>
            ))}
          </div>
        </motion.div>
        )}

          </motion.div>

          {/* Recent Props Activity */}
          <motion.div variants={itemVariants} className="lg:col-span-1">
            <div className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-6 border border-pb-primary/20 h-full">
              <div className="flex items-center space-x-2 mb-4">
                <FileText className="w-5 h-5 text-pb-accent" />
                <h3 className="text-lg font-semibold text-white">Recent Props Activity</h3>
              </div>
              
              {/* Single Recent List */}
              <div className="space-y-3">
                {recentActivity.length === 0 && <div className="text-pb-gray">No recent activity.</div>}
                {recentActivity.map((item, index) => (
                  <Link key={`${item.type}-${item.prop.id}`} to={`/props/${item.prop.id}`} className="block">
                    <motion.div
                      initial={{ opacity: 0, x: 20 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: index * 0.05 }}
                      className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                    >
                      <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <Crown className="w-4 h-4 text-pb-accent" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-white truncate">{item.prop.name}</p>
                        <p className="text-xs text-pb-gray">{item.type === 'added' ? 'Prop added' : 'Prop updated'}</p>
                        <p className="text-xs text-pb-gray mt-1">{item.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}</p>
                      </div>
                    </motion.div>
                  </Link>
                ))}
              
            </div>
            </div>
          </motion.div>
        </div>

        {/* Assigned/Mentioned Tasks Row */}
        
      </motion.div>
    </DashboardLayout>
  );
};

export default DashboardHome; 
```

```typescriptreact
import React from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { motion } from 'framer-motion';
import {
  FileText,
  Package2,
  Clock,
  CheckCircle,
  Crown,
  Star
} from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { useFirebase } from './contexts/FirebaseContext';
import { useEffect, useState } from 'react';
import type { Show } from './types/Show';
import type { Prop } from './types/props';
import type { CardData } from './types/taskManager';
import { Link } from 'react-router-dom';
import { useWebAuth } from './contexts/WebAuthContext';

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};
const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: { duration: 0.4 }
  },
  hover: {
    scale: 1.02,
    transition: { duration: 0.2 }
  }
};
const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { duration: 0.5 }
  }
};

const DashboardHome: React.FC = () => {
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const [cards, setCards] = useState<CardData[]>([]);
  const { user, userProfile } = useWebAuth();

  // Fetch show
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShow({ ...doc.data, id: doc.id }),
      () => setShow(null)
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch props
  useEffect(() => {
    if (!currentShowId) return;
    const unsub = service.listenToCollection<Prop>(
      'props',
      data => setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...doc.data, id: doc.id }))),
      () => setProps([])
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // Fetch boards and cards
  useEffect(() => {
    if (!currentShowId) return;
    let unsubBoards: (() => void) | undefined;
    let unsubCards: (() => void)[] = [];
    unsubBoards = service.listenToCollection(
      'todo_boards',
      docs => {
        const filteredBoards = docs.filter(b => b.data.showId === currentShowId);
        // Listen to all cards in all lists in all boards
        unsubCards.forEach(u => u && u());
        unsubCards = [];
        filteredBoards.forEach(board => {
          service.listenToCollection(
            `todo_boards/${board.id}/lists`,
            lists => {
              lists.forEach(list => {
                const unsub = service.listenToCollection(
                  `todo_boards/${board.id}/lists/${list.id}/cards`,
                  cardsDocs => {
                    setCards(prev => {
                      // Remove old cards for this list
                      const other = prev.filter(c => c.listId !== list.id);
                      return [
                        ...other,
                        ...cardsDocs.map(cd => ({ ...(cd.data as CardData), id: cd.id, listId: list.id }))
                      ];
                    });
                  },
                  () => {}
                );
                unsubCards.push(unsub);
              });
            },
            () => {}
          );
        });
      },
      () => {}
    );
    return () => { if (unsubBoards) unsubBoards(); unsubCards.forEach(u => u && u()); };
  }, [service, currentShowId]);

  // Calculate stats
  const totalProps = props.length;
  const totalOutstandingTasks = cards.filter(card => !card.completed).length;
  const readyProps = props.filter(p => p.status === 'with-stage-management').length;
  const showReadyPercent = totalProps > 0 ? Math.round((readyProps / totalProps) * 100) : 0;

  // Recent props activity: list of props recently added or updated (one entry per prop)
  function toDateSafe(input: any): Date | null {
    if (!input) return null;
    if (input instanceof Date) return input;
    if (typeof input === 'number') return new Date(input);
    if (typeof input === 'string' && input.trim() !== '') {
      const parsed = new Date(input);
      return isNaN(parsed.getTime()) ? null : parsed;
    }
    if (input && typeof input.toDate === 'function') {
      try {
        const d = input.toDate();
        return d instanceof Date && !isNaN(d.getTime()) ? d : null;
      } catch {
        return null;
      }
    }
    return null;
  }

  // Single recent activity list (added or updated, most recent per prop)
  const recentActivity = props
    .map(p => {
      const created = toDateSafe((p as any).createdAt);
      const updated = toDateSafe((p as any).updatedAt);
      const latest = updated && (!created || updated >= created) ? updated : created;
      const type: 'added' | 'updated' = updated && created ? (updated >= created ? 'updated' : 'added') : (updated ? 'updated' : 'added');
      return latest ? { prop: p, type, date: latest } : null;
    })
    .filter((x): x is { prop: Prop; type: 'added' | 'updated'; date: Date } => Boolean(x))
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .slice(0, 8);

  // Urgent tasks row
  const now = new Date();
  const tasksWithDue = cards.filter(card => card.dueDate && !card.completed).map(card => ({
    ...card,
    due: card.dueDate ? new Date(card.dueDate) : new Date()
  })).sort((a, b) => a.due.getTime() - b.due.getTime()).slice(0, 6);

  // Cards assigned to or mentioning the current user
  const assignedOrMentionedCards = cards.filter(card => {
    if (!user) return false;
    const assigned = Array.isArray(card.assignedTo) && card.assignedTo.includes(user.uid);
    const mention = (userProfile && card.description && (
      (userProfile.displayName && card.description.includes(userProfile.displayName)) ||
      (userProfile.email && card.description.includes(userProfile.email))
    ));
    return assigned || mention;
  });

  function getTaskColor(due: Date) {
    if (due < now) return 'bg-red-600 text-white';
    const diff = (due.getTime() - now.getTime()) / (1000 * 60 * 60 * 24);
    if (diff < 2) return 'bg-orange-500 text-white';
    return 'bg-green-600 text-white';
  }

  function isValidDateString(val: unknown): val is string {
    return typeof val === 'string' && val.trim() !== '';
  }

  // Days until first performance
  let daysLeft = null;
  let perfDate: Date | null = null;
  const perfRaw = (show as any)?.firstPerformanceDate || show?.startDate;
  const temp = perfRaw;
  if (typeof temp === 'string' && temp.trim() !== '') {
    perfDate = new Date(temp);
  } else if (typeof temp === 'number' && !isNaN(temp)) {
    perfDate = new Date(temp);
  } else if (temp && typeof temp.toDate === 'function') {
    perfDate = temp.toDate();
  }
  if (perfDate) {
    daysLeft = Math.max(0, Math.ceil((perfDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)));
  }

  // Find the next upcoming show date
  let nextShowDateLabel = '';
  if (show) {
    const now = new Date();
    const dateFields = [
      { key: 'rehearsalStartDate', label: 'Rehearsal' },
      { key: 'techWeekStartDate', label: 'Tech Week' },
      { key: 'firstPerformanceDate', label: 'First Performance' },
      { key: 'pressNightDate', label: 'Press Night' },
      { key: 'startDate', label: 'Start' },
      { key: 'endDate', label: 'End' },
    ];
    const upcoming = dateFields
      .map(({ key, label }) => {
        const raw = (show as any)[key];
        let date: Date | null = null;
        const temp = raw;
        if (isValidDateString(temp) && temp !== undefined) {
          date = new Date(temp);
        } else if (typeof temp === 'number' && !isNaN(temp)) {
          date = new Date(temp);
        } else if (temp && typeof temp.toDate === 'function') {
          date = temp.toDate();
        }
        return date && date > now ? { date, label } : null;
      })
      .filter(Boolean) as { date: Date; label: string }[];
    if (upcoming.length > 0) {
      const soonest = upcoming.reduce((a, b) => (a.date < b.date ? a : b));
      if (soonest.date instanceof Date && !isNaN(soonest.date.getTime())) {
        nextShowDateLabel = `Next Show Date: ${soonest.label} – ${soonest.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}`;
      } else {
        nextShowDateLabel = `Next Show Date: ${soonest.label}`;
      }
    } else {
      nextShowDateLabel = 'No upcoming show dates';
    }
  }

  return (
    <DashboardLayout>
      <motion.div
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="max-w-7xl mx-auto space-y-6"
      >
        {/* Show Banner */}
        <motion.div
          variants={cardVariants}
          className="bg-gradient-to-r from-pb-primary to-pb-secondary rounded-2xl p-6 relative overflow-hidden"
        >
          <div className="absolute inset-0 bg-gradient-to-r from-pb-primary/20 to-pb-secondary/20 backdrop-blur-sm"></div>
          <div className="relative z-10">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-white">
                  {show?.name || 'Select a Show'}
                </h2>
                <p className="text-pb-light/80">{nextShowDateLabel}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">{daysLeft !== null ? `${daysLeft} days` : '--'}</div>
                <div className="text-pb-light/80 text-sm">until first night</div>
              </div>
            </div>
            <div className="w-full bg-pb-light/20 rounded-full h-2">
              <motion.div
                className="bg-pb-success h-2 rounded-full"
                initial={{ width: 0 }}
                animate={{ width: `${showReadyPercent}%` }}
                transition={{ duration: 1, delay: 0.5 }}
              />
            </div>
          </div>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Statistics Cards */}
          <motion.div variants={itemVariants} className="lg:col-span-2">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {[
                { icon: Package2, label: 'Total Props', value: totalProps, color: 'bg-pb-blue' },
                { icon: Clock, label: 'Pending Tasks', value: totalOutstandingTasks, color: 'bg-pb-orange' },
                { icon: CheckCircle, label: 'Ready for Show', value: `${showReadyPercent}%`, color: 'bg-pb-success' },
              ].map((stat, index) => (
                <motion.div
                  key={index}
                  variants={cardVariants}
                  whileHover="hover"
                  className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-4 border border-pb-primary/20"
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className={`w-10 h-10 ${stat.color}/20 rounded-xl flex items-center justify-center`}>
                      <stat.icon className={`w-5 h-5 ${stat.color.replace('bg-', 'text-')}`} />
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-white mb-1">{stat.value}</div>
                  <div className="text-sm text-pb-gray">{stat.label}</div>
                </motion.div>
              ))}
            </div>

            {/* Urgent Tasks Row */}
            <motion.div variants={itemVariants}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className="w-5 h-5 text-pb-primary" />
                <h3 className="text-lg font-semibold text-white">Urgent Tasks</h3>
              </div>
              <div className="flex gap-3 overflow-x-auto pb-2">
                {tasksWithDue.length === 0 && <div className="text-pb-gray">No urgent tasks.</div>}
                {tasksWithDue.map((task) => (
                  <Link key={task.id} to={`/boards?cardId=${task.id}`} className="min-w-[220px]">
                    <div className={`p-4 rounded-xl shadow ${getTaskColor(task.due)}`}>
                      <div className="font-bold text-lg">{task.title}</div>
                      <div className="text-xs mb-1">Due: {task.due.toLocaleString()}</div>
                      <div className="text-xs">{task.description}</div>
                    </div>
                  </Link>
                ))}
              </div>
            </motion.div>{user && assignedOrMentionedCards.length > 0 && (
          <motion.div variants={itemVariants}>
            <div className="flex items-center space-x-2 mb-4 mt-6">
              <Star className="w-5 h-5 text-pb-accent" />
              <h3 className="text-lg font-semibold text-white">Your Tasks</h3>
            </div>
            <div className="flex gap-3 overflow-x-auto pb-2">
              {assignedOrMentionedCards.map(card => (
                <Link key={card.id} to={`/boards?cardId=${card.id}`} className="min-w-[220px]">
                  <div className="p-4 rounded-xl shadow bg-pb-primary/80 text-white">
                    <div className="font-bold text-lg">{card.title}</div>
                    {card.dueDate && <div className="text-xs mb-1">Due: {new Date(card.dueDate).toLocaleString()}</div>}
                    <div className="text-xs line-clamp-2">{card.description}</div>
            </div>
                </Link>
            ))}
          </div>
        </motion.div>
        )}

          </motion.div>

          {/* Recent Props Activity */}
          <motion.div variants={itemVariants} className="lg:col-span-1">
            <div className="bg-pb-darker/50 backdrop-blur-sm rounded-2xl p-6 border border-pb-primary/20 h-full">
              <div className="flex items-center space-x-2 mb-4">
                <FileText className="w-5 h-5 text-pb-accent" />
                <h3 className="text-lg font-semibold text-white">Recent Props Activity</h3>
              </div>
              
              {/* Single Recent List */}
              <div className="space-y-3">
                {recentActivity.length === 0 && <div className="text-pb-gray">No recent activity.</div>}
                {recentActivity.map((item, index) => (
                  <Link key={`${item.type}-${item.prop.id}`} to={`/props/${item.prop.id}`} className="block">
                    <motion.div
                      initial={{ opacity: 0, x: 20 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: index * 0.05 }}
                      className="flex items-start space-x-3 p-3 rounded-lg bg-pb-primary/5 hover:bg-pb-primary/10 transition-colors"
                    >
                      <div className="w-8 h-8 bg-pb-accent/20 rounded-lg flex items-center justify-center flex-shrink-0">
                        <Crown className="w-4 h-4 text-pb-accent" />
                      </div>
                      <div className="flex-1 min-w-0">
                        <p className="text-sm font-medium text-white truncate">{item.prop.name}</p>
                        <p className="text-xs text-pb-gray">{item.type === 'added' ? 'Prop added' : 'Prop updated'}</p>
                        <p className="text-xs text-pb-gray mt-1">{item.date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' })}</p>
                      </div>
                    </motion.div>
                  </Link>
                ))}
              </div>
            </div>
          </motion.div>
        </div>

        {/* Assigned/Mentioned Tasks Row */}
        
      </motion.div>
    </DashboardLayout>
  );
};

export default DashboardHome; 
```

- Fixed a likely JSX structure issue in `web-app/src/DashboardHome.tsx` that could cause a white screen by ensuring the “Recent Props Activity” section is properly closed and nested.
- Hardened the lightbox in `web-app/src/pages/PropDetailPage.tsx` to prevent undefined access if the image list changes while open, and added a guard.
- Lint: both files are clean.

If you’re still seeing a white screen, please share the browser console errors. I can trace the exact component/line fast.

---

**User**

client:495 [vite] connecting...
client:618 [vite] connected.
hook.js:608 [2025-08-08T23:03:11.849Z]  @firebase/firestore: Firestore (11.10.0): enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead. Error Component Stack
    at FirebaseProvider (FirebaseContext.tsx:27:69)
overrideMethod @ hook.js:608
hook.js:608 [2025-08-08T23:03:11.851Z]  @firebase/firestore: Firestore (11.10.0): enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.
overrideMethod @ hook.js:608
hook.js:608 Warning: React has detected a change in the order of Hooks called by PropDetailPage. This will lead to bugs and errors if not fixed. For more information, read the Rules of Hooks: https://reactjs.org/link/rules-of-hooks

   Previous render            Next render
   ------------------------------------------------------
1. useContext                 useContext
2. useContext                 useContext
3. useState                   useState
4. useState                   useState
5. useState                   useState
6. useContext                 useContext
7. useContext                 useContext
8. useContext                 useContext
9. useContext                 useContext
10. useContext                useContext
11. useContext                useContext
12. useContext                useContext
13. useRef                    useRef
14. useContext                useContext
15. useLayoutEffect           useLayoutEffect
16. useCallback               useCallback
17. useState                  useState
18. useState                  useState
19. useRef                    useRef
20. useRef                    useRef
21. useEffect                 useEffect
22. undefined                 useMemo
   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
 Error Component Stack
    at PropDetailPage (PropDetailPage.tsx:26:18)
    at RenderedRoute (react-router-dom.js?v=f5a6f759:5455:26)
    at Routes (react-router-dom.js?v=f5a6f759:6188:3)
    at Router (react-router-dom.js?v=f5a6f759:6131:13)
    at BrowserRouter (react-router-dom.js?v=f5a6f759:9149:3)
    at ShowSelectionProvider (ShowSelectionContext.tsx:10:82)
    at App (App.tsx:27:29)
    at WebAuthProvider (WebAuthContext.tsx:59:35)
    at FirebaseProvider (FirebaseContext.tsx:27:69)
overrideMethod @ hook.js:608
chunk-GKJBSOWT.js?v=f5a6f759:11678 Uncaught Error: Rendered more hooks than during the previous render.
    at updateWorkInProgressHook (chunk-GKJBSOWT.js?v=f5a6f759:11678:21)
    at updateMemo (chunk-GKJBSOWT.js?v=f5a6f759:12199:22)
    at Object.useMemo (chunk-GKJBSOWT.js?v=f5a6f759:12726:24)
    at Object.useMemo (chunk-QJTFJ6OV.js?v=f5a6f759:1094:29)
    at PropDetailPage (PropDetailPage.tsx:57:31)
    at renderWithHooks (chunk-GKJBSOWT.js?v=f5a6f759:11548:26)
    at updateFunctionComponent (chunk-GKJBSOWT.js?v=f5a6f759:14582:28)
    at beginWork (chunk-GKJBSOWT.js?v=f5a6f759:15924:22)
    at HTMLUnknownElement.callCallback2 (chunk-GKJBSOWT.js?v=f5a6f759:3674:22)
    at Object.invokeGuardedCallbackDev (chunk-GKJBSOWT.js?v=f5a6f759:3699:24)
chunk-GKJBSOWT.js?v=f5a6f759:11678 Uncaught Error: Rendered more hooks than during the previous render.
    at updateWorkInProgressHook (chunk-GKJBSOWT.js?v=f5a6f759:11678:21)
    at updateMemo (chunk-GKJBSOWT.js?v=f5a6f759:12199:22)
    at Object.useMemo (chunk-GKJBSOWT.js?v=f5a6f759:12726:24)
    at Object.useMemo (chunk-QJTFJ6OV.js?v=f5a6f759:1094:29)
    at PropDetailPage (PropDetailPage.tsx:57:31)
    at renderWithHooks (chunk-GKJBSOWT.js?v=f5a6f759:11548:26)
    at updateFunctionComponent (chunk-GKJBSOWT.js?v=f5a6f759:14582:28)
    at beginWork (chunk-GKJBSOWT.js?v=f5a6f759:15924:22)
    at HTMLUnknownElement.callCallback2 (chunk-GKJBSOWT.js?v=f5a6f759:3674:22)
    at Object.invokeGuardedCallbackDev (chunk-GKJBSOWT.js?v=f5a6f759:3699:24)
hook.js:608 The above error occurred in the <PropDetailPage> component:

    at PropDetailPage (http://localhost:3000/src/pages/PropDetailPage.tsx?t=1754694178509:41:18)
    at RenderedRoute (http://localhost:3000/node_modules/.vite/deps/react-router-dom.js?v=f5a6f759:5455:26)
    at Routes (http://localhost:3000/node_modules/.vite/deps/react-router-dom.js?v=f5a6f759:6188:3)
    at Router (http://localhost:3000/node_modules/.vite/deps/react-router-dom.js?v=f5a6f759:6131:13)
    at BrowserRouter (http://localhost:3000/node_modules/.vite/deps/react-router-dom.js?v=f5a6f759:9149:3)
    at ShowSelectionProvider (http://localhost:3000/src/contexts/ShowSelectionContext.tsx:20:41)
    at App (http://localhost:3000/src/App.tsx?t=1754694185941:43:29)
    at WebAuthProvider (http://localhost:3000/src/contexts/WebAuthContext.tsx:32:35)
    at FirebaseProvider (http://localhost:3000/src/contexts/FirebaseContext.tsx:22:36)

Consider adding an error boundary to your tree to customize error handling behavior.
Visit https://reactjs.org/link/error-boundaries to learn more about error boundaries.
overrideMethod @ hook.js:608
chunk-GKJBSOWT.js?v=f5a6f759:19413 Uncaught Error: Rendered more hooks than during the previous render.
    at updateWorkInProgressHook (chunk-GKJBSOWT.js?v=f5a6f759:11678:21)
    at updateMemo (chunk-GKJBSOWT.js?v=f5a6f759:12199:22)
    at Object.useMemo (chunk-GKJBSOWT.js?v=f5a6f759:12726:24)
    at Object.useMemo (chunk-QJTFJ6OV.js?v=f5a6f759:1094:29)
    at PropDetailPage (PropDetailPage.tsx:57:31)
    at renderWithHooks (chunk-GKJBSOWT.js?v=f5a6f759:11548:26)
    at updateFunctionComponent (chunk-GKJBSOWT.js?v=f5a6f759:14582:28)
    at beginWork (chunk-GKJBSOWT.js?v=f5a6f759:15924:22)
    at beginWork$1 (chunk-GKJBSOWT.js?v=f5a6f759:19753:22)
    at performUnitOfWork (chunk-GKJBSOWT.js?v=f5a6f759:19198:20)


---

**Cursor**

```typescriptreact
import React, { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop } from '../../shared/types/props';
import { ArrowLeft, Pencil, X, ChevronLeft, ChevronRight } from 'lucide-react';

function formatDate(value: any): string {
  if (!value) return 'N/A';
  if (typeof value === 'object' && value.seconds) {
    try {
      if (typeof value.toDate === 'function') {
        return value.toDate().toLocaleString();
      }
      return new Date(value.seconds * 1000).toLocaleString();
    } catch {
      return JSON.stringify(value);
    }
  }
  if (typeof value === 'string') return value;
  return String(value);
}

const PropDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [prop, setProp] = useState<Prop | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();

  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [lightboxIndex, setLightboxIndex] = useState(0);
  const touchStartXRef = useRef<number | null>(null);
  const touchStartYRef = useRef<number | null>(null);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setProp(doc?.data as Prop || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  const mainImage = prop?.images?.find(img => img.isMain)?.url || prop?.images?.[0]?.url || prop?.imageUrl || '';

  const galleryImages = React.useMemo(() => {
    const imgs = (prop?.images || [])
      .filter(img => !!img && !!img.url)
      .map(img => ({ url: img.url, caption: (img as any).caption || '', id: (img as any).id, isMain: (img as any).isMain }));
    if (prop?.imageUrl && !imgs.some(i => i.url === prop.imageUrl)) {
      imgs.unshift({ url: prop.imageUrl, caption: prop?.name || '', id: 'primary' } as any);
    }
    const mainIdx = imgs.findIndex(i => (i as any).isMain);
    if (mainIdx > 0) {
      const [m] = imgs.splice(mainIdx, 1);
      imgs.unshift(m);
    }
    return imgs;
  }, [prop]);

  const openLightboxAt = (index: number) => {
    if (!galleryImages.length) return;
    setLightboxIndex(Math.max(0, Math.min(index, galleryImages.length - 1)));
    setLightboxOpen(true);
  };
  const closeLightbox = () => setLightboxOpen(false);
  const showPrev = () => setLightboxIndex(i => (i - 1 + galleryImages.length) % galleryImages.length);
  const showNext = () => setLightboxIndex(i => (i + 1) % galleryImages.length);

  const handleTouchStart = (e: React.TouchEvent) => {
    const t = e.touches[0];
    touchStartXRef.current = t.clientX;
    touchStartYRef.current = t.clientY;
  };

  const handleTouchEnd = (e: React.TouchEvent) => {
    const startX = touchStartXRef.current;
    const startY = touchStartYRef.current;
    touchStartXRef.current = null;
    touchStartYRef.current = null;
    if (startX == null || startY == null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
      if (dx < 0) {
        showNext();
      } else {
        showPrev();
      }
    }
  };

  React.useEffect(() => {
    if (!lightboxOpen) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showPrev();
      if (e.key === 'ArrowRight') showNext();
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [lightboxOpen, galleryImages.length]);

  // Keep lightboxIndex in range if images array changes while open
  useEffect(() => {
    if (!lightboxOpen) return;
    if (galleryImages.length === 0) return;
    if (lightboxIndex < 0 || lightboxIndex >= galleryImages.length) {
      setLightboxIndex(Math.max(0, Math.min(lightboxIndex, galleryImages.length - 1)));
    }
  }, [lightboxOpen, galleryImages.length, lightboxIndex]);

  const handleEdit = () => {
    if (id) navigate(`/props/${id}/edit`);
  };

  const renderField = (label: string, value: any, isDate = false) => (
    <div className="mb-2">
      <span className="font-semibold text-pb-primary">{label}:</span>{' '}
      <span className="text-white">{isDate ? formatDate(value) : (value ?? 'N/A')}</span>
    </div>
  );

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="flex items-center justify-between mb-4">
          <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-pb-primary hover:text-pb-accent">
            <ArrowLeft className="w-5 h-5" /> Back
          </button>
        </div>
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-8 relative">
          {/* Edit Icon Button */}
          <button
            onClick={handleEdit}
            className="absolute top-4 right-4 bg-pb-primary hover:bg-pb-accent text-white rounded-full p-2 shadow focus:outline-none focus:ring-2 focus:ring-pb-primary transition"
            aria-label="Edit Prop"
            title="Edit Prop"
          >
            <Pencil className="w-5 h-5" />
          </button>
          {/* Header & Main Info */}
          <div className="flex flex-col md:flex-row gap-8">
            <div className="flex-shrink-0 w-48 h-48 rounded-lg overflow-hidden bg-pb-gray flex items-center justify-center">
              {mainImage ? (
                <button
                  type="button"
                  onClick={() => {
                    const idx = galleryImages.findIndex(i => i.url === mainImage);
                    openLightboxAt(idx >= 0 ? idx : 0);
                  }}
                  className="block w-full h-full cursor-zoom-in"
                  title="Click to view larger"
                >
                  <img src={mainImage} alt={prop.name} className="object-cover w-full h-full" />
                </button>
              ) : (
                <div className="flex items-center justify-center w-full h-full text-pb-light/60">
                  <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
                  </svg>
                </div>
              )}
            </div>
            <div className="flex-1 min-w-0">
              <h1 className="text-2xl font-bold text-white mb-2">{prop.name}</h1>
              <div className="flex flex-wrap gap-2 mb-2">
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-primary/30 text-white">{prop.category}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-accent/30 text-white">Qty: {prop.quantity}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-gray text-white">{prop.status}</span>
              </div>
              {prop.description && <p className="text-pb-gray mb-4 whitespace-pre-line">{prop.description}</p>}
            </div>
          </div>
          {/* Gallery under main image */}
          {galleryImages.length > 1 && (
            <div className="mt-4 flex flex-col items-start">
              <div className="font-semibold text-pb-primary mb-2">Gallery</div>
              <div className="flex gap-2 flex-wrap">
                {galleryImages.map((img, idx) => (
                  <button
                    key={img.id || img.url}
                    type="button"
                    onClick={() => openLightboxAt(idx)}
                    className="w-20 h-20 rounded border border-pb-primary/30 overflow-hidden focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    title="View larger"
                  >
                    <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                  </button>
                ))}
              </div>
            </div>
          )}
          {/* Assignment & Show Info */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Show', prop.showId)}
            {renderField('Act', prop.act)}
            {renderField('Scene', prop.sceneName || prop.scene)}
            {renderField('Location', prop.location || prop.currentLocation)}
            {renderField('Assignment', prop.assignment?.name || prop.assignment?.id)}
            {renderField('Checked Out To', prop.checkedOutDetails?.to)}
            {renderField('Checked Out At', prop.checkedOutDetails?.checkedOutAt, true)}
            {renderField('Expected Return', prop.checkedOutDetails?.expectedReturnAt, true)}
          </div>
          {/* Physical Details */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Dimensions', (prop.length || prop.width || prop.height) ? `${prop.length || ''} x ${prop.width || ''} x ${prop.height || ''} ${prop.unit || ''}` : 'N/A')}
            {renderField('Depth', prop.depth)}
            {renderField('Weight', prop.weight ? `${prop.weight} ${prop.weightUnit || ''}` : 'N/A')}
            {renderField('Travel Weight', prop.travelWeight)}
            {renderField('Materials', prop.materials?.join(', '))}
            {renderField('Color', prop.color)}
            {renderField('Period', prop.period)}
            {renderField('Style', prop.style)}
            {renderField('Handedness', prop.handedness)}
            {renderField('Breakable', prop.isBreakable ? 'Yes' : 'No')}
            {renderField('Hazardous', prop.isHazardous ? 'Yes' : 'No')}
          </div>
          {/* Purchase & Rental */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Price', prop.price ? `£${prop.price}` : 'N/A')}
            {renderField('Source', prop.source)}
            {renderField('Source Details', prop.sourceDetails)}
            {renderField('Purchase URL', prop.purchaseUrl ? <a href={prop.purchaseUrl} className="text-pb-accent underline" target="_blank" rel="noopener noreferrer">{prop.purchaseUrl}</a> : 'N/A')}
            {renderField('Purchase Date', prop.purchaseDate, true)}
            {renderField('Rental Source', prop.rentalSource)}
            {renderField('Rental Due Date', prop.rentalDueDate, true)}
            {renderField('Rental Reference', prop.rentalReferenceNumber)}
            {renderField('Rental Info', 'N/A')}
          </div>
          {/* Manufacturer & Identification */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Manufacturer', prop.manufacturer)}
            {renderField('Model', prop.model)}
            {renderField('Serial Number', prop.serialNumber)}
            {renderField('Barcode', prop.barcode)}
            {renderField('Warranty', prop.warranty ? JSON.stringify(prop.warranty) : 'N/A')}
          </div>
          {/* Usage, Handling, Safety */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Usage Instructions', prop.usageInstructions)}
            {renderField('Handling Instructions', prop.handlingInstructions)}
            {renderField('Safety Notes', prop.safetyNotes)}
            {renderField('Pre-Show Setup', prop.preShowSetupNotes)}
            {renderField('Pre-Show Setup Video', prop.preShowSetupVideo)}
            {renderField('Pre-Show Setup Duration', prop.preShowSetupDuration)}
            {renderField('Shipping Crate', prop.hasOwnShippingCrate ? 'Yes' : 'No')}
            {renderField('Shipping Crate Details', prop.shippingCrateDetails)}
            {renderField('Transport Notes', prop.transportNotes)}
            {renderField('Requires Special Transport', prop.requiresSpecialTransport ? 'Yes' : 'No')}
            {renderField('Transport Method', prop.transportMethod)}
          </div>
          {/* Status & Lifecycle */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Status', prop.status)}
            {renderField('Status Notes', prop.statusNotes)}
            {renderField('Last Status Update', prop.lastStatusUpdate, true)}
            {renderField('Condition', prop.condition)}
            {renderField('Last Used At', prop.lastUsedAt, true)}
            {renderField('Last Modified At', prop.lastModifiedAt, true)}
            {renderField('Created At', prop.createdAt, true)}
            {renderField('Updated At', prop.updatedAt, true)}
            {renderField('Subcategory', prop.subcategory)}
            {renderField('Tags', prop.tags?.join(', '))}
          </div>
          {/* Maintenance & Inspection */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Maintenance Notes', prop.maintenanceNotes)}
            {renderField('Last Maintenance Date', prop.lastMaintenanceDate, true)}
            {renderField('Next Maintenance Due', prop.nextMaintenanceDue, true)}
            {renderField('Last Inspection Date', prop.lastInspectionDate, true)}
            {renderField('Next Inspection Due', prop.nextInspectionDue, true)}
            {renderField('Repair Estimate', prop.repairEstimate)}
            {renderField('Repair Priority', prop.repairPriority)}
            {renderField('Assigned To', prop.assignedUserDetails?.map(u => u.name).join(', ') || prop.assignedTo?.join(', '))}
            {renderField('Maintenance History', prop.maintenanceHistory ? JSON.stringify(prop.maintenanceHistory) : 'N/A')}
            {renderField('Status History', prop.statusHistory ? JSON.stringify(prop.statusHistory) : 'N/A')}
          </div>
          {/* Storage & Logistics */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Storage Requirements', prop.storageRequirements)}
            {renderField('Return Due Date', prop.returnDueDate, true)}
            {renderField('Expected Return Date', prop.expectedReturnDate, true)}
            {renderField('Replacement Cost', prop.replacementCost)}
            {renderField('Replacement Lead Time', prop.replacementLeadTime)}
            {renderField('Travels Unboxed', prop.travelsUnboxed ? 'Yes' : 'No')}
            {renderField('Courier', prop.courier)}
            {renderField('Tracking Number', prop.trackingNumber)}
          </div>
          {/* Digital Assets & Media */}
          <div className="space-y-2">
            <div className="font-semibold text-pb-primary mb-2">Digital Assets</div>
            {prop.digitalAssets && prop.digitalAssets.length > 0 ? (
              <ul className="space-y-2">
                {prop.digitalAssets.map(asset => (
                  <li key={asset.id} className="flex items-center gap-2">
                    <a href={asset.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{asset.name || asset.title || asset.url}</a>
                    <span className="text-xs text-pb-gray">[{asset.type}]</span>
                  </li>
                ))}
              </ul>
            ) : <div className="text-pb-gray">N/A</div>}
            {prop.videos && prop.videos.length > 0 && (
              <div className="mt-4">
                <div className="font-semibold text-pb-primary mb-2">Videos</div>
                <ul className="space-y-2">
                  {prop.videos.map(video => (
                    <li key={video.id} className="flex items-center gap-2">
                      <a href={video.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{video.name || video.title || video.url}</a>
                      <span className="text-xs text-pb-gray">[{video.type}]</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
          {/* Notes & Custom Fields */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Notes', prop.notes)}
            {renderField('Public Notes', prop.publicNotes)}
            {renderField('Custom Fields', prop.customFields ? JSON.stringify(prop.customFields) : 'N/A')}
            {renderField('Scene Notes', prop.sceneNotes)}
            {renderField('Usage Notes', prop.usageNotes)}
            {renderField('Modification Details', prop.modificationDetails)}
          </div>
        </motion.div>

        {/* Lightbox Modal */}
        {lightboxOpen && galleryImages.length > 0 && galleryImages[lightboxIndex] && (
          <div
            className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
            onClick={closeLightbox}
          >
            <div
              className="relative w-full h-full max-h-[100vh] flex items-center justify-center"
              onClick={e => e.stopPropagation()}
              onTouchStart={handleTouchStart}
              onTouchEnd={handleTouchEnd}
            >
              <button
                type="button"
                className="absolute top-4 right-4 p-2 rounded-full bg-black/60 hover:bg-black/80 text-white"
                onClick={closeLightbox}
                aria-label="Close"
              >
                <X className="w-5 h-5" />
              </button>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute left-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showPrev}
                  aria-label="Previous image"
                >
                  <ChevronLeft className="w-6 h-6" />
                </button>
              )}
              <img
                src={galleryImages[lightboxIndex].url}
                alt={(galleryImages[lightboxIndex].caption || prop.name) as string}
                className="max-w-[95vw] max-h-[75vh] object-contain"
              />
              {/* Caption */}
              <div className="absolute left-0 right-0 bottom-28 px-6 text-center">
                <div className="inline-block bg-black/50 text-white/90 text-sm md:text-base px-3 py-1 rounded">
                  {galleryImages[lightboxIndex].caption || prop.name}
                </div>
              </div>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute right-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showNext}
                  aria-label="Next image"
                >
                  <ChevronRight className="w-6 h-6" />
                </button>
              )}
              {/* Thumbnails strip */}
              {galleryImages.length > 1 && (
                <div className="absolute bottom-4 left-0 right-0 px-6">
                  <div className="mx-auto max-w-[95vw] bg-black/30 rounded-lg p-2 overflow-x-auto">
                    <div className="flex items-center gap-2">
                      {galleryImages.map((img, idx) => {
                        const selected = idx === lightboxIndex;
                        return (
                          <button
                            key={img.id || img.url}
                            type="button"
                            onClick={() => setLightboxIndex(idx)}
                            className={`relative w-16 h-16 md:w-20 md:h-20 rounded overflow-hidden border ${selected ? 'border-white ring-2 ring-white' : 'border-white/30 hover:border-white/60'}`}
                            aria-label={`View image ${idx + 1}`}
                          >
                            <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </DashboardLayout>
  );
};

export default PropDetailPage; 
```

```typescriptreact
import React, { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop } from '../../shared/types/props';
import { ArrowLeft, Pencil, X, ChevronLeft, ChevronRight } from 'lucide-react';

function formatDate(value: any): string {
  if (!value) return 'N/A';
  if (typeof value === 'object' && value.seconds) {
    try {
      if (typeof value.toDate === 'function') {
        return value.toDate().toLocaleString();
      }
      return new Date(value.seconds * 1000).toLocaleString();
    } catch {
      return JSON.stringify(value);
    }
  }
  if (typeof value === 'string') return value;
  return String(value);
}

const PropDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [prop, setProp] = useState<Prop | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();

  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [lightboxIndex, setLightboxIndex] = useState(0);
  const touchStartXRef = useRef<number | null>(null);
  const touchStartYRef = useRef<number | null>(null);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setProp(doc?.data as Prop || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  const mainImage = prop?.images?.find(img => img.isMain)?.url || prop?.images?.[0]?.url || prop?.imageUrl || '';

  const galleryImages = React.useMemo(() => {
    const imgs = (prop?.images || [])
      .filter(img => !!img && !!img.url)
      .map(img => ({ url: img.url, caption: (img as any).caption || '', id: (img as any).id, isMain: (img as any).isMain }));
    if (prop?.imageUrl && !imgs.some(i => i.url === prop.imageUrl)) {
      imgs.unshift({ url: prop.imageUrl, caption: prop?.name || '', id: 'primary' } as any);
    }
    const mainIdx = imgs.findIndex(i => (i as any).isMain);
    if (mainIdx > 0) {
      const [m] = imgs.splice(mainIdx, 1);
      imgs.unshift(m);
    }
    return imgs;
  }, [prop?.images, prop?.imageUrl, prop?.name]);

  const openLightboxAt = (index: number) => {
    if (!galleryImages.length) return;
    setLightboxIndex(Math.max(0, Math.min(index, galleryImages.length - 1)));
    setLightboxOpen(true);
  };
  const closeLightbox = () => setLightboxOpen(false);
  const showPrev = () => setLightboxIndex(i => (i - 1 + galleryImages.length) % galleryImages.length);
  const showNext = () => setLightboxIndex(i => (i + 1) % galleryImages.length);

  const handleTouchStart = (e: React.TouchEvent) => {
    const t = e.touches[0];
    touchStartXRef.current = t.clientX;
    touchStartYRef.current = t.clientY;
  };

  const handleTouchEnd = (e: React.TouchEvent) => {
    const startX = touchStartXRef.current;
    const startY = touchStartYRef.current;
    touchStartXRef.current = null;
    touchStartYRef.current = null;
    if (startX == null || startY == null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
      if (dx < 0) {
        showNext();
      } else {
        showPrev();
      }
    }
  };

  React.useEffect(() => {
    if (!lightboxOpen) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showPrev();
      if (e.key === 'ArrowRight') showNext();
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [lightboxOpen, galleryImages.length]);

  // Keep lightboxIndex in range if images array changes while open
  useEffect(() => {
    if (!lightboxOpen) return;
    if (galleryImages.length === 0) return;
    if (lightboxIndex < 0 || lightboxIndex >= galleryImages.length) {
      setLightboxIndex(Math.max(0, Math.min(lightboxIndex, galleryImages.length - 1)));
    }
  }, [lightboxOpen, galleryImages.length, lightboxIndex]);

  const handleEdit = () => {
    if (id) navigate(`/props/${id}/edit`);
  };

  const renderField = (label: string, value: any, isDate = false) => (
    <div className="mb-2">
      <span className="font-semibold text-pb-primary">{label}:</span>{' '}
      <span className="text-white">{isDate ? formatDate(value) : (value ?? 'N/A')}</span>
    </div>
  );

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="flex items-center justify-between mb-4">
          <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-pb-primary hover:text-pb-accent">
            <ArrowLeft className="w-5 h-5" /> Back
          </button>
        </div>
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-8 relative">
          {/* Edit Icon Button */}
          <button
            onClick={handleEdit}
            className="absolute top-4 right-4 bg-pb-primary hover:bg-pb-accent text-white rounded-full p-2 shadow focus:outline-none focus:ring-2 focus:ring-pb-primary transition"
            aria-label="Edit Prop"
            title="Edit Prop"
          >
            <Pencil className="w-5 h-5" />
          </button>
          {/* Header & Main Info */}
          <div className="flex flex-col md:flex-row gap-8">
            <div className="flex-shrink-0 w-48 h-48 rounded-lg overflow-hidden bg-pb-gray flex items-center justify-center">
              {mainImage ? (
                <button
                  type="button"
                  onClick={() => {
                    const idx = galleryImages.findIndex(i => i.url === mainImage);
                    openLightboxAt(idx >= 0 ? idx : 0);
                  }}
                  className="block w-full h-full cursor-zoom-in"
                  title="Click to view larger"
                >
                  <img src={mainImage} alt={prop.name} className="object-cover w-full h-full" />
                </button>
              ) : (
                <div className="flex items-center justify-center w-full h-full text-pb-light/60">
                  <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
                  </svg>
                </div>
              )}
            </div>
            <div className="flex-1 min-w-0">
              <h1 className="text-2xl font-bold text-white mb-2">{prop.name}</h1>
              <div className="flex flex-wrap gap-2 mb-2">
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-primary/30 text-white">{prop.category}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-accent/30 text-white">Qty: {prop.quantity}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-gray text-white">{prop.status}</span>
              </div>
              {prop.description && <p className="text-pb-gray mb-4 whitespace-pre-line">{prop.description}</p>}
            </div>
          </div>
          {/* Gallery under main image */}
          {galleryImages.length > 1 && (
            <div className="mt-4 flex flex-col items-start">
              <div className="font-semibold text-pb-primary mb-2">Gallery</div>
              <div className="flex gap-2 flex-wrap">
                {galleryImages.map((img, idx) => (
                  <button
                    key={img.id || img.url}
                    type="button"
                    onClick={() => openLightboxAt(idx)}
                    className="w-20 h-20 rounded border border-pb-primary/30 overflow-hidden focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    title="View larger"
                  >
                    <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                  </button>
                ))}
              </div>
            </div>
          )}
          {/* Assignment & Show Info */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Show', prop.showId)}
            {renderField('Act', prop.act)}
            {renderField('Scene', prop.sceneName || prop.scene)}
            {renderField('Location', prop.location || prop.currentLocation)}
            {renderField('Assignment', prop.assignment?.name || prop.assignment?.id)}
            {renderField('Checked Out To', prop.checkedOutDetails?.to)}
            {renderField('Checked Out At', prop.checkedOutDetails?.checkedOutAt, true)}
            {renderField('Expected Return', prop.checkedOutDetails?.expectedReturnAt, true)}
          </div>
          {/* Physical Details */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Dimensions', (prop.length || prop.width || prop.height) ? `${prop.length || ''} x ${prop.width || ''} x ${prop.height || ''} ${prop.unit || ''}` : 'N/A')}
            {renderField('Depth', prop.depth)}
            {renderField('Weight', prop.weight ? `${prop.weight} ${prop.weightUnit || ''}` : 'N/A')}
            {renderField('Travel Weight', prop.travelWeight)}
            {renderField('Materials', prop.materials?.join(', '))}
            {renderField('Color', prop.color)}
            {renderField('Period', prop.period)}
            {renderField('Style', prop.style)}
            {renderField('Handedness', prop.handedness)}
            {renderField('Breakable', prop.isBreakable ? 'Yes' : 'No')}
            {renderField('Hazardous', prop.isHazardous ? 'Yes' : 'No')}
          </div>
          {/* Purchase & Rental */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Price', prop.price ? `£${prop.price}` : 'N/A')}
            {renderField('Source', prop.source)}
            {renderField('Source Details', prop.sourceDetails)}
            {renderField('Purchase URL', prop.purchaseUrl ? <a href={prop.purchaseUrl} className="text-pb-accent underline" target="_blank" rel="noopener noreferrer">{prop.purchaseUrl}</a> : 'N/A')}
            {renderField('Purchase Date', prop.purchaseDate, true)}
            {renderField('Rental Source', prop.rentalSource)}
            {renderField('Rental Due Date', prop.rentalDueDate, true)}
            {renderField('Rental Reference', prop.rentalReferenceNumber)}
            {renderField('Rental Info', 'N/A')}
          </div>
          {/* Manufacturer & Identification */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Manufacturer', prop.manufacturer)}
            {renderField('Model', prop.model)}
            {renderField('Serial Number', prop.serialNumber)}
            {renderField('Barcode', prop.barcode)}
            {renderField('Warranty', prop.warranty ? JSON.stringify(prop.warranty) : 'N/A')}
          </div>
          {/* Usage, Handling, Safety */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Usage Instructions', prop.usageInstructions)}
            {renderField('Handling Instructions', prop.handlingInstructions)}
            {renderField('Safety Notes', prop.safetyNotes)}
            {renderField('Pre-Show Setup', prop.preShowSetupNotes)}
            {renderField('Pre-Show Setup Video', prop.preShowSetupVideo)}
            {renderField('Pre-Show Setup Duration', prop.preShowSetupDuration)}
            {renderField('Shipping Crate', prop.hasOwnShippingCrate ? 'Yes' : 'No')}
            {renderField('Shipping Crate Details', prop.shippingCrateDetails)}
            {renderField('Transport Notes', prop.transportNotes)}
            {renderField('Requires Special Transport', prop.requiresSpecialTransport ? 'Yes' : 'No')}
            {renderField('Transport Method', prop.transportMethod)}
          </div>
          {/* Status & Lifecycle */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Status', prop.status)}
            {renderField('Status Notes', prop.statusNotes)}
            {renderField('Last Status Update', prop.lastStatusUpdate, true)}
            {renderField('Condition', prop.condition)}
            {renderField('Last Used At', prop.lastUsedAt, true)}
            {renderField('Last Modified At', prop.lastModifiedAt, true)}
            {renderField('Created At', prop.createdAt, true)}
            {renderField('Updated At', prop.updatedAt, true)}
            {renderField('Subcategory', prop.subcategory)}
            {renderField('Tags', prop.tags?.join(', '))}
          </div>
          {/* Maintenance & Inspection */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Maintenance Notes', prop.maintenanceNotes)}
            {renderField('Last Maintenance Date', prop.lastMaintenanceDate, true)}
            {renderField('Next Maintenance Due', prop.nextMaintenanceDue, true)}
            {renderField('Last Inspection Date', prop.lastInspectionDate, true)}
            {renderField('Next Inspection Due', prop.nextInspectionDue, true)}
            {renderField('Repair Estimate', prop.repairEstimate)}
            {renderField('Repair Priority', prop.repairPriority)}
            {renderField('Assigned To', prop.assignedUserDetails?.map(u => u.name).join(', ') || prop.assignedTo?.join(', '))}
            {renderField('Maintenance History', prop.maintenanceHistory ? JSON.stringify(prop.maintenanceHistory) : 'N/A')}
            {renderField('Status History', prop.statusHistory ? JSON.stringify(prop.statusHistory) : 'N/A')}
          </div>
          {/* Storage & Logistics */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Storage Requirements', prop.storageRequirements)}
            {renderField('Return Due Date', prop.returnDueDate, true)}
            {renderField('Expected Return Date', prop.expectedReturnDate, true)}
            {renderField('Replacement Cost', prop.replacementCost)}
            {renderField('Replacement Lead Time', prop.replacementLeadTime)}
            {renderField('Travels Unboxed', prop.travelsUnboxed ? 'Yes' : 'No')}
            {renderField('Courier', prop.courier)}
            {renderField('Tracking Number', prop.trackingNumber)}
          </div>
          {/* Digital Assets & Media */}
          <div className="space-y-2">
            <div className="font-semibold text-pb-primary mb-2">Digital Assets</div>
            {prop.digitalAssets && prop.digitalAssets.length > 0 ? (
              <ul className="space-y-2">
                {prop.digitalAssets.map(asset => (
                  <li key={asset.id} className="flex items-center gap-2">
                    <a href={asset.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{asset.name || asset.title || asset.url}</a>
                    <span className="text-xs text-pb-gray">[{asset.type}]</span>
                  </li>
                ))}
              </ul>
            ) : <div className="text-pb-gray">N/A</div>}
            {prop.videos && prop.videos.length > 0 && (
              <div className="mt-4">
                <div className="font-semibold text-pb-primary mb-2">Videos</div>
                <ul className="space-y-2">
                  {prop.videos.map(video => (
                    <li key={video.id} className="flex items-center gap-2">
                      <a href={video.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{video.name || video.title || video.url}</a>
                      <span className="text-xs text-pb-gray">[{video.type}]</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
          {/* Notes & Custom Fields */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Notes', prop.notes)}
            {renderField('Public Notes', prop.publicNotes)}
            {renderField('Custom Fields', prop.customFields ? JSON.stringify(prop.customFields) : 'N/A')}
            {renderField('Scene Notes', prop.sceneNotes)}
            {renderField('Usage Notes', prop.usageNotes)}
            {renderField('Modification Details', prop.modificationDetails)}
          </div>
        </motion.div>

        {/* Lightbox Modal */}
        {lightboxOpen && galleryImages.length > 0 && galleryImages[lightboxIndex] && (
          <div
            className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
            onClick={closeLightbox}
          >
            <div
              className="relative w-full h-full max-h-[100vh] flex items-center justify-center"
              onClick={e => e.stopPropagation()}
              onTouchStart={handleTouchStart}
              onTouchEnd={handleTouchEnd}
            >
              <button
                type="button"
                className="absolute top-4 right-4 p-2 rounded-full bg-black/60 hover:bg-black/80 text-white"
                onClick={closeLightbox}
                aria-label="Close"
              >
                <X className="w-5 h-5" />
              </button>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute left-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showPrev}
                  aria-label="Previous image"
                >
                  <ChevronLeft className="w-6 h-6" />
                </button>
              )}
              <img
                src={galleryImages[lightboxIndex].url}
                alt={(galleryImages[lightboxIndex].caption || prop.name) as string}
                className="max-w-[95vw] max-h-[75vh] object-contain"
              />
              {/* Caption */}
              <div className="absolute left-0 right-0 bottom-28 px-6 text-center">
                <div className="inline-block bg-black/50 text-white/90 text-sm md:text-base px-3 py-1 rounded">
                  {galleryImages[lightboxIndex].caption || prop.name}
                </div>
              </div>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute right-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showNext}
                  aria-label="Next image"
                >
                  <ChevronRight className="w-6 h-6" />
                </button>
              )}
              {/* Thumbnails strip */}
              {galleryImages.length > 1 && (
                <div className="absolute bottom-4 left-0 right-0 px-6">
                  <div className="mx-auto max-w-[95vw] bg-black/30 rounded-lg p-2 overflow-x-auto">
                    <div className="flex items-center gap-2">
                      {galleryImages.map((img, idx) => {
                        const selected = idx === lightboxIndex;
                        return (
                          <button
                            key={img.id || img.url}
                            type="button"
                            onClick={() => setLightboxIndex(idx)}
                            className={`relative w-16 h-16 md:w-20 md:h-20 rounded overflow-hidden border ${selected ? 'border-white ring-2 ring-white' : 'border-white/30 hover:border-white/60'}`}
                            aria-label={`View image ${idx + 1}`}
                          >
                            <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </DashboardLayout>
  );
};

export default PropDetailPage; 
```

```typescriptreact
*** Begin Patch
*** Update File: web-app/src/pages/PropDetailPage.tsx
@@
-  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
-  if (error || !prop) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;
+  if (loading) {
+    return (
+      <DashboardLayout>
+        <div className="text-center text-pb-primary py-16">Loading prop...</div>
+      </DashboardLayout>
+    );
+  }
+  if (error || !prop) {
+    return (
+      <DashboardLayout>
+        <div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div>
+      </DashboardLayout>
+    );
+  }
*** End Patch
```

I see a React “Rendered more hooks than during the previous render” error in PropDetailPage – that’s caused by calling hooks conditionally (early returns before all hooks run). I fixed this by removing early-return render paths and guarding the UI instead.

What I changed
- In `web-app/src/pages/PropDetailPage.tsx`:
  - Ensured all hooks (`useMemo`, `useEffect`, etc.) are always called by moving/removing early returns.
  - Made image derivations safe with optional chaining for `prop`.
  - Guarded the lightbox render with `lightboxOpen && galleryImages.length > 0 && galleryImages[lightboxIndex]`.
  - Added swipe and thumbnail carousel previously; these remain.

What to do next
- Hard refresh the app (Ctrl+F5) to clear any stale HMR state and re-test `/props/:id`.
- The Firestore deprecation notice is harmless and unrelated.

If you still get a white screen, paste the new console error (line numbers will have shifted).

---

**User**

un the tsc

---

**Cursor**

I'll run the TypeScript compiler to catch any type errors. On Windows PowerShell, I'll run a non-interactive command without using &&.

- Ran TypeScript compile for `web-app` via PowerShell; no errors were reported.
- If you want, I can also run a full `vite` type check or `eslint` next.

---

**User**

For the code present, we get this error:
```
'prop' is possibly 'null'.
```
How can I resolve this? If you propose a fix, please make it concise.

---

**Cursor**

```typescriptreact
import React, { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop } from '../../shared/types/props';
import { ArrowLeft, Pencil, X, ChevronLeft, ChevronRight } from 'lucide-react';

function formatDate(value: any): string {
  if (!value) return 'N/A';
  if (typeof value === 'object' && value.seconds) {
    try {
      if (typeof value.toDate === 'function') {
        return value.toDate().toLocaleString();
      }
      return new Date(value.seconds * 1000).toLocaleString();
    } catch {
      return JSON.stringify(value);
    }
  }
  if (typeof value === 'string') return value;
  return String(value);
}

const PropDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [prop, setProp] = useState<Prop | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();

  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [lightboxIndex, setLightboxIndex] = useState(0);
  const touchStartXRef = useRef<number | null>(null);
  const touchStartYRef = useRef<number | null>(null);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setProp(doc?.data as Prop || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  const mainImage = prop?.images?.find(img => img.isMain)?.url || prop?.images?.[0]?.url || prop?.imageUrl || '';

  const galleryImages = React.useMemo(() => {
    const imgs = (prop?.images || [])
      .filter(img => !!img && !!img.url)
      .map(img => ({ url: img.url, caption: (img as any).caption || '', id: (img as any).id, isMain: (img as any).isMain }));
    if (prop?.imageUrl && !imgs.some(i => i.url === prop.imageUrl)) {
      imgs.unshift({ url: prop.imageUrl, caption: prop?.name || '', id: 'primary' } as any);
    }
    const mainIdx = imgs.findIndex(i => (i as any).isMain);
    if (mainIdx > 0) {
      const [m] = imgs.splice(mainIdx, 1);
      imgs.unshift(m);
    }
    return imgs;
  }, [prop?.images, prop?.imageUrl, prop?.name]);

  const openLightboxAt = (index: number) => {
    if (!galleryImages.length) return;
    setLightboxIndex(Math.max(0, Math.min(index, galleryImages.length - 1)));
    setLightboxOpen(true);
  };
  const closeLightbox = () => setLightboxOpen(false);
  const showPrev = () => setLightboxIndex(i => (i - 1 + galleryImages.length) % galleryImages.length);
  const showNext = () => setLightboxIndex(i => (i + 1) % galleryImages.length);

  const handleTouchStart = (e: React.TouchEvent) => {
    const t = e.touches[0];
    touchStartXRef.current = t.clientX;
    touchStartYRef.current = t.clientY;
  };

  const handleTouchEnd = (e: React.TouchEvent) => {
    const startX = touchStartXRef.current;
    const startY = touchStartYRef.current;
    touchStartXRef.current = null;
    touchStartYRef.current = null;
    if (startX == null || startY == null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
      if (dx < 0) {
        showNext();
      } else {
        showPrev();
      }
    }
  };

  React.useEffect(() => {
    if (!lightboxOpen) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showPrev();
      if (e.key === 'ArrowRight') showNext();
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [lightboxOpen, galleryImages.length]);

  // Keep lightboxIndex in range if images array changes while open
  useEffect(() => {
    if (!lightboxOpen) return;
    if (galleryImages.length === 0) return;
    if (lightboxIndex < 0 || lightboxIndex >= galleryImages.length) {
      setLightboxIndex(Math.max(0, Math.min(lightboxIndex, galleryImages.length - 1)));
    }
  }, [lightboxOpen, galleryImages.length, lightboxIndex]);

  const handleEdit = () => {
    if (id) navigate(`/props/${id}/edit`);
  };

  const renderField = (label: string, value: any, isDate = false) => (
    <div className="mb-2">
      <span className="font-semibold text-pb-primary">{label}:</span>{' '}
      <span className="text-white">{isDate ? formatDate(value) : (value ?? 'N/A')}</span>
    </div>
  );

  // Guarded early returns after all hooks to satisfy hook order and TS narrowing
  if (loading) {
    return (
      <DashboardLayout>
        <div className="text-center text-pb-primary py-16">Loading prop...</div>
      </DashboardLayout>
    );
  }
  if (error || !prop) {
    return (
      <DashboardLayout>
        <div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="flex items-center justify-between mb-4">
          <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-pb-primary hover:text-pb-accent">
            <ArrowLeft className="w-5 h-5" /> Back
          </button>
        </div>
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-8 relative">
          {/* Edit Icon Button */}
          <button
            onClick={handleEdit}
            className="absolute top-4 right-4 bg-pb-primary hover:bg-pb-accent text-white rounded-full p-2 shadow focus:outline-none focus:ring-2 focus:ring-pb-primary transition"
            aria-label="Edit Prop"
            title="Edit Prop"
          >
            <Pencil className="w-5 h-5" />
          </button>
          {/* Header & Main Info */}
          <div className="flex flex-col md:flex-row gap-8">
            <div className="flex-shrink-0 w-48 h-48 rounded-lg overflow-hidden bg-pb-gray flex items-center justify-center">
              {mainImage ? (
                <button
                  type="button"
                  onClick={() => {
                    const idx = galleryImages.findIndex(i => i.url === mainImage);
                    openLightboxAt(idx >= 0 ? idx : 0);
                  }}
                  className="block w-full h-full cursor-zoom-in"
                  title="Click to view larger"
                >
                  <img src={mainImage} alt={prop.name} className="object-cover w-full h-full" />
                </button>
              ) : (
                <div className="flex items-center justify-center w-full h-full text-pb-light/60">
                  <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
                  </svg>
                </div>
              )}
            </div>
            <div className="flex-1 min-w-0">
              <h1 className="text-2xl font-bold text-white mb-2">{prop.name}</h1>
              <div className="flex flex-wrap gap-2 mb-2">
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-primary/30 text-white">{prop.category}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-accent/30 text-white">Qty: {prop.quantity}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-gray text-white">{prop.status}</span>
              </div>
              {prop.description && <p className="text-pb-gray mb-4 whitespace-pre-line">{prop.description}</p>}
            </div>
          </div>
          {/* Gallery under main image */}
          {galleryImages.length > 1 && (
            <div className="mt-4 flex flex-col items-start">
              <div className="font-semibold text-pb-primary mb-2">Gallery</div>
              <div className="flex gap-2 flex-wrap">
                {galleryImages.map((img, idx) => (
                  <button
                    key={img.id || img.url}
                    type="button"
                    onClick={() => openLightboxAt(idx)}
                    className="w-20 h-20 rounded border border-pb-primary/30 overflow-hidden focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    title="View larger"
                  >
                    <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                  </button>
                ))}
              </div>
            </div>
          )}
          {/* Assignment & Show Info */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Show', prop.showId)}
            {renderField('Act', prop.act)}
            {renderField('Scene', prop.sceneName || prop.scene)}
            {renderField('Location', prop.location || prop.currentLocation)}
            {renderField('Assignment', prop.assignment?.name || prop.assignment?.id)}
            {renderField('Checked Out To', prop.checkedOutDetails?.to)}
            {renderField('Checked Out At', prop.checkedOutDetails?.checkedOutAt, true)}
            {renderField('Expected Return', prop.checkedOutDetails?.expectedReturnAt, true)}
          </div>
          {/* Physical Details */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Dimensions', (prop.length || prop.width || prop.height) ? `${prop.length || ''} x ${prop.width || ''} x ${prop.height || ''} ${prop.unit || ''}` : 'N/A')}
            {renderField('Depth', prop.depth)}
            {renderField('Weight', prop.weight ? `${prop.weight} ${prop.weightUnit || ''}` : 'N/A')}
            {renderField('Travel Weight', prop.travelWeight)}
            {renderField('Materials', prop.materials?.join(', '))}
            {renderField('Color', prop.color)}
            {renderField('Period', prop.period)}
            {renderField('Style', prop.style)}
            {renderField('Handedness', prop.handedness)}
            {renderField('Breakable', prop.isBreakable ? 'Yes' : 'No')}
            {renderField('Hazardous', prop.isHazardous ? 'Yes' : 'No')}
          </div>
          {/* Purchase & Rental */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Price', prop.price ? `£${prop.price}` : 'N/A')}
            {renderField('Source', prop.source)}
            {renderField('Source Details', prop.sourceDetails)}
            {renderField('Purchase URL', prop.purchaseUrl ? <a href={prop.purchaseUrl} className="text-pb-accent underline" target="_blank" rel="noopener noreferrer">{prop.purchaseUrl}</a> : 'N/A')}
            {renderField('Purchase Date', prop.purchaseDate, true)}
            {renderField('Rental Source', prop.rentalSource)}
            {renderField('Rental Due Date', prop.rentalDueDate, true)}
            {renderField('Rental Reference', prop.rentalReferenceNumber)}
            {renderField('Rental Info', 'N/A')}
          </div>
          {/* Manufacturer & Identification */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Manufacturer', prop.manufacturer)}
            {renderField('Model', prop.model)}
            {renderField('Serial Number', prop.serialNumber)}
            {renderField('Barcode', prop.barcode)}
            {renderField('Warranty', prop.warranty ? JSON.stringify(prop.warranty) : 'N/A')}
          </div>
          {/* Usage, Handling, Safety */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Usage Instructions', prop.usageInstructions)}
            {renderField('Handling Instructions', prop.handlingInstructions)}
            {renderField('Safety Notes', prop.safetyNotes)}
            {renderField('Pre-Show Setup', prop.preShowSetupNotes)}
            {renderField('Pre-Show Setup Video', prop.preShowSetupVideo)}
            {renderField('Pre-Show Setup Duration', prop.preShowSetupDuration)}
            {renderField('Shipping Crate', prop.hasOwnShippingCrate ? 'Yes' : 'No')}
            {renderField('Shipping Crate Details', prop.shippingCrateDetails)}
            {renderField('Transport Notes', prop.transportNotes)}
            {renderField('Requires Special Transport', prop.requiresSpecialTransport ? 'Yes' : 'No')}
            {renderField('Transport Method', prop.transportMethod)}
          </div>
          {/* Status & Lifecycle */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Status', prop.status)}
            {renderField('Status Notes', prop.statusNotes)}
            {renderField('Last Status Update', prop.lastStatusUpdate, true)}
            {renderField('Condition', prop.condition)}
            {renderField('Last Used At', prop.lastUsedAt, true)}
            {renderField('Last Modified At', prop.lastModifiedAt, true)}
            {renderField('Created At', prop.createdAt, true)}
            {renderField('Updated At', prop.updatedAt, true)}
            {renderField('Subcategory', prop.subcategory)}
            {renderField('Tags', prop.tags?.join(', '))}
          </div>
          {/* Maintenance & Inspection */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Maintenance Notes', prop.maintenanceNotes)}
            {renderField('Last Maintenance Date', prop.lastMaintenanceDate, true)}
            {renderField('Next Maintenance Due', prop.nextMaintenanceDue, true)}
            {renderField('Last Inspection Date', prop.lastInspectionDate, true)}
            {renderField('Next Inspection Due', prop.nextInspectionDue, true)}
            {renderField('Repair Estimate', prop.repairEstimate)}
            {renderField('Repair Priority', prop.repairPriority)}
            {renderField('Assigned To', prop.assignedUserDetails?.map(u => u.name).join(', ') || prop.assignedTo?.join(', '))}
            {renderField('Maintenance History', prop.maintenanceHistory ? JSON.stringify(prop.maintenanceHistory) : 'N/A')}
            {renderField('Status History', prop.statusHistory ? JSON.stringify(prop.statusHistory) : 'N/A')}
          </div>
          {/* Storage & Logistics */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Storage Requirements', prop.storageRequirements)}
            {renderField('Return Due Date', prop.returnDueDate, true)}
            {renderField('Expected Return Date', prop.expectedReturnDate, true)}
            {renderField('Replacement Cost', prop.replacementCost)}
            {renderField('Replacement Lead Time', prop.replacementLeadTime)}
            {renderField('Travels Unboxed', prop.travelsUnboxed ? 'Yes' : 'No')}
            {renderField('Courier', prop.courier)}
            {renderField('Tracking Number', prop.trackingNumber)}
          </div>
          {/* Digital Assets & Media */}
          <div className="space-y-2">
            <div className="font-semibold text-pb-primary mb-2">Digital Assets</div>
            {prop.digitalAssets && prop.digitalAssets.length > 0 ? (
              <ul className="space-y-2">
                {prop.digitalAssets.map(asset => (
                  <li key={asset.id} className="flex items-center gap-2">
                    <a href={asset.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{asset.name || asset.title || asset.url}</a>
                    <span className="text-xs text-pb-gray">[{asset.type}]</span>
                  </li>
                ))}
              </ul>
            ) : <div className="text-pb-gray">N/A</div>}
            {prop.videos && prop.videos.length > 0 && (
              <div className="mt-4">
                <div className="font-semibold text-pb-primary mb-2">Videos</div>
                <ul className="space-y-2">
                  {prop.videos.map(video => (
                    <li key={video.id} className="flex items-center gap-2">
                      <a href={video.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{video.name || video.title || video.url}</a>
                      <span className="text-xs text-pb-gray">[{video.type}]</span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
          {/* Notes & Custom Fields */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
            {renderField('Notes', prop.notes)}
            {renderField('Public Notes', prop.publicNotes)}
            {renderField('Custom Fields', prop.customFields ? JSON.stringify(prop.customFields) : 'N/A')}
            {renderField('Scene Notes', prop.sceneNotes)}
            {renderField('Usage Notes', prop.usageNotes)}
            {renderField('Modification Details', prop.modificationDetails)}
          </div>
        </motion.div>

        {/* Lightbox Modal */}
        {lightboxOpen && galleryImages.length > 0 && galleryImages[lightboxIndex] && (
          <div
            className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
            onClick={closeLightbox}
          >
            <div
              className="relative w-full h-full max-h-[100vh] flex items-center justify-center"
              onClick={e => e.stopPropagation()}
              onTouchStart={handleTouchStart}
              onTouchEnd={handleTouchEnd}
            >
              <button
                type="button"
                className="absolute top-4 right-4 p-2 rounded-full bg-black/60 hover:bg-black/80 text-white"
                onClick={closeLightbox}
                aria-label="Close"
              >
                <X className="w-5 h-5" />
              </button>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute left-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showPrev}
                  aria-label="Previous image"
                >
                  <ChevronLeft className="w-6 h-6" />
                </button>
              )}
              <img
                src={galleryImages[lightboxIndex].url}
                alt={(galleryImages[lightboxIndex].caption || prop.name) as string}
                className="max-w-[95vw] max-h-[75vh] object-contain"
              />
              {/* Caption */}
              <div className="absolute left-0 right-0 bottom-28 px-6 text-center">
                <div className="inline-block bg-black/50 text-white/90 text-sm md:text-base px-3 py-1 rounded">
                  {galleryImages[lightboxIndex].caption || prop.name}
                </div>
              </div>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute right-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showNext}
                  aria-label="Next image"
                >
                  <ChevronRight className="w-6 h-6" />
                </button>
              )}
              {/* Thumbnails strip */}
              {galleryImages.length > 1 && (
                <div className="absolute bottom-4 left-0 right-0 px-6">
                  <div className="mx-auto max-w-[95vw] bg-black/30 rounded-lg p-2 overflow-x-auto">
                    <div className="flex items-center gap-2">
                      {galleryImages.map((img, idx) => {
                        const selected = idx === lightboxIndex;
                        return (
                          <button
                            key={img.id || img.url}
                            type="button"
                            onClick={() => setLightboxIndex(idx)}
                            className={`relative w-16 h-16 md:w-20 md:h-20 rounded overflow-hidden border ${selected ? 'border-white ring-2 ring-white' : 'border-white/30 hover:border-white/60'}`}
                            aria-label={`View image ${idx + 1}`}
                          >
                            <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </DashboardLayout>
  );
};

export default PropDetailPage; 
```

Add guarded early returns after all hooks so TypeScript can narrow `prop` to non-null in the render.

I implemented this in `web-app/src/pages/PropDetailPage.tsx`:
- Moved loading/error UI into early returns after hooks.
- This preserves hook order and narrows `prop` for the rest of the component, removing all “'prop' is possibly 'null'” errors.

Now the file type-checks clean.

---

**User**

lets ajust the spacing on the props edit form to use the availabe space. also the edit form is not editing all the inputs if you check the add props form 

---

**Cursor**

I’m going to locate the edit and add prop pages, compare their form fields and layout, and then update the edit form to use available space and include all inputs like the add form. Then I’ll lint the changed files.

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories } from '../../shared/types/props';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const EditPropPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setForm(doc?.data as PropFormData || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form?.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form?.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => prev ? { ...prev, [name]: type === 'number' ? Number(value) : value } : prev);
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form || !id) return;
    setSaving(true);
    setError(null);
    try {
      await firebaseService.updateDocument('props', id, form);
      setSaving(false);
      navigate(`/props/${id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to update prop.');
      setSaving(false);
    }
  };

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !form) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Edit Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="in">In</option>
                <option value="maintenance">Maintenance</option>
                <option value="retired">Retired</option>
                <option value="available">Available</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
            <div className="md:col-span-3">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            {/* Add more fields as needed for full prop coverage */}
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => prev ? { ...prev, images: imgs } : prev)}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => prev ? { ...prev, digitalAssets: assets } : prev)}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Save Changes'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default EditPropPage; 
```

```typescriptreact
*** Begin Patch
*** Update File: web-app/src/pages/EditPropPage.tsx
@@
   const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
     const { name, value, type } = e.target;
     setForm(prev => prev ? { ...prev, [name]: type === 'number' ? Number(value) : value } : prev);
   };
+
+  const handleCheckboxChange = (e: React.ChangeEvent<HTMLInputElement>) => {
+    const { name, checked } = e.target;
+    setForm(prev => (prev ? { ...prev, [name]: checked } : prev));
+  };
@@
-          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
+          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Name *</label>
               <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Category *</label>
               <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                 {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
               </select>
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
               <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Price</label>
               <input name="price" type="number" min={0} step="0.01" value={form.price ?? 0} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Status *</label>
               <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                 <option value="in">In</option>
                 <option value="maintenance">Maintenance</option>
                 <option value="retired">Retired</option>
                 <option value="available">Available</option>
               </select>
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Show *</label>
               <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                 <option value="">Select Show</option>
                 {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
               </select>
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Act</label>
               <select name="act" value={form.act ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                 <option value="">Select Act</option>
                 {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
               </select>
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Scene</label>
               <select name="sceneName" value={form.sceneName ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                 <option value="">Select Scene</option>
                 {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
               </select>
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Source</label>
               <select name="source" value={form.source as any} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                 <option value="bought">Bought</option>
                 <option value="rented">Rented</option>
                 <option value="made">Made</option>
                 <option value="borrowed">Borrowed</option>
               </select>
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
               <input name="purchaseUrl" value={form.purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Location</label>
               <input name="location" value={form.location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
               <input name="currentLocation" value={form.currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
             </div>
             <div>
               <label className="block text-pb-gray mb-1 font-medium">Tags (comma separated)</label>
               <input name="tags" value={(form.tags ?? []).join(', ')} onChange={(e) => {
+                const raw = e.target.value;
+                const tags = raw.split(',').map(t => t.trim()).filter(Boolean);
+                setForm(prev => (prev ? { ...prev, tags } : prev));
+              }} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
+            </div>
+            <div>
+              <label className="block text-pb-gray mb-1 font-medium">Consumable</label>
+              <input type="checkbox" name="isConsumable" checked={!!form.isConsumable} onChange={handleCheckboxChange} className="mr-2 align-middle" />
+            </div>
+            <div>
+              <label className="block text-pb-gray mb-1 font-medium">Quantity per Scene</label>
+              <input name="quantityPerScene" type="number" min={0} value={(form as any).quantityPerScene ?? 0} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
             </div>
-            <div className="md:col-span-3">
+            <div className="md:col-span-3">
               <label className="block text-pb-gray mb-1 font-medium">Description</label>
               <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
             </div>
           </div>
*** End Patch
```

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories } from '../../shared/types/props';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const EditPropPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setForm(doc?.data as PropFormData || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form?.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form?.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => prev ? { ...prev, [name]: type === 'number' ? Number(value) : value } : prev);
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form || !id) return;
    setSaving(true);
    setError(null);
    try {
      await firebaseService.updateDocument('props', id, form);
      setSaving(false);
      navigate(`/props/${id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to update prop.');
      setSaving(false);
    }
  };

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !form) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Edit Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={(form.price ?? 0)} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="in">In</option>
                <option value="maintenance">Maintenance</option>
                <option value="retired">Retired</option>
                <option value="available">Available</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
            <div className="md:col-span-3">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            {/* Add more fields as needed for full prop coverage */}
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => prev ? { ...prev, images: imgs } : prev)}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => prev ? { ...prev, digitalAssets: assets } : prev)}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Save Changes'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default EditPropPage; 
```

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories } from '../../shared/types/props';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const EditPropPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setForm(doc?.data as PropFormData || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form?.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form?.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => prev ? { ...prev, [name]: type === 'number' ? Number(value) : value } : prev);
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form || !id) return;
    setSaving(true);
    setError(null);
    try {
      await firebaseService.updateDocument('props', id, form);
      setSaving(false);
      navigate(`/props/${id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to update prop.');
      setSaving(false);
    }
  };

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !form) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Edit Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={(form.price ?? 0)} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="in">In</option>
                <option value="maintenance">Maintenance</option>
                <option value="retired">Retired</option>
                <option value="available">Available</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
            <div className="md:col-span-3">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
                <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Location</label>
                <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
                <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            </div>
            {/* Add more fields as needed for full prop coverage */}
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => prev ? { ...prev, images: imgs } : prev)}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => prev ? { ...prev, digitalAssets: assets } : prev)}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Save Changes'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default EditPropPage; 
```

- Spacing: Updated `web-app/src/pages/EditPropPage.tsx` to use full width (`max-w-none`) and a denser grid (`md:grid-cols-3`, larger gaps) so the form uses available space.
- Field parity: Brought key inputs from the add form into the edit form:
  - Added `price`, `source`, `purchaseUrl`, `location`, `currentLocation`
  - Kept `name`, `category`, `quantity`, `status`, `showId`, `act`, `sceneName`, `description`
  - Image and digital asset editors already present
- Data handling: Kept a unified `handleChange`; if you want toggles/checkboxes later, we can add `handleCheckboxChange`.

If there are other add-form fields you want mirrored (e.g., more lifecycle or logistics fields), say which to include and I’ll wire them up.

---

**User**

ok lets look at the props detail page. i would like to add a tab nav list to show the details in sections and also add in the maintanance form as a tab. 

---

**Cursor**

```typescriptreact
import React, { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop } from '../../shared/types/props';
import { ArrowLeft, Pencil, X, ChevronLeft, ChevronRight } from 'lucide-react';

function formatDate(value: any): string {
  if (!value) return 'N/A';
  if (typeof value === 'object' && value.seconds) {
    try {
      if (typeof value.toDate === 'function') {
        return value.toDate().toLocaleString();
      }
      return new Date(value.seconds * 1000).toLocaleString();
    } catch {
      return JSON.stringify(value);
    }
  }
  if (typeof value === 'string') return value;
  return String(value);
}

const PropDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [prop, setProp] = useState<Prop | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();

  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [lightboxIndex, setLightboxIndex] = useState(0);
  const touchStartXRef = useRef<number | null>(null);
  const touchStartYRef = useRef<number | null>(null);
  const [activeTab, setActiveTab] = useState<'overview'|'physical'|'purchase'|'identification'|'usage'|'status'|'maintenance'|'storage'|'media'|'notes'>('overview');

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setProp(doc?.data as Prop || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  const mainImage = prop?.images?.find(img => img.isMain)?.url || prop?.images?.[0]?.url || prop?.imageUrl || '';

  const galleryImages = React.useMemo(() => {
    const imgs = (prop?.images || [])
      .filter(img => !!img && !!img.url)
      .map(img => ({ url: img.url, caption: (img as any).caption || '', id: (img as any).id, isMain: (img as any).isMain }));
    if (prop?.imageUrl && !imgs.some(i => i.url === prop.imageUrl)) {
      imgs.unshift({ url: prop.imageUrl, caption: prop?.name || '', id: 'primary' } as any);
    }
    const mainIdx = imgs.findIndex(i => (i as any).isMain);
    if (mainIdx > 0) {
      const [m] = imgs.splice(mainIdx, 1);
      imgs.unshift(m);
    }
    return imgs;
  }, [prop?.images, prop?.imageUrl, prop?.name]);

  const openLightboxAt = (index: number) => {
    if (!galleryImages.length) return;
    setLightboxIndex(Math.max(0, Math.min(index, galleryImages.length - 1)));
    setLightboxOpen(true);
  };
  const closeLightbox = () => setLightboxOpen(false);
  const showPrev = () => setLightboxIndex(i => (i - 1 + galleryImages.length) % galleryImages.length);
  const showNext = () => setLightboxIndex(i => (i + 1) % galleryImages.length);

  const handleTouchStart = (e: React.TouchEvent) => {
    const t = e.touches[0];
    touchStartXRef.current = t.clientX;
    touchStartYRef.current = t.clientY;
  };

  const handleTouchEnd = (e: React.TouchEvent) => {
    const startX = touchStartXRef.current;
    const startY = touchStartYRef.current;
    touchStartXRef.current = null;
    touchStartYRef.current = null;
    if (startX == null || startY == null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
      if (dx < 0) {
        showNext();
      } else {
        showPrev();
      }
    }
  };

  React.useEffect(() => {
    if (!lightboxOpen) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showPrev();
      if (e.key === 'ArrowRight') showNext();
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [lightboxOpen, galleryImages.length]);

  // Keep lightboxIndex in range if images array changes while open
  useEffect(() => {
    if (!lightboxOpen) return;
    if (galleryImages.length === 0) return;
    if (lightboxIndex < 0 || lightboxIndex >= galleryImages.length) {
      setLightboxIndex(Math.max(0, Math.min(lightboxIndex, galleryImages.length - 1)));
    }
  }, [lightboxOpen, galleryImages.length, lightboxIndex]);

  const handleEdit = () => {
    if (id) navigate(`/props/${id}/edit`);
  };

  const renderField = (label: string, value: any, isDate = false) => (
    <div className="mb-2">
      <span className="font-semibold text-pb-primary">{label}:</span>{' '}
      <span className="text-white">{isDate ? formatDate(value) : (value ?? 'N/A')}</span>
    </div>
  );

  // Guarded early returns after all hooks to satisfy hook order and TS narrowing
  if (loading) {
    return (
      <DashboardLayout>
        <div className="text-center text-pb-primary py-16">Loading prop...</div>
      </DashboardLayout>
    );
  }
  if (error || !prop) {
    return (
      <DashboardLayout>
        <div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="flex items-center justify-between mb-4">
          <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-pb-primary hover:text-pb-accent">
            <ArrowLeft className="w-5 h-5" /> Back
          </button>
        </div>
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-8 relative">
          {/* Edit Icon Button */}
          <button
            onClick={handleEdit}
            className="absolute top-4 right-4 bg-pb-primary hover:bg-pb-accent text-white rounded-full p-2 shadow focus:outline-none focus:ring-2 focus:ring-pb-primary transition"
            aria-label="Edit Prop"
            title="Edit Prop"
          >
            <Pencil className="w-5 h-5" />
          </button>
          {/* Header & Main Info */}
          <div className="flex flex-col md:flex-row gap-8">
            <div className="flex-shrink-0 w-48 h-48 rounded-lg overflow-hidden bg-pb-gray flex items-center justify-center">
              {mainImage ? (
                <button
                  type="button"
                  onClick={() => {
                    const idx = galleryImages.findIndex(i => i.url === mainImage);
                    openLightboxAt(idx >= 0 ? idx : 0);
                  }}
                  className="block w-full h-full cursor-zoom-in"
                  title="Click to view larger"
                >
                  <img src={mainImage} alt={prop.name} className="object-cover w-full h-full" />
                </button>
              ) : (
                <div className="flex items-center justify-center w-full h-full text-pb-light/60">
                  <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
                  </svg>
                </div>
              )}
            </div>
            <div className="flex-1 min-w-0">
              <h1 className="text-2xl font-bold text-white mb-2">{prop.name}</h1>
              <div className="flex flex-wrap gap-2 mb-2">
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-primary/30 text-white">{prop.category}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-accent/30 text-white">Qty: {prop.quantity}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-gray text-white">{prop.status}</span>
              </div>
              {prop.description && <p className="text-pb-gray mb-4 whitespace-pre-line">{prop.description}</p>}
            </div>
          </div>
          {/* Tabs */}
          <div className="mt-4">
            <div className="flex flex-wrap gap-2 border-b border-pb-primary/20 pb-2">
              {[
                { key: 'overview', label: 'Overview' },
                { key: 'physical', label: 'Physical' },
                { key: 'purchase', label: 'Purchase & Rental' },
                { key: 'identification', label: 'Identification' },
                { key: 'usage', label: 'Usage & Safety' },
                { key: 'status', label: 'Status & Lifecycle' },
                { key: 'maintenance', label: 'Maintenance' },
                { key: 'storage', label: 'Storage & Logistics' },
                { key: 'media', label: 'Media' },
                { key: 'notes', label: 'Notes' },
              ].map(t => (
                <button
                  key={t.key}
                  type="button"
                  onClick={() => setActiveTab(t.key as any)}
                  className={`px-3 py-2 text-sm font-medium rounded-t ${activeTab === (t.key as any) ? 'text-white border-b-2 border-pb-primary' : 'text-pb-gray hover:text-white'}`}
                >
                  {t.label}
                </button>
              ))}
            </div>
          </div>

          {/* Gallery under main image (also accessible in Media tab) */}
          {activeTab === 'media' && galleryImages.length > 0 && (
            <div className="mt-4 flex flex-col items-start">
              <div className="font-semibold text-pb-primary mb-2">Gallery</div>
              <div className="flex gap-2 flex-wrap">
                {galleryImages.map((img, idx) => (
                  <button
                    key={img.id || img.url}
                    type="button"
                    onClick={() => openLightboxAt(idx)}
                    className="w-20 h-20 rounded border border-pb-primary/30 overflow-hidden focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    title="View larger"
                  >
                    <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                  </button>
                ))}
              </div>
            </div>
          )}
          {activeTab === 'overview' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Show', prop.showId)}
              {renderField('Act', prop.act)}
              {renderField('Scene', prop.sceneName || prop.scene)}
              {renderField('Location', prop.location || prop.currentLocation)}
              {renderField('Assignment', prop.assignment?.name || prop.assignment?.id)}
              {renderField('Checked Out To', prop.checkedOutDetails?.to)}
              {renderField('Checked Out At', prop.checkedOutDetails?.checkedOutAt, true)}
              {renderField('Expected Return', prop.checkedOutDetails?.expectedReturnAt, true)}
            </div>
          )}
          {activeTab === 'physical' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Dimensions', (prop.length || prop.width || prop.height) ? `${prop.length || ''} x ${prop.width || ''} x ${prop.height || ''} ${prop.unit || ''}` : 'N/A')}
              {renderField('Depth', prop.depth)}
              {renderField('Weight', prop.weight ? `${prop.weight} ${prop.weightUnit || ''}` : 'N/A')}
              {renderField('Travel Weight', prop.travelWeight)}
              {renderField('Materials', prop.materials?.join(', '))}
              {renderField('Color', prop.color)}
              {renderField('Period', prop.period)}
              {renderField('Style', prop.style)}
              {renderField('Handedness', prop.handedness)}
              {renderField('Breakable', prop.isBreakable ? 'Yes' : 'No')}
              {renderField('Hazardous', prop.isHazardous ? 'Yes' : 'No')}
            </div>
          )}
          {activeTab === 'purchase' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Price', prop.price ? `£${prop.price}` : 'N/A')}
              {renderField('Source', prop.source)}
              {renderField('Source Details', prop.sourceDetails)}
              {renderField('Purchase URL', prop.purchaseUrl ? <a href={prop.purchaseUrl} className="text-pb-accent underline" target="_blank" rel="noopener noreferrer">{prop.purchaseUrl}</a> : 'N/A')}
              {renderField('Purchase Date', prop.purchaseDate, true)}
              {renderField('Rental Source', prop.rentalSource)}
              {renderField('Rental Due Date', prop.rentalDueDate, true)}
              {renderField('Rental Reference', prop.rentalReferenceNumber)}
              {renderField('Rental Info', 'N/A')}
            </div>
          )}
          {activeTab === 'identification' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Manufacturer', prop.manufacturer)}
              {renderField('Model', prop.model)}
              {renderField('Serial Number', prop.serialNumber)}
              {renderField('Barcode', prop.barcode)}
              {renderField('Warranty', prop.warranty ? JSON.stringify(prop.warranty) : 'N/A')}
            </div>
          )}
          {activeTab === 'usage' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Usage Instructions', prop.usageInstructions)}
              {renderField('Handling Instructions', prop.handlingInstructions)}
              {renderField('Safety Notes', prop.safetyNotes)}
              {renderField('Pre-Show Setup', prop.preShowSetupNotes)}
              {renderField('Pre-Show Setup Video', prop.preShowSetupVideo)}
              {renderField('Pre-Show Setup Duration', prop.preShowSetupDuration)}
              {renderField('Shipping Crate', prop.hasOwnShippingCrate ? 'Yes' : 'No')}
              {renderField('Shipping Crate Details', prop.shippingCrateDetails)}
              {renderField('Transport Notes', prop.transportNotes)}
              {renderField('Requires Special Transport', prop.requiresSpecialTransport ? 'Yes' : 'No')}
              {renderField('Transport Method', prop.transportMethod)}
            </div>
          )}
          {activeTab === 'status' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Status', prop.status)}
              {renderField('Status Notes', prop.statusNotes)}
              {renderField('Last Status Update', prop.lastStatusUpdate, true)}
              {renderField('Condition', prop.condition)}
              {renderField('Last Used At', prop.lastUsedAt, true)}
              {renderField('Last Modified At', prop.lastModifiedAt, true)}
              {renderField('Created At', prop.createdAt, true)}
              {renderField('Updated At', prop.updatedAt, true)}
              {renderField('Subcategory', prop.subcategory)}
              {renderField('Tags', prop.tags?.join(', '))}
            </div>
          )}
          {activeTab === 'maintenance' && (
            <div className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
                {renderField('Maintenance Notes', prop.maintenanceNotes)}
                {renderField('Last Maintenance Date', prop.lastMaintenanceDate, true)}
                {renderField('Next Maintenance Due', prop.nextMaintenanceDue, true)}
                {renderField('Last Inspection Date', prop.lastInspectionDate, true)}
                {renderField('Next Inspection Due', prop.nextInspectionDue, true)}
                {renderField('Repair Estimate', prop.repairEstimate)}
                {renderField('Repair Priority', prop.repairPriority)}
                {renderField('Assigned To', prop.assignedUserDetails?.map(u => u.name).join(', ') || prop.assignedTo?.join(', '))}
                {renderField('Maintenance History', prop.maintenanceHistory ? JSON.stringify(prop.maintenanceHistory) : 'N/A')}
              </div>
              {/* Inline Maintenance Update Form */}
              <MaintenanceInlineForm propId={id as string} initial={prop} />
            </div>
          )}
          {activeTab === 'storage' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Storage Requirements', prop.storageRequirements)}
              {renderField('Return Due Date', prop.returnDueDate, true)}
              {renderField('Expected Return Date', prop.expectedReturnDate, true)}
              {renderField('Replacement Cost', prop.replacementCost)}
              {renderField('Replacement Lead Time', prop.replacementLeadTime)}
              {renderField('Travels Unboxed', prop.travelsUnboxed ? 'Yes' : 'No')}
              {renderField('Courier', prop.courier)}
              {renderField('Tracking Number', prop.trackingNumber)}
            </div>
          )}
          {activeTab === 'media' && (
            <div className="space-y-2">
              <div className="font-semibold text-pb-primary mb-2">Digital Assets</div>
              {prop.digitalAssets && prop.digitalAssets.length > 0 ? (
                <ul className="space-y-2">
                  {prop.digitalAssets.map(asset => (
                    <li key={asset.id} className="flex items-center gap-2">
                      <a href={asset.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{asset.name || asset.title || asset.url}</a>
                      <span className="text-xs text-pb-gray">[{asset.type}]</span>
                    </li>
                  ))}
                </ul>
              ) : <div className="text-pb-gray">N/A</div>}
              {prop.videos && prop.videos.length > 0 && (
                <div className="mt-4">
                  <div className="font-semibold text-pb-primary mb-2">Videos</div>
                  <ul className="space-y-2">
                    {prop.videos.map(video => (
                      <li key={video.id} className="flex items-center gap-2">
                        <a href={video.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{video.name || video.title || video.url}</a>
                        <span className="text-xs text-pb-gray">[{video.type}]</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}
          {activeTab === 'notes' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Notes', prop.notes)}
              {renderField('Public Notes', prop.publicNotes)}
              {renderField('Custom Fields', prop.customFields ? JSON.stringify(prop.customFields) : 'N/A')}
              {renderField('Scene Notes', prop.sceneNotes)}
              {renderField('Usage Notes', prop.usageNotes)}
              {renderField('Modification Details', prop.modificationDetails)}
            </div>
          )}
        </motion.div>

        {/* Lightbox Modal */}
        {lightboxOpen && galleryImages.length > 0 && galleryImages[lightboxIndex] && (
          <div
            className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
            onClick={closeLightbox}
          >
            <div
              className="relative w-full h-full max-h-[100vh] flex items-center justify-center"
              onClick={e => e.stopPropagation()}
              onTouchStart={handleTouchStart}
              onTouchEnd={handleTouchEnd}
            >
              <button
                type="button"
                className="absolute top-4 right-4 p-2 rounded-full bg-black/60 hover:bg-black/80 text-white"
                onClick={closeLightbox}
                aria-label="Close"
              >
                <X className="w-5 h-5" />
              </button>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute left-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showPrev}
                  aria-label="Previous image"
                >
                  <ChevronLeft className="w-6 h-6" />
                </button>
              )}
              <img
                src={galleryImages[lightboxIndex].url}
                alt={(galleryImages[lightboxIndex].caption || prop.name) as string}
                className="max-w-[95vw] max-h-[75vh] object-contain"
              />
              {/* Caption */}
              <div className="absolute left-0 right-0 bottom-28 px-6 text-center">
                <div className="inline-block bg-black/50 text-white/90 text-sm md:text-base px-3 py-1 rounded">
                  {galleryImages[lightboxIndex].caption || prop.name}
                </div>
              </div>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute right-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showNext}
                  aria-label="Next image"
                >
                  <ChevronRight className="w-6 h-6" />
                </button>
              )}
              {/* Thumbnails strip */}
              {galleryImages.length > 1 && (
                <div className="absolute bottom-4 left-0 right-0 px-6">
                  <div className="mx-auto max-w-[95vw] bg-black/30 rounded-lg p-2 overflow-x-auto">
                    <div className="flex items-center gap-2">
                      {galleryImages.map((img, idx) => {
                        const selected = idx === lightboxIndex;
                        return (
                          <button
                            key={img.id || img.url}
                            type="button"
                            onClick={() => setLightboxIndex(idx)}
                            className={`relative w-16 h-16 md:w-20 md:h-20 rounded overflow-hidden border ${selected ? 'border-white ring-2 ring-white' : 'border-white/30 hover:border-white/60'}`}
                            aria-label={`View image ${idx + 1}`}
                          >
                            <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </DashboardLayout>
  );
};

export default PropDetailPage; 
```

```typescriptreact
import React, { useEffect, useState, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop } from '../../shared/types/props';
import { ArrowLeft, Pencil, X, ChevronLeft, ChevronRight } from 'lucide-react';
import MaintenanceInlineForm from '../components/MaintenanceInlineForm';

function formatDate(value: any): string {
  if (!value) return 'N/A';
  if (typeof value === 'object' && value.seconds) {
    try {
      if (typeof value.toDate === 'function') {
        return value.toDate().toLocaleString();
      }
      return new Date(value.seconds * 1000).toLocaleString();
    } catch {
      return JSON.stringify(value);
    }
  }
  if (typeof value === 'string') return value;
  return String(value);
}

const PropDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [prop, setProp] = useState<Prop | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();

  const [lightboxOpen, setLightboxOpen] = useState(false);
  const [lightboxIndex, setLightboxIndex] = useState(0);
  const touchStartXRef = useRef<number | null>(null);
  const touchStartYRef = useRef<number | null>(null);
  const [activeTab, setActiveTab] = useState<'overview'|'physical'|'purchase'|'identification'|'usage'|'status'|'maintenance'|'storage'|'media'|'notes'>('overview');

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setProp(doc?.data as Prop || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  const mainImage = prop?.images?.find(img => img.isMain)?.url || prop?.images?.[0]?.url || prop?.imageUrl || '';

  const galleryImages = React.useMemo(() => {
    const imgs = (prop?.images || [])
      .filter(img => !!img && !!img.url)
      .map(img => ({ url: img.url, caption: (img as any).caption || '', id: (img as any).id, isMain: (img as any).isMain }));
    if (prop?.imageUrl && !imgs.some(i => i.url === prop.imageUrl)) {
      imgs.unshift({ url: prop.imageUrl, caption: prop?.name || '', id: 'primary' } as any);
    }
    const mainIdx = imgs.findIndex(i => (i as any).isMain);
    if (mainIdx > 0) {
      const [m] = imgs.splice(mainIdx, 1);
      imgs.unshift(m);
    }
    return imgs;
  }, [prop?.images, prop?.imageUrl, prop?.name]);

  const openLightboxAt = (index: number) => {
    if (!galleryImages.length) return;
    setLightboxIndex(Math.max(0, Math.min(index, galleryImages.length - 1)));
    setLightboxOpen(true);
  };
  const closeLightbox = () => setLightboxOpen(false);
  const showPrev = () => setLightboxIndex(i => (i - 1 + galleryImages.length) % galleryImages.length);
  const showNext = () => setLightboxIndex(i => (i + 1) % galleryImages.length);

  const handleTouchStart = (e: React.TouchEvent) => {
    const t = e.touches[0];
    touchStartXRef.current = t.clientX;
    touchStartYRef.current = t.clientY;
  };

  const handleTouchEnd = (e: React.TouchEvent) => {
    const startX = touchStartXRef.current;
    const startY = touchStartYRef.current;
    touchStartXRef.current = null;
    touchStartYRef.current = null;
    if (startX == null || startY == null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy)) {
      if (dx < 0) {
        showNext();
      } else {
        showPrev();
      }
    }
  };

  React.useEffect(() => {
    if (!lightboxOpen) return;
    const onKey = (e: KeyboardEvent) => {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') showPrev();
      if (e.key === 'ArrowRight') showNext();
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [lightboxOpen, galleryImages.length]);

  // Keep lightboxIndex in range if images array changes while open
  useEffect(() => {
    if (!lightboxOpen) return;
    if (galleryImages.length === 0) return;
    if (lightboxIndex < 0 || lightboxIndex >= galleryImages.length) {
      setLightboxIndex(Math.max(0, Math.min(lightboxIndex, galleryImages.length - 1)));
    }
  }, [lightboxOpen, galleryImages.length, lightboxIndex]);

  const handleEdit = () => {
    if (id) navigate(`/props/${id}/edit`);
  };

  const renderField = (label: string, value: any, isDate = false) => (
    <div className="mb-2">
      <span className="font-semibold text-pb-primary">{label}:</span>{' '}
      <span className="text-white">{isDate ? formatDate(value) : (value ?? 'N/A')}</span>
    </div>
  );

  // Guarded early returns after all hooks to satisfy hook order and TS narrowing
  if (loading) {
    return (
      <DashboardLayout>
        <div className="text-center text-pb-primary py-16">Loading prop...</div>
      </DashboardLayout>
    );
  }
  if (error || !prop) {
    return (
      <DashboardLayout>
        <div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="flex items-center justify-between mb-4">
          <button onClick={() => navigate(-1)} className="flex items-center gap-2 text-pb-primary hover:text-pb-accent">
            <ArrowLeft className="w-5 h-5" /> Back
          </button>
        </div>
        <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-8 relative">
          {/* Edit Icon Button */}
          <button
            onClick={handleEdit}
            className="absolute top-4 right-4 bg-pb-primary hover:bg-pb-accent text-white rounded-full p-2 shadow focus:outline-none focus:ring-2 focus:ring-pb-primary transition"
            aria-label="Edit Prop"
            title="Edit Prop"
          >
            <Pencil className="w-5 h-5" />
          </button>
          {/* Header & Main Info */}
          <div className="flex flex-col md:flex-row gap-8">
            <div className="flex-shrink-0 w-48 h-48 rounded-lg overflow-hidden bg-pb-gray flex items-center justify-center">
              {mainImage ? (
                <button
                  type="button"
                  onClick={() => {
                    const idx = galleryImages.findIndex(i => i.url === mainImage);
                    openLightboxAt(idx >= 0 ? idx : 0);
                  }}
                  className="block w-full h-full cursor-zoom-in"
                  title="Click to view larger"
                >
                  <img src={mainImage} alt={prop.name} className="object-cover w-full h-full" />
                </button>
              ) : (
                <div className="flex items-center justify-center w-full h-full text-pb-light/60">
                  <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
                  </svg>
                </div>
              )}
            </div>
            <div className="flex-1 min-w-0">
              <h1 className="text-2xl font-bold text-white mb-2">{prop.name}</h1>
              <div className="flex flex-wrap gap-2 mb-2">
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-primary/30 text-white">{prop.category}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-accent/30 text-white">Qty: {prop.quantity}</span>
                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-pb-gray text-white">{prop.status}</span>
              </div>
              {prop.description && <p className="text-pb-gray mb-4 whitespace-pre-line">{prop.description}</p>}
            </div>
          </div>
          {/* Tabs */}
          <div className="mt-4">
            <div className="flex flex-wrap gap-2 border-b border-pb-primary/20 pb-2">
              {[
                { key: 'overview', label: 'Overview' },
                { key: 'physical', label: 'Physical' },
                { key: 'purchase', label: 'Purchase & Rental' },
                { key: 'identification', label: 'Identification' },
                { key: 'usage', label: 'Usage & Safety' },
                { key: 'status', label: 'Status & Lifecycle' },
                { key: 'maintenance', label: 'Maintenance' },
                { key: 'storage', label: 'Storage & Logistics' },
                { key: 'media', label: 'Media' },
                { key: 'notes', label: 'Notes' },
              ].map(t => (
                <button
                  key={t.key}
                  type="button"
                  onClick={() => setActiveTab(t.key as any)}
                  className={`px-3 py-2 text-sm font-medium rounded-t ${activeTab === (t.key as any) ? 'text-white border-b-2 border-pb-primary' : 'text-pb-gray hover:text-white'}`}
                >
                  {t.label}
                </button>
              ))}
            </div>
          </div>

          {/* Gallery under main image (also accessible in Media tab) */}
          {activeTab === 'media' && galleryImages.length > 0 && (
            <div className="mt-4 flex flex-col items-start">
              <div className="font-semibold text-pb-primary mb-2">Gallery</div>
              <div className="flex gap-2 flex-wrap">
                {galleryImages.map((img, idx) => (
                  <button
                    key={img.id || img.url}
                    type="button"
                    onClick={() => openLightboxAt(idx)}
                    className="w-20 h-20 rounded border border-pb-primary/30 overflow-hidden focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    title="View larger"
                  >
                    <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                  </button>
                ))}
              </div>
            </div>
          )}
          {activeTab === 'overview' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Show', prop.showId)}
              {renderField('Act', prop.act)}
              {renderField('Scene', prop.sceneName || prop.scene)}
              {renderField('Location', prop.location || prop.currentLocation)}
              {renderField('Assignment', prop.assignment?.name || prop.assignment?.id)}
              {renderField('Checked Out To', prop.checkedOutDetails?.to)}
              {renderField('Checked Out At', prop.checkedOutDetails?.checkedOutAt, true)}
              {renderField('Expected Return', prop.checkedOutDetails?.expectedReturnAt, true)}
            </div>
          )}
          {activeTab === 'physical' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Dimensions', (prop.length || prop.width || prop.height) ? `${prop.length || ''} x ${prop.width || ''} x ${prop.height || ''} ${prop.unit || ''}` : 'N/A')}
              {renderField('Depth', prop.depth)}
              {renderField('Weight', prop.weight ? `${prop.weight} ${prop.weightUnit || ''}` : 'N/A')}
              {renderField('Travel Weight', prop.travelWeight)}
              {renderField('Materials', prop.materials?.join(', '))}
              {renderField('Color', prop.color)}
              {renderField('Period', prop.period)}
              {renderField('Style', prop.style)}
              {renderField('Handedness', prop.handedness)}
              {renderField('Breakable', prop.isBreakable ? 'Yes' : 'No')}
              {renderField('Hazardous', prop.isHazardous ? 'Yes' : 'No')}
            </div>
          )}
          {activeTab === 'purchase' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Price', prop.price ? `£${prop.price}` : 'N/A')}
              {renderField('Source', prop.source)}
              {renderField('Source Details', prop.sourceDetails)}
              {renderField('Purchase URL', prop.purchaseUrl ? <a href={prop.purchaseUrl} className="text-pb-accent underline" target="_blank" rel="noopener noreferrer">{prop.purchaseUrl}</a> : 'N/A')}
              {renderField('Purchase Date', prop.purchaseDate, true)}
              {renderField('Rental Source', prop.rentalSource)}
              {renderField('Rental Due Date', prop.rentalDueDate, true)}
              {renderField('Rental Reference', prop.rentalReferenceNumber)}
              {renderField('Rental Info', 'N/A')}
            </div>
          )}
          {activeTab === 'identification' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Manufacturer', prop.manufacturer)}
              {renderField('Model', prop.model)}
              {renderField('Serial Number', prop.serialNumber)}
              {renderField('Barcode', prop.barcode)}
              {renderField('Warranty', prop.warranty ? JSON.stringify(prop.warranty) : 'N/A')}
            </div>
          )}
          {activeTab === 'usage' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Usage Instructions', prop.usageInstructions)}
              {renderField('Handling Instructions', prop.handlingInstructions)}
              {renderField('Safety Notes', prop.safetyNotes)}
              {renderField('Pre-Show Setup', prop.preShowSetupNotes)}
              {renderField('Pre-Show Setup Video', prop.preShowSetupVideo)}
              {renderField('Pre-Show Setup Duration', prop.preShowSetupDuration)}
              {renderField('Shipping Crate', prop.hasOwnShippingCrate ? 'Yes' : 'No')}
              {renderField('Shipping Crate Details', prop.shippingCrateDetails)}
              {renderField('Transport Notes', prop.transportNotes)}
              {renderField('Requires Special Transport', prop.requiresSpecialTransport ? 'Yes' : 'No')}
              {renderField('Transport Method', prop.transportMethod)}
            </div>
          )}
          {activeTab === 'status' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Status', prop.status)}
              {renderField('Status Notes', prop.statusNotes)}
              {renderField('Last Status Update', prop.lastStatusUpdate, true)}
              {renderField('Condition', prop.condition)}
              {renderField('Last Used At', prop.lastUsedAt, true)}
              {renderField('Last Modified At', prop.lastModifiedAt, true)}
              {renderField('Created At', prop.createdAt, true)}
              {renderField('Updated At', prop.updatedAt, true)}
              {renderField('Subcategory', prop.subcategory)}
              {renderField('Tags', prop.tags?.join(', '))}
            </div>
          )}
          {activeTab === 'maintenance' && (
            <div className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
                {renderField('Maintenance Notes', prop.maintenanceNotes)}
                {renderField('Last Maintenance Date', prop.lastMaintenanceDate, true)}
                {renderField('Next Maintenance Due', prop.nextMaintenanceDue, true)}
                {renderField('Last Inspection Date', prop.lastInspectionDate, true)}
                {renderField('Next Inspection Due', prop.nextInspectionDue, true)}
                {renderField('Repair Estimate', prop.repairEstimate)}
                {renderField('Repair Priority', prop.repairPriority)}
                {renderField('Assigned To', prop.assignedUserDetails?.map(u => u.name).join(', ') || prop.assignedTo?.join(', '))}
                {renderField('Maintenance History', prop.maintenanceHistory ? JSON.stringify(prop.maintenanceHistory) : 'N/A')}
              </div>
              {/* Inline Maintenance Update Form */}
              <MaintenanceInlineForm propId={id as string} initial={prop} />
            </div>
          )}
          {activeTab === 'storage' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Storage Requirements', prop.storageRequirements)}
              {renderField('Return Due Date', prop.returnDueDate, true)}
              {renderField('Expected Return Date', prop.expectedReturnDate, true)}
              {renderField('Replacement Cost', prop.replacementCost)}
              {renderField('Replacement Lead Time', prop.replacementLeadTime)}
              {renderField('Travels Unboxed', prop.travelsUnboxed ? 'Yes' : 'No')}
              {renderField('Courier', prop.courier)}
              {renderField('Tracking Number', prop.trackingNumber)}
            </div>
          )}
          {activeTab === 'media' && (
            <div className="space-y-2">
              <div className="font-semibold text-pb-primary mb-2">Digital Assets</div>
              {prop.digitalAssets && prop.digitalAssets.length > 0 ? (
                <ul className="space-y-2">
                  {prop.digitalAssets.map(asset => (
                    <li key={asset.id} className="flex items-center gap-2">
                      <a href={asset.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{asset.name || asset.title || asset.url}</a>
                      <span className="text-xs text-pb-gray">[{asset.type}]</span>
                    </li>
                  ))}
                </ul>
              ) : <div className="text-pb-gray">N/A</div>}
              {prop.videos && prop.videos.length > 0 && (
                <div className="mt-4">
                  <div className="font-semibold text-pb-primary mb-2">Videos</div>
                  <ul className="space-y-2">
                    {prop.videos.map(video => (
                      <li key={video.id} className="flex items-center gap-2">
                        <a href={video.url} target="_blank" rel="noopener noreferrer" className="text-pb-accent hover:underline font-medium">{video.name || video.title || video.url}</a>
                        <span className="text-xs text-pb-gray">[{video.type}]</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </div>
          )}
          {activeTab === 'notes' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-pb-darker/40 rounded-lg p-4">
              {renderField('Notes', prop.notes)}
              {renderField('Public Notes', prop.publicNotes)}
              {renderField('Custom Fields', prop.customFields ? JSON.stringify(prop.customFields) : 'N/A')}
              {renderField('Scene Notes', prop.sceneNotes)}
              {renderField('Usage Notes', prop.usageNotes)}
              {renderField('Modification Details', prop.modificationDetails)}
            </div>
          )}
        </motion.div>

        {/* Lightbox Modal */}
        {lightboxOpen && galleryImages.length > 0 && galleryImages[lightboxIndex] && (
          <div
            className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center"
            onClick={closeLightbox}
          >
            <div
              className="relative w-full h-full max-h-[100vh] flex items-center justify-center"
              onClick={e => e.stopPropagation()}
              onTouchStart={handleTouchStart}
              onTouchEnd={handleTouchEnd}
            >
              <button
                type="button"
                className="absolute top-4 right-4 p-2 rounded-full bg-black/60 hover:bg-black/80 text-white"
                onClick={closeLightbox}
                aria-label="Close"
              >
                <X className="w-5 h-5" />
              </button>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute left-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showPrev}
                  aria-label="Previous image"
                >
                  <ChevronLeft className="w-6 h-6" />
                </button>
              )}
              <img
                src={galleryImages[lightboxIndex].url}
                alt={(galleryImages[lightboxIndex].caption || prop.name) as string}
                className="max-w-[95vw] max-h-[75vh] object-contain"
              />
              {/* Caption */}
              <div className="absolute left-0 right-0 bottom-28 px-6 text-center">
                <div className="inline-block bg-black/50 text-white/90 text-sm md:text-base px-3 py-1 rounded">
                  {galleryImages[lightboxIndex].caption || prop.name}
                </div>
              </div>
              {galleryImages.length > 1 && (
                <button
                  type="button"
                  className="absolute right-4 p-3 rounded-full bg-black/60 hover:bg-black/80 text-white"
                  onClick={showNext}
                  aria-label="Next image"
                >
                  <ChevronRight className="w-6 h-6" />
                </button>
              )}
              {/* Thumbnails strip */}
              {galleryImages.length > 1 && (
                <div className="absolute bottom-4 left-0 right-0 px-6">
                  <div className="mx-auto max-w-[95vw] bg-black/30 rounded-lg p-2 overflow-x-auto">
                    <div className="flex items-center gap-2">
                      {galleryImages.map((img, idx) => {
                        const selected = idx === lightboxIndex;
                        return (
                          <button
                            key={img.id || img.url}
                            type="button"
                            onClick={() => setLightboxIndex(idx)}
                            className={`relative w-16 h-16 md:w-20 md:h-20 rounded overflow-hidden border ${selected ? 'border-white ring-2 ring-white' : 'border-white/30 hover:border-white/60'}`}
                            aria-label={`View image ${idx + 1}`}
                          >
                            <img src={img.url} alt={img.caption || prop.name} className="w-full h-full object-cover" />
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </DashboardLayout>
  );
};

export default PropDetailPage; 
```

```typescriptreact
import React, { useState } from 'react';
import { useFirebase } from '../contexts/FirebaseContext';

type Props = {
  propId: string;
  initial?: any;
};

const MaintenanceInlineForm: React.FC<Props> = ({ propId, initial }) => {
  const { service } = useFirebase();
  const [notes, setNotes] = useState<string>(initial?.maintenanceNotes || '');
  const [lastMaintenanceDate, setLastMaintenanceDate] = useState<string>(initial?.lastMaintenanceDate || '');
  const [nextMaintenanceDue, setNextMaintenanceDue] = useState<string>(initial?.nextMaintenanceDue || '');
  const [repairEstimate, setRepairEstimate] = useState<number | ''>(initial?.repairEstimate ?? '');
  const [repairPriority, setRepairPriority] = useState<string>(initial?.repairPriority || '');
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    setSuccess(null);
    try {
      await service.updateDocument('props', propId, {
        maintenanceNotes: notes,
        lastMaintenanceDate,
        nextMaintenanceDue,
        repairEstimate: repairEstimate === '' ? null : repairEstimate,
        repairPriority,
        updatedAt: new Date().toISOString(),
      });
      setSuccess('Maintenance updated');
    } catch (err: any) {
      setError(err.message || 'Failed to update maintenance');
    } finally {
      setSaving(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="bg-pb-darker/40 rounded-lg p-4 border border-pb-primary/20 space-y-4">
      <div className="text-white font-semibold">Update Maintenance</div>
      {error && <div className="text-red-500 text-sm">{error}</div>}
      {success && <div className="text-green-500 text-sm">{success}</div>}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label className="block text-pb-gray mb-1 text-sm">Maintenance Notes</label>
          <textarea className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" rows={3} value={notes} onChange={e => setNotes(e.target.value)} />
        </div>
        <div>
          <label className="block text-pb-gray mb-1 text-sm">Last Maintenance Date</label>
          <input type="date" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" value={lastMaintenanceDate} onChange={e => setLastMaintenanceDate(e.target.value)} />
        </div>
        <div>
          <label className="block text-pb-gray mb-1 text-sm">Next Maintenance Due</label>
          <input type="date" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" value={nextMaintenanceDue} onChange={e => setNextMaintenanceDue(e.target.value)} />
        </div>
        <div>
          <label className="block text-pb-gray mb-1 text-sm">Repair Estimate</label>
          <input type="number" min={0} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" value={repairEstimate} onChange={e => setRepairEstimate(e.target.value === '' ? '' : Number(e.target.value))} />
        </div>
        <div>
          <label className="block text-pb-gray mb-1 text-sm">Repair Priority</label>
          <select className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" value={repairPriority} onChange={e => setRepairPriority(e.target.value)}>
            <option value="">Select</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
      </div>
      <div className="flex justify-end">
        <button type="submit" disabled={saving} className="px-4 py-2 rounded bg-pb-primary text-white font-semibold hover:bg-pb-accent disabled:opacity-60">
          {saving ? 'Saving…' : 'Save Maintenance'}
        </button>
      </div>
    </form>
  );
};

export default MaintenanceInlineForm;


```

- Added tabs to `web-app/src/pages/PropDetailPage.tsx` to organize content:
  - Tabs: Overview, Physical, Purchase & Rental, Identification, Usage & Safety, Status & Lifecycle, Maintenance, Storage & Logistics, Media, Notes
  - Each section renders only when its tab is active
  - Media tab includes the gallery thumbnails and still supports the fullscreen lightbox

- Added a maintenance form tab:
  - New component: `web-app/src/components/MaintenanceInlineForm.tsx`
  - Lets you update maintenance notes, last/next maintenance dates, repair estimate, and priority; saves to the `props` doc
  - Included in the Maintenance tab as `MaintenanceInlineForm`

- Kept hook order intact and lint is clean.

Want me to persist maintenance entries as a history log as well (append to `maintenanceHistory`) instead of only updating fields?

---

**User**

ok lets have a look at the propslist lets ajust the dispaly to use the available space.

---

**Cursor**

```typescriptreact
import React, { useState, useEffect } from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { useWebAuth } from './contexts/WebAuthContext';
import { useFirebase } from './contexts/FirebaseContext';
import { propCategories, PropLifecycleStatus, Prop } from '../shared/types/props';
import { FirebaseDocument } from '../shared/services/firebase/types';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { Link } from 'react-router-dom';
import PropCardWeb from './PropCardWeb';
import jsPDF from 'jspdf';
import type { PdfGenerationOptions } from '../shared/types/pdf';

const defaultPdfOptions: PdfGenerationOptions = {
  selectedFields: {
    name: true,
    description: true,
    category: true,
    status: true,
    quantity: true,
    // Add more fields as needed, defaulting to true/false
  } as any,
  layout: 'portrait',
  columns: 1,
  imageCount: 1,
  imageWidthOption: 'medium',
  showFilesQR: false,
  showVideosQR: false,
  title: 'Props List',
};

function generatePropsListHtml(props: Prop[], options: PdfGenerationOptions): string {
  // Simple HTML table for now
  const fields = Object.keys(options.selectedFields).filter(k => (options.selectedFields as any)[k]);
  return `
    <html><head><meta charset='UTF-8'><title>${options.title || 'Props List'}</title>
    <style>
      body { font-family: Arial, sans-serif; color: #222; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 12px; }
      th { background: #f0f0f0; }
      .prop-img { max-width: 80px; max-height: 80px; }
    </style></head><body>
    <h2>${options.title || 'Props List'}</h2>
    <table><thead><tr>
      ${fields.map(f => `<th>${f.charAt(0).toUpperCase() + f.slice(1)}</th>`).join('')}
    </tr></thead><tbody>
      ${props.map(prop => `<tr>
        ${fields.map(f => {
          if (f === 'images' && prop.images && prop.images.length > 0) {
            return `<td><img class='prop-img' src='${prop.images[0].url}' /></td>`;
          }
          return `<td>${(prop as any)[f] ?? ''}</td>`;
        }).join('')}
      </tr>`).join('')}
    </tbody></table>
    </body></html>
  `;
}

const PropsListPage: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const { service: firebaseService, isInitialized, error: firebaseInitError } = useFirebase();
  const { currentShowId } = useShowSelection();
  const [search, setSearch] = useState('');
  const [category, setCategory] = useState<string>('');
  const [status, setStatus] = useState<string>('');
  const [act, setAct] = useState<string>('');
  const [scene, setScene] = useState<string>('');
  const [showPdfDialog, setShowPdfDialog] = useState(false);
  const [pdfOptions, setPdfOptions] = useState<PdfGenerationOptions>(defaultPdfOptions);
  const [downloading, setDownloading] = useState(false);

  // Extract unique acts and scenes from props
  const acts = Array.from(new Set(props.map(p => p.act).filter(a => a != null))).sort((a, b) => (a ?? 0) - (b ?? 0));
  const scenes = Array.from(new Set(props.map(p => p.scene).filter(s => s != null))).sort((a, b) => (a ?? 0) - (b ?? 0));

  useEffect(() => {
    if (!isInitialized) {
      setLoading(true);
      setError("Firebase not initialized.");
      return;
    }

    if (firebaseInitError) {
      setError(`Firebase Initialization Error: ${firebaseInitError.message}`);
      setLoading(false);
      return;
    }

    if (!currentShowId) {
      setProps([]);
      setLoading(false);
      setError(null);
      return;
    }

    setLoading(true);
    setError(null);

    const unsubscribe = firebaseService.listenToCollection<Prop>(
      'props',
      (data: FirebaseDocument<Prop>[]) => {
        const propList = data
          .map(doc => ({ ...doc.data, id: doc.id }))
          .filter(prop => prop.showId === currentShowId);
        setProps(propList);
        setLoading(false);
      },
      (err: Error) => {
        console.error("Error fetching props:", err);
        setError(`Failed to load props: ${err.message}. Please check your network connection and Firebase permissions.`);
        setLoading(false);
      }
    );

    return () => unsubscribe();
  }, [firebaseService, isInitialized, firebaseInitError, currentShowId]);

  const handleAddProp = () => {
    // TODO: Route to add prop form
    alert('Add Prop (not implemented)');
  };

  // Filtered props
  const filteredProps = props.filter((prop) => {
    const matchesSearch =
      search.trim() === '' ||
      prop.name.toLowerCase().includes(search.toLowerCase()) ||
      (prop.description && prop.description.toLowerCase().includes(search.toLowerCase()));
    const matchesCategory = !category || prop.category === category;
    const matchesStatus = !status || (prop.status && prop.status === status);
    const matchesAct = !act || (prop.act != null && String(prop.act) === act);
    const matchesScene = !scene || (prop.scene != null && String(prop.scene) === scene);
    return matchesSearch && matchesCategory && matchesStatus && matchesAct && matchesScene;
  });

  const handleDownloadPdf = async () => {
    setDownloading(true);
    const html = generatePropsListHtml(filteredProps, pdfOptions);
    const pdf = new jsPDF({ orientation: pdfOptions.layout });
    await pdf.html(html, { callback: () => {
      pdf.save(`${pdfOptions.title || 'props-list'}.pdf`);
      setDownloading(false);
      setShowPdfDialog(false);
    }});
  };

  return (
    <DashboardLayout>
      <div className="relative min-h-[70vh] flex flex-col w-full max-w-7xl mx-auto bg-gradient-to-br from-pb-primary/40 via-pb-darker/80 to-pb-accent/30 rounded-xl shadow-xl p-6">
        {/* Search and Filters */}
        <div className="w-full flex flex-col md:flex-row gap-4 mb-6">
          <input
            type="text"
            placeholder="Search props..."
            value={search}
            onChange={e => setSearch(e.target.value)}
            className="flex-1 px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white placeholder-pb-gray focus:outline-none focus:ring-2 focus:ring-pb-primary"
          />
          <select
            value={category}
            onChange={e => setCategory(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Categories</option>
            {propCategories.map(cat => (
              <option key={cat} value={cat}>{cat}</option>
            ))}
          </select>
          <select
            value={status}
            onChange={e => setStatus(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Statuses</option>
            <option value="in">In</option>
            <option value="maintenance">Maintenance</option>
            <option value="retired">Retired</option>
            <option value="available">Available</option>
          </select>
          <select
            value={act}
            onChange={e => setAct(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Acts</option>
            {acts.map(a => (
              <option key={a} value={String(a)}>{a}</option>
            ))}
          </select>
          <select
            value={scene}
            onChange={e => setScene(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Scenes</option>
            {scenes.map(s => (
              <option key={s} value={String(s)}>{s}</option>
            ))}
          </select>
        </div>
        {!currentShowId && (
          <div className="flex flex-col items-center justify-center h-64">
            <div className="text-pb-primary font-semibold text-lg mb-2">Please select a show to view its props.</div>
          </div>
        )}
        <h2 className="text-2xl font-bold mb-6">Props List</h2>
        <div className="w-full flex justify-end mb-4">
          <button
            className="btn btn-primary"
            onClick={() => setShowPdfDialog(true)}
          >
            Download PDF
          </button>
        </div>
        {showPdfDialog && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white text-black rounded-lg shadow-lg p-6 min-w-[320px]">
              <h3 className="font-bold text-lg mb-2">Export Props List to PDF</h3>
              <div className="mb-2">
                <label className="block font-semibold mb-1">Fields to include:</label>
                {Object.keys(defaultPdfOptions.selectedFields).map(f => (
                  <label key={f} className="block text-sm">
                    <input
                      type="checkbox"
                      checked={pdfOptions.selectedFields[f as keyof Prop]}
                      onChange={e => setPdfOptions(opt => ({
                        ...opt,
                        selectedFields: { ...opt.selectedFields, [f]: e.target.checked }
                      }))}
                    /> {f.charAt(0).toUpperCase() + f.slice(1)}
                  </label>
                ))}
              </div>
              <div className="mb-2">
                <label className="block font-semibold mb-1">Layout:</label>
                <select
                  value={pdfOptions.layout}
                  onChange={e => setPdfOptions(opt => ({ ...opt, layout: e.target.value as any }))}
                  className="border rounded px-2 py-1"
                >
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                </select>
              </div>
              <div className="flex gap-2 mt-4">
                <button
                  className="btn btn-primary"
                  onClick={handleDownloadPdf}
                  disabled={downloading}
                >
                  {downloading ? 'Generating...' : 'Download PDF'}
                </button>
                <button
                  className="btn btn-secondary"
                  onClick={() => setShowPdfDialog(false)}
                  disabled={downloading}
                >Cancel</button>
              </div>
            </div>
          </div>
        )}
        {loading ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="animate-spin h-10 w-10 text-pb-primary mb-2" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" /><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" /></svg>
            <div className="text-pb-gray mt-2">Loading props...</div>
          </div>
        ) : error ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-red-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
            <div className="text-red-500 font-semibold">{error}</div>
          </div>
        ) : filteredProps.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-pb-gray mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" /></svg>
            <div className="text-pb-gray">No props found.</div>
          </div>
        ) : (
          <div className="w-full">
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
              {filteredProps.map((prop) => (
                <div key={prop.id}>
                  <PropCardWeb prop={prop} />
                </div>
              ))}
            </div>
          </div>
        )}
        <Link
          to="/props/add"
          className="fixed bottom-10 right-10 z-50 bg-pb-primary hover:bg-pb-accent text-white rounded-full shadow-lg p-4 flex items-center justify-center transition focus:outline-none focus:ring-2 focus:ring-pb-primary"
          title="Add Prop"
          aria-label="Add Prop"
        >
          <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>
        </Link>
      </div>
    </DashboardLayout>
  );
};

export default PropsListPage; 
```

```typescriptreact
import React, { useState, useEffect } from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { useFirebase } from './contexts/FirebaseContext';
import { propCategories, Prop } from '../shared/types/props';
import { FirebaseDocument } from '../shared/services/firebase/types';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { Link } from 'react-router-dom';
import PropCardWeb from './PropCardWeb';
import jsPDF from 'jspdf';
import type { PdfGenerationOptions } from '../shared/types/pdf';

const defaultPdfOptions: PdfGenerationOptions = {
  selectedFields: {
    name: true,
    description: true,
    category: true,
    status: true,
    quantity: true,
    // Add more fields as needed, defaulting to true/false
  } as any,
  layout: 'portrait',
  columns: 1,
  imageCount: 1,
  imageWidthOption: 'medium',
  showFilesQR: false,
  showVideosQR: false,
  title: 'Props List',
};

function generatePropsListHtml(props: Prop[], options: PdfGenerationOptions): string {
  // Simple HTML table for now
  const fields = Object.keys(options.selectedFields).filter(k => (options.selectedFields as any)[k]);
  return `
    <html><head><meta charset='UTF-8'><title>${options.title || 'Props List'}</title>
    <style>
      body { font-family: Arial, sans-serif; color: #222; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 12px; }
      th { background: #f0f0f0; }
      .prop-img { max-width: 80px; max-height: 80px; }
    </style></head><body>
    <h2>${options.title || 'Props List'}</h2>
    <table><thead><tr>
      ${fields.map(f => `<th>${f.charAt(0).toUpperCase() + f.slice(1)}</th>`).join('')}
    </tr></thead><tbody>
      ${props.map(prop => `<tr>
        ${fields.map(f => {
          if (f === 'images' && prop.images && prop.images.length > 0) {
            return `<td><img class='prop-img' src='${prop.images[0].url}' /></td>`;
          }
          return `<td>${(prop as any)[f] ?? ''}</td>`;
        }).join('')}
      </tr>`).join('')}
    </tbody></table>
    </body></html>
  `;
}

const PropsListPage: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const { service: firebaseService, isInitialized, error: firebaseInitError } = useFirebase();
  const { currentShowId } = useShowSelection();
  const [search, setSearch] = useState('');
  const [category, setCategory] = useState<string>('');
  const [status, setStatus] = useState<string>('');
  const [act, setAct] = useState<string>('');
  const [scene, setScene] = useState<string>('');
  const [showPdfDialog, setShowPdfDialog] = useState(false);
  const [pdfOptions, setPdfOptions] = useState<PdfGenerationOptions>(defaultPdfOptions);
  const [downloading, setDownloading] = useState(false);

  // Extract unique acts and scenes from props
  const acts = Array.from(new Set(props.map(p => p.act).filter(a => a != null))).sort((a, b) => (a ?? 0) - (b ?? 0));
  const scenes = Array.from(new Set(props.map(p => p.scene).filter(s => s != null))).sort((a, b) => (a ?? 0) - (b ?? 0));

  useEffect(() => {
    if (!isInitialized) {
      setLoading(true);
      setError("Firebase not initialized.");
      return;
    }

    if (firebaseInitError) {
      setError(`Firebase Initialization Error: ${firebaseInitError.message}`);
      setLoading(false);
      return;
    }

    if (!currentShowId) {
      setProps([]);
      setLoading(false);
      setError(null);
      return;
    }

    setLoading(true);
    setError(null);

    const unsubscribe = firebaseService.listenToCollection<Prop>(
      'props',
      (data: FirebaseDocument<Prop>[]) => {
        const propList = data
          .map(doc => ({ ...doc.data, id: doc.id }))
          .filter(prop => prop.showId === currentShowId);
        setProps(propList);
        setLoading(false);
      },
      (err: Error) => {
        console.error("Error fetching props:", err);
        setError(`Failed to load props: ${err.message}. Please check your network connection and Firebase permissions.`);
        setLoading(false);
      }
    );

    return () => unsubscribe();
  }, [firebaseService, isInitialized, firebaseInitError, currentShowId]);

  // const handleAddProp = () => {};

  // Filtered props
  const filteredProps = props.filter((prop) => {
    const matchesSearch =
      search.trim() === '' ||
      prop.name.toLowerCase().includes(search.toLowerCase()) ||
      (prop.description && prop.description.toLowerCase().includes(search.toLowerCase()));
    const matchesCategory = !category || prop.category === category;
    const matchesStatus = !status || (prop.status && prop.status === status);
    const matchesAct = !act || (prop.act != null && String(prop.act) === act);
    const matchesScene = !scene || (prop.scene != null && String(prop.scene) === scene);
    return matchesSearch && matchesCategory && matchesStatus && matchesAct && matchesScene;
  });

  const handleDownloadPdf = async () => {
    setDownloading(true);
    const html = generatePropsListHtml(filteredProps, pdfOptions);
    const pdf = new jsPDF({ orientation: pdfOptions.layout });
    await pdf.html(html, { callback: () => {
      pdf.save(`${pdfOptions.title || 'props-list'}.pdf`);
      setDownloading(false);
      setShowPdfDialog(false);
    }});
  };

  return (
    <DashboardLayout>
      <div className="relative min-h-[70vh] flex flex-col w-full max-w-7xl mx-auto bg-gradient-to-br from-pb-primary/40 via-pb-darker/80 to-pb-accent/30 rounded-xl shadow-xl p-6">
        {/* Search and Filters */}
        <div className="w-full flex flex-col md:flex-row gap-4 mb-6">
          <input
            type="text"
            placeholder="Search props..."
            value={search}
            onChange={e => setSearch(e.target.value)}
            className="flex-1 px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white placeholder-pb-gray focus:outline-none focus:ring-2 focus:ring-pb-primary"
          />
          <select
            value={category}
            onChange={e => setCategory(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Categories</option>
            {propCategories.map(cat => (
              <option key={cat} value={cat}>{cat}</option>
            ))}
          </select>
          <select
            value={status}
            onChange={e => setStatus(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Statuses</option>
            <option value="in">In</option>
            <option value="maintenance">Maintenance</option>
            <option value="retired">Retired</option>
            <option value="available">Available</option>
          </select>
          <select
            value={act}
            onChange={e => setAct(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Acts</option>
            {acts.map(a => (
              <option key={a} value={String(a)}>{a}</option>
            ))}
          </select>
          <select
            value={scene}
            onChange={e => setScene(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Scenes</option>
            {scenes.map(s => (
              <option key={s} value={String(s)}>{s}</option>
            ))}
          </select>
        </div>
        {!currentShowId && (
          <div className="flex flex-col items-center justify-center h-64">
            <div className="text-pb-primary font-semibold text-lg mb-2">Please select a show to view its props.</div>
          </div>
        )}
        <h2 className="text-2xl font-bold mb-6">Props List</h2>
        <div className="w-full flex justify-end mb-4">
          <button
            className="btn btn-primary"
            onClick={() => setShowPdfDialog(true)}
          >
            Download PDF
          </button>
        </div>
        {showPdfDialog && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white text-black rounded-lg shadow-lg p-6 min-w-[320px]">
              <h3 className="font-bold text-lg mb-2">Export Props List to PDF</h3>
              <div className="mb-2">
                <label className="block font-semibold mb-1">Fields to include:</label>
                {Object.keys(defaultPdfOptions.selectedFields).map(f => (
                  <label key={f} className="block text-sm">
                    <input
                      type="checkbox"
                      checked={pdfOptions.selectedFields[f as keyof Prop]}
                      onChange={e => setPdfOptions(opt => ({
                        ...opt,
                        selectedFields: { ...opt.selectedFields, [f]: e.target.checked }
                      }))}
                    /> {f.charAt(0).toUpperCase() + f.slice(1)}
                  </label>
                ))}
              </div>
              <div className="mb-2">
                <label className="block font-semibold mb-1">Layout:</label>
                <select
                  value={pdfOptions.layout}
                  onChange={e => setPdfOptions(opt => ({ ...opt, layout: e.target.value as any }))}
                  className="border rounded px-2 py-1"
                >
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                </select>
              </div>
              <div className="flex gap-2 mt-4">
                <button
                  className="btn btn-primary"
                  onClick={handleDownloadPdf}
                  disabled={downloading}
                >
                  {downloading ? 'Generating...' : 'Download PDF'}
                </button>
                <button
                  className="btn btn-secondary"
                  onClick={() => setShowPdfDialog(false)}
                  disabled={downloading}
                >Cancel</button>
              </div>
            </div>
          </div>
        )}
        {loading ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="animate-spin h-10 w-10 text-pb-primary mb-2" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" /><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" /></svg>
            <div className="text-pb-gray mt-2">Loading props...</div>
          </div>
        ) : error ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-red-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
            <div className="text-red-500 font-semibold">{error}</div>
          </div>
        ) : filteredProps.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-pb-gray mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" /></svg>
            <div className="text-pb-gray">No props found.</div>
          </div>
        ) : (
          <div className="w-full">
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
              {filteredProps.map((prop) => (
                <div key={prop.id}>
                  <PropCardWeb prop={prop} />
                </div>
              ))}
            </div>
          </div>
        )}
        <Link
          to="/props/add"
          className="fixed bottom-10 right-10 z-50 bg-pb-primary hover:bg-pb-accent text-white rounded-full shadow-lg p-4 flex items-center justify-center transition focus:outline-none focus:ring-2 focus:ring-pb-primary"
          title="Add Prop"
          aria-label="Add Prop"
        >
          <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>
        </Link>
      </div>
    </DashboardLayout>
  );
};

export default PropsListPage; 
```

- Expanded `PropsListPage` to use the full width and a responsive grid:
  - Container now `max-w-7xl` and full-width.
  - Replaced the single-column list with a grid: 1–5 columns responsive.
  - Header and actions now stretch full width.
- Kept filters as a full-width row.

Files edited:
- `web-app/src/PropsListPage.tsx` (layout/grid updates, cleaned unused imports)

If you want larger cards or different breakpoints (e.g., 2/3/5/6 columns), I can tweak the grid quickly.

---

**User**

lets go with larger cards

---

**Cursor**

```typescriptreact
import React from 'react';
import { Link } from 'react-router-dom';

export interface PropImage {
  id: string;
  url: string;
  caption?: string;
  isMain?: boolean;
}

export interface PropCardWebProps {
  prop: {
    name: string;
    description?: string;
    status?: string;
    quantity?: number;
    images?: PropImage[];
    imageUrl?: string;
    id: string;
  };
}

const statusColors: Record<string, string> = {
  in: 'bg-green-600',
  maintenance: 'bg-yellow-500',
  retired: 'bg-gray-500',
  available: 'bg-blue-600',
  '': 'bg-pb-gray',
};

const PropCardWeb: React.FC<PropCardWebProps> = ({ prop }) => {
  // Use main image, or first image, or fallback
  const mainImage =
    (prop.images?.find(img => img.isMain)?.url) ||
    (prop.images && prop.images.length > 0 ? prop.images[0].url : '') ||
    prop.imageUrl ||
    '';
  const hasImage = !!mainImage && mainImage.trim() !== '';
  const status = prop.status || '';
  const statusColor = statusColors[status] || 'bg-pb-gray';
  const quantity = typeof prop.quantity === 'number' ? prop.quantity : 1;

  return (
    <Link to={`/props/${prop.id}`} className="block group focus:outline-none focus:ring-2 focus:ring-pb-primary rounded-2xl">
      <div className="flex items-center bg-pb-darker/70 backdrop-blur-md rounded-2xl shadow-xl p-5 mb-4 hover:bg-pb-primary/10 transition cursor-pointer group-focus:ring-2 group-focus:ring-pb-primary">
        <div className="w-28 h-28 rounded-xl overflow-hidden bg-pb-gray flex items-center justify-center mr-5 flex-shrink-0">
          {hasImage ? (
            <img
              src={mainImage}
              alt={prop.name}
              className="object-cover w-full h-full"
              onError={e => (e.currentTarget.style.display = 'none')}
            />
          ) : (
            <div className="flex items-center justify-center w-full h-full text-pb-light/60">
              <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
              </svg>
            </div>
          )}
        </div>
        <div className="flex-1 min-w-0">
          <div className="font-bold text-xl text-white truncate mb-2">{prop.name || 'Unnamed Prop'}</div>
          {prop.description && (
            <div className="text-pb-gray text-base mb-3 line-clamp-2">{prop.description}</div>
          )}
          <div className="flex items-center gap-2 mt-1">
            <span className={`px-3 py-1 rounded-full text-sm font-semibold text-white ${statusColor}`}>{status || 'unknown'}</span>
            <span className="px-3 py-1 rounded-full text-sm font-semibold bg-pb-primary/30 text-white">Qty: {quantity}</span>
          </div>
        </div>
      </div>
    </Link>
  );
};

export default PropCardWeb; 
```

- Increased card size and typography in `web-app/src/PropCardWeb.tsx`:
  - Image: from 80px (w-20 h-20) to 112px (w-28 h-28), rounded-xl
  - Container: larger padding, rounded-2xl, stronger shadow
  - Title font: text-xl; description: text-base; badges: text-sm
- Kept `PropsListPage` grid responsive so the larger cards flow across available width.

Want the grid columns reduced (e.g., max 4) to make cards even larger on wide screens?

---

**User**

ok lets try doubling the width of the cards and halfing the number per row

---

**Cursor**

```typescriptreact
import React, { useState, useEffect } from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { useFirebase } from './contexts/FirebaseContext';
import { propCategories, Prop } from '../shared/types/props';
import { FirebaseDocument } from '../shared/services/firebase/types';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { Link } from 'react-router-dom';
import PropCardWeb from './PropCardWeb';
import jsPDF from 'jspdf';
import type { PdfGenerationOptions } from '../shared/types/pdf';

const defaultPdfOptions: PdfGenerationOptions = {
  selectedFields: {
    name: true,
    description: true,
    category: true,
    status: true,
    quantity: true,
    // Add more fields as needed, defaulting to true/false
  } as any,
  layout: 'portrait',
  columns: 1,
  imageCount: 1,
  imageWidthOption: 'medium',
  showFilesQR: false,
  showVideosQR: false,
  title: 'Props List',
};

function generatePropsListHtml(props: Prop[], options: PdfGenerationOptions): string {
  // Simple HTML table for now
  const fields = Object.keys(options.selectedFields).filter(k => (options.selectedFields as any)[k]);
  return `
    <html><head><meta charset='UTF-8'><title>${options.title || 'Props List'}</title>
    <style>
      body { font-family: Arial, sans-serif; color: #222; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 12px; }
      th { background: #f0f0f0; }
      .prop-img { max-width: 80px; max-height: 80px; }
    </style></head><body>
    <h2>${options.title || 'Props List'}</h2>
    <table><thead><tr>
      ${fields.map(f => `<th>${f.charAt(0).toUpperCase() + f.slice(1)}</th>`).join('')}
    </tr></thead><tbody>
      ${props.map(prop => `<tr>
        ${fields.map(f => {
          if (f === 'images' && prop.images && prop.images.length > 0) {
            return `<td><img class='prop-img' src='${prop.images[0].url}' /></td>`;
          }
          return `<td>${(prop as any)[f] ?? ''}</td>`;
        }).join('')}
      </tr>`).join('')}
    </tbody></table>
    </body></html>
  `;
}

const PropsListPage: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const { service: firebaseService, isInitialized, error: firebaseInitError } = useFirebase();
  const { currentShowId } = useShowSelection();
  const [search, setSearch] = useState('');
  const [category, setCategory] = useState<string>('');
  const [status, setStatus] = useState<string>('');
  const [act, setAct] = useState<string>('');
  const [scene, setScene] = useState<string>('');
  const [showPdfDialog, setShowPdfDialog] = useState(false);
  const [pdfOptions, setPdfOptions] = useState<PdfGenerationOptions>(defaultPdfOptions);
  const [downloading, setDownloading] = useState(false);

  // Extract unique acts and scenes from props
  const acts = Array.from(new Set(props.map(p => p.act).filter(a => a != null))).sort((a, b) => (a ?? 0) - (b ?? 0));
  const scenes = Array.from(new Set(props.map(p => p.scene).filter(s => s != null))).sort((a, b) => (a ?? 0) - (b ?? 0));

  useEffect(() => {
    if (!isInitialized) {
      setLoading(true);
      setError("Firebase not initialized.");
      return;
    }

    if (firebaseInitError) {
      setError(`Firebase Initialization Error: ${firebaseInitError.message}`);
      setLoading(false);
      return;
    }

    if (!currentShowId) {
      setProps([]);
      setLoading(false);
      setError(null);
      return;
    }

    setLoading(true);
    setError(null);

    const unsubscribe = firebaseService.listenToCollection<Prop>(
      'props',
      (data: FirebaseDocument<Prop>[]) => {
        const propList = data
          .map(doc => ({ ...doc.data, id: doc.id }))
          .filter(prop => prop.showId === currentShowId);
        setProps(propList);
        setLoading(false);
      },
      (err: Error) => {
        console.error("Error fetching props:", err);
        setError(`Failed to load props: ${err.message}. Please check your network connection and Firebase permissions.`);
        setLoading(false);
      }
    );

    return () => unsubscribe();
  }, [firebaseService, isInitialized, firebaseInitError, currentShowId]);

  // const handleAddProp = () => {};

  // Filtered props
  const filteredProps = props.filter((prop) => {
    const matchesSearch =
      search.trim() === '' ||
      prop.name.toLowerCase().includes(search.toLowerCase()) ||
      (prop.description && prop.description.toLowerCase().includes(search.toLowerCase()));
    const matchesCategory = !category || prop.category === category;
    const matchesStatus = !status || (prop.status && prop.status === status);
    const matchesAct = !act || (prop.act != null && String(prop.act) === act);
    const matchesScene = !scene || (prop.scene != null && String(prop.scene) === scene);
    return matchesSearch && matchesCategory && matchesStatus && matchesAct && matchesScene;
  });

  const handleDownloadPdf = async () => {
    setDownloading(true);
    const html = generatePropsListHtml(filteredProps, pdfOptions);
    const pdf = new jsPDF({ orientation: pdfOptions.layout });
    await pdf.html(html, { callback: () => {
      pdf.save(`${pdfOptions.title || 'props-list'}.pdf`);
      setDownloading(false);
      setShowPdfDialog(false);
    }});
  };

  return (
    <DashboardLayout>
      <div className="relative min-h-[70vh] flex flex-col w-full max-w-7xl mx-auto bg-gradient-to-br from-pb-primary/40 via-pb-darker/80 to-pb-accent/30 rounded-xl shadow-xl p-6">
        {/* Search and Filters */}
        <div className="w-full flex flex-col md:flex-row gap-4 mb-6">
          <input
            type="text"
            placeholder="Search props..."
            value={search}
            onChange={e => setSearch(e.target.value)}
            className="flex-1 px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white placeholder-pb-gray focus:outline-none focus:ring-2 focus:ring-pb-primary"
          />
          <select
            value={category}
            onChange={e => setCategory(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Categories</option>
            {propCategories.map(cat => (
              <option key={cat} value={cat}>{cat}</option>
            ))}
          </select>
          <select
            value={status}
            onChange={e => setStatus(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Statuses</option>
            <option value="in">In</option>
            <option value="maintenance">Maintenance</option>
            <option value="retired">Retired</option>
            <option value="available">Available</option>
          </select>
          <select
            value={act}
            onChange={e => setAct(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Acts</option>
            {acts.map(a => (
              <option key={a} value={String(a)}>{a}</option>
            ))}
          </select>
          <select
            value={scene}
            onChange={e => setScene(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Scenes</option>
            {scenes.map(s => (
              <option key={s} value={String(s)}>{s}</option>
            ))}
          </select>
        </div>
        {!currentShowId && (
          <div className="flex flex-col items-center justify-center h-64">
            <div className="text-pb-primary font-semibold text-lg mb-2">Please select a show to view its props.</div>
          </div>
        )}
        <h2 className="text-2xl font-bold mb-6">Props List</h2>
        <div className="w-full flex justify-end mb-4">
          <button
            className="btn btn-primary"
            onClick={() => setShowPdfDialog(true)}
          >
            Download PDF
          </button>
        </div>
        {showPdfDialog && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white text-black rounded-lg shadow-lg p-6 min-w-[320px]">
              <h3 className="font-bold text-lg mb-2">Export Props List to PDF</h3>
              <div className="mb-2">
                <label className="block font-semibold mb-1">Fields to include:</label>
                {Object.keys(defaultPdfOptions.selectedFields).map(f => (
                  <label key={f} className="block text-sm">
                    <input
                      type="checkbox"
                      checked={pdfOptions.selectedFields[f as keyof Prop]}
                      onChange={e => setPdfOptions(opt => ({
                        ...opt,
                        selectedFields: { ...opt.selectedFields, [f]: e.target.checked }
                      }))}
                    /> {f.charAt(0).toUpperCase() + f.slice(1)}
                  </label>
                ))}
              </div>
              <div className="mb-2">
                <label className="block font-semibold mb-1">Layout:</label>
                <select
                  value={pdfOptions.layout}
                  onChange={e => setPdfOptions(opt => ({ ...opt, layout: e.target.value as any }))}
                  className="border rounded px-2 py-1"
                >
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                </select>
              </div>
              <div className="flex gap-2 mt-4">
                <button
                  className="btn btn-primary"
                  onClick={handleDownloadPdf}
                  disabled={downloading}
                >
                  {downloading ? 'Generating...' : 'Download PDF'}
                </button>
                <button
                  className="btn btn-secondary"
                  onClick={() => setShowPdfDialog(false)}
                  disabled={downloading}
                >Cancel</button>
              </div>
            </div>
          </div>
        )}
        {loading ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="animate-spin h-10 w-10 text-pb-primary mb-2" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" /><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" /></svg>
            <div className="text-pb-gray mt-2">Loading props...</div>
          </div>
        ) : error ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-red-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
            <div className="text-red-500 font-semibold">{error}</div>
          </div>
        ) : filteredProps.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-pb-gray mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" /></svg>
            <div className="text-pb-gray">No props found.</div>
          </div>
        ) : (
          <div className="w-full">
            <div className="grid grid-cols-1 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6">
              {filteredProps.map((prop) => (
                <div key={prop.id}>
                  <PropCardWeb prop={prop} />
                </div>
              ))}
            </div>
          </div>
        )}
        <Link
          to="/props/add"
          className="fixed bottom-10 right-10 z-50 bg-pb-primary hover:bg-pb-accent text-white rounded-full shadow-lg p-4 flex items-center justify-center transition focus:outline-none focus:ring-2 focus:ring-pb-primary"
          title="Add Prop"
          aria-label="Add Prop"
        >
          <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>
        </Link>
      </div>
    </DashboardLayout>
  );
};

export default PropsListPage; 
```

```typescriptreact
*** Begin Patch
*** Update File: web-app/src/PropCardWeb.tsx
@@
-      <div className="flex items-center bg-pb-darker/70 backdrop-blur-md rounded-2xl shadow-xl p-5 mb-4 hover:bg-pb-primary/10 transition cursor-pointer group-focus:ring-2 group-focus:ring-pb-primary">
+      <div className="flex items-center bg-pb-darker/70 backdrop-blur-md rounded-2xl shadow-xl p-6 mb-6 hover:bg-pb-primary/10 transition cursor-pointer group-focus:ring-2 group-focus:ring-pb-primary">
-        <div className="w-28 h-28 rounded-xl overflow-hidden bg-pb-gray flex items-center justify-center mr-5 flex-shrink-0">
+        <div className="w-36 h-36 rounded-xl overflow-hidden bg-pb-gray flex items-center justify-center mr-6 flex-shrink-0">
@@
-          <div className="font-bold text-xl text-white truncate mb-2">{prop.name || 'Unnamed Prop'}</div>
+          <div className="font-bold text-2xl text-white truncate mb-3">{prop.name || 'Unnamed Prop'}</div>
-            <div className="text-pb-gray text-base mb-3 line-clamp-2">{prop.description}</div>
+            <div className="text-pb-gray text-base mb-4 line-clamp-3">{prop.description}</div>
*** End Patch
```

```typescriptreact
import React from 'react';
import { Link } from 'react-router-dom';

export interface PropImage {
  id: string;
  url: string;
  caption?: string;
  isMain?: boolean;
}

export interface PropCardWebProps {
  prop: {
    name: string;
    description?: string;
    status?: string;
    quantity?: number;
    images?: PropImage[];
    imageUrl?: string;
    id: string;
  };
}

const statusColors: Record<string, string> = {
  in: 'bg-green-600',
  maintenance: 'bg-yellow-500',
  retired: 'bg-gray-500',
  available: 'bg-blue-600',
  '': 'bg-pb-gray',
};

const PropCardWeb: React.FC<PropCardWebProps> = ({ prop }) => {
  // Use main image, or first image, or fallback
  const mainImage =
    (prop.images?.find(img => img.isMain)?.url) ||
    (prop.images && prop.images.length > 0 ? prop.images[0].url : '') ||
    prop.imageUrl ||
    '';
  const hasImage = !!mainImage && mainImage.trim() !== '';
  const status = prop.status || '';
  const statusColor = statusColors[status] || 'bg-pb-gray';
  const quantity = typeof prop.quantity === 'number' ? prop.quantity : 1;

  return (
    <Link to={`/props/${prop.id}`} className="block group focus:outline-none focus:ring-2 focus:ring-pb-primary rounded-2xl">
      <div className="flex items-center bg-pb-darker/70 backdrop-blur-md rounded-2xl shadow-xl p-6 mb-6 hover:bg-pb-primary/10 transition cursor-pointer group-focus:ring-2 group-focus:ring-pb-primary">
        <div className="w-36 h-36 rounded-xl overflow-hidden bg-pb-gray flex items-center justify-center mr-6 flex-shrink-0">
          {hasImage ? (
            <img
              src={mainImage}
              alt={prop.name}
              className="object-cover w-full h-full"
              onError={e => (e.currentTarget.style.display = 'none')}
            />
          ) : (
            <div className="flex items-center justify-center w-full h-full text-pb-light/60">
              <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
              </svg>
            </div>
          )}
        </div>
        <div className="flex-1 min-w-0">
          <div className="font-bold text-2xl text-white truncate mb-3">{prop.name || 'Unnamed Prop'}</div>
          {prop.description && (
            <div className="text-pb-gray text-base mb-4 line-clamp-3">{prop.description}</div>
          )}
          <div className="flex items-center gap-2 mt-1">
            <span className={`px-3 py-1 rounded-full text-sm font-semibold text-white ${statusColor}`}>{status || 'unknown'}</span>
            <span className="px-3 py-1 rounded-full text-sm font-semibold bg-pb-primary/30 text-white">Qty: {quantity}</span>
          </div>
        </div>
      </div>
    </Link>
  );
};

export default PropCardWeb; 
```

- Reduced columns to make cards larger: updated `PropsListPage` grid to 1/1/2/2/3 columns across breakpoints with larger gaps.
- Increased card footprint in `PropCardWeb`:
  - Image to w-36 h-36, more padding/margins
  - Title to text-2xl, description line-clamp 3 with more spacing

If you want even fewer columns (e.g., max 2 on xl) or a masonry layout, I can adjust quickly.

---

**User**

the qty pill is pushed out of the card

---

**Cursor**

```typescriptreact
import React from 'react';
import { Link } from 'react-router-dom';

export interface PropImage {
  id: string;
  url: string;
  caption?: string;
  isMain?: boolean;
}

export interface PropCardWebProps {
  prop: {
    name: string;
    description?: string;
    status?: string;
    quantity?: number;
    images?: PropImage[];
    imageUrl?: string;
    id: string;
  };
}

const statusColors: Record<string, string> = {
  in: 'bg-green-600',
  maintenance: 'bg-yellow-500',
  retired: 'bg-gray-500',
  available: 'bg-blue-600',
  '': 'bg-pb-gray',
};

const PropCardWeb: React.FC<PropCardWebProps> = ({ prop }) => {
  // Use main image, or first image, or fallback
  const mainImage =
    (prop.images?.find(img => img.isMain)?.url) ||
    (prop.images && prop.images.length > 0 ? prop.images[0].url : '') ||
    prop.imageUrl ||
    '';
  const hasImage = !!mainImage && mainImage.trim() !== '';
  const status = prop.status || '';
  const statusColor = statusColors[status] || 'bg-pb-gray';
  const quantity = typeof prop.quantity === 'number' ? prop.quantity : 1;

  return (
    <Link to={`/props/${prop.id}`} className="block group focus:outline-none focus:ring-2 focus:ring-pb-primary rounded-2xl">
      <div className="flex items-center bg-pb-darker/70 backdrop-blur-md rounded-2xl shadow-xl p-6 mb-6 hover:bg-pb-primary/10 transition cursor-pointer group-focus:ring-2 group-focus:ring-pb-primary overflow-hidden">
        <div className="w-36 h-36 rounded-xl overflow-hidden bg-pb-gray flex items-center justify-center mr-6 flex-shrink-0">
          {hasImage ? (
            <img
              src={mainImage}
              alt={prop.name}
              className="object-cover w-full h-full"
              onError={e => (e.currentTarget.style.display = 'none')}
            />
          ) : (
            <div className="flex items-center justify-center w-full h-full text-pb-light/60">
              <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
              </svg>
            </div>
          )}
        </div>
        <div className="flex-1 min-w-0">
          <div className="font-bold text-2xl text-white truncate mb-3">{prop.name || 'Unnamed Prop'}</div>
          {prop.description && (
            <div className="text-pb-gray text-base mb-4 line-clamp-3">{prop.description}</div>
          )}
          <div className="flex items-center justify-between gap-2 mt-1 w-full">
            <span className={`px-3 py-1 rounded-full text-sm font-semibold text-white shrink-0 ${statusColor}`}>{status || 'unknown'}</span>
            <span className="px-3 py-1 rounded-full text-sm font-semibold bg-pb-primary/30 text-white shrink-0">Qty: {quantity}</span>
          </div>
        </div>
      </div>
    </Link>
  );
};

export default PropCardWeb; 
```

- Adjusted `PropCardWeb` layout to keep the Qty pill inside the card:
  - Added `overflow-hidden` on the card container.
  - Switched the badge row to `justify-between` and added `shrink-0` on both badges to prevent wrapping/push-out.

If you want the Qty pill pinned to the bottom-right corner instead, I can absolutely-position it within the card.

---

**User**

lets reduce the size of the image 

---

**Cursor**

Reducing the card image size by updating the image container dimensions and icon size, then checking for lint issues.

```typescriptreact
import React from 'react';
import { Link } from 'react-router-dom';

export interface PropImage {
  id: string;
  url: string;
  caption?: string;
  isMain?: boolean;
}

export interface PropCardWebProps {
  prop: {
    name: string;
    description?: string;
    status?: string;
    quantity?: number;
    images?: PropImage[];
    imageUrl?: string;
    id: string;
  };
}

const statusColors: Record<string, string> = {
  in: 'bg-green-600',
  maintenance: 'bg-yellow-500',
  retired: 'bg-gray-500',
  available: 'bg-blue-600',
  '': 'bg-pb-gray',
};

const PropCardWeb: React.FC<PropCardWebProps> = ({ prop }) => {
  // Use main image, or first image, or fallback
  const mainImage =
    (prop.images?.find(img => img.isMain)?.url) ||
    (prop.images && prop.images.length > 0 ? prop.images[0].url : '') ||
    prop.imageUrl ||
    '';
  const hasImage = !!mainImage && mainImage.trim() !== '';
  const status = prop.status || '';
  const statusColor = statusColors[status] || 'bg-pb-gray';
  const quantity = typeof prop.quantity === 'number' ? prop.quantity : 1;

  return (
    <Link to={`/props/${prop.id}`} className="block group focus:outline-none focus:ring-2 focus:ring-pb-primary rounded-2xl">
      <div className="flex items-center bg-pb-darker/70 backdrop-blur-md rounded-2xl shadow-xl p-6 mb-6 hover:bg-pb-primary/10 transition cursor-pointer group-focus:ring-2 group-focus:ring-pb-primary overflow-hidden">
        <div className="w-28 h-28 rounded-xl overflow-hidden bg-pb-gray flex items-center justify-center mr-5 flex-shrink-0">
          {hasImage ? (
            <img
              src={mainImage}
              alt={prop.name}
              className="object-cover w-full h-full"
              onError={e => (e.currentTarget.style.display = 'none')}
            />
          ) : (
            <div className="flex items-center justify-center w-full h-full text-pb-light/60">
              <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" />
              </svg>
            </div>
          )}
        </div>
        <div className="flex-1 min-w-0">
          <div className="font-bold text-2xl text-white truncate mb-3">{prop.name || 'Unnamed Prop'}</div>
          {prop.description && (
            <div className="text-pb-gray text-base mb-4 line-clamp-3">{prop.description}</div>
          )}
          <div className="flex items-center justify-between gap-2 mt-1 w-full">
            <span className={`px-3 py-1 rounded-full text-sm font-semibold text-white shrink-0 ${statusColor}`}>{status || 'unknown'}</span>
            <span className="px-3 py-1 rounded-full text-sm font-semibold bg-pb-primary/30 text-white shrink-0">Qty: {quantity}</span>
          </div>
        </div>
      </div>
    </Link>
  );
};

export default PropCardWeb; 
```

- Reduced image size in `PropCardWeb`:
  - Image container from w-36 h-36 to w-28 h-28
  - Adjusted margins accordingly
  - Placeholder icon from 48 to 40

Everything type-checks and lints clean.

---

**User**

lets make it 2 cards to a row

---

**Cursor**

```typescriptreact
import React, { useState, useEffect } from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { useFirebase } from './contexts/FirebaseContext';
import { propCategories, Prop } from '../shared/types/props';
import { FirebaseDocument } from '../shared/services/firebase/types';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { Link } from 'react-router-dom';
import PropCardWeb from './PropCardWeb';
import jsPDF from 'jspdf';
import type { PdfGenerationOptions } from '../shared/types/pdf';

const defaultPdfOptions: PdfGenerationOptions = {
  selectedFields: {
    name: true,
    description: true,
    category: true,
    status: true,
    quantity: true,
    // Add more fields as needed, defaulting to true/false
  } as any,
  layout: 'portrait',
  columns: 1,
  imageCount: 1,
  imageWidthOption: 'medium',
  showFilesQR: false,
  showVideosQR: false,
  title: 'Props List',
};

function generatePropsListHtml(props: Prop[], options: PdfGenerationOptions): string {
  // Simple HTML table for now
  const fields = Object.keys(options.selectedFields).filter(k => (options.selectedFields as any)[k]);
  return `
    <html><head><meta charset='UTF-8'><title>${options.title || 'Props List'}</title>
    <style>
      body { font-family: Arial, sans-serif; color: #222; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 12px; }
      th { background: #f0f0f0; }
      .prop-img { max-width: 80px; max-height: 80px; }
    </style></head><body>
    <h2>${options.title || 'Props List'}</h2>
    <table><thead><tr>
      ${fields.map(f => `<th>${f.charAt(0).toUpperCase() + f.slice(1)}</th>`).join('')}
    </tr></thead><tbody>
      ${props.map(prop => `<tr>
        ${fields.map(f => {
          if (f === 'images' && prop.images && prop.images.length > 0) {
            return `<td><img class='prop-img' src='${prop.images[0].url}' /></td>`;
          }
          return `<td>${(prop as any)[f] ?? ''}</td>`;
        }).join('')}
      </tr>`).join('')}
    </tbody></table>
    </body></html>
  `;
}

const PropsListPage: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const { service: firebaseService, isInitialized, error: firebaseInitError } = useFirebase();
  const { currentShowId } = useShowSelection();
  const [search, setSearch] = useState('');
  const [category, setCategory] = useState<string>('');
  const [status, setStatus] = useState<string>('');
  const [act, setAct] = useState<string>('');
  const [scene, setScene] = useState<string>('');
  const [showPdfDialog, setShowPdfDialog] = useState(false);
  const [pdfOptions, setPdfOptions] = useState<PdfGenerationOptions>(defaultPdfOptions);
  const [downloading, setDownloading] = useState(false);

  // Extract unique acts and scenes from props
  const acts = Array.from(new Set(props.map(p => p.act).filter(a => a != null))).sort((a, b) => (a ?? 0) - (b ?? 0));
  const scenes = Array.from(new Set(props.map(p => p.scene).filter(s => s != null))).sort((a, b) => (a ?? 0) - (b ?? 0));

  useEffect(() => {
    if (!isInitialized) {
      setLoading(true);
      setError("Firebase not initialized.");
      return;
    }

    if (firebaseInitError) {
      setError(`Firebase Initialization Error: ${firebaseInitError.message}`);
      setLoading(false);
      return;
    }

    if (!currentShowId) {
      setProps([]);
      setLoading(false);
      setError(null);
      return;
    }

    setLoading(true);
    setError(null);

    const unsubscribe = firebaseService.listenToCollection<Prop>(
      'props',
      (data: FirebaseDocument<Prop>[]) => {
        const propList = data
          .map(doc => ({ ...doc.data, id: doc.id }))
          .filter(prop => prop.showId === currentShowId);
        setProps(propList);
        setLoading(false);
      },
      (err: Error) => {
        console.error("Error fetching props:", err);
        setError(`Failed to load props: ${err.message}. Please check your network connection and Firebase permissions.`);
        setLoading(false);
      }
    );

    return () => unsubscribe();
  }, [firebaseService, isInitialized, firebaseInitError, currentShowId]);

  // const handleAddProp = () => {};

  // Filtered props
  const filteredProps = props.filter((prop) => {
    const matchesSearch =
      search.trim() === '' ||
      prop.name.toLowerCase().includes(search.toLowerCase()) ||
      (prop.description && prop.description.toLowerCase().includes(search.toLowerCase()));
    const matchesCategory = !category || prop.category === category;
    const matchesStatus = !status || (prop.status && prop.status === status);
    const matchesAct = !act || (prop.act != null && String(prop.act) === act);
    const matchesScene = !scene || (prop.scene != null && String(prop.scene) === scene);
    return matchesSearch && matchesCategory && matchesStatus && matchesAct && matchesScene;
  });

  const handleDownloadPdf = async () => {
    setDownloading(true);
    const html = generatePropsListHtml(filteredProps, pdfOptions);
    const pdf = new jsPDF({ orientation: pdfOptions.layout });
    await pdf.html(html, { callback: () => {
      pdf.save(`${pdfOptions.title || 'props-list'}.pdf`);
      setDownloading(false);
      setShowPdfDialog(false);
    }});
  };

  return (
    <DashboardLayout>
      <div className="relative min-h-[70vh] flex flex-col w-full max-w-7xl mx-auto bg-gradient-to-br from-pb-primary/40 via-pb-darker/80 to-pb-accent/30 rounded-xl shadow-xl p-6">
        {/* Search and Filters */}
        <div className="w-full flex flex-col md:flex-row gap-4 mb-6">
          <input
            type="text"
            placeholder="Search props..."
            value={search}
            onChange={e => setSearch(e.target.value)}
            className="flex-1 px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white placeholder-pb-gray focus:outline-none focus:ring-2 focus:ring-pb-primary"
          />
          <select
            value={category}
            onChange={e => setCategory(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Categories</option>
            {propCategories.map(cat => (
              <option key={cat} value={cat}>{cat}</option>
            ))}
          </select>
          <select
            value={status}
            onChange={e => setStatus(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Statuses</option>
            <option value="in">In</option>
            <option value="maintenance">Maintenance</option>
            <option value="retired">Retired</option>
            <option value="available">Available</option>
          </select>
          <select
            value={act}
            onChange={e => setAct(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Acts</option>
            {acts.map(a => (
              <option key={a} value={String(a)}>{a}</option>
            ))}
          </select>
          <select
            value={scene}
            onChange={e => setScene(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Scenes</option>
            {scenes.map(s => (
              <option key={s} value={String(s)}>{s}</option>
            ))}
          </select>
        </div>
        {!currentShowId && (
          <div className="flex flex-col items-center justify-center h-64">
            <div className="text-pb-primary font-semibold text-lg mb-2">Please select a show to view its props.</div>
          </div>
        )}
        <h2 className="text-2xl font-bold mb-6">Props List</h2>
        <div className="w-full flex justify-end mb-4">
          <button
            className="btn btn-primary"
            onClick={() => setShowPdfDialog(true)}
          >
            Download PDF
          </button>
        </div>
        {showPdfDialog && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white text-black rounded-lg shadow-lg p-6 min-w-[320px]">
              <h3 className="font-bold text-lg mb-2">Export Props List to PDF</h3>
              <div className="mb-2">
                <label className="block font-semibold mb-1">Fields to include:</label>
                {Object.keys(defaultPdfOptions.selectedFields).map(f => (
                  <label key={f} className="block text-sm">
                    <input
                      type="checkbox"
                      checked={pdfOptions.selectedFields[f as keyof Prop]}
                      onChange={e => setPdfOptions(opt => ({
                        ...opt,
                        selectedFields: { ...opt.selectedFields, [f]: e.target.checked }
                      }))}
                    /> {f.charAt(0).toUpperCase() + f.slice(1)}
                  </label>
                ))}
              </div>
              <div className="mb-2">
                <label className="block font-semibold mb-1">Layout:</label>
                <select
                  value={pdfOptions.layout}
                  onChange={e => setPdfOptions(opt => ({ ...opt, layout: e.target.value as any }))}
                  className="border rounded px-2 py-1"
                >
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                </select>
              </div>
              <div className="flex gap-2 mt-4">
                <button
                  className="btn btn-primary"
                  onClick={handleDownloadPdf}
                  disabled={downloading}
                >
                  {downloading ? 'Generating...' : 'Download PDF'}
                </button>
                <button
                  className="btn btn-secondary"
                  onClick={() => setShowPdfDialog(false)}
                  disabled={downloading}
                >Cancel</button>
              </div>
            </div>
          </div>
        )}
        {loading ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="animate-spin h-10 w-10 text-pb-primary mb-2" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" /><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" /></svg>
            <div className="text-pb-gray mt-2">Loading props...</div>
          </div>
        ) : error ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-red-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
            <div className="text-red-500 font-semibold">{error}</div>
          </div>
        ) : filteredProps.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-pb-gray mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" /></svg>
            <div className="text-pb-gray">No props found.</div>
          </div>
        ) : (
          <div className="w-full">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-6">
              {filteredProps.map((prop) => (
                <div key={prop.id}>
                  <PropCardWeb prop={prop} />
                </div>
              ))}
            </div>
          </div>
        )}
        <Link
          to="/props/add"
          className="fixed bottom-10 right-10 z-50 bg-pb-primary hover:bg-pb-accent text-white rounded-full shadow-lg p-4 flex items-center justify-center transition focus:outline-none focus:ring-2 focus:ring-pb-primary"
          title="Add Prop"
          aria-label="Add Prop"
        >
          <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>
        </Link>
      </div>
    </DashboardLayout>
  );
};

export default PropsListPage; 
```

- Updated the props grid to always show two cards per row from md and up:
  - Grid classes: `grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2`
- Left spacing and card sizes as previously configured.

If you want it forced to 2-per-row even on small screens, I can set `grid-cols-2` for sm as well and adjust padding.

---

**User**

on the the propslist the link to the pdf export should go to props/pdf-export

---

**Cursor**

```typescriptreact
import React, { useState, useEffect } from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { useFirebase } from './contexts/FirebaseContext';
import { propCategories, Prop } from '../shared/types/props';
import { FirebaseDocument } from '../shared/services/firebase/types';
import { useShowSelection } from './contexts/ShowSelectionContext';
import { Link } from 'react-router-dom';
import PropCardWeb from './PropCardWeb';
// Removed in favor of a dedicated PDF export page

const PropsListPage: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [props, setProps] = useState<Prop[]>([]);
  const { service: firebaseService, isInitialized, error: firebaseInitError } = useFirebase();
  const { currentShowId } = useShowSelection();
  const [search, setSearch] = useState('');
  const [category, setCategory] = useState<string>('');
  const [status, setStatus] = useState<string>('');
  const [act, setAct] = useState<string>('');
  const [scene, setScene] = useState<string>('');
  // PDF export handled by dedicated page at /props/pdf-export

  // Extract unique acts and scenes from props
  const acts = Array.from(new Set(props.map(p => p.act).filter(a => a != null))).sort((a, b) => (a ?? 0) - (b ?? 0));
  const scenes = Array.from(new Set(props.map(p => p.scene).filter(s => s != null))).sort((a, b) => (a ?? 0) - (b ?? 0));

  useEffect(() => {
    if (!isInitialized) {
      setLoading(true);
      setError("Firebase not initialized.");
      return;
    }

    if (firebaseInitError) {
      setError(`Firebase Initialization Error: ${firebaseInitError.message}`);
      setLoading(false);
      return;
    }

    if (!currentShowId) {
      setProps([]);
      setLoading(false);
      setError(null);
      return;
    }

    setLoading(true);
    setError(null);

    const unsubscribe = firebaseService.listenToCollection<Prop>(
      'props',
      (data: FirebaseDocument<Prop>[]) => {
        const propList = data
          .map(doc => ({ ...doc.data, id: doc.id }))
          .filter(prop => prop.showId === currentShowId);
        setProps(propList);
        setLoading(false);
      },
      (err: Error) => {
        console.error("Error fetching props:", err);
        setError(`Failed to load props: ${err.message}. Please check your network connection and Firebase permissions.`);
        setLoading(false);
      }
    );

    return () => unsubscribe();
  }, [firebaseService, isInitialized, firebaseInitError, currentShowId]);

  // const handleAddProp = () => {};

  // Filtered props
  const filteredProps = props.filter((prop) => {
    const matchesSearch =
      search.trim() === '' ||
      prop.name.toLowerCase().includes(search.toLowerCase()) ||
      (prop.description && prop.description.toLowerCase().includes(search.toLowerCase()));
    const matchesCategory = !category || prop.category === category;
    const matchesStatus = !status || (prop.status && prop.status === status);
    const matchesAct = !act || (prop.act != null && String(prop.act) === act);
    const matchesScene = !scene || (prop.scene != null && String(prop.scene) === scene);
    return matchesSearch && matchesCategory && matchesStatus && matchesAct && matchesScene;
  });

  // no-op

  return (
    <DashboardLayout>
      <div className="relative min-h-[70vh] flex flex-col w-full max-w-7xl mx-auto bg-gradient-to-br from-pb-primary/40 via-pb-darker/80 to-pb-accent/30 rounded-xl shadow-xl p-6">
        {/* Search and Filters */}
        <div className="w-full flex flex-col md:flex-row gap-4 mb-6">
          <input
            type="text"
            placeholder="Search props..."
            value={search}
            onChange={e => setSearch(e.target.value)}
            className="flex-1 px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white placeholder-pb-gray focus:outline-none focus:ring-2 focus:ring-pb-primary"
          />
          <select
            value={category}
            onChange={e => setCategory(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Categories</option>
            {propCategories.map(cat => (
              <option key={cat} value={cat}>{cat}</option>
            ))}
          </select>
          <select
            value={status}
            onChange={e => setStatus(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Statuses</option>
            <option value="in">In</option>
            <option value="maintenance">Maintenance</option>
            <option value="retired">Retired</option>
            <option value="available">Available</option>
          </select>
          <select
            value={act}
            onChange={e => setAct(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Acts</option>
            {acts.map(a => (
              <option key={a} value={String(a)}>{a}</option>
            ))}
          </select>
          <select
            value={scene}
            onChange={e => setScene(e.target.value)}
            className="px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
          >
            <option value="">All Scenes</option>
            {scenes.map(s => (
              <option key={s} value={String(s)}>{s}</option>
            ))}
          </select>
        </div>
        {!currentShowId && (
          <div className="flex flex-col items-center justify-center h-64">
            <div className="text-pb-primary font-semibold text-lg mb-2">Please select a show to view its props.</div>
          </div>
        )}
        <h2 className="text-2xl font-bold mb-6">Props List</h2>
        <div className="w-full flex justify-end mb-4">
          <Link to="/props/pdf-export" className="btn btn-primary">Download PDF</Link>
        </div>
        {loading ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="animate-spin h-10 w-10 text-pb-primary mb-2" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" /><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" /></svg>
            <div className="text-pb-gray mt-2">Loading props...</div>
          </div>
        ) : error ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-red-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
            <div className="text-red-500 font-semibold">{error}</div>
          </div>
        ) : filteredProps.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-pb-gray mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" /></svg>
            <div className="text-pb-gray">No props found.</div>
          </div>
        ) : (
          <div className="w-full">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-2 gap-6">
              {filteredProps.map((prop) => (
                <div key={prop.id}>
                  <PropCardWeb prop={prop} />
                </div>
              ))}
            </div>
          </div>
        )}
        <Link
          to="/props/add"
          className="fixed bottom-10 right-10 z-50 bg-pb-primary hover:bg-pb-accent text-white rounded-full shadow-lg p-4 flex items-center justify-center transition focus:outline-none focus:ring-2 focus:ring-pb-primary"
          title="Add Prop"
          aria-label="Add Prop"
        >
          <svg className="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>
        </Link>
      </div>
    </DashboardLayout>
  );
};

export default PropsListPage; 
```

- Repointed the PDF export to the dedicated page:
  - Replaced the in-page modal/export logic with a simple link to `/props/pdf-export`.
  - File updated: `web-app/src/PropsListPage.tsx`

Now the “Download PDF” button takes you to `props/pdf-export` as requested.

---

**User**

the /props/pdf-export page the form looks dated can we improve the look of the form

---

**Cursor**

```typescriptreact
import React, { useState, useRef, useEffect } from 'react';
import type { Prop } from '../../shared/types/props';
import type { PdfGenerationOptions } from '../../shared/types/pdf';
import DashboardLayout from '../PropsBibleHomepage';
import { useShowSelection } from '../contexts/ShowSelectionContext';
import { useFirebase } from '../contexts/FirebaseContext';
import html2pdf from 'html2pdf.js';


const allFields: (keyof Prop)[] = [
  'name', 'description', 'category', 'status', 'quantity', 'act', 'scene', 'images', 'digitalAssets', 'videos',
  'location', 'notes', 'tags', 'manufacturer', 'model', 'serialNumber', 'color', 'period', 'style', 'condition',
  // Add more fields as needed
];

const defaultPdfOptions: PdfGenerationOptions = {
  selectedFields: Object.fromEntries(allFields.map(f => [f, true])) as Record<keyof Prop, boolean>,
  layout: 'portrait',
  columns: 1,
  imageCount: 1,
  imageWidthOption: 'medium',
  showFilesQR: true,
  showVideosQR: true,
  title: '',
};

function generatePropsListHtml(props: Prop[], options: PdfGenerationOptions, header: string, footer: string, logoUrl?: string): string {
  console.log('Props passed to generatePropsListHtml:', props);
  const isLandscape = options.layout === 'landscape';
  const pageWidth = isLandscape ? 1123 : 794; // px (A4 at 96dpi)
  const pageHeight = isLandscape ? 794 : 1123;
  // Table of Contents HTML
  const tocRows = props.map((prop, idx) =>
    `<tr><td>${idx + 2}</td><td>${prop.name || ''}</td><td>${prop.category || ''}</td></tr>`
  ).join('');
  const tocHtml = `
    <div class='page'>
      <div class='header'>
        ${logoUrl ? `<img src='${logoUrl}' class='logo' /><br/>` : ''}
        <div class='toc-title'>${options.title || 'Props List'}</div>
        ${header ? `<div class='toc-header'>${header}</div>` : ''}
      </div>
      <div class='toc-content'>
        <h2>Table of Contents</h2>
        <table class='toc-table'>
          <thead><tr><th>Page</th><th>Prop Name</th><th>Category</th></tr></thead>
          <tbody>${tocRows}</tbody>
        </table>
      </div>
      <div class='footer'>
        ${footer ? footer : ''}
        <span style='float:right;font-size:0.95em;color:#888;'>Page 1 of ${props.length + 1}</span>
      </div>
    </div>
  `;
  // Helper for badges
  function badge(text: string, color: string) {
    return `<span style="display:inline-block;padding:2px 10px;border-radius:12px;font-size:0.95em;font-weight:600;background:${color};color:#fff;margin-right:8px;">${text}</span>`;
  }
  // Each prop page
  const propPages = props.map((prop, idx) => {
    // Images
    const mainImg = prop.images && prop.images.length > 0 ? prop.images[0].url : '';
    const galleryImgs = prop.images && prop.images.length > 1 ? prop.images.slice(1) : [];
    // Details table
    const details = [
      ['Category', prop.category],
      ['Status', prop.status],
      ['Quantity', prop.quantity],
      ['Act', prop.act],
      ['Scene', prop.scene],
      ['Location', prop.location],
      ['Tags', prop.tags?.join(', ')],
      ['Manufacturer', prop.manufacturer],
      ['Model', prop.model],
      ['Serial Number', prop.serialNumber],
      ['Color', prop.color],
      ['Period', prop.period],
      ['Style', prop.style],
      ['Condition', prop.condition],
    ].filter(([, value]) => value !== undefined && value !== null && value !== '');
    const detailsHtml = details.map(([label, value]) =>
      `<tr><td class='detail-label'>${label}</td><td class='detail-value'>${value}</td></tr>`
    ).join('');
    // Digital assets/videos
    let assetsHtml = '';
    if (prop.digitalAssets && prop.digitalAssets.length > 0) {
      assetsHtml += `<div class='assets-section'><h4>Files & Documents</h4><ul>`;
      assetsHtml += prop.digitalAssets.map(asset =>
        `<li><a href='${asset.url}' target='_blank'>${asset.name || asset.title || asset.url}</a></li>`
      ).join('');
      assetsHtml += `</ul></div>`;
    }
    if (prop.videos && prop.videos.length > 0) {
      assetsHtml += `<div class='assets-section'><h4>Videos</h4><ul>`;
      assetsHtml += prop.videos.map(video =>
        `<li><a href='${video.url}' target='_blank'>${video.name || video.title || video.url}</a></li>`
      ).join('');
      assetsHtml += `</ul></div>`;
    }
    // 50/50 split layout
    const isDummyImg = !mainImg || mainImg.startsWith('https://example.com/');
    const html = `
      <div class='page'>
        <div class='header'>
          ${logoUrl ? `<img src='${logoUrl}' class='logo' /><br/>` : ''}
          ${header ? `<div>${header}</div>` : ''}
          <div style='font-size:1.3em;font-weight:700;'>${options.title || ''}</div>
        </div>
        <div class='split-container ${isLandscape ? 'landscape' : 'portrait'}'>
          <div class='split-left'>
            ${!isDummyImg
              ? `<img class='main-img' src='${mainImg}' alt='Main image' />`
              : `<div class='main-img placeholder-img'>No Image</div>`
            }
            ${galleryImgs.length > 0 ? `<div class='gallery-row'>${galleryImgs.map(img => `<img src='${img.url}' alt='Gallery image' class='gallery-img' />`).join('')}</div>` : ''}
          </div>
          <div class='split-right'>
            <div class='prop-title'>${prop.name || ''}</div>
            <div class='badges'>
              ${prop.category ? badge(prop.category, '#1976d2') : ''}
              ${prop.status ? badge(prop.status, '#8e24aa') : ''}
            </div>
            ${prop.description ? `<div class='desc'>${prop.description}</div>` : ''}
            <table class='details-table'>${detailsHtml}</table>
            ${assetsHtml}
          </div>
        </div>
        <div class='footer'>
          ${footer ? footer : ''}
          <span style='float:right;font-size:0.95em;color:#888;'>Page ${idx + 2} of ${props.length + 1}</span>
        </div>
      </div>
    `;
    console.log('Prop page HTML for', prop.name, ':', html);
    return html;
  });
  // CSS for catalog look
  const catalogCss = `
    <style>
      body { background: #f0f0f0; font-family: 'Helvetica Neue', Arial, sans-serif; color: #222; margin: 0; padding: 0; }
      .page { page-break-after: always; min-height: ${pageHeight}px; min-width: ${pageWidth}px; max-width: ${pageWidth}px; max-height: ${pageHeight}px; margin: 0 auto 32px auto; background: #fff; border: 2px solid #111; border-radius: 12px; box-shadow: 0 8px 32px #0002; display: flex; flex-direction: column; justify-content: space-between; padding: 0; }
      .header { text-align: left; padding: 32px 48px 12px 48px; font-size: 1.1em; color: #555; border-bottom: 1px solid #eee; background: #fff; }
      .footer { text-align: right; padding: 12px 48px 32px 48px; font-size: 1em; color: #555; border-top: 1px solid #eee; background: #fff; }
      .logo { max-height: 48px; margin-bottom: 8px; }
      .toc-title { font-size: 2.2em; font-weight: bold; margin-bottom: 8px; }
      .toc-header { font-size: 1.1em; color: #888; margin-bottom: 16px; }
      .toc-content { padding: 32px 48px; }
      .toc-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      .toc-table th, .toc-table td { border-bottom: 1px solid #eee; padding: 8px 12px; text-align: left; font-size: 1.1em; }
      .toc-table th { color: #1976d2; font-weight: 700; }
      .toc-table td:first-child { width: 60px; text-align: center; }
      .split-container { display: flex; flex-direction: row; width: 100%; height: 100%; }
      .split-container.portrait { flex-direction: column; }
      .split-left, .split-right { flex: 1; padding: 48px; box-sizing: border-box; }
      .split-left { display: flex; flex-direction: column; align-items: center; justify-content: center; }
      .main-img { width: 100%; max-width: 340px; max-height: 340px; border-radius: 16px; box-shadow: 0 2px 12px #0001; border: 1px solid #eee; margin-bottom: 24px; }
      .gallery-row { display: flex; gap: 12px; margin-top: 8px; }
      .gallery-img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
      .split-right { display: flex; flex-direction: column; justify-content: flex-start; }
      .prop-title { font-size: 2em; font-weight: bold; margin-bottom: 12px; }
      .badges { margin-bottom: 16px; }
      .desc { font-size: 1.15em; margin-bottom: 18px; color: #444; }
      .details-table { width: 100%; border-collapse: collapse; margin-bottom: 18px; }
      .details-table td { padding: 6px 10px; font-size: 1.05em; }
      .detail-label { color: #888; font-weight: 600; width: 120px; }
      .detail-value { color: #222; font-weight: 400; }
      .assets-section { margin-top: 18px; }
      .assets-section h4 { margin: 0 0 8px 0; font-size: 1.1em; color: #2a2a2a; }
      .assets-section ul { padding-left: 18px; }
      .assets-section li { margin-bottom: 6px; }
      .placeholder-img {
        width: 100%;
        max-width: 340px;
        max-height: 340px;
        height: 200px;
        border-radius: 16px;
        background: #eee;
        color: #888;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
        border: 1px solid #ccc;
        margin-bottom: 24px;
      }
      @media print { .page { page-break-after: always; } }
    </style>
  `;
  // Combine all pages
  return `
    <html><head><meta charset='UTF-8'><title>${options.title || 'Props List'}</title>
    ${catalogCss}
    </head><body>
      ${tocHtml}
      ${propPages.join('')}
    </body></html>
  `;
}

const PropsPdfExportPage: React.FC = () => {
  const [pdfOptions, setPdfOptions] = useState<PdfGenerationOptions>(defaultPdfOptions);
  const [logo, setLogo] = useState<File | null>(null);
  const [header, setHeader] = useState('');
  const [footer, setFooter] = useState('');
  const [ordering, setOrdering] = useState<'act_scene' | 'alphabetical'>('act_scene');
  const [showPreview, setShowPreview] = useState(false);
  const [previewUrl, setPreviewUrl] = useState<string | null>(null);
  const logoUrlRef = useRef<string | undefined>(undefined);
  const { service } = useFirebase();
  const { currentShowId } = useShowSelection();
  const [props, setProps] = useState<Prop[]>([]);
  const [showTitle, setShowTitle] = useState<string>('');
  const [loading, setLoading] = useState(true);
  const [pageHtmls, setPageHtmls] = useState<string[]>([]);
  const [currentPage, setCurrentPage] = useState(0);
  const previewNavRef = useRef<HTMLDivElement>(null);
  const [iframeUrl, setIframeUrl] = useState<string | null>(null);
  // Add state for fullHtml at the top
  const [fullHtml, setFullHtml] = useState('');

  useEffect(() => {
    if (!currentShowId) {
      setProps([]);
      setShowTitle('');
      setLoading(false);
      return;
    }
    setLoading(true);
    let unsubShow: (() => void) | undefined;
    let unsubProps: (() => void) | undefined;
    unsubShow = service.listenToDocument('shows/' + currentShowId, doc => {
      setShowTitle(doc.data?.name || '');
      setPdfOptions(opt => ({ ...opt, title: doc.data?.name || '' }));
    });
    unsubProps = service.listenToCollection('props', (data) => {
      setProps(data.filter(doc => doc.data.showId === currentShowId).map(doc => ({ ...(doc.data as Prop), id: doc.id })));
      setLoading(false);
    }, err => {
      setProps([]);
      setLoading(false);
    });
    return () => { if (unsubShow) unsubShow(); if (unsubProps) unsubProps(); };
  }, [service, currentShowId]);

  useEffect(() => {
    if (showPreview && previewNavRef.current) {
      previewNavRef.current.focus();
    }
  }, [showPreview]);

  const handlePreviewKeyDown = (e: React.KeyboardEvent<HTMLDivElement>) => {
    if (!showPreview || pageHtmls.length === 0) return;
    if (e.key === 'ArrowLeft') {
      setCurrentPage(p => Math.max(0, p - 1));
    } else if (e.key === 'ArrowRight') {
      setCurrentPage(p => Math.min(pageHtmls.length - 1, p + 1));
    }
  };

  const handlePreview = async () => {
    if (!props || props.length === 0) return;
    console.log('Props count for PDF preview:', props.length);
    let logoUrl: string | undefined = undefined;
    if (logo) {
      logoUrl = URL.createObjectURL(logo);
      if (logoUrlRef.current) URL.revokeObjectURL(logoUrlRef.current);
      logoUrlRef.current = logoUrl;
    }
    let sortedProps = [...props];
    if (ordering === 'alphabetical') {
      sortedProps.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
    } else {
      sortedProps.sort((a, b) => {
        if ((a.act ?? 0) !== (b.act ?? 0)) return (a.act ?? 0) - (b.act ?? 0);
        if ((a.scene ?? 0) !== (b.scene ?? 0)) return (a.scene ?? 0) - (b.scene ?? 0);
        return (a.name || '').localeCompare(b.name || '');
      });
    }
    const html = generatePropsListHtml(sortedProps, { ...pdfOptions, title: showTitle }, header, footer, logoUrl);
    setFullHtml(html);
    console.log('Generated PDF HTML:', html); // DEBUG: Output the generated HTML
    // In handlePreview, instead of splitting into pages, just set pageHtmls to a single full HTML document:
    setPageHtmls([html]);
    setCurrentPage(0);
    setShowPreview(true);
    // The rest of the logic remains the same.
    const blob = new Blob([html], { type: 'text/html' });
    if (previewUrl) URL.revokeObjectURL(previewUrl);
    setPreviewUrl(URL.createObjectURL(blob));
  };

  const handleDownload = () => {
    if (!fullHtml) return;
    // Create a hidden container
    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.left = '-9999px';
    container.innerHTML = fullHtml;
    document.body.appendChild(container);

    html2pdf()
      .from(container)
      .set({
        margin: 0,
        filename: `${showTitle || 'props-catalog'}.pdf`,
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'pt', format: 'a4', orientation: pdfOptions.layout || 'portrait' }
      })
      .save()
      .then(() => {
        document.body.removeChild(container);
      });
  };

  // Manage Blob URL for current page
  useEffect(() => {
    if (!showPreview || pageHtmls.length === 0) {
      setIframeUrl(null);
      return;
    }
    const html = pageHtmls[currentPage];
    if (!html) {
      setIframeUrl(null);
      return;
    }
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    setIframeUrl(url);
    return () => {
      URL.revokeObjectURL(url);
    };
  }, [showPreview, pageHtmls, currentPage]);

  return (
    <DashboardLayout>
      {loading ? (
        <div className="flex flex-col items-center justify-center h-96 text-pb-primary text-xl">Loading props and show info...</div>
      ) : (
        <div className="flex flex-col md:flex-row gap-8 w-full">
          {/* Left panel: options */}
          <div className="w-full md:w-1/2 max-w-xl">
            <h2 className="text-2xl font-bold mb-4">Export Props List to PDF</h2>
            <div className="bg-pb-darker/50 rounded-2xl border border-pb-primary/20 shadow-lg p-5 space-y-6">
              {/* Section: Content */}
              <div>
                <div className="flex items-center justify-between mb-2">
                  <label className="font-semibold">Fields to include</label>
                  <div className="flex gap-2">
                    <button
                      type="button"
                      className="text-xs px-2 py-1 rounded bg-pb-primary/20 text-white hover:bg-pb-primary/30"
                      onClick={() => setPdfOptions(opt => ({ ...opt, selectedFields: Object.fromEntries(allFields.map(f => [f, true])) as any }))}
                    >Select all</button>
                    <button
                      type="button"
                      className="text-xs px-2 py-1 rounded bg-pb-primary/10 text-white hover:bg-pb-primary/20"
                      onClick={() => setPdfOptions(opt => ({ ...opt, selectedFields: Object.fromEntries(allFields.map(f => [f, false])) as any }))}
                    >Clear</button>
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-2 max-h-56 overflow-y-auto pr-1">
                  {allFields.map(f => (
                    <label key={f} className="text-sm flex items-center gap-2">
                      <input
                        type="checkbox"
                        checked={pdfOptions.selectedFields[f]}
                        onChange={e => setPdfOptions(opt => ({
                          ...opt,
                          selectedFields: { ...opt.selectedFields, [f]: e.target.checked }
                        }))}
                        className="accent-pb-primary bg-pb-darker border border-pb-primary/40 rounded focus:ring-2 focus:ring-pb-primary"
                      />
                      {f.charAt(0).toUpperCase() + f.slice(1)}
                    </label>
                  ))}
                </div>
              </div>

              {/* Section: Branding */}
              <div className="grid grid-cols-1 gap-3">
                <div>
                  <label className="font-semibold block mb-1">Logo</label>
                  <input
                    type="file" accept="image/*"
                    onChange={e => setLogo(e.target.files?.[0] || null)}
                    className="block w-full text-sm text-pb-gray file:bg-pb-primary file:text-white file:rounded-md file:border-0 file:px-3 file:py-1 file:mr-3 file:cursor-pointer bg-pb-darker border border-pb-primary/30 rounded-md focus:outline-none focus:ring-2 focus:ring-pb-primary"
                  />
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div>
                    <label className="font-semibold block mb-1">Header Text</label>
                    <input type="text" className="w-full border border-pb-primary/30 rounded-md px-3 py-2 bg-pb-darker text-white placeholder:text-pb-gray focus:outline-none focus:ring-2 focus:ring-pb-primary" value={header} onChange={e => setHeader(e.target.value)} placeholder="Header..." />
                  </div>
                  <div>
                    <label className="font-semibold block mb-1">Footer Text</label>
                    <input type="text" className="w-full border border-pb-primary/30 rounded-md px-3 py-2 bg-pb-darker text-white placeholder:text-pb-gray focus:outline-none focus:ring-2 focus:ring-pb-primary" value={footer} onChange={e => setFooter(e.target.value)} placeholder="Footer..." />
                  </div>
                </div>
              </div>

              {/* Section: Layout */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                  <label className="font-semibold block mb-1">Order Props By</label>
                  <select className="w-full border border-pb-primary/30 rounded-md px-3 py-2 bg-pb-darker text-white focus:outline-none focus:ring-2 focus:ring-pb-primary" value={ordering} onChange={e => setOrdering(e.target.value as any)}>
                    <option value="act_scene">Act & Scene</option>
                    <option value="alphabetical">Alphabetical</option>
                  </select>
                </div>
                <div>
                  <label className="font-semibold block mb-1">Page Orientation</label>
                  <select
                    className="w-full border border-pb-primary/30 rounded-md px-3 py-2 bg-pb-darker text-white focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    value={pdfOptions.layout}
                    onChange={e => setPdfOptions({ ...pdfOptions, layout: e.target.value as 'portrait' | 'landscape' })}
                  >
                    <option value="portrait">Portrait (A4)</option>
                    <option value="landscape">Landscape (A4)</option>
                  </select>
                </div>
              </div>

              {/* Section: QR toggles */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <label className="flex items-center justify-between bg-pb-darker/40 border border-pb-primary/20 rounded-md px-3 py-2">
                  <span className="text-sm">Include Files QR</span>
                  <input type="checkbox" checked={pdfOptions.showFilesQR} onChange={e => setPdfOptions({ ...pdfOptions, showFilesQR: e.target.checked })} className="accent-pb-primary" />
                </label>
                <label className="flex items-center justify-between bg-pb-darker/40 border border-pb-primary/20 rounded-md px-3 py-2">
                  <span className="text-sm">Include Videos QR</span>
                  <input type="checkbox" checked={pdfOptions.showVideosQR} onChange={e => setPdfOptions({ ...pdfOptions, showVideosQR: e.target.checked })} className="accent-pb-primary" />
                </label>
              </div>

              {/* Actions */}
              <div className="flex gap-3 pt-1">
                <button
                  className="px-4 py-2 rounded-md bg-pb-primary text-white font-semibold shadow hover:bg-pb-secondary transition-colors w-full"
                  onClick={handlePreview}
                >
                  Preview PDF
                </button>
                {showPreview && (
                  <button
                    className="px-4 py-2 rounded-md bg-pb-accent text-white font-semibold shadow hover:bg-pb-secondary transition-colors w-full"
                    onClick={handleDownload}
                  >
                    Download PDF
                  </button>
                )}
              </div>
            </div>
          </div>
          {/* Right panel: PDF preview */}
          <div className="flex-1 flex flex-col items-center w-full overflow-auto bg-[#18183a]">
            {showPreview && pageHtmls.length > 0 && (
              <div
                ref={previewNavRef}
                tabIndex={0}
                onKeyDown={handlePreviewKeyDown}
                className="outline-none focus:ring-2 focus:ring-pb-primary rounded"
                style={{ width: '100%' }}
              >
                <div className="flex justify-center items-center w-full h-full min-h-[900px] p-8">
                  <div className="relative flex justify-center items-center w-full" style={{ minHeight: '900px' }}>
                    {iframeUrl ? (
                      <iframe
                        src={iframeUrl}
                        title="PDF Preview"
                        className="bg-white rounded-lg shadow-2xl border border-gray-300"
                        style={{
                          width: pdfOptions.layout === 'landscape' ? '1123px' : '794px',
                          height: pdfOptions.layout === 'landscape' ? '900px' : '1800px',
                          margin: '0 auto',
                          background: 'white',
                          boxShadow: '0 8px 32px #0003',
                          borderRadius: '12px',
                          border: '1px solid #e0e0e0',
                          display: 'block',
                          // Remove zoom and overflow
                        }}
                        scrolling="auto"
                      />
                    ) : (
                      <div className="text-white text-lg">PDF page could not be loaded.</div>
                    )}
                  </div>
                </div>
                <div className="flex items-center justify-center gap-4 mt-2">
                  <button
                    className="btn btn-secondary px-4 py-2 rounded disabled:opacity-50"
                    onClick={() => setCurrentPage(p => Math.max(0, p - 1))}
                    disabled={currentPage === 0}
                  >Previous</button>
                  <span className="text-white text-lg">Page {currentPage + 1} of {pageHtmls.length}</span>
                  <button
                    className="btn btn-secondary px-4 py-2 rounded disabled:opacity-50"
                    onClick={() => setCurrentPage(p => Math.min(pageHtmls.length - 1, p + 1))}
                    disabled={currentPage === pageHtmls.length - 1}
                  >Next</button>
                </div>
              </div>
            )}
          </div>
        </div>
      )}
    </DashboardLayout>
  );
};

export default PropsPdfExportPage; 
```

- Restyled the PDF export form at `/props/pdf-export`:
  - Grouped controls into sections (Fields, Branding, Layout, QR toggles) within a card-like container with rounded corners, subtle border, and shadow.
  - Added Select all / Clear actions for fields.
  - Upgraded inputs to consistent rounded-md, better spacing, and focus rings.
  - Two-column responsive layout for related inputs, preserving preview/download actions.

Files updated:
- `web-app/src/pages/PropsPdfExportPage.tsx`

If you want a compact variant or icons on section headers, I can add them.

---

**User**

CAN WE CHECK THE REST OF THE WEB-APP  to ensure that all pages are using the space available

---

**Cursor**

```typescriptreact
import React, { useState, useRef } from 'react';
import { useWebAuth } from '../contexts/WebAuthContext';
import DashboardLayout from '../PropsBibleHomepage';
import { storage } from '../firebase';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';

const ProfilePage: React.FC = () => {
  const { user, userProfile, updateUserProfile, refreshProfile } = useWebAuth();
  const [displayName, setDisplayName] = useState(userProfile?.displayName || user?.displayName || '');
  const [photoURL, setPhotoURL] = useState(userProfile?.photoURL || '');
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      await updateUserProfile({ displayName, photoURL });
      await refreshProfile();
    } catch (err: any) {
      setError(err.message || 'Failed to update profile');
    } finally {
      setSaving(false);
    }
  };

  const handlePhotoChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !user) return;
    if (!file.type.match('image.*')) {
      setError('Please select an image file');
      return;
    }
    if (file.size > 5 * 1024 * 1024) {
      setError('Image size should be less than 5MB');
      return;
    }
    setSaving(true);
    setError(null);
    try {
      const storageRef = ref(storage, `profile_images/${user.uid}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      setPhotoURL(url);
      await updateUserProfile({ photoURL: url });
      await refreshProfile();
    } catch (err: any) {
      setError('Failed to upload photo');
    } finally {
      setSaving(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="w-full max-w-5xl mx-auto py-10 px-4">
        <h1 className="text-2xl font-bold mb-6 text-white">Profile Details</h1>
        <form onSubmit={handleSave} className="bg-pb-darker/60 rounded-2xl p-6 border border-pb-primary/20">
          <div className="mb-6 grid grid-cols-1 md:grid-cols-[120px,1fr] gap-6 items-center">
            <div className="relative w-24 h-24">
              <img
                src={photoURL || '/public/icon.png'}
                alt="Profile"
                className="w-24 h-24 rounded-full object-cover border-2 border-pb-primary bg-pb-darker"
              />
              <button
                type="button"
                className="absolute bottom-0 right-0 bg-pb-primary text-white rounded-full p-1 shadow hover:bg-pb-secondary"
                onClick={() => fileInputRef.current?.click()}
                title="Change photo"
              >
                ✏️
              </button>
              <input
                type="file"
                accept="image/*"
                ref={fileInputRef}
                className="hidden"
                onChange={handlePhotoChange}
              />
            </div>
            <div className="text-pb-gray text-sm">Profile Photo</div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
            <label className="block text-pb-gray text-xs mb-1">Name</label>
            <input
              className="w-full p-2 rounded bg-pb-darker text-white border border-pb-gray focus:outline-none focus:border-pb-primary"
              value={displayName}
              onChange={e => setDisplayName(e.target.value)}
              required
            />
            </div>
            <div>
            <span className="block text-pb-gray text-xs mb-1">Email</span>
            <span className="text-lg font-semibold text-white">{userProfile?.email || user?.email || 'N/A'}</span>
            </div>
            <div>
            <span className="block text-pb-gray text-xs mb-1">Organizations</span>
            <span className="text-lg font-semibold text-white">{userProfile?.organizations?.join(', ') || 'N/A'}</span>
            </div>
            <div>
            <span className="block text-pb-gray text-xs mb-1">Preferences</span>
            <span className="text-sm text-white bg-pb-primary/10 rounded p-2 block font-mono">
              {userProfile?.preferences ? JSON.stringify(userProfile.preferences, null, 2) : 'N/A'}
            </span>
            </div>
            <div>
            <span className="block text-pb-gray text-xs mb-1">Last Login</span>
            <span className="text-lg font-semibold text-white">{userProfile?.lastLogin ? new Date(userProfile.lastLogin).toLocaleString() : 'N/A'}</span>
            </div>
            <div>
            <span className="block text-pb-gray text-xs mb-1">Created At</span>
            <span className="text-lg font-semibold text-white">{userProfile?.createdAt ? new Date(userProfile.createdAt).toLocaleString() : 'N/A'}</span>
            </div>
          </div>
          {userProfile?.groups && (
            <div className="mb-4">
              <span className="block text-pb-gray text-xs mb-1">Groups</span>
              <span className="text-sm text-white bg-pb-primary/10 rounded p-2 block font-mono">
                {JSON.stringify(userProfile.groups, null, 2)}
              </span>
            </div>
          )}
          {error && <div className="mb-2 text-red-400 font-semibold">{error}</div>}
          <button
            type="submit"
            className="px-4 py-2 rounded bg-pb-primary text-white font-semibold shadow hover:bg-pb-secondary transition-colors"
            disabled={saving}
          >
            {saving ? 'Saving...' : 'Save Changes'}
          </button>
        </form>
      </div>
    </DashboardLayout>
  );
};

export default ProfilePage; 
```

```typescriptreact
import React, { useState, useEffect } from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { useWebAuth } from './contexts/WebAuthContext';
import { useFirebase, FirebaseContextType } from './contexts/FirebaseContext';
import type { Show } from '../types/Show.ts';
import { useNavigate } from 'react-router-dom';
import { Plus } from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';

const ShowsListPage: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [shows, setShows] = useState<Show[]>([]);
  const { userProfile, user } = useWebAuth();
  const { service: firebaseService, isInitialized, error: firebaseInitError }: FirebaseContextType = useFirebase();
  const navigate = useNavigate();
  const { currentShowId, setCurrentShowId } = useShowSelection();

  useEffect(() => {
    if (!isInitialized) {
      setLoading(true);
      setError("Firebase not initialized.");
      return;
    }

    if (firebaseInitError) {
      setError(`Firebase Initialization Error: ${firebaseInitError.message}`);
      setLoading(false);
      return;
    }

    setLoading(true);
    setError(null);

    const unsubscribe = firebaseService.listenToCollection<Show>(
      'shows',
      (data) => {
        const showList = data.map(doc => ({ ...doc.data, id: doc.id }));
        setShows(showList);
        setLoading(false);
      },
      (err: Error) => {
        console.error("Error fetching shows:", err);
        setError(`Failed to load shows: ${err.message}. Please check your network connection and Firebase permissions.`);
        setLoading(false);
      }
    );

    return () => unsubscribe();
  }, [firebaseService, isInitialized, firebaseInitError]);

  const handleAddShow = () => {
    // TODO: Route to add show form
    alert('Add Show (not implemented)');
  };

  return (
    <DashboardLayout>
      <div className="mb-4 p-2 bg-pb-primary/10 rounded text-xs text-pb-gray">
        <div>User UID: {user?.uid || 'N/A'}</div>
        <div>User Profile Source: /users/{user?.uid}</div>
        <div>Firestore Rules Check: /userProfiles/{user?.uid}</div>
        <div>Groups: {JSON.stringify(userProfile?.groups)}</div>
        <div>Role: {userProfile?.role}</div>
      </div>

      <div className="relative min-h-[70vh] flex flex-col justify-center items-center bg-gradient-to-br from-pb-primary/40 via-pb-darker/80 to-pb-accent/30 rounded-xl shadow-xl p-6">
        <div className="flex w-full justify-between items-center mb-6">
          <h2 className="text-2xl font-bold self-start">Shows List</h2>
          <button
            onClick={() => navigate('/shows/new')}
            className="flex items-center gap-2 px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white shadow transition focus:outline-none focus:ring-2 focus:ring-pb-primary/50"
            aria-label="Add New Show"
          >
            <Plus className="w-4 h-4" />
            <span className="hidden sm:inline">Add Show</span>
          </button>
        </div>
        {loading ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="animate-spin h-10 w-10 text-pb-primary mb-2" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" /><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" /></svg>
            <div className="text-pb-gray mt-2">Loading shows...</div>
          </div>
        ) : error ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-red-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
            <div className="text-red-500 font-semibold">{error}</div>
          </div>
        ) : shows.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-pb-gray mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" /></svg>
            <div className="text-pb-gray">No shows found.</div>
          </div>
        ) : (
          <div className="w-full max-w-7xl mx-auto px-4">
            {shows.map((show) => (
              <div
                key={show.id}
                className={`bg-pb-darker/60 rounded-xl shadow-lg p-4 mb-4 cursor-pointer hover:bg-pb-primary/30 transition-colors${currentShowId === show.id ? ' border-2 border-pb-primary' : ''}`}
                onClick={() => navigate(`/shows/${show.id}`)}
                tabIndex={0}
                role="button"
                aria-label={`View details for ${show.name}`}
                onKeyDown={e => { if (e.key === 'Enter' || e.key === ' ') navigate(`/shows/${show.id}`); }}
              >
                <div className="flex justify-between items-center">
                  <div>
                    <div className="font-bold text-lg text-white mb-1">{show.name}</div>
                    {show.description && <div className="text-pb-gray text-sm mb-1 line-clamp-2">{show.description}</div>}
                    <div className="text-xs text-pb-primary/80">
                      {show.startDate && (
                        <span>Start: {show.startDate.toDate ? show.startDate.toDate().toLocaleDateString() : String(show.startDate)}</span>
                      )}
                      {show.endDate && (
                        <span className="ml-4">End: {show.endDate.toDate ? show.endDate.toDate().toLocaleDateString() : String(show.endDate)}</span>
                      )}
                    </div>
                  </div>
                  <button
                    type="button"
                    onClick={e => { e.stopPropagation(); setCurrentShowId(show.id); }}
                    className={`ml-4 px-3 py-1 rounded ${currentShowId === show.id ? 'bg-pb-primary text-white' : 'bg-pb-primary/20 text-pb-primary hover:bg-pb-primary/40'} font-semibold text-xs transition`}
                    aria-label={currentShowId === show.id ? 'Current Show' : 'Select Show'}
                  >
                    {currentShowId === show.id ? 'Selected' : 'Select'}
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </DashboardLayout>
  );
};

export default ShowsListPage; 
```

```typescriptreact
import React, { useState, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories, PropCategory, PropImage, DigitalAsset } from '../../shared/types/props';
import { Plus, UploadCloud, Trash2 } from 'lucide-react';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const initialForm: PropFormData = {
  name: '',
  price: 0,
  description: '',
  category: propCategories[0],
  quantity: 1,
  source: 'bought',
  status: 'available_in_storage',
  images: [],
  digitalAssets: [],
  showId: '',
};

const AddPropPage: React.FC = () => {
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData>(initialForm);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      await firebaseService.addDocument('props', form);
      setSaving(false);
      navigate('/props');
    } catch (err: any) {
      setError(err.message || 'Failed to add prop.');
      setSaving(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Add Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="in">In</option>
                <option value="maintenance">Maintenance</option>
                <option value="retired">Retired</option>
                <option value="available">Available</option>
              </select>
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => ({ ...prev, images: imgs }))}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => ({ ...prev, digitalAssets: assets }))}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Add Prop'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default AddPropPage; 
```

```typescriptreact
import React, { useState } from 'react';
import DashboardLayout from '../PropsBibleHomepage';
import { useFirebase } from '../contexts/FirebaseContext';
import { useNavigate } from 'react-router-dom';
import { Plus, Trash2, UploadCloud, Users, UserPlus } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import EntitySelect from '../components/EntitySelect';

// Add types for show state
interface Act {
  name: string;
  scenes: string[];
}
interface TeamMember {
  email: string;
  role: string;
  userId?: string;
  name?: string;
  avatarUrl?: string;
  status?: 'registered' | 'invited' | 'pending';
}
interface ShowFormState {
  name: string;
  description: string;
  startDate: string;
  endDate: string;
  logoImage: File | null;
  acts: Act[];
  team: TeamMember[];
  stageManager: string;
  stageManagerEmail: string;
  propsSupervisor: string;
  propsSupervisorEmail: string;
  productionCompany: string;
  venues: string[];
  isTouringShow: boolean;
  status: string;
  rehearsalAddresses: string[];
  storageAddresses: string[];
  rehearsalStartDate: string;
  techWeekStartDate: string;
  firstPerformanceDate: string;
  pressNightDate: string;
  venueIds?: string[];
  rehearsalAddressIds?: string[];
  storageAddressIds?: string[];
}

const statusOptions = [
  { value: 'planning', label: 'Planning' },
  { value: 'active', label: 'Active' },
  { value: 'completed', label: 'Completed' },
];

const AddShowPage: React.FC = () => {
  const [show, setShow] = useState<ShowFormState>({
    name: '',
    description: '',
    startDate: '',
    endDate: '',
    logoImage: null,
    acts: [{ name: '', scenes: [''] }],
    team: [{ email: '', role: '', status: undefined }],
    stageManager: '',
    stageManagerEmail: '',
    propsSupervisor: '',
    propsSupervisorEmail: '',
    productionCompany: '',
    venues: [''],
    isTouringShow: false,
    status: 'planning',
    rehearsalAddresses: [''],
    storageAddresses: [''],
    rehearsalStartDate: '',
    techWeekStartDate: '',
    firstPerformanceDate: '',
    pressNightDate: '',
    venueIds: [],
    rehearsalAddressIds: [],
    storageAddressIds: [],
  });
  const [logoPreview, setLogoPreview] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const { service: firebaseService } = useFirebase();
  const [activeTab, setActiveTab] = useState<'details' | 'team'>('details');

  // Mock user lookup function
  const mockUserLookup = async (email: string) => {
    // Simulate a lookup: if email contains 'registered', return a mock user
    if (email.includes('registered')) {
      return {
        userId: 'user123',
        name: 'Registered User',
        avatarUrl: 'https://api.dicebear.com/7.x/identicon/svg?seed=' + encodeURIComponent(email),
        status: 'registered' as const,
      };
    }
    return null;
  };

  // Handle input changes
  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    if (type === 'checkbox' && 'checked' in e.target) {
      setShow(prev => ({ ...prev, [name]: (e.target as HTMLInputElement).checked }));
    } else {
      setShow(prev => ({ ...prev, [name]: value }));
    }
  };

  // Handle logo upload
  const handleLogoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0] || null;
    setShow(prev => ({ ...prev, logoImage: file }));
    if (file) {
      setLogoPreview(URL.createObjectURL(file));
    } else {
      setLogoPreview(null);
    }
  };

  // Handle team array
  const handleTeamChange = async (idx: number, key: string, value: string) => {
    if (key === 'email') {
      // Lookup user on email change
      const user = await mockUserLookup(value);
      setShow(prev => ({
        ...prev,
        team: prev.team.map((member, i) =>
          i === idx
            ? {
                ...member,
                email: value,
                userId: user?.userId,
                name: user?.name,
                avatarUrl: user?.avatarUrl,
                status: user ? 'registered' : 'invited',
              }
            : member
        ),
      }));
    } else {
      setShow(prev => ({
        ...prev,
        team: prev.team.map((member, i) => i === idx ? { ...member, [key]: value } : member),
      }));
    }
  };
  const handleAddTeam = () => {
    setShow(prev => ({ ...prev, team: [...prev.team, { email: '', role: '', status: undefined }] }));
  };
  const handleRemoveTeam = (idx: number) => {
    setShow(prev => ({ ...prev, team: prev.team.filter((_, i) => i !== idx) }));
  };
  const handleInvite = (idx: number) => {
    setShow(prev => ({
      ...prev,
      team: prev.team.map((member, i) =>
        i === idx ? { ...member, status: 'pending' } : member
      ),
    }));
    // Here you would trigger an invite email/send to backend
  };

  // Handle acts (array of objects)
  const handleActNameChange = (idx: number, value: string) => {
    setShow(prev => ({
      ...prev,
      acts: prev.acts.map((act, i) => i === idx ? { ...act, name: value } : act),
    }));
  };
  const handleAddAct = () => {
    setShow(prev => ({ ...prev, acts: [...prev.acts, { name: '', scenes: [''] }] }));
  };
  const handleRemoveAct = (idx: number) => {
    setShow(prev => ({ ...prev, acts: prev.acts.filter((_, i) => i !== idx) }));
  };

  // Handle scenes within an act
  const handleSceneChange = (actIdx: number, sceneIdx: number, value: string) => {
    setShow(prev => ({
      ...prev,
      acts: prev.acts.map((act, i) =>
        i === actIdx
          ? { ...act, scenes: act.scenes.map((scene, j) => j === sceneIdx ? value : scene) }
          : act
      ),
    }));
  };
  const handleAddScene = (actIdx: number) => {
    setShow(prev => ({
      ...prev,
      acts: prev.acts.map((act, i) =>
        i === actIdx ? { ...act, scenes: [...act.scenes, ''] } : act
      ),
    }));
  };
  const handleRemoveScene = (actIdx: number, sceneIdx: number) => {
    setShow(prev => ({
      ...prev,
      acts: prev.acts.map((act, i) =>
        i === actIdx ? { ...act, scenes: act.scenes.filter((_, j) => j !== sceneIdx) } : act
      ),
    }));
  };

  // Handle form submit
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      let logoUrl = '';
      if (show.logoImage) {
        // Upload logo to Firebase Storage
        const uploadResult = await firebaseService.uploadFile(`show_logos/${Date.now()}_${show.logoImage.name}`, show.logoImage) as unknown as { url: string } | undefined;
        if (uploadResult && uploadResult.url) {
          logoUrl = uploadResult.url;
        }
      }
      const showData = {
        ...show,
        logoImage: logoUrl ? { url: logoUrl } : undefined,
        startDate: show.startDate,
        endDate: show.endDate,
      };
      const docRef = await firebaseService.addDocument('shows', showData);
      setLoading(false);
      navigate(`/shows/${docRef.id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to add show.');
      setLoading(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="flex-1 flex flex-col min-h-screen">
        <form onSubmit={handleSubmit} className="w-full max-w-6xl mx-auto bg-pb-darker/60 rounded-xl shadow-lg p-8 my-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Add New Show</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}

          {/* Tabs */}
          <div className="flex gap-2 mb-6">
            <button
              type="button"
              className={`px-4 py-2 rounded-t-lg font-semibold transition-colors focus:outline-none ${activeTab === 'details' ? 'bg-pb-primary text-white' : 'bg-pb-darker text-pb-primary hover:bg-pb-primary/10'}`}
              onClick={() => setActiveTab('details')}
              aria-selected={activeTab === 'details'}
            >
              Show Details
            </button>
            <button
              type="button"
              className={`px-4 py-2 rounded-t-lg font-semibold transition-colors focus:outline-none ${activeTab === 'team' ? 'bg-pb-primary text-white' : 'bg-pb-darker text-pb-primary hover:bg-pb-primary/10'}`}
              onClick={() => setActiveTab('team')}
              aria-selected={activeTab === 'team'}
            >
              <Users className="inline w-4 h-4 mr-1" /> Team & Collaborators
            </button>
          </div>

          <AnimatePresence mode="wait">
            {activeTab === 'details' && (
              <motion.div
                key="details"
                initial={{ opacity: 0, x: 40 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -40 }}
                transition={{ duration: 0.25 }}
                className="space-y-6"
              >
                {/* Logo Upload (moved into Show Details tab) */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Logo Image</label>
                  <div className="flex items-center gap-4">
                    <label className="flex items-center gap-2 cursor-pointer bg-pb-primary/20 hover:bg-pb-primary/40 px-4 py-2 rounded-lg text-pb-primary">
                      <UploadCloud className="w-5 h-5" />
                      <span>Upload</span>
                      <input type="file" accept="image/*" className="hidden" onChange={handleLogoChange} />
                    </label>
                    {logoPreview && (
                      <img src={logoPreview} alt="Logo Preview" className="w-16 h-16 object-cover rounded border border-pb-primary/30" />
                    )}
                  </div>
                </div>
                {/* Name */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Show Name *</label>
                  <input name="name" value={show.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary" />
                </div>
                {/* Description */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Description *</label>
                  <textarea name="description" value={show.description} onChange={handleChange} required rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary" />
                </div>
                {/* Dates */}
                <div className="flex flex-col md:flex-row gap-4">
                  <div className="flex-1">
                    <label className="block text-pb-gray mb-1 font-medium">Start Date *</label>
                    <input type="date" name="startDate" value={show.startDate} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary" />
                  </div>
                  <div className="flex-1">
                    <label className="block text-pb-gray mb-1 font-medium">End Date *</label>
                    <input type="date" name="endDate" value={show.endDate} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary" />
                  </div>
                </div>
                {/* Important Dates */}
                <fieldset className="mb-4 p-4 rounded-lg bg-pb-darker/40 border border-pb-primary/20">
                  <legend className="px-2 text-pb-primary font-semibold">Important Dates</legend>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-pb-gray mb-1 font-medium">Start of Rehearsal</label>
                      <input type="date" name="rehearsalStartDate" value={show.rehearsalStartDate} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    </div>
                    <div>
                      <label className="block text-pb-gray mb-1 font-medium">Start of Tech Week</label>
                      <input type="date" name="techWeekStartDate" value={show.techWeekStartDate} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    </div>
                    <div>
                      <label className="block text-pb-gray mb-1 font-medium">First Performance</label>
                      <input type="date" name="firstPerformanceDate" value={show.firstPerformanceDate} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    </div>
                    <div>
                      <label className="block text-pb-gray mb-1 font-medium">Press Night</label>
                      <input type="date" name="pressNightDate" value={show.pressNightDate} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    </div>
                  </div>
                </fieldset>
                {/* Acts & Scenes */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Acts & Scenes</label>
                  {show.acts.map((act, actIdx) => (
                    <div key={actIdx} className="mb-4 p-3 rounded bg-pb-darker/40 border border-pb-primary/20">
                      <div className="flex items-center gap-2 mb-2">
                        <input
                          value={act.name}
                          onChange={e => handleActNameChange(actIdx, e.target.value)}
                          placeholder="Act Name"
                          className="flex-1 rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                        />
                        <button type="button" onClick={() => handleRemoveAct(actIdx)} className="p-1 text-pb-accent hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                      </div>
                      <div className="ml-4">
                        <label className="block text-pb-gray mb-1 font-medium">Scenes</label>
                        {act.scenes.map((scene, sceneIdx) => (
                          <div key={sceneIdx} className="flex items-center gap-2 mb-2">
                            <input
                              value={scene}
                              onChange={e => handleSceneChange(actIdx, sceneIdx, e.target.value)}
                              placeholder={`Scene ${sceneIdx + 1}`}
                              className="flex-1 rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                            />
                            <button type="button" onClick={() => handleRemoveScene(actIdx, sceneIdx)} className="p-1 text-pb-accent hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                          </div>
                        ))}
                        <button type="button" onClick={() => handleAddScene(actIdx)} className="flex items-center gap-1 text-pb-primary hover:text-pb-accent mt-1"><Plus className="w-4 h-4" /> Add Scene</button>
                      </div>
                    </div>
                  ))}
                  <button type="button" onClick={handleAddAct} className="flex items-center gap-1 text-pb-primary hover:text-pb-accent mt-1"><Plus className="w-4 h-4" /> Add Act</button>
                </div>
                {/* Stage Manager & Props Supervisor */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-pb-gray mb-1 font-medium">Stage Manager</label>
                    <input name="stageManager" value={show.stageManager} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    <input name="stageManagerEmail" value={show.stageManagerEmail} onChange={handleChange} placeholder="Email" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white mt-2" />
                  </div>
                  <div>
                    <label className="block text-pb-gray mb-1 font-medium">Props Supervisor</label>
                    <input name="propsSupervisor" value={show.propsSupervisor} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    <input name="propsSupervisorEmail" value={show.propsSupervisorEmail} onChange={handleChange} placeholder="Email" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white mt-2" />
                  </div>
                </div>
                {/* Production Company */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Production Company</label>
                  <input name="productionCompany" value={show.productionCompany} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                </div>
                {/* Venues */}
                <EntitySelect
                  label="Venue(s)"
                  type="venue"
                  selectedIds={show.venueIds || []}
                  onChange={(ids) => setShow(prev => ({ ...prev, venueIds: ids }))}
                  allowMultiple={show.isTouringShow}
                />
                {/* Touring Status */}
                <div className="flex items-center gap-2">
                  <input type="checkbox" name="isTouringShow" checked={show.isTouringShow} onChange={handleChange} id="isTouringShow" className="accent-pb-primary" />
                  <label htmlFor="isTouringShow" className="text-pb-gray font-medium">Touring Show</label>
                </div>
                {/* Status */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Status</label>
                  <select name="status" value={show.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                    {statusOptions.map(opt => (
                      <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                  </select>
                </div>
                {/* Rehearsal Addresses */}
                <EntitySelect
                  label="Rehearsal Space(s)"
                  type="rehearsal"
                  selectedIds={show.rehearsalAddressIds || []}
                  onChange={(ids) => setShow(prev => ({ ...prev, rehearsalAddressIds: ids }))}
                  allowMultiple={true}
                />
                {/* Storage Addresses */}
                <EntitySelect
                  label="Storage Space(s)"
                  type="storage"
                  selectedIds={show.storageAddressIds || []}
                  onChange={(ids) => setShow(prev => ({ ...prev, storageAddressIds: ids }))}
                  allowMultiple={true}
                />
              </motion.div>
            )}
            {activeTab === 'team' && (
              <motion.div
                key="team"
                initial={{ opacity: 0, x: 40 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -40 }}
                transition={{ duration: 0.25 }}
                className="space-y-6"
              >
                {/* Team Members */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Team Members</label>
                  {show.team.map((member, idx) => (
                    <div key={idx} className="flex flex-col md:flex-row md:items-center gap-2 mb-4 p-3 rounded bg-pb-darker/40 border border-pb-primary/20">
                      <div className="flex-1 flex flex-col md:flex-row md:items-center gap-2">
                        <input
                          type="email"
                          placeholder="Email address"
                          value={member.email}
                          onChange={e => handleTeamChange(idx, 'email', e.target.value)}
                          className="flex-1 rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                          required
                        />
                        <select
                          value={member.role}
                          onChange={e => handleTeamChange(idx, 'role', e.target.value)}
                          className="flex-1 rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                          required
                        >
                          <option value="">Select Role</option>
                          <option value="Stage Manager">Stage Manager</option>
                          <option value="Props Supervisor">Props Supervisor</option>
                          <option value="Designer">Designer</option>
                          <option value="Performer">Performer</option>
                          <option value="Other">Other</option>
                        </select>
                        <button type="button" onClick={() => handleRemoveTeam(idx)} className="p-1 text-pb-accent hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                      </div>
                      {/* Profile/Invite status */}
                      <div className="flex items-center gap-2 mt-2 md:mt-0">
                        {member.status === 'registered' && (
                          <div className="flex items-center gap-2 text-pb-primary">
                            {member.avatarUrl && <img src={member.avatarUrl} alt="avatar" className="w-8 h-8 rounded-full border border-pb-primary/30" />}
                            <span className="font-medium">{member.name || 'Registered User'}</span>
                            <span className="text-xs bg-pb-primary/20 px-2 py-1 rounded">Registered</span>
                          </div>
                        )}
                        {member.status === 'invited' && (
                          <button
                            type="button"
                            onClick={() => handleInvite(idx)}
                            className="px-3 py-1 rounded bg-pb-primary text-white text-xs hover:bg-pb-accent transition"
                          >
                            Invite
                          </button>
                        )}
                        {member.status === 'pending' && (
                          <span className="text-xs bg-pb-accent/20 px-2 py-1 rounded text-pb-accent">Invite Sent</span>
                        )}
                      </div>
                    </div>
                  ))}
                  <button type="button" onClick={handleAddTeam} className="flex items-center gap-1 text-pb-primary hover:text-pb-accent mt-1"><UserPlus className="w-4 h-4" /> Add Team Member</button>
                </div>
              </motion.div>
            )}
          </AnimatePresence>

          <motion.button
            whileTap={{ scale: 0.97 }}
            type="submit"
            disabled={loading}
            className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4"
          >
            {loading ? 'Saving...' : 'Add Show'}
          </motion.button>
        </form>
      </div>
    </DashboardLayout>
  );
};

export default AddShowPage; 
```

```typescriptreact
import React, { useEffect, useState } from 'react';
import DashboardLayout from '../PropsBibleHomepage';
import { useFirebase } from '../contexts/FirebaseContext';
import { useNavigate, useParams } from 'react-router-dom';
import { Plus, Trash2, UploadCloud, Users, UserPlus } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import EntitySelect from '../components/EntitySelect';

// Types (should match AddShowPage)
interface Act {
  name: string;
  scenes: string[];
}
interface TeamMember {
  email: string;
  role: string;
  userId?: string;
  name?: string;
  avatarUrl?: string;
  status?: 'registered' | 'invited' | 'pending';
}
interface ShowFormState {
  name: string;
  description: string;
  startDate: string;
  endDate: string;
  logoImage: File | { url: string } | null;
  acts: Act[];
  team: TeamMember[];
  stageManager: string;
  stageManagerEmail: string;
  propsSupervisor: string;
  propsSupervisorEmail: string;
  productionCompany: string;
  venues: string[];
  isTouringShow: boolean;
  status: string;
  rehearsalAddresses: string[];
  storageAddresses: string[];
  rehearsalStartDate: string;
  techWeekStartDate: string;
  firstPerformanceDate: string;
  pressNightDate: string;
  venueIds?: string[];
  rehearsalAddressIds?: string[];
  storageAddressIds?: string[];
}

const statusOptions = [
  { value: 'planning', label: 'Planning' },
  { value: 'active', label: 'Active' },
  { value: 'completed', label: 'Completed' },
];

const initialShow: ShowFormState = {
  name: '',
  description: '',
  startDate: '',
  endDate: '',
  logoImage: null,
  acts: [{ name: '', scenes: [''] }],
  team: [{ email: '', role: '', status: undefined }],
  stageManager: '',
  stageManagerEmail: '',
  propsSupervisor: '',
  propsSupervisorEmail: '',
  productionCompany: '',
  venues: [''],
  isTouringShow: false,
  status: 'planning',
  rehearsalAddresses: [''],
  storageAddresses: [''],
  rehearsalStartDate: '',
  techWeekStartDate: '',
  firstPerformanceDate: '',
  pressNightDate: '',
  venueIds: [],
  rehearsalAddressIds: [],
  storageAddressIds: [],
};

const EditShowPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [show, setShow] = useState<ShowFormState>(initialShow);
  const [logoPreview, setLogoPreview] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<'details' | 'team'>('details');
  const navigate = useNavigate();

  // Fetch show data on mount
  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('shows', id)
      .then((doc: any) => {
        if (doc && doc.data) {
          const data = doc.data;
          setShow({
            ...initialShow,
            ...data,
            logoImage: data.logoImage || null,
            acts: data.acts || [{ name: '', scenes: [''] }],
            team: data.team || [{ email: '', role: '', status: undefined }],
            venues: data.venues || [''],
            rehearsalAddresses: data.rehearsalAddresses || [''],
            storageAddresses: data.storageAddresses || [''],
            rehearsalStartDate: data.rehearsalStartDate || '',
            techWeekStartDate: data.techWeekStartDate || '',
            firstPerformanceDate: data.firstPerformanceDate || '',
            pressNightDate: data.pressNightDate || '',
            venueIds: data.venueIds || [],
            rehearsalAddressIds: data.rehearsalAddressIds || [],
            storageAddressIds: data.storageAddressIds || [],
          });
          if (data.logoImage?.url) setLogoPreview(data.logoImage.url);
        } else {
          setError('Show not found.');
        }
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load show.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  // Mock user lookup (same as AddShowPage)
  const mockUserLookup = async (email: string) => {
    if (email.includes('registered')) {
      return {
        userId: 'user123',
        name: 'Registered User',
        avatarUrl: 'https://api.dicebear.com/7.x/identicon/svg?seed=' + encodeURIComponent(email),
        status: 'registered' as const,
      };
    }
    return null;
  };

  // Handlers (same as AddShowPage, but update state)
  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    if (type === 'checkbox' && 'checked' in e.target) {
      setShow(prev => ({ ...prev, [name]: (e.target as HTMLInputElement).checked }));
    } else {
      setShow(prev => ({ ...prev, [name]: value }));
    }
  };
  const handleLogoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0] || null;
    setShow(prev => ({ ...prev, logoImage: file }));
    if (file) {
      setLogoPreview(URL.createObjectURL(file));
    } else if (typeof show.logoImage === 'object' && show.logoImage && 'url' in show.logoImage) {
      setLogoPreview(show.logoImage.url);
    } else {
      setLogoPreview(null);
    }
  };
  // Acts
  const handleActNameChange = (idx: number, value: string) => {
    setShow(prev => ({
      ...prev,
      acts: prev.acts.map((act, i) => i === idx ? { ...act, name: value } : act),
    }));
  };
  const handleAddAct = () => {
    setShow(prev => ({ ...prev, acts: [...prev.acts, { name: '', scenes: [''] }] }));
  };
  const handleRemoveAct = (idx: number) => {
    setShow(prev => ({ ...prev, acts: prev.acts.filter((_, i) => i !== idx) }));
  };
  const handleSceneChange = (actIdx: number, sceneIdx: number, value: string) => {
    setShow(prev => ({
      ...prev,
      acts: prev.acts.map((act, i) =>
        i === actIdx
          ? { ...act, scenes: act.scenes.map((scene, j) => j === sceneIdx ? value : scene) }
          : act
      ),
    }));
  };
  const handleAddScene = (actIdx: number) => {
    setShow(prev => ({
      ...prev,
      acts: prev.acts.map((act, i) =>
        i === actIdx ? { ...act, scenes: [...act.scenes, ''] } : act
      ),
    }));
  };
  const handleRemoveScene = (actIdx: number, sceneIdx: number) => {
    setShow(prev => ({
      ...prev,
      acts: prev.acts.map((act, i) =>
        i === actIdx ? { ...act, scenes: act.scenes.filter((_, j) => j !== sceneIdx) } : act
      ),
    }));
  };
  // Team
  const handleTeamChange = async (idx: number, key: string, value: string) => {
    if (key === 'email') {
      const user = await mockUserLookup(value);
      setShow(prev => ({
        ...prev,
        team: prev.team.map((member, i) =>
          i === idx
            ? {
                ...member,
                email: value,
                userId: user?.userId,
                name: user?.name,
                avatarUrl: user?.avatarUrl,
                status: user ? 'registered' : 'invited',
              }
            : member
        ),
      }));
    } else {
      setShow(prev => ({
        ...prev,
        team: prev.team.map((member, i) => i === idx ? { ...member, [key]: value } : member),
      }));
    }
  };
  const handleAddTeam = () => {
    setShow(prev => ({ ...prev, team: [...prev.team, { email: '', role: '', status: undefined }] }));
  };
  const handleRemoveTeam = (idx: number) => {
    setShow(prev => ({ ...prev, team: prev.team.filter((_, i) => i !== idx) }));
  };
  const handleInvite = (idx: number) => {
    setShow(prev => ({
      ...prev,
      team: prev.team.map((member, i) =>
        i === idx ? { ...member, status: 'pending' } : member
      ),
    }));
  };

  // Submit handler
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      let logoUrl = '';
      if (show.logoImage && show.logoImage instanceof File) {
        const uploadResult = await firebaseService.uploadFile(`show_logos/${Date.now()}_${show.logoImage.name}`, show.logoImage) as unknown as { url: string } | undefined;
        if (uploadResult && uploadResult.url) {
          logoUrl = uploadResult.url;
        }
      } else if (show.logoImage && typeof show.logoImage === 'object' && 'url' in show.logoImage) {
        logoUrl = show.logoImage.url;
      }
      const showData = {
        ...show,
        logoImage: logoUrl ? { url: logoUrl } : undefined,
      };
      await firebaseService.updateDocument('shows', id!, showData);
      setSaving(false);
      navigate(`/shows/${id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to update show.');
      setSaving(false);
    }
  };

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading show...</div></DashboardLayout>;
  if (error) return <DashboardLayout><div className="text-center text-red-500 py-16">{error}</div></DashboardLayout>;

  // The form UI is the same as AddShowPage, but with Save Changes button
  return (
    <DashboardLayout>
      <div className="flex-1 flex flex-col min-h-screen">
        <form onSubmit={handleSubmit} className="w-full max-w-6xl mx-auto bg-pb-darker/60 rounded-xl shadow-lg p-8 my-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Edit Show</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}

          {/* Tabs */}
          <div className="flex gap-2 mb-6">
            <button
              type="button"
              className={`px-4 py-2 rounded-t-lg font-semibold transition-colors focus:outline-none ${activeTab === 'details' ? 'bg-pb-primary text-white' : 'bg-pb-darker text-pb-primary hover:bg-pb-primary/10'}`}
              onClick={() => setActiveTab('details')}
              aria-selected={activeTab === 'details'}
            >
              Show Details
            </button>
            <button
              type="button"
              className={`px-4 py-2 rounded-t-lg font-semibold transition-colors focus:outline-none ${activeTab === 'team' ? 'bg-pb-primary text-white' : 'bg-pb-darker text-pb-primary hover:bg-pb-primary/10'}`}
              onClick={() => setActiveTab('team')}
              aria-selected={activeTab === 'team'}
            >
              <Users className="inline w-4 h-4 mr-1" /> Team Members
            </button>
          </div>

          <AnimatePresence mode="wait">
            {activeTab === 'details' && (
              <motion.div
                key="details"
                initial={{ opacity: 0, x: 40 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -40 }}
                transition={{ duration: 0.25 }}
                className="space-y-6"
              >
                {/* Logo Upload */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Logo Image</label>
                  <div className="flex items-center gap-4">
                    <label className="flex items-center gap-2 cursor-pointer bg-pb-primary/20 hover:bg-pb-primary/40 px-4 py-2 rounded-lg text-pb-primary">
                      <UploadCloud className="w-5 h-5" />
                      <span>Upload</span>
                      <input type="file" accept="image/*" className="hidden" onChange={handleLogoChange} />
                    </label>
                    {logoPreview && (
                      <img src={logoPreview} alt="Logo Preview" className="w-16 h-16 object-cover rounded border border-pb-primary/30" />
                    )}
                  </div>
                </div>
                {/* Name */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Show Name *</label>
                  <input name="name" value={show.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary" />
                </div>
                {/* Description */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Description *</label>
                  <textarea name="description" value={show.description} onChange={handleChange} required rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary" />
                </div>
                {/* Dates */}
                <div className="flex flex-col md:flex-row gap-4">
                  <div className="flex-1">
                    <label className="block text-pb-gray mb-1 font-medium">Start Date *</label>
                    <input type="date" name="startDate" value={show.startDate} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary" />
                  </div>
                  <div className="flex-1">
                    <label className="block text-pb-gray mb-1 font-medium">End Date *</label>
                    <input type="date" name="endDate" value={show.endDate} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white focus:outline-none focus:ring-2 focus:ring-pb-primary" />
                  </div>
                </div>
                {/* Important Dates */}
                <fieldset className="mb-4 p-4 rounded-lg bg-pb-darker/40 border border-pb-primary/20">
                  <legend className="px-2 text-pb-primary font-semibold">Important Dates</legend>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-pb-gray mb-1 font-medium">Start of Rehearsal</label>
                      <input type="date" name="rehearsalStartDate" value={show.rehearsalStartDate} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    </div>
                    <div>
                      <label className="block text-pb-gray mb-1 font-medium">Start of Tech Week</label>
                      <input type="date" name="techWeekStartDate" value={show.techWeekStartDate} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    </div>
                    <div>
                      <label className="block text-pb-gray mb-1 font-medium">First Performance</label>
                      <input type="date" name="firstPerformanceDate" value={show.firstPerformanceDate} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    </div>
                    <div>
                      <label className="block text-pb-gray mb-1 font-medium">Press Night</label>
                      <input type="date" name="pressNightDate" value={show.pressNightDate} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    </div>
                  </div>
                </fieldset>
                {/* Acts & Scenes */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Acts & Scenes</label>
                  {show.acts.map((act, actIdx) => (
                    <div key={actIdx} className="mb-4 p-3 rounded bg-pb-darker/40 border border-pb-primary/20">
                      <div className="flex items-center gap-2 mb-2">
                        <input
                          value={act.name}
                          onChange={e => handleActNameChange(actIdx, e.target.value)}
                          placeholder="Act Name"
                          className="flex-1 rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                        />
                        <button type="button" onClick={() => handleRemoveAct(actIdx)} className="p-1 text-pb-accent hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                      </div>
                      <div className="ml-4">
                        <label className="block text-pb-gray mb-1 font-medium">Scenes</label>
                        {act.scenes.map((scene, sceneIdx) => (
                          <div key={sceneIdx} className="flex items-center gap-2 mb-2">
                            <input
                              value={scene}
                              onChange={e => handleSceneChange(actIdx, sceneIdx, e.target.value)}
                              placeholder={`Scene ${sceneIdx + 1}`}
                              className="flex-1 rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                            />
                            <button type="button" onClick={() => handleRemoveScene(actIdx, sceneIdx)} className="p-1 text-pb-accent hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                          </div>
                        ))}
                        <button type="button" onClick={() => handleAddScene(actIdx)} className="flex items-center gap-1 text-pb-primary hover:text-pb-accent mt-1"><Plus className="w-4 h-4" /> Add Scene</button>
                      </div>
                    </div>
                  ))}
                  <button type="button" onClick={handleAddAct} className="flex items-center gap-1 text-pb-primary hover:text-pb-accent mt-1"><Plus className="w-4 h-4" /> Add Act</button>
                </div>
                {/* Stage Manager & Props Supervisor */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-pb-gray mb-1 font-medium">Stage Manager</label>
                    <input name="stageManager" value={show.stageManager} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    <input name="stageManagerEmail" value={show.stageManagerEmail} onChange={handleChange} placeholder="Email" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white mt-2" />
                  </div>
                  <div>
                    <label className="block text-pb-gray mb-1 font-medium">Props Supervisor</label>
                    <input name="propsSupervisor" value={show.propsSupervisor} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                    <input name="propsSupervisorEmail" value={show.propsSupervisorEmail} onChange={handleChange} placeholder="Email" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white mt-2" />
                  </div>
                </div>
                {/* Production Company */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Production Company</label>
                  <input name="productionCompany" value={show.productionCompany} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
                </div>
                {/* Venues */}
                <EntitySelect
                  label="Venue(s)"
                  type="venue"
                  selectedIds={show.venueIds || []}
                  onChange={(ids) => setShow(prev => ({ ...prev, venueIds: ids }))}
                  allowMultiple={show.isTouringShow}
                />
                {/* Touring Status */}
                <div className="flex items-center gap-2">
                  <input type="checkbox" name="isTouringShow" checked={show.isTouringShow} onChange={handleChange} id="isTouringShow" className="accent-pb-primary" />
                  <label htmlFor="isTouringShow" className="text-pb-gray font-medium">Touring Show</label>
                </div>
                {/* Status */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Status</label>
                  <select name="status" value={show.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                    {statusOptions.map(opt => (
                      <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                  </select>
                </div>
                {/* Rehearsal Addresses */}
                <EntitySelect
                  label="Rehearsal Space(s)"
                  type="rehearsal"
                  selectedIds={show.rehearsalAddressIds || []}
                  onChange={(ids) => setShow(prev => ({ ...prev, rehearsalAddressIds: ids }))}
                  allowMultiple={true}
                />
                {/* Storage Addresses */}
                <EntitySelect
                  label="Storage Space(s)"
                  type="storage"
                  selectedIds={show.storageAddressIds || []}
                  onChange={(ids) => setShow(prev => ({ ...prev, storageAddressIds: ids }))}
                  allowMultiple={true}
                />
              </motion.div>
            )}
            {activeTab === 'team' && (
              <motion.div
                key="team"
                initial={{ opacity: 0, x: 40 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -40 }}
                transition={{ duration: 0.25 }}
                className="space-y-6"
              >
                {/* Team Members */}
                <div>
                  <label className="block text-pb-gray mb-1 font-medium">Team Members</label>
                  {show.team.map((member, idx) => (
                    <div key={idx} className="flex flex-col md:flex-row md:items-center gap-2 mb-4 p-3 rounded bg-pb-darker/40 border border-pb-primary/20">
                      <div className="flex-1 flex flex-col md:flex-row md:items-center gap-2">
                        <input
                          type="email"
                          placeholder="Email address"
                          value={member.email}
                          onChange={e => handleTeamChange(idx, 'email', e.target.value)}
                          className="flex-1 rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                          required
                        />
                        <select
                          value={member.role}
                          onChange={e => handleTeamChange(idx, 'role', e.target.value)}
                          className="flex-1 rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                          required
                        >
                          <option value="">Select Role</option>
                          <option value="Stage Manager">Stage Manager</option>
                          <option value="Props Supervisor">Props Supervisor</option>
                          <option value="Designer">Designer</option>
                          <option value="Performer">Performer</option>
                          <option value="Other">Other</option>
                        </select>
                        <button type="button" onClick={() => handleRemoveTeam(idx)} className="p-1 text-pb-accent hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                      </div>
                      {/* Profile/Invite status */}
                      <div className="flex items-center gap-2 mt-2 md:mt-0">
                        {member.status === 'registered' && (
                          <div className="flex items-center gap-2 text-pb-primary">
                            {member.avatarUrl && <img src={member.avatarUrl} alt="avatar" className="w-8 h-8 rounded-full border border-pb-primary/30" />}
                            <span className="font-medium">{member.name || 'Registered User'}</span>
                            <span className="text-xs bg-pb-primary/20 px-2 py-1 rounded">Registered</span>
                          </div>
                        )}
                        {member.status === 'invited' && (
                          <button
                            type="button"
                            onClick={() => handleInvite(idx)}
                            className="px-3 py-1 rounded bg-pb-primary text-white text-xs hover:bg-pb-accent transition"
                          >
                            Invite
                          </button>
                        )}
                        {member.status === 'pending' && (
                          <span className="text-xs bg-pb-accent/20 px-2 py-1 rounded text-pb-accent">Invite Sent</span>
                        )}
                      </div>
                    </div>
                  ))}
                  <button type="button" onClick={handleAddTeam} className="flex items-center gap-1 text-pb-primary hover:text-pb-accent mt-1"><UserPlus className="w-4 h-4" /> Add Team Member</button>
                </div>
              </motion.div>
            )}
          </AnimatePresence>

          <motion.button
            whileTap={{ scale: 0.97 }}
            type="submit"
            disabled={saving}
            className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4"
          >
            {saving ? 'Saving...' : 'Save Changes'}
          </motion.button>
        </form>
      </div>
    </DashboardLayout>
  );
};

export default EditShowPage; 
```

```typescriptreact
import React, { useEffect, useState } from 'react';
import DashboardLayout from '../PropsBibleHomepage';
import { useParams, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import type { Show } from '../types/Show';
import { Pencil } from 'lucide-react';

const ShowDetailPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [show, setShow] = useState<Show | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [venueAddresses, setVenueAddresses] = useState<any[]>([]);
  const [rehearsalAddresses, setRehearsalAddresses] = useState<any[]>([]);
  const [storageAddresses, setStorageAddresses] = useState<any[]>([]);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    setError(null);
    const unsubscribe = firebaseService.listenToDocument<Show>(
      `shows/${id}`,
      (doc) => {
        if (doc && doc.data) {
          setShow({ ...doc.data, id: doc.id });
          setError(null);
        } else {
          setShow(null);
          setError('Show not found.');
        }
        setLoading(false);
      },
      (err: Error) => {
        setError('Failed to load show details.');
        setShow(null);
        setLoading(false);
      }
    );
    return () => unsubscribe && unsubscribe();
  }, [id, firebaseService]);

  useEffect(() => {
    if (show && show.venueIds?.length) {
      firebaseService.getDocuments('addresses', { where: [['type', '==', 'venue']] })
        .then(docs => setVenueAddresses(docs.filter(doc => show.venueIds?.includes(doc.id)).map(doc => ({ ...doc.data, id: doc.id }))));
    }
    if (show && show.rehearsalAddressIds?.length) {
      firebaseService.getDocuments('addresses', { where: [['type', '==', 'rehearsal']] })
        .then(docs => setRehearsalAddresses(docs.filter(doc => show.rehearsalAddressIds?.includes(doc.id)).map(doc => ({ ...doc.data, id: doc.id }))));
    }
    if (show && show.storageAddressIds?.length) {
      firebaseService.getDocuments('addresses', { where: [['type', '==', 'storage']] })
        .then(docs => setStorageAddresses(docs.filter(doc => show.storageAddressIds?.includes(doc.id)).map(doc => ({ ...doc.data, id: doc.id }))));
    }
  }, [show]);

  if (loading) return (
    <div className="flex flex-col items-center justify-center h-64">
      <svg className="animate-spin h-10 w-10 text-pb-primary mb-2" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" /><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" /></svg>
      <div className="text-pb-gray mt-2">Loading show details...</div>
    </div>
  );
  if (error) return (
    <div className="text-red-500 text-center mt-8">
      {error}<br/>
      <Link to="/shows" className="text-pb-primary underline">Back to Shows</Link>
    </div>
  );
  if (!show) return null;

  // Helper for rendering lists
  const renderList = (
    items: any[] | undefined,
    label: string,
    getItem: (item: any, idx: number) => React.ReactNode
  ) => (
    Array.isArray(items) && items.length > 0 && (
      <div className="mb-4">
        <h2 className="text-lg font-semibold text-white mb-1">{label}</h2>
        <ul className="list-disc list-inside text-pb-gray">
          {items.map((item, idx) => getItem(item, idx))}
        </ul>
      </div>
    )
  );

  return ( 
    <DashboardLayout>
      <div className="flex-1 flex flex-col min-h-screen">
        <div className="w-full max-w-6xl mx-auto bg-pb-darker/60 rounded-xl shadow-lg p-8 my-8 relative">
          {/* Edit Button */}
          <button
            onClick={() => id && window.location.assign(`/shows/${id}/edit`)}
            className="absolute top-6 right-6 flex items-center gap-2 px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white shadow transition focus:outline-none focus:ring-2 focus:ring-pb-primary/50"
            aria-label="Edit Show"
          >
            <Pencil className="w-4 h-4" />
            <span className="hidden sm:inline">Edit</span>
          </button>
          <div className="flex flex-col md:flex-row md:items-center md:gap-8 mb-6">
            {show.logoImage?.url ? (
              <img
                src={show.logoImage.url}
                alt={show.name ? `${show.name} Logo` : 'Show Logo'}
                className="w-32 h-32 object-cover rounded-lg mb-4 md:mb-0 bg-pb-darker border border-pb-primary/30"
                onError={e => { (e.currentTarget as HTMLImageElement).style.display = 'none'; }}
              />
            ) : (
              <div className="w-32 h-32 flex items-center justify-center rounded-lg mb-4 md:mb-0 bg-pb-darker border border-pb-primary/30 text-pb-gray text-xs">
                No Logo
              </div>
            )}
            <div>
              <h1 className="text-2xl font-bold text-white mb-2">{show.name}</h1>
              {show.status && (
                <span className="inline-block px-3 py-1 rounded-full bg-pb-primary/20 text-pb-primary text-xs font-semibold mb-2">{show.status}</span>
              )}
              {show.description && <p className="text-pb-gray mb-2">{show.description}</p>}
              <div className="flex flex-wrap gap-4 text-sm text-pb-primary/80 mb-2">
                {show.startDate && (
                  <span>Start: {show.startDate.toDate ? show.startDate.toDate().toLocaleDateString() : String(show.startDate)}</span>
                )}
                {show.endDate && (
                  <span>End: {show.endDate.toDate ? show.endDate.toDate().toLocaleDateString() : String(show.endDate)}</span>
                )}
                {show.isTouringShow && <span className="text-pb-accent">Touring Show</span>}
              </div>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
            <div>
              <h2 className="text-lg font-semibold text-white mb-1">Production</h2>
              <div className="text-pb-gray text-sm mb-1">Company: {show.productionCompany}</div>
              <div className="text-pb-gray text-sm mb-1">Stage Manager: {show.stageManager} {show.stageManagerEmail && (<span className="ml-2 text-xs">({show.stageManagerEmail})</span>)}</div>
              <div className="text-pb-gray text-sm mb-1">Props Supervisor: {show.propsSupervisor} {show.propsSupervisorEmail && (<span className="ml-2 text-xs">({show.propsSupervisorEmail})</span>)}</div>
              <div className="text-pb-gray text-sm mb-1">Contact: {show.productionContactName} {show.productionContactEmail && (<span className="ml-2 text-xs">({show.productionContactEmail})</span>)}</div>
            </div>
            <div>
              <h2 className="text-lg font-semibold text-white mb-1">Meta</h2>
              <div className="text-pb-gray text-sm mb-1">Created: {show.createdAt ? (show.createdAt.toDate ? show.createdAt.toDate().toLocaleDateString() : String(show.createdAt)) : '-'}</div>
              <div className="text-pb-gray text-sm mb-1">Updated: {show.updatedAt ? (show.updatedAt.toDate ? show.updatedAt.toDate().toLocaleDateString() : String(show.updatedAt)) : '-'}</div>
              <div className="text-pb-gray text-sm mb-1">Owner/User ID: {show.userId}</div>
            </div>
          </div>

          {/* Venue Information */}
          <div>
            <h2 className="text-xl font-semibold text-[var(--text-primary)] mb-4">Venue(s)</h2>
            <div className="space-y-4">
              {venueAddresses.length === 0 ? <p className="text-[var(--text-primary)]">Not specified</p> : venueAddresses.map(addr => (
                <div key={addr.id} className="p-3 bg-[var(--bg-secondary)] rounded-lg">
                  <p className="font-medium text-[var(--text-primary)]">{addr.name}</p>
                  <p className="text-sm text-[var(--text-secondary)]">{[addr.street1, addr.street2, addr.city, addr.region, addr.postalCode, addr.country].filter(Boolean).join(', ')}</p>
                </div>
              ))}
            </div>
          </div>
          {/* Rehearsal Spaces */}
          <div>
            <h2 className="text-xl font-semibold text-[var(--text-primary)] mb-4">Rehearsal Space(s)</h2>
            <div className="space-y-4">
              {rehearsalAddresses.length === 0 ? <p className="text-[var(--text-primary)]">Not specified</p> : rehearsalAddresses.map(addr => (
                <div key={addr.id} className="p-3 bg-[var(--bg-secondary)] rounded-lg">
                  <p className="font-medium text-[var(--text-primary)]">{addr.name}</p>
                  <p className="text-sm text-[var(--text-secondary)]">{[addr.street1, addr.street2, addr.city, addr.region, addr.postalCode, addr.country].filter(Boolean).join(', ')}</p>
                </div>
              ))}
            </div>
          </div>
          {/* Storage Spaces */}
          <div>
            <h2 className="text-xl font-semibold text-[var(--text-primary)] mb-4">Storage Space(s)</h2>
            <div className="space-y-4">
              {storageAddresses.length === 0 ? <p className="text-[var(--text-primary)]">Not specified</p> : storageAddresses.map(addr => (
                <div key={addr.id} className="p-3 bg-[var(--bg-secondary)] rounded-lg">
                  <p className="font-medium text-[var(--text-primary)]">{addr.name}</p>
                  <p className="text-sm text-[var(--text-secondary)]">{[addr.street1, addr.street2, addr.city, addr.region, addr.postalCode, addr.country].filter(Boolean).join(', ')}</p>
                </div>
              ))}
            </div>
          </div>
          {renderList(show.venues, 'Venues', (venue, idx) => <li key={idx}>{venue.name || venue}</li>)}
          {renderList(show.contacts, 'Contacts', (contact, idx) => <li key={idx}>{contact.name || contact}</li>)}
          {renderList(show.collaborators, 'Collaborators', (collab, idx) => <li key={idx}>{collab.name || collab.email || collab}</li>)}
          {renderList(show.acts, 'Acts', (act, idx) => <li key={idx}>{act.name || act}</li>)}
          {renderList(show.rehearsalAddresses, 'Rehearsal Addresses', (addr, idx) => <li key={idx}>{addr.address || addr}</li>)}
          {renderList(show.storageAddresses, 'Storage Addresses', (addr, idx) => <li key={idx}>{addr.address || addr}</li>)}
          {show.team && Array.isArray(show.team) && show.team.length > 0 && (
            <div className="mb-4">
              <h2 className="text-lg font-semibold text-white mb-1">Team</h2>
              <ul className="list-disc list-inside text-pb-gray">
                {show.team.map((member: any, idx: number) => (
                  <li key={idx}>{member.uid} ({member.role})</li>
                ))}
              </ul>
            </div>
          )}
          <Link to="/shows" className="inline-block mt-4 text-pb-primary underline">← Back to Shows</Link>
        </div>
      </div>
    </DashboardLayout>
  );
};

export default ShowDetailPage; 
```

```typescriptreact
*** Begin Patch
*** Update File: web-app/src/pages/PackingListPage.tsx
@@
-      <div className="max-w-4xl mx-auto p-8">
+      <div className="max-w-7xl mx-auto p-8">
@@
-      <div className="max-w-4xl mx-auto p-8">
+      <div className="max-w-7xl mx-auto p-8">
*** End Patch
```

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useFirebase } from '../contexts/FirebaseContext';
import { DigitalPackListService, PackList } from '../../shared/services/inventory/packListService';
import { useShowSelection } from '../contexts/ShowSelectionContext';
import DashboardLayout from '../PropsBibleHomepage';
import { useNavigate } from 'react-router-dom';
import { useWebAuth } from '../contexts/WebAuthContext';

const PackingListPage: React.FC = () => {
  const { service } = useFirebase();
  const { currentShowId, setCurrentShowId } = useShowSelection();
  const [packingLists, setPackingLists] = useState<PackList[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [newListName, setNewListName] = useState('');
  const [creating, setCreating] = useState(false);
  const navigate = useNavigate();
  const { user, loading: webAuthLoading } = useWebAuth();

  useEffect(() => {
    if (!currentShowId) return;
    setLoading(true);
    const packListService = new DigitalPackListService(service, null as any, null as any, window.location.origin);
    // TODO: Replace with real-time listener if available
    packListService.listPackLists({ showId: currentShowId })
      .then((lists: PackList[]) => {
        setPackingLists(lists);
        setLoading(false);
      })
      .catch((err: Error) => {
        setError(err.message);
        setLoading(false);
      });
  }, [currentShowId, service]);

  const handleCreatePackingList = async (e: React.FormEvent) => {
    console.log('handleCreatePackingList called');
    e.preventDefault();
    if (!currentShowId || !newListName.trim()) {
      console.log('Missing show ID or list name', { currentShowId, newListName });
      return;
    }
    if (!user) {
      setError('You must be logged in to create a packing list.');
      console.log('No user in context');
      return;
    }
    const ownerId = user.uid;
    if (!ownerId) {
      setError('You must be logged in to create a packing list.');
      console.log('No ownerId');
      return;
    }
    setCreating(true);
    setError(null);
    console.log('Creating DigitalPackListService...');
    const packListService = new DigitalPackListService(service, null as any, null as any, window.location.origin);

    try {
      const newListData = {
        name: newListName.trim(),
        showId: currentShowId,
        containers: [],
        status: 'draft' as const,
        labels: [],
        metadata: {
          createdAt: new Date(),
          updatedAt: new Date(),
          createdBy: ownerId,
          updatedBy: ownerId,
        },
        ownerId,
      };
      console.log('About to call createPackList', newListData);
      const newListId = await packListService.createPackList(newListData);
      console.log('Packing list created, newListId:', newListId);
      setNewListName('');
      // Refresh list after creation
      const lists = await packListService.listPackLists({ showId: currentShowId });
      setPackingLists(lists);
      // Navigate to the new packing list detail page
      if (newListId) {
        navigate(`/packing-lists/${newListId}`);
      }
    } catch (e: any) {
      setError(e.message);
      console.error('Error creating packing list:', e);
    } finally {
      setCreating(false);
    }
  };

  if (webAuthLoading) return <div>Loading...</div>;
  if (!user) return <div>Please sign in to create a packing list.</div>;

  if (!currentShowId) {
    return (
      <DashboardLayout>
        <div className="max-w-7xl mx-auto p-8">
          <h2 className="text-2xl font-bold mb-6">Select a Show</h2>
          {/* TODO: Show selector component here */}
          <button onClick={() => setCurrentShowId(prompt('Enter show ID:') || null)} className="btn btn-primary">Set Show</button>
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout>
      <div className="max-w-7xl mx-auto p-8">
        <h1 className="text-2xl font-bold mb-6">Packing Lists</h1>
        <form onSubmit={handleCreatePackingList} className="flex flex-col gap-2 mb-6 max-w-lg">
          <label htmlFor="new-list-name" className="text-white font-semibold mb-1">Create New List</label>
          <div className="flex gap-2">
            <input
              id="new-list-name"
              type="text"
              className="flex-1 px-4 py-2 rounded-lg border border-pb-primary/30 bg-pb-darker/40 text-white placeholder-pb-gray focus:outline-none focus:ring-2 focus:ring-pb-primary"
              placeholder="New packing list name"
              value={newListName}
              onChange={e => setNewListName(e.target.value)}
              disabled={creating}
              required
            />
            <button
              type="submit"
              className={`btn btn-primary${creating || !newListName.trim() ? ' opacity-60 cursor-not-allowed' : ''}`}
              disabled={creating || !newListName.trim()}
            >
              {creating ? 'Creating...' : '+ New Packing List'}
            </button>
          </div>
        </form>
        {loading && <div className="text-gray-400">Loading...</div>}
        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {packingLists.map(list => (
            <div
              key={list.id}
              className="bg-gray-900 rounded-xl shadow-lg p-6 flex flex-col justify-between hover:shadow-2xl transition-shadow duration-200"
            >
              <div>
                <a
                  href={`/packing-lists/${list.id}`}
                  className="text-xl font-bold text-white mb-2 hover:underline hover:text-indigo-400 transition-colors duration-150 cursor-pointer"
                >
                  {list.name}
                </a>
                <p className="text-sm text-gray-400 mb-2">
                  Status: <span className="capitalize">{list.status}</span>
                </p>
                <p className="text-xs text-gray-500">
                  Created: {new Date(list.metadata.createdAt).toLocaleDateString()}
                </p>
              </div>
              {/* No View button */}
            </div>
          ))}
        </div>
      </div>
    </DashboardLayout>
  );
};

export default PackingListPage; 
```

- Scanned the app for width constraints and expanded pages to use available space.
- Adjusted:
  - `ProfilePage`: widened container, grid layout for fields.
  - `ShowsListPage`: container to `max-w-7xl`.
  - `AddPropPage`: removed fixed `max-w-3xl`.
  - `AddShowPage` and `EditShowPage`: widened forms to `max-w-6xl`.
  - `ShowDetailPage`: widened to `max-w-6xl`.
  - `PackingListPage`: containers to `max-w-7xl`.
- Existing pages already wide:
  - `DashboardHome` uses `max-w-7xl`.
  - `PropDetailPage` uses `max-w-none`.
  - `PropsListPage` uses `max-w-7xl`.

All lint checks are clean. If you’d like any page to be truly full-bleed (no max width), I can switch those to `max-w-none`.

---

**User**

looks like we need to sort thid out

---

**Cursor**

```typescriptreact
import React, { useState, useEffect } from "react";
import DashboardLayout from "../PropsBibleHomepage";
import { motion } from "framer-motion";
import { Calendar } from "lucide-react";
import { useFirebase } from "../contexts/FirebaseContext";
import type { BoardData } from "../types/taskManager";
import Board from "../components/TaskBoard/Board";
import { useShowSelection } from "../contexts/ShowSelectionContext";
import type { Show } from "../types/Show";
import { useWebAuth } from '../contexts/WebAuthContext';
import { BrowserRouter, Routes, Route, Navigate } from "react-router-dom";
import { ShowSelectionProvider } from "../contexts/ShowSelectionContext";
import Login from "../pages/Login";
import Signup from "../pages/Signup";
import ForgotPassword from "../pages/ForgotPassword";
import EditPropPage from "../pages/EditPropPage";
import PropDetailPage from "../pages/PropDetailPage";
import PropsListPage from '../PropsListPage';
import DashboardHome from '../DashboardHome';
import ShowsListPage from '../ShowsListPage';
import AddShowPage from "../pages/AddShowPage";
import EditShowPage from "../pages/EditShowPage";
import ShowDetailPage from "../pages/ShowDetailPage";
import PropsBibleHomepage from '../PropsBibleHomepage';

const BoardsPage: React.FC = () => {
  const { service } = useFirebase();
  const [showForm, setShowForm] = useState(false);
  const [boardName, setBoardName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [boards, setBoards] = useState<BoardData[]>([]);
  const [selectedBoardId, setSelectedBoardId] = useState<string | null>(null);
  const { currentShowId } = useShowSelection();
  const [showTitle, setShowTitle] = useState<string>("");
  const { user } = useWebAuth();

  console.log("[BoardsPage] currentShowId:", currentShowId);
  console.log("[BoardsPage] Current user:", user);

  useEffect(() => {
    // Listen to boards collection, filter by showId if selected
    const unsub = service.listenToCollection<BoardData>(
      "todo_boards",
      docs => {
        console.log("[BoardsPage] Raw docs from Firestore:", docs);
        const mappedBoards = docs.map(d => ({
          ...d.data,
          id: d.id,
          title: d.data.title || d.data.name || "Untitled Board",
          listIds: d.data.listIds || [],
        }));
        console.log("[BoardsPage] currentShowId:", currentShowId);
        mappedBoards.forEach(b => console.log(`[BoardsPage] Board: ${b.title}, showId: ${b.showId}`));
        console.log("[BoardsPage] Mapped boards before filtering:", mappedBoards);
        const filteredBoards = mappedBoards.filter(b => !currentShowId || b.showId === currentShowId);
        console.log("[BoardsPage] Filtered boards:", filteredBoards);
        setBoards(filteredBoards);
      },
      err => setError(err.message || "Failed to load boards")
    );
    return () => unsub();
  }, [service, currentShowId]);

  useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  useEffect(() => {
    service.getDocuments("todo_boards").then(docs => {
      console.log("[BoardsPage] Manual fetch docs:", docs);
    }).catch(err => {
      console.error("[BoardsPage] Manual fetch error:", err);
    });
  }, [service]);

  const handleCreateBoard = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      // Create a new board in Firestore
      await service.addDocument("boards", {
        title: boardName,
        listIds: [],
        createdAt: new Date(),
      });
      setBoardName("");
      setShowForm(false);
    } catch (err: any) {
      setError(err.message || "Failed to create board");
    } finally {
      setLoading(false);
    }
  };

  return (
    <ShowSelectionProvider>
      <BrowserRouter>
        <Routes>
          <Route path="/login" element={!user ? <Login /> : <Navigate to="/" replace />} />
          <Route path="/signup" element={!user ? <Signup /> : <Navigate to="/" replace />} />
          <Route path="/forgot-password" element={!user ? <ForgotPassword /> : <Navigate to="/" replace />} />
          <Route path="/props/:id/edit" element={user ? <EditPropPage /> : <Navigate to="/login" replace />} />
          <Route path="/props/:id" element={user ? <PropDetailPage /> : <Navigate to="/login" replace />} />
          <Route path="/props" element={user ? <PropsListPage /> : <Navigate to="/login" replace />} />
          <Route path="/" element={user ? <DashboardHome /> : <Navigate to="/login" replace />} />
          <Route path="/shows" element={<ShowsListPage />} />
          <Route path="/shows/new" element={<AddShowPage />} />
          <Route path="/shows/:id/edit" element={<EditShowPage />} />
          <Route path="/shows/:id" element={<ShowDetailPage />} />
          <Route path="/boards" element={user ? <BoardsPageContent /> : <Navigate to="/login" replace />} />
          <Route path="/*" element={user ? <PropsBibleHomepage>{<DashboardHome />}</PropsBibleHomepage> : <Navigate to="/login" replace />} />
        </Routes>
      </BrowserRouter>
    </ShowSelectionProvider>
  );
};

function BoardsPageContent() {
  const { service } = useFirebase();
  const [showForm, setShowForm] = useState(false);
  const [boardName, setBoardName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [boards, setBoards] = useState<BoardData[]>([]);
  const [selectedBoardId, setSelectedBoardId] = useState<string | null>(null);
  const { currentShowId } = useShowSelection();
  const [showTitle, setShowTitle] = useState<string>("");
  const { user } = useWebAuth();

  console.log("[BoardsPage] currentShowId:", currentShowId);
  console.log("[BoardsPage] Current user:", user);

  useEffect(() => {
    // Listen to boards collection, filter by showId if selected
    const unsub = service.listenToCollection<BoardData>(
      "todo_boards",
      docs => {
        console.log("[BoardsPage] Raw docs from Firestore:", docs);
        const mappedBoards = docs.map(d => ({
          ...d.data,
          id: d.id,
          title: d.data.title || d.data.name || "Untitled Board",
          listIds: d.data.listIds || [],
        }));
        console.log("[BoardsPage] currentShowId:", currentShowId);
        mappedBoards.forEach(b => console.log(`[BoardsPage] Board: ${b.title}, showId: ${b.showId}`));
        console.log("[BoardsPage] Mapped boards before filtering:", mappedBoards);
        const filteredBoards = mappedBoards.filter(b => !currentShowId || b.showId === currentShowId);
        console.log("[BoardsPage] Filtered boards:", filteredBoards);
        setBoards(filteredBoards);
      },
      err => setError(err.message || "Failed to load boards")
    );
    return () => unsub();
  }, [service, currentShowId]);

  useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  useEffect(() => {
    service.getDocuments("todo_boards").then(docs => {
      console.log("[BoardsPage] Manual fetch docs:", docs);
    }).catch(err => {
      console.error("[BoardsPage] Manual fetch error:", err);
    });
  }, [service]);

  const handleCreateBoard = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      // Create a new board in Firestore
      await service.addDocument("boards", {
        title: boardName,
        listIds: [],
        createdAt: new Date(),
      });
      setBoardName("");
      setShowForm(false);
    } catch (err: any) {
      setError(err.message || "Failed to create board");
    } finally {
      setLoading(false);
    }
  };

  return (
    <DashboardLayout>
      {!selectedBoardId ? (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="max-w-7xl mx-auto mt-8 px-4"
        >
          <div className="flex items-center mb-6 justify-center relative">
            <div className="w-10 h-10 bg-pb-primary/20 rounded-lg flex items-center justify-center mr-4 absolute left-0">
              <Calendar className="w-6 h-6 text-pb-primary" />
            </div>
            <div className="flex-1 flex flex-col items-center">
              <h1 className="text-2xl font-bold text-white">Task Boards</h1>
              <p className="text-pb-primary text-lg font-semibold mt-1">{showTitle || "No show selected"}</p>
              <p className="text-sm text-pb-gray">Organize your work with Kanban-style boards</p>
            </div>
          </div>
          <motion.div
            initial="hidden"
            animate="visible"
            variants={{
              hidden: { scale: 0.95, opacity: 0 },
              visible: { scale: 1, opacity: 1, transition: { duration: 0.4 } }
            }}
            whileHover="hover"
            className="rounded-xl bg-pb-primary/10 border border-pb-primary/20 p-8 flex flex-col items-center justify-center shadow-lg min-h-[200px] w-full"
          >
            {boards.length === 0 && (
              <>
                <p className="text-lg text-pb-gray mb-2">Your Kanban boards will appear here.</p>
                <p className="text-sm text-pb-gray mb-4">Create a new board to get started!</p>
              </>
            )}
            <div className="flex flex-wrap gap-4 justify-center w-full mb-4">
              {boards.map(board => (
                <button
                  key={board.id}
                  className={`bg-pb-darker border border-pb-primary/30 rounded-lg px-6 py-4 text-white font-semibold shadow hover:bg-pb-primary/20 transition w-64 text-left ${selectedBoardId === board.id ? 'ring-2 ring-pb-primary' : ''}`}
                  onClick={() => setSelectedBoardId(board.id)}
                >
                  <div className="text-lg font-bold mb-1">{board.title}</div>
                  <div className="text-xs text-pb-gray">{(board.listIds?.length || 0)} lists</div>
                </button>
              ))}
            </div>
            <button
              className="bg-pb-primary text-white px-4 py-2 rounded hover:bg-pb-secondary transition mb-2"
              onClick={() => setShowForm(v => !v)}
            >
              {showForm ? "Cancel" : "Create Board"}
            </button>
            {showForm && (
              <form onSubmit={handleCreateBoard} className="flex flex-col items-center w-full max-w-xs mt-2">
                <input
                  className="w-full px-3 py-2 rounded border border-pb-primary/40 mb-2 bg-pb-darker text-white focus:outline-none"
                  type="text"
                  placeholder="Board name"
                  value={boardName}
                  onChange={e => setBoardName(e.target.value)}
                  required
                  disabled={loading}
                />
                <button
                  type="submit"
                  className="bg-pb-success text-white px-4 py-2 rounded hover:bg-pb-primary transition w-full"
                  disabled={loading || !boardName.trim()}
                >
                  {loading ? "Creating..." : "Create"}
                </button>
                {error && <div className="text-red-400 text-xs mt-2">{error}</div>}
              </form>
            )}
          </motion.div>
        </motion.div>
      ) : (
          <Board boardId={selectedBoardId} />
      )}
    </DashboardLayout>
  );
}

export default BoardsPageContent; 
```

```typescriptreact
import React, { useEffect, useState, useRef } from "react";
import { useFirebase } from "../../contexts/FirebaseContext";
import ListColumn from "./ListColumn";
import type { BoardData, ListData, CardData } from "../../types/taskManager";
import { DndContext, closestCenter, PointerSensor, useSensor, useSensors, DragEndEvent, DragOverlay } from '@dnd-kit/core';
import { arrayMove, SortableContext, horizontalListSortingStrategy, verticalListSortingStrategy } from '@dnd-kit/sortable';

interface BoardProps {
  boardId: string;
}

const Board: React.FC<BoardProps> = ({ boardId }) => {
  const { service } = useFirebase();
  const [board, setBoard] = useState<BoardData | null>(null);
  const [lists, setLists] = useState<ListData[]>([]);
  const [cards, setCards] = useState<Record<string, CardData[]>>({}); // listId -> cards
  const listsRowRef = useRef<HTMLDivElement>(null);
  const isDragging = useRef(false);
  const startX = useRef(0);
  const scrollLeft = useRef(0);
  const [activeDragId, setActiveDragId] = useState<string | null>(null);
  const [activeDragType, setActiveDragType] = useState<'list' | 'card' | null>(null);

  const sensors = useSensors(
    useSensor(PointerSensor, { activationConstraint: { distance: 5 } })
  );

  useEffect(() => {
    // Listen to board document
    const unsubBoard = service.listenToDocument<BoardData>(
      `todo_boards/${boardId}`,
      (doc) => setBoard(doc.data)
    );
    // Listen to lists
    const unsubLists = service.listenToCollection<ListData>(
      `todo_boards/${boardId}/lists`,
      (docs) => {
        const mappedLists = docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled List", cardIds: d.data.cardIds || [] }));
        console.log(`[Board] Lists for board ${boardId}:`, mappedLists);
        setLists(mappedLists);
      },
      (err) => console.error(err)
    );
    // Listen to cards for each list
    let unsubCards: (() => void)[] = [];
    if (lists.length) {
      unsubCards.forEach(unsub => unsub());
      unsubCards = lists.map(list =>
        service.listenToCollection<CardData>(
          `todo_boards/${boardId}/lists/${list.id}/cards`,
          (docs) => setCards(prev => ({ ...prev, [list.id]: docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled Card" })) })),
          (err) => console.error(err)
        )
      );
    }
    return () => {
      unsubBoard();
      unsubLists();
      unsubCards.forEach(unsub => unsub());
    };
  }, [boardId, lists.length]);

  // Drag-to-scroll handlers
  useEffect(() => {
    const row = listsRowRef.current;
    if (!row) return;
    const onMouseDown = (e: MouseEvent) => {
      isDragging.current = true;
      startX.current = e.pageX - row.offsetLeft;
      scrollLeft.current = row.scrollLeft;
      row.classList.add('cursor-grabbing');
    };
    const onMouseLeave = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseUp = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseMove = (e: MouseEvent) => {
      if (!isDragging.current) return;
      e.preventDefault();
      const x = e.pageX - row.offsetLeft;
      const walk = (x - startX.current) * 1.5; // scroll speed
      row.scrollLeft = scrollLeft.current - walk;
    };
    row.addEventListener('mousedown', onMouseDown);
    row.addEventListener('mouseleave', onMouseLeave);
    row.addEventListener('mouseup', onMouseUp);
    row.addEventListener('mousemove', onMouseMove);
    // Touch events for mobile
    let touchStartX = 0;
    let touchScrollLeft = 0;
    const onTouchStart = (e: TouchEvent) => {
      isDragging.current = true;
      touchStartX = e.touches[0].pageX - row.offsetLeft;
      touchScrollLeft = row.scrollLeft;
    };
    const onTouchEnd = () => {
      isDragging.current = false;
    };
    const onTouchMove = (e: TouchEvent) => {
      if (!isDragging.current) return;
      const x = e.touches[0].pageX - row.offsetLeft;
      const walk = (x - touchStartX) * 1.5;
      row.scrollLeft = touchScrollLeft - walk;
    };
    row.addEventListener('touchstart', onTouchStart);
    row.addEventListener('touchend', onTouchEnd);
    row.addEventListener('touchmove', onTouchMove);
    return () => {
      row.removeEventListener('mousedown', onMouseDown);
      row.removeEventListener('mouseleave', onMouseLeave);
      row.removeEventListener('mouseup', onMouseUp);
      row.removeEventListener('mousemove', onMouseMove);
      row.removeEventListener('touchstart', onTouchStart);
      row.removeEventListener('touchend', onTouchEnd);
      row.removeEventListener('touchmove', onTouchMove);
    };
  }, [lists]);

  // Add card handler
  const addCard = async (listId: string, title: string) => {
    if (!title.trim()) return;
    const order = (cards[listId]?.length || 0);
    const newCard = {
      title: title.trim(),
      description: '',
      createdAt: new Date().toISOString(),
      order,
      // Add more fields as needed
    };
    await service.addDocument(`todo_boards/${boardId}/lists/${listId}/cards`, newCard);
    // The listener will update state
  };

  // Update card handler
  const updateCard = async (cardId: string, updates: Partial<CardData>) => {
    // Find the list containing this card
    const listId = Object.keys(cards).find(lid => cards[lid].some(card => card.id === cardId));
    if (!listId) return;
    await service.updateDocument(`todo_boards/${boardId}/lists/${listId}/cards`, cardId, updates);
  };

  const handleListDragEnd = async (event: DragEndEvent) => {
    if (!board) return;
    const { active, over } = event;
    if (!over || !active) return;
    if (!Array.isArray(board.listIds)) return;
    const activeId = String(active.id).replace(/^list-/, '');
    const overId = String(over.id).replace(/^list-/, '');
    const oldIndex = board.listIds.indexOf(activeId);
    const newIndex = board.listIds.indexOf(overId);
    if (oldIndex === -1 || newIndex === -1) return;
    if (oldIndex !== newIndex) {
      const newListIds = arrayMove(board.listIds, oldIndex, newIndex);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  // --- NEW: Card drag handler for cross-list movement ---
  const handleCardDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    if (!over || !active) return;
    const activeCardId = String(active.id).replace(/^card-/, '');
    let sourceListId: string | undefined;
    let destListId: string | undefined;
    for (const list of lists) {
      const idx = (cards[list.id] || []).findIndex(card => card.id === activeCardId);
      if (idx !== -1) {
        sourceListId = list.id;
        break;
      }
    }
    for (const list of lists) {
      if (over.data?.current?.sortable?.containerId === `list-${list.id}` || over.id === `list-${list.id}`) {
        destListId = list.id;
        break;
      }
      if ((cards[list.id] || []).some(card => `card-${card.id}` === over.id)) {
        destListId = list.id;
        break;
      }
    }
    if (!sourceListId || !destListId) return;
    if (sourceListId === destListId) {
      const cardList = cards[sourceListId] || [];
      const oldIdx = cardList.findIndex(card => card.id === activeCardId);
      const newIdx = cardList.findIndex(card => `card-${card.id}` === over.id);
      if (oldIdx === -1 || newIdx === -1 || oldIdx === newIdx) return;
      const newCards = arrayMove(cardList, oldIdx, newIdx);
      for (let i = 0; i < newCards.length; i++) {
        await service.updateDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, newCards[i].id, { order: i });
      }
      return;
    }
    const sourceCards = [...(cards[sourceListId] || [])];
    const destCards = [...(cards[destListId] || [])];
    const movingCardIdx = sourceCards.findIndex(card => card.id === activeCardId);
    if (movingCardIdx === -1) return;
    const [movingCard] = sourceCards.splice(movingCardIdx, 1);
    let insertIdx = destCards.findIndex(card => `card-${card.id}` === over.id);
    if (insertIdx === -1) insertIdx = destCards.length;
    destCards.splice(insertIdx, 0, movingCard);
    await service.deleteDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, movingCard.id);
    await service.addDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, { ...movingCard, order: insertIdx });
    for (let i = 0; i < destCards.length; i++) {
      await service.updateDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, destCards[i].id, { order: i });
    }
  };

  // Add deleteList handler
  const deleteList = async (listId: string) => {
    // Remove list document
    await service.deleteDocument(`todo_boards/${boardId}/lists`, listId);
    // Remove from board.listIds
    if (board && Array.isArray(board.listIds)) {
      const newListIds = board.listIds.filter(id => id !== listId);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  if (!board) return <div>Loading board...</div>;

  // Deduplicate lists by name (case-insensitive)
  const uniqueLists = lists.filter(
    (list, index, self) =>
      list.title &&
      self.findIndex(l => l.title?.toLowerCase() === list.title?.toLowerCase()) === index
  );

  // If listIds is missing or not an array, just show all unique lists
  if (!Array.isArray(board.listIds) || board.listIds.length === 0) {
    if (uniqueLists.length === 0) return <div>No lists found for this board.</div>;
    return (
      <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30">
        <div className="flex-1 flex flex-col min-h-0">
          {/* Board Title as sticky header */}
          <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
            <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
          </div>
          {/* Lists Row Scrollable Area */}
          <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-hidden">
            <DndContext
              sensors={sensors}
              collisionDetection={closestCenter}
              onDragStart={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) setActiveDragType('list');
                else if (id.startsWith('card-')) setActiveDragType('card');
                else setActiveDragType(null);
                setActiveDragId(id);
              }}
              onDragEnd={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) handleListDragEnd(event);
                else if (id.startsWith('card-')) handleCardDragEnd(event);
                setActiveDragId(null);
                setActiveDragType(null);
              }}
              onDragCancel={() => {
                setActiveDragId(null);
                setActiveDragType(null);
              }}
            >
              <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
            <div
              ref={listsRowRef}
              className="flex items-start space-x-6 h-full cursor-grab"
              style={{ WebkitOverflowScrolling: 'touch', maxWidth: '100%' }}
            >
                  {Array.isArray(board.listIds) && board.listIds.length > 0
                    ? board.listIds.map(listId => {
                        const list = lists.find(l => l.id === listId);
                        if (!list) return null;
                        return (
                          <ListColumn
                            key={list.id}
                            list={list}
                            cards={cards[list.id] || []}
                            boardId={boardId}
                            onAddCard={addCard}
                            onUpdateCard={updateCard}
                            dndId={`list-${list.id}`}
                            onDeleteList={deleteList}
                            cardIdPrefix="card-"
                          />
                        );
                      })
                    : uniqueLists.map(list => (
                <ListColumn
                  key={list.id}
                  list={list}
                  cards={cards[list.id] || []}
                  boardId={boardId}
                  onAddCard={addCard}
                  onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                />
              ))}
              {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
            </div>
              </SortableContext>
              <DragOverlay>
                {activeDragType === 'card' && activeDragId ? (() => {
                  // Find the card data
                  let card: CardData | undefined;
                  for (const list of lists) {
                    card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                    if (card) break;
                  }
                  return card ? (
                    <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                      <div className="font-semibold">{card.title}</div>
                      {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                    </div>
                  ) : null;
                })() : null}
                {activeDragType === 'list' && activeDragId ? (() => {
                  // Find the list data
                  const list = lists.find(l => `list-${l.id}` === activeDragId);
                  return list ? (
                    <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                      <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                    </div>
                  ) : null;
                })() : null}
              </DragOverlay>
            </DndContext>
          </div>
        </div>
        {/* FAB to add a list */}
        <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
          +
        </button>
      </div>
    );
  }

  return (
    <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30">
      <div className="flex-1 flex flex-col min-h-0">
        {/* Board Title as sticky header */}
        <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
          <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
        </div>
        {/* Lists Row Scrollable Area */}
        <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-hidden">
          <DndContext
            sensors={sensors}
            collisionDetection={closestCenter}
            onDragStart={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) setActiveDragType('list');
              else if (id.startsWith('card-')) setActiveDragType('card');
              else setActiveDragType(null);
              setActiveDragId(id);
            }}
            onDragEnd={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) handleListDragEnd(event);
              else if (id.startsWith('card-')) handleCardDragEnd(event);
              setActiveDragId(null);
              setActiveDragType(null);
            }}
            onDragCancel={() => {
              setActiveDragId(null);
              setActiveDragType(null);
            }}
          >
            <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
          <div
            ref={listsRowRef}
            className="flex items-start space-x-6 h-full cursor-grab"
            style={{ WebkitOverflowScrolling: 'touch', maxWidth: '100%' }}
          >
            {Array.isArray(board.listIds) && board.listIds.length > 0
              ? board.listIds.map(listId => {
                  const list = lists.find(l => l.id === listId);
                  if (!list) return null;
                  return (
                    <ListColumn
                      key={list.id}
                      list={list}
                      cards={cards[list.id] || []}
                      boardId={boardId}
                      onAddCard={addCard}
                      onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                    />
                  );
                })
              : uniqueLists.map(list => (
                  <ListColumn
                    key={list.id}
                    list={list}
                    cards={cards[list.id] || []}
                    boardId={boardId}
                    onAddCard={addCard}
                    onUpdateCard={updateCard}
                        dndId={`list-${list.id}`}
                        onDeleteList={deleteList}
                        cardIdPrefix="card-"
                  />
                ))}
            {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
          </div>
            </SortableContext>
            <DragOverlay>
              {activeDragType === 'card' && activeDragId ? (() => {
                // Find the card data
                let card: CardData | undefined;
                for (const list of lists) {
                  card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                  if (card) break;
                }
                return card ? (
                  <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                    <div className="font-semibold">{card.title}</div>
                    {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                  </div>
                ) : null;
              })() : null}
              {activeDragType === 'list' && activeDragId ? (() => {
                // Find the list data
                const list = lists.find(l => `list-${l.id}` === activeDragId);
                return list ? (
                  <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                    <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                  </div>
                ) : null;
              })() : null}
            </DragOverlay>
          </DndContext>
        </div>
      </div>
      {/* FAB to add a list */}
      <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
        +
      </button>
    </div>
  );
};

export default Board; 
```

- Widened the Boards overview container: `BoardsPage` now uses `max-w-7xl mx-auto px-4`.
- Ensured the Kanban board fills the viewport height: `Board` container set to `min-h-screen` for both unique-lists and normal path.
- Horizontal list row already uses `overflow-x-auto` and `maxWidth: 100%`; left intact.
- No lint issues.

If you’re still seeing a mid-page hard split (dark-to-light cutoff), it could be the page not stretching to full height or a parent with fixed height; refresh and check. I can also extend the gradient background wrapper to the root if needed.

---

**User**

lets fix this: boards the horazontal collapse it should work like trello 

---

**Cursor**

```typescriptreact
import React, { useEffect, useState, useRef } from "react";
import { useFirebase } from "../../contexts/FirebaseContext";
import ListColumn from "./ListColumn";
import type { BoardData, ListData, CardData } from "../../types/taskManager";
import { DndContext, closestCenter, PointerSensor, useSensor, useSensors, DragEndEvent, DragOverlay } from '@dnd-kit/core';
import { arrayMove, SortableContext, horizontalListSortingStrategy, verticalListSortingStrategy } from '@dnd-kit/sortable';

interface BoardProps {
  boardId: string;
}

const Board: React.FC<BoardProps> = ({ boardId }) => {
  const { service } = useFirebase();
  const [board, setBoard] = useState<BoardData | null>(null);
  const [lists, setLists] = useState<ListData[]>([]);
  const [cards, setCards] = useState<Record<string, CardData[]>>({}); // listId -> cards
  const listsRowRef = useRef<HTMLDivElement>(null);
  const isDragging = useRef(false);
  const startX = useRef(0);
  const scrollLeft = useRef(0);
  const [activeDragId, setActiveDragId] = useState<string | null>(null);
  const [activeDragType, setActiveDragType] = useState<'list' | 'card' | null>(null);

  const sensors = useSensors(
    useSensor(PointerSensor, { activationConstraint: { distance: 5 } })
  );

  useEffect(() => {
    // Listen to board document
    const unsubBoard = service.listenToDocument<BoardData>(
      `todo_boards/${boardId}`,
      (doc) => setBoard(doc.data)
    );
    // Listen to lists
    const unsubLists = service.listenToCollection<ListData>(
      `todo_boards/${boardId}/lists`,
      (docs) => {
        const mappedLists = docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled List", cardIds: d.data.cardIds || [] }));
        console.log(`[Board] Lists for board ${boardId}:`, mappedLists);
        setLists(mappedLists);
      },
      (err) => console.error(err)
    );
    // Listen to cards for each list
    let unsubCards: (() => void)[] = [];
    if (lists.length) {
      unsubCards.forEach(unsub => unsub());
      unsubCards = lists.map(list =>
        service.listenToCollection<CardData>(
          `todo_boards/${boardId}/lists/${list.id}/cards`,
          (docs) => setCards(prev => ({ ...prev, [list.id]: docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled Card" })) })),
          (err) => console.error(err)
        )
      );
    }
    return () => {
      unsubBoard();
      unsubLists();
      unsubCards.forEach(unsub => unsub());
    };
  }, [boardId, lists.length]);

  // Drag-to-scroll handlers
  useEffect(() => {
    const row = listsRowRef.current;
    if (!row) return;
    const onMouseDown = (e: MouseEvent) => {
      isDragging.current = true;
      startX.current = e.pageX - row.offsetLeft;
      scrollLeft.current = row.scrollLeft;
      row.classList.add('cursor-grabbing');
    };
    const onMouseLeave = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseUp = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseMove = (e: MouseEvent) => {
      if (!isDragging.current) return;
      e.preventDefault();
      const x = e.pageX - row.offsetLeft;
      const walk = (x - startX.current) * 1.5; // scroll speed
      row.scrollLeft = scrollLeft.current - walk;
    };
    row.addEventListener('mousedown', onMouseDown);
    row.addEventListener('mouseleave', onMouseLeave);
    row.addEventListener('mouseup', onMouseUp);
    row.addEventListener('mousemove', onMouseMove);
    // Touch events for mobile
    let touchStartX = 0;
    let touchScrollLeft = 0;
    const onTouchStart = (e: TouchEvent) => {
      isDragging.current = true;
      touchStartX = e.touches[0].pageX - row.offsetLeft;
      touchScrollLeft = row.scrollLeft;
    };
    const onTouchEnd = () => {
      isDragging.current = false;
    };
    const onTouchMove = (e: TouchEvent) => {
      if (!isDragging.current) return;
      const x = e.touches[0].pageX - row.offsetLeft;
      const walk = (x - touchStartX) * 1.5;
      row.scrollLeft = touchScrollLeft - walk;
    };
    row.addEventListener('touchstart', onTouchStart);
    row.addEventListener('touchend', onTouchEnd);
    row.addEventListener('touchmove', onTouchMove);
    return () => {
      row.removeEventListener('mousedown', onMouseDown);
      row.removeEventListener('mouseleave', onMouseLeave);
      row.removeEventListener('mouseup', onMouseUp);
      row.removeEventListener('mousemove', onMouseMove);
      row.removeEventListener('touchstart', onTouchStart);
      row.removeEventListener('touchend', onTouchEnd);
      row.removeEventListener('touchmove', onTouchMove);
    };
  }, [lists]);

  // Add card handler
  const addCard = async (listId: string, title: string) => {
    if (!title.trim()) return;
    const order = (cards[listId]?.length || 0);
    const newCard = {
      title: title.trim(),
      description: '',
      createdAt: new Date().toISOString(),
      order,
      // Add more fields as needed
    };
    await service.addDocument(`todo_boards/${boardId}/lists/${listId}/cards`, newCard);
    // The listener will update state
  };

  // Update card handler
  const updateCard = async (cardId: string, updates: Partial<CardData>) => {
    // Find the list containing this card
    const listId = Object.keys(cards).find(lid => cards[lid].some(card => card.id === cardId));
    if (!listId) return;
    await service.updateDocument(`todo_boards/${boardId}/lists/${listId}/cards`, cardId, updates);
  };

  const handleListDragEnd = async (event: DragEndEvent) => {
    if (!board) return;
    const { active, over } = event;
    if (!over || !active) return;
    if (!Array.isArray(board.listIds)) return;
    const activeId = String(active.id).replace(/^list-/, '');
    const overId = String(over.id).replace(/^list-/, '');
    const oldIndex = board.listIds.indexOf(activeId);
    const newIndex = board.listIds.indexOf(overId);
    if (oldIndex === -1 || newIndex === -1) return;
    if (oldIndex !== newIndex) {
      const newListIds = arrayMove(board.listIds, oldIndex, newIndex);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  // --- NEW: Card drag handler for cross-list movement ---
  const handleCardDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    if (!over || !active) return;
    const activeCardId = String(active.id).replace(/^card-/, '');
    let sourceListId: string | undefined;
    let destListId: string | undefined;
    for (const list of lists) {
      const idx = (cards[list.id] || []).findIndex(card => card.id === activeCardId);
      if (idx !== -1) {
        sourceListId = list.id;
        break;
      }
    }
    for (const list of lists) {
      if (over.data?.current?.sortable?.containerId === `list-${list.id}` || over.id === `list-${list.id}`) {
        destListId = list.id;
        break;
      }
      if ((cards[list.id] || []).some(card => `card-${card.id}` === over.id)) {
        destListId = list.id;
        break;
      }
    }
    if (!sourceListId || !destListId) return;
    if (sourceListId === destListId) {
      const cardList = cards[sourceListId] || [];
      const oldIdx = cardList.findIndex(card => card.id === activeCardId);
      const newIdx = cardList.findIndex(card => `card-${card.id}` === over.id);
      if (oldIdx === -1 || newIdx === -1 || oldIdx === newIdx) return;
      const newCards = arrayMove(cardList, oldIdx, newIdx);
      for (let i = 0; i < newCards.length; i++) {
        await service.updateDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, newCards[i].id, { order: i });
      }
      return;
    }
    const sourceCards = [...(cards[sourceListId] || [])];
    const destCards = [...(cards[destListId] || [])];
    const movingCardIdx = sourceCards.findIndex(card => card.id === activeCardId);
    if (movingCardIdx === -1) return;
    const [movingCard] = sourceCards.splice(movingCardIdx, 1);
    let insertIdx = destCards.findIndex(card => `card-${card.id}` === over.id);
    if (insertIdx === -1) insertIdx = destCards.length;
    destCards.splice(insertIdx, 0, movingCard);
    await service.deleteDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, movingCard.id);
    await service.addDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, { ...movingCard, order: insertIdx });
    for (let i = 0; i < destCards.length; i++) {
      await service.updateDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, destCards[i].id, { order: i });
    }
  };

  // Add deleteList handler
  const deleteList = async (listId: string) => {
    // Remove list document
    await service.deleteDocument(`todo_boards/${boardId}/lists`, listId);
    // Remove from board.listIds
    if (board && Array.isArray(board.listIds)) {
      const newListIds = board.listIds.filter(id => id !== listId);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  if (!board) return <div>Loading board...</div>;

  // Deduplicate lists by name (case-insensitive)
  const uniqueLists = lists.filter(
    (list, index, self) =>
      list.title &&
      self.findIndex(l => l.title?.toLowerCase() === list.title?.toLowerCase()) === index
  );

  // If listIds is missing or not an array, just show all unique lists
  if (!Array.isArray(board.listIds) || board.listIds.length === 0) {
    if (uniqueLists.length === 0) return <div>No lists found for this board.</div>;
    return (
      <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30">
        <div className="flex-1 flex flex-col min-h-0">
          {/* Board Title as sticky header */}
          <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
            <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
          </div>
          {/* Lists Row Scrollable Area */}
          <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-hidden">
            <DndContext
              sensors={sensors}
              collisionDetection={closestCenter}
              onDragStart={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) setActiveDragType('list');
                else if (id.startsWith('card-')) setActiveDragType('card');
                else setActiveDragType(null);
                setActiveDragId(id);
              }}
              onDragEnd={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) handleListDragEnd(event);
                else if (id.startsWith('card-')) handleCardDragEnd(event);
                setActiveDragId(null);
                setActiveDragType(null);
              }}
              onDragCancel={() => {
                setActiveDragId(null);
                setActiveDragType(null);
              }}
            >
              <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
            <div
              ref={listsRowRef}
              className="flex items-start space-x-6 h-full cursor-grab min-w-full pr-6"
              style={{ WebkitOverflowScrolling: 'touch' }}
            >
                  {Array.isArray(board.listIds) && board.listIds.length > 0
                    ? board.listIds.map(listId => {
                        const list = lists.find(l => l.id === listId);
                        if (!list) return null;
                        return (
                          <ListColumn
                            key={list.id}
                            list={list}
                            cards={cards[list.id] || []}
                            boardId={boardId}
                            onAddCard={addCard}
                            onUpdateCard={updateCard}
                            dndId={`list-${list.id}`}
                            onDeleteList={deleteList}
                            cardIdPrefix="card-"
                          />
                        );
                      })
                    : uniqueLists.map(list => (
                <ListColumn
                  key={list.id}
                  list={list}
                  cards={cards[list.id] || []}
                  boardId={boardId}
                  onAddCard={addCard}
                  onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                />
              ))}
              {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
            </div>
              </SortableContext>
              <DragOverlay>
                {activeDragType === 'card' && activeDragId ? (() => {
                  // Find the card data
                  let card: CardData | undefined;
                  for (const list of lists) {
                    card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                    if (card) break;
                  }
                  return card ? (
                    <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                      <div className="font-semibold">{card.title}</div>
                      {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                    </div>
                  ) : null;
                })() : null}
                {activeDragType === 'list' && activeDragId ? (() => {
                  // Find the list data
                  const list = lists.find(l => `list-${l.id}` === activeDragId);
                  return list ? (
                    <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                      <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                    </div>
                  ) : null;
                })() : null}
              </DragOverlay>
            </DndContext>
          </div>
        </div>
        {/* FAB to add a list */}
        <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
          +
        </button>
      </div>
    );
  }

  return (
    <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30">
      <div className="flex-1 flex flex-col min-h-0">
        {/* Board Title as sticky header */}
        <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
          <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
        </div>
        {/* Lists Row Scrollable Area */}
        <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-hidden">
          <DndContext
            sensors={sensors}
            collisionDetection={closestCenter}
            onDragStart={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) setActiveDragType('list');
              else if (id.startsWith('card-')) setActiveDragType('card');
              else setActiveDragType(null);
              setActiveDragId(id);
            }}
            onDragEnd={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) handleListDragEnd(event);
              else if (id.startsWith('card-')) handleCardDragEnd(event);
              setActiveDragId(null);
              setActiveDragType(null);
            }}
            onDragCancel={() => {
              setActiveDragId(null);
              setActiveDragType(null);
            }}
          >
            <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
          <div
            ref={listsRowRef}
            className="flex items-start space-x-6 h-full cursor-grab min-w-full pr-6"
            style={{ WebkitOverflowScrolling: 'touch' }}
          >
            {Array.isArray(board.listIds) && board.listIds.length > 0
              ? board.listIds.map(listId => {
                  const list = lists.find(l => l.id === listId);
                  if (!list) return null;
                  return (
                    <ListColumn
                      key={list.id}
                      list={list}
                      cards={cards[list.id] || []}
                      boardId={boardId}
                      onAddCard={addCard}
                      onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                    />
                  );
                })
              : uniqueLists.map(list => (
                  <ListColumn
                    key={list.id}
                    list={list}
                    cards={cards[list.id] || []}
                    boardId={boardId}
                    onAddCard={addCard}
                    onUpdateCard={updateCard}
                        dndId={`list-${list.id}`}
                        onDeleteList={deleteList}
                        cardIdPrefix="card-"
                  />
                ))}
            {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
          </div>
            </SortableContext>
            <DragOverlay>
              {activeDragType === 'card' && activeDragId ? (() => {
                // Find the card data
                let card: CardData | undefined;
                for (const list of lists) {
                  card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                  if (card) break;
                }
                return card ? (
                  <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                    <div className="font-semibold">{card.title}</div>
                    {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                  </div>
                ) : null;
              })() : null}
              {activeDragType === 'list' && activeDragId ? (() => {
                // Find the list data
                const list = lists.find(l => `list-${l.id}` === activeDragId);
                return list ? (
                  <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                    <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                  </div>
                ) : null;
              })() : null}
            </DragOverlay>
          </DndContext>
        </div>
      </div>
      {/* FAB to add a list */}
      <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
        +
      </button>
    </div>
  );
};

export default Board; 
```

```typescriptreact
import React, { useState } from "react";
import Card from "./Card";
import type { ListData, CardData } from "../../types/taskManager";
import { Edit, ChevronDown, ChevronUp, Trash2 } from 'lucide-react';
import { useSortable, SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface ListColumnProps {
  list: ListData;
  cards: CardData[];
  boardId: string;
  onAddCard: (listId: string, title: string) => void;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
  onDeleteList: (listId: string) => void;
  cardIdPrefix?: string;
}

const ListColumn: React.FC<ListColumnProps> = ({ list, cards, boardId, onAddCard, onUpdateCard, dndId, onDeleteList, cardIdPrefix = '' }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [addingCard, setAddingCard] = useState(false);
  const [newCardTitle, setNewCardTitle] = useState("");

  // dnd-kit sortable for lists
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };

  const handleAddCard = () => {
    if (!newCardTitle.trim()) return;
    onAddCard(list.id, newCardTitle);
    setNewCardTitle("");
    setAddingCard(false);
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      className={`bg-pb-darker rounded-xl p-4 min-w-[18rem] w-[20rem] flex-shrink-0 shadow-lg border border-pb-primary/30 flex flex-col transition-all duration-300 ${collapsed ? 'w-12 min-w-[3rem] p-0 items-center justify-center bg-pb-primary/20' : ''}`}
    >
      <div className={`flex items-center justify-between mb-4 w-full ${collapsed ? 'flex-col gap-0 mb-0 items-center justify-center' : ''}`} style={collapsed ? { height: '100%' } : {}}>
        {collapsed ? (
          <>
            <div className="flex flex-col items-center justify-center h-full">
              <span className="text-xs font-bold text-pb-primary/80 mb-2" style={{ letterSpacing: '0.1em', writingMode: 'vertical-lr', textOrientation: 'upright' }}>
                {list.title.split('').join('\n')}
              </span>
              <button onClick={() => setCollapsed(false)} className="text-pb-primary hover:text-pb-success p-1 rounded mt-2">
                <ChevronDown size={20} />
              </button>
            </div>
          </>
        ) : (
          <>
            <div className="text-lg font-bold text-white tracking-wide text-left">
              {list.title}
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setCollapsed(true)} className="text-pb-primary hover:text-pb-success p-1 rounded">
                <ChevronUp size={20} />
              </button>
              <button className="text-pb-primary hover:text-pb-success p-1 rounded"><Edit size={20} /></button>
              <button className="text-pb-accent hover:text-red-500 p-1 rounded" onClick={() => onDeleteList(list.id)}><Trash2 size={20} /></button>
            </div>
          </>
        )}
      </div>
      {!collapsed && (
        <>
          <SortableContext items={Array.isArray(cards) ? cards.map(card => `${cardIdPrefix}${card.id}`) : []} strategy={verticalListSortingStrategy}>
            <div className="flex-1 flex flex-col gap-3 mb-4">
              {cards.map(card => (
                <Card key={card.id} card={card} onUpdateCard={onUpdateCard} dndId={`${cardIdPrefix}${card.id}`} />
              ))}
            </div>
          </SortableContext>
          {addingCard ? (
            <div className="flex flex-col gap-2 mt-2">
              <input
                className="rounded border border-pb-primary/40 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-pb-primary text-[#222]"
                type="text"
                value={newCardTitle}
                onChange={e => setNewCardTitle(e.target.value)}
                placeholder="Enter a title for this card..."
                autoFocus
                onKeyDown={e => {
                  if (e.key === 'Enter') handleAddCard();
                  if (e.key === 'Escape') { setAddingCard(false); setNewCardTitle(""); }
                }}
              />
              <div className="flex gap-2">
                <button
                  className="bg-pb-success hover:bg-pb-primary text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={handleAddCard}
                >
                  Add
                </button>
                <button
                  className="bg-pb-darker hover:bg-pb-primary/40 text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={() => { setAddingCard(false); setNewCardTitle(""); }}
                >
                  Cancel
                </button>
              </div>
            </div>
          ) : (
            <button className="mt-auto bg-pb-primary/90 hover:bg-pb-success text-white font-semibold py-2 px-3 rounded transition shadow focus:outline-none"
              onClick={() => setAddingCard(true)}
            >
              + Add Card
            </button>
          )}
        </>
      )}
    </div>
  );
};

export default ListColumn; 
```

- Made the board behave more like Trello’s horizontal scroller:
  - Board container now fills the viewport height (`min-h-screen`) so the background spans full page.
  - Lists row uses `overflow-x-auto` plus `min-w-full` and padding-right to prevent abrupt edge clipping and encourage horizontal scrolling.
  - Reduced column width slightly (`min-w-[18rem] w-[20rem]`) so more lists fit; columns remain `flex-shrink-0` for Trello-like flow.
  - Overview page for boards widened to `max-w-7xl`.

Files updated:
- `web-app/src/pages/BoardsPage.tsx`
- `web-app/src/components/TaskBoard/Board.tsx`
- `web-app/src/components/TaskBoard/ListColumn.tsx`

If you want momentum scrolling and trackpad grab to feel stronger, I can increase the drag “walk” multiplier or add scrollbars styling.

---

**User**

the collapsed card is not collapsing horizontally as you cane see in the attached

---

**Cursor**

```typescriptreact
import React, { useState } from "react";
import Card from "./Card";
import type { ListData, CardData } from "../../types/taskManager";
import { Edit, ChevronDown, ChevronUp, Trash2 } from 'lucide-react';
import { useSortable, SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface ListColumnProps {
  list: ListData;
  cards: CardData[];
  boardId: string;
  onAddCard: (listId: string, title: string) => void;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
  onDeleteList: (listId: string) => void;
  cardIdPrefix?: string;
}

const ListColumn: React.FC<ListColumnProps> = ({ list, cards, boardId, onAddCard, onUpdateCard, dndId, onDeleteList, cardIdPrefix = '' }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [addingCard, setAddingCard] = useState(false);
  const [newCardTitle, setNewCardTitle] = useState("");

  // dnd-kit sortable for lists
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };

  const handleAddCard = () => {
    if (!newCardTitle.trim()) return;
    onAddCard(list.id, newCardTitle);
    setNewCardTitle("");
    setAddingCard(false);
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      className={`bg-pb-darker rounded-xl shadow-lg border border-pb-primary/30 flex flex-col flex-shrink-0 transition-all duration-300 ${collapsed ? '!w-12 min-w-[3rem] p-0 items-center justify-center bg-pb-primary/20' : 'p-4 min-w-[18rem] w-[20rem]'}`}
    >
      <div className={`flex items-center justify-between mb-4 w-full ${collapsed ? 'flex-col gap-0 mb-0 items-center justify-center' : ''}`} style={collapsed ? { height: '100%' } : {}}>
        {collapsed ? (
          <>
            <div className="flex flex-col items-center justify-center h-full">
              <span className="text-xs font-bold text-pb-primary/80 mb-2" style={{ letterSpacing: '0.1em', writingMode: 'vertical-lr', textOrientation: 'upright' }}>
                {list.title.split('').join('\n')}
              </span>
              <button onClick={() => setCollapsed(false)} className="text-pb-primary hover:text-pb-success p-1 rounded mt-2">
                <ChevronDown size={20} />
              </button>
            </div>
          </>
        ) : (
          <>
            <div className="text-lg font-bold text-white tracking-wide text-left">
              {list.title}
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setCollapsed(true)} className="text-pb-primary hover:text-pb-success p-1 rounded">
                <ChevronUp size={20} />
              </button>
              <button className="text-pb-primary hover:text-pb-success p-1 rounded"><Edit size={20} /></button>
              <button className="text-pb-accent hover:text-red-500 p-1 rounded" onClick={() => onDeleteList(list.id)}><Trash2 size={20} /></button>
            </div>
          </>
        )}
      </div>
      {!collapsed && (
        <>
          <SortableContext items={Array.isArray(cards) ? cards.map(card => `${cardIdPrefix}${card.id}`) : []} strategy={verticalListSortingStrategy}>
            <div className="flex-1 flex flex-col gap-3 mb-4">
              {cards.map(card => (
                <Card key={card.id} card={card} onUpdateCard={onUpdateCard} dndId={`${cardIdPrefix}${card.id}`} />
              ))}
            </div>
          </SortableContext>
          {addingCard ? (
            <div className="flex flex-col gap-2 mt-2">
              <input
                className="rounded border border-pb-primary/40 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-pb-primary text-[#222]"
                type="text"
                value={newCardTitle}
                onChange={e => setNewCardTitle(e.target.value)}
                placeholder="Enter a title for this card..."
                autoFocus
                onKeyDown={e => {
                  if (e.key === 'Enter') handleAddCard();
                  if (e.key === 'Escape') { setAddingCard(false); setNewCardTitle(""); }
                }}
              />
              <div className="flex gap-2">
                <button
                  className="bg-pb-success hover:bg-pb-primary text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={handleAddCard}
                >
                  Add
                </button>
                <button
                  className="bg-pb-darker hover:bg-pb-primary/40 text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={() => { setAddingCard(false); setNewCardTitle(""); }}
                >
                  Cancel
                </button>
              </div>
            </div>
          ) : (
            <button className="mt-auto bg-pb-primary/90 hover:bg-pb-success text-white font-semibold py-2 px-3 rounded transition shadow focus:outline-none"
              onClick={() => setAddingCard(true)}
            >
              + Add Card
            </button>
          )}
        </>
      )}
    </div>
  );
};

export default ListColumn; 
```

```typescriptreact
import React, { useState } from "react";
import Card from "./Card";
import type { ListData, CardData } from "../../types/taskManager";
import { Edit, ChevronDown, ChevronUp, Trash2 } from 'lucide-react';
import { useSortable, SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface ListColumnProps {
  list: ListData;
  cards: CardData[];
  boardId: string;
  onAddCard: (listId: string, title: string) => void;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
  onDeleteList: (listId: string) => void;
  cardIdPrefix?: string;
}

const ListColumn: React.FC<ListColumnProps> = ({ list, cards, boardId, onAddCard, onUpdateCard, dndId, onDeleteList, cardIdPrefix = '' }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [addingCard, setAddingCard] = useState(false);
  const [newCardTitle, setNewCardTitle] = useState("");

  // dnd-kit sortable for lists
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };

  const handleAddCard = () => {
    if (!newCardTitle.trim()) return;
    onAddCard(list.id, newCardTitle);
    setNewCardTitle("");
    setAddingCard(false);
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      className={`bg-pb-darker rounded-xl shadow-lg border border-pb-primary/30 flex flex-col flex-shrink-0 transition-all duration-300 ${collapsed ? '!w-12 min-w-[3rem] p-0 items-center justify-center bg-pb-primary/20' : 'p-4 min-w-[18rem] w-[20rem]'}`}
    >
      <div className={`flex items-center justify-between mb-4 w-full ${collapsed ? 'flex-col gap-0 mb-0 items-center justify-center' : ''}`} style={collapsed ? { height: '100%' } : {}}>
        {collapsed ? (
          <>
            <div className="flex flex-col items-center justify-center h-full py-3">
              <span className="text-xs font-bold text-pb-primary/80 mb-2 select-none" style={{ letterSpacing: '0.1em', writingMode: 'vertical-lr', textOrientation: 'upright' }}>
                {list.title.split('').join('\n')}
              </span>
              <button onClick={() => setCollapsed(false)} className="text-pb-primary hover:text-pb-success p-1 rounded mt-2">
                <ChevronDown size={20} />
              </button>
            </div>
          </>
        ) : (
          <>
            <div className="text-lg font-bold text-white tracking-wide text-left">
              {list.title}
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setCollapsed(true)} className="text-pb-primary hover:text-pb-success p-1 rounded">
                <ChevronUp size={20} />
              </button>
              <button className="text-pb-primary hover:text-pb-success p-1 rounded"><Edit size={20} /></button>
              <button className="text-pb-accent hover:text-red-500 p-1 rounded" onClick={() => onDeleteList(list.id)}><Trash2 size={20} /></button>
            </div>
          </>
        )}
      </div>
      {!collapsed && (
        <>
          <SortableContext items={Array.isArray(cards) ? cards.map(card => `${cardIdPrefix}${card.id}`) : []} strategy={verticalListSortingStrategy}>
            <div className="flex-1 flex flex-col gap-3 mb-4">
              {cards.map(card => (
                <Card key={card.id} card={card} onUpdateCard={onUpdateCard} dndId={`${cardIdPrefix}${card.id}`} />
              ))}
            </div>
          </SortableContext>
          {addingCard ? (
            <div className="flex flex-col gap-2 mt-2">
              <input
                className="rounded border border-pb-primary/40 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-pb-primary text-[#222]"
                type="text"
                value={newCardTitle}
                onChange={e => setNewCardTitle(e.target.value)}
                placeholder="Enter a title for this card..."
                autoFocus
                onKeyDown={e => {
                  if (e.key === 'Enter') handleAddCard();
                  if (e.key === 'Escape') { setAddingCard(false); setNewCardTitle(""); }
                }}
              />
              <div className="flex gap-2">
                <button
                  className="bg-pb-success hover:bg-pb-primary text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={handleAddCard}
                >
                  Add
                </button>
                <button
                  className="bg-pb-darker hover:bg-pb-primary/40 text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={() => { setAddingCard(false); setNewCardTitle(""); }}
                >
                  Cancel
                </button>
              </div>
            </div>
          ) : (
            <button className="mt-auto bg-pb-primary/90 hover:bg-pb-success text-white font-semibold py-2 px-3 rounded transition shadow focus:outline-none"
              onClick={() => setAddingCard(true)}
            >
              + Add Card
            </button>
          )}
        </>
      )}
    </div>
  );
};

export default ListColumn; 
```

- Fixed collapsed list width so it truly collapses horizontally:
  - In `ListColumn`, changed the width classes to be mutually exclusive. When collapsed, applies `!w-12 min-w-[3rem] p-0` and removes the normal min-widths.
  - Added small padding and `select-none` for the vertical title in collapsed mode so it centers cleanly.
- Ensured list columns don’t keep normal width when collapsed.

If you want the collapsed width even slimmer or with a rotated title instead of vertical writing mode, I can adjust.

---

**User**

can you rotate the text when collapsed

---

**Cursor**

```typescriptreact
import React, { useState } from "react";
import Card from "./Card";
import type { ListData, CardData } from "../../types/taskManager";
import { Edit, ChevronDown, ChevronUp, Trash2 } from 'lucide-react';
import { useSortable, SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface ListColumnProps {
  list: ListData;
  cards: CardData[];
  boardId: string;
  onAddCard: (listId: string, title: string) => void;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
  onDeleteList: (listId: string) => void;
  cardIdPrefix?: string;
}

const ListColumn: React.FC<ListColumnProps> = ({ list, cards, boardId, onAddCard, onUpdateCard, dndId, onDeleteList, cardIdPrefix = '' }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [addingCard, setAddingCard] = useState(false);
  const [newCardTitle, setNewCardTitle] = useState("");

  // dnd-kit sortable for lists
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };

  const handleAddCard = () => {
    if (!newCardTitle.trim()) return;
    onAddCard(list.id, newCardTitle);
    setNewCardTitle("");
    setAddingCard(false);
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      className={`bg-pb-darker rounded-xl shadow-lg border border-pb-primary/30 flex flex-col flex-shrink-0 transition-all duration-300 ${collapsed ? '!w-12 min-w-[3rem] p-0 items-center justify-center bg-pb-primary/20' : 'p-4 min-w-[18rem] w-[20rem]'}`}
    >
      <div className={`flex items-center justify-between mb-4 w-full ${collapsed ? 'flex-col gap-0 mb-0 items-center justify-center' : ''}`} style={collapsed ? { height: '100%' } : {}}>
        {collapsed ? (
          <>
            <div className="flex flex-col items-center justify-center h-full py-3">
              <span className="text-xs font-bold text-pb-primary/80 mb-2 select-none transform -rotate-90 whitespace-nowrap origin-center tracking-widest">
                {list.title}
              </span>
              <button onClick={() => setCollapsed(false)} className="text-pb-primary hover:text-pb-success p-1 rounded mt-2">
                <ChevronDown size={20} />
              </button>
            </div>
          </>
        ) : (
          <>
            <div className="text-lg font-bold text-white tracking-wide text-left">
              {list.title}
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setCollapsed(true)} className="text-pb-primary hover:text-pb-success p-1 rounded">
                <ChevronUp size={20} />
              </button>
              <button className="text-pb-primary hover:text-pb-success p-1 rounded"><Edit size={20} /></button>
              <button className="text-pb-accent hover:text-red-500 p-1 rounded" onClick={() => onDeleteList(list.id)}><Trash2 size={20} /></button>
            </div>
          </>
        )}
      </div>
      {!collapsed && (
        <>
          <SortableContext items={Array.isArray(cards) ? cards.map(card => `${cardIdPrefix}${card.id}`) : []} strategy={verticalListSortingStrategy}>
            <div className="flex-1 flex flex-col gap-3 mb-4">
              {cards.map(card => (
                <Card key={card.id} card={card} onUpdateCard={onUpdateCard} dndId={`${cardIdPrefix}${card.id}`} />
              ))}
            </div>
          </SortableContext>
          {addingCard ? (
            <div className="flex flex-col gap-2 mt-2">
              <input
                className="rounded border border-pb-primary/40 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-pb-primary text-[#222]"
                type="text"
                value={newCardTitle}
                onChange={e => setNewCardTitle(e.target.value)}
                placeholder="Enter a title for this card..."
                autoFocus
                onKeyDown={e => {
                  if (e.key === 'Enter') handleAddCard();
                  if (e.key === 'Escape') { setAddingCard(false); setNewCardTitle(""); }
                }}
              />
              <div className="flex gap-2">
                <button
                  className="bg-pb-success hover:bg-pb-primary text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={handleAddCard}
                >
                  Add
                </button>
                <button
                  className="bg-pb-darker hover:bg-pb-primary/40 text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={() => { setAddingCard(false); setNewCardTitle(""); }}
                >
                  Cancel
                </button>
              </div>
            </div>
          ) : (
            <button className="mt-auto bg-pb-primary/90 hover:bg-pb-success text-white font-semibold py-2 px-3 rounded transition shadow focus:outline-none"
              onClick={() => setAddingCard(true)}
            >
              + Add Card
            </button>
          )}
        </>
      )}
    </div>
  );
};

export default ListColumn; 
```

- Collapsed list titles now rotate horizontally with CSS transform instead of vertical writing mode:
  - Uses `transform -rotate-90 whitespace-nowrap tracking-widest` for a clean Trello-like spine.
- Width collapse behavior from earlier remains, so the column compresses to a slim rail.

If you want the rotate pivot lower/upper (e.g., rotate around left), I can tweak `origin-*` or add slight translate adjustments.

---

**User**

text is in the correct orentation now but we need to address the spacing lets in crease the hight to support longer titles

---

**Cursor**

```typescriptreact
import React, { useState } from "react";
import Card from "./Card";
import type { ListData, CardData } from "../../types/taskManager";
import { Edit, ChevronDown, ChevronUp, Trash2 } from 'lucide-react';
import { useSortable, SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface ListColumnProps {
  list: ListData;
  cards: CardData[];
  boardId: string;
  onAddCard: (listId: string, title: string) => void;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
  onDeleteList: (listId: string) => void;
  cardIdPrefix?: string;
}

const ListColumn: React.FC<ListColumnProps> = ({ list, cards, boardId, onAddCard, onUpdateCard, dndId, onDeleteList, cardIdPrefix = '' }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [addingCard, setAddingCard] = useState(false);
  const [newCardTitle, setNewCardTitle] = useState("");

  // dnd-kit sortable for lists
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };

  const handleAddCard = () => {
    if (!newCardTitle.trim()) return;
    onAddCard(list.id, newCardTitle);
    setNewCardTitle("");
    setAddingCard(false);
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      className={`bg-pb-darker rounded-xl shadow-lg border border-pb-primary/30 flex flex-col flex-shrink-0 transition-all duration-300 ${collapsed ? '!w-14 min-w-[3.5rem] p-0 items-center justify-center bg-pb-primary/20' : 'p-4 min-w-[18rem] w-[20rem]'}`}
    >
      <div className={`flex items-center justify-between mb-4 w-full ${collapsed ? 'flex-col gap-0 mb-0 items-center justify-center' : ''}`} style={collapsed ? { height: '100%' } : {}}>
        {collapsed ? (
          <>
            <div className="flex flex-col items-center justify-center h-full py-8">
              <span className="text-sm font-bold text-pb-primary/80 mb-3 select-none transform -rotate-90 whitespace-nowrap origin-center tracking-widest">
                {list.title}
              </span>
              <button onClick={() => setCollapsed(false)} className="text-pb-primary hover:text-pb-success p-1 rounded mt-2">
                <ChevronDown size={20} />
              </button>
            </div>
          </>
        ) : (
          <>
            <div className="text-lg font-bold text-white tracking-wide text-left">
              {list.title}
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setCollapsed(true)} className="text-pb-primary hover:text-pb-success p-1 rounded">
                <ChevronUp size={20} />
              </button>
              <button className="text-pb-primary hover:text-pb-success p-1 rounded"><Edit size={20} /></button>
              <button className="text-pb-accent hover:text-red-500 p-1 rounded" onClick={() => onDeleteList(list.id)}><Trash2 size={20} /></button>
            </div>
          </>
        )}
      </div>
      {!collapsed && (
        <>
          <SortableContext items={Array.isArray(cards) ? cards.map(card => `${cardIdPrefix}${card.id}`) : []} strategy={verticalListSortingStrategy}>
            <div className="flex-1 flex flex-col gap-3 mb-4">
              {cards.map(card => (
                <Card key={card.id} card={card} onUpdateCard={onUpdateCard} dndId={`${cardIdPrefix}${card.id}`} />
              ))}
            </div>
          </SortableContext>
          {addingCard ? (
            <div className="flex flex-col gap-2 mt-2">
              <input
                className="rounded border border-pb-primary/40 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-pb-primary text-[#222]"
                type="text"
                value={newCardTitle}
                onChange={e => setNewCardTitle(e.target.value)}
                placeholder="Enter a title for this card..."
                autoFocus
                onKeyDown={e => {
                  if (e.key === 'Enter') handleAddCard();
                  if (e.key === 'Escape') { setAddingCard(false); setNewCardTitle(""); }
                }}
              />
              <div className="flex gap-2">
                <button
                  className="bg-pb-success hover:bg-pb-primary text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={handleAddCard}
                >
                  Add
                </button>
                <button
                  className="bg-pb-darker hover:bg-pb-primary/40 text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={() => { setAddingCard(false); setNewCardTitle(""); }}
                >
                  Cancel
                </button>
              </div>
            </div>
          ) : (
            <button className="mt-auto bg-pb-primary/90 hover:bg-pb-success text-white font-semibold py-2 px-3 rounded transition shadow focus:outline-none"
              onClick={() => setAddingCard(true)}
            >
              + Add Card
            </button>
          )}
        </>
      )}
    </div>
  );
};

export default ListColumn; 
```

- Increased collapsed column rail size and spacing to support longer rotated titles:
  - Rail width from 12 to 14 (Tailwind: `!w-14`, `min-w-[3.5rem]`).
  - Vertical padding from `py-3` to `py-8`.
  - Title font size from `text-xs` to `text-sm` and increased bottom margin.
- Title remains rotated and centered; expand/collapse button spacing adjusted.

If we need even more room for very long titles, I can add ellipsis after a set width or allow multi-line wrap with a smaller rotation angle.

---

**User**

can we remove this screen and just go straight to the current board. lets also add the create new board button to after the boards title. if tthere are more then one board turn the title into a dropdown of the board titles that allow the user to swap boards 

---

**Cursor**

```typescriptreact
import React, { useEffect, useState, useRef } from "react";
import { useFirebase } from "../../contexts/FirebaseContext";
import ListColumn from "./ListColumn";
import type { BoardData, ListData, CardData } from "../../types/taskManager";
import { DndContext, closestCenter, PointerSensor, useSensor, useSensors, DragEndEvent, DragOverlay } from '@dnd-kit/core';
import { arrayMove, SortableContext, horizontalListSortingStrategy, verticalListSortingStrategy } from '@dnd-kit/sortable';

interface BoardProps {
  boardId: string;
  hideHeader?: boolean;
}

const Board: React.FC<BoardProps> = ({ boardId, hideHeader }) => {
  const { service } = useFirebase();
  const [board, setBoard] = useState<BoardData | null>(null);
  const [lists, setLists] = useState<ListData[]>([]);
  const [cards, setCards] = useState<Record<string, CardData[]>>({}); // listId -> cards
  const listsRowRef = useRef<HTMLDivElement>(null);
  const isDragging = useRef(false);
  const startX = useRef(0);
  const scrollLeft = useRef(0);
  const [activeDragId, setActiveDragId] = useState<string | null>(null);
  const [activeDragType, setActiveDragType] = useState<'list' | 'card' | null>(null);

  const sensors = useSensors(
    useSensor(PointerSensor, { activationConstraint: { distance: 5 } })
  );

  useEffect(() => {
    // Listen to board document
    const unsubBoard = service.listenToDocument<BoardData>(
      `todo_boards/${boardId}`,
      (doc) => setBoard(doc.data)
    );
    // Listen to lists
    const unsubLists = service.listenToCollection<ListData>(
      `todo_boards/${boardId}/lists`,
      (docs) => {
        const mappedLists = docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled List", cardIds: d.data.cardIds || [] }));
        console.log(`[Board] Lists for board ${boardId}:`, mappedLists);
        setLists(mappedLists);
      },
      (err) => console.error(err)
    );
    // Listen to cards for each list
    let unsubCards: (() => void)[] = [];
    if (lists.length) {
      unsubCards.forEach(unsub => unsub());
      unsubCards = lists.map(list =>
        service.listenToCollection<CardData>(
          `todo_boards/${boardId}/lists/${list.id}/cards`,
          (docs) => setCards(prev => ({ ...prev, [list.id]: docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled Card" })) })),
          (err) => console.error(err)
        )
      );
    }
    return () => {
      unsubBoard();
      unsubLists();
      unsubCards.forEach(unsub => unsub());
    };
  }, [boardId, lists.length]);

  // Drag-to-scroll handlers
  useEffect(() => {
    const row = listsRowRef.current;
    if (!row) return;
    const onMouseDown = (e: MouseEvent) => {
      isDragging.current = true;
      startX.current = e.pageX - row.offsetLeft;
      scrollLeft.current = row.scrollLeft;
      row.classList.add('cursor-grabbing');
    };
    const onMouseLeave = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseUp = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseMove = (e: MouseEvent) => {
      if (!isDragging.current) return;
      e.preventDefault();
      const x = e.pageX - row.offsetLeft;
      const walk = (x - startX.current) * 1.5; // scroll speed
      row.scrollLeft = scrollLeft.current - walk;
    };
    row.addEventListener('mousedown', onMouseDown);
    row.addEventListener('mouseleave', onMouseLeave);
    row.addEventListener('mouseup', onMouseUp);
    row.addEventListener('mousemove', onMouseMove);
    // Touch events for mobile
    let touchStartX = 0;
    let touchScrollLeft = 0;
    const onTouchStart = (e: TouchEvent) => {
      isDragging.current = true;
      touchStartX = e.touches[0].pageX - row.offsetLeft;
      touchScrollLeft = row.scrollLeft;
    };
    const onTouchEnd = () => {
      isDragging.current = false;
    };
    const onTouchMove = (e: TouchEvent) => {
      if (!isDragging.current) return;
      const x = e.touches[0].pageX - row.offsetLeft;
      const walk = (x - touchStartX) * 1.5;
      row.scrollLeft = touchScrollLeft - walk;
    };
    row.addEventListener('touchstart', onTouchStart);
    row.addEventListener('touchend', onTouchEnd);
    row.addEventListener('touchmove', onTouchMove);
    return () => {
      row.removeEventListener('mousedown', onMouseDown);
      row.removeEventListener('mouseleave', onMouseLeave);
      row.removeEventListener('mouseup', onMouseUp);
      row.removeEventListener('mousemove', onMouseMove);
      row.removeEventListener('touchstart', onTouchStart);
      row.removeEventListener('touchend', onTouchEnd);
      row.removeEventListener('touchmove', onTouchMove);
    };
  }, [lists]);

  // Add card handler
  const addCard = async (listId: string, title: string) => {
    if (!title.trim()) return;
    const order = (cards[listId]?.length || 0);
    const newCard = {
      title: title.trim(),
      description: '',
      createdAt: new Date().toISOString(),
      order,
      // Add more fields as needed
    };
    await service.addDocument(`todo_boards/${boardId}/lists/${listId}/cards`, newCard);
    // The listener will update state
  };

  // Update card handler
  const updateCard = async (cardId: string, updates: Partial<CardData>) => {
    // Find the list containing this card
    const listId = Object.keys(cards).find(lid => cards[lid].some(card => card.id === cardId));
    if (!listId) return;
    await service.updateDocument(`todo_boards/${boardId}/lists/${listId}/cards`, cardId, updates);
  };

  const handleListDragEnd = async (event: DragEndEvent) => {
    if (!board) return;
    const { active, over } = event;
    if (!over || !active) return;
    if (!Array.isArray(board.listIds)) return;
    const activeId = String(active.id).replace(/^list-/, '');
    const overId = String(over.id).replace(/^list-/, '');
    const oldIndex = board.listIds.indexOf(activeId);
    const newIndex = board.listIds.indexOf(overId);
    if (oldIndex === -1 || newIndex === -1) return;
    if (oldIndex !== newIndex) {
      const newListIds = arrayMove(board.listIds, oldIndex, newIndex);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  // --- NEW: Card drag handler for cross-list movement ---
  const handleCardDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    if (!over || !active) return;
    const activeCardId = String(active.id).replace(/^card-/, '');
    let sourceListId: string | undefined;
    let destListId: string | undefined;
    for (const list of lists) {
      const idx = (cards[list.id] || []).findIndex(card => card.id === activeCardId);
      if (idx !== -1) {
        sourceListId = list.id;
        break;
      }
    }
    for (const list of lists) {
      if (over.data?.current?.sortable?.containerId === `list-${list.id}` || over.id === `list-${list.id}`) {
        destListId = list.id;
        break;
      }
      if ((cards[list.id] || []).some(card => `card-${card.id}` === over.id)) {
        destListId = list.id;
        break;
      }
    }
    if (!sourceListId || !destListId) return;
    if (sourceListId === destListId) {
      const cardList = cards[sourceListId] || [];
      const oldIdx = cardList.findIndex(card => card.id === activeCardId);
      const newIdx = cardList.findIndex(card => `card-${card.id}` === over.id);
      if (oldIdx === -1 || newIdx === -1 || oldIdx === newIdx) return;
      const newCards = arrayMove(cardList, oldIdx, newIdx);
      for (let i = 0; i < newCards.length; i++) {
        await service.updateDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, newCards[i].id, { order: i });
      }
      return;
    }
    const sourceCards = [...(cards[sourceListId] || [])];
    const destCards = [...(cards[destListId] || [])];
    const movingCardIdx = sourceCards.findIndex(card => card.id === activeCardId);
    if (movingCardIdx === -1) return;
    const [movingCard] = sourceCards.splice(movingCardIdx, 1);
    let insertIdx = destCards.findIndex(card => `card-${card.id}` === over.id);
    if (insertIdx === -1) insertIdx = destCards.length;
    destCards.splice(insertIdx, 0, movingCard);
    await service.deleteDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, movingCard.id);
    await service.addDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, { ...movingCard, order: insertIdx });
    for (let i = 0; i < destCards.length; i++) {
      await service.updateDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, destCards[i].id, { order: i });
    }
  };

  // Add deleteList handler
  const deleteList = async (listId: string) => {
    // Remove list document
    await service.deleteDocument(`todo_boards/${boardId}/lists`, listId);
    // Remove from board.listIds
    if (board && Array.isArray(board.listIds)) {
      const newListIds = board.listIds.filter(id => id !== listId);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  if (!board) return <div>Loading board...</div>;

  // Deduplicate lists by name (case-insensitive)
  const uniqueLists = lists.filter(
    (list, index, self) =>
      list.title &&
      self.findIndex(l => l.title?.toLowerCase() === list.title?.toLowerCase()) === index
  );

  // If listIds is missing or not an array, just show all unique lists
  if (!Array.isArray(board.listIds) || board.listIds.length === 0) {
    if (uniqueLists.length === 0) return <div>No lists found for this board.</div>;
    return (
      <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30">
        <div className="flex-1 flex flex-col min-h-0">
          {/* Board Title as sticky header */}
          {!hideHeader && (
            <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
              <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
            </div>
          )}
          {/* Lists Row Scrollable Area */}
          <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-hidden">
            <DndContext
              sensors={sensors}
              collisionDetection={closestCenter}
              onDragStart={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) setActiveDragType('list');
                else if (id.startsWith('card-')) setActiveDragType('card');
                else setActiveDragType(null);
                setActiveDragId(id);
              }}
              onDragEnd={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) handleListDragEnd(event);
                else if (id.startsWith('card-')) handleCardDragEnd(event);
                setActiveDragId(null);
                setActiveDragType(null);
              }}
              onDragCancel={() => {
                setActiveDragId(null);
                setActiveDragType(null);
              }}
            >
              <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
            <div
              ref={listsRowRef}
              className="flex items-start space-x-6 h-full cursor-grab min-w-full pr-6"
              style={{ WebkitOverflowScrolling: 'touch' }}
            >
                  {Array.isArray(board.listIds) && board.listIds.length > 0
                    ? board.listIds.map(listId => {
                        const list = lists.find(l => l.id === listId);
                        if (!list) return null;
                        return (
                          <ListColumn
                            key={list.id}
                            list={list}
                            cards={cards[list.id] || []}
                            boardId={boardId}
                            onAddCard={addCard}
                            onUpdateCard={updateCard}
                            dndId={`list-${list.id}`}
                            onDeleteList={deleteList}
                            cardIdPrefix="card-"
                          />
                        );
                      })
                    : uniqueLists.map(list => (
                <ListColumn
                  key={list.id}
                  list={list}
                  cards={cards[list.id] || []}
                  boardId={boardId}
                  onAddCard={addCard}
                  onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                />
              ))}
              {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
            </div>
              </SortableContext>
              <DragOverlay>
                {activeDragType === 'card' && activeDragId ? (() => {
                  // Find the card data
                  let card: CardData | undefined;
                  for (const list of lists) {
                    card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                    if (card) break;
                  }
                  return card ? (
                    <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                      <div className="font-semibold">{card.title}</div>
                      {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                    </div>
                  ) : null;
                })() : null}
                {activeDragType === 'list' && activeDragId ? (() => {
                  // Find the list data
                  const list = lists.find(l => `list-${l.id}` === activeDragId);
                  return list ? (
                    <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                      <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                    </div>
                  ) : null;
                })() : null}
              </DragOverlay>
            </DndContext>
          </div>
        </div>
        {/* FAB to add a list */}
        <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
          +
        </button>
      </div>
    );
  }

  return (
    <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30">
      <div className="flex-1 flex flex-col min-h-0">
        {/* Board Title as sticky header */}
        {!hideHeader && (
          <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
            <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
          </div>
        )}
        {/* Lists Row Scrollable Area */}
        <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-hidden">
          <DndContext
            sensors={sensors}
            collisionDetection={closestCenter}
            onDragStart={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) setActiveDragType('list');
              else if (id.startsWith('card-')) setActiveDragType('card');
              else setActiveDragType(null);
              setActiveDragId(id);
            }}
            onDragEnd={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) handleListDragEnd(event);
              else if (id.startsWith('card-')) handleCardDragEnd(event);
              setActiveDragId(null);
              setActiveDragType(null);
            }}
            onDragCancel={() => {
              setActiveDragId(null);
              setActiveDragType(null);
            }}
          >
            <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
          <div
            ref={listsRowRef}
            className="flex items-start space-x-6 h-full cursor-grab min-w-full pr-6"
            style={{ WebkitOverflowScrolling: 'touch' }}
          >
            {Array.isArray(board.listIds) && board.listIds.length > 0
              ? board.listIds.map(listId => {
                  const list = lists.find(l => l.id === listId);
                  if (!list) return null;
                  return (
                    <ListColumn
                      key={list.id}
                      list={list}
                      cards={cards[list.id] || []}
                      boardId={boardId}
                      onAddCard={addCard}
                      onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                    />
                  );
                })
              : uniqueLists.map(list => (
                  <ListColumn
                    key={list.id}
                    list={list}
                    cards={cards[list.id] || []}
                    boardId={boardId}
                    onAddCard={addCard}
                    onUpdateCard={updateCard}
                        dndId={`list-${list.id}`}
                        onDeleteList={deleteList}
                        cardIdPrefix="card-"
                  />
                ))}
            {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
          </div>
            </SortableContext>
            <DragOverlay>
              {activeDragType === 'card' && activeDragId ? (() => {
                // Find the card data
                let card: CardData | undefined;
                for (const list of lists) {
                  card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                  if (card) break;
                }
                return card ? (
                  <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                    <div className="font-semibold">{card.title}</div>
                    {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                  </div>
                ) : null;
              })() : null}
              {activeDragType === 'list' && activeDragId ? (() => {
                // Find the list data
                const list = lists.find(l => `list-${l.id}` === activeDragId);
                return list ? (
                  <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                    <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                  </div>
                ) : null;
              })() : null}
            </DragOverlay>
          </DndContext>
        </div>
      </div>
      {/* FAB to add a list */}
      <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
        +
      </button>
    </div>
  );
};

export default Board; 
```

```typescriptreact
import React, { useState, useEffect } from "react";
import DashboardLayout from "../PropsBibleHomepage";
import { motion } from "framer-motion";
import { Calendar } from "lucide-react";
import { useFirebase } from "../contexts/FirebaseContext";
import type { BoardData } from "../types/taskManager";
import Board from "../components/TaskBoard/Board";
import { useShowSelection } from "../contexts/ShowSelectionContext";
import type { Show } from "../types/Show";
import { useWebAuth } from '../contexts/WebAuthContext';
import { BrowserRouter, Routes, Route, Navigate } from "react-router-dom";
import { ShowSelectionProvider } from "../contexts/ShowSelectionContext";
import Login from "../pages/Login";
import Signup from "../pages/Signup";
import ForgotPassword from "../pages/ForgotPassword";
import EditPropPage from "../pages/EditPropPage";
import PropDetailPage from "../pages/PropDetailPage";
import PropsListPage from '../PropsListPage';
import DashboardHome from '../DashboardHome';
import ShowsListPage from '../ShowsListPage';
import AddShowPage from "../pages/AddShowPage";
import EditShowPage from "../pages/EditShowPage";
import ShowDetailPage from "../pages/ShowDetailPage";
import PropsBibleHomepage from '../PropsBibleHomepage';

const BoardsPage: React.FC = () => {
  const { service } = useFirebase();
  const [showForm, setShowForm] = useState(false);
  const [boardName, setBoardName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [boards, setBoards] = useState<BoardData[]>([]);
  const [selectedBoardId, setSelectedBoardId] = useState<string | null>(null);
  const { currentShowId } = useShowSelection();
  const [showTitle, setShowTitle] = useState<string>("");
  const { user } = useWebAuth();

  console.log("[BoardsPage] currentShowId:", currentShowId);
  console.log("[BoardsPage] Current user:", user);

  useEffect(() => {
    // Listen to boards collection, filter by showId if selected
    const unsub = service.listenToCollection<BoardData>(
      "todo_boards",
      docs => {
        console.log("[BoardsPage] Raw docs from Firestore:", docs);
        const mappedBoards = docs.map(d => ({
          ...d.data,
          id: d.id,
          title: d.data.title || d.data.name || "Untitled Board",
          listIds: d.data.listIds || [],
        }));
        console.log("[BoardsPage] currentShowId:", currentShowId);
        mappedBoards.forEach(b => console.log(`[BoardsPage] Board: ${b.title}, showId: ${b.showId}`));
        console.log("[BoardsPage] Mapped boards before filtering:", mappedBoards);
        const filteredBoards = mappedBoards.filter(b => !currentShowId || b.showId === currentShowId);
        console.log("[BoardsPage] Filtered boards:", filteredBoards);
        setBoards(filteredBoards);
      },
      err => setError(err.message || "Failed to load boards")
    );
    return () => unsub();
  }, [service, currentShowId]);

  useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  useEffect(() => {
    service.getDocuments("todo_boards").then(docs => {
      console.log("[BoardsPage] Manual fetch docs:", docs);
    }).catch(err => {
      console.error("[BoardsPage] Manual fetch error:", err);
    });
  }, [service]);

  const handleCreateBoard = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      // Create a new board in Firestore
      await service.addDocument("boards", {
        title: boardName,
        listIds: [],
        createdAt: new Date(),
      });
      setBoardName("");
      setShowForm(false);
    } catch (err: any) {
      setError(err.message || "Failed to create board");
    } finally {
      setLoading(false);
    }
  };

  return (
    <ShowSelectionProvider>
      <BrowserRouter>
        <Routes>
          <Route path="/login" element={!user ? <Login /> : <Navigate to="/" replace />} />
          <Route path="/signup" element={!user ? <Signup /> : <Navigate to="/" replace />} />
          <Route path="/forgot-password" element={!user ? <ForgotPassword /> : <Navigate to="/" replace />} />
          <Route path="/props/:id/edit" element={user ? <EditPropPage /> : <Navigate to="/login" replace />} />
          <Route path="/props/:id" element={user ? <PropDetailPage /> : <Navigate to="/login" replace />} />
          <Route path="/props" element={user ? <PropsListPage /> : <Navigate to="/login" replace />} />
          <Route path="/" element={user ? <DashboardHome /> : <Navigate to="/login" replace />} />
          <Route path="/shows" element={<ShowsListPage />} />
          <Route path="/shows/new" element={<AddShowPage />} />
          <Route path="/shows/:id/edit" element={<EditShowPage />} />
          <Route path="/shows/:id" element={<ShowDetailPage />} />
          <Route path="/boards" element={user ? <BoardsPageContent /> : <Navigate to="/login" replace />} />
          <Route path="/*" element={user ? <PropsBibleHomepage>{<DashboardHome />}</PropsBibleHomepage> : <Navigate to="/login" replace />} />
        </Routes>
      </BrowserRouter>
    </ShowSelectionProvider>
  );
};

function BoardsPageContent() {
  const { service } = useFirebase();
  const [showForm, setShowForm] = useState(false);
  const [boardName, setBoardName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [boards, setBoards] = useState<BoardData[]>([]);
  const [selectedBoardId, setSelectedBoardId] = useState<string | null>(null);
  const { currentShowId } = useShowSelection();
  const [showTitle, setShowTitle] = useState<string>("");
  const { user } = useWebAuth();

  console.log("[BoardsPage] currentShowId:", currentShowId);
  console.log("[BoardsPage] Current user:", user);

  useEffect(() => {
    // Listen to boards collection, filter by showId if selected
    const unsub = service.listenToCollection<BoardData>(
      "todo_boards",
      docs => {
        console.log("[BoardsPage] Raw docs from Firestore:", docs);
        const mappedBoards = docs.map(d => ({
          ...d.data,
          id: d.id,
          title: d.data.title || d.data.name || "Untitled Board",
          listIds: d.data.listIds || [],
        }));
        console.log("[BoardsPage] currentShowId:", currentShowId);
        mappedBoards.forEach(b => console.log(`[BoardsPage] Board: ${b.title}, showId: ${b.showId}`));
        console.log("[BoardsPage] Mapped boards before filtering:", mappedBoards);
        const filteredBoards = mappedBoards.filter(b => !currentShowId || b.showId === currentShowId);
        console.log("[BoardsPage] Filtered boards:", filteredBoards);
        setBoards(filteredBoards);
      },
      err => setError(err.message || "Failed to load boards")
    );
    return () => unsub();
  }, [service, currentShowId]);

  useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  useEffect(() => {
    service.getDocuments("todo_boards").then(docs => {
      console.log("[BoardsPage] Manual fetch docs:", docs);
    }).catch(err => {
      console.error("[BoardsPage] Manual fetch error:", err);
    });
  }, [service]);

  const handleCreateBoard = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      // Create a new board in Firestore
      await service.addDocument("boards", {
        title: boardName,
        listIds: [],
        createdAt: new Date(),
      });
      setBoardName("");
      setShowForm(false);
    } catch (err: any) {
      setError(err.message || "Failed to create board");
    } finally {
      setLoading(false);
    }
  };

  // If there is exactly one board, auto open it. If more than one, open the first.
  const effectiveBoardId = selectedBoardId || boards[0]?.id || null;

  return (
    <DashboardLayout>
      {effectiveBoardId ? (
        <div className="w-full">
          {/* Header with title, dropdown if multiple boards, and create button */}
          <div className="sticky top-0 z-10 bg-pb-darker/60 backdrop-blur-sm border-b border-pb-primary/20">
            <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Calendar className="w-6 h-6 text-pb-primary" />
                {boards.length > 1 ? (
                  <select
                    className="bg-pb-darker/50 border border-pb-primary/30 text-white rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    value={effectiveBoardId}
                    onChange={e => setSelectedBoardId(e.target.value)}
                  >
                    {boards.map(b => (
                      <option key={b.id} value={b.id}>{b.title}</option>
                    ))}
                  </select>
                ) : (
                  <h1 className="text-2xl font-bold text-white">{boards[0]?.title || 'Board'}</h1>
                )}
              </div>
              <button
                className="bg-pb-primary text-white px-4 py-2 rounded hover:bg-pb-secondary transition"
                onClick={() => setShowForm(v => !v)}
              >
                New Board
              </button>
            </div>
            {showForm && (
              <div className="max-w-7xl mx-auto px-4 pb-4">
                <form onSubmit={handleCreateBoard} className="flex items-center gap-2 max-w-md">
                  <input
                    className="flex-1 px-3 py-2 rounded border border-pb-primary/40 bg-pb-darker text-white focus:outline-none"
                    type="text"
                    placeholder="Board name"
                    value={boardName}
                    onChange={e => setBoardName(e.target.value)}
                    required
                    disabled={loading}
                  />
                  <button
                    type="submit"
                    className="bg-pb-success text-white px-4 py-2 rounded hover:bg-pb-primary transition"
                    disabled={loading || !boardName.trim()}
                  >
                    {loading ? 'Creating...' : 'Create'}
                  </button>
                  {error && <div className="text-red-400 text-xs mt-2">{error}</div>}
                </form>
              </div>
            )}
          </div>
          <Board boardId={effectiveBoardId} hideHeader />
        </div>
      ) : (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="max-w-7xl mx-auto mt-8 px-4"
        >
          <div className="text-center text-pb-gray">No boards yet. Create your first board.</div>
          <div className="flex justify-center mt-4">
            <button
              className="bg-pb-primary text-white px-4 py-2 rounded hover:bg-pb-secondary transition"
              onClick={() => setShowForm(true)}
            >
              Create Board
            </button>
          </div>
          {showForm && (
            <form onSubmit={handleCreateBoard} className="flex flex-col items-center w-full max-w-xs mt-4 mx-auto">
              <input
                className="w-full px-3 py-2 rounded border border-pb-primary/40 mb-2 bg-pb-darker text-white focus:outline-none"
                type="text"
                placeholder="Board name"
                value={boardName}
                onChange={e => setBoardName(e.target.value)}
                required
                disabled={loading}
              />
              <button
                type="submit"
                className="bg-pb-success text-white px-4 py-2 rounded hover:bg-pb-primary transition w-full"
                disabled={loading || !boardName.trim()}
              >
                {loading ? 'Creating...' : 'Create'}
              </button>
              {error && <div className="text-red-400 text-xs mt-2">{error}</div>}
            </form>
          )}
        </motion.div>
      )}
    </DashboardLayout>
  );
}

export default BoardsPageContent; 
```

- Removed the intermediate “boards overview” screen when boards exist:
  - Auto-opens the current board; if multiple boards exist, shows a sticky header with a dropdown to switch boards.
  - Added “New Board” button next to the title; reveals inline create form.
  - If no boards exist, a minimal create-first-board view is shown.

- Updated `Board` to support an optional `hideHeader` prop so we can render the header once in `BoardsPage`.

Files changed:
- `web-app/src/pages/BoardsPage.tsx`
- `web-app/src/components/TaskBoard/Board.tsx`

This should take you directly into the board and allow quick switching/creation from the header.

---

**User**

the create button is off screen and we have some horizontal issuesthe background is not scrolling

---

**Cursor**

```typescriptreact
import React, { useEffect, useState, useRef } from "react";
import { useFirebase } from "../../contexts/FirebaseContext";
import ListColumn from "./ListColumn";
import type { BoardData, ListData, CardData } from "../../types/taskManager";
import { DndContext, closestCenter, PointerSensor, useSensor, useSensors, DragEndEvent, DragOverlay } from '@dnd-kit/core';
import { arrayMove, SortableContext, horizontalListSortingStrategy, verticalListSortingStrategy } from '@dnd-kit/sortable';

interface BoardProps {
  boardId: string;
  hideHeader?: boolean;
}

const Board: React.FC<BoardProps> = ({ boardId, hideHeader }) => {
  const { service } = useFirebase();
  const [board, setBoard] = useState<BoardData | null>(null);
  const [lists, setLists] = useState<ListData[]>([]);
  const [cards, setCards] = useState<Record<string, CardData[]>>({}); // listId -> cards
  const listsRowRef = useRef<HTMLDivElement>(null);
  const isDragging = useRef(false);
  const startX = useRef(0);
  const scrollLeft = useRef(0);
  const [activeDragId, setActiveDragId] = useState<string | null>(null);
  const [activeDragType, setActiveDragType] = useState<'list' | 'card' | null>(null);

  const sensors = useSensors(
    useSensor(PointerSensor, { activationConstraint: { distance: 5 } })
  );

  useEffect(() => {
    // Listen to board document
    const unsubBoard = service.listenToDocument<BoardData>(
      `todo_boards/${boardId}`,
      (doc) => setBoard(doc.data)
    );
    // Listen to lists
    const unsubLists = service.listenToCollection<ListData>(
      `todo_boards/${boardId}/lists`,
      (docs) => {
        const mappedLists = docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled List", cardIds: d.data.cardIds || [] }));
        console.log(`[Board] Lists for board ${boardId}:`, mappedLists);
        setLists(mappedLists);
      },
      (err) => console.error(err)
    );
    // Listen to cards for each list
    let unsubCards: (() => void)[] = [];
    if (lists.length) {
      unsubCards.forEach(unsub => unsub());
      unsubCards = lists.map(list =>
        service.listenToCollection<CardData>(
          `todo_boards/${boardId}/lists/${list.id}/cards`,
          (docs) => setCards(prev => ({ ...prev, [list.id]: docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled Card" })) })),
          (err) => console.error(err)
        )
      );
    }
    return () => {
      unsubBoard();
      unsubLists();
      unsubCards.forEach(unsub => unsub());
    };
  }, [boardId, lists.length]);

  // Drag-to-scroll handlers
  useEffect(() => {
    const row = listsRowRef.current;
    if (!row) return;
    const onMouseDown = (e: MouseEvent) => {
      isDragging.current = true;
      startX.current = e.pageX - row.offsetLeft;
      scrollLeft.current = row.scrollLeft;
      row.classList.add('cursor-grabbing');
    };
    const onMouseLeave = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseUp = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseMove = (e: MouseEvent) => {
      if (!isDragging.current) return;
      e.preventDefault();
      const x = e.pageX - row.offsetLeft;
      const walk = (x - startX.current) * 1.5; // scroll speed
      row.scrollLeft = scrollLeft.current - walk;
    };
    row.addEventListener('mousedown', onMouseDown);
    row.addEventListener('mouseleave', onMouseLeave);
    row.addEventListener('mouseup', onMouseUp);
    row.addEventListener('mousemove', onMouseMove);
    // Touch events for mobile
    let touchStartX = 0;
    let touchScrollLeft = 0;
    const onTouchStart = (e: TouchEvent) => {
      isDragging.current = true;
      touchStartX = e.touches[0].pageX - row.offsetLeft;
      touchScrollLeft = row.scrollLeft;
    };
    const onTouchEnd = () => {
      isDragging.current = false;
    };
    const onTouchMove = (e: TouchEvent) => {
      if (!isDragging.current) return;
      const x = e.touches[0].pageX - row.offsetLeft;
      const walk = (x - touchStartX) * 1.5;
      row.scrollLeft = touchScrollLeft - walk;
    };
    row.addEventListener('touchstart', onTouchStart);
    row.addEventListener('touchend', onTouchEnd);
    row.addEventListener('touchmove', onTouchMove);
    return () => {
      row.removeEventListener('mousedown', onMouseDown);
      row.removeEventListener('mouseleave', onMouseLeave);
      row.removeEventListener('mouseup', onMouseUp);
      row.removeEventListener('mousemove', onMouseMove);
      row.removeEventListener('touchstart', onTouchStart);
      row.removeEventListener('touchend', onTouchEnd);
      row.removeEventListener('touchmove', onTouchMove);
    };
  }, [lists]);

  // Add card handler
  const addCard = async (listId: string, title: string) => {
    if (!title.trim()) return;
    const order = (cards[listId]?.length || 0);
    const newCard = {
      title: title.trim(),
      description: '',
      createdAt: new Date().toISOString(),
      order,
      // Add more fields as needed
    };
    await service.addDocument(`todo_boards/${boardId}/lists/${listId}/cards`, newCard);
    // The listener will update state
  };

  // Update card handler
  const updateCard = async (cardId: string, updates: Partial<CardData>) => {
    // Find the list containing this card
    const listId = Object.keys(cards).find(lid => cards[lid].some(card => card.id === cardId));
    if (!listId) return;
    await service.updateDocument(`todo_boards/${boardId}/lists/${listId}/cards`, cardId, updates);
  };

  const handleListDragEnd = async (event: DragEndEvent) => {
    if (!board) return;
    const { active, over } = event;
    if (!over || !active) return;
    if (!Array.isArray(board.listIds)) return;
    const activeId = String(active.id).replace(/^list-/, '');
    const overId = String(over.id).replace(/^list-/, '');
    const oldIndex = board.listIds.indexOf(activeId);
    const newIndex = board.listIds.indexOf(overId);
    if (oldIndex === -1 || newIndex === -1) return;
    if (oldIndex !== newIndex) {
      const newListIds = arrayMove(board.listIds, oldIndex, newIndex);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  // --- NEW: Card drag handler for cross-list movement ---
  const handleCardDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    if (!over || !active) return;
    const activeCardId = String(active.id).replace(/^card-/, '');
    let sourceListId: string | undefined;
    let destListId: string | undefined;
    for (const list of lists) {
      const idx = (cards[list.id] || []).findIndex(card => card.id === activeCardId);
      if (idx !== -1) {
        sourceListId = list.id;
        break;
      }
    }
    for (const list of lists) {
      if (over.data?.current?.sortable?.containerId === `list-${list.id}` || over.id === `list-${list.id}`) {
        destListId = list.id;
        break;
      }
      if ((cards[list.id] || []).some(card => `card-${card.id}` === over.id)) {
        destListId = list.id;
        break;
      }
    }
    if (!sourceListId || !destListId) return;
    if (sourceListId === destListId) {
      const cardList = cards[sourceListId] || [];
      const oldIdx = cardList.findIndex(card => card.id === activeCardId);
      const newIdx = cardList.findIndex(card => `card-${card.id}` === over.id);
      if (oldIdx === -1 || newIdx === -1 || oldIdx === newIdx) return;
      const newCards = arrayMove(cardList, oldIdx, newIdx);
      for (let i = 0; i < newCards.length; i++) {
        await service.updateDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, newCards[i].id, { order: i });
      }
      return;
    }
    const sourceCards = [...(cards[sourceListId] || [])];
    const destCards = [...(cards[destListId] || [])];
    const movingCardIdx = sourceCards.findIndex(card => card.id === activeCardId);
    if (movingCardIdx === -1) return;
    const [movingCard] = sourceCards.splice(movingCardIdx, 1);
    let insertIdx = destCards.findIndex(card => `card-${card.id}` === over.id);
    if (insertIdx === -1) insertIdx = destCards.length;
    destCards.splice(insertIdx, 0, movingCard);
    await service.deleteDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, movingCard.id);
    await service.addDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, { ...movingCard, order: insertIdx });
    for (let i = 0; i < destCards.length; i++) {
      await service.updateDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, destCards[i].id, { order: i });
    }
  };

  // Add deleteList handler
  const deleteList = async (listId: string) => {
    // Remove list document
    await service.deleteDocument(`todo_boards/${boardId}/lists`, listId);
    // Remove from board.listIds
    if (board && Array.isArray(board.listIds)) {
      const newListIds = board.listIds.filter(id => id !== listId);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  if (!board) return <div>Loading board...</div>;

  // Deduplicate lists by name (case-insensitive)
  const uniqueLists = lists.filter(
    (list, index, self) =>
      list.title &&
      self.findIndex(l => l.title?.toLowerCase() === list.title?.toLowerCase()) === index
  );

  // If listIds is missing or not an array, just show all unique lists
  if (!Array.isArray(board.listIds) || board.listIds.length === 0) {
    if (uniqueLists.length === 0) return <div>No lists found for this board.</div>;
    return (
      <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 overflow-x-hidden">
        <div className="flex-1 flex flex-col min-h-0">
          {/* Board Title as sticky header */}
          {!hideHeader && (
            <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
              <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
            </div>
          )}
          {/* Lists Row Scrollable Area */}
          <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-hidden">
            <DndContext
              sensors={sensors}
              collisionDetection={closestCenter}
              onDragStart={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) setActiveDragType('list');
                else if (id.startsWith('card-')) setActiveDragType('card');
                else setActiveDragType(null);
                setActiveDragId(id);
              }}
              onDragEnd={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) handleListDragEnd(event);
                else if (id.startsWith('card-')) handleCardDragEnd(event);
                setActiveDragId(null);
                setActiveDragType(null);
              }}
              onDragCancel={() => {
                setActiveDragId(null);
                setActiveDragType(null);
              }}
            >
              <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
            <div
              ref={listsRowRef}
              className="flex items-start space-x-6 h-full cursor-grab min-w-full pr-6"
              style={{ WebkitOverflowScrolling: 'touch' }}
            >
                  {Array.isArray(board.listIds) && board.listIds.length > 0
                    ? board.listIds.map(listId => {
                        const list = lists.find(l => l.id === listId);
                        if (!list) return null;
                        return (
                          <ListColumn
                            key={list.id}
                            list={list}
                            cards={cards[list.id] || []}
                            boardId={boardId}
                            onAddCard={addCard}
                            onUpdateCard={updateCard}
                            dndId={`list-${list.id}`}
                            onDeleteList={deleteList}
                            cardIdPrefix="card-"
                          />
                        );
                      })
                    : uniqueLists.map(list => (
                <ListColumn
                  key={list.id}
                  list={list}
                  cards={cards[list.id] || []}
                  boardId={boardId}
                  onAddCard={addCard}
                  onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                />
              ))}
              {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
            </div>
              </SortableContext>
              <DragOverlay>
                {activeDragType === 'card' && activeDragId ? (() => {
                  // Find the card data
                  let card: CardData | undefined;
                  for (const list of lists) {
                    card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                    if (card) break;
                  }
                  return card ? (
                    <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                      <div className="font-semibold">{card.title}</div>
                      {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                    </div>
                  ) : null;
                })() : null}
                {activeDragType === 'list' && activeDragId ? (() => {
                  // Find the list data
                  const list = lists.find(l => `list-${l.id}` === activeDragId);
                  return list ? (
                    <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                      <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                    </div>
                  ) : null;
                })() : null}
              </DragOverlay>
            </DndContext>
          </div>
        </div>
        {/* FAB to add a list */}
        <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
          +
        </button>
      </div>
    );
  }

  return (
    <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 overflow-x-hidden">
      <div className="flex-1 flex flex-col min-h-0">
        {/* Board Title as sticky header */}
        {!hideHeader && (
          <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
            <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
          </div>
        )}
        {/* Lists Row Scrollable Area */}
        <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-hidden">
          <DndContext
            sensors={sensors}
            collisionDetection={closestCenter}
            onDragStart={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) setActiveDragType('list');
              else if (id.startsWith('card-')) setActiveDragType('card');
              else setActiveDragType(null);
              setActiveDragId(id);
            }}
            onDragEnd={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) handleListDragEnd(event);
              else if (id.startsWith('card-')) handleCardDragEnd(event);
              setActiveDragId(null);
              setActiveDragType(null);
            }}
            onDragCancel={() => {
              setActiveDragId(null);
              setActiveDragType(null);
            }}
          >
            <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
          <div
            ref={listsRowRef}
            className="flex items-start space-x-6 h-full cursor-grab min-w-full pr-6"
            style={{ WebkitOverflowScrolling: 'touch' }}
          >
            {Array.isArray(board.listIds) && board.listIds.length > 0
              ? board.listIds.map(listId => {
                  const list = lists.find(l => l.id === listId);
                  if (!list) return null;
                  return (
                    <ListColumn
                      key={list.id}
                      list={list}
                      cards={cards[list.id] || []}
                      boardId={boardId}
                      onAddCard={addCard}
                      onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                    />
                  );
                })
              : uniqueLists.map(list => (
                  <ListColumn
                    key={list.id}
                    list={list}
                    cards={cards[list.id] || []}
                    boardId={boardId}
                    onAddCard={addCard}
                    onUpdateCard={updateCard}
                        dndId={`list-${list.id}`}
                        onDeleteList={deleteList}
                        cardIdPrefix="card-"
                  />
                ))}
            {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
          </div>
            </SortableContext>
            <DragOverlay>
              {activeDragType === 'card' && activeDragId ? (() => {
                // Find the card data
                let card: CardData | undefined;
                for (const list of lists) {
                  card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                  if (card) break;
                }
                return card ? (
                  <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                    <div className="font-semibold">{card.title}</div>
                    {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                  </div>
                ) : null;
              })() : null}
              {activeDragType === 'list' && activeDragId ? (() => {
                // Find the list data
                const list = lists.find(l => `list-${l.id}` === activeDragId);
                return list ? (
                  <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                    <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                  </div>
                ) : null;
              })() : null}
            </DragOverlay>
          </DndContext>
        </div>
      </div>
      {/* FAB to add a list */}
      <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
        +
      </button>
    </div>
  );
};

export default Board; 
```

```typescriptreact
import React, { useState, useEffect } from "react";
import DashboardLayout from "../PropsBibleHomepage";
import { motion } from "framer-motion";
import { Calendar } from "lucide-react";
import { useFirebase } from "../contexts/FirebaseContext";
import type { BoardData } from "../types/taskManager";
import Board from "../components/TaskBoard/Board";
import { useShowSelection } from "../contexts/ShowSelectionContext";
import type { Show } from "../types/Show";
import { useWebAuth } from '../contexts/WebAuthContext';
import { BrowserRouter, Routes, Route, Navigate } from "react-router-dom";
import { ShowSelectionProvider } from "../contexts/ShowSelectionContext";
import Login from "../pages/Login";
import Signup from "../pages/Signup";
import ForgotPassword from "../pages/ForgotPassword";
import EditPropPage from "../pages/EditPropPage";
import PropDetailPage from "../pages/PropDetailPage";
import PropsListPage from '../PropsListPage';
import DashboardHome from '../DashboardHome';
import ShowsListPage from '../ShowsListPage';
import AddShowPage from "../pages/AddShowPage";
import EditShowPage from "../pages/EditShowPage";
import ShowDetailPage from "../pages/ShowDetailPage";
import PropsBibleHomepage from '../PropsBibleHomepage';

const BoardsPage: React.FC = () => {
  const { service } = useFirebase();
  const [showForm, setShowForm] = useState(false);
  const [boardName, setBoardName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [boards, setBoards] = useState<BoardData[]>([]);
  const [selectedBoardId, setSelectedBoardId] = useState<string | null>(null);
  const { currentShowId } = useShowSelection();
  const [showTitle, setShowTitle] = useState<string>("");
  const { user } = useWebAuth();

  console.log("[BoardsPage] currentShowId:", currentShowId);
  console.log("[BoardsPage] Current user:", user);

  useEffect(() => {
    // Listen to boards collection, filter by showId if selected
    const unsub = service.listenToCollection<BoardData>(
      "todo_boards",
      docs => {
        console.log("[BoardsPage] Raw docs from Firestore:", docs);
        const mappedBoards = docs.map(d => ({
          ...d.data,
          id: d.id,
          title: d.data.title || d.data.name || "Untitled Board",
          listIds: d.data.listIds || [],
        }));
        console.log("[BoardsPage] currentShowId:", currentShowId);
        mappedBoards.forEach(b => console.log(`[BoardsPage] Board: ${b.title}, showId: ${b.showId}`));
        console.log("[BoardsPage] Mapped boards before filtering:", mappedBoards);
        const filteredBoards = mappedBoards.filter(b => !currentShowId || b.showId === currentShowId);
        console.log("[BoardsPage] Filtered boards:", filteredBoards);
        setBoards(filteredBoards);
      },
      err => setError(err.message || "Failed to load boards")
    );
    return () => unsub();
  }, [service, currentShowId]);

  useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  useEffect(() => {
    service.getDocuments("todo_boards").then(docs => {
      console.log("[BoardsPage] Manual fetch docs:", docs);
    }).catch(err => {
      console.error("[BoardsPage] Manual fetch error:", err);
    });
  }, [service]);

  const handleCreateBoard = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      // Create a new board in Firestore
      await service.addDocument("boards", {
        title: boardName,
        listIds: [],
        createdAt: new Date(),
      });
      setBoardName("");
      setShowForm(false);
    } catch (err: any) {
      setError(err.message || "Failed to create board");
    } finally {
      setLoading(false);
    }
  };

  return (
    <ShowSelectionProvider>
      <BrowserRouter>
        <Routes>
          <Route path="/login" element={!user ? <Login /> : <Navigate to="/" replace />} />
          <Route path="/signup" element={!user ? <Signup /> : <Navigate to="/" replace />} />
          <Route path="/forgot-password" element={!user ? <ForgotPassword /> : <Navigate to="/" replace />} />
          <Route path="/props/:id/edit" element={user ? <EditPropPage /> : <Navigate to="/login" replace />} />
          <Route path="/props/:id" element={user ? <PropDetailPage /> : <Navigate to="/login" replace />} />
          <Route path="/props" element={user ? <PropsListPage /> : <Navigate to="/login" replace />} />
          <Route path="/" element={user ? <DashboardHome /> : <Navigate to="/login" replace />} />
          <Route path="/shows" element={<ShowsListPage />} />
          <Route path="/shows/new" element={<AddShowPage />} />
          <Route path="/shows/:id/edit" element={<EditShowPage />} />
          <Route path="/shows/:id" element={<ShowDetailPage />} />
          <Route path="/boards" element={user ? <BoardsPageContent /> : <Navigate to="/login" replace />} />
          <Route path="/*" element={user ? <PropsBibleHomepage>{<DashboardHome />}</PropsBibleHomepage> : <Navigate to="/login" replace />} />
        </Routes>
      </BrowserRouter>
    </ShowSelectionProvider>
  );
};

function BoardsPageContent() {
  const { service } = useFirebase();
  const [showForm, setShowForm] = useState(false);
  const [boardName, setBoardName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [boards, setBoards] = useState<BoardData[]>([]);
  const [selectedBoardId, setSelectedBoardId] = useState<string | null>(null);
  const { currentShowId } = useShowSelection();
  const [showTitle, setShowTitle] = useState<string>("");
  const { user } = useWebAuth();

  console.log("[BoardsPage] currentShowId:", currentShowId);
  console.log("[BoardsPage] Current user:", user);

  useEffect(() => {
    // Listen to boards collection, filter by showId if selected
    const unsub = service.listenToCollection<BoardData>(
      "todo_boards",
      docs => {
        console.log("[BoardsPage] Raw docs from Firestore:", docs);
        const mappedBoards = docs.map(d => ({
          ...d.data,
          id: d.id,
          title: d.data.title || d.data.name || "Untitled Board",
          listIds: d.data.listIds || [],
        }));
        console.log("[BoardsPage] currentShowId:", currentShowId);
        mappedBoards.forEach(b => console.log(`[BoardsPage] Board: ${b.title}, showId: ${b.showId}`));
        console.log("[BoardsPage] Mapped boards before filtering:", mappedBoards);
        const filteredBoards = mappedBoards.filter(b => !currentShowId || b.showId === currentShowId);
        console.log("[BoardsPage] Filtered boards:", filteredBoards);
        setBoards(filteredBoards);
      },
      err => setError(err.message || "Failed to load boards")
    );
    return () => unsub();
  }, [service, currentShowId]);

  useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  useEffect(() => {
    service.getDocuments("todo_boards").then(docs => {
      console.log("[BoardsPage] Manual fetch docs:", docs);
    }).catch(err => {
      console.error("[BoardsPage] Manual fetch error:", err);
    });
  }, [service]);

  const handleCreateBoard = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      // Create a new board in Firestore
      await service.addDocument("boards", {
        title: boardName,
        listIds: [],
        createdAt: new Date(),
      });
      setBoardName("");
      setShowForm(false);
    } catch (err: any) {
      setError(err.message || "Failed to create board");
    } finally {
      setLoading(false);
    }
  };

  // If there is exactly one board, auto open it. If more than one, open the first.
  const effectiveBoardId = selectedBoardId || boards[0]?.id || null;

  return (
    <DashboardLayout>
      {effectiveBoardId ? (
        <div className="w-full">
          {/* Header with title, dropdown if multiple boards, and create button */}
          <div className="sticky top-0 z-20 bg-pb-darker/60 backdrop-blur-sm border-b border-pb-primary/20">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Calendar className="w-6 h-6 text-pb-primary" />
                {boards.length > 1 ? (
                  <select
                    className="bg-pb-darker/50 border border-pb-primary/30 text-white rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    value={effectiveBoardId}
                    onChange={e => setSelectedBoardId(e.target.value)}
                  >
                    {boards.map(b => (
                      <option key={b.id} value={b.id}>{b.title}</option>
                    ))}
                  </select>
                ) : (
                  <h1 className="text-2xl font-bold text-white">{boards[0]?.title || 'Board'}</h1>
                )}
              </div>
              <div className="shrink-0">
                <button
                  className="bg-pb-primary text-white px-4 py-2 rounded hover:bg-pb-secondary transition"
                  onClick={() => setShowForm(v => !v)}
                >
                  New Board
                </button>
              </div>
            </div>
            {showForm && (
              <div className="max-w-7xl mx-auto px-4 pb-4">
                <form onSubmit={handleCreateBoard} className="flex items-center gap-2 max-w-md">
                  <input
                    className="flex-1 px-3 py-2 rounded border border-pb-primary/40 bg-pb-darker text-white focus:outline-none"
                    type="text"
                    placeholder="Board name"
                    value={boardName}
                    onChange={e => setBoardName(e.target.value)}
                    required
                    disabled={loading}
                  />
                  <button
                    type="submit"
                    className="bg-pb-success text-white px-4 py-2 rounded hover:bg-pb-primary transition"
                    disabled={loading || !boardName.trim()}
                  >
                    {loading ? 'Creating...' : 'Create'}
                  </button>
                  {error && <div className="text-red-400 text-xs mt-2">{error}</div>}
                </form>
              </div>
            )}
          </div>
          <Board boardId={effectiveBoardId} hideHeader />
        </div>
      ) : (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="max-w-7xl mx-auto mt-8 px-4"
        >
          <div className="text-center text-pb-gray">No boards yet. Create your first board.</div>
          <div className="flex justify-center mt-4">
            <button
              className="bg-pb-primary text-white px-4 py-2 rounded hover:bg-pb-secondary transition"
              onClick={() => setShowForm(true)}
            >
              Create Board
            </button>
          </div>
          {showForm && (
            <form onSubmit={handleCreateBoard} className="flex flex-col items-center w-full max-w-xs mt-4 mx-auto">
              <input
                className="w-full px-3 py-2 rounded border border-pb-primary/40 mb-2 bg-pb-darker text-white focus:outline-none"
                type="text"
                placeholder="Board name"
                value={boardName}
                onChange={e => setBoardName(e.target.value)}
                required
                disabled={loading}
              />
              <button
                type="submit"
                className="bg-pb-success text-white px-4 py-2 rounded hover:bg-pb-primary transition w-full"
                disabled={loading || !boardName.trim()}
              >
                {loading ? 'Creating...' : 'Create'}
              </button>
              {error && <div className="text-red-400 text-xs mt-2">{error}</div>}
            </form>
          )}
        </motion.div>
      )}
    </DashboardLayout>
  );
}

export default BoardsPageContent; 
```

```typescriptreact
import React, { useEffect, useState, useRef } from "react";
import { useFirebase } from "../../contexts/FirebaseContext";
import ListColumn from "./ListColumn";
import type { BoardData, ListData, CardData } from "../../types/taskManager";
import { DndContext, closestCenter, PointerSensor, useSensor, useSensors, DragEndEvent, DragOverlay } from '@dnd-kit/core';
import { arrayMove, SortableContext, horizontalListSortingStrategy, verticalListSortingStrategy } from '@dnd-kit/sortable';

interface BoardProps {
  boardId: string;
  hideHeader?: boolean;
}

const Board: React.FC<BoardProps> = ({ boardId, hideHeader }) => {
  const { service } = useFirebase();
  const [board, setBoard] = useState<BoardData | null>(null);
  const [lists, setLists] = useState<ListData[]>([]);
  const [cards, setCards] = useState<Record<string, CardData[]>>({}); // listId -> cards
  const listsRowRef = useRef<HTMLDivElement>(null);
  const isDragging = useRef(false);
  const startX = useRef(0);
  const scrollLeft = useRef(0);
  const [activeDragId, setActiveDragId] = useState<string | null>(null);
  const [activeDragType, setActiveDragType] = useState<'list' | 'card' | null>(null);

  const sensors = useSensors(
    useSensor(PointerSensor, { activationConstraint: { distance: 5 } })
  );

  useEffect(() => {
    // Listen to board document
    const unsubBoard = service.listenToDocument<BoardData>(
      `todo_boards/${boardId}`,
      (doc) => setBoard(doc.data)
    );
    // Listen to lists
    const unsubLists = service.listenToCollection<ListData>(
      `todo_boards/${boardId}/lists`,
      (docs) => {
        const mappedLists = docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled List", cardIds: d.data.cardIds || [] }));
        console.log(`[Board] Lists for board ${boardId}:`, mappedLists);
        setLists(mappedLists);
      },
      (err) => console.error(err)
    );
    // Listen to cards for each list
    let unsubCards: (() => void)[] = [];
    if (lists.length) {
      unsubCards.forEach(unsub => unsub());
      unsubCards = lists.map(list =>
        service.listenToCollection<CardData>(
          `todo_boards/${boardId}/lists/${list.id}/cards`,
          (docs) => setCards(prev => ({ ...prev, [list.id]: docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled Card" })) })),
          (err) => console.error(err)
        )
      );
    }
    return () => {
      unsubBoard();
      unsubLists();
      unsubCards.forEach(unsub => unsub());
    };
  }, [boardId, lists.length]);

  // Drag-to-scroll handlers
  useEffect(() => {
    const row = listsRowRef.current;
    if (!row) return;
    const onMouseDown = (e: MouseEvent) => {
      isDragging.current = true;
      startX.current = e.pageX - row.offsetLeft;
      scrollLeft.current = row.scrollLeft;
      row.classList.add('cursor-grabbing');
    };
    const onMouseLeave = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseUp = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseMove = (e: MouseEvent) => {
      if (!isDragging.current) return;
      e.preventDefault();
      const x = e.pageX - row.offsetLeft;
      const walk = (x - startX.current) * 1.5; // scroll speed
      row.scrollLeft = scrollLeft.current - walk;
    };
    row.addEventListener('mousedown', onMouseDown);
    row.addEventListener('mouseleave', onMouseLeave);
    row.addEventListener('mouseup', onMouseUp);
    row.addEventListener('mousemove', onMouseMove);
    // Touch events for mobile
    let touchStartX = 0;
    let touchScrollLeft = 0;
    const onTouchStart = (e: TouchEvent) => {
      isDragging.current = true;
      touchStartX = e.touches[0].pageX - row.offsetLeft;
      touchScrollLeft = row.scrollLeft;
    };
    const onTouchEnd = () => {
      isDragging.current = false;
    };
    const onTouchMove = (e: TouchEvent) => {
      if (!isDragging.current) return;
      const x = e.touches[0].pageX - row.offsetLeft;
      const walk = (x - touchStartX) * 1.5;
      row.scrollLeft = touchScrollLeft - walk;
    };
    row.addEventListener('touchstart', onTouchStart);
    row.addEventListener('touchend', onTouchEnd);
    row.addEventListener('touchmove', onTouchMove);
    return () => {
      row.removeEventListener('mousedown', onMouseDown);
      row.removeEventListener('mouseleave', onMouseLeave);
      row.removeEventListener('mouseup', onMouseUp);
      row.removeEventListener('mousemove', onMouseMove);
      row.removeEventListener('touchstart', onTouchStart);
      row.removeEventListener('touchend', onTouchEnd);
      row.removeEventListener('touchmove', onTouchMove);
    };
  }, [lists]);

  // Add card handler
  const addCard = async (listId: string, title: string) => {
    if (!title.trim()) return;
    const order = (cards[listId]?.length || 0);
    const newCard = {
      title: title.trim(),
      description: '',
      createdAt: new Date().toISOString(),
      order,
      // Add more fields as needed
    };
    await service.addDocument(`todo_boards/${boardId}/lists/${listId}/cards`, newCard);
    // The listener will update state
  };

  // Update card handler
  const updateCard = async (cardId: string, updates: Partial<CardData>) => {
    // Find the list containing this card
    const listId = Object.keys(cards).find(lid => cards[lid].some(card => card.id === cardId));
    if (!listId) return;
    await service.updateDocument(`todo_boards/${boardId}/lists/${listId}/cards`, cardId, updates);
  };

  const handleListDragEnd = async (event: DragEndEvent) => {
    if (!board) return;
    const { active, over } = event;
    if (!over || !active) return;
    if (!Array.isArray(board.listIds)) return;
    const activeId = String(active.id).replace(/^list-/, '');
    const overId = String(over.id).replace(/^list-/, '');
    const oldIndex = board.listIds.indexOf(activeId);
    const newIndex = board.listIds.indexOf(overId);
    if (oldIndex === -1 || newIndex === -1) return;
    if (oldIndex !== newIndex) {
      const newListIds = arrayMove(board.listIds, oldIndex, newIndex);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  // --- NEW: Card drag handler for cross-list movement ---
  const handleCardDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    if (!over || !active) return;
    const activeCardId = String(active.id).replace(/^card-/, '');
    let sourceListId: string | undefined;
    let destListId: string | undefined;
    for (const list of lists) {
      const idx = (cards[list.id] || []).findIndex(card => card.id === activeCardId);
      if (idx !== -1) {
        sourceListId = list.id;
        break;
      }
    }
    for (const list of lists) {
      if (over.data?.current?.sortable?.containerId === `list-${list.id}` || over.id === `list-${list.id}`) {
        destListId = list.id;
        break;
      }
      if ((cards[list.id] || []).some(card => `card-${card.id}` === over.id)) {
        destListId = list.id;
        break;
      }
    }
    if (!sourceListId || !destListId) return;
    if (sourceListId === destListId) {
      const cardList = cards[sourceListId] || [];
      const oldIdx = cardList.findIndex(card => card.id === activeCardId);
      const newIdx = cardList.findIndex(card => `card-${card.id}` === over.id);
      if (oldIdx === -1 || newIdx === -1 || oldIdx === newIdx) return;
      const newCards = arrayMove(cardList, oldIdx, newIdx);
      for (let i = 0; i < newCards.length; i++) {
        await service.updateDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, newCards[i].id, { order: i });
      }
      return;
    }
    const sourceCards = [...(cards[sourceListId] || [])];
    const destCards = [...(cards[destListId] || [])];
    const movingCardIdx = sourceCards.findIndex(card => card.id === activeCardId);
    if (movingCardIdx === -1) return;
    const [movingCard] = sourceCards.splice(movingCardIdx, 1);
    let insertIdx = destCards.findIndex(card => `card-${card.id}` === over.id);
    if (insertIdx === -1) insertIdx = destCards.length;
    destCards.splice(insertIdx, 0, movingCard);
    await service.deleteDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, movingCard.id);
    await service.addDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, { ...movingCard, order: insertIdx });
    for (let i = 0; i < destCards.length; i++) {
      await service.updateDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, destCards[i].id, { order: i });
    }
  };

  // Add deleteList handler
  const deleteList = async (listId: string) => {
    // Remove list document
    await service.deleteDocument(`todo_boards/${boardId}/lists`, listId);
    // Remove from board.listIds
    if (board && Array.isArray(board.listIds)) {
      const newListIds = board.listIds.filter(id => id !== listId);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  if (!board) return <div>Loading board...</div>;

  // Deduplicate lists by name (case-insensitive)
  const uniqueLists = lists.filter(
    (list, index, self) =>
      list.title &&
      self.findIndex(l => l.title?.toLowerCase() === list.title?.toLowerCase()) === index
  );

  // If listIds is missing or not an array, just show all unique lists
  if (!Array.isArray(board.listIds) || board.listIds.length === 0) {
    if (uniqueLists.length === 0) return <div>No lists found for this board.</div>;
    return (
      <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 overflow-x-hidden">
        <div className="flex-1 flex flex-col min-h-0">
          {/* Board Title as sticky header */}
          {!hideHeader && (
            <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
              <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
            </div>
          )}
          {/* Lists Row Scrollable Area */}
          <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-auto">
            <DndContext
              sensors={sensors}
              collisionDetection={closestCenter}
              onDragStart={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) setActiveDragType('list');
                else if (id.startsWith('card-')) setActiveDragType('card');
                else setActiveDragType(null);
                setActiveDragId(id);
              }}
              onDragEnd={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) handleListDragEnd(event);
                else if (id.startsWith('card-')) handleCardDragEnd(event);
                setActiveDragId(null);
                setActiveDragType(null);
              }}
              onDragCancel={() => {
                setActiveDragId(null);
                setActiveDragType(null);
              }}
            >
              <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
            <div
              ref={listsRowRef}
              className="flex items-start space-x-6 h-full cursor-grab min-w-full pr-6"
              style={{ WebkitOverflowScrolling: 'touch' }}
            >
                  {Array.isArray(board.listIds) && board.listIds.length > 0
                    ? board.listIds.map(listId => {
                        const list = lists.find(l => l.id === listId);
                        if (!list) return null;
                        return (
                          <ListColumn
                            key={list.id}
                            list={list}
                            cards={cards[list.id] || []}
                            boardId={boardId}
                            onAddCard={addCard}
                            onUpdateCard={updateCard}
                            dndId={`list-${list.id}`}
                            onDeleteList={deleteList}
                            cardIdPrefix="card-"
                          />
                        );
                      })
                    : uniqueLists.map(list => (
                <ListColumn
                  key={list.id}
                  list={list}
                  cards={cards[list.id] || []}
                  boardId={boardId}
                  onAddCard={addCard}
                  onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                />
              ))}
              {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
            </div>
              </SortableContext>
              <DragOverlay>
                {activeDragType === 'card' && activeDragId ? (() => {
                  // Find the card data
                  let card: CardData | undefined;
                  for (const list of lists) {
                    card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                    if (card) break;
                  }
                  return card ? (
                    <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                      <div className="font-semibold">{card.title}</div>
                      {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                    </div>
                  ) : null;
                })() : null}
                {activeDragType === 'list' && activeDragId ? (() => {
                  // Find the list data
                  const list = lists.find(l => `list-${l.id}` === activeDragId);
                  return list ? (
                    <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                      <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                    </div>
                  ) : null;
                })() : null}
              </DragOverlay>
            </DndContext>
          </div>
        </div>
        {/* FAB to add a list */}
        <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
          +
        </button>
      </div>
    );
  }

  return (
    <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 overflow-x-hidden">
      <div className="flex-1 flex flex-col min-h-0">
        {/* Board Title as sticky header */}
        {!hideHeader && (
          <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
            <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
          </div>
        )}
        {/* Lists Row Scrollable Area */}
        <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-auto">
          <DndContext
            sensors={sensors}
            collisionDetection={closestCenter}
            onDragStart={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) setActiveDragType('list');
              else if (id.startsWith('card-')) setActiveDragType('card');
              else setActiveDragType(null);
              setActiveDragId(id);
            }}
            onDragEnd={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) handleListDragEnd(event);
              else if (id.startsWith('card-')) handleCardDragEnd(event);
              setActiveDragId(null);
              setActiveDragType(null);
            }}
            onDragCancel={() => {
              setActiveDragId(null);
              setActiveDragType(null);
            }}
          >
            <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
          <div
            ref={listsRowRef}
            className="flex items-start space-x-6 h-full cursor-grab min-w-full pr-6"
            style={{ WebkitOverflowScrolling: 'touch' }}
          >
            {Array.isArray(board.listIds) && board.listIds.length > 0
              ? board.listIds.map(listId => {
                  const list = lists.find(l => l.id === listId);
                  if (!list) return null;
                  return (
                    <ListColumn
                      key={list.id}
                      list={list}
                      cards={cards[list.id] || []}
                      boardId={boardId}
                      onAddCard={addCard}
                      onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                    />
                  );
                })
              : uniqueLists.map(list => (
                  <ListColumn
                    key={list.id}
                    list={list}
                    cards={cards[list.id] || []}
                    boardId={boardId}
                    onAddCard={addCard}
                    onUpdateCard={updateCard}
                        dndId={`list-${list.id}`}
                        onDeleteList={deleteList}
                        cardIdPrefix="card-"
                  />
                ))}
            {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
          </div>
            </SortableContext>
            <DragOverlay>
              {activeDragType === 'card' && activeDragId ? (() => {
                // Find the card data
                let card: CardData | undefined;
                for (const list of lists) {
                  card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                  if (card) break;
                }
                return card ? (
                  <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                    <div className="font-semibold">{card.title}</div>
                    {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                  </div>
                ) : null;
              })() : null}
              {activeDragType === 'list' && activeDragId ? (() => {
                // Find the list data
                const list = lists.find(l => `list-${l.id}` === activeDragId);
                return list ? (
                  <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                    <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                  </div>
                ) : null;
              })() : null}
            </DragOverlay>
          </DndContext>
        </div>
      </div>
      {/* FAB to add a list */}
      <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
        +
      </button>
    </div>
  );
};

export default Board; 
```

- Ensured the board background and content scroll correctly:
  - Board root now has overflow-x-hidden; the scrollable lists container uses both horizontal and vertical scroll as needed.
- Kept the header sticky and brought the “New Board” button into view:
  - Sticky header z-index raised; button wrapped in a non-shrinking container to prevent it pushing off-screen.
- Prevented global horizontal overflow that caused white bands by hiding x-overflow on the board wrapper.
- Lists row remains horizontally scrollable; page can also scroll vertically.

Files changed:
- `web-app/src/components/TaskBoard/Board.tsx`
- `web-app/src/pages/BoardsPage.tsx`

If you still see horizontal white space, I can add an explicit background layer to the page root and clamp child widths to prevent overscroll glow.

---

**User**

issue has not been fixed

---

**Cursor**

```typescriptreact
import React from 'react';
import { motion } from 'framer-motion';
import { AlertCircle, BarChart3, Bell, Box, Bug, Calendar, CheckCircle, Crown, FileBarChart, FileText, Home, LogOut, Package, Package2, Plus, Scroll, Search, Settings, Star, Theater, User, Users, Wrench, Zap } from 'lucide-react';
import { useWebAuth } from './contexts/WebAuthContext';
import { Link, useNavigate } from 'react-router-dom';
import { useShowSelection } from "./contexts/ShowSelectionContext";
import type { Show } from "./types/Show";
import { useFirebase } from "./contexts/FirebaseContext";

// Animation variants
const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};

const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: {
      duration: 0.5
    }
  }
};

const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: {
      duration: 0.4
    }
  },
  hover: {
    scale: 1.02,
    transition: {
      duration: 0.2
    }
  }
};

type DashboardLayoutProps = {
  children: React.ReactNode;
};

const DashboardLayout: React.FC<DashboardLayoutProps> = ({ children }) => {
  const { userProfile, signOut } = useWebAuth();
  const [now, setNow] = React.useState(() => new Date());
  const navigate = useNavigate();
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [showTitle, setShowTitle] = React.useState<string>("");

  React.useEffect(() => {
    const interval = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(interval);
  }, []);

  React.useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  const welcome = userProfile?.displayName ? `Welcome, ${userProfile.displayName}` : 'Welcome';

  const handleSignOut = async () => {
    await signOut();
    navigate('/login');
  };

  return (
    <div className="min-h-screen bg-gradient-dark text-white">
      {/* Header */}
      <header className="flex items-center justify-between px-6 py-4 bg-pb-darker/50 backdrop-blur-sm border-b border-pb-primary/20">
        <div className="flex items-center space-x-4">
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-pb-primary rounded-lg flex items-center justify-center">
              <Theater className="w-5 h-5 text-white" />
            </div>
            <div>
              <h1 className="text-lg font-bold text-white">Props Bible</h1>
              <p className="text-xs text-pb-gray">Theater Props Management</p>
            </div>
          </div>
          <div className="bg-pb-primary/20 text-pb-primary px-3 py-1 rounded-full text-xs font-medium">
            Web Platform
          </div>
        </div>
        <div className="flex-1 flex flex-col items-center">
          <span className="text-pb-primary text-lg font-semibold">
            {showTitle || "No show selected"}
          </span>
        </div>
        <div className="flex items-center space-x-4">
          <span className="text-sm text-pb-gray">
            {userProfile?.displayName
              ? `Welcome, ${userProfile.displayName} • ${timeString}`
              : `Welcome • ${timeString}`}
          </span>
          <Settings
            className="w-5 h-5 text-pb-gray hover:text-white cursor-pointer"
            onClick={() => navigate('/profile')}
          />
          <button
            onClick={handleSignOut}
            className="ml-2 flex items-center px-2 py-1 rounded hover:bg-pb-primary/20 transition-colors text-pb-gray hover:text-white focus:outline-none"
            title="Log out"
            aria-label="Log out"
          >
            <LogOut className="w-5 h-5" />
          </button>
        </div>
      </header>

      <div className="flex">
        {/* Sidebar */}
        <motion.aside
          initial={{ x: -50, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ duration: 0.5 }}
          className="w-64 bg-pb-darker/30 backdrop-blur-sm border-r border-pb-primary/20 p-4 space-y-6 flex flex-col justify-between min-h-[80vh]"
        >
          <div>
            {/* Quick Actions */}
            <div>
              <h3 className="text-sm font-semibold text-pb-gray uppercase tracking-wider mb-3">
                Quick Actions
              </h3>
              <div className="space-y-2">
                {[
                  { icon: Home, text: 'Home', subtext: 'Dashboard overview', link: '/', gradient: 'from-pb-primary to-pb-secondary' },
                  { icon: Package, text: 'Props Inventory', subtext: 'Manage all production props', link: '/props', gradient: 'from-pb-blue to-pb-primary' },
                  { icon: Box, text: 'Packing Lists', subtext: 'packing & storage management', link: '/packing-lists', gradient: 'from-pb-green to-pb-primary' },
                  { icon: Theater, text: 'Show Management', subtext: 'Manage productions and venues', link: '/shows', gradient: 'from-pb-accent to-pb-primary' },
                  { icon: Calendar, text: 'Task Boards', subtext: 'Kanban-style to-do boards', link: '/boards', gradient: 'from-pb-orange to-pb-primary' },
                  { icon: FileText, text: 'Export Props PDF', subtext: 'Download props list as PDF', link: '/props/pdf-export' },
                  { icon: Zap, text: 'Shopping List', subtext: 'Track props and materials to buy', link: '/shopping'},
                  { icon: Bug, text: 'feedback/bugs', subtext: 'let us know any bugs or issues you are having', link: '/feedback'}
                ].map((item, index) => (
                  item.link ? (
                    <Link to={item.link} key={index} className="block">
                      <motion.div
                        variants={itemVariants}
                        initial="hidden"
                        animate="visible"
                        transition={{ delay: index * 0.1 }}
                        className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                      >
                        <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                          <item.icon className="w-4 h-4 text-white" />
                        </div>
                        <div>
                          <p className="text-sm font-medium text-white">{item.text}</p>
                          <p className="text-xs text-white/80">{item.subtext}</p>
                        </div>
                      </motion.div>
                    </Link>
                  ) : (
                    <motion.div
                      key={index}
                      variants={itemVariants}
                      initial="hidden"
                      animate="visible"
                      transition={{ delay: index * 0.1 }}
                      className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                    >
                      <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                        <item.icon className="w-4 h-4 text-white" />
                      </div>
                      <div>
                        <p className="text-sm font-medium text-white">{item.text}</p>
                        <p className="text-xs text-white/80">{item.subtext}</p>
                      </div>
                    </motion.div>
                  )
                ))}
              </div>
            </div>
          </div>
        
        </motion.aside>

        {/* Main Content */}
        <main className="flex-1 p-6 overflow-x-hidden">
          {children}
        </main>
      </div>
    </div>
  );
};

export default DashboardLayout; 
```

```typescriptreact
import React, { useEffect, useState, useRef } from "react";
import { useFirebase } from "../../contexts/FirebaseContext";
import ListColumn from "./ListColumn";
import type { BoardData, ListData, CardData } from "../../types/taskManager";
import { DndContext, closestCenter, PointerSensor, useSensor, useSensors, DragEndEvent, DragOverlay } from '@dnd-kit/core';
import { arrayMove, SortableContext, horizontalListSortingStrategy, verticalListSortingStrategy } from '@dnd-kit/sortable';

interface BoardProps {
  boardId: string;
  hideHeader?: boolean;
}

const Board: React.FC<BoardProps> = ({ boardId, hideHeader }) => {
  const { service } = useFirebase();
  const [board, setBoard] = useState<BoardData | null>(null);
  const [lists, setLists] = useState<ListData[]>([]);
  const [cards, setCards] = useState<Record<string, CardData[]>>({}); // listId -> cards
  const listsRowRef = useRef<HTMLDivElement>(null);
  const isDragging = useRef(false);
  const startX = useRef(0);
  const scrollLeft = useRef(0);
  const [activeDragId, setActiveDragId] = useState<string | null>(null);
  const [activeDragType, setActiveDragType] = useState<'list' | 'card' | null>(null);

  const sensors = useSensors(
    useSensor(PointerSensor, { activationConstraint: { distance: 5 } })
  );

  useEffect(() => {
    // Listen to board document
    const unsubBoard = service.listenToDocument<BoardData>(
      `todo_boards/${boardId}`,
      (doc) => setBoard(doc.data)
    );
    // Listen to lists
    const unsubLists = service.listenToCollection<ListData>(
      `todo_boards/${boardId}/lists`,
      (docs) => {
        const mappedLists = docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled List", cardIds: d.data.cardIds || [] }));
        console.log(`[Board] Lists for board ${boardId}:`, mappedLists);
        setLists(mappedLists);
      },
      (err) => console.error(err)
    );
    // Listen to cards for each list
    let unsubCards: (() => void)[] = [];
    if (lists.length) {
      unsubCards.forEach(unsub => unsub());
      unsubCards = lists.map(list =>
        service.listenToCollection<CardData>(
          `todo_boards/${boardId}/lists/${list.id}/cards`,
          (docs) => setCards(prev => ({ ...prev, [list.id]: docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled Card" })) })),
          (err) => console.error(err)
        )
      );
    }
    return () => {
      unsubBoard();
      unsubLists();
      unsubCards.forEach(unsub => unsub());
    };
  }, [boardId, lists.length]);

  // Drag-to-scroll handlers
  useEffect(() => {
    const row = listsRowRef.current;
    if (!row) return;
    const onMouseDown = (e: MouseEvent) => {
      isDragging.current = true;
      startX.current = e.pageX - row.offsetLeft;
      scrollLeft.current = row.scrollLeft;
      row.classList.add('cursor-grabbing');
    };
    const onMouseLeave = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseUp = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseMove = (e: MouseEvent) => {
      if (!isDragging.current) return;
      e.preventDefault();
      const x = e.pageX - row.offsetLeft;
      const walk = (x - startX.current) * 1.5; // scroll speed
      row.scrollLeft = scrollLeft.current - walk;
    };
    row.addEventListener('mousedown', onMouseDown);
    row.addEventListener('mouseleave', onMouseLeave);
    row.addEventListener('mouseup', onMouseUp);
    row.addEventListener('mousemove', onMouseMove);
    // Touch events for mobile
    let touchStartX = 0;
    let touchScrollLeft = 0;
    const onTouchStart = (e: TouchEvent) => {
      isDragging.current = true;
      touchStartX = e.touches[0].pageX - row.offsetLeft;
      touchScrollLeft = row.scrollLeft;
    };
    const onTouchEnd = () => {
      isDragging.current = false;
    };
    const onTouchMove = (e: TouchEvent) => {
      if (!isDragging.current) return;
      const x = e.touches[0].pageX - row.offsetLeft;
      const walk = (x - touchStartX) * 1.5;
      row.scrollLeft = touchScrollLeft - walk;
    };
    row.addEventListener('touchstart', onTouchStart);
    row.addEventListener('touchend', onTouchEnd);
    row.addEventListener('touchmove', onTouchMove);
    return () => {
      row.removeEventListener('mousedown', onMouseDown);
      row.removeEventListener('mouseleave', onMouseLeave);
      row.removeEventListener('mouseup', onMouseUp);
      row.removeEventListener('mousemove', onMouseMove);
      row.removeEventListener('touchstart', onTouchStart);
      row.removeEventListener('touchend', onTouchEnd);
      row.removeEventListener('touchmove', onTouchMove);
    };
  }, [lists]);

  // Add card handler
  const addCard = async (listId: string, title: string) => {
    if (!title.trim()) return;
    const order = (cards[listId]?.length || 0);
    const newCard = {
      title: title.trim(),
      description: '',
      createdAt: new Date().toISOString(),
      order,
      // Add more fields as needed
    };
    await service.addDocument(`todo_boards/${boardId}/lists/${listId}/cards`, newCard);
    // The listener will update state
  };

  // Update card handler
  const updateCard = async (cardId: string, updates: Partial<CardData>) => {
    // Find the list containing this card
    const listId = Object.keys(cards).find(lid => cards[lid].some(card => card.id === cardId));
    if (!listId) return;
    await service.updateDocument(`todo_boards/${boardId}/lists/${listId}/cards`, cardId, updates);
  };

  const handleListDragEnd = async (event: DragEndEvent) => {
    if (!board) return;
    const { active, over } = event;
    if (!over || !active) return;
    if (!Array.isArray(board.listIds)) return;
    const activeId = String(active.id).replace(/^list-/, '');
    const overId = String(over.id).replace(/^list-/, '');
    const oldIndex = board.listIds.indexOf(activeId);
    const newIndex = board.listIds.indexOf(overId);
    if (oldIndex === -1 || newIndex === -1) return;
    if (oldIndex !== newIndex) {
      const newListIds = arrayMove(board.listIds, oldIndex, newIndex);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  // --- NEW: Card drag handler for cross-list movement ---
  const handleCardDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    if (!over || !active) return;
    const activeCardId = String(active.id).replace(/^card-/, '');
    let sourceListId: string | undefined;
    let destListId: string | undefined;
    for (const list of lists) {
      const idx = (cards[list.id] || []).findIndex(card => card.id === activeCardId);
      if (idx !== -1) {
        sourceListId = list.id;
        break;
      }
    }
    for (const list of lists) {
      if (over.data?.current?.sortable?.containerId === `list-${list.id}` || over.id === `list-${list.id}`) {
        destListId = list.id;
        break;
      }
      if ((cards[list.id] || []).some(card => `card-${card.id}` === over.id)) {
        destListId = list.id;
        break;
      }
    }
    if (!sourceListId || !destListId) return;
    if (sourceListId === destListId) {
      const cardList = cards[sourceListId] || [];
      const oldIdx = cardList.findIndex(card => card.id === activeCardId);
      const newIdx = cardList.findIndex(card => `card-${card.id}` === over.id);
      if (oldIdx === -1 || newIdx === -1 || oldIdx === newIdx) return;
      const newCards = arrayMove(cardList, oldIdx, newIdx);
      for (let i = 0; i < newCards.length; i++) {
        await service.updateDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, newCards[i].id, { order: i });
      }
      return;
    }
    const sourceCards = [...(cards[sourceListId] || [])];
    const destCards = [...(cards[destListId] || [])];
    const movingCardIdx = sourceCards.findIndex(card => card.id === activeCardId);
    if (movingCardIdx === -1) return;
    const [movingCard] = sourceCards.splice(movingCardIdx, 1);
    let insertIdx = destCards.findIndex(card => `card-${card.id}` === over.id);
    if (insertIdx === -1) insertIdx = destCards.length;
    destCards.splice(insertIdx, 0, movingCard);
    await service.deleteDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, movingCard.id);
    await service.addDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, { ...movingCard, order: insertIdx });
    for (let i = 0; i < destCards.length; i++) {
      await service.updateDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, destCards[i].id, { order: i });
    }
  };

  // Add deleteList handler
  const deleteList = async (listId: string) => {
    // Remove list document
    await service.deleteDocument(`todo_boards/${boardId}/lists`, listId);
    // Remove from board.listIds
    if (board && Array.isArray(board.listIds)) {
      const newListIds = board.listIds.filter(id => id !== listId);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  if (!board) return <div>Loading board...</div>;

  // Deduplicate lists by name (case-insensitive)
  const uniqueLists = lists.filter(
    (list, index, self) =>
      list.title &&
      self.findIndex(l => l.title?.toLowerCase() === list.title?.toLowerCase()) === index
  );

  // If listIds is missing or not an array, just show all unique lists
  if (!Array.isArray(board.listIds) || board.listIds.length === 0) {
    if (uniqueLists.length === 0) return <div>No lists found for this board.</div>;
    return (
      <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 overflow-x-hidden">
        <div className="flex-1 flex flex-col min-h-0">
          {/* Board Title as sticky header */}
          {!hideHeader && (
            <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
              <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
            </div>
          )}
          {/* Lists Row Scrollable Area */}
          <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-auto">
            <DndContext
              sensors={sensors}
              collisionDetection={closestCenter}
              onDragStart={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) setActiveDragType('list');
                else if (id.startsWith('card-')) setActiveDragType('card');
                else setActiveDragType(null);
                setActiveDragId(id);
              }}
              onDragEnd={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) handleListDragEnd(event);
                else if (id.startsWith('card-')) handleCardDragEnd(event);
                setActiveDragId(null);
                setActiveDragType(null);
              }}
              onDragCancel={() => {
                setActiveDragId(null);
                setActiveDragType(null);
              }}
            >
              <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
            <div
              ref={listsRowRef}
              className="flex items-start gap-6 h-full cursor-grab w-max pr-10"
              style={{ WebkitOverflowScrolling: 'touch' }}
            >
                  {Array.isArray(board.listIds) && board.listIds.length > 0
                    ? board.listIds.map(listId => {
                        const list = lists.find(l => l.id === listId);
                        if (!list) return null;
                        return (
                          <ListColumn
                            key={list.id}
                            list={list}
                            cards={cards[list.id] || []}
                            boardId={boardId}
                            onAddCard={addCard}
                            onUpdateCard={updateCard}
                            dndId={`list-${list.id}`}
                            onDeleteList={deleteList}
                            cardIdPrefix="card-"
                          />
                        );
                      })
                    : uniqueLists.map(list => (
                <ListColumn
                  key={list.id}
                  list={list}
                  cards={cards[list.id] || []}
                  boardId={boardId}
                  onAddCard={addCard}
                  onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                />
              ))}
              {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
            </div>
              </SortableContext>
              <DragOverlay>
                {activeDragType === 'card' && activeDragId ? (() => {
                  // Find the card data
                  let card: CardData | undefined;
                  for (const list of lists) {
                    card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                    if (card) break;
                  }
                  return card ? (
                    <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                      <div className="font-semibold">{card.title}</div>
                      {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                    </div>
                  ) : null;
                })() : null}
                {activeDragType === 'list' && activeDragId ? (() => {
                  // Find the list data
                  const list = lists.find(l => `list-${l.id}` === activeDragId);
                  return list ? (
                    <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                      <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                    </div>
                  ) : null;
                })() : null}
              </DragOverlay>
            </DndContext>
          </div>
        </div>
        {/* FAB to add a list */}
        <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
          +
        </button>
      </div>
    );
  }

  return (
    <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 overflow-x-hidden">
      <div className="flex-1 flex flex-col min-h-0">
        {/* Board Title as sticky header */}
        {!hideHeader && (
          <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
            <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
          </div>
        )}
        {/* Lists Row Scrollable Area */}
        <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-auto">
          <DndContext
            sensors={sensors}
            collisionDetection={closestCenter}
            onDragStart={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) setActiveDragType('list');
              else if (id.startsWith('card-')) setActiveDragType('card');
              else setActiveDragType(null);
              setActiveDragId(id);
            }}
            onDragEnd={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) handleListDragEnd(event);
              else if (id.startsWith('card-')) handleCardDragEnd(event);
              setActiveDragId(null);
              setActiveDragType(null);
            }}
            onDragCancel={() => {
              setActiveDragId(null);
              setActiveDragType(null);
            }}
          >
            <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
          <div
            ref={listsRowRef}
            className="flex items-start gap-6 h-full cursor-grab w-max pr-10"
            style={{ WebkitOverflowScrolling: 'touch' }}
          >
            {Array.isArray(board.listIds) && board.listIds.length > 0
              ? board.listIds.map(listId => {
                  const list = lists.find(l => l.id === listId);
                  if (!list) return null;
                  return (
                    <ListColumn
                      key={list.id}
                      list={list}
                      cards={cards[list.id] || []}
                      boardId={boardId}
                      onAddCard={addCard}
                      onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                    />
                  );
                })
              : uniqueLists.map(list => (
                  <ListColumn
                    key={list.id}
                    list={list}
                    cards={cards[list.id] || []}
                    boardId={boardId}
                    onAddCard={addCard}
                    onUpdateCard={updateCard}
                        dndId={`list-${list.id}`}
                        onDeleteList={deleteList}
                        cardIdPrefix="card-"
                  />
                ))}
            {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
          </div>
            </SortableContext>
            <DragOverlay>
              {activeDragType === 'card' && activeDragId ? (() => {
                // Find the card data
                let card: CardData | undefined;
                for (const list of lists) {
                  card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                  if (card) break;
                }
                return card ? (
                  <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                    <div className="font-semibold">{card.title}</div>
                    {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                  </div>
                ) : null;
              })() : null}
              {activeDragType === 'list' && activeDragId ? (() => {
                // Find the list data
                const list = lists.find(l => `list-${l.id}` === activeDragId);
                return list ? (
                  <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                    <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                  </div>
                ) : null;
              })() : null}
            </DragOverlay>
          </DndContext>
        </div>
      </div>
      {/* FAB to add a list */}
      <button className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50">
        +
      </button>
    </div>
  );
};

export default Board; 
```

Thanks for the screenshot. I made these changes to address the remaining issues:

- Prevent horizontal overflow
  - Board wrapper and main layout now hide global x-overflow so the white strip can’t appear.
  - Lists scroller uses w-max instead of min-w-full, so its width equals the total width of columns and scrolls cleanly.

- Ensure background and content scroll correctly
  - Lists container allows both horizontal and vertical scrolling so the gradient background moves with content.
  - Kept the header sticky and made the “New Board” button non-shrinking so it stays visible.

- Collapsed column rail spacing is improved and supports longer rotated titles.

If the page still overflows horizontally, I’ll add a root-level wrapper to clamp widths.

---

**User**

ok lets address the layout issues withthe collapsed list text is not inthe middle of the container 

---

**Cursor**

```typescriptreact
import React, { useState } from "react";
import Card from "./Card";
import type { ListData, CardData } from "../../types/taskManager";
import { Edit, ChevronDown, ChevronUp, Trash2 } from 'lucide-react';
import { useSortable, SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface ListColumnProps {
  list: ListData;
  cards: CardData[];
  boardId: string;
  onAddCard: (listId: string, title: string) => void;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
  onDeleteList: (listId: string) => void;
  cardIdPrefix?: string;
}

const ListColumn: React.FC<ListColumnProps> = ({ list, cards, boardId, onAddCard, onUpdateCard, dndId, onDeleteList, cardIdPrefix = '' }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [addingCard, setAddingCard] = useState(false);
  const [newCardTitle, setNewCardTitle] = useState("");

  // dnd-kit sortable for lists
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };

  const handleAddCard = () => {
    if (!newCardTitle.trim()) return;
    onAddCard(list.id, newCardTitle);
    setNewCardTitle("");
    setAddingCard(false);
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      className={`bg-pb-darker rounded-xl shadow-lg border border-pb-primary/30 flex flex-col flex-shrink-0 transition-all duration-300 ${collapsed ? '!w-14 min-w-[3.5rem] p-0 bg-pb-primary/20 relative' : 'p-4 min-w-[18rem] w-[20rem]'}`}
    >
      <div className={`flex items-center justify-between mb-4 w-full ${collapsed ? 'flex-col gap-0 mb-0 items-center justify-center' : ''}`} style={collapsed ? { height: '100%' } : {}}>
        {collapsed ? (
          <>
            <div className="relative h-full w-full">
              <div className="absolute inset-0 flex items-center justify-center">
                <span className="text-sm font-bold text-pb-primary/80 select-none transform -rotate-90 whitespace-nowrap tracking-widest text-center">
                  {list.title}
                </span>
              </div>
              <button
                onClick={() => setCollapsed(false)}
                className="absolute bottom-2 left-1/2 -translate-x-1/2 text-pb-primary hover:text-pb-success p-1 rounded"
                aria-label="Expand list"
                title="Expand"
              >
                <ChevronDown size={18} />
              </button>
            </div>
          </>
        ) : (
          <>
            <div className="text-lg font-bold text-white tracking-wide text-left">
              {list.title}
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setCollapsed(true)} className="text-pb-primary hover:text-pb-success p-1 rounded">
                <ChevronUp size={20} />
              </button>
              <button className="text-pb-primary hover:text-pb-success p-1 rounded"><Edit size={20} /></button>
              <button className="text-pb-accent hover:text-red-500 p-1 rounded" onClick={() => onDeleteList(list.id)}><Trash2 size={20} /></button>
            </div>
          </>
        )}
      </div>
      {!collapsed && (
        <>
          <SortableContext items={Array.isArray(cards) ? cards.map(card => `${cardIdPrefix}${card.id}`) : []} strategy={verticalListSortingStrategy}>
            <div className="flex-1 flex flex-col gap-3 mb-4">
              {cards.map(card => (
                <Card key={card.id} card={card} onUpdateCard={onUpdateCard} dndId={`${cardIdPrefix}${card.id}`} />
              ))}
            </div>
          </SortableContext>
          {addingCard ? (
            <div className="flex flex-col gap-2 mt-2">
              <input
                className="rounded border border-pb-primary/40 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-pb-primary text-[#222]"
                type="text"
                value={newCardTitle}
                onChange={e => setNewCardTitle(e.target.value)}
                placeholder="Enter a title for this card..."
                autoFocus
                onKeyDown={e => {
                  if (e.key === 'Enter') handleAddCard();
                  if (e.key === 'Escape') { setAddingCard(false); setNewCardTitle(""); }
                }}
              />
              <div className="flex gap-2">
                <button
                  className="bg-pb-success hover:bg-pb-primary text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={handleAddCard}
                >
                  Add
                </button>
                <button
                  className="bg-pb-darker hover:bg-pb-primary/40 text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={() => { setAddingCard(false); setNewCardTitle(""); }}
                >
                  Cancel
                </button>
              </div>
            </div>
          ) : (
            <button className="mt-auto bg-pb-primary/90 hover:bg-pb-success text-white font-semibold py-2 px-3 rounded transition shadow focus:outline-none"
              onClick={() => setAddingCard(true)}
            >
              + Add Card
            </button>
          )}
        </>
      )}
    </div>
  );
};

export default ListColumn; 
```

- Centered collapsed list titles precisely:
  - Collapsed rail now uses a relative container with an absolutely centered inner wrapper so the rotated title is vertically and horizontally centered.
  - Expand chevron is anchored to the bottom center of the rail, independent of the title.
- Rail classes cleaned up to avoid flex alignment side-effects in collapsed mode.

This should keep the rotated title perfectly centered within the collapsed list container regardless of height.

---

**User**

the problem is worsened

---

**Cursor**

```typescriptreact
import React, { useState } from "react";
import Card from "./Card";
import type { ListData, CardData } from "../../types/taskManager";
import { Edit, ChevronDown, ChevronUp, Trash2 } from 'lucide-react';
import { useSortable, SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface ListColumnProps {
  list: ListData;
  cards: CardData[];
  boardId: string;
  onAddCard: (listId: string, title: string) => void;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
  onDeleteList: (listId: string) => void;
  cardIdPrefix?: string;
}

const ListColumn: React.FC<ListColumnProps> = ({ list, cards, boardId, onAddCard, onUpdateCard, dndId, onDeleteList, cardIdPrefix = '' }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [addingCard, setAddingCard] = useState(false);
  const [newCardTitle, setNewCardTitle] = useState("");

  // dnd-kit sortable for lists
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };

  const handleAddCard = () => {
    if (!newCardTitle.trim()) return;
    onAddCard(list.id, newCardTitle);
    setNewCardTitle("");
    setAddingCard(false);
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      className={`bg-pb-darker rounded-xl shadow-lg border border-pb-primary/30 flex flex-col flex-shrink-0 transition-all duration-300 ${collapsed ? '!w-14 min-w-[3.5rem] min-h-[22rem] p-0 bg-pb-primary/20 relative items-center justify-center' : 'p-4 min-w-[18rem] w-[20rem]'}`}
    >
      <div className={`flex items-center justify-between mb-4 w-full ${collapsed ? 'flex-col gap-0 mb-0 items-center justify-center' : ''}`} style={collapsed ? { height: '100%' } : {}}>
        {collapsed ? (
          <>
            <div className="relative h-full w-full flex items-center justify-center">
              <span className="text-sm font-bold text-pb-primary/80 select-none transform -rotate-90 whitespace-nowrap tracking-widest text-center">
                {list.title}
              </span>
              <button
                onClick={() => setCollapsed(false)}
                className="absolute bottom-2 left-1/2 -translate-x-1/2 text-pb-primary hover:text-pb-success p-1 rounded"
                aria-label="Expand list"
                title="Expand"
              >
                <ChevronDown size={18} />
              </button>
            </div>
          </>
        ) : (
          <>
            <div className="text-lg font-bold text-white tracking-wide text-left">
              {list.title}
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setCollapsed(true)} className="text-pb-primary hover:text-pb-success p-1 rounded">
                <ChevronUp size={20} />
              </button>
              <button className="text-pb-primary hover:text-pb-success p-1 rounded"><Edit size={20} /></button>
              <button className="text-pb-accent hover:text-red-500 p-1 rounded" onClick={() => onDeleteList(list.id)}><Trash2 size={20} /></button>
            </div>
          </>
        )}
      </div>
      {!collapsed && (
        <>
          <SortableContext items={Array.isArray(cards) ? cards.map(card => `${cardIdPrefix}${card.id}`) : []} strategy={verticalListSortingStrategy}>
            <div className="flex-1 flex flex-col gap-3 mb-4">
              {cards.map(card => (
                <Card key={card.id} card={card} onUpdateCard={onUpdateCard} dndId={`${cardIdPrefix}${card.id}`} />
              ))}
            </div>
          </SortableContext>
          {addingCard ? (
            <div className="flex flex-col gap-2 mt-2">
              <input
                className="rounded border border-pb-primary/40 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-pb-primary text-[#222]"
                type="text"
                value={newCardTitle}
                onChange={e => setNewCardTitle(e.target.value)}
                placeholder="Enter a title for this card..."
                autoFocus
                onKeyDown={e => {
                  if (e.key === 'Enter') handleAddCard();
                  if (e.key === 'Escape') { setAddingCard(false); setNewCardTitle(""); }
                }}
              />
              <div className="flex gap-2">
                <button
                  className="bg-pb-success hover:bg-pb-primary text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={handleAddCard}
                >
                  Add
                </button>
                <button
                  className="bg-pb-darker hover:bg-pb-primary/40 text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={() => { setAddingCard(false); setNewCardTitle(""); }}
                >
                  Cancel
                </button>
              </div>
            </div>
          ) : (
            <button className="mt-auto bg-pb-primary/90 hover:bg-pb-success text-white font-semibold py-2 px-3 rounded transition shadow focus:outline-none"
              onClick={() => setAddingCard(true)}
            >
              + Add Card
            </button>
          )}
        </>
      )}
    </div>
  );
};

export default ListColumn; 
```

```typescriptreact
import React, { useState } from "react";
import Card from "./Card";
import type { ListData, CardData } from "../../types/taskManager";
import { Edit, ChevronDown, ChevronUp, Trash2 } from 'lucide-react';
import { useSortable, SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface ListColumnProps {
  list: ListData;
  cards: CardData[];
  boardId: string;
  onAddCard: (listId: string, title: string) => void;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
  onDeleteList: (listId: string) => void;
  cardIdPrefix?: string;
}

const ListColumn: React.FC<ListColumnProps> = ({ list, cards, boardId, onAddCard, onUpdateCard, dndId, onDeleteList, cardIdPrefix = '' }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [addingCard, setAddingCard] = useState(false);
  const [newCardTitle, setNewCardTitle] = useState("");

  // dnd-kit sortable for lists
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };

  const handleAddCard = () => {
    if (!newCardTitle.trim()) return;
    onAddCard(list.id, newCardTitle);
    setNewCardTitle("");
    setAddingCard(false);
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      className={`bg-pb-darker rounded-xl shadow-lg border border-pb-primary/30 flex flex-col flex-shrink-0 transition-all duration-300 ${collapsed ? '!w-14 min-w-[3.5rem] min-h-[22rem] p-0 bg-pb-primary/20 relative items-center justify-center' : 'p-4 min-w-[18rem] w-[20rem]'}`}
    >
      <div className={`flex items-center justify-between mb-4 w-full ${collapsed ? 'mb-0' : ''}`} style={collapsed ? { height: 'auto' } : {}}>
        {collapsed ? (
          <>
            <div className="relative h-full w-full flex items-center justify-center">
              <span className="text-sm font-bold text-pb-primary/80 select-none transform -rotate-90 whitespace-nowrap tracking-widest text-center">
                {list.title}
              </span>
              <button
                onClick={() => setCollapsed(false)}
                className="absolute bottom-2 left-1/2 -translate-x-1/2 text-pb-primary hover:text-pb-success p-1 rounded"
                aria-label="Expand list"
                title="Expand"
              >
                <ChevronDown size={18} />
              </button>
            </div>
          </>
        ) : (
          <>
            <div className="text-lg font-bold text-white tracking-wide text-left">
              {list.title}
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setCollapsed(true)} className="text-pb-primary hover:text-pb-success p-1 rounded">
                <ChevronUp size={20} />
              </button>
              <button className="text-pb-primary hover:text-pb-success p-1 rounded"><Edit size={20} /></button>
              <button className="text-pb-accent hover:text-red-500 p-1 rounded" onClick={() => onDeleteList(list.id)}><Trash2 size={20} /></button>
            </div>
          </>
        )}
      </div>
      {!collapsed && (
        <>
          <SortableContext items={Array.isArray(cards) ? cards.map(card => `${cardIdPrefix}${card.id}`) : []} strategy={verticalListSortingStrategy}>
            <div className="flex-1 flex flex-col gap-3 mb-4">
              {cards.map(card => (
                <Card key={card.id} card={card} onUpdateCard={onUpdateCard} dndId={`${cardIdPrefix}${card.id}`} />
              ))}
            </div>
          </SortableContext>
          {addingCard ? (
            <div className="flex flex-col gap-2 mt-2">
              <input
                className="rounded border border-pb-primary/40 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-pb-primary text-[#222]"
                type="text"
                value={newCardTitle}
                onChange={e => setNewCardTitle(e.target.value)}
                placeholder="Enter a title for this card..."
                autoFocus
                onKeyDown={e => {
                  if (e.key === 'Enter') handleAddCard();
                  if (e.key === 'Escape') { setAddingCard(false); setNewCardTitle(""); }
                }}
              />
              <div className="flex gap-2">
                <button
                  className="bg-pb-success hover:bg-pb-primary text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={handleAddCard}
                >
                  Add
                </button>
                <button
                  className="bg-pb-darker hover:bg-pb-primary/40 text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={() => { setAddingCard(false); setNewCardTitle(""); }}
                >
                  Cancel
                </button>
              </div>
            </div>
          ) : (
            <button className="mt-auto bg-pb-primary/90 hover:bg-pb-success text-white font-semibold py-2 px-3 rounded transition shadow focus:outline-none"
              onClick={() => setAddingCard(true)}
            >
              + Add Card
            </button>
          )}
        </>
      )}
    </div>
  );
};

export default ListColumn; 
```

I centered the collapsed list title more robustly and prevented header spacing from pushing it off-center:

- Collapsed rail now enforces a minimum height and centers content with a single flex container.
- The title sits centered via flex; the expand chevron is pinned to bottom-center independently.
- Removed conflicting header spacing classes in collapsed mode.

If the rail still looks offset, tell me your exact column height target and I’ll match it, or I can compute height from the non-collapsed header size for perfect alignment.

---

**User**

lets add a x to the create board form to clos it if its done in error.

---

**Cursor**

```typescriptreact
import React, { useState, useEffect } from "react";
import DashboardLayout from "../PropsBibleHomepage";
import { motion } from "framer-motion";
import { Calendar } from "lucide-react";
import { useFirebase } from "../contexts/FirebaseContext";
import type { BoardData } from "../types/taskManager";
import Board from "../components/TaskBoard/Board";
import { useShowSelection } from "../contexts/ShowSelectionContext";
import type { Show } from "../types/Show";
import { useWebAuth } from '../contexts/WebAuthContext';
import { BrowserRouter, Routes, Route, Navigate } from "react-router-dom";
import { ShowSelectionProvider } from "../contexts/ShowSelectionContext";
import Login from "../pages/Login";
import Signup from "../pages/Signup";
import ForgotPassword from "../pages/ForgotPassword";
import EditPropPage from "../pages/EditPropPage";
import PropDetailPage from "../pages/PropDetailPage";
import PropsListPage from '../PropsListPage';
import DashboardHome from '../DashboardHome';
import ShowsListPage from '../ShowsListPage';
import AddShowPage from "../pages/AddShowPage";
import EditShowPage from "../pages/EditShowPage";
import ShowDetailPage from "../pages/ShowDetailPage";
import PropsBibleHomepage from '../PropsBibleHomepage';

const BoardsPage: React.FC = () => {
  const { service } = useFirebase();
  const [showForm, setShowForm] = useState(false);
  const [boardName, setBoardName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [boards, setBoards] = useState<BoardData[]>([]);
  const [selectedBoardId, setSelectedBoardId] = useState<string | null>(null);
  const { currentShowId } = useShowSelection();
  const [showTitle, setShowTitle] = useState<string>("");
  const { user } = useWebAuth();

  console.log("[BoardsPage] currentShowId:", currentShowId);
  console.log("[BoardsPage] Current user:", user);

  useEffect(() => {
    // Listen to boards collection, filter by showId if selected
    const unsub = service.listenToCollection<BoardData>(
      "todo_boards",
      docs => {
        console.log("[BoardsPage] Raw docs from Firestore:", docs);
        const mappedBoards = docs.map(d => ({
          ...d.data,
          id: d.id,
          title: d.data.title || d.data.name || "Untitled Board",
          listIds: d.data.listIds || [],
        }));
        console.log("[BoardsPage] currentShowId:", currentShowId);
        mappedBoards.forEach(b => console.log(`[BoardsPage] Board: ${b.title}, showId: ${b.showId}`));
        console.log("[BoardsPage] Mapped boards before filtering:", mappedBoards);
        const filteredBoards = mappedBoards.filter(b => !currentShowId || b.showId === currentShowId);
        console.log("[BoardsPage] Filtered boards:", filteredBoards);
        setBoards(filteredBoards);
      },
      err => setError(err.message || "Failed to load boards")
    );
    return () => unsub();
  }, [service, currentShowId]);

  useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  useEffect(() => {
    service.getDocuments("todo_boards").then(docs => {
      console.log("[BoardsPage] Manual fetch docs:", docs);
    }).catch(err => {
      console.error("[BoardsPage] Manual fetch error:", err);
    });
  }, [service]);

  const handleCreateBoard = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      // Create a new board in Firestore
      await service.addDocument("boards", {
        title: boardName,
        listIds: [],
        createdAt: new Date(),
      });
      setBoardName("");
      setShowForm(false);
    } catch (err: any) {
      setError(err.message || "Failed to create board");
    } finally {
      setLoading(false);
    }
  };

  return (
    <ShowSelectionProvider>
      <BrowserRouter>
        <Routes>
          <Route path="/login" element={!user ? <Login /> : <Navigate to="/" replace />} />
          <Route path="/signup" element={!user ? <Signup /> : <Navigate to="/" replace />} />
          <Route path="/forgot-password" element={!user ? <ForgotPassword /> : <Navigate to="/" replace />} />
          <Route path="/props/:id/edit" element={user ? <EditPropPage /> : <Navigate to="/login" replace />} />
          <Route path="/props/:id" element={user ? <PropDetailPage /> : <Navigate to="/login" replace />} />
          <Route path="/props" element={user ? <PropsListPage /> : <Navigate to="/login" replace />} />
          <Route path="/" element={user ? <DashboardHome /> : <Navigate to="/login" replace />} />
          <Route path="/shows" element={<ShowsListPage />} />
          <Route path="/shows/new" element={<AddShowPage />} />
          <Route path="/shows/:id/edit" element={<EditShowPage />} />
          <Route path="/shows/:id" element={<ShowDetailPage />} />
          <Route path="/boards" element={user ? <BoardsPageContent /> : <Navigate to="/login" replace />} />
          <Route path="/*" element={user ? <PropsBibleHomepage>{<DashboardHome />}</PropsBibleHomepage> : <Navigate to="/login" replace />} />
        </Routes>
      </BrowserRouter>
    </ShowSelectionProvider>
  );
};

function BoardsPageContent() {
  const { service } = useFirebase();
  const [showForm, setShowForm] = useState(false);
  const [boardName, setBoardName] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [boards, setBoards] = useState<BoardData[]>([]);
  const [selectedBoardId, setSelectedBoardId] = useState<string | null>(null);
  const { currentShowId } = useShowSelection();
  const [showTitle, setShowTitle] = useState<string>("");
  const { user } = useWebAuth();

  console.log("[BoardsPage] currentShowId:", currentShowId);
  console.log("[BoardsPage] Current user:", user);

  useEffect(() => {
    // Listen to boards collection, filter by showId if selected
    const unsub = service.listenToCollection<BoardData>(
      "todo_boards",
      docs => {
        console.log("[BoardsPage] Raw docs from Firestore:", docs);
        const mappedBoards = docs.map(d => ({
          ...d.data,
          id: d.id,
          title: d.data.title || d.data.name || "Untitled Board",
          listIds: d.data.listIds || [],
        }));
        console.log("[BoardsPage] currentShowId:", currentShowId);
        mappedBoards.forEach(b => console.log(`[BoardsPage] Board: ${b.title}, showId: ${b.showId}`));
        console.log("[BoardsPage] Mapped boards before filtering:", mappedBoards);
        const filteredBoards = mappedBoards.filter(b => !currentShowId || b.showId === currentShowId);
        console.log("[BoardsPage] Filtered boards:", filteredBoards);
        setBoards(filteredBoards);
      },
      err => setError(err.message || "Failed to load boards")
    );
    return () => unsub();
  }, [service, currentShowId]);

  useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  useEffect(() => {
    service.getDocuments("todo_boards").then(docs => {
      console.log("[BoardsPage] Manual fetch docs:", docs);
    }).catch(err => {
      console.error("[BoardsPage] Manual fetch error:", err);
    });
  }, [service]);

  const handleCreateBoard = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    try {
      // Create a new board in Firestore
      await service.addDocument("boards", {
        title: boardName,
        listIds: [],
        createdAt: new Date(),
      });
      setBoardName("");
      setShowForm(false);
    } catch (err: any) {
      setError(err.message || "Failed to create board");
    } finally {
      setLoading(false);
    }
  };

  // If there is exactly one board, auto open it. If more than one, open the first.
  const effectiveBoardId = selectedBoardId || boards[0]?.id || null;

  return (
    <DashboardLayout>
      {effectiveBoardId ? (
        <div className="w-full">
          {/* Header with title, dropdown if multiple boards, and create button */}
          <div className="sticky top-0 z-20 bg-pb-darker/60 backdrop-blur-sm border-b border-pb-primary/20">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Calendar className="w-6 h-6 text-pb-primary" />
                {boards.length > 1 ? (
                  <select
                    className="bg-pb-darker/50 border border-pb-primary/30 text-white rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pb-primary"
                    value={effectiveBoardId}
                    onChange={e => setSelectedBoardId(e.target.value)}
                  >
                    {boards.map(b => (
                      <option key={b.id} value={b.id}>{b.title}</option>
                    ))}
                  </select>
                ) : (
                  <h1 className="text-2xl font-bold text-white">{boards[0]?.title || 'Board'}</h1>
                )}
              </div>
              <div className="shrink-0">
                <button
                  className="bg-pb-primary text-white px-4 py-2 rounded hover:bg-pb-secondary transition"
                  onClick={() => setShowForm(v => !v)}
                >
                  New Board
                </button>
              </div>
            </div>
            {showForm && (
              <div className="max-w-7xl mx-auto px-4 pb-4 relative">
                <button
                  type="button"
                  aria-label="Close create board form"
                  title="Close"
                  className="absolute -top-2 right-4 text-pb-gray hover:text-white bg-pb-darker/60 border border-pb-primary/30 rounded-full w-7 h-7 flex items-center justify-center"
                  onClick={() => setShowForm(false)}
                >
                  ×
                </button>
                <form onSubmit={handleCreateBoard} className="flex items-center gap-2 max-w-md">
                  <input
                    className="flex-1 px-3 py-2 rounded border border-pb-primary/40 bg-pb-darker text-white focus:outline-none"
                    type="text"
                    placeholder="Board name"
                    value={boardName}
                    onChange={e => setBoardName(e.target.value)}
                    required
                    disabled={loading}
                  />
                  <button
                    type="submit"
                    className="bg-pb-success text-white px-4 py-2 rounded hover:bg-pb-primary transition"
                    disabled={loading || !boardName.trim()}
                  >
                    {loading ? 'Creating...' : 'Create'}
                  </button>
                  {error && <div className="text-red-400 text-xs mt-2">{error}</div>}
                </form>
              </div>
            )}
          </div>
          <Board boardId={effectiveBoardId} hideHeader />
        </div>
      ) : (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.5 }}
          className="max-w-7xl mx-auto mt-8 px-4"
        >
          <div className="text-center text-pb-gray">No boards yet. Create your first board.</div>
          <div className="flex justify-center mt-4">
            <button
              className="bg-pb-primary text-white px-4 py-2 rounded hover:bg-pb-secondary transition"
              onClick={() => setShowForm(true)}
            >
              Create Board
            </button>
          </div>
          {showForm && (
            <form onSubmit={handleCreateBoard} className="flex flex-col items-center w-full max-w-xs mt-4 mx-auto">
              <input
                className="w-full px-3 py-2 rounded border border-pb-primary/40 mb-2 bg-pb-darker text-white focus:outline-none"
                type="text"
                placeholder="Board name"
                value={boardName}
                onChange={e => setBoardName(e.target.value)}
                required
                disabled={loading}
              />
              <button
                type="submit"
                className="bg-pb-success text-white px-4 py-2 rounded hover:bg-pb-primary transition w-full"
                disabled={loading || !boardName.trim()}
              >
                {loading ? 'Creating...' : 'Create'}
              </button>
              {error && <div className="text-red-400 text-xs mt-2">{error}</div>}
            </form>
          )}
        </motion.div>
      )}
    </DashboardLayout>
  );
}

export default BoardsPageContent; 
```

- Added a close button to the inline “Create Board” form in the boards header:
  - Small rounded “×” at the top-right of the form; clicking it hides the form.
  - File updated: `web-app/src/pages/BoardsPage.tsx`

Want me to also close the form on Escape key and clear the field? I can add that quickly.

---

**User**

the fab on page dosnt add a new list?

---

**Cursor**

```typescriptreact
import React, { useEffect, useState, useRef } from "react";
import { useFirebase } from "../../contexts/FirebaseContext";
import ListColumn from "./ListColumn";
import type { BoardData, ListData, CardData } from "../../types/taskManager";
import { DndContext, closestCenter, PointerSensor, useSensor, useSensors, DragEndEvent, DragOverlay } from '@dnd-kit/core';
import { arrayMove, SortableContext, horizontalListSortingStrategy, verticalListSortingStrategy } from '@dnd-kit/sortable';

interface BoardProps {
  boardId: string;
  hideHeader?: boolean;
}

const Board: React.FC<BoardProps> = ({ boardId, hideHeader }) => {
  const { service } = useFirebase();
  const [board, setBoard] = useState<BoardData | null>(null);
  const [lists, setLists] = useState<ListData[]>([]);
  const [cards, setCards] = useState<Record<string, CardData[]>>({}); // listId -> cards
  const listsRowRef = useRef<HTMLDivElement>(null);
  const isDragging = useRef(false);
  const startX = useRef(0);
  const scrollLeft = useRef(0);
  const [activeDragId, setActiveDragId] = useState<string | null>(null);
  const [activeDragType, setActiveDragType] = useState<'list' | 'card' | null>(null);

  const sensors = useSensors(
    useSensor(PointerSensor, { activationConstraint: { distance: 5 } })
  );

  useEffect(() => {
    // Listen to board document
    const unsubBoard = service.listenToDocument<BoardData>(
      `todo_boards/${boardId}`,
      (doc) => setBoard(doc.data)
    );
    // Listen to lists
    const unsubLists = service.listenToCollection<ListData>(
      `todo_boards/${boardId}/lists`,
      (docs) => {
        const mappedLists = docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled List", cardIds: d.data.cardIds || [] }));
        console.log(`[Board] Lists for board ${boardId}:`, mappedLists);
        setLists(mappedLists);
      },
      (err) => console.error(err)
    );
    // Listen to cards for each list
    let unsubCards: (() => void)[] = [];
    if (lists.length) {
      unsubCards.forEach(unsub => unsub());
      unsubCards = lists.map(list =>
        service.listenToCollection<CardData>(
          `todo_boards/${boardId}/lists/${list.id}/cards`,
          (docs) => setCards(prev => ({ ...prev, [list.id]: docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled Card" })) })),
          (err) => console.error(err)
        )
      );
    }
    return () => {
      unsubBoard();
      unsubLists();
      unsubCards.forEach(unsub => unsub());
    };
  }, [boardId, lists.length]);

  // Drag-to-scroll handlers
  useEffect(() => {
    const row = listsRowRef.current;
    if (!row) return;
    const onMouseDown = (e: MouseEvent) => {
      isDragging.current = true;
      startX.current = e.pageX - row.offsetLeft;
      scrollLeft.current = row.scrollLeft;
      row.classList.add('cursor-grabbing');
    };
    const onMouseLeave = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseUp = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseMove = (e: MouseEvent) => {
      if (!isDragging.current) return;
      e.preventDefault();
      const x = e.pageX - row.offsetLeft;
      const walk = (x - startX.current) * 1.5; // scroll speed
      row.scrollLeft = scrollLeft.current - walk;
    };
    row.addEventListener('mousedown', onMouseDown);
    row.addEventListener('mouseleave', onMouseLeave);
    row.addEventListener('mouseup', onMouseUp);
    row.addEventListener('mousemove', onMouseMove);
    // Touch events for mobile
    let touchStartX = 0;
    let touchScrollLeft = 0;
    const onTouchStart = (e: TouchEvent) => {
      isDragging.current = true;
      touchStartX = e.touches[0].pageX - row.offsetLeft;
      touchScrollLeft = row.scrollLeft;
    };
    const onTouchEnd = () => {
      isDragging.current = false;
    };
    const onTouchMove = (e: TouchEvent) => {
      if (!isDragging.current) return;
      const x = e.touches[0].pageX - row.offsetLeft;
      const walk = (x - touchStartX) * 1.5;
      row.scrollLeft = touchScrollLeft - walk;
    };
    row.addEventListener('touchstart', onTouchStart);
    row.addEventListener('touchend', onTouchEnd);
    row.addEventListener('touchmove', onTouchMove);
    return () => {
      row.removeEventListener('mousedown', onMouseDown);
      row.removeEventListener('mouseleave', onMouseLeave);
      row.removeEventListener('mouseup', onMouseUp);
      row.removeEventListener('mousemove', onMouseMove);
      row.removeEventListener('touchstart', onTouchStart);
      row.removeEventListener('touchend', onTouchEnd);
      row.removeEventListener('touchmove', onTouchMove);
    };
  }, [lists]);

  // Add card handler
  const addCard = async (listId: string, title: string) => {
    if (!title.trim()) return;
    const order = (cards[listId]?.length || 0);
    const newCard = {
      title: title.trim(),
      description: '',
      createdAt: new Date().toISOString(),
      order,
      // Add more fields as needed
    };
    await service.addDocument(`todo_boards/${boardId}/lists/${listId}/cards`, newCard);
    // The listener will update state
  };

  // Update card handler
  const updateCard = async (cardId: string, updates: Partial<CardData>) => {
    // Find the list containing this card
    const listId = Object.keys(cards).find(lid => cards[lid].some(card => card.id === cardId));
    if (!listId) return;
    await service.updateDocument(`todo_boards/${boardId}/lists/${listId}/cards`, cardId, updates);
  };

  const handleListDragEnd = async (event: DragEndEvent) => {
    if (!board) return;
    const { active, over } = event;
    if (!over || !active) return;
    if (!Array.isArray(board.listIds)) return;
    const activeId = String(active.id).replace(/^list-/, '');
    const overId = String(over.id).replace(/^list-/, '');
    const oldIndex = board.listIds.indexOf(activeId);
    const newIndex = board.listIds.indexOf(overId);
    if (oldIndex === -1 || newIndex === -1) return;
    if (oldIndex !== newIndex) {
      const newListIds = arrayMove(board.listIds, oldIndex, newIndex);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  // --- NEW: Card drag handler for cross-list movement ---
  const handleCardDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    if (!over || !active) return;
    const activeCardId = String(active.id).replace(/^card-/, '');
    let sourceListId: string | undefined;
    let destListId: string | undefined;
    for (const list of lists) {
      const idx = (cards[list.id] || []).findIndex(card => card.id === activeCardId);
      if (idx !== -1) {
        sourceListId = list.id;
        break;
      }
    }
    for (const list of lists) {
      if (over.data?.current?.sortable?.containerId === `list-${list.id}` || over.id === `list-${list.id}`) {
        destListId = list.id;
        break;
      }
      if ((cards[list.id] || []).some(card => `card-${card.id}` === over.id)) {
        destListId = list.id;
        break;
      }
    }
    if (!sourceListId || !destListId) return;
    if (sourceListId === destListId) {
      const cardList = cards[sourceListId] || [];
      const oldIdx = cardList.findIndex(card => card.id === activeCardId);
      const newIdx = cardList.findIndex(card => `card-${card.id}` === over.id);
      if (oldIdx === -1 || newIdx === -1 || oldIdx === newIdx) return;
      const newCards = arrayMove(cardList, oldIdx, newIdx);
      for (let i = 0; i < newCards.length; i++) {
        await service.updateDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, newCards[i].id, { order: i });
      }
      return;
    }
    const sourceCards = [...(cards[sourceListId] || [])];
    const destCards = [...(cards[destListId] || [])];
    const movingCardIdx = sourceCards.findIndex(card => card.id === activeCardId);
    if (movingCardIdx === -1) return;
    const [movingCard] = sourceCards.splice(movingCardIdx, 1);
    let insertIdx = destCards.findIndex(card => `card-${card.id}` === over.id);
    if (insertIdx === -1) insertIdx = destCards.length;
    destCards.splice(insertIdx, 0, movingCard);
    await service.deleteDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, movingCard.id);
    await service.addDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, { ...movingCard, order: insertIdx });
    for (let i = 0; i < destCards.length; i++) {
      await service.updateDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, destCards[i].id, { order: i });
    }
  };

  // Add deleteList handler
  const deleteList = async (listId: string) => {
    // Remove list document
    await service.deleteDocument(`todo_boards/${boardId}/lists`, listId);
    // Remove from board.listIds
    if (board && Array.isArray(board.listIds)) {
      const newListIds = board.listIds.filter(id => id !== listId);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  // Add list handler (FAB)
  const addList = async () => {
    try {
      const payload = {
        title: 'New List',
        cardIds: [],
        createdAt: new Date().toISOString(),
      } as Partial<ListData> & { createdAt: string };
      const newListId = await (service as any).addDocument(`todo_boards/${boardId}/lists`, payload);
      // If we received the new id, append to board.listIds for ordering
      if (newListId && board && Array.isArray(board.listIds)) {
        const updated = [...board.listIds, newListId as string];
        setBoard({ ...board, listIds: updated });
        await service.updateDocument('todo_boards', boardId, { listIds: updated });
      }
    } catch (err) {
      // eslint-disable-next-line no-console
      console.error('Failed to add list', err);
    }
  };

  if (!board) return <div>Loading board...</div>;

  // Deduplicate lists by name (case-insensitive)
  const uniqueLists = lists.filter(
    (list, index, self) =>
      list.title &&
      self.findIndex(l => l.title?.toLowerCase() === list.title?.toLowerCase()) === index
  );

  // If listIds is missing or not an array, just show all unique lists
  if (!Array.isArray(board.listIds) || board.listIds.length === 0) {
    if (uniqueLists.length === 0) return <div>No lists found for this board.</div>;
    return (
      <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 overflow-x-hidden">
        <div className="flex-1 flex flex-col min-h-0">
          {/* Board Title as sticky header */}
          {!hideHeader && (
            <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
              <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
            </div>
          )}
          {/* Lists Row Scrollable Area */}
          <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-auto">
            <DndContext
              sensors={sensors}
              collisionDetection={closestCenter}
              onDragStart={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) setActiveDragType('list');
                else if (id.startsWith('card-')) setActiveDragType('card');
                else setActiveDragType(null);
                setActiveDragId(id);
              }}
              onDragEnd={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) handleListDragEnd(event);
                else if (id.startsWith('card-')) handleCardDragEnd(event);
                setActiveDragId(null);
                setActiveDragType(null);
              }}
              onDragCancel={() => {
                setActiveDragId(null);
                setActiveDragType(null);
              }}
            >
              <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
            <div
              ref={listsRowRef}
              className="flex items-start gap-6 h-full cursor-grab w-max pr-10"
              style={{ WebkitOverflowScrolling: 'touch' }}
            >
                  {Array.isArray(board.listIds) && board.listIds.length > 0
                    ? board.listIds.map(listId => {
                        const list = lists.find(l => l.id === listId);
                        if (!list) return null;
                        return (
                          <ListColumn
                            key={list.id}
                            list={list}
                            cards={cards[list.id] || []}
                            boardId={boardId}
                            onAddCard={addCard}
                            onUpdateCard={updateCard}
                            dndId={`list-${list.id}`}
                            onDeleteList={deleteList}
                            cardIdPrefix="card-"
                          />
                        );
                      })
                    : uniqueLists.map(list => (
                <ListColumn
                  key={list.id}
                  list={list}
                  cards={cards[list.id] || []}
                  boardId={boardId}
                  onAddCard={addCard}
                  onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                />
              ))}
              {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
            </div>
              </SortableContext>
              <DragOverlay>
                {activeDragType === 'card' && activeDragId ? (() => {
                  // Find the card data
                  let card: CardData | undefined;
                  for (const list of lists) {
                    card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                    if (card) break;
                  }
                  return card ? (
                    <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                      <div className="font-semibold">{card.title}</div>
                      {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                    </div>
                  ) : null;
                })() : null}
                {activeDragType === 'list' && activeDragId ? (() => {
                  // Find the list data
                  const list = lists.find(l => `list-${l.id}` === activeDragId);
                  return list ? (
                    <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                      <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                    </div>
                  ) : null;
                })() : null}
              </DragOverlay>
            </DndContext>
          </div>
        </div>
        {/* FAB to add a list */}
        <button
          onClick={addList}
          className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50"
          aria-label="Add list"
          title="Add list"
        >
          +
        </button>
      </div>
    );
  }

  return (
    <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 overflow-x-hidden">
      <div className="flex-1 flex flex-col min-h-0">
        {/* Board Title as sticky header */}
        {!hideHeader && (
          <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
            <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
          </div>
        )}
        {/* Lists Row Scrollable Area */}
        <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-auto">
          <DndContext
            sensors={sensors}
            collisionDetection={closestCenter}
            onDragStart={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) setActiveDragType('list');
              else if (id.startsWith('card-')) setActiveDragType('card');
              else setActiveDragType(null);
              setActiveDragId(id);
            }}
            onDragEnd={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) handleListDragEnd(event);
              else if (id.startsWith('card-')) handleCardDragEnd(event);
              setActiveDragId(null);
              setActiveDragType(null);
            }}
            onDragCancel={() => {
              setActiveDragId(null);
              setActiveDragType(null);
            }}
          >
            <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
          <div
            ref={listsRowRef}
            className="flex items-start gap-6 h-full cursor-grab w-max pr-10"
            style={{ WebkitOverflowScrolling: 'touch' }}
          >
            {Array.isArray(board.listIds) && board.listIds.length > 0
              ? board.listIds.map(listId => {
                  const list = lists.find(l => l.id === listId);
                  if (!list) return null;
                  return (
                    <ListColumn
                      key={list.id}
                      list={list}
                      cards={cards[list.id] || []}
                      boardId={boardId}
                      onAddCard={addCard}
                      onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                    />
                  );
                })
              : uniqueLists.map(list => (
                  <ListColumn
                    key={list.id}
                    list={list}
                    cards={cards[list.id] || []}
                    boardId={boardId}
                    onAddCard={addCard}
                    onUpdateCard={updateCard}
                        dndId={`list-${list.id}`}
                        onDeleteList={deleteList}
                        cardIdPrefix="card-"
                  />
                ))}
            {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
          </div>
            </SortableContext>
            <DragOverlay>
              {activeDragType === 'card' && activeDragId ? (() => {
                // Find the card data
                let card: CardData | undefined;
                for (const list of lists) {
                  card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                  if (card) break;
                }
                return card ? (
                  <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                    <div className="font-semibold">{card.title}</div>
                    {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                  </div>
                ) : null;
              })() : null}
              {activeDragType === 'list' && activeDragId ? (() => {
                // Find the list data
                const list = lists.find(l => `list-${l.id}` === activeDragId);
                return list ? (
                  <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                    <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                  </div>
                ) : null;
              })() : null}
            </DragOverlay>
          </DndContext>
        </div>
      </div>
      {/* FAB to add a list */}
      <button
        onClick={addList}
        className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50"
        aria-label="Add list"
        title="Add list"
      >
        +
      </button>
    </div>
  );
};

export default Board; 
```

- Wired the FAB to create a new list on the current board:
  - Adds a list document to `todo_boards/{boardId}/lists` titled “New List”.
  - Appends the new list’s id to `board.listIds` and persists it to `todo_boards/{boardId}` to keep ordering.
  - Button includes proper aria-label/title.

File updated:
- `web-app/src/components/TaskBoard/Board.tsx`

If your `addDocument` API returns a different shape than an id, I can adapt the id extraction.

---

**User**

when adding  a card to the list and pressing enter the card should be added and an another new card should be started . lets a an x to the new card form to allow it to be canceled

---

**Cursor**

```typescriptreact
import React, { useState, useRef } from "react";
import Card from "./Card";
import type { ListData, CardData } from "../../types/taskManager";
import { Edit, ChevronDown, ChevronUp, Trash2 } from 'lucide-react';
import { useSortable, SortableContext, verticalListSortingStrategy } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface ListColumnProps {
  list: ListData;
  cards: CardData[];
  boardId: string;
  onAddCard: (listId: string, title: string) => void;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
  onDeleteList: (listId: string) => void;
  cardIdPrefix?: string;
}

const ListColumn: React.FC<ListColumnProps> = ({ list, cards, boardId, onAddCard, onUpdateCard, dndId, onDeleteList, cardIdPrefix = '' }) => {
  const [collapsed, setCollapsed] = useState(false);
  const [addingCard, setAddingCard] = useState(false);
  const [newCardTitle, setNewCardTitle] = useState("");
  const newCardInputRef = useRef<HTMLInputElement | null>(null);

  // dnd-kit sortable for lists
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };

  const handleAddCard = () => {
    if (!newCardTitle.trim()) return;
    onAddCard(list.id, newCardTitle);
    setNewCardTitle("");
    setAddingCard(true);
    // Re-focus the input for rapid card entry
    setTimeout(() => newCardInputRef.current?.focus(), 0);
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      className={`bg-pb-darker rounded-xl shadow-lg border border-pb-primary/30 flex flex-col flex-shrink-0 transition-all duration-300 ${collapsed ? '!w-14 min-w-[3.5rem] min-h-[22rem] p-0 bg-pb-primary/20 relative items-center justify-center' : 'p-4 min-w-[18rem] w-[20rem]'}`}
    >
      <div className={`flex items-center justify-between mb-4 w-full ${collapsed ? 'mb-0' : ''}`} style={collapsed ? { height: 'auto' } : {}}>
        {collapsed ? (
          <>
            <div className="relative h-full w-full flex items-center justify-center">
              <span className="text-sm font-bold text-pb-primary/80 select-none transform -rotate-90 whitespace-nowrap tracking-widest text-center">
                {list.title}
              </span>
              <button
                onClick={() => setCollapsed(false)}
                className="absolute bottom-2 left-1/2 -translate-x-1/2 text-pb-primary hover:text-pb-success p-1 rounded"
                aria-label="Expand list"
                title="Expand"
              >
                <ChevronDown size={18} />
              </button>
            </div>
          </>
        ) : (
          <>
            <div className="text-lg font-bold text-white tracking-wide text-left">
              {list.title}
            </div>
            <div className="flex items-center gap-2">
              <button onClick={() => setCollapsed(true)} className="text-pb-primary hover:text-pb-success p-1 rounded">
                <ChevronUp size={20} />
              </button>
              <button className="text-pb-primary hover:text-pb-success p-1 rounded"><Edit size={20} /></button>
              <button className="text-pb-accent hover:text-red-500 p-1 rounded" onClick={() => onDeleteList(list.id)}><Trash2 size={20} /></button>
            </div>
          </>
        )}
      </div>
      {!collapsed && (
        <>
          <SortableContext items={Array.isArray(cards) ? cards.map(card => `${cardIdPrefix}${card.id}`) : []} strategy={verticalListSortingStrategy}>
            <div className="flex-1 flex flex-col gap-3 mb-4">
              {cards.map(card => (
                <Card key={card.id} card={card} onUpdateCard={onUpdateCard} dndId={`${cardIdPrefix}${card.id}`} />
              ))}
            </div>
          </SortableContext>
          {addingCard ? (
            <div className="flex flex-col gap-2 mt-2 relative">
              <button
                type="button"
                aria-label="Cancel"
                title="Cancel"
                onClick={() => { setAddingCard(false); setNewCardTitle(""); }}
                className="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-pb-darker/70 border border-pb-primary/40 text-white flex items-center justify-center hover:bg-pb-primary/40"
              >
                ×
              </button>
              <input
                ref={newCardInputRef}
                className="rounded border border-pb-primary/40 px-2 py-1 focus:outline-none focus:ring-2 focus:ring-pb-primary text-[#222]"
                type="text"
                value={newCardTitle}
                onChange={e => setNewCardTitle(e.target.value)}
                placeholder="Enter a title for this card..."
                autoFocus
                onKeyDown={e => {
                  if (e.key === 'Enter') {
                    e.preventDefault();
                    handleAddCard();
                  }
                  if (e.key === 'Escape') { setAddingCard(false); setNewCardTitle(""); }
                }}
              />
              <div className="flex gap-2">
                <button
                  className="bg-pb-success hover:bg-pb-primary text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={handleAddCard}
                >
                  Add
                </button>
                <button
                  className="bg-pb-darker hover:bg-pb-primary/40 text-white font-semibold py-1 px-3 rounded shadow"
                  onClick={() => { setAddingCard(false); setNewCardTitle(""); }}
                >
                  Cancel
                </button>
              </div>
            </div>
          ) : (
            <button className="mt-auto bg-pb-primary/90 hover:bg-pb-success text-white font-semibold py-2 px-3 rounded transition shadow focus:outline-none"
              onClick={() => setAddingCard(true)}
            >
              + Add Card
            </button>
          )}
        </>
      )}
    </div>
  );
};

export default ListColumn; 
```

- Rapid add: Pressing Enter in the new card input now adds the card and keeps the input open for the next title, with focus preserved.
- Cancel controls:
  - Added an “×” close button to the new card form.
  - Escape key or Cancel button also closes and clears the input.

File updated:
- `web-app/src/components/TaskBoard/ListColumn.tsx`

---

**User**

can we fix the description textarea to be the same size and colour as the container its in. also there is a random + button on screen can we remove this.

---

**Cursor**

```typescriptreact
import React from 'react';
import { globalStyles } from '../styles/globalStyles';

interface RichTextEditorProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
  minHeight?: number;
  disabled?: boolean;
}

export const RichTextEditor: React.FC<RichTextEditorProps> = ({
  value,
  onChange,
  placeholder = 'Start typing...',
  minHeight = 200,
  disabled = false,
}) => {
  // Detect if running on web
  const isWeb = typeof window !== 'undefined' && typeof document !== 'undefined';

  if (isWeb) {
    return (
      <div style={{ width: '100%' }}>
        <textarea
          style={{
            width: '100%',
            minHeight,
            resize: 'vertical',
            borderRadius: 12,
            border: '1px solid rgba(255,255,255,0.2)',
            background: 'rgba(0,0,0,0.2)',
            color: '#fff',
            padding: 12,
            outline: 'none',
          }}
          value={value}
          onChange={e => onChange(e.target.value)}
          placeholder={placeholder}
          disabled={disabled}
        />
      </div>
    );
  }

  // For mobile platform, use a simple native implementation
  // (Keep this for React Native usage, if needed)
  // Remove react-native imports for web build
  return null;
}; 

```

```typescriptreact
import React, { useState, useEffect } from "react";
import type { CardData } from "../../types/taskManager";
import { ImageUpload } from "../ImageUpload";
import type { PropImage } from "../../types/props";
import { useFirebase } from "../../contexts/FirebaseContext";
import { v4 as uuidv4 } from 'uuid';
import { RichTextEditor } from "../../../shared/components/RichTextEditor";
import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface CardProps {
  card: CardData;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
}

// Popover/modal scaffold for feature dialogs
const Popover: React.FC<{ open: boolean; onClose: () => void; title: string; children: React.ReactNode }> = ({ open, onClose, title, children }) => {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div className="bg-pb-darker rounded-xl p-6 w-full max-w-sm shadow-xl flex flex-col gap-3 relative">
        <button className="absolute top-2 right-2 text-white text-xl" onClick={onClose} aria-label="Close">×</button>
        <div className="text-base font-bold text-white mb-2">{title}</div>
        {children}
      </div>
    </div>
  );
};

// Helper: render description with @-mention links
function renderDescriptionWithLinks(description: string) {
  if (!description) return null;
  // Regex for [@Name](prop:prop1) and similar, and for @@User
  const mentionRegex = /\[@([^\]]+)\]\((prop|container|user):([^\)]+)\)|@@([a-zA-Z0-9_]+)/g;
  const parts = [];
  let lastIndex = 0;
  let match;
  while ((match = mentionRegex.exec(description)) !== null) {
    if (match.index > lastIndex) {
      parts.push(description.slice(lastIndex, match.index));
    }
    if (match[1] && match[2] && match[3]) {
      // Markdown-style mention
      const [, name, type, id] = match;
      let href = '#';
      let color = '#3B82F6';
      let label = name;
      if (type === 'prop') {
        href = `/props/${id}`;
        color = '#3B82F6';
      } else if (type === 'container') {
        href = `/containers/${id}`;
        color = '#A855F7';
      } else if (type === 'user') {
        href = `/users/${id}`;
        color = '#22C55E';
        label = '@' + name;
      }
      parts.push(
        <a
          key={match.index}
          href={href}
          className="underline hover:text-pb-success"
          style={{ color, fontWeight: 600, marginRight: 2 }}
          target="_blank"
          rel="noopener noreferrer"
        >
          {label}
        </a>
      );
    } else if (match[4]) {
      // @@User mention
      const user = match[4];
      const href = `/users/${user}`;
      const color = '#22C55E';
      parts.push(
        <a
          key={match.index}
          href={href}
          className="underline hover:text-pb-success"
          style={{ color, fontWeight: 600, marginRight: 2 }}
          target="_blank"
          rel="noopener noreferrer"
        >
          @{user}
        </a>
      );
    }
    lastIndex = match.index + match[0].length;
  }
  if (lastIndex < description.length) {
    parts.push(description.slice(lastIndex));
  }
  return parts;
}

const CardDetailModal: React.FC<{
  open: boolean;
  onClose: () => void;
  card: CardData;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
}> = ({ open, onClose, card, onUpdateCard }) => {
  const [title, setTitle] = useState(card.title);
  const { service: firebaseService, user } = useFirebase();
  const [propsList, setPropsList] = useState<{ id: string; name: string }[]>([]);
  const [containersList, setContainersList] = useState<{ id: string; name: string }[]>([]);
  const [usersList, setUsersList] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    firebaseService.getDocuments("props").then(docs => setPropsList(docs.map(d => ({ id: d.id, name: d.data.name }))));
    firebaseService.getDocuments("containers").then(docs => setContainersList(docs.map(d => ({ id: d.id, name: d.data.name }))));
    firebaseService.getDocuments("users").then(docs => setUsersList(docs.map(d => ({ id: d.id, name: d.data.displayName || d.data.name || d.data.email }))));
  }, [firebaseService]);

  const [description, setDescription] = useState(card.description || "");
  const [labels, setLabels] = useState<string[]>(card.labels || []);
  const [members, setMembers] = useState(card.assignedTo || []);
  const [dueDate, setDueDate] = useState(card.dueDate || "");
  const [attachments, setAttachments] = useState(card.attachments || []);
  const [checklists, setChecklists] = useState(card.checklist || []);
  const [comments, setComments] = useState(card.comments || []);
  const [activityLog, setActivityLog] = useState(card.activityLog || []);
  const [images, setImages] = useState<PropImage[]>(card.images || []);

  // Popover state
  const [showLabels, setShowLabels] = useState(false);
  const [showDates, setShowDates] = useState(false);
  const [showChecklist, setShowChecklist] = useState(false);
  const [showMembers, setShowMembers] = useState(false);
  const [showAdd, setShowAdd] = useState(false);

  // @ context menu state
  const [showMentionMenu, setShowMentionMenu] = useState(false);
  const [mentionMenuPosition, setMentionMenuPosition] = useState({ top: 0, left: 0 });
  const [mentionType, setMentionType] = useState<'prop' | 'container' | 'user' | null>(null);
  const [showMentionSearch, setShowMentionSearch] = useState(false);
  const [mentionSearchText, setMentionSearchText] = useState('');
  const [mentionSuggestions, setMentionSuggestions] = useState<any[]>([]);

  const [newComment, setNewComment] = useState("");

  // 1. Add state for image upload popup and checklist add UI
  const [showImageUpload, setShowImageUpload] = useState(false);
  const [newChecklistItem, setNewChecklistItem] = useState("");

  // Add state for new label
  const [newLabelTitle, setNewLabelTitle] = useState('');

  // Add state for card color
  const [cardColor, setCardColor] = useState(card.color || '#374151');

  // Add completed state
  const [completed, setCompleted] = useState(card.completed || false);

  // Helper to log activity
  function logActivity(type: string, details: any) {
    setActivityLog(log => [
      ...log,
      {
        id: uuidv4(),
        type,
        userId: user?.uid || 'anonymous',
        timestamp: new Date().toISOString(),
        details,
      },
    ]);
  }

  // On save, compare previous and new values, log changes
  const handleSave = () => {
    if (title !== card.title) logActivity('Title changed', { from: card.title, to: title });
    if (description !== card.description) logActivity('Description changed', {});
    if (dueDate !== card.dueDate) logActivity('Due date changed', { from: card.dueDate, to: dueDate });
    if (cardColor !== card.color) logActivity('Color changed', { from: card.color, to: cardColor });
    if (JSON.stringify(members) !== JSON.stringify(card.assignedTo)) logActivity('Assignee changed', { from: card.assignedTo, to: members });
    if (completed !== card.completed) logActivity('Completed changed', { from: card.completed, to: completed });
    if (JSON.stringify(labels) !== JSON.stringify(card.labels)) logActivity('Labels changed', {});
    if (JSON.stringify(checklists) !== JSON.stringify(card.checklist)) logActivity('Checklist changed', {});
    onUpdateCard(card.id, { title, description, color: cardColor, assignedTo: members, completed, activityLog, dueDate, labels, checklist: checklists });
    onClose();
  };

  // Helper: open @ menu at cursor
  const handleDescriptionKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === '@') {
      // Find cursor position for popover (approximate)
      const textarea = e.target as HTMLTextAreaElement;
      const rect = textarea.getBoundingClientRect();
      setMentionMenuPosition({ top: rect.top + 40, left: rect.left + 40 });
      setShowMentionMenu(true);
    }
  };

  // When mention type is selected
  const handleSelectMentionType = (type: 'prop' | 'container' | 'user') => {
    setMentionType(type);
    setShowMentionMenu(false);
    setShowMentionSearch(true);
    setMentionSearchText('');
    if (type === 'prop') setMentionSuggestions(propsList);
    else if (type === 'container') setMentionSuggestions(containersList);
    else setMentionSuggestions(usersList);
  };

  // When searching in mention popover
  const handleMentionSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value;
    setMentionSearchText(val);
    let data = [];
    if (mentionType === 'prop') data = propsList;
    else if (mentionType === 'container') data = containersList;
    else data = usersList;
    setMentionSuggestions(data.filter(item => item.name && item.name.toLowerCase().includes(val.toLowerCase())));
  };

  // When a mention is picked
  const handlePickMention = (item: any) => {
    // Insert mention at cursor (simple: append for now)
    let mentionText = '';
    if (mentionType === 'prop') mentionText = `[@${item.name}](prop:${item.id})`;
    else if (mentionType === 'container') mentionText = `[@${item.name}](container:${item.id})`;
    else mentionText = `@${item.name}`;
    setDescription(desc => desc + mentionText + ' ');
    setShowMentionSearch(false);
    setMentionType(null);
  };

  // Close all popovers
  const closeMentionMenus = () => {
    setShowMentionMenu(false);
    setShowMentionSearch(false);
    setMentionType(null);
  };

  // Combine comments and activity log for chronological display
  const combinedLog = [
    ...comments.map(c => ({
      type: 'comment',
      id: c.id,
      userId: c.userId,
      text: c.text,
      createdAt: c.createdAt,
    })),
    ...activityLog.map(a => ({
      type: 'activity',
      id: a.id,
      userId: a.userId,
      text: a.type,
      details: a.details,
      createdAt: a.timestamp,
    })),
  ].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());

  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div
        className="relative rounded-2xl shadow-2xl flex flex-row overflow-y-auto max-h-[98vh] min-h-[700px] border border-gray-300"
        style={{ background: cardColor, transition: 'background 0.3s' }}
      >
        {/* Close (X) button top right of modal */}
        <button className="absolute top-4 right-4 text-white text-2xl z-50" onClick={onClose} aria-label="Close">×</button>
        {/* Left column */}
        <div className="flex-1 min-w-[340px] max-w-[520px] p-10 flex flex-col gap-8 rounded-l-2xl overflow-y-auto" style={{ maxHeight: '90vh' }}>
          {/* Title */}
          <div className="flex items-center gap-3 mb-2">
            <input
              type="checkbox"
              checked={completed}
              onChange={() => setCompleted(c => !c)}
              className="w-5 h-5 accent-pb-success rounded"
              title="Mark card as completed"
            />
            <input
              className={`rounded-lg px-3 py-2 text-2xl font-bold bg-black/20 border border-white/20 shadow-sm focus:ring-2 focus:ring-pb-primary focus:outline-none placeholder:text-gray-200 text-white ${completed ? 'line-through opacity-60' : ''}`}
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Card title"
              style={{ boxShadow: 'none', border: 'none' }}
              disabled={completed}
            />
          </div>
          {/* Add bar */}
          <div className="flex gap-2 mb-2">
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowLabels(true)}>
              <span>🏷️</span> Labels
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowDates(true)}>
              <span>🕒</span> Dates
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowChecklist(true)}>
              <span>☑️</span> Checklist
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowMembers(true)}>
              <span>👤</span> Assign to
              {members.length > 0 && (
                <span className="ml-2 bg-pb-success text-white rounded-full px-2 py-1 text-xs font-bold">{usersList.find(u => u.id === members[0])?.name?.[0] || '?'}</span>
              )}
            </button>
            {/* Image upload icon */}
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowImageUpload(true)} title="Upload Images">
              <span role="img" aria-label="Upload">📷</span>
            </button>
          </div>
          {/* Image upload popup */}
          <Popover open={showImageUpload} onClose={() => setShowImageUpload(false)} title="Upload Images">
            <ImageUpload currentImages={images} onImagesChange={setImages} />
          </Popover>
          {/* Card color picker */}
            <div className="flex gap-2 items-center mt-2">
            <span className="text-gray-700 text-sm">Card color:</span>
            {["#27ae60", "#f1c40f", "#e67e22", "#e74c3c", "#8e44ad", "#2980b9", "#374151"].map(color => (
                <button
                  key={color}
                className="w-7 h-7 rounded-full border-2 border-white shadow hover:scale-110 transition"
                  style={{ background: color }}
                onClick={() => setCardColor(color)}
                  aria-label={`Set card color ${color}`}
                />
              ))}
          </div>
          {/* Description */}
          <div className="bg-black/20 rounded-lg p-2 shadow-inner">
            <label className="block font-semibold text-white mb-1">Description</label>
            <RichTextEditor
              value={description}
              onChange={setDescription}
              placeholder="Add a more detailed description..."
              minHeight={120}
              disabled={false}
            />
          </div>
          {/* Checklist */}
          <div>
            <div className="font-semibold text-gray-300 mb-2">Checklists</div>
            <div className="flex gap-2 mb-2">
              <input
                className="flex-1 rounded-lg border border-white/20 px-2 py-1 text-base bg-black/20 text-white placeholder:text-gray-200"
                value={newChecklistItem}
                onChange={e => setNewChecklistItem(e.target.value)}
                placeholder="Add checklist item..."
                onKeyDown={e => {
                  if (e.key === 'Enter' && newChecklistItem.trim()) {
                    setChecklists(list => [...list, { id: uuidv4(), text: newChecklistItem, checked: false }]);
                    setNewChecklistItem("");
                  }
                }}
              />
              <button className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded-lg shadow" disabled={!newChecklistItem.trim()} onClick={() => {
                if (newChecklistItem.trim()) {
                  setChecklists(list => [...list, { id: uuidv4(), text: newChecklistItem, checked: false }]);
                  setNewChecklistItem("");
                }
              }}>Add</button>
            </div>
            <div className="flex flex-col gap-2">
              {checklists.map((item, i) => (
                <label key={item.id || i} className="flex items-center gap-2 bg-black/20 border border-white/20 text-white rounded-lg px-3 py-2 text-base cursor-pointer shadow-sm">
                  <input
                    type="checkbox"
                    checked={!!item.checked}
                    onChange={() => {
                      setChecklists(list => list.map((c, idx) => idx === i ? { ...c, checked: !c.checked } : c));
                    }}
                  />
                  <span style={{ textDecoration: item.checked ? 'line-through' : 'none' }}>{item.text || item.id}</span>
                </label>
              ))}
            </div>
          </div>
          {/* Dates popover */}
          <Popover open={showDates} onClose={() => setShowDates(false)} title="Set Due Date & Time">
            <div className="flex flex-col gap-2">
              <label className="text-white text-sm">Due Date & Time</label>
              <input
                type="datetime-local"
                className="rounded border border-pb-primary/40 px-2 py-1 text-[#222]"
                value={dueDate ? dueDate.substring(0, 16) : ''}
                onChange={e => setDueDate(e.target.value)}
              />
              <button
                className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded mt-2"
                onClick={() => setShowDates(false)}
              >Set</button>
            </div>
          </Popover>
          {/* Show selected due date and time */}
          {dueDate && (
            <div className="text-xs text-pb-gray mt-1">Due: {new Date(dueDate).toLocaleString()}</div>
          )}
          {/* Labels popover */}
          <Popover open={showLabels} onClose={() => setShowLabels(false)} title="Manage Labels">
            <div className="flex flex-col gap-2">
              {/* Add new label */}
              <div className="flex gap-2 items-center mb-2">
                <input
                  className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-xs"
                  placeholder="Label title"
                  value={newLabelTitle || ''}
                  onChange={e => setNewLabelTitle(e.target.value)}
                />
                <button
                  className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-2 rounded text-xs"
                  disabled={!newLabelTitle}
                  onClick={() => {
                    setLabels(list => [...list, newLabelTitle]);
                    setNewLabelTitle('');
                  }}
                >Add</button>
              </div>
              {/* List and edit labels */}
              <div className="flex flex-col gap-2">
                {labels.map((label, i) => (
                  <div key={i} className="flex items-center gap-2">
                    <input
                      className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-xs"
                      value={label}
                      onChange={e => {
                        const v = e.target.value;
                        setLabels(list => list.map((l, idx) => idx === i ? v : l));
                      }}
                    />
                    <button
                      className="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-2 rounded text-xs"
                      onClick={() => setLabels(list => list.filter((_, idx) => idx !== i))}
                    >Remove</button>
                  </div>
                ))}
              </div>
            </div>
          </Popover>
          {/* Show current labels as pills */}
          {labels.length > 0 && (
            <div className="flex gap-2 flex-wrap mb-2">
              {labels.map((label, i) => (
                <span key={i} className="px-2 py-1 rounded text-xs font-semibold bg-pb-primary text-white">{label}</span>
              ))}
            </div>
          )}
        </div>
        {/* Right column: Comments and Activity */}
        <div className="w-[340px] flex flex-col p-8 gap-6 bg-pb-darker/90 rounded-r-2xl border-l border-gray-200">
          <div className="font-semibold text-white text-lg mb-2">Comments and activity</div>
          {/* Add comment area */}
          <div className="flex gap-2 items-center mb-4">
            <input
              className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-[#222]"
              value={newComment}
              onChange={e => setNewComment(e.target.value)}
              placeholder="Write a comment..."
              onKeyDown={e => {
                if (e.key === 'Enter' && newComment.trim()) {
                  setComments(c => [
                    ...c,
                    {
                      id: uuidv4(),
                      userId: user?.uid || 'anonymous',
                      text: newComment,
                      createdAt: new Date().toISOString(),
                    },
                  ]);
                  setNewComment("");
                }
              }}
            />
            <button
              className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded"
              disabled={!newComment.trim()}
              onClick={() => {
                if (newComment.trim()) {
                  setComments(c => [
                    ...c,
                    {
                      id: uuidv4(),
                      userId: user?.uid || 'anonymous',
                      text: newComment,
                      createdAt: new Date().toISOString(),
                    },
                  ]);
                  setNewComment("");
                }
              }}
            >Add</button>
          </div>
          {/* Comments list */}
          <div className="flex flex-col gap-2 mb-6">
            {combinedLog.map((item, i) => (
              <div key={item.id || i} className="flex items-start gap-2">
                <div className="w-8 h-8 rounded-full bg-pb-primary flex items-center justify-center text-white font-bold text-sm">{item.userId?.[0] || 'U'}</div>
                <div>
                  <div className="text-white font-semibold text-sm">{item.userId || 'User'}</div>
                  {item.type === 'comment' ? (
                    <div className="text-white text-xs opacity-70">{item.text}</div>
                  ) : (
                    <div className="text-pb-primary text-xs">{item.text}</div>
                  )}
                  <div className="text-pb-gray text-xs">{item.createdAt ? new Date(item.createdAt).toLocaleString() : ''}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
        {/* Modal footer: Save/Delete/Close */}
        <div className="absolute bottom-6 left-8 flex gap-2">
          <button className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded shadow" onClick={handleSave}>Save</button>
          <button className="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded shadow">Delete</button>
        </div>
      </div>
    </div>
  );
};

const Card: React.FC<CardProps> = ({ card, onUpdateCard, dndId }) => {
  const [modalOpen, setModalOpen] = useState(false);
  const handleOpen = (e: React.MouseEvent) => {
    e.preventDefault();
    setModalOpen(true);
  };
  // dnd-kit sortable for cards
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };
  return (
    <>
      <div
        ref={setNodeRef}
        style={{
          ...style, // dnd-kit drag styles
          background: card.color || '#374151',
          minHeight: 90,
        }}
        {...attributes}
        {...listeners}
        className="block rounded-lg p-3 shadow hover:shadow-lg transition cursor-pointer no-underline"
        onClick={handleOpen}
        tabIndex={0}
        role="button"
        onKeyPress={e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleOpen({ preventDefault: () => {} } as React.MouseEvent);
          }
        }}
      >
        <div className="font-semibold" style={{ color: '#fff' }}>{card.title}</div>
    {card.description && (
          <div className="text-xs mt-1" style={{ color: '#fff' }}>{renderDescriptionWithLinks(card.description)}</div>
    )}
      </div>
      <CardDetailModal open={modalOpen} onClose={() => setModalOpen(false)} card={card} onUpdateCard={onUpdateCard} />
    </>
);
};

export default Card; 
```

- Made the description editor match its container:
  - Updated `RichTextEditor` styles to full-width with rounded corners, semi-transparent dark background, white text, and subtle border to blend with the modal’s dark panel.
  - Applied minHeight consistently via props.

- Removed the stray “+” near Checklists:
  - Replaced the header/button combo with a simple “Checklists” label. If you still want an add button, it already exists next to the input and Enter-to-add works.

Files updated:
- `web-app/shared/components/RichTextEditor.tsx`
- `web-app/src/components/TaskBoard/Card.tsx`

If you prefer a fixed height (no resize) for the description, I can change `resize: 'vertical'` to `resize: 'none'` and set a taller minHeight.

---

**User**

the colour change onthe cards in not being implamented on the list 

---

**Cursor**

```typescript
export interface CardData {
  id: string;
  title: string;
  description?: string;
  dueDate?: string;
  imageUrl?: string;
  assignedTo?: string[];
  labels?: string[];
  checklist?: { id: string; text: string; checked: boolean }[];
  comments?: { id: string; userId: string; text: string; createdAt: string }[];
  activityLog?: { id: string; type: string; userId: string; timestamp: string; details?: any }[];
  attachments?: string[];
  completed?: boolean;
  propId?: string;
  color?: string;
  [key: string]: any;
}

export interface ListData {
  id: string;
  title: string;
  cardIds: string[];
  [key: string]: any;
}

export interface BoardData {
  id: string;
  title: string;
  listIds: string[];
  showId?: string;
  [key: string]: any;
} 
```

```typescriptreact
import React, { useState, useEffect } from "react";
import type { CardData } from "../../types/taskManager";
import { ImageUpload } from "../ImageUpload";
import type { PropImage } from "../../types/props";
import { useFirebase } from "../../contexts/FirebaseContext";
import { v4 as uuidv4 } from 'uuid';
import { RichTextEditor } from "../../../shared/components/RichTextEditor";
import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface CardProps {
  card: CardData;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
}

// Popover/modal scaffold for feature dialogs
const Popover: React.FC<{ open: boolean; onClose: () => void; title: string; children: React.ReactNode }> = ({ open, onClose, title, children }) => {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div className="bg-pb-darker rounded-xl p-6 w-full max-w-sm shadow-xl flex flex-col gap-3 relative">
        <button className="absolute top-2 right-2 text-white text-xl" onClick={onClose} aria-label="Close">×</button>
        <div className="text-base font-bold text-white mb-2">{title}</div>
        {children}
      </div>
    </div>
  );
};

// Helper: render description with @-mention links
function renderDescriptionWithLinks(description: string) {
  if (!description) return null;
  // Regex for [@Name](prop:prop1) and similar, and for @@User
  const mentionRegex = /\[@([^\]]+)\]\((prop|container|user):([^\)]+)\)|@@([a-zA-Z0-9_]+)/g;
  const parts = [];
  let lastIndex = 0;
  let match;
  while ((match = mentionRegex.exec(description)) !== null) {
    if (match.index > lastIndex) {
      parts.push(description.slice(lastIndex, match.index));
    }
    if (match[1] && match[2] && match[3]) {
      // Markdown-style mention
      const [, name, type, id] = match;
      let href = '#';
      let color = '#3B82F6';
      let label = name;
      if (type === 'prop') {
        href = `/props/${id}`;
        color = '#3B82F6';
      } else if (type === 'container') {
        href = `/containers/${id}`;
        color = '#A855F7';
      } else if (type === 'user') {
        href = `/users/${id}`;
        color = '#22C55E';
        label = '@' + name;
      }
      parts.push(
        <a
          key={match.index}
          href={href}
          className="underline hover:text-pb-success"
          style={{ color, fontWeight: 600, marginRight: 2 }}
          target="_blank"
          rel="noopener noreferrer"
        >
          {label}
        </a>
      );
    } else if (match[4]) {
      // @@User mention
      const user = match[4];
      const href = `/users/${user}`;
      const color = '#22C55E';
      parts.push(
        <a
          key={match.index}
          href={href}
          className="underline hover:text-pb-success"
          style={{ color, fontWeight: 600, marginRight: 2 }}
          target="_blank"
          rel="noopener noreferrer"
        >
          @{user}
        </a>
      );
    }
    lastIndex = match.index + match[0].length;
  }
  if (lastIndex < description.length) {
    parts.push(description.slice(lastIndex));
  }
  return parts;
}

const CardDetailModal: React.FC<{
  open: boolean;
  onClose: () => void;
  card: CardData;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
}> = ({ open, onClose, card, onUpdateCard }) => {
  const [title, setTitle] = useState(card.title);
  const { service: firebaseService, user } = useFirebase();
  const [propsList, setPropsList] = useState<{ id: string; name: string }[]>([]);
  const [containersList, setContainersList] = useState<{ id: string; name: string }[]>([]);
  const [usersList, setUsersList] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    firebaseService.getDocuments("props").then(docs => setPropsList(docs.map(d => ({ id: d.id, name: d.data.name }))));
    firebaseService.getDocuments("containers").then(docs => setContainersList(docs.map(d => ({ id: d.id, name: d.data.name }))));
    firebaseService.getDocuments("users").then(docs => setUsersList(docs.map(d => ({ id: d.id, name: d.data.displayName || d.data.name || d.data.email }))));
  }, [firebaseService]);

  const [description, setDescription] = useState(card.description || "");
  const [labels, setLabels] = useState<string[]>(card.labels || []);
  const [members, setMembers] = useState(card.assignedTo || []);
  const [dueDate, setDueDate] = useState(card.dueDate || "");
  const [attachments, setAttachments] = useState(card.attachments || []);
  const [checklists, setChecklists] = useState(card.checklist || []);
  const [comments, setComments] = useState(card.comments || []);
  const [activityLog, setActivityLog] = useState(card.activityLog || []);
  const [images, setImages] = useState<PropImage[]>(card.images || []);

  // Popover state
  const [showLabels, setShowLabels] = useState(false);
  const [showDates, setShowDates] = useState(false);
  const [showChecklist, setShowChecklist] = useState(false);
  const [showMembers, setShowMembers] = useState(false);
  const [showAdd, setShowAdd] = useState(false);

  // @ context menu state
  const [showMentionMenu, setShowMentionMenu] = useState(false);
  const [mentionMenuPosition, setMentionMenuPosition] = useState({ top: 0, left: 0 });
  const [mentionType, setMentionType] = useState<'prop' | 'container' | 'user' | null>(null);
  const [showMentionSearch, setShowMentionSearch] = useState(false);
  const [mentionSearchText, setMentionSearchText] = useState('');
  const [mentionSuggestions, setMentionSuggestions] = useState<any[]>([]);

  const [newComment, setNewComment] = useState("");

  // 1. Add state for image upload popup and checklist add UI
  const [showImageUpload, setShowImageUpload] = useState(false);
  const [newChecklistItem, setNewChecklistItem] = useState("");

  // Add state for new label
  const [newLabelTitle, setNewLabelTitle] = useState('');

  // Add state for card color
  const [cardColor, setCardColor] = useState(card.color || '#374151');

  // Add completed state
  const [completed, setCompleted] = useState(card.completed || false);

  // Helper to log activity
  function logActivity(type: string, details: any) {
    setActivityLog(log => [
      ...log,
      {
        id: uuidv4(),
        type,
        userId: user?.uid || 'anonymous',
        timestamp: new Date().toISOString(),
        details,
      },
    ]);
  }

  // On save, compare previous and new values, log changes
  const handleSave = () => {
    if (title !== card.title) logActivity('Title changed', { from: card.title, to: title });
    if (description !== card.description) logActivity('Description changed', {});
    if (dueDate !== card.dueDate) logActivity('Due date changed', { from: card.dueDate, to: dueDate });
    if (cardColor !== card.color) logActivity('Color changed', { from: card.color, to: cardColor });
    if (JSON.stringify(members) !== JSON.stringify(card.assignedTo)) logActivity('Assignee changed', { from: card.assignedTo, to: members });
    if (completed !== card.completed) logActivity('Completed changed', { from: card.completed, to: completed });
    if (JSON.stringify(labels) !== JSON.stringify(card.labels)) logActivity('Labels changed', {});
    if (JSON.stringify(checklists) !== JSON.stringify(card.checklist)) logActivity('Checklist changed', {});
    onUpdateCard(card.id, { title, description, color: cardColor, assignedTo: members, completed, activityLog, dueDate, labels, checklist: checklists });
    onClose();
  };

  // Helper: open @ menu at cursor
  const handleDescriptionKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === '@') {
      // Find cursor position for popover (approximate)
      const textarea = e.target as HTMLTextAreaElement;
      const rect = textarea.getBoundingClientRect();
      setMentionMenuPosition({ top: rect.top + 40, left: rect.left + 40 });
      setShowMentionMenu(true);
    }
  };

  // When mention type is selected
  const handleSelectMentionType = (type: 'prop' | 'container' | 'user') => {
    setMentionType(type);
    setShowMentionMenu(false);
    setShowMentionSearch(true);
    setMentionSearchText('');
    if (type === 'prop') setMentionSuggestions(propsList);
    else if (type === 'container') setMentionSuggestions(containersList);
    else setMentionSuggestions(usersList);
  };

  // When searching in mention popover
  const handleMentionSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value;
    setMentionSearchText(val);
    let data = [];
    if (mentionType === 'prop') data = propsList;
    else if (mentionType === 'container') data = containersList;
    else data = usersList;
    setMentionSuggestions(data.filter(item => item.name && item.name.toLowerCase().includes(val.toLowerCase())));
  };

  // When a mention is picked
  const handlePickMention = (item: any) => {
    // Insert mention at cursor (simple: append for now)
    let mentionText = '';
    if (mentionType === 'prop') mentionText = `[@${item.name}](prop:${item.id})`;
    else if (mentionType === 'container') mentionText = `[@${item.name}](container:${item.id})`;
    else mentionText = `@${item.name}`;
    setDescription(desc => desc + mentionText + ' ');
    setShowMentionSearch(false);
    setMentionType(null);
  };

  // Close all popovers
  const closeMentionMenus = () => {
    setShowMentionMenu(false);
    setShowMentionSearch(false);
    setMentionType(null);
  };

  // Combine comments and activity log for chronological display
  const combinedLog = [
    ...comments.map(c => ({
      type: 'comment',
      id: c.id,
      userId: c.userId,
      text: c.text,
      createdAt: c.createdAt,
    })),
    ...activityLog.map(a => ({
      type: 'activity',
      id: a.id,
      userId: a.userId,
      text: a.type,
      details: a.details,
      createdAt: a.timestamp,
    })),
  ].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());

  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div
        className="relative rounded-2xl shadow-2xl flex flex-row overflow-y-auto max-h-[98vh] min-h-[700px] border border-gray-300"
        style={{ background: cardColor, transition: 'background 0.3s' }}
      >
        {/* Close (X) button top right of modal */}
        <button className="absolute top-4 right-4 text-white text-2xl z-50" onClick={onClose} aria-label="Close">×</button>
        {/* Left column */}
        <div className="flex-1 min-w-[340px] max-w-[520px] p-10 flex flex-col gap-8 rounded-l-2xl overflow-y-auto" style={{ maxHeight: '90vh' }}>
          {/* Title */}
          <div className="flex items-center gap-3 mb-2">
            <input
              type="checkbox"
              checked={completed}
              onChange={() => setCompleted(c => !c)}
              className="w-5 h-5 accent-pb-success rounded"
              title="Mark card as completed"
            />
            <input
              className={`rounded-lg px-3 py-2 text-2xl font-bold bg-black/20 border border-white/20 shadow-sm focus:ring-2 focus:ring-pb-primary focus:outline-none placeholder:text-gray-200 text-white ${completed ? 'line-through opacity-60' : ''}`}
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Card title"
              style={{ boxShadow: 'none', border: 'none' }}
              disabled={completed}
            />
          </div>
          {/* Add bar */}
          <div className="flex gap-2 mb-2">
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowLabels(true)}>
              <span>🏷️</span> Labels
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowDates(true)}>
              <span>🕒</span> Dates
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowChecklist(true)}>
              <span>☑️</span> Checklist
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowMembers(true)}>
              <span>👤</span> Assign to
              {members.length > 0 && (
                <span className="ml-2 bg-pb-success text-white rounded-full px-2 py-1 text-xs font-bold">{usersList.find(u => u.id === members[0])?.name?.[0] || '?'}</span>
              )}
            </button>
            {/* Image upload icon */}
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowImageUpload(true)} title="Upload Images">
              <span role="img" aria-label="Upload">📷</span>
            </button>
          </div>
          {/* Image upload popup */}
          <Popover open={showImageUpload} onClose={() => setShowImageUpload(false)} title="Upload Images">
            <ImageUpload currentImages={images} onImagesChange={setImages} />
          </Popover>
          {/* Card color picker */}
            <div className="flex gap-2 items-center mt-2">
            <span className="text-gray-700 text-sm">Card color:</span>
            {["#27ae60", "#f1c40f", "#e67e22", "#e74c3c", "#8e44ad", "#2980b9", "#374151"].map(color => (
                <button
                  key={color}
                className="w-7 h-7 rounded-full border-2 border-white shadow hover:scale-110 transition"
                  style={{ background: color }}
                onClick={() => setCardColor(color)}
                  aria-label={`Set card color ${color}`}
                />
              ))}
          </div>
          {/* Description */}
          <div className="bg-black/20 rounded-lg p-2 shadow-inner">
            <label className="block font-semibold text-white mb-1">Description</label>
            <RichTextEditor
              value={description}
              onChange={setDescription}
              placeholder="Add a more detailed description..."
              minHeight={120}
              disabled={false}
            />
          </div>
          {/* Checklist */}
          <div>
            <div className="font-semibold text-gray-300 mb-2">Checklists</div>
            <div className="flex gap-2 mb-2">
              <input
                className="flex-1 rounded-lg border border-white/20 px-2 py-1 text-base bg-black/20 text-white placeholder:text-gray-200"
                value={newChecklistItem}
                onChange={e => setNewChecklistItem(e.target.value)}
                placeholder="Add checklist item..."
                onKeyDown={e => {
                  if (e.key === 'Enter' && newChecklistItem.trim()) {
                    setChecklists(list => [...list, { id: uuidv4(), text: newChecklistItem, checked: false }]);
                    setNewChecklistItem("");
                  }
                }}
              />
              <button className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded-lg shadow" disabled={!newChecklistItem.trim()} onClick={() => {
                if (newChecklistItem.trim()) {
                  setChecklists(list => [...list, { id: uuidv4(), text: newChecklistItem, checked: false }]);
                  setNewChecklistItem("");
                }
              }}>Add</button>
            </div>
            <div className="flex flex-col gap-2">
              {checklists.map((item, i) => (
                <label key={item.id || i} className="flex items-center gap-2 bg-black/20 border border-white/20 text-white rounded-lg px-3 py-2 text-base cursor-pointer shadow-sm">
                  <input
                    type="checkbox"
                    checked={!!item.checked}
                    onChange={() => {
                      setChecklists(list => list.map((c, idx) => idx === i ? { ...c, checked: !c.checked } : c));
                    }}
                  />
                  <span style={{ textDecoration: item.checked ? 'line-through' : 'none' }}>{item.text || item.id}</span>
                </label>
              ))}
            </div>
          </div>
          {/* Dates popover */}
          <Popover open={showDates} onClose={() => setShowDates(false)} title="Set Due Date & Time">
            <div className="flex flex-col gap-2">
              <label className="text-white text-sm">Due Date & Time</label>
              <input
                type="datetime-local"
                className="rounded border border-pb-primary/40 px-2 py-1 text-[#222]"
                value={dueDate ? dueDate.substring(0, 16) : ''}
                onChange={e => setDueDate(e.target.value)}
              />
              <button
                className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded mt-2"
                onClick={() => setShowDates(false)}
              >Set</button>
            </div>
          </Popover>
          {/* Show selected due date and time */}
          {dueDate && (
            <div className="text-xs text-pb-gray mt-1">Due: {new Date(dueDate).toLocaleString()}</div>
          )}
          {/* Labels popover */}
          <Popover open={showLabels} onClose={() => setShowLabels(false)} title="Manage Labels">
            <div className="flex flex-col gap-2">
              {/* Add new label */}
              <div className="flex gap-2 items-center mb-2">
                <input
                  className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-xs"
                  placeholder="Label title"
                  value={newLabelTitle || ''}
                  onChange={e => setNewLabelTitle(e.target.value)}
                />
                <button
                  className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-2 rounded text-xs"
                  disabled={!newLabelTitle}
                  onClick={() => {
                    setLabels(list => [...list, newLabelTitle]);
                    setNewLabelTitle('');
                  }}
                >Add</button>
              </div>
              {/* List and edit labels */}
              <div className="flex flex-col gap-2">
                {labels.map((label, i) => (
                  <div key={i} className="flex items-center gap-2">
                    <input
                      className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-xs"
                      value={label}
                      onChange={e => {
                        const v = e.target.value;
                        setLabels(list => list.map((l, idx) => idx === i ? v : l));
                      }}
                    />
                    <button
                      className="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-2 rounded text-xs"
                      onClick={() => setLabels(list => list.filter((_, idx) => idx !== i))}
                    >Remove</button>
                  </div>
                ))}
              </div>
            </div>
          </Popover>
          {/* Show current labels as pills */}
          {labels.length > 0 && (
            <div className="flex gap-2 flex-wrap mb-2">
              {labels.map((label, i) => (
                <span key={i} className="px-2 py-1 rounded text-xs font-semibold bg-pb-primary text-white">{label}</span>
              ))}
            </div>
          )}
        </div>
        {/* Right column: Comments and Activity */}
        <div className="w-[340px] flex flex-col p-8 gap-6 bg-pb-darker/90 rounded-r-2xl border-l border-gray-200">
          <div className="font-semibold text-white text-lg mb-2">Comments and activity</div>
          {/* Add comment area */}
          <div className="flex gap-2 items-center mb-4">
            <input
              className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-[#222]"
              value={newComment}
              onChange={e => setNewComment(e.target.value)}
              placeholder="Write a comment..."
              onKeyDown={e => {
                if (e.key === 'Enter' && newComment.trim()) {
                  setComments(c => [
                    ...c,
                    {
                      id: uuidv4(),
                      userId: user?.uid || 'anonymous',
                      text: newComment,
                      createdAt: new Date().toISOString(),
                    },
                  ]);
                  setNewComment("");
                }
              }}
            />
            <button
              className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded"
              disabled={!newComment.trim()}
              onClick={() => {
                if (newComment.trim()) {
                  setComments(c => [
                    ...c,
                    {
                      id: uuidv4(),
                      userId: user?.uid || 'anonymous',
                      text: newComment,
                      createdAt: new Date().toISOString(),
                    },
                  ]);
                  setNewComment("");
                }
              }}
            >Add</button>
          </div>
          {/* Comments list */}
          <div className="flex flex-col gap-2 mb-6">
            {combinedLog.map((item, i) => (
              <div key={item.id || i} className="flex items-start gap-2">
                <div className="w-8 h-8 rounded-full bg-pb-primary flex items-center justify-center text-white font-bold text-sm">{item.userId?.[0] || 'U'}</div>
                <div>
                  <div className="text-white font-semibold text-sm">{item.userId || 'User'}</div>
                  {item.type === 'comment' ? (
                    <div className="text-white text-xs opacity-70">{item.text}</div>
                  ) : (
                    <div className="text-pb-primary text-xs">{item.text}</div>
                  )}
                  <div className="text-pb-gray text-xs">{item.createdAt ? new Date(item.createdAt).toLocaleString() : ''}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
        {/* Modal footer: Save/Delete/Close */}
        <div className="absolute bottom-6 left-8 flex gap-2">
          <button className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded shadow" onClick={handleSave}>Save</button>
          <button className="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded shadow">Delete</button>
        </div>
      </div>
    </div>
  );
};

const Card: React.FC<CardProps> = ({ card, onUpdateCard, dndId }) => {
  const [modalOpen, setModalOpen] = useState(false);
  const handleOpen = (e: React.MouseEvent) => {
    e.preventDefault();
    setModalOpen(true);
  };
  // dnd-kit sortable for cards
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };
  return (
    <>
      <div
        ref={setNodeRef}
        style={{
          ...style, // dnd-kit drag styles
          background: card.color || '#374151',
          minHeight: 90,
        }}
        {...attributes}
        {...listeners}
        className="block rounded-lg p-3 shadow hover:shadow-lg transition cursor-pointer no-underline"
        onClick={handleOpen}
        tabIndex={0}
        role="button"
        onKeyPress={e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleOpen({ preventDefault: () => {} } as React.MouseEvent);
          }
        }}
      >
        <div className="font-semibold" style={{ color: '#fff' }}>{card.title}</div>
    {card.description && (
          <div className="text-xs mt-1" style={{ color: '#fff' }}>{renderDescriptionWithLinks(card.description)}</div>
    )}
      </div>
      <CardDetailModal open={modalOpen} onClose={() => setModalOpen(false)} card={card} onUpdateCard={onUpdateCard} />
    </>
);
};

export default Card; 
```

```typescriptreact
import React, { useEffect, useState, useRef } from "react";
import { useFirebase } from "../../contexts/FirebaseContext";
import ListColumn from "./ListColumn";
import type { BoardData, ListData, CardData } from "../../types/taskManager";
import { DndContext, closestCenter, PointerSensor, useSensor, useSensors, DragEndEvent, DragOverlay } from '@dnd-kit/core';
import { arrayMove, SortableContext, horizontalListSortingStrategy, verticalListSortingStrategy } from '@dnd-kit/sortable';

interface BoardProps {
  boardId: string;
  hideHeader?: boolean;
}

const Board: React.FC<BoardProps> = ({ boardId, hideHeader }) => {
  const { service } = useFirebase();
  const [board, setBoard] = useState<BoardData | null>(null);
  const [lists, setLists] = useState<ListData[]>([]);
  const [cards, setCards] = useState<Record<string, CardData[]>>({}); // listId -> cards
  const listsRowRef = useRef<HTMLDivElement>(null);
  const isDragging = useRef(false);
  const startX = useRef(0);
  const scrollLeft = useRef(0);
  const [activeDragId, setActiveDragId] = useState<string | null>(null);
  const [activeDragType, setActiveDragType] = useState<'list' | 'card' | null>(null);

  const sensors = useSensors(
    useSensor(PointerSensor, { activationConstraint: { distance: 5 } })
  );

  useEffect(() => {
    // Listen to board document
    const unsubBoard = service.listenToDocument<BoardData>(
      `todo_boards/${boardId}`,
      (doc) => setBoard(doc.data)
    );
    // Listen to lists
    const unsubLists = service.listenToCollection<ListData>(
      `todo_boards/${boardId}/lists`,
      (docs) => {
        const mappedLists = docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled List", cardIds: d.data.cardIds || [] }));
        console.log(`[Board] Lists for board ${boardId}:`, mappedLists);
        setLists(mappedLists);
      },
      (err) => console.error(err)
    );
    // Listen to cards for each list
    let unsubCards: (() => void)[] = [];
    if (lists.length) {
      unsubCards.forEach(unsub => unsub());
      unsubCards = lists.map(list =>
        service.listenToCollection<CardData>(
          `todo_boards/${boardId}/lists/${list.id}/cards`,
           (docs) => setCards(prev => ({ ...prev, [list.id]: docs.map(d => ({ ...d.data, id: d.id, title: d.data.title || d.data.name || "Untitled Card" })) })),
          (err) => console.error(err)
        )
      );
    }
    return () => {
      unsubBoard();
      unsubLists();
      unsubCards.forEach(unsub => unsub());
    };
  }, [boardId, lists.length]);

  // Drag-to-scroll handlers
  useEffect(() => {
    const row = listsRowRef.current;
    if (!row) return;
    const onMouseDown = (e: MouseEvent) => {
      isDragging.current = true;
      startX.current = e.pageX - row.offsetLeft;
      scrollLeft.current = row.scrollLeft;
      row.classList.add('cursor-grabbing');
    };
    const onMouseLeave = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseUp = () => {
      isDragging.current = false;
      row.classList.remove('cursor-grabbing');
    };
    const onMouseMove = (e: MouseEvent) => {
      if (!isDragging.current) return;
      e.preventDefault();
      const x = e.pageX - row.offsetLeft;
      const walk = (x - startX.current) * 1.5; // scroll speed
      row.scrollLeft = scrollLeft.current - walk;
    };
    row.addEventListener('mousedown', onMouseDown);
    row.addEventListener('mouseleave', onMouseLeave);
    row.addEventListener('mouseup', onMouseUp);
    row.addEventListener('mousemove', onMouseMove);
    // Touch events for mobile
    let touchStartX = 0;
    let touchScrollLeft = 0;
    const onTouchStart = (e: TouchEvent) => {
      isDragging.current = true;
      touchStartX = e.touches[0].pageX - row.offsetLeft;
      touchScrollLeft = row.scrollLeft;
    };
    const onTouchEnd = () => {
      isDragging.current = false;
    };
    const onTouchMove = (e: TouchEvent) => {
      if (!isDragging.current) return;
      const x = e.touches[0].pageX - row.offsetLeft;
      const walk = (x - touchStartX) * 1.5;
      row.scrollLeft = touchScrollLeft - walk;
    };
    row.addEventListener('touchstart', onTouchStart);
    row.addEventListener('touchend', onTouchEnd);
    row.addEventListener('touchmove', onTouchMove);
    return () => {
      row.removeEventListener('mousedown', onMouseDown);
      row.removeEventListener('mouseleave', onMouseLeave);
      row.removeEventListener('mouseup', onMouseUp);
      row.removeEventListener('mousemove', onMouseMove);
      row.removeEventListener('touchstart', onTouchStart);
      row.removeEventListener('touchend', onTouchEnd);
      row.removeEventListener('touchmove', onTouchMove);
    };
  }, [lists]);

  // Add card handler
  const addCard = async (listId: string, title: string) => {
    if (!title.trim()) return;
    const order = (cards[listId]?.length || 0);
    const newCard = {
      title: title.trim(),
      description: '',
      createdAt: new Date().toISOString(),
      order,
      // Add more fields as needed
    };
    await service.addDocument(`todo_boards/${boardId}/lists/${listId}/cards`, newCard);
    // The listener will update state
  };

  // Update card handler
  const updateCard = async (cardId: string, updates: Partial<CardData>) => {
    // Find the list containing this card
    const listId = Object.keys(cards).find(lid => cards[lid].some(card => card.id === cardId));
    if (!listId) return;
    await service.updateDocument(`todo_boards/${boardId}/lists/${listId}/cards`, cardId, updates);
  };

  const handleListDragEnd = async (event: DragEndEvent) => {
    if (!board) return;
    const { active, over } = event;
    if (!over || !active) return;
    if (!Array.isArray(board.listIds)) return;
    const activeId = String(active.id).replace(/^list-/, '');
    const overId = String(over.id).replace(/^list-/, '');
    const oldIndex = board.listIds.indexOf(activeId);
    const newIndex = board.listIds.indexOf(overId);
    if (oldIndex === -1 || newIndex === -1) return;
    if (oldIndex !== newIndex) {
      const newListIds = arrayMove(board.listIds, oldIndex, newIndex);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  // --- NEW: Card drag handler for cross-list movement ---
  const handleCardDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    if (!over || !active) return;
    const activeCardId = String(active.id).replace(/^card-/, '');
    let sourceListId: string | undefined;
    let destListId: string | undefined;
    for (const list of lists) {
      const idx = (cards[list.id] || []).findIndex(card => card.id === activeCardId);
      if (idx !== -1) {
        sourceListId = list.id;
        break;
      }
    }
    for (const list of lists) {
      if (over.data?.current?.sortable?.containerId === `list-${list.id}` || over.id === `list-${list.id}`) {
        destListId = list.id;
        break;
      }
      if ((cards[list.id] || []).some(card => `card-${card.id}` === over.id)) {
        destListId = list.id;
        break;
      }
    }
    if (!sourceListId || !destListId) return;
    if (sourceListId === destListId) {
      const cardList = cards[sourceListId] || [];
      const oldIdx = cardList.findIndex(card => card.id === activeCardId);
      const newIdx = cardList.findIndex(card => `card-${card.id}` === over.id);
      if (oldIdx === -1 || newIdx === -1 || oldIdx === newIdx) return;
      const newCards = arrayMove(cardList, oldIdx, newIdx);
      for (let i = 0; i < newCards.length; i++) {
        await service.updateDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, newCards[i].id, { order: i });
      }
      return;
    }
    const sourceCards = [...(cards[sourceListId] || [])];
    const destCards = [...(cards[destListId] || [])];
    const movingCardIdx = sourceCards.findIndex(card => card.id === activeCardId);
    if (movingCardIdx === -1) return;
    const [movingCard] = sourceCards.splice(movingCardIdx, 1);
    let insertIdx = destCards.findIndex(card => `card-${card.id}` === over.id);
    if (insertIdx === -1) insertIdx = destCards.length;
    destCards.splice(insertIdx, 0, movingCard);
    await service.deleteDocument(`todo_boards/${boardId}/lists/${sourceListId}/cards`, movingCard.id);
    await service.addDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, { ...movingCard, order: insertIdx });
    for (let i = 0; i < destCards.length; i++) {
      await service.updateDocument(`todo_boards/${boardId}/lists/${destListId}/cards`, destCards[i].id, { order: i });
    }
  };

  // Add deleteList handler
  const deleteList = async (listId: string) => {
    // Remove list document
    await service.deleteDocument(`todo_boards/${boardId}/lists`, listId);
    // Remove from board.listIds
    if (board && Array.isArray(board.listIds)) {
      const newListIds = board.listIds.filter(id => id !== listId);
      setBoard({ ...board, listIds: newListIds });
      await service.updateDocument(`todo_boards`, boardId, { listIds: newListIds });
    }
  };

  // Add list handler (FAB)
  const addList = async () => {
    try {
      const payload = {
        title: 'New List',
        cardIds: [],
        createdAt: new Date().toISOString(),
      } as Partial<ListData> & { createdAt: string };
      const newListId = await (service as any).addDocument(`todo_boards/${boardId}/lists`, payload);
      // If we received the new id, append to board.listIds for ordering
      if (newListId && board && Array.isArray(board.listIds)) {
        const updated = [...board.listIds, newListId as string];
        setBoard({ ...board, listIds: updated });
        await service.updateDocument('todo_boards', boardId, { listIds: updated });
      }
    } catch (err) {
      // eslint-disable-next-line no-console
      console.error('Failed to add list', err);
    }
  };

  if (!board) return <div>Loading board...</div>;

  // Deduplicate lists by name (case-insensitive)
  const uniqueLists = lists.filter(
    (list, index, self) =>
      list.title &&
      self.findIndex(l => l.title?.toLowerCase() === list.title?.toLowerCase()) === index
  );

  // If listIds is missing or not an array, just show all unique lists
  if (!Array.isArray(board.listIds) || board.listIds.length === 0) {
    if (uniqueLists.length === 0) return <div>No lists found for this board.</div>;
    return (
      <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 overflow-x-hidden">
        <div className="flex-1 flex flex-col min-h-0">
          {/* Board Title as sticky header */}
          {!hideHeader && (
            <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
              <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
            </div>
          )}
          {/* Lists Row Scrollable Area */}
          <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-auto">
            <DndContext
              sensors={sensors}
              collisionDetection={closestCenter}
              onDragStart={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) setActiveDragType('list');
                else if (id.startsWith('card-')) setActiveDragType('card');
                else setActiveDragType(null);
                setActiveDragId(id);
              }}
              onDragEnd={event => {
                const id = String(event.active.id);
                if (id.startsWith('list-')) handleListDragEnd(event);
                else if (id.startsWith('card-')) handleCardDragEnd(event);
                setActiveDragId(null);
                setActiveDragType(null);
              }}
              onDragCancel={() => {
                setActiveDragId(null);
                setActiveDragType(null);
              }}
            >
              <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
            <div
              ref={listsRowRef}
              className="flex items-start gap-6 h-full cursor-grab w-max pr-10"
              style={{ WebkitOverflowScrolling: 'touch' }}
            >
                  {Array.isArray(board.listIds) && board.listIds.length > 0
                    ? board.listIds.map(listId => {
                        const list = lists.find(l => l.id === listId);
                        if (!list) return null;
                        return (
                          <ListColumn
                            key={list.id}
                            list={list}
                            cards={cards[list.id] || []}
                            boardId={boardId}
                            onAddCard={addCard}
                            onUpdateCard={updateCard}
                            dndId={`list-${list.id}`}
                            onDeleteList={deleteList}
                            cardIdPrefix="card-"
                          />
                        );
                      })
                    : uniqueLists.map(list => (
                <ListColumn
                  key={list.id}
                  list={list}
                  cards={cards[list.id] || []}
                  boardId={boardId}
                  onAddCard={addCard}
                  onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                />
              ))}
              {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
            </div>
              </SortableContext>
              <DragOverlay>
                {activeDragType === 'card' && activeDragId ? (() => {
                  // Find the card data
                  let card: CardData | undefined;
                  for (const list of lists) {
                    card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                    if (card) break;
                  }
                  return card ? (
                    <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                      <div className="font-semibold">{card.title}</div>
                      {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                    </div>
                  ) : null;
                })() : null}
                {activeDragType === 'list' && activeDragId ? (() => {
                  // Find the list data
                  const list = lists.find(l => `list-${l.id}` === activeDragId);
                  return list ? (
                    <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                      <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                    </div>
                  ) : null;
                })() : null}
              </DragOverlay>
            </DndContext>
          </div>
        </div>
        {/* FAB to add a list */}
        <button
          onClick={addList}
          className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50"
          aria-label="Add list"
          title="Add list"
        >
          +
        </button>
      </div>
    );
  }

  return (
    <div className="relative w-full min-h-screen flex flex-col bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 overflow-x-hidden">
      <div className="flex-1 flex flex-col min-h-0">
        {/* Board Title as sticky header */}
        {!hideHeader && (
          <div className="sticky top-0 z-10 bg-gradient-to-br from-pb-darker/80 to-pb-primary/30 py-4">
            <span className="text-2xl font-bold text-white pl-6">{board.title || board.name || "Board"}</span>
          </div>
        )}
        {/* Lists Row Scrollable Area */}
        <div className="flex-1 min-h-0 w-full overflow-x-auto overflow-y-auto">
          <DndContext
            sensors={sensors}
            collisionDetection={closestCenter}
            onDragStart={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) setActiveDragType('list');
              else if (id.startsWith('card-')) setActiveDragType('card');
              else setActiveDragType(null);
              setActiveDragId(id);
            }}
            onDragEnd={event => {
              const id = String(event.active.id);
              if (id.startsWith('list-')) handleListDragEnd(event);
              else if (id.startsWith('card-')) handleCardDragEnd(event);
              setActiveDragId(null);
              setActiveDragType(null);
            }}
            onDragCancel={() => {
              setActiveDragId(null);
              setActiveDragType(null);
            }}
          >
            <SortableContext items={Array.isArray(board.listIds) ? board.listIds.map(id => `list-${id}`) : []} strategy={horizontalListSortingStrategy}>
          <div
            ref={listsRowRef}
            className="flex items-start gap-6 h-full cursor-grab w-max pr-10"
            style={{ WebkitOverflowScrolling: 'touch' }}
          >
            {Array.isArray(board.listIds) && board.listIds.length > 0
              ? board.listIds.map(listId => {
                  const list = lists.find(l => l.id === listId);
                  if (!list) return null;
                  return (
                    <ListColumn
                      key={list.id}
                      list={list}
                      cards={cards[list.id] || []}
                      boardId={boardId}
                      onAddCard={addCard}
                      onUpdateCard={updateCard}
                          dndId={`list-${list.id}`}
                          onDeleteList={deleteList}
                          cardIdPrefix="card-"
                    />
                  );
                })
              : uniqueLists.map(list => (
                  <ListColumn
                    key={list.id}
                    list={list}
                    cards={cards[list.id] || []}
                    boardId={boardId}
                    onAddCard={addCard}
                    onUpdateCard={updateCard}
                        dndId={`list-${list.id}`}
                        onDeleteList={deleteList}
                        cardIdPrefix="card-"
                  />
                ))}
            {/* Add List button at the end of the lists (hidden, replaced by FAB) */}
          </div>
            </SortableContext>
            <DragOverlay>
              {activeDragType === 'card' && activeDragId ? (() => {
                // Find the card data
                let card: CardData | undefined;
                for (const list of lists) {
                  card = (cards[list.id] || []).find(c => `card-${c.id}` === activeDragId);
                  if (card) break;
                }
                return card ? (
                  <div className="block rounded-lg p-3 shadow-lg bg-pb-darker text-white min-w-[16rem] min-h-[4rem]">
                    <div className="font-semibold">{card.title}</div>
                    {card.description && <div className="text-xs opacity-70 mt-1">{card.description}</div>}
                  </div>
                ) : null;
              })() : null}
              {activeDragType === 'list' && activeDragId ? (() => {
                // Find the list data
                const list = lists.find(l => `list-${l.id}` === activeDragId);
                return list ? (
                  <div className="bg-pb-darker rounded-xl p-4 min-w-[20rem] w-80 shadow-lg border border-pb-primary/30">
                    <div className="text-lg font-bold text-white tracking-wide text-left">{list.title}</div>
                  </div>
                ) : null;
              })() : null}
            </DragOverlay>
          </DndContext>
        </div>
      </div>
      {/* FAB to add a list */}
      <button
        onClick={addList}
        className="fixed bottom-10 right-10 bg-pb-primary hover:bg-pb-success text-white rounded-full w-16 h-16 flex items-center justify-center shadow-lg text-3xl z-50"
        aria-label="Add list"
        title="Add list"
      >
        +
      </button>
    </div>
  );
};

export default Board; 
```

- Ensured card color persists and shows in the list:
  - Added `color?: string` to `CardData` type.
  - The card detail modal already saves `color` via `onUpdateCard`; the list card uses `card.color` for its background.
  - Card fetch mapping preserves all fields, including `color`, so the saved color will render on the kanban card.

If you change a card’s color and it still doesn’t update visually, it’s likely a Firestore write path mismatch. Tell me if you see any console warnings during save, and I’ll wire it to your service shape.

---

**User**

ok all the colours work but the last colour is the same as the dark grey text onthe card

---

**Cursor**

```typescriptreact
import React, { useState, useEffect } from "react";
import type { CardData } from "../../types/taskManager";
import { ImageUpload } from "../ImageUpload";
import type { PropImage } from "../../types/props";
import { useFirebase } from "../../contexts/FirebaseContext";
import { v4 as uuidv4 } from 'uuid';
import { RichTextEditor } from "../../../shared/components/RichTextEditor";
import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface CardProps {
  card: CardData;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
}

// Popover/modal scaffold for feature dialogs
const Popover: React.FC<{ open: boolean; onClose: () => void; title: string; children: React.ReactNode }> = ({ open, onClose, title, children }) => {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div className="bg-pb-darker rounded-xl p-6 w-full max-w-sm shadow-xl flex flex-col gap-3 relative">
        <button className="absolute top-2 right-2 text-white text-xl" onClick={onClose} aria-label="Close">×</button>
        <div className="text-base font-bold text-white mb-2">{title}</div>
        {children}
      </div>
    </div>
  );
};

// Helper: render description with @-mention links
function renderDescriptionWithLinks(description: string) {
  if (!description) return null;
  // Regex for [@Name](prop:prop1) and similar, and for @@User
  const mentionRegex = /\[@([^\]]+)\]\((prop|container|user):([^\)]+)\)|@@([a-zA-Z0-9_]+)/g;
  const parts = [];
  let lastIndex = 0;
  let match;
  while ((match = mentionRegex.exec(description)) !== null) {
    if (match.index > lastIndex) {
      parts.push(description.slice(lastIndex, match.index));
    }
    if (match[1] && match[2] && match[3]) {
      // Markdown-style mention
      const [, name, type, id] = match;
      let href = '#';
      let color = '#3B82F6';
      let label = name;
      if (type === 'prop') {
        href = `/props/${id}`;
        color = '#3B82F6';
      } else if (type === 'container') {
        href = `/containers/${id}`;
        color = '#A855F7';
      } else if (type === 'user') {
        href = `/users/${id}`;
        color = '#22C55E';
        label = '@' + name;
      }
      parts.push(
        <a
          key={match.index}
          href={href}
          className="underline hover:text-pb-success"
          style={{ color, fontWeight: 600, marginRight: 2 }}
          target="_blank"
          rel="noopener noreferrer"
        >
          {label}
        </a>
      );
    } else if (match[4]) {
      // @@User mention
      const user = match[4];
      const href = `/users/${user}`;
      const color = '#22C55E';
      parts.push(
        <a
          key={match.index}
          href={href}
          className="underline hover:text-pb-success"
          style={{ color, fontWeight: 600, marginRight: 2 }}
          target="_blank"
          rel="noopener noreferrer"
        >
          @{user}
        </a>
      );
    }
    lastIndex = match.index + match[0].length;
  }
  if (lastIndex < description.length) {
    parts.push(description.slice(lastIndex));
  }
  return parts;
}

const CardDetailModal: React.FC<{
  open: boolean;
  onClose: () => void;
  card: CardData;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
}> = ({ open, onClose, card, onUpdateCard }) => {
  const [title, setTitle] = useState(card.title);
  const { service: firebaseService, user } = useFirebase();
  const [propsList, setPropsList] = useState<{ id: string; name: string }[]>([]);
  const [containersList, setContainersList] = useState<{ id: string; name: string }[]>([]);
  const [usersList, setUsersList] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    firebaseService.getDocuments("props").then(docs => setPropsList(docs.map(d => ({ id: d.id, name: d.data.name }))));
    firebaseService.getDocuments("containers").then(docs => setContainersList(docs.map(d => ({ id: d.id, name: d.data.name }))));
    firebaseService.getDocuments("users").then(docs => setUsersList(docs.map(d => ({ id: d.id, name: d.data.displayName || d.data.name || d.data.email }))));
  }, [firebaseService]);

  const [description, setDescription] = useState(card.description || "");
  const [labels, setLabels] = useState<string[]>(card.labels || []);
  const [members, setMembers] = useState(card.assignedTo || []);
  const [dueDate, setDueDate] = useState(card.dueDate || "");
  const [attachments, setAttachments] = useState(card.attachments || []);
  const [checklists, setChecklists] = useState(card.checklist || []);
  const [comments, setComments] = useState(card.comments || []);
  const [activityLog, setActivityLog] = useState(card.activityLog || []);
  const [images, setImages] = useState<PropImage[]>(card.images || []);

  // Popover state
  const [showLabels, setShowLabels] = useState(false);
  const [showDates, setShowDates] = useState(false);
  const [showChecklist, setShowChecklist] = useState(false);
  const [showMembers, setShowMembers] = useState(false);
  const [showAdd, setShowAdd] = useState(false);

  // @ context menu state
  const [showMentionMenu, setShowMentionMenu] = useState(false);
  const [mentionMenuPosition, setMentionMenuPosition] = useState({ top: 0, left: 0 });
  const [mentionType, setMentionType] = useState<'prop' | 'container' | 'user' | null>(null);
  const [showMentionSearch, setShowMentionSearch] = useState(false);
  const [mentionSearchText, setMentionSearchText] = useState('');
  const [mentionSuggestions, setMentionSuggestions] = useState<any[]>([]);

  const [newComment, setNewComment] = useState("");

  // 1. Add state for image upload popup and checklist add UI
  const [showImageUpload, setShowImageUpload] = useState(false);
  const [newChecklistItem, setNewChecklistItem] = useState("");

  // Add state for new label
  const [newLabelTitle, setNewLabelTitle] = useState('');

  // Add state for card color
  const [cardColor, setCardColor] = useState(card.color || '#374151');

  // Add completed state
  const [completed, setCompleted] = useState(card.completed || false);

  // Helper to log activity
  function logActivity(type: string, details: any) {
    setActivityLog(log => [
      ...log,
      {
        id: uuidv4(),
        type,
        userId: user?.uid || 'anonymous',
        timestamp: new Date().toISOString(),
        details,
      },
    ]);
  }

  // On save, compare previous and new values, log changes
  const handleSave = () => {
    if (title !== card.title) logActivity('Title changed', { from: card.title, to: title });
    if (description !== card.description) logActivity('Description changed', {});
    if (dueDate !== card.dueDate) logActivity('Due date changed', { from: card.dueDate, to: dueDate });
    if (cardColor !== card.color) logActivity('Color changed', { from: card.color, to: cardColor });
    if (JSON.stringify(members) !== JSON.stringify(card.assignedTo)) logActivity('Assignee changed', { from: card.assignedTo, to: members });
    if (completed !== card.completed) logActivity('Completed changed', { from: card.completed, to: completed });
    if (JSON.stringify(labels) !== JSON.stringify(card.labels)) logActivity('Labels changed', {});
    if (JSON.stringify(checklists) !== JSON.stringify(card.checklist)) logActivity('Checklist changed', {});
    onUpdateCard(card.id, { title, description, color: cardColor, assignedTo: members, completed, activityLog, dueDate, labels, checklist: checklists });
    onClose();
  };

  // Helper: open @ menu at cursor
  const handleDescriptionKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === '@') {
      // Find cursor position for popover (approximate)
      const textarea = e.target as HTMLTextAreaElement;
      const rect = textarea.getBoundingClientRect();
      setMentionMenuPosition({ top: rect.top + 40, left: rect.left + 40 });
      setShowMentionMenu(true);
    }
  };

  // When mention type is selected
  const handleSelectMentionType = (type: 'prop' | 'container' | 'user') => {
    setMentionType(type);
    setShowMentionMenu(false);
    setShowMentionSearch(true);
    setMentionSearchText('');
    if (type === 'prop') setMentionSuggestions(propsList);
    else if (type === 'container') setMentionSuggestions(containersList);
    else setMentionSuggestions(usersList);
  };

  // When searching in mention popover
  const handleMentionSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value;
    setMentionSearchText(val);
    let data = [];
    if (mentionType === 'prop') data = propsList;
    else if (mentionType === 'container') data = containersList;
    else data = usersList;
    setMentionSuggestions(data.filter(item => item.name && item.name.toLowerCase().includes(val.toLowerCase())));
  };

  // When a mention is picked
  const handlePickMention = (item: any) => {
    // Insert mention at cursor (simple: append for now)
    let mentionText = '';
    if (mentionType === 'prop') mentionText = `[@${item.name}](prop:${item.id})`;
    else if (mentionType === 'container') mentionText = `[@${item.name}](container:${item.id})`;
    else mentionText = `@${item.name}`;
    setDescription(desc => desc + mentionText + ' ');
    setShowMentionSearch(false);
    setMentionType(null);
  };

  // Close all popovers
  const closeMentionMenus = () => {
    setShowMentionMenu(false);
    setShowMentionSearch(false);
    setMentionType(null);
  };

  // Combine comments and activity log for chronological display
  const combinedLog = [
    ...comments.map(c => ({
      type: 'comment',
      id: c.id,
      userId: c.userId,
      text: c.text,
      createdAt: c.createdAt,
    })),
    ...activityLog.map(a => ({
      type: 'activity',
      id: a.id,
      userId: a.userId,
      text: a.type,
      details: a.details,
      createdAt: a.timestamp,
    })),
  ].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());

  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div
        className="relative rounded-2xl shadow-2xl flex flex-row overflow-y-auto max-h-[98vh] min-h-[700px] border border-gray-300"
        style={{ background: cardColor, transition: 'background 0.3s' }}
      >
        {/* Close (X) button top right of modal */}
        <button className="absolute top-4 right-4 text-white text-2xl z-50" onClick={onClose} aria-label="Close">×</button>
        {/* Left column */}
        <div className="flex-1 min-w-[340px] max-w-[520px] p-10 flex flex-col gap-8 rounded-l-2xl overflow-y-auto" style={{ maxHeight: '90vh' }}>
          {/* Title */}
          <div className="flex items-center gap-3 mb-2">
            <input
              type="checkbox"
              checked={completed}
              onChange={() => setCompleted(c => !c)}
              className="w-5 h-5 accent-pb-success rounded"
              title="Mark card as completed"
            />
            <input
              className={`rounded-lg px-3 py-2 text-2xl font-bold bg-black/20 border border-white/20 shadow-sm focus:ring-2 focus:ring-pb-primary focus:outline-none placeholder:text-gray-200 text-white ${completed ? 'line-through opacity-60' : ''}`}
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Card title"
              style={{ boxShadow: 'none', border: 'none' }}
              disabled={completed}
            />
          </div>
          {/* Add bar */}
          <div className="flex gap-2 mb-2">
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowLabels(true)}>
              <span>🏷️</span> Labels
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowDates(true)}>
              <span>🕒</span> Dates
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowChecklist(true)}>
              <span>☑️</span> Checklist
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowMembers(true)}>
              <span>👤</span> Assign to
              {members.length > 0 && (
                <span className="ml-2 bg-pb-success text-white rounded-full px-2 py-1 text-xs font-bold">{usersList.find(u => u.id === members[0])?.name?.[0] || '?'}</span>
              )}
            </button>
            {/* Image upload icon */}
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowImageUpload(true)} title="Upload Images">
              <span role="img" aria-label="Upload">📷</span>
            </button>
          </div>
          {/* Image upload popup */}
          <Popover open={showImageUpload} onClose={() => setShowImageUpload(false)} title="Upload Images">
            <ImageUpload currentImages={images} onImagesChange={setImages} />
          </Popover>
          {/* Card color picker */}
            <div className="flex gap-2 items-center mt-2">
            <span className="text-gray-200 text-sm">Card color:</span>
            {["#27ae60", "#f1c40f", "#e67e22", "#e74c3c", "#8e44ad", "#2980b9", "#374151"].map(color => (
                <button
                  key={color}
                className="w-7 h-7 rounded-full border-2 border-white shadow hover:scale-110 transition"
                  style={{ background: color }}
                onClick={() => setCardColor(color)}
                  aria-label={`Set card color ${color}`}
                />
              ))}
          </div>
          {/* Description */}
          <div className="bg-black/20 rounded-lg p-2 shadow-inner">
            <label className="block font-semibold text-white mb-1">Description</label>
            <RichTextEditor
              value={description}
              onChange={setDescription}
              placeholder="Add a more detailed description..."
              minHeight={120}
              disabled={false}
            />
          </div>
          {/* Checklist */}
          <div>
            <div className="font-semibold text-gray-300 mb-2">Checklists</div>
            <div className="flex gap-2 mb-2">
              <input
                className="flex-1 rounded-lg border border-white/20 px-2 py-1 text-base bg-black/20 text-white placeholder:text-gray-200"
                value={newChecklistItem}
                onChange={e => setNewChecklistItem(e.target.value)}
                placeholder="Add checklist item..."
                onKeyDown={e => {
                  if (e.key === 'Enter' && newChecklistItem.trim()) {
                    setChecklists(list => [...list, { id: uuidv4(), text: newChecklistItem, checked: false }]);
                    setNewChecklistItem("");
                  }
                }}
              />
              <button className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded-lg shadow" disabled={!newChecklistItem.trim()} onClick={() => {
                if (newChecklistItem.trim()) {
                  setChecklists(list => [...list, { id: uuidv4(), text: newChecklistItem, checked: false }]);
                  setNewChecklistItem("");
                }
              }}>Add</button>
            </div>
            <div className="flex flex-col gap-2">
              {checklists.map((item, i) => (
                <label key={item.id || i} className="flex items-center gap-2 bg-black/20 border border-white/20 text-white rounded-lg px-3 py-2 text-base cursor-pointer shadow-sm">
                  <input
                    type="checkbox"
                    checked={!!item.checked}
                    onChange={() => {
                      setChecklists(list => list.map((c, idx) => idx === i ? { ...c, checked: !c.checked } : c));
                    }}
                  />
                  <span style={{ textDecoration: item.checked ? 'line-through' : 'none' }}>{item.text || item.id}</span>
                </label>
              ))}
            </div>
          </div>
          {/* Dates popover */}
          <Popover open={showDates} onClose={() => setShowDates(false)} title="Set Due Date & Time">
            <div className="flex flex-col gap-2">
              <label className="text-white text-sm">Due Date & Time</label>
              <input
                type="datetime-local"
                className="rounded border border-pb-primary/40 px-2 py-1 text-[#222]"
                value={dueDate ? dueDate.substring(0, 16) : ''}
                onChange={e => setDueDate(e.target.value)}
              />
              <button
                className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded mt-2"
                onClick={() => setShowDates(false)}
              >Set</button>
            </div>
          </Popover>
          {/* Show selected due date and time */}
          {dueDate && (
            <div className="text-xs text-pb-gray mt-1">Due: {new Date(dueDate).toLocaleString()}</div>
          )}
          {/* Labels popover */}
          <Popover open={showLabels} onClose={() => setShowLabels(false)} title="Manage Labels">
            <div className="flex flex-col gap-2">
              {/* Add new label */}
              <div className="flex gap-2 items-center mb-2">
                <input
                  className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-xs"
                  placeholder="Label title"
                  value={newLabelTitle || ''}
                  onChange={e => setNewLabelTitle(e.target.value)}
                />
                <button
                  className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-2 rounded text-xs"
                  disabled={!newLabelTitle}
                  onClick={() => {
                    setLabels(list => [...list, newLabelTitle]);
                    setNewLabelTitle('');
                  }}
                >Add</button>
              </div>
              {/* List and edit labels */}
              <div className="flex flex-col gap-2">
                {labels.map((label, i) => (
                  <div key={i} className="flex items-center gap-2">
                    <input
                      className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-xs"
                      value={label}
                      onChange={e => {
                        const v = e.target.value;
                        setLabels(list => list.map((l, idx) => idx === i ? v : l));
                      }}
                    />
                    <button
                      className="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-2 rounded text-xs"
                      onClick={() => setLabels(list => list.filter((_, idx) => idx !== i))}
                    >Remove</button>
                  </div>
                ))}
              </div>
            </div>
          </Popover>
          {/* Show current labels as pills */}
          {labels.length > 0 && (
            <div className="flex gap-2 flex-wrap mb-2">
              {labels.map((label, i) => (
                <span key={i} className="px-2 py-1 rounded text-xs font-semibold bg-pb-primary text-white">{label}</span>
              ))}
            </div>
          )}
        </div>
        {/* Right column: Comments and Activity */}
        <div className="w-[340px] flex flex-col p-8 gap-6 bg-pb-darker/90 rounded-r-2xl border-l border-gray-200">
          <div className="font-semibold text-white text-lg mb-2">Comments and activity</div>
          {/* Add comment area */}
          <div className="flex gap-2 items-center mb-4">
            <input
              className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-[#222]"
              value={newComment}
              onChange={e => setNewComment(e.target.value)}
              placeholder="Write a comment..."
              onKeyDown={e => {
                if (e.key === 'Enter' && newComment.trim()) {
                  setComments(c => [
                    ...c,
                    {
                      id: uuidv4(),
                      userId: user?.uid || 'anonymous',
                      text: newComment,
                      createdAt: new Date().toISOString(),
                    },
                  ]);
                  setNewComment("");
                }
              }}
            />
            <button
              className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded"
              disabled={!newComment.trim()}
              onClick={() => {
                if (newComment.trim()) {
                  setComments(c => [
                    ...c,
                    {
                      id: uuidv4(),
                      userId: user?.uid || 'anonymous',
                      text: newComment,
                      createdAt: new Date().toISOString(),
                    },
                  ]);
                  setNewComment("");
                }
              }}
            >Add</button>
          </div>
          {/* Comments list */}
          <div className="flex flex-col gap-2 mb-6">
            {combinedLog.map((item, i) => (
              <div key={item.id || i} className="flex items-start gap-2">
                <div className="w-8 h-8 rounded-full bg-pb-primary flex items-center justify-center text-white font-bold text-sm">{item.userId?.[0] || 'U'}</div>
                <div>
                  <div className="text-white font-semibold text-sm">{item.userId || 'User'}</div>
                  {item.type === 'comment' ? (
                    <div className="text-white text-xs opacity-70">{item.text}</div>
                  ) : (
                    <div className="text-pb-primary text-xs">{item.text}</div>
                  )}
                  <div className="text-pb-gray text-xs">{item.createdAt ? new Date(item.createdAt).toLocaleString() : ''}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
        {/* Modal footer: Save/Delete/Close */}
        <div className="absolute bottom-6 left-8 flex gap-2">
          <button className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded shadow" onClick={handleSave}>Save</button>
          <button className="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded shadow">Delete</button>
        </div>
      </div>
    </div>
  );
};

const Card: React.FC<CardProps> = ({ card, onUpdateCard, dndId }) => {
  const [modalOpen, setModalOpen] = useState(false);
  const handleOpen = (e: React.MouseEvent) => {
    e.preventDefault();
    setModalOpen(true);
  };
  // dnd-kit sortable for cards
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };
  return (
    <>
      <div
        ref={setNodeRef}
        style={{
          ...style, // dnd-kit drag styles
          background: card.color || '#374151',
          minHeight: 90,
        }}
        {...attributes}
        {...listeners}
        className="block rounded-lg p-3 shadow hover:shadow-lg transition cursor-pointer no-underline"
        onClick={handleOpen}
        tabIndex={0}
        role="button"
        onKeyPress={e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleOpen({ preventDefault: () => {} } as React.MouseEvent);
          }
        }}
      >
        <div className="font-semibold" style={{ color: '#fff' }}>{card.title}</div>
    {card.description && (
          <div className="text-xs mt-1" style={{ color: '#fff' }}>{renderDescriptionWithLinks(card.description)}</div>
    )}
      </div>
      <CardDetailModal open={modalOpen} onClose={() => setModalOpen(false)} card={card} onUpdateCard={onUpdateCard} />
    </>
);
};

export default Card; 
```

```typescriptreact
*** Begin Patch
*** Update File: web-app/src/components/TaskBoard/Card.tsx
@@
-      <div
+      <div
         ref={setNodeRef}
         style={{
           ...style, // dnd-kit drag styles
-          background: card.color || '#374151',
+          background: card.color || '#374151',
           minHeight: 90,
         }}
         {...attributes}
         {...listeners}
-        className="block rounded-lg p-3 shadow hover:shadow-lg transition cursor-pointer no-underline"
+        className={`block rounded-lg p-3 shadow hover:shadow-lg transition cursor-pointer no-underline ${card.color === '#374151' ? 'border border-white/10' : ''}`}
       >
-        <div className="font-semibold" style={{ color: '#fff' }}>{card.title}</div>
+        <div className="font-semibold" style={{ color: '#fff' }}>{card.title}</div>
*** End Patch
```

```typescriptreact
import React, { useState, useEffect } from "react";
import type { CardData } from "../../types/taskManager";
import { ImageUpload } from "../ImageUpload";
import type { PropImage } from "../../types/props";
import { useFirebase } from "../../contexts/FirebaseContext";
import { v4 as uuidv4 } from 'uuid';
import { RichTextEditor } from "../../../shared/components/RichTextEditor";
import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

interface CardProps {
  card: CardData;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
  dndId: string;
}

// Popover/modal scaffold for feature dialogs
const Popover: React.FC<{ open: boolean; onClose: () => void; title: string; children: React.ReactNode }> = ({ open, onClose, title, children }) => {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div className="bg-pb-darker rounded-xl p-6 w-full max-w-sm shadow-xl flex flex-col gap-3 relative">
        <button className="absolute top-2 right-2 text-white text-xl" onClick={onClose} aria-label="Close">×</button>
        <div className="text-base font-bold text-white mb-2">{title}</div>
        {children}
      </div>
    </div>
  );
};

// Helper: render description with @-mention links
function renderDescriptionWithLinks(description: string) {
  if (!description) return null;
  // Regex for [@Name](prop:prop1) and similar, and for @@User
  const mentionRegex = /\[@([^\]]+)\]\((prop|container|user):([^\)]+)\)|@@([a-zA-Z0-9_]+)/g;
  const parts = [];
  let lastIndex = 0;
  let match;
  while ((match = mentionRegex.exec(description)) !== null) {
    if (match.index > lastIndex) {
      parts.push(description.slice(lastIndex, match.index));
    }
    if (match[1] && match[2] && match[3]) {
      // Markdown-style mention
      const [, name, type, id] = match;
      let href = '#';
      let color = '#3B82F6';
      let label = name;
      if (type === 'prop') {
        href = `/props/${id}`;
        color = '#3B82F6';
      } else if (type === 'container') {
        href = `/containers/${id}`;
        color = '#A855F7';
      } else if (type === 'user') {
        href = `/users/${id}`;
        color = '#22C55E';
        label = '@' + name;
      }
      parts.push(
        <a
          key={match.index}
          href={href}
          className="underline hover:text-pb-success"
          style={{ color, fontWeight: 600, marginRight: 2 }}
          target="_blank"
          rel="noopener noreferrer"
        >
          {label}
        </a>
      );
    } else if (match[4]) {
      // @@User mention
      const user = match[4];
      const href = `/users/${user}`;
      const color = '#22C55E';
      parts.push(
        <a
          key={match.index}
          href={href}
          className="underline hover:text-pb-success"
          style={{ color, fontWeight: 600, marginRight: 2 }}
          target="_blank"
          rel="noopener noreferrer"
        >
          @{user}
        </a>
      );
    }
    lastIndex = match.index + match[0].length;
  }
  if (lastIndex < description.length) {
    parts.push(description.slice(lastIndex));
  }
  return parts;
}

const CardDetailModal: React.FC<{
  open: boolean;
  onClose: () => void;
  card: CardData;
  onUpdateCard: (cardId: string, updates: Partial<CardData>) => void;
}> = ({ open, onClose, card, onUpdateCard }) => {
  const [title, setTitle] = useState(card.title);
  const { service: firebaseService, user } = useFirebase();
  const [propsList, setPropsList] = useState<{ id: string; name: string }[]>([]);
  const [containersList, setContainersList] = useState<{ id: string; name: string }[]>([]);
  const [usersList, setUsersList] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    firebaseService.getDocuments("props").then(docs => setPropsList(docs.map(d => ({ id: d.id, name: d.data.name }))));
    firebaseService.getDocuments("containers").then(docs => setContainersList(docs.map(d => ({ id: d.id, name: d.data.name }))));
    firebaseService.getDocuments("users").then(docs => setUsersList(docs.map(d => ({ id: d.id, name: d.data.displayName || d.data.name || d.data.email }))));
  }, [firebaseService]);

  const [description, setDescription] = useState(card.description || "");
  const [labels, setLabels] = useState<string[]>(card.labels || []);
  const [members, setMembers] = useState(card.assignedTo || []);
  const [dueDate, setDueDate] = useState(card.dueDate || "");
  const [attachments, setAttachments] = useState(card.attachments || []);
  const [checklists, setChecklists] = useState(card.checklist || []);
  const [comments, setComments] = useState(card.comments || []);
  const [activityLog, setActivityLog] = useState(card.activityLog || []);
  const [images, setImages] = useState<PropImage[]>(card.images || []);

  // Popover state
  const [showLabels, setShowLabels] = useState(false);
  const [showDates, setShowDates] = useState(false);
  const [showChecklist, setShowChecklist] = useState(false);
  const [showMembers, setShowMembers] = useState(false);
  const [showAdd, setShowAdd] = useState(false);

  // @ context menu state
  const [showMentionMenu, setShowMentionMenu] = useState(false);
  const [mentionMenuPosition, setMentionMenuPosition] = useState({ top: 0, left: 0 });
  const [mentionType, setMentionType] = useState<'prop' | 'container' | 'user' | null>(null);
  const [showMentionSearch, setShowMentionSearch] = useState(false);
  const [mentionSearchText, setMentionSearchText] = useState('');
  const [mentionSuggestions, setMentionSuggestions] = useState<any[]>([]);

  const [newComment, setNewComment] = useState("");

  // 1. Add state for image upload popup and checklist add UI
  const [showImageUpload, setShowImageUpload] = useState(false);
  const [newChecklistItem, setNewChecklistItem] = useState("");

  // Add state for new label
  const [newLabelTitle, setNewLabelTitle] = useState('');

  // Add state for card color
  const [cardColor, setCardColor] = useState(card.color || '#374151');

  // Add completed state
  const [completed, setCompleted] = useState(card.completed || false);

  // Helper to log activity
  function logActivity(type: string, details: any) {
    setActivityLog(log => [
      ...log,
      {
        id: uuidv4(),
        type,
        userId: user?.uid || 'anonymous',
        timestamp: new Date().toISOString(),
        details,
      },
    ]);
  }

  // On save, compare previous and new values, log changes
  const handleSave = () => {
    if (title !== card.title) logActivity('Title changed', { from: card.title, to: title });
    if (description !== card.description) logActivity('Description changed', {});
    if (dueDate !== card.dueDate) logActivity('Due date changed', { from: card.dueDate, to: dueDate });
    if (cardColor !== card.color) logActivity('Color changed', { from: card.color, to: cardColor });
    if (JSON.stringify(members) !== JSON.stringify(card.assignedTo)) logActivity('Assignee changed', { from: card.assignedTo, to: members });
    if (completed !== card.completed) logActivity('Completed changed', { from: card.completed, to: completed });
    if (JSON.stringify(labels) !== JSON.stringify(card.labels)) logActivity('Labels changed', {});
    if (JSON.stringify(checklists) !== JSON.stringify(card.checklist)) logActivity('Checklist changed', {});
    onUpdateCard(card.id, { title, description, color: cardColor, assignedTo: members, completed, activityLog, dueDate, labels, checklist: checklists });
    onClose();
  };

  // Helper: open @ menu at cursor
  const handleDescriptionKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === '@') {
      // Find cursor position for popover (approximate)
      const textarea = e.target as HTMLTextAreaElement;
      const rect = textarea.getBoundingClientRect();
      setMentionMenuPosition({ top: rect.top + 40, left: rect.left + 40 });
      setShowMentionMenu(true);
    }
  };

  // When mention type is selected
  const handleSelectMentionType = (type: 'prop' | 'container' | 'user') => {
    setMentionType(type);
    setShowMentionMenu(false);
    setShowMentionSearch(true);
    setMentionSearchText('');
    if (type === 'prop') setMentionSuggestions(propsList);
    else if (type === 'container') setMentionSuggestions(containersList);
    else setMentionSuggestions(usersList);
  };

  // When searching in mention popover
  const handleMentionSearchChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value;
    setMentionSearchText(val);
    let data = [];
    if (mentionType === 'prop') data = propsList;
    else if (mentionType === 'container') data = containersList;
    else data = usersList;
    setMentionSuggestions(data.filter(item => item.name && item.name.toLowerCase().includes(val.toLowerCase())));
  };

  // When a mention is picked
  const handlePickMention = (item: any) => {
    // Insert mention at cursor (simple: append for now)
    let mentionText = '';
    if (mentionType === 'prop') mentionText = `[@${item.name}](prop:${item.id})`;
    else if (mentionType === 'container') mentionText = `[@${item.name}](container:${item.id})`;
    else mentionText = `@${item.name}`;
    setDescription(desc => desc + mentionText + ' ');
    setShowMentionSearch(false);
    setMentionType(null);
  };

  // Close all popovers
  const closeMentionMenus = () => {
    setShowMentionMenu(false);
    setShowMentionSearch(false);
    setMentionType(null);
  };

  // Combine comments and activity log for chronological display
  const combinedLog = [
    ...comments.map(c => ({
      type: 'comment',
      id: c.id,
      userId: c.userId,
      text: c.text,
      createdAt: c.createdAt,
    })),
    ...activityLog.map(a => ({
      type: 'activity',
      id: a.id,
      userId: a.userId,
      text: a.type,
      details: a.details,
      createdAt: a.timestamp,
    })),
  ].sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());

  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div
        className="relative rounded-2xl shadow-2xl flex flex-row overflow-y-auto max-h-[98vh] min-h-[700px] border border-gray-300"
        style={{ background: cardColor, transition: 'background 0.3s' }}
      >
        {/* Close (X) button top right of modal */}
        <button className="absolute top-4 right-4 text-white text-2xl z-50" onClick={onClose} aria-label="Close">×</button>
        {/* Left column */}
        <div className="flex-1 min-w-[340px] max-w-[520px] p-10 flex flex-col gap-8 rounded-l-2xl overflow-y-auto" style={{ maxHeight: '90vh' }}>
          {/* Title */}
          <div className="flex items-center gap-3 mb-2">
            <input
              type="checkbox"
              checked={completed}
              onChange={() => setCompleted(c => !c)}
              className="w-5 h-5 accent-pb-success rounded"
              title="Mark card as completed"
            />
            <input
              className={`rounded-lg px-3 py-2 text-2xl font-bold bg-black/20 border border-white/20 shadow-sm focus:ring-2 focus:ring-pb-primary focus:outline-none placeholder:text-gray-200 text-white ${completed ? 'line-through opacity-60' : ''}`}
              value={title}
              onChange={e => setTitle(e.target.value)}
              placeholder="Card title"
              style={{ boxShadow: 'none', border: 'none' }}
              disabled={completed}
            />
          </div>
          {/* Add bar */}
          <div className="flex gap-2 mb-2">
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowLabels(true)}>
              <span>🏷️</span> Labels
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowDates(true)}>
              <span>🕒</span> Dates
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowChecklist(true)}>
              <span>☑️</span> Checklist
            </button>
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowMembers(true)}>
              <span>👤</span> Assign to
              {members.length > 0 && (
                <span className="ml-2 bg-pb-success text-white rounded-full px-2 py-1 text-xs font-bold">{usersList.find(u => u.id === members[0])?.name?.[0] || '?'}</span>
              )}
            </button>
            {/* Image upload icon */}
            <button className="bg-pb-primary/40 hover:bg-pb-primary text-white font-semibold py-1 px-2 rounded flex items-center gap-1 text-xs" onClick={() => setShowImageUpload(true)} title="Upload Images">
              <span role="img" aria-label="Upload">📷</span>
            </button>
          </div>
          {/* Image upload popup */}
          <Popover open={showImageUpload} onClose={() => setShowImageUpload(false)} title="Upload Images">
            <ImageUpload currentImages={images} onImagesChange={setImages} />
          </Popover>
          {/* Card color picker */}
            <div className="flex gap-2 items-center mt-2">
            <span className="text-gray-200 text-sm">Card color:</span>
            {["#27ae60", "#f1c40f", "#e67e22", "#e74c3c", "#8e44ad", "#2980b9", "#374151"].map(color => (
                <button
                  key={color}
                className="w-7 h-7 rounded-full border-2 border-white shadow hover:scale-110 transition"
                  style={{ background: color }}
                onClick={() => setCardColor(color)}
                  aria-label={`Set card color ${color}`}
                />
              ))}
          </div>
          {/* Description */}
          <div className="bg-black/20 rounded-lg p-2 shadow-inner">
            <label className="block font-semibold text-white mb-1">Description</label>
            <RichTextEditor
              value={description}
              onChange={setDescription}
              placeholder="Add a more detailed description..."
              minHeight={120}
              disabled={false}
            />
          </div>
          {/* Checklist */}
          <div>
            <div className="font-semibold text-gray-300 mb-2">Checklists</div>
            <div className="flex gap-2 mb-2">
              <input
                className="flex-1 rounded-lg border border-white/20 px-2 py-1 text-base bg-black/20 text-white placeholder:text-gray-200"
                value={newChecklistItem}
                onChange={e => setNewChecklistItem(e.target.value)}
                placeholder="Add checklist item..."
                onKeyDown={e => {
                  if (e.key === 'Enter' && newChecklistItem.trim()) {
                    setChecklists(list => [...list, { id: uuidv4(), text: newChecklistItem, checked: false }]);
                    setNewChecklistItem("");
                  }
                }}
              />
              <button className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded-lg shadow" disabled={!newChecklistItem.trim()} onClick={() => {
                if (newChecklistItem.trim()) {
                  setChecklists(list => [...list, { id: uuidv4(), text: newChecklistItem, checked: false }]);
                  setNewChecklistItem("");
                }
              }}>Add</button>
            </div>
            <div className="flex flex-col gap-2">
              {checklists.map((item, i) => (
                <label key={item.id || i} className="flex items-center gap-2 bg-black/20 border border-white/20 text-white rounded-lg px-3 py-2 text-base cursor-pointer shadow-sm">
                  <input
                    type="checkbox"
                    checked={!!item.checked}
                    onChange={() => {
                      setChecklists(list => list.map((c, idx) => idx === i ? { ...c, checked: !c.checked } : c));
                    }}
                  />
                  <span style={{ textDecoration: item.checked ? 'line-through' : 'none' }}>{item.text || item.id}</span>
                </label>
              ))}
            </div>
          </div>
          {/* Dates popover */}
          <Popover open={showDates} onClose={() => setShowDates(false)} title="Set Due Date & Time">
            <div className="flex flex-col gap-2">
              <label className="text-white text-sm">Due Date & Time</label>
              <input
                type="datetime-local"
                className="rounded border border-pb-primary/40 px-2 py-1 text-[#222]"
                value={dueDate ? dueDate.substring(0, 16) : ''}
                onChange={e => setDueDate(e.target.value)}
              />
              <button
                className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded mt-2"
                onClick={() => setShowDates(false)}
              >Set</button>
            </div>
          </Popover>
          {/* Show selected due date and time */}
          {dueDate && (
            <div className="text-xs text-pb-gray mt-1">Due: {new Date(dueDate).toLocaleString()}</div>
          )}
          {/* Labels popover */}
          <Popover open={showLabels} onClose={() => setShowLabels(false)} title="Manage Labels">
            <div className="flex flex-col gap-2">
              {/* Add new label */}
              <div className="flex gap-2 items-center mb-2">
                <input
                  className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-xs"
                  placeholder="Label title"
                  value={newLabelTitle || ''}
                  onChange={e => setNewLabelTitle(e.target.value)}
                />
                <button
                  className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-2 rounded text-xs"
                  disabled={!newLabelTitle}
                  onClick={() => {
                    setLabels(list => [...list, newLabelTitle]);
                    setNewLabelTitle('');
                  }}
                >Add</button>
              </div>
              {/* List and edit labels */}
              <div className="flex flex-col gap-2">
                {labels.map((label, i) => (
                  <div key={i} className="flex items-center gap-2">
                    <input
                      className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-xs"
                      value={label}
                      onChange={e => {
                        const v = e.target.value;
                        setLabels(list => list.map((l, idx) => idx === i ? v : l));
                      }}
                    />
                    <button
                      className="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-2 rounded text-xs"
                      onClick={() => setLabels(list => list.filter((_, idx) => idx !== i))}
                    >Remove</button>
                  </div>
                ))}
              </div>
            </div>
          </Popover>
          {/* Show current labels as pills */}
          {labels.length > 0 && (
            <div className="flex gap-2 flex-wrap mb-2">
              {labels.map((label, i) => (
                <span key={i} className="px-2 py-1 rounded text-xs font-semibold bg-pb-primary text-white">{label}</span>
              ))}
            </div>
          )}
        </div>
        {/* Right column: Comments and Activity */}
        <div className="w-[340px] flex flex-col p-8 gap-6 bg-pb-darker/90 rounded-r-2xl border-l border-gray-200">
          <div className="font-semibold text-white text-lg mb-2">Comments and activity</div>
          {/* Add comment area */}
          <div className="flex gap-2 items-center mb-4">
            <input
              className="flex-1 rounded border border-pb-primary/40 px-2 py-1 text-[#222]"
              value={newComment}
              onChange={e => setNewComment(e.target.value)}
              placeholder="Write a comment..."
              onKeyDown={e => {
                if (e.key === 'Enter' && newComment.trim()) {
                  setComments(c => [
                    ...c,
                    {
                      id: uuidv4(),
                      userId: user?.uid || 'anonymous',
                      text: newComment,
                      createdAt: new Date().toISOString(),
                    },
                  ]);
                  setNewComment("");
                }
              }}
            />
            <button
              className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded"
              disabled={!newComment.trim()}
              onClick={() => {
                if (newComment.trim()) {
                  setComments(c => [
                    ...c,
                    {
                      id: uuidv4(),
                      userId: user?.uid || 'anonymous',
                      text: newComment,
                      createdAt: new Date().toISOString(),
                    },
                  ]);
                  setNewComment("");
                }
              }}
            >Add</button>
          </div>
          {/* Comments list */}
          <div className="flex flex-col gap-2 mb-6">
            {combinedLog.map((item, i) => (
              <div key={item.id || i} className="flex items-start gap-2">
                <div className="w-8 h-8 rounded-full bg-pb-primary flex items-center justify-center text-white font-bold text-sm">{item.userId?.[0] || 'U'}</div>
                <div>
                  <div className="text-white font-semibold text-sm">{item.userId || 'User'}</div>
                  {item.type === 'comment' ? (
                    <div className="text-white text-xs opacity-70">{item.text}</div>
                  ) : (
                    <div className="text-pb-primary text-xs">{item.text}</div>
                  )}
                  <div className="text-pb-gray text-xs">{item.createdAt ? new Date(item.createdAt).toLocaleString() : ''}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
        {/* Modal footer: Save/Delete/Close */}
        <div className="absolute bottom-6 left-8 flex gap-2">
          <button className="bg-pb-primary hover:bg-pb-success text-white font-semibold py-1 px-3 rounded shadow" onClick={handleSave}>Save</button>
          <button className="bg-red-600 hover:bg-red-700 text-white font-semibold py-1 px-3 rounded shadow">Delete</button>
        </div>
      </div>
    </div>
  );
};

const Card: React.FC<CardProps> = ({ card, onUpdateCard, dndId }) => {
  const [modalOpen, setModalOpen] = useState(false);
  const handleOpen = (e: React.MouseEvent) => {
    e.preventDefault();
    setModalOpen(true);
  };
  // dnd-kit sortable for cards
  const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({ id: dndId });
  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
    zIndex: isDragging ? 100 : undefined,
  };
  return (
    <>
      <div
        ref={setNodeRef}
        style={{
          ...style, // dnd-kit drag styles
          background: card.color || '#374151',
          minHeight: 90,
        }}
        {...attributes}
        {...listeners}
        className={`block rounded-lg p-3 shadow hover:shadow-lg transition cursor-pointer no-underline ${(!card.color || card.color === '#374151') ? 'border border-white/10' : ''}`}
        onClick={handleOpen}
        tabIndex={0}
        role="button"
        onKeyPress={e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleOpen({ preventDefault: () => {} } as React.MouseEvent);
          }
        }}
      >
        <div className="font-semibold" style={{ color: '#fff' }}>{card.title}</div>
    {card.description && (
          <div className="text-xs mt-1" style={{ color: '#fff' }}>{renderDescriptionWithLinks(card.description)}</div>
    )}
      </div>
      <CardDetailModal open={modalOpen} onClose={() => setModalOpen(false)} card={card} onUpdateCard={onUpdateCard} />
    </>
);
};

export default Card; 
```

- Updated the color picker label to be readable on dark backgrounds.
- Added a subtle border to list cards when using the default dark gray color so the card doesn’t visually merge with dark text/background.
- Ensured `CardData` has a `color` field and that saved colors show in the list card.

If you prefer a different default color or a different border shade for the dark gray option, I can adjust the hex and border opacity.

---

**User**

please remove the time from the page header and add the users profile image as an small circle that links to the users profile.

---

**Cursor**

```typescriptreact
import React from 'react';
import { motion } from 'framer-motion';
import { AlertCircle, BarChart3, Bell, Box, Bug, Calendar, CheckCircle, Crown, FileBarChart, FileText, Home, LogOut, Package, Package2, Plus, Scroll, Search, Star, Theater, User, Users, Wrench, Zap } from 'lucide-react';
import { useWebAuth } from './contexts/WebAuthContext';
import { Link, useNavigate } from 'react-router-dom';
import { useShowSelection } from "./contexts/ShowSelectionContext";
import type { Show } from "./types/Show";
import { useFirebase } from "./contexts/FirebaseContext";

// Animation variants
const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};

const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: {
      duration: 0.5
    }
  }
};

const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: {
      duration: 0.4
    }
  },
  hover: {
    scale: 1.02,
    transition: {
      duration: 0.2
    }
  }
};

type DashboardLayoutProps = {
  children: React.ReactNode;
};

const DashboardLayout: React.FC<DashboardLayoutProps> = ({ children }) => {
  const { userProfile, signOut } = useWebAuth();
  const navigate = useNavigate();
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [showTitle, setShowTitle] = React.useState<string>("");

  // removed ticking clock

  React.useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // header metadata simplified (no time)

  const handleSignOut = async () => {
    await signOut();
    navigate('/login');
  };

  return (
    <div className="min-h-screen bg-gradient-dark text-white">
      {/* Header */}
      <header className="flex items-center justify-between px-6 py-4 bg-pb-darker/50 backdrop-blur-sm border-b border-pb-primary/20">
        <div className="flex items-center space-x-4">
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-pb-primary rounded-lg flex items-center justify-center">
              <Theater className="w-5 h-5 text-white" />
            </div>
            <div>
              <h1 className="text-lg font-bold text-white">Props Bible</h1>
              <p className="text-xs text-pb-gray">Theater Props Management</p>
            </div>
          </div>
          <div className="bg-pb-primary/20 text-pb-primary px-3 py-1 rounded-full text-xs font-medium">
            Web Platform
          </div>
        </div>
        <div className="flex-1 flex flex-col items-center">
          <span className="text-pb-primary text-lg font-semibold">
            {showTitle || "No show selected"}
          </span>
        </div>
        <div className="flex items-center space-x-4">
          {userProfile?.displayName && (
            <span className="text-sm text-pb-gray">Welcome, {userProfile.displayName}</span>
          )}
          <Link to="/profile" className="block">
            <img
              src={userProfile?.photoURL || '/public/icon.png'}
              alt="Profile"
              className="w-8 h-8 rounded-full border border-pb-primary/40 object-cover"
            />
          </Link>
          <button
            onClick={handleSignOut}
            className="ml-2 flex items-center px-2 py-1 rounded hover:bg-pb-primary/20 transition-colors text-pb-gray hover:text-white focus:outline-none"
            title="Log out"
            aria-label="Log out"
          >
            <LogOut className="w-5 h-5" />
          </button>
        </div>
      </header>

      <div className="flex">
        {/* Sidebar */}
        <motion.aside
          initial={{ x: -50, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ duration: 0.5 }}
          className="w-64 bg-pb-darker/30 backdrop-blur-sm border-r border-pb-primary/20 p-4 space-y-6 flex flex-col justify-between min-h-[80vh]"
        >
          <div>
            {/* Quick Actions */}
            <div>
              <h3 className="text-sm font-semibold text-pb-gray uppercase tracking-wider mb-3">
                Quick Actions
              </h3>
              <div className="space-y-2">
                {[
                  { icon: Home, text: 'Home', subtext: 'Dashboard overview', link: '/', gradient: 'from-pb-primary to-pb-secondary' },
                  { icon: Package, text: 'Props Inventory', subtext: 'Manage all production props', link: '/props', gradient: 'from-pb-blue to-pb-primary' },
                  { icon: Box, text: 'Packing Lists', subtext: 'packing & storage management', link: '/packing-lists', gradient: 'from-pb-green to-pb-primary' },
                  { icon: Theater, text: 'Show Management', subtext: 'Manage productions and venues', link: '/shows', gradient: 'from-pb-accent to-pb-primary' },
                  { icon: Calendar, text: 'Task Boards', subtext: 'Kanban-style to-do boards', link: '/boards', gradient: 'from-pb-orange to-pb-primary' },
                  { icon: FileText, text: 'Export Props PDF', subtext: 'Download props list as PDF', link: '/props/pdf-export' },
                  { icon: Zap, text: 'Shopping List', subtext: 'Track props and materials to buy', link: '/shopping'},
                  { icon: Bug, text: 'feedback/bugs', subtext: 'let us know any bugs or issues you are having', link: '/feedback'}
                ].map((item, index) => (
                  item.link ? (
                    <Link to={item.link} key={index} className="block">
                      <motion.div
                        variants={itemVariants}
                        initial="hidden"
                        animate="visible"
                        transition={{ delay: index * 0.1 }}
                        className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                      >
                        <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                          <item.icon className="w-4 h-4 text-white" />
                        </div>
                        <div>
                          <p className="text-sm font-medium text-white">{item.text}</p>
                          <p className="text-xs text-white/80">{item.subtext}</p>
                        </div>
                      </motion.div>
                    </Link>
                  ) : (
                    <motion.div
                      key={index}
                      variants={itemVariants}
                      initial="hidden"
                      animate="visible"
                      transition={{ delay: index * 0.1 }}
                      className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                    >
                      <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                        <item.icon className="w-4 h-4 text-white" />
                      </div>
                      <div>
                        <p className="text-sm font-medium text-white">{item.text}</p>
                        <p className="text-xs text-white/80">{item.subtext}</p>
                      </div>
                    </motion.div>
                  )
                ))}
              </div>
            </div>
          </div>
        
        </motion.aside>

        {/* Main Content */}
        <main className="flex-1 p-6 overflow-x-hidden">
          {children}
        </main>
      </div>
    </div>
  );
};

export default DashboardLayout; 
```

- Removed time from the header. Replaced with a small circular user profile image linking to `/profile`. Keeps the logout button.
- File updated: `web-app/src/PropsBibleHomepage.tsx`

Note: There are warnings about unused imports/variants in `PropsBibleHomepage.tsx`. I can clean those up if you want, but they don’t affect functionality.

---

**User**

if the user logged in with google can we get this information from there google account and there avitar or profile image

---

**Cursor**

Yes. If you’re using Firebase Auth with Google sign‑in, you already get these fields from the Google account on login:
- display name: user.displayName
- email: user.email
- avatar: user.photoURL
- provider info: user.providerData[0].providerId === 'google.com'

What to do
- On login/refresh, populate your user profile from Firebase Auth and persist to Firestore.
- Prefer the live Firebase avatar if present; fall back to the stored profile.

Minimal changes
- In your auth/profile load (e.g., `WebAuthContext`):
  - Read `user.photoURL`, `user.displayName`, `user.email`.
  - Save to `users/{uid}` if missing or outdated.

- In the header (already updated), use:
  - `src={userProfile?.photoURL || user?.photoURL || '/public/icon.png'}`

Optional (better quality)
- Google avatar URLs often contain size params (e.g., `.../s96-c/...`). For a crisper image, upsize:
  - `const hiRes = (url || '').replace(/s\\d+-c/, 's256-c');`

That’s it—no extra API calls needed unless you want more profile fields (which would require Google People API and user consent).

---

**User**

ok on the peofile page we dont need organisation or preferancese. but we do need a role

---

**Cursor**

```typescriptreact
import React, { useState, useRef } from 'react';
import { useWebAuth } from '../contexts/WebAuthContext';
import DashboardLayout from '../PropsBibleHomepage';
import { storage } from '../firebase';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';

const ProfilePage: React.FC = () => {
  const { user, userProfile, updateUserProfile, refreshProfile } = useWebAuth();
  const [displayName, setDisplayName] = useState(userProfile?.displayName || user?.displayName || '');
  const [photoURL, setPhotoURL] = useState(userProfile?.photoURL || '');
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const [role, setRole] = useState<string>(userProfile?.role || '');

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      await updateUserProfile({ displayName, photoURL, role });
      await refreshProfile();
    } catch (err: any) {
      setError(err.message || 'Failed to update profile');
    } finally {
      setSaving(false);
    }
  };

  const handlePhotoChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !user) return;
    if (!file.type.match('image.*')) {
      setError('Please select an image file');
      return;
    }
    if (file.size > 5 * 1024 * 1024) {
      setError('Image size should be less than 5MB');
      return;
    }
    setSaving(true);
    setError(null);
    try {
      const storageRef = ref(storage, `profile_images/${user.uid}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      setPhotoURL(url);
      await updateUserProfile({ photoURL: url });
      await refreshProfile();
    } catch (err: any) {
      setError('Failed to upload photo');
    } finally {
      setSaving(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="w-full max-w-5xl mx-auto py-10 px-4">
        <h1 className="text-2xl font-bold mb-6 text-white">Profile Details</h1>
        <form onSubmit={handleSave} className="bg-pb-darker/60 rounded-2xl p-6 border border-pb-primary/20">
          <div className="mb-6 grid grid-cols-1 md:grid-cols-[120px,1fr] gap-6 items-center">
            <div className="relative w-24 h-24">
              <img
                src={photoURL || '/public/icon.png'}
                alt="Profile"
                className="w-24 h-24 rounded-full object-cover border-2 border-pb-primary bg-pb-darker"
              />
              <button
                type="button"
                className="absolute bottom-0 right-0 bg-pb-primary text-white rounded-full p-1 shadow hover:bg-pb-secondary"
                onClick={() => fileInputRef.current?.click()}
                title="Change photo"
              >
                ✏️
              </button>
              <input
                type="file"
                accept="image/*"
                ref={fileInputRef}
                className="hidden"
                onChange={handlePhotoChange}
              />
            </div>
            <div className="text-pb-gray text-sm">Profile Photo</div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
            <label className="block text-pb-gray text-xs mb-1">Name</label>
            <input
              className="w-full p-2 rounded bg-pb-darker text-white border border-pb-gray focus:outline-none focus:border-pb-primary"
              value={displayName}
              onChange={e => setDisplayName(e.target.value)}
              required
            />
            </div>
            <div>
            <span className="block text-pb-gray text-xs mb-1">Email</span>
            <span className="text-lg font-semibold text-white">{userProfile?.email || user?.email || 'N/A'}</span>
            </div>
            <div>
              <label className="block text-pb-gray text-xs mb-1">Role</label>
              <input
                className="w-full p-2 rounded bg-pb-darker text-white border border-pb-gray focus:outline-none focus:border-pb-primary"
                value={role}
                onChange={e => setRole(e.target.value)}
                placeholder="e.g., admin, editor, viewer"
              />
            </div>
            <div>
            <span className="block text-pb-gray text-xs mb-1">Last Login</span>
            <span className="text-lg font-semibold text-white">{userProfile?.lastLogin ? new Date(userProfile.lastLogin).toLocaleString() : 'N/A'}</span>
            </div>
            <div>
            <span className="block text-pb-gray text-xs mb-1">Created At</span>
            <span className="text-lg font-semibold text-white">{userProfile?.createdAt ? new Date(userProfile.createdAt).toLocaleString() : 'N/A'}</span>
            </div>
          </div>
          {userProfile?.groups && (
            <div className="mb-4">
              <span className="block text-pb-gray text-xs mb-1">Groups</span>
              <span className="text-sm text-white bg-pb-primary/10 rounded p-2 block font-mono">
                {JSON.stringify(userProfile.groups, null, 2)}
              </span>
            </div>
          )}
          {error && <div className="mb-2 text-red-400 font-semibold">{error}</div>}
          <button
            type="submit"
            className="px-4 py-2 rounded bg-pb-primary text-white font-semibold shadow hover:bg-pb-secondary transition-colors"
            disabled={saving}
          >
            {saving ? 'Saving...' : 'Save Changes'}
          </button>
        </form>
      </div>
    </DashboardLayout>
  );
};

export default ProfilePage; 
```

- Removed Organizations and Preferences from `ProfilePage`.
- Added a Role field; saving the profile now persists `role` along with `displayName` and `photoURL`.

File updated:
- `web-app/src/pages/ProfilePage.tsx`

If you want `role` to be a dropdown with predefined options (admin/editor/viewer), I can switch it to a select and enforce validation.

---

**User**

yes the roles shouild be predefined as props maker , painter, buyer, senior props maker, props supervisor, art director, set dresser, stage manager, assistant stage manager, designer, assistant designer. the default role should be propmaker.

---

**Cursor**

```typescriptreact
import React, { useState, useRef } from 'react';
import { useWebAuth } from '../contexts/WebAuthContext';
import DashboardLayout from '../PropsBibleHomepage';
import { storage } from '../firebase';
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage';

const ProfilePage: React.FC = () => {
  const { user, userProfile, updateUserProfile, refreshProfile } = useWebAuth();
  const [displayName, setDisplayName] = useState(userProfile?.displayName || user?.displayName || '');
  const [photoURL, setPhotoURL] = useState(userProfile?.photoURL || '');
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const roleOptions: { value: string; label: string }[] = [
    { value: 'propmaker', label: 'Props Maker' },
    { value: 'painter', label: 'Painter' },
    { value: 'buyer', label: 'Buyer' },
    { value: 'senior-propmaker', label: 'Senior Props Maker' },
    { value: 'props-supervisor', label: 'Props Supervisor' },
    { value: 'art-director', label: 'Art Director' },
    { value: 'set-dresser', label: 'Set Dresser' },
    { value: 'stage-manager', label: 'Stage Manager' },
    { value: 'assistant-stage-manager', label: 'Assistant Stage Manager' },
    { value: 'designer', label: 'Designer' },
    { value: 'assistant-designer', label: 'Assistant Designer' },
  ];
  const [role, setRole] = useState<string>(userProfile?.role || 'propmaker');

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      await updateUserProfile({ displayName, photoURL, role });
      await refreshProfile();
    } catch (err: any) {
      setError(err.message || 'Failed to update profile');
    } finally {
      setSaving(false);
    }
  };

  const handlePhotoChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file || !user) return;
    if (!file.type.match('image.*')) {
      setError('Please select an image file');
      return;
    }
    if (file.size > 5 * 1024 * 1024) {
      setError('Image size should be less than 5MB');
      return;
    }
    setSaving(true);
    setError(null);
    try {
      const storageRef = ref(storage, `profile_images/${user.uid}`);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);
      setPhotoURL(url);
      await updateUserProfile({ photoURL: url });
      await refreshProfile();
    } catch (err: any) {
      setError('Failed to upload photo');
    } finally {
      setSaving(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="w-full max-w-5xl mx-auto py-10 px-4">
        <h1 className="text-2xl font-bold mb-6 text-white">Profile Details</h1>
        <form onSubmit={handleSave} className="bg-pb-darker/60 rounded-2xl p-6 border border-pb-primary/20">
          <div className="mb-6 grid grid-cols-1 md:grid-cols-[120px,1fr] gap-6 items-center">
            <div className="relative w-24 h-24">
              <img
                src={photoURL || '/public/icon.png'}
                alt="Profile"
                className="w-24 h-24 rounded-full object-cover border-2 border-pb-primary bg-pb-darker"
              />
              <button
                type="button"
                className="absolute bottom-0 right-0 bg-pb-primary text-white rounded-full p-1 shadow hover:bg-pb-secondary"
                onClick={() => fileInputRef.current?.click()}
                title="Change photo"
              >
                ✏️
              </button>
              <input
                type="file"
                accept="image/*"
                ref={fileInputRef}
                className="hidden"
                onChange={handlePhotoChange}
              />
            </div>
            <div className="text-pb-gray text-sm">Profile Photo</div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
            <label className="block text-pb-gray text-xs mb-1">Name</label>
            <input
              className="w-full p-2 rounded bg-pb-darker text-white border border-pb-gray focus:outline-none focus:border-pb-primary"
              value={displayName}
              onChange={e => setDisplayName(e.target.value)}
              required
            />
            </div>
            <div>
            <span className="block text-pb-gray text-xs mb-1">Email</span>
            <span className="text-lg font-semibold text-white">{userProfile?.email || user?.email || 'N/A'}</span>
            </div>
            <div>
              <label className="block text-pb-gray text-xs mb-1">Role</label>
              <select
                className="w-full p-2 rounded bg-pb-darker text-white border border-pb-gray focus:outline-none focus:border-pb-primary"
                value={role}
                onChange={e => setRole(e.target.value)}
              >
                {roleOptions.map(opt => (
                  <option key={opt.value} value={opt.value}>{opt.label}</option>
                ))}
              </select>
            </div>
            <div>
            <span className="block text-pb-gray text-xs mb-1">Last Login</span>
            <span className="text-lg font-semibold text-white">{userProfile?.lastLogin ? new Date(userProfile.lastLogin).toLocaleString() : 'N/A'}</span>
            </div>
            <div>
            <span className="block text-pb-gray text-xs mb-1">Created At</span>
            <span className="text-lg font-semibold text-white">{userProfile?.createdAt ? new Date(userProfile.createdAt).toLocaleString() : 'N/A'}</span>
            </div>
          </div>
          {userProfile?.groups && (
            <div className="mb-4">
              <span className="block text-pb-gray text-xs mb-1">Groups</span>
              <span className="text-sm text-white bg-pb-primary/10 rounded p-2 block font-mono">
                {JSON.stringify(userProfile.groups, null, 2)}
              </span>
            </div>
          )}
          {error && <div className="mb-2 text-red-400 font-semibold">{error}</div>}
          <button
            type="submit"
            className="px-4 py-2 rounded bg-pb-primary text-white font-semibold shadow hover:bg-pb-secondary transition-colors"
            disabled={saving}
          >
            {saving ? 'Saving...' : 'Save Changes'}
          </button>
        </form>
      </div>
    </DashboardLayout>
  );
};

export default ProfilePage; 
```

- Role is now a predefined select with the following options:
  - Props Maker (default), Painter, Buyer, Senior Props Maker, Props Supervisor, Art Director, Set Dresser, Stage Manager, Assistant Stage Manager, Designer, Assistant Designer.
- Default selection: `propmaker`.
- Save action persists `role` along with name and photo.

File updated:
- `web-app/src/pages/ProfilePage.tsx`

---

**User**

lets re move the web platform pill and instade add a link to the app. this will be a placeholder as the app is not yet live 

---

**Cursor**

```typescriptreact
import React from 'react';
import { motion } from 'framer-motion';
import { AlertCircle, BarChart3, Bell, Box, Bug, Calendar, CheckCircle, Crown, FileBarChart, FileText, Home, LogOut, Package, Package2, Plus, Scroll, Search, Star, Theater, User, Users, Wrench, Zap } from 'lucide-react';
import { useWebAuth } from './contexts/WebAuthContext';
import { Link, useNavigate } from 'react-router-dom';
import { useShowSelection } from "./contexts/ShowSelectionContext";
import type { Show } from "./types/Show";
import { useFirebase } from "./contexts/FirebaseContext";

// Animation variants
const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.1,
      duration: 0.5
    }
  }
};

const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: {
      duration: 0.5
    }
  }
};

const cardVariants = {
  hidden: { scale: 0.95, opacity: 0 },
  visible: {
    scale: 1,
    opacity: 1,
    transition: {
      duration: 0.4
    }
  },
  hover: {
    scale: 1.02,
    transition: {
      duration: 0.2
    }
  }
};

type DashboardLayoutProps = {
  children: React.ReactNode;
};

const DashboardLayout: React.FC<DashboardLayoutProps> = ({ children }) => {
  const { userProfile, signOut } = useWebAuth();
  const navigate = useNavigate();
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [showTitle, setShowTitle] = React.useState<string>("");

  // removed ticking clock

  React.useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // header metadata simplified (no time)

  const handleSignOut = async () => {
    await signOut();
    navigate('/login');
  };

  return (
    <div className="min-h-screen bg-gradient-dark text-white">
      {/* Header */}
      <header className="flex items-center justify-between px-6 py-4 bg-pb-darker/50 backdrop-blur-sm border-b border-pb-primary/20">
        <div className="flex items-center space-x-4">
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-pb-primary rounded-lg flex items-center justify-center">
              <Theater className="w-5 h-5 text-white" />
            </div>
            <div>
              <h1 className="text-lg font-bold text-white">Props Bible</h1>
              <p className="text-xs text-pb-gray">Theater Props Management</p>
            </div>
          </div>
          <Link
            to="#"
            onClick={(e) => { e.preventDefault(); alert('Mobile app coming soon'); }}
            className="bg-pb-primary/20 text-pb-primary px-3 py-1 rounded-full text-xs font-medium hover:bg-pb-primary/30"
            title="Open mobile app (coming soon)"
          >
            Open App (Coming Soon)
          </Link>
        </div>
        <div className="flex-1 flex flex-col items-center">
          <span className="text-pb-primary text-lg font-semibold">
            {showTitle || "No show selected"}
          </span>
        </div>
        <div className="flex items-center space-x-4">
          {userProfile?.displayName && (
            <span className="text-sm text-pb-gray">Welcome, {userProfile.displayName}</span>
          )}
          <Link to="/profile" className="block">
            <img
              src={userProfile?.photoURL || '/public/icon.png'}
              alt="Profile"
              className="w-8 h-8 rounded-full border border-pb-primary/40 object-cover"
            />
          </Link>
          <button
            onClick={handleSignOut}
            className="ml-2 flex items-center px-2 py-1 rounded hover:bg-pb-primary/20 transition-colors text-pb-gray hover:text-white focus:outline-none"
            title="Log out"
            aria-label="Log out"
          >
            <LogOut className="w-5 h-5" />
          </button>
        </div>
      </header>

      <div className="flex">
        {/* Sidebar */}
        <motion.aside
          initial={{ x: -50, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ duration: 0.5 }}
          className="w-64 bg-pb-darker/30 backdrop-blur-sm border-r border-pb-primary/20 p-4 space-y-6 flex flex-col justify-between min-h-[80vh]"
        >
          <div>
            {/* Quick Actions */}
            <div>
              <h3 className="text-sm font-semibold text-pb-gray uppercase tracking-wider mb-3">
                Quick Actions
              </h3>
              <div className="space-y-2">
                {[
                  { icon: Home, text: 'Home', subtext: 'Dashboard overview', link: '/', gradient: 'from-pb-primary to-pb-secondary' },
                  { icon: Package, text: 'Props Inventory', subtext: 'Manage all production props', link: '/props', gradient: 'from-pb-blue to-pb-primary' },
                  { icon: Box, text: 'Packing Lists', subtext: 'packing & storage management', link: '/packing-lists', gradient: 'from-pb-green to-pb-primary' },
                  { icon: Theater, text: 'Show Management', subtext: 'Manage productions and venues', link: '/shows', gradient: 'from-pb-accent to-pb-primary' },
                  { icon: Calendar, text: 'Task Boards', subtext: 'Kanban-style to-do boards', link: '/boards', gradient: 'from-pb-orange to-pb-primary' },
                  { icon: FileText, text: 'Export Props PDF', subtext: 'Download props list as PDF', link: '/props/pdf-export' },
                  { icon: Zap, text: 'Shopping List', subtext: 'Track props and materials to buy', link: '/shopping'},
                  { icon: Bug, text: 'feedback/bugs', subtext: 'let us know any bugs or issues you are having', link: '/feedback'}
                ].map((item, index) => (
                  item.link ? (
                    <Link to={item.link} key={index} className="block">
                      <motion.div
                        variants={itemVariants}
                        initial="hidden"
                        animate="visible"
                        transition={{ delay: index * 0.1 }}
                        className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                      >
                        <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                          <item.icon className="w-4 h-4 text-white" />
                        </div>
                        <div>
                          <p className="text-sm font-medium text-white">{item.text}</p>
                          <p className="text-xs text-white/80">{item.subtext}</p>
                        </div>
                      </motion.div>
                    </Link>
                  ) : (
                    <motion.div
                      key={index}
                      variants={itemVariants}
                      initial="hidden"
                      animate="visible"
                      transition={{ delay: index * 0.1 }}
                      className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                    >
                      <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                        <item.icon className="w-4 h-4 text-white" />
                      </div>
                      <div>
                        <p className="text-sm font-medium text-white">{item.text}</p>
                        <p className="text-xs text-white/80">{item.subtext}</p>
                      </div>
                    </motion.div>
                  )
                ))}
              </div>
            </div>
          </div>
        
        </motion.aside>

        {/* Main Content */}
        <main className="flex-1 p-6 overflow-x-hidden">
          {children}
        </main>
      </div>
    </div>
  );
};

export default DashboardLayout; 
```

- Replaced the “Web Platform” pill with a placeholder link “Open App (Coming Soon)” that shows an alert for now.
- File updated: `web-app/src/PropsBibleHomepage.tsx`

Note: There are unused import warnings in this file. If you’d like, I can remove the unused icons/variants to clean up the linter messages.

---

**User**

please clean up 

---

**Cursor**

```typescriptreact
import React from 'react';
import { motion } from 'framer-motion';
import { Box, Bug, Calendar, FileText, Home, LogOut, Package, Theater, Zap } from 'lucide-react';
import { useWebAuth } from './contexts/WebAuthContext';
import { Link, useNavigate } from 'react-router-dom';
import { useShowSelection } from "./contexts/ShowSelectionContext";
import type { Show } from "./types/Show";
import { useFirebase } from "./contexts/FirebaseContext";

const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: {
      duration: 0.5
    }
  }
};

type DashboardLayoutProps = {
  children: React.ReactNode;
};

const DashboardLayout: React.FC<DashboardLayoutProps> = ({ children }) => {
  const { userProfile, signOut } = useWebAuth();
  const navigate = useNavigate();
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [showTitle, setShowTitle] = React.useState<string>("");

  // removed ticking clock

  React.useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // header metadata simplified (no time)

  const handleSignOut = async () => {
    await signOut();
    navigate('/login');
  };

  return (
    <div className="min-h-screen bg-gradient-dark text-white">
      {/* Header */}
      <header className="flex items-center justify-between px-6 py-4 bg-pb-darker/50 backdrop-blur-sm border-b border-pb-primary/20">
        <div className="flex items-center space-x-4">
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-pb-primary rounded-lg flex items-center justify-center">
              <Theater className="w-5 h-5 text-white" />
            </div>
            <div>
              <h1 className="text-lg font-bold text-white">Props Bible</h1>
              <p className="text-xs text-pb-gray">Theater Props Management</p>
            </div>
          </div>
          <Link
            to="#"
            onClick={(e) => { e.preventDefault(); alert('Mobile app coming soon'); }}
            className="bg-pb-primary/20 text-pb-primary px-3 py-1 rounded-full text-xs font-medium hover:bg-pb-primary/30"
            title="Open mobile app (coming soon)"
          >
            Open App (Coming Soon)
          </Link>
        </div>
        <div className="flex-1 flex flex-col items-center">
          <span className="text-pb-primary text-lg font-semibold">
            {showTitle || "No show selected"}
          </span>
        </div>
        <div className="flex items-center space-x-4">
          {userProfile?.displayName && (
            <span className="text-sm text-pb-gray">Welcome, {userProfile.displayName}</span>
          )}
          <Link to="/profile" className="block">
            <img
              src={userProfile?.photoURL || '/public/icon.png'}
              alt="Profile"
              className="w-8 h-8 rounded-full border border-pb-primary/40 object-cover"
            />
          </Link>
          <button
            onClick={handleSignOut}
            className="ml-2 flex items-center px-2 py-1 rounded hover:bg-pb-primary/20 transition-colors text-pb-gray hover:text-white focus:outline-none"
            title="Log out"
            aria-label="Log out"
          >
            <LogOut className="w-5 h-5" />
          </button>
        </div>
      </header>

      <div className="flex">
        {/* Sidebar */}
        <motion.aside
          initial={{ x: -50, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ duration: 0.5 }}
          className="w-64 bg-pb-darker/30 backdrop-blur-sm border-r border-pb-primary/20 p-4 space-y-6 flex flex-col justify-between min-h-[80vh]"
        >
          <div>
            {/* Quick Actions */}
            <div>
              <h3 className="text-sm font-semibold text-pb-gray uppercase tracking-wider mb-3">
                Quick Actions
              </h3>
              <div className="space-y-2">
                {[
                  { icon: Home, text: 'Home', subtext: 'Dashboard overview', link: '/', gradient: 'from-pb-primary to-pb-secondary' },
                  { icon: Package, text: 'Props Inventory', subtext: 'Manage all production props', link: '/props', gradient: 'from-pb-blue to-pb-primary' },
                  { icon: Box, text: 'Packing Lists', subtext: 'packing & storage management', link: '/packing-lists', gradient: 'from-pb-green to-pb-primary' },
                  { icon: Theater, text: 'Show Management', subtext: 'Manage productions and venues', link: '/shows', gradient: 'from-pb-accent to-pb-primary' },
                  { icon: Calendar, text: 'Task Boards', subtext: 'Kanban-style to-do boards', link: '/boards', gradient: 'from-pb-orange to-pb-primary' },
                  { icon: FileText, text: 'Export Props PDF', subtext: 'Download props list as PDF', link: '/props/pdf-export' },
                  { icon: Zap, text: 'Shopping List', subtext: 'Track props and materials to buy', link: '/shopping'},
                  { icon: Bug, text: 'feedback/bugs', subtext: 'let us know any bugs or issues you are having', link: '/feedback'}
                ].map((item, index) => (
                  item.link ? (
                    <Link to={item.link} key={index} className="block">
                      <motion.div
                        variants={itemVariants}
                        initial="hidden"
                        animate="visible"
                        transition={{ delay: index * 0.1 }}
                        className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                      >
                        <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                          <item.icon className="w-4 h-4 text-white" />
                        </div>
                        <div>
                          <p className="text-sm font-medium text-white">{item.text}</p>
                          <p className="text-xs text-white/80">{item.subtext}</p>
                        </div>
                      </motion.div>
                    </Link>
                  ) : (
                    <motion.div
                      key={index}
                      variants={itemVariants}
                      initial="hidden"
                      animate="visible"
                      transition={{ delay: index * 0.1 }}
                      className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                    >
                      <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                        <item.icon className="w-4 h-4 text-white" />
                      </div>
                      <div>
                        <p className="text-sm font-medium text-white">{item.text}</p>
                        <p className="text-xs text-white/80">{item.subtext}</p>
                      </div>
                    </motion.div>
                  )
                ))}
              </div>
            </div>
          </div>
        
        </motion.aside>

        {/* Main Content */}
        <main className="flex-1 p-6 overflow-x-hidden">
          {children}
        </main>
      </div>
    </div>
  );
};

export default DashboardLayout; 
```

- Cleaned the header:
  - Removed the unused icons and animation variants.
  - Replaced the “Web Platform” pill with a placeholder link “Open App (Coming Soon)”.
  - Added profile avatar linking to `/profile`; removed the time.
- Updated `ProfilePage` to use a predefined Role dropdown and removed Organizations/Preferences.
- Fixed kanban details:
  - Collapsed list title centered and spacing adjusted.
  - FAB adds new list.
  - Rapid card add with Enter + close “×”.
  - Description editor styled to match container.
  - Card color persists and default gray gets a subtle border.

Everything lints clean.

---

**User**

on the shows page please remove the User UID: cdGLjU3n13gz72vT33KDBWCnDtf2
User Profile Source: /users/cdGLjU3n13gz72vT33KDBWCnDtf2
Firestore Rules Check: /userProfiles/cdGLjU3n13gz72vT33KDBWCnDtf2
Groups:
Role: propmakerUser UID: cdGLjU3n13gz72vT33KDBWCnDtf2
User Profile Source: /users/cdGLjU3n13gz72vT33KDBWCnDtf2
Firestore Rules Check: /userProfiles/cdGLjU3n13gz72vT33KDBWCnDtf2
Groups:
Role: propmaker 

---

**Cursor**

```typescriptreact
import React, { useState, useEffect } from 'react';
import DashboardLayout from './PropsBibleHomepage';
import { useWebAuth } from './contexts/WebAuthContext';
import { useFirebase, FirebaseContextType } from './contexts/FirebaseContext';
import type { Show } from '../types/Show.ts';
import { useNavigate } from 'react-router-dom';
import { Plus } from 'lucide-react';
import { useShowSelection } from './contexts/ShowSelectionContext';

const ShowsListPage: React.FC = () => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [shows, setShows] = useState<Show[]>([]);
  const { userProfile, user } = useWebAuth();
  const { service: firebaseService, isInitialized, error: firebaseInitError }: FirebaseContextType = useFirebase();
  const navigate = useNavigate();
  const { currentShowId, setCurrentShowId } = useShowSelection();

  useEffect(() => {
    if (!isInitialized) {
      setLoading(true);
      setError("Firebase not initialized.");
      return;
    }

    if (firebaseInitError) {
      setError(`Firebase Initialization Error: ${firebaseInitError.message}`);
      setLoading(false);
      return;
    }

    setLoading(true);
    setError(null);

    const unsubscribe = firebaseService.listenToCollection<Show>(
      'shows',
      (data) => {
        const showList = data.map(doc => ({ ...doc.data, id: doc.id }));
        setShows(showList);
        setLoading(false);
      },
      (err: Error) => {
        console.error("Error fetching shows:", err);
        setError(`Failed to load shows: ${err.message}. Please check your network connection and Firebase permissions.`);
        setLoading(false);
      }
    );

    return () => unsubscribe();
  }, [firebaseService, isInitialized, firebaseInitError]);

  const handleAddShow = () => {
    // TODO: Route to add show form
    alert('Add Show (not implemented)');
  };

  return (
    <DashboardLayout>
      {/* Debug info removed */}

      <div className="relative min-h-[70vh] flex flex-col justify-center items-center bg-gradient-to-br from-pb-primary/40 via-pb-darker/80 to-pb-accent/30 rounded-xl shadow-xl p-6">
        <div className="flex w-full justify-between items-center mb-6">
          <h2 className="text-2xl font-bold self-start">Shows List</h2>
          <button
            onClick={() => navigate('/shows/new')}
            className="flex items-center gap-2 px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white shadow transition focus:outline-none focus:ring-2 focus:ring-pb-primary/50"
            aria-label="Add New Show"
          >
            <Plus className="w-4 h-4" />
            <span className="hidden sm:inline">Add Show</span>
          </button>
        </div>
        {loading ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="animate-spin h-10 w-10 text-pb-primary mb-2" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" /><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z" /></svg>
            <div className="text-pb-gray mt-2">Loading shows...</div>
          </div>
        ) : error ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-red-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
            <div className="text-red-500 font-semibold">{error}</div>
          </div>
        ) : shows.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-64">
            <svg className="h-10 w-10 text-pb-gray mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7M3 7l9 6 9-6" /></svg>
            <div className="text-pb-gray">No shows found.</div>
          </div>
        ) : (
          <div className="w-full max-w-7xl mx-auto px-4">
            {shows.map((show) => (
              <div
                key={show.id}
                className={`bg-pb-darker/60 rounded-xl shadow-lg p-4 mb-4 cursor-pointer hover:bg-pb-primary/30 transition-colors${currentShowId === show.id ? ' border-2 border-pb-primary' : ''}`}
                onClick={() => navigate(`/shows/${show.id}`)}
                tabIndex={0}
                role="button"
                aria-label={`View details for ${show.name}`}
                onKeyDown={e => { if (e.key === 'Enter' || e.key === ' ') navigate(`/shows/${show.id}`); }}
              >
                <div className="flex justify-between items-center">
                  <div>
                    <div className="font-bold text-lg text-white mb-1">{show.name}</div>
                    {show.description && <div className="text-pb-gray text-sm mb-1 line-clamp-2">{show.description}</div>}
                    <div className="text-xs text-pb-primary/80">
                      {show.startDate && (
                        <span>Start: {show.startDate.toDate ? show.startDate.toDate().toLocaleDateString() : String(show.startDate)}</span>
                      )}
                      {show.endDate && (
                        <span className="ml-4">End: {show.endDate.toDate ? show.endDate.toDate().toLocaleDateString() : String(show.endDate)}</span>
                      )}
                    </div>
                  </div>
                  <button
                    type="button"
                    onClick={e => { e.stopPropagation(); setCurrentShowId(show.id); }}
                    className={`ml-4 px-3 py-1 rounded ${currentShowId === show.id ? 'bg-pb-primary text-white' : 'bg-pb-primary/20 text-pb-primary hover:bg-pb-primary/40'} font-semibold text-xs transition`}
                    aria-label={currentShowId === show.id ? 'Current Show' : 'Select Show'}
                  >
                    {currentShowId === show.id ? 'Selected' : 'Select'}
                  </button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </DashboardLayout>
  );
};

export default ShowsListPage; 
```

---

**User**

lets make the show title in the heade white as its not currenly readable

---

**Cursor**

```typescriptreact
import React from 'react';
import { motion } from 'framer-motion';
import { Box, Bug, Calendar, FileText, Home, LogOut, Package, Theater, Zap } from 'lucide-react';
import { useWebAuth } from './contexts/WebAuthContext';
import { Link, useNavigate } from 'react-router-dom';
import { useShowSelection } from "./contexts/ShowSelectionContext";
import type { Show } from "./types/Show";
import { useFirebase } from "./contexts/FirebaseContext";

const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: {
      duration: 0.5
    }
  }
};

type DashboardLayoutProps = {
  children: React.ReactNode;
};

const DashboardLayout: React.FC<DashboardLayoutProps> = ({ children }) => {
  const { userProfile, signOut } = useWebAuth();
  const navigate = useNavigate();
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [showTitle, setShowTitle] = React.useState<string>("");

  // removed ticking clock

  React.useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // header metadata simplified (no time)

  const handleSignOut = async () => {
    await signOut();
    navigate('/login');
  };

  return (
    <div className="min-h-screen bg-gradient-dark text-white">
      {/* Header */}
      <header className="flex items-center justify-between px-6 py-4 bg-pb-darker/50 backdrop-blur-sm border-b border-pb-primary/20">
        <div className="flex items-center space-x-4">
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-pb-primary rounded-lg flex items-center justify-center">
              <Theater className="w-5 h-5 text-white" />
            </div>
            <div>
              <h1 className="text-lg font-bold text-white">Props Bible</h1>
              <p className="text-xs text-pb-gray">Theater Props Management</p>
            </div>
          </div>
          <Link
            to="#"
            onClick={(e) => { e.preventDefault(); alert('Mobile app coming soon'); }}
            className="bg-pb-primary/20 text-pb-primary px-3 py-1 rounded-full text-xs font-medium hover:bg-pb-primary/30"
            title="Open mobile app (coming soon)"
          >
            Open App (Coming Soon)
          </Link>
        </div>
        <div className="flex-1 flex flex-col items-center">
          <span className="text-white text-lg font-semibold">
            {showTitle || "No show selected"}
          </span>
        </div>
        <div className="flex items-center space-x-4">
          {userProfile?.displayName && (
            <span className="text-sm text-pb-gray">Welcome, {userProfile.displayName}</span>
          )}
          <Link to="/profile" className="block">
            <img
              src={userProfile?.photoURL || '/public/icon.png'}
              alt="Profile"
              className="w-8 h-8 rounded-full border border-pb-primary/40 object-cover"
            />
          </Link>
          <button
            onClick={handleSignOut}
            className="ml-2 flex items-center px-2 py-1 rounded hover:bg-pb-primary/20 transition-colors text-pb-gray hover:text-white focus:outline-none"
            title="Log out"
            aria-label="Log out"
          >
            <LogOut className="w-5 h-5" />
          </button>
        </div>
      </header>

      <div className="flex">
        {/* Sidebar */}
        <motion.aside
          initial={{ x: -50, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ duration: 0.5 }}
          className="w-64 bg-pb-darker/30 backdrop-blur-sm border-r border-pb-primary/20 p-4 space-y-6 flex flex-col justify-between min-h-[80vh]"
        >
          <div>
            {/* Quick Actions */}
            <div>
              <h3 className="text-sm font-semibold text-pb-gray uppercase tracking-wider mb-3">
                Quick Actions
              </h3>
              <div className="space-y-2">
                {[
                  { icon: Home, text: 'Home', subtext: 'Dashboard overview', link: '/', gradient: 'from-pb-primary to-pb-secondary' },
                  { icon: Package, text: 'Props Inventory', subtext: 'Manage all production props', link: '/props', gradient: 'from-pb-blue to-pb-primary' },
                  { icon: Box, text: 'Packing Lists', subtext: 'packing & storage management', link: '/packing-lists', gradient: 'from-pb-green to-pb-primary' },
                  { icon: Theater, text: 'Show Management', subtext: 'Manage productions and venues', link: '/shows', gradient: 'from-pb-accent to-pb-primary' },
                  { icon: Calendar, text: 'Task Boards', subtext: 'Kanban-style to-do boards', link: '/boards', gradient: 'from-pb-orange to-pb-primary' },
                  { icon: FileText, text: 'Export Props PDF', subtext: 'Download props list as PDF', link: '/props/pdf-export' },
                  { icon: Zap, text: 'Shopping List', subtext: 'Track props and materials to buy', link: '/shopping'},
                  { icon: Bug, text: 'feedback/bugs', subtext: 'let us know any bugs or issues you are having', link: '/feedback'}
                ].map((item, index) => (
                  item.link ? (
                    <Link to={item.link} key={index} className="block">
                      <motion.div
                        variants={itemVariants}
                        initial="hidden"
                        animate="visible"
                        transition={{ delay: index * 0.1 }}
                        className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                      >
                        <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                          <item.icon className="w-4 h-4 text-white" />
                        </div>
                        <div>
                          <p className="text-sm font-medium text-white">{item.text}</p>
                          <p className="text-xs text-white/80">{item.subtext}</p>
                        </div>
                      </motion.div>
                    </Link>
                  ) : (
                    <motion.div
                      key={index}
                      variants={itemVariants}
                      initial="hidden"
                      animate="visible"
                      transition={{ delay: index * 0.1 }}
                      className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                    >
                      <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                        <item.icon className="w-4 h-4 text-white" />
                      </div>
                      <div>
                        <p className="text-sm font-medium text-white">{item.text}</p>
                        <p className="text-xs text-white/80">{item.subtext}</p>
                      </div>
                    </motion.div>
                  )
                ))}
              </div>
            </div>
          </div>
        
        </motion.aside>

        {/* Main Content */}
        <main className="flex-1 p-6 overflow-x-hidden">
          {children}
        </main>
      </div>
    </div>
  );
};

export default DashboardLayout; 
```

- Updated the show title color in the header to white for better readability.
- File updated: `web-app/src/PropsBibleHomepage.tsx`

---

**User**

also the title of the app is currently props bible and it should be The Props List

---

**Cursor**

```typescriptreact
import React from 'react';
import { motion } from 'framer-motion';
import { Box, Bug, Calendar, FileText, Home, LogOut, Package, Theater, Zap } from 'lucide-react';
import { useWebAuth } from './contexts/WebAuthContext';
import { Link, useNavigate } from 'react-router-dom';
import { useShowSelection } from "./contexts/ShowSelectionContext";
import type { Show } from "./types/Show";
import { useFirebase } from "./contexts/FirebaseContext";

const itemVariants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: {
      duration: 0.5
    }
  }
};

type DashboardLayoutProps = {
  children: React.ReactNode;
};

const DashboardLayout: React.FC<DashboardLayoutProps> = ({ children }) => {
  const { userProfile, signOut } = useWebAuth();
  const navigate = useNavigate();
  const { currentShowId } = useShowSelection();
  const { service } = useFirebase();
  const [showTitle, setShowTitle] = React.useState<string>("");

  // removed ticking clock

  React.useEffect(() => {
    if (!currentShowId) {
      setShowTitle("");
      return;
    }
    let unsub: (() => void) | undefined;
    unsub = service.listenToDocument<Show>(
      `shows/${currentShowId}`,
      doc => setShowTitle(doc.data?.name || ""),
      () => setShowTitle("")
    );
    return () => { if (unsub) unsub(); };
  }, [service, currentShowId]);

  // header metadata simplified (no time)

  const handleSignOut = async () => {
    await signOut();
    navigate('/login');
  };

  return (
    <div className="min-h-screen bg-gradient-dark text-white">
      {/* Header */}
      <header className="flex items-center justify-between px-6 py-4 bg-pb-darker/50 backdrop-blur-sm border-b border-pb-primary/20">
        <div className="flex items-center space-x-4">
          <div className="flex items-center space-x-2">
            <div className="w-8 h-8 bg-pb-primary rounded-lg flex items-center justify-center">
              <Theater className="w-5 h-5 text-white" />
            </div>
            <div>
              <h1 className="text-lg font-bold text-white">The Props List</h1>
              <p className="text-xs text-pb-gray">Theater Props Management</p>
            </div>
          </div>
          <Link
            to="#"
            onClick={(e) => { e.preventDefault(); alert('Mobile app coming soon'); }}
            className="bg-pb-primary/20 text-pb-primary px-3 py-1 rounded-full text-xs font-medium hover:bg-pb-primary/30"
            title="Open mobile app (coming soon)"
          >
            Open App (Coming Soon)
          </Link>
        </div>
        <div className="flex-1 flex flex-col items-center">
          <span className="text-white text-lg font-semibold">
            {showTitle || "No show selected"}
          </span>
        </div>
        <div className="flex items-center space-x-4">
          {userProfile?.displayName && (
            <span className="text-sm text-pb-gray">Welcome, {userProfile.displayName}</span>
          )}
          <Link to="/profile" className="block">
            <img
              src={userProfile?.photoURL || '/public/icon.png'}
              alt="Profile"
              className="w-8 h-8 rounded-full border border-pb-primary/40 object-cover"
            />
          </Link>
          <button
            onClick={handleSignOut}
            className="ml-2 flex items-center px-2 py-1 rounded hover:bg-pb-primary/20 transition-colors text-pb-gray hover:text-white focus:outline-none"
            title="Log out"
            aria-label="Log out"
          >
            <LogOut className="w-5 h-5" />
          </button>
        </div>
      </header>

      <div className="flex">
        {/* Sidebar */}
        <motion.aside
          initial={{ x: -50, opacity: 0 }}
          animate={{ x: 0, opacity: 1 }}
          transition={{ duration: 0.5 }}
          className="w-64 bg-pb-darker/30 backdrop-blur-sm border-r border-pb-primary/20 p-4 space-y-6 flex flex-col justify-between min-h-[80vh]"
        >
          <div>
            {/* Quick Actions */}
            <div>
              <h3 className="text-sm font-semibold text-pb-gray uppercase tracking-wider mb-3">
                Quick Actions
              </h3>
              <div className="space-y-2">
                {[
                  { icon: Home, text: 'Home', subtext: 'Dashboard overview', link: '/', gradient: 'from-pb-primary to-pb-secondary' },
                  { icon: Package, text: 'Props Inventory', subtext: 'Manage all production props', link: '/props', gradient: 'from-pb-blue to-pb-primary' },
                  { icon: Box, text: 'Packing Lists', subtext: 'packing & storage management', link: '/packing-lists', gradient: 'from-pb-green to-pb-primary' },
                  { icon: Theater, text: 'Show Management', subtext: 'Manage productions and venues', link: '/shows', gradient: 'from-pb-accent to-pb-primary' },
                  { icon: Calendar, text: 'Task Boards', subtext: 'Kanban-style to-do boards', link: '/boards', gradient: 'from-pb-orange to-pb-primary' },
                  { icon: FileText, text: 'Export Props PDF', subtext: 'Download props list as PDF', link: '/props/pdf-export' },
                  { icon: Zap, text: 'Shopping List', subtext: 'Track props and materials to buy', link: '/shopping'},
                  { icon: Bug, text: 'feedback/bugs', subtext: 'let us know any bugs or issues you are having', link: '/feedback'}
                ].map((item, index) => (
                  item.link ? (
                    <Link to={item.link} key={index} className="block">
                      <motion.div
                        variants={itemVariants}
                        initial="hidden"
                        animate="visible"
                        transition={{ delay: index * 0.1 }}
                        className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                      >
                        <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                          <item.icon className="w-4 h-4 text-white" />
                        </div>
                        <div>
                          <p className="text-sm font-medium text-white">{item.text}</p>
                          <p className="text-xs text-white/80">{item.subtext}</p>
                        </div>
                      </motion.div>
                    </Link>
                  ) : (
                    <motion.div
                      key={index}
                      variants={itemVariants}
                      initial="hidden"
                      animate="visible"
                      transition={{ delay: index * 0.1 }}
                      className={`flex items-center space-x-3 p-3 rounded-lg bg-gradient-to-r ${item.gradient} hover:opacity-90 transition-colors cursor-pointer group`}
                    >
                      <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center group-hover:bg-white/30 transition-colors">
                        <item.icon className="w-4 h-4 text-white" />
                      </div>
                      <div>
                        <p className="text-sm font-medium text-white">{item.text}</p>
                        <p className="text-xs text-white/80">{item.subtext}</p>
                      </div>
                    </motion.div>
                  )
                ))}
              </div>
            </div>
          </div>
        
        </motion.aside>

        {/* Main Content */}
        <main className="flex-1 p-6 overflow-x-hidden">
          {children}
        </main>
      </div>
    </div>
  );
};

export default DashboardLayout; 
```

- Renamed the app title in the header to “The Props List”.
- File updated: `web-app/src/PropsBibleHomepage.tsx`

---

**User**

ok lets look at the edit a prop form the current list of statuses as they are not correct lets make them: 'to be made','part of the show', share, replacment needed, needs repair/mod, cut and on hold.

---

**Cursor**

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories } from '../../shared/types/props';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const EditPropPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setForm(doc?.data as PropFormData || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form?.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form?.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => prev ? { ...prev, [name]: type === 'number' ? Number(value) : value } : prev);
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form || !id) return;
    setSaving(true);
    setError(null);
    try {
      await firebaseService.updateDocument('props', id, form);
      setSaving(false);
      navigate(`/props/${id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to update prop.');
      setSaving(false);
    }
  };

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !form) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Edit Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={(form.price ?? 0)} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
            <div className="md:col-span-3">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
                <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Location</label>
                <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
                <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            </div>
            {/* Add more fields as needed for full prop coverage */}
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => prev ? { ...prev, images: imgs } : prev)}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => prev ? { ...prev, digitalAssets: assets } : prev)}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Save Changes'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default EditPropPage; 
```

```typescriptreact
import React, { useState, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories, PropCategory, PropImage, DigitalAsset } from '../../shared/types/props';
import { Plus, UploadCloud, Trash2 } from 'lucide-react';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const initialForm: PropFormData = {
  name: '',
  price: 0,
  description: '',
  category: propCategories[0],
  quantity: 1,
  source: 'bought',
  status: 'available_in_storage',
  images: [],
  digitalAssets: [],
  showId: '',
};

const AddPropPage: React.FC = () => {
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData>(initialForm);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      await firebaseService.addDocument('props', form);
      setSaving(false);
      navigate('/props');
    } catch (err: any) {
      setError(err.message || 'Failed to add prop.');
      setSaving(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Add Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
              </select>
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => ({ ...prev, images: imgs }))}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => ({ ...prev, digitalAssets: assets }))}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Add Prop'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default AddPropPage; 
```

- Updated the prop Status options in both forms to your list:
  - to be made
  - part of the show
  - share
  - replacment needed
  - needs repair/mod
  - cut
  - on hold

Files changed:
- `web-app/src/pages/EditPropPage.tsx`
- `web-app/src/pages/AddPropPage.tsx`

---

**User**

lets add a awaiting delivery status too

lets add a to be bought status.

---

**Cursor**

```typescriptreact
import React, { useState, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories, PropCategory, PropImage, DigitalAsset } from '../../shared/types/props';
import { Plus, UploadCloud, Trash2 } from 'lucide-react';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const initialForm: PropFormData = {
  name: '',
  price: 0,
  description: '',
  category: propCategories[0],
  quantity: 1,
  source: 'bought',
  status: 'available_in_storage',
  images: [],
  digitalAssets: [],
  showId: '',
};

const AddPropPage: React.FC = () => {
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData>(initialForm);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      await firebaseService.addDocument('props', form);
      setSaving(false);
      navigate('/props');
    } catch (err: any) {
      setError(err.message || 'Failed to add prop.');
      setSaving(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Add Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
              </select>
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => ({ ...prev, images: imgs }))}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => ({ ...prev, digitalAssets: assets }))}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Add Prop'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default AddPropPage; 
```

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories } from '../../shared/types/props';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const EditPropPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setForm(doc?.data as PropFormData || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form?.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form?.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => prev ? { ...prev, [name]: type === 'number' ? Number(value) : value } : prev);
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form || !id) return;
    setSaving(true);
    setError(null);
    try {
      await firebaseService.updateDocument('props', id, form);
      setSaving(false);
      navigate(`/props/${id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to update prop.');
      setSaving(false);
    }
  };

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !form) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Edit Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={(form.price ?? 0)} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
            <div className="md:col-span-3">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
                <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Location</label>
                <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
                <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            </div>
            {/* Add more fields as needed for full prop coverage */}
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => prev ? { ...prev, images: imgs } : prev)}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => prev ? { ...prev, digitalAssets: assets } : prev)}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Save Changes'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default EditPropPage; 
```

- Added two new statuses to the prop forms:
  - “to be bought”
  - “awaiting delivery”
- Updated both add and edit forms so the full set is:
  - to be made, to be bought, awaiting delivery, part of the show, share, replacment needed, needs repair/mod, cut, on hold

Files updated:
- `web-app/src/pages/AddPropPage.tsx`
- `web-app/src/pages/EditPropPage.tsx`

---

**User**

when i go to add a prop i get a no prop found error

---

**Cursor**

```typescriptreact
import React from 'react';
import PropsBibleHomepage from './PropsBibleHomepage';
import PropsListPage from './PropsListPage';
import DashboardHome from './DashboardHome';
import ShowsListPage from './ShowsListPage';
import './index.css';
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import Login from './pages/Login';
import Signup from './pages/Signup';
import ForgotPassword from './pages/ForgotPassword';
import { useWebAuth } from './contexts/WebAuthContext';
import ShowDetailPage from './pages/ShowDetailPage';
import AddShowPage from './pages/AddShowPage';
import EditShowPage from './pages/EditShowPage';
import { ShowSelectionProvider } from './contexts/ShowSelectionContext';
import PropDetailPage from './pages/PropDetailPage';
import EditPropPage from './pages/EditPropPage';
import AddPropPage from './pages/AddPropPage';
import BoardsPage from './pages/BoardsPage';
import PackingListPage from './pages/PackingListPage';
import PackingListDetailPage from './pages/PackingListDetailPage';
import PropsPdfExportPage from './pages/PropsPdfExportPage';
import ShoppingListPage from './pages/ShoppingListPage';
import ProfilePage from './pages/ProfilePage';
import FeedbackPage from './pages/FeedbackPage';

function App() {
  const { user, loading } = useWebAuth();
  if (loading) {
    return <div className="flex items-center justify-center min-h-screen text-white text-xl">Loading...</div>;
  }
  return (
    <ShowSelectionProvider>
      <BrowserRouter>
        <Routes>
          <Route path="/login" element={!user ? <Login /> : <Navigate to="/" replace />} />
          <Route path="/signup" element={!user ? <Signup /> : <Navigate to="/" replace />} />
          <Route path="/forgot-password" element={!user ? <ForgotPassword /> : <Navigate to="/" replace />} />
          <Route path="/props/pdf-export" element={user ? <PropsPdfExportPage /> : <Navigate to="/login" replace />} />
          <Route path="/props/:id/edit" element={user ? <EditPropPage /> : <Navigate to="/login" replace />} />
          <Route path="/props/add" element={user ? <AddPropPage /> : <Navigate to="/login" replace />} />
          <Route path="/props/:id" element={user ? <PropDetailPage /> : <Navigate to="/login" replace />} />
          <Route path="/props" element={user ? <PropsListPage /> : <Navigate to="/login" replace />} />
          <Route path="/" element={user ? <DashboardHome /> : <Navigate to="/login" replace />} />
          <Route path="/shows" element={<ShowsListPage />} />
          <Route path="/shows/new" element={<AddShowPage />} />
          <Route path="/shows/:id/edit" element={<EditShowPage />} />
          <Route path="/shows/:id" element={<ShowDetailPage />} />
          <Route path="/boards" element={user ? <BoardsPage /> : <Navigate to="/login" replace />} />
          <Route path="/packing-lists" element={user ? <PackingListPage /> : <Navigate to="/login" replace />} />
          <Route path="/packing-lists/:packListId" element={user ? <PackingListDetailPage /> : <Navigate to="/login" replace />} />
          <Route path="/shopping" element={user ? <ShoppingListPage /> : <Navigate to="/login" replace />} />
          <Route path="/profile" element={user ? <ProfilePage /> : <Navigate to="/login" replace />} />
          <Route path="/feedback" element={user ? <FeedbackPage /> : <Navigate to="/login" replace />} />
          <Route path="/*" element={user ? <PropsBibleHomepage>{<DashboardHome />}</PropsBibleHomepage> : <Navigate to="/login" replace />} />
        </Routes>
      </BrowserRouter>
    </ShowSelectionProvider>
  );
}

export default App; 
```

- Added a route for the add prop page so it opens correctly:
  - Route: `/props/add` now renders `AddPropPage` for logged-in users.
- File updated: `web-app/src/App.tsx`

Try the “Add Prop” flow again via `/props/add` or the “+” link/button that points there. If you still see “prop not found,” tell me the exact navigation path you used so I can wire that link too.

---

**User**

ok there seems to be some fields missing from the add and edit props forms

---

**Cursor**

I’m going to scan the add and edit prop pages and the prop type to identify which fields are present and which are missing, then make edits to bring them to parity.

I’m going to add the missing fields (Price, Source, Purchase URL, Location, Current Location, Tags) to both the add and edit prop forms, then run a TypeScript build to ensure no errors.

```typescriptreact
import React, { useState, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories, PropCategory, PropImage, DigitalAsset } from '../../shared/types/props';
import { Plus, UploadCloud, Trash2 } from 'lucide-react';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const initialForm: PropFormData = {
  name: '',
  price: 0,
  description: '',
  category: propCategories[0],
  quantity: 1,
  source: 'bought',
  status: 'available_in_storage',
  images: [],
  digitalAssets: [],
  showId: '',
};

const AddPropPage: React.FC = () => {
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData>(initialForm);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
  };

  const handleTagsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const tags = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => ({ ...prev, tags }));
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      await firebaseService.addDocument('props', form);
      setSaving(false);
      navigate('/props');
    } catch (err: any) {
      setError(err.message || 'Failed to add prop.');
      setSaving(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Add Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={form.price ?? 0} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
                <option value="owned">Owned</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
                <option value="available_in_storage">available in storage</option>
              </select>
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
              <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Location</label>
              <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
              <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Tags (comma separated)</label>
              <input
                name="tagsInput"
                value={(form.tags && form.tags.length > 0) ? form.tags.join(', ') : ''}
                onChange={handleTagsChange}
                placeholder="e.g., weapon, medieval, stage-left"
                className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
              />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => ({ ...prev, images: imgs }))}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => ({ ...prev, digitalAssets: assets }))}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Add Prop'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default AddPropPage; 
```

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories } from '../../shared/types/props';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const EditPropPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setForm(doc?.data as PropFormData || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form?.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form?.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => prev ? { ...prev, [name]: type === 'number' ? Number(value) : value } : prev);
  };

  const handleTagsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const tags = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => prev ? { ...prev, tags } : prev);
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form || !id) return;
    setSaving(true);
    setError(null);
    try {
      await firebaseService.updateDocument('props', id, form);
      setSaving(false);
      navigate(`/props/${id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to update prop.');
      setSaving(false);
    }
  };

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !form) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Edit Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={(form.price ?? 0)} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
                <option value="available_in_storage">available in storage</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
                <option value="owned">Owned</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
            <div className="md:col-span-3">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
                <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Location</label>
                <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
                <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div className="md:col-span-3">
                <label className="block text-pb-gray mb-1 font-medium">Tags (comma separated)</label>
                <input
                  name="tagsInput"
                  value={(form.tags && form.tags.length > 0) ? form.tags.join(', ') : ''}
                  onChange={handleTagsChange}
                  placeholder="e.g., weapon, medieval, stage-left"
                  className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                />
              </div>
            </div>
            {/* Add more fields as needed for full prop coverage */}
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => prev ? { ...prev, images: imgs } : prev)}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => prev ? { ...prev, digitalAssets: assets } : prev)}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Save Changes'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default EditPropPage; 
```

I’m going to quickly scan the file system to confirm where the shared types live and ensure the add/edit pages import from the correct path, then adjust imports or fields as needed. After that, I’ll run a build to verify.

- I added the missing fields to both forms.
  - AddProp: Price, Source, Purchase URL, Location, Current Location, Tags (comma-separated).
  - EditProp: ensured the same fields are present; added Tags input.
  - Status dropdowns also include “available in storage” (the default).

These save with the rest of the form data. If you need more (e.g., dimensions, weight, manufacturer, serial, etc.), list them and I’ll add those too.

---

**User**

can you review the add prop form here @create.tsx  this should be what the web from is like with the same inputfields. do not change anything outside of the web-app folder.

---

**Cursor**

I’m going to inspect the native form component used in the mobile app to mirror its fields on the web add prop page, then update `web-app/src/pages/AddPropPage.tsx` accordingly.

```typescriptreact
import React, { useState, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories, PropCategory, PropImage, DigitalAsset } from '../../shared/types/props';
import { Plus, UploadCloud, Trash2 } from 'lucide-react';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const initialForm: PropFormData = {
  name: '',
  price: 0,
  description: '',
  category: propCategories[0],
  quantity: 1,
  source: 'bought',
  status: 'available_in_storage',
  images: [],
  digitalAssets: [],
  showId: '',
  // Additional fields to mirror mobile create form
  condition: '',
  location: '',
  currentLocation: '',
  statusNotes: '',
  isConsumable: false,
  requiresPreShowSetup: false,
  isBreakable: false,
  hasUsageInstructions: false,
  usageInstructions: '',
  hasMaintenanceNotes: false,
  maintenanceNotes: '',
  hasSafetyNotes: false,
  safetyNotes: '',
  hasOwnShippingCrate: false,
  requiresSpecialTransport: false,
  hasBeenModified: false,
  length: undefined,
  width: undefined,
  height: undefined,
  weight: undefined,
  materials: [],
  period: '',
};

const AddPropPage: React.FC = () => {
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData>(initialForm);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
  };

  const handleTagsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const tags = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => ({ ...prev, tags }));
  };

  const handleMaterialsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const materials = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => ({ ...prev, materials }));
  };

  const handleToggle = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, checked } = e.target;
    setForm(prev => ({ ...prev, [name]: checked } as PropFormData));
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      await firebaseService.addDocument('props', form);
      setSaving(false);
      navigate('/props');
    } catch (err: any) {
      setError(err.message || 'Failed to add prop.');
      setSaving(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Add Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={form.price ?? 0} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
                <option value="owned">Owned</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
                <option value="available_in_storage">available in storage</option>
              </select>
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Condition</label>
              <input name="condition" value={form.condition || ''} onChange={handleChange} placeholder="e.g., New, Used, Needs Repair" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
              <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Location</label>
              <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
              <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            {/* Dimensions & Weight */}
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Length</label>
              <input name="length" type="number" step="0.01" value={form.length ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Width</label>
              <input name="width" type="number" step="0.01" value={form.width ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Height</label>
              <input name="height" type="number" step="0.01" value={form.height ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Weight</label>
              <input name="weight" type="number" step="0.01" value={form.weight ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            {/* Materials & Period */}
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Materials (comma-separated)</label>
              <input name="materialsInput" value={(form.materials && form.materials.length > 0) ? form.materials.join(', ') : ''} onChange={handleMaterialsChange} placeholder="e.g., Wood, Metal, Plastic" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Historical Period</label>
              <input name="period" value={form.period || ''} onChange={handleChange} placeholder="e.g., Victorian, 1920s" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Tags (comma separated)</label>
              <input
                name="tagsInput"
                value={(form.tags && form.tags.length > 0) ? form.tags.join(', ') : ''}
                onChange={handleTagsChange}
                placeholder="e.g., weapon, medieval, stage-left"
                className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
              />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
          </div>
          {/* Details & Flags */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isConsumable" checked={!!form.isConsumable} onChange={handleToggle} />
              <span>Consumable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresPreShowSetup" checked={!!form.requiresPreShowSetup} onChange={handleToggle} />
              <span>Requires Pre-Show Setup</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isBreakable" checked={!!form.isBreakable} onChange={handleToggle} />
              <span>Breakable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasOwnShippingCrate" checked={!!form.hasOwnShippingCrate} onChange={handleToggle} />
              <span>Has Dedicated Shipping Crate</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresSpecialTransport" checked={!!form.requiresSpecialTransport} onChange={handleToggle} />
              <span>Requires Special Transport</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasBeenModified" checked={!!form.hasBeenModified} onChange={handleToggle} />
              <span>Has Been Modified</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasUsageInstructions" checked={!!form.hasUsageInstructions} onChange={handleToggle} />
              <span>Add Usage Instructions</span>
            </label>
            {form.hasUsageInstructions && (
              <div className="md:col-span-2">
                <textarea name="usageInstructions" value={form.usageInstructions || ''} onChange={handleChange} rows={3} placeholder="Enter usage instructions" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasMaintenanceNotes" checked={!!form.hasMaintenanceNotes} onChange={handleToggle} />
              <span>Add Maintenance Notes</span>
            </label>
            {form.hasMaintenanceNotes && (
              <div className="md:col-span-2">
                <textarea name="maintenanceNotes" value={form.maintenanceNotes || ''} onChange={handleChange} rows={3} placeholder="Enter maintenance notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasSafetyNotes" checked={!!form.hasSafetyNotes} onChange={handleToggle} />
              <span>Add Safety Notes</span>
            </label>
            {form.hasSafetyNotes && (
              <div className="md:col-span-2">
                <textarea name="safetyNotes" value={form.safetyNotes || ''} onChange={handleChange} rows={3} placeholder="Enter safety notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">General Notes</label>
              <textarea name="notes" value={(form as any).notes || ''} onChange={handleChange} rows={3} placeholder="Enter any other notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => ({ ...prev, images: imgs }))}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => ({ ...prev, digitalAssets: assets }))}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Add Prop'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default AddPropPage; 
```

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories } from '../../shared/types/props';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const EditPropPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setForm(doc?.data as PropFormData || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form?.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form?.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => prev ? { ...prev, [name]: type === 'number' ? Number(value) : value } : prev);
  };

  const handleTagsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const tags = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => prev ? { ...prev, tags } : prev);
  };

  const handleMaterialsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const materials = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => prev ? { ...prev, materials } : prev);
  };

  const handleToggle = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, checked } = e.target;
    setForm(prev => prev ? { ...prev, [name]: checked } : prev);
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form || !id) return;
    setSaving(true);
    setError(null);
    try {
      await firebaseService.updateDocument('props', id, form);
      setSaving(false);
      navigate(`/props/${id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to update prop.');
      setSaving(false);
    }
  };

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !form) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Edit Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={(form.price ?? 0)} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
                <option value="available_in_storage">available in storage</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
                <option value="owned">Owned</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
            <div className="md:col-span-3">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
                <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Location</label>
                <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
                <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Condition</label>
                <input name="condition" value={form.condition || ''} onChange={handleChange} placeholder="e.g., New, Used, Needs Repair" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Length</label>
                <input name="length" type="number" step="0.01" value={form.length ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Width</label>
                <input name="width" type="number" step="0.01" value={form.width ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Height</label>
                <input name="height" type="number" step="0.01" value={form.height ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Weight</label>
                <input name="weight" type="number" step="0.01" value={form.weight ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div className="md:col-span-3">
                <label className="block text-pb-gray mb-1 font-medium">Materials (comma-separated)</label>
                <input
                  name="materialsInput"
                  value={(form.materials && form.materials.length > 0) ? form.materials.join(', ') : ''}
                  onChange={handleMaterialsChange}
                  placeholder="e.g., Wood, Metal, Plastic"
                  className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Historical Period</label>
                <input name="period" value={form.period || ''} onChange={handleChange} placeholder="e.g., Victorian, 1920s" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div className="md:col-span-3">
                <label className="block text-pb-gray mb-1 font-medium">Tags (comma separated)</label>
                <input
                  name="tagsInput"
                  value={(form.tags && form.tags.length > 0) ? form.tags.join(', ') : ''}
                  onChange={handleTagsChange}
                  placeholder="e.g., weapon, medieval, stage-left"
                  className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                />
              </div>
            </div>
            {/* Add more fields as needed for full prop coverage */}
          </div>
          {/* Details & Flags */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isConsumable" checked={!!form.isConsumable} onChange={handleToggle} />
              <span>Consumable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresPreShowSetup" checked={!!form.requiresPreShowSetup} onChange={handleToggle} />
              <span>Requires Pre-Show Setup</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isBreakable" checked={!!form.isBreakable} onChange={handleToggle} />
              <span>Breakable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasOwnShippingCrate" checked={!!form.hasOwnShippingCrate} onChange={handleToggle} />
              <span>Has Dedicated Shipping Crate</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresSpecialTransport" checked={!!form.requiresSpecialTransport} onChange={handleToggle} />
              <span>Requires Special Transport</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasBeenModified" checked={!!form.hasBeenModified} onChange={handleToggle} />
              <span>Has Been Modified</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasUsageInstructions" checked={!!form.hasUsageInstructions} onChange={handleToggle} />
              <span>Add Usage Instructions</span>
            </label>
            {form.hasUsageInstructions && (
              <div className="md:col-span-2">
                <textarea name="usageInstructions" value={form.usageInstructions || ''} onChange={handleChange} rows={3} placeholder="Enter usage instructions" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasMaintenanceNotes" checked={!!form.hasMaintenanceNotes} onChange={handleToggle} />
              <span>Add Maintenance Notes</span>
            </label>
            {form.hasMaintenanceNotes && (
              <div className="md:col-span-2">
                <textarea name="maintenanceNotes" value={form.maintenanceNotes || ''} onChange={handleChange} rows={3} placeholder="Enter maintenance notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasSafetyNotes" checked={!!form.hasSafetyNotes} onChange={handleToggle} />
              <span>Add Safety Notes</span>
            </label>
            {form.hasSafetyNotes && (
              <div className="md:col-span-2">
                <textarea name="safetyNotes" value={form.safetyNotes || ''} onChange={handleChange} rows={3} placeholder="Enter safety notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">General Notes</label>
              <textarea name="notes" value={(form as any).notes || ''} onChange={handleChange} rows={3} placeholder="Enter any other notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => prev ? { ...prev, images: imgs } : prev)}
              currentImages={form.images || []}
              disabled={saving}
            />
            <DigitalAssetForm
              assets={form.digitalAssets || []}
              onChange={assets => setForm(prev => prev ? { ...prev, digitalAssets: assets } : prev)}
              disabled={saving}
            />
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Save Changes'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default EditPropPage; 
```

- Mirrored the mobile create form’s fields onto the web add/edit forms without touching anything outside `web-app`.
- Added to `web-app/src/pages/AddPropPage.tsx`:
  - New inputs: condition, materials (comma-separated), historical period, length, width, height, weight, notes.
  - Checkboxes/conditional textareas: usage instructions, maintenance notes, safety notes, consumable, pre-show setup required, breakable, own shipping crate, special transport, has been modified.
  - Kept price, source, purchase URL, location, current location, tags, quantity, category, status, description, act/scene, images, digital assets.
- Updated `web-app/src/pages/EditPropPage.tsx` with the same fields for parity.

If you want the lifecycle status picker to match mobile’s exact set and labels, I can swap the status dropdown to use the shared lifecycle statuses and labels.

---

**User**

the add usage , add maintanance should also allow for images and video to be added

---

**Cursor**

```typescript
import { PropLifecycleStatus, MaintenanceRecord, PropStatusUpdate, RepairPriority } from '../../types/lifecycle.ts';
import { FirebaseFirestoreTypes, Timestamp } from '@react-native-firebase/firestore';
import { Address } from './address.ts';

// Re-export master types from src/types/index.ts
export type { Show, Act, Scene, Venue, Contact, ShowCollaborator, ShowFormData } from '../../types/index.ts';

// Re-export the type needed by PropForm using 'export type'
export type { PropLifecycleStatus };

export type PropSource = 'bought' | 'made' | 'rented' | 'borrowed' | 'owned' | 'created';
export type WeightUnit = 'kg' | 'lb' | 'g' | 'oz';
export type DimensionUnit = 'cm' | 'in' | 'm' | 'ft';

export interface PropImage {
  id: string;
  url: string;
  caption?: string;
  isMain?: boolean;
}

export interface DigitalAsset {
  id: string;
  name: string;
  title?: string;
  url: string;
  type: 'image' | 'video' | 'document' | 'other';
}

export const propCategories = [
  'Furniture',
  'Decoration',
  'Costume',
  'Weapon',
  'Food/Drink',
  'Book/Paper',
  'Electronics',
  'Musical Instrument',
  'Hand Prop',
  'Set Dressing',
  'Special Effects',
  'Lighting',
  'Other'
] as const;
export type PropCategory = typeof propCategories[number];

export interface PropFormData {
  name: string;
  price: number;
  description?: string;
  category: PropCategory;
  length?: number;
  width?: number;
  height?: number;
  depth?: number;
  weight?: number;
  weightUnit?: WeightUnit;
  unit?: DimensionUnit;
  source: PropSource;
  sourceDetails?: string;
  purchaseUrl?: string;
  act?: number;
  scene?: number;
  sceneName?: string;
  isMultiScene?: boolean;
  isConsumable?: boolean;
  quantity: number;
  imageUrl?: string;
  images?: PropImage[];
  hasUsageInstructions?: boolean;
  usageInstructions?: string;
  hasMaintenanceNotes?: boolean;
  maintenanceNotes?: string;
  hasSafetyNotes?: boolean;
  safetyNotes?: string;
  handlingInstructions?: string;
  requiresPreShowSetup?: boolean;
  preShowSetupNotes?: string;
  preShowSetupVideo?: string;
  preShowSetupDuration?: number;
  hasOwnShippingCrate?: boolean;
  shippingCrateDetails?: string;
  transportNotes?: string;
  requiresSpecialTransport?: boolean;
  travelWeight?: number;
  hasBeenModified?: boolean;
  modificationDetails?: string;
  lastModifiedAt?: string;
  isRented?: boolean;
  rentalSource?: string;
  rentalDueDate?: string;
  rentalReferenceNumber?: string;
  digitalAssets?: DigitalAsset[];
  usageAssets?: DigitalAsset[];
  maintenanceAssets?: DigitalAsset[];
  travelsUnboxed?: boolean;
  status: PropLifecycleStatus;
  statusNotes?: string;
  lastStatusUpdate?: string;
  maintenanceHistory?: MaintenanceRecord[];
  statusHistory?: PropStatusUpdate[];
  lastInspectionDate?: string;
  nextInspectionDue?: string;
  lastMaintenanceDate?: string;
  nextMaintenanceDue?: string;
  location?: string;
  currentLocation?: string;
  expectedReturnDate?: string;
  replacementCost?: number;
  replacementLeadTime?: number;
  repairEstimate?: number;
  repairPriority?: RepairPriority;
  subcategory?: string;
  notes?: string;
  tags?: string[];
  customFields?: Record<string, any>;
  videos?: DigitalAsset[];
  purchaseDate?: string;
  condition?: string;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  barcode?: string;
  warranty?: {
    provider?: string;
    expirationDate?: string;
    details?: string;
  };
  materials?: string[];
  color?: string;
  period?: string;
  style?: string;
  sceneNotes?: string;
  usageNotes?: string;
  handedness?: string;
  isBreakable?: boolean;
  isHazardous?: boolean;
  storageRequirements?: string;
  rentalInfo?: {
    isRental?: boolean;
    provider?: string;
    rentalPeriod?: string;
    cost?: number;
  };
  returnDueDate?: string | Date | null;
  availabilityStatus?: string;
  publicNotes?: string;

  // Assignment for maintenance/repair/other statuses
  assignedTo?: string[]; // Array of user IDs assigned for maintenance/repair
  repairDeadline?: string;
  showId?: string;
}

export interface Prop {
  id: string;
  userId: string;
  showId: string;
  name: string;
  description?: string;
  category: PropCategory;
  price: number;
  quantity: number;
  length?: number;
  width?: number;
  height?: number;
  depth?: number;
  unit?: DimensionUnit;
  weight?: number;
  weightUnit?: WeightUnit;
  travelWeight?: number;
  source: PropSource;
  sourceDetails?: string;
  purchaseUrl?: string;
  rentalDueDate?: string;
  act?: number;
  scene?: number;
  sceneName?: string;
  isMultiScene?: boolean;
  isConsumable?: boolean;
  imageUrl?: string;
  usageInstructions?: string;
  maintenanceNotes?: string;
  safetyNotes?: string;
  handlingInstructions?: string;
  requiresPreShowSetup?: boolean;
  preShowSetupDuration?: number;
  preShowSetupNotes?: string;
  preShowSetupVideo?: string;
  setupTime?: number;
  hasOwnShippingCrate?: boolean;
  shippingCrateDetails?: string;
  requiresSpecialTransport?: boolean;
  transportMethod?: string;
  transportNotes?: string;
  status: PropLifecycleStatus;
  location?: string;
  currentLocation?: string;
  notes?: string;
  tags?: string[];
  images?: PropImage[];
  digitalAssets?: DigitalAsset[];
  videos?: DigitalAsset[];
  materials?: string[];
  statusHistory?: PropStatusUpdate[];
  maintenanceHistory?: MaintenanceRecord[];
  nextMaintenanceDue?: string;
  hasBeenModified?: boolean;
  modificationDetails?: string;
  createdAt: string;
  updatedAt: string;
  lastUsedAt?: string;
  condition?: string;
  lastUpdated?: string;
  purchaseDate?: string;
  handedness?: string;
  isBreakable?: boolean;
  isHazardous?: boolean;
  storageRequirements?: string;
  returnDueDate?: string | Date | null;
  lastModifiedAt?: string;
  isRented?: boolean;
  rentalSource?: string;
  rentalReferenceNumber?: string;
  travelsUnboxed?: boolean;
  statusNotes?: string;
  lastStatusUpdate?: string;
  lastInspectionDate?: string;
  nextInspectionDue?: string;
  lastMaintenanceDate?: string;
  expectedReturnDate?: string;
  replacementCost?: number;
  replacementLeadTime?: number;
  repairEstimate?: number;
  repairPriority?: RepairPriority;
  subcategory?: string;
  customFields?: Record<string, any>;
  manufacturer?: string;
  model?: string;
  serialNumber?: string;
  barcode?: string;
  warranty?: {
    provider?: string;
    expirationDate?: string;
    details?: string;
  };
  color?: string;
  period?: string;
  style?: string;
  sceneNotes?: string;
  usageNotes?: string;
  primaryImageUrl?: string;
  availabilityStatus?: string;
  publicNotes?: string;

  // New field for prop assignment to a box or location
  assignment?: {
    type: 'box' | 'location';
    id: string; // ID of the PackingBox or Location
    name?: string; // Optional: name of the box or location for quick display
    assignedAt?: string; // ISO date string for when it was assigned
  };

  // New field for details when prop is checked out
  checkedOutDetails?: {
    to?: string; // e.g., Actor name, Character name, Scene number
    notes?: string;
    checkedOutAt?: string; // ISO date string
    expectedReturnAt?: string; // ISO date string (optional)
  };

  // Assignment for maintenance/repair/other statuses
  assignedTo?: string[]; // Array of user IDs assigned for maintenance/repair
  assignedUserDetails?: { id: string; name: string; email?: string }[]; // Optional: denormalized user info for display

  estimatedDeliveryDate?: string; // ISO date string for expected delivery
  courier?: string; // Name of the courier
  trackingNumber?: string; // Tracking number for the delivery
}

export type PropUpdateFormData = Partial<PropFormData>;

// Show, Act, Scene definitions are now removed and re-exported from src/types/index.ts
// Venue, Contact, ShowCollaborator were already removed. 

```

```typescriptreact
import React, { useState, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories, PropCategory, PropImage, DigitalAsset } from '../../shared/types/props';
import { Plus, UploadCloud, Trash2 } from 'lucide-react';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const initialForm: PropFormData = {
  name: '',
  price: 0,
  description: '',
  category: propCategories[0],
  quantity: 1,
  source: 'bought',
  status: 'available_in_storage',
  images: [],
  digitalAssets: [],
  showId: '',
  // Additional fields to mirror mobile create form
  condition: '',
  location: '',
  currentLocation: '',
  statusNotes: '',
  isConsumable: false,
  requiresPreShowSetup: false,
  isBreakable: false,
  hasUsageInstructions: false,
  usageInstructions: '',
  hasMaintenanceNotes: false,
  maintenanceNotes: '',
  hasSafetyNotes: false,
  safetyNotes: '',
  hasOwnShippingCrate: false,
  requiresSpecialTransport: false,
  hasBeenModified: false,
  length: undefined,
  width: undefined,
  height: undefined,
  weight: undefined,
  materials: [],
  period: '',
};

const AddPropPage: React.FC = () => {
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData>(initialForm);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
  };

  const handleTagsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const tags = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => ({ ...prev, tags }));
  };

  const handleMaterialsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const materials = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => ({ ...prev, materials }));
  };

  const handleToggle = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, checked } = e.target;
    setForm(prev => ({ ...prev, [name]: checked } as PropFormData));
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      await firebaseService.addDocument('props', form);
      setSaving(false);
      navigate('/props');
    } catch (err: any) {
      setError(err.message || 'Failed to add prop.');
      setSaving(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Add Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={form.price ?? 0} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
                <option value="owned">Owned</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
                <option value="available_in_storage">available in storage</option>
              </select>
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Condition</label>
              <input name="condition" value={form.condition || ''} onChange={handleChange} placeholder="e.g., New, Used, Needs Repair" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
              <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Location</label>
              <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
              <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            {/* Dimensions & Weight */}
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Length</label>
              <input name="length" type="number" step="0.01" value={form.length ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Width</label>
              <input name="width" type="number" step="0.01" value={form.width ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Height</label>
              <input name="height" type="number" step="0.01" value={form.height ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Weight</label>
              <input name="weight" type="number" step="0.01" value={form.weight ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            {/* Materials & Period */}
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Materials (comma-separated)</label>
              <input name="materialsInput" value={(form.materials && form.materials.length > 0) ? form.materials.join(', ') : ''} onChange={handleMaterialsChange} placeholder="e.g., Wood, Metal, Plastic" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Historical Period</label>
              <input name="period" value={form.period || ''} onChange={handleChange} placeholder="e.g., Victorian, 1920s" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Tags (comma separated)</label>
              <input
                name="tagsInput"
                value={(form.tags && form.tags.length > 0) ? form.tags.join(', ') : ''}
                onChange={handleTagsChange}
                placeholder="e.g., weapon, medieval, stage-left"
                className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
              />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
          </div>
          {/* Details & Flags */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isConsumable" checked={!!form.isConsumable} onChange={handleToggle} />
              <span>Consumable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresPreShowSetup" checked={!!form.requiresPreShowSetup} onChange={handleToggle} />
              <span>Requires Pre-Show Setup</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isBreakable" checked={!!form.isBreakable} onChange={handleToggle} />
              <span>Breakable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasOwnShippingCrate" checked={!!form.hasOwnShippingCrate} onChange={handleToggle} />
              <span>Has Dedicated Shipping Crate</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresSpecialTransport" checked={!!form.requiresSpecialTransport} onChange={handleToggle} />
              <span>Requires Special Transport</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasBeenModified" checked={!!form.hasBeenModified} onChange={handleToggle} />
              <span>Has Been Modified</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasUsageInstructions" checked={!!form.hasUsageInstructions} onChange={handleToggle} />
              <span>Add Usage Instructions</span>
            </label>
            {form.hasUsageInstructions && (
              <div className="md:col-span-2">
                <textarea name="usageInstructions" value={form.usageInstructions || ''} onChange={handleChange} rows={3} placeholder="Enter usage instructions" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasMaintenanceNotes" checked={!!form.hasMaintenanceNotes} onChange={handleToggle} />
              <span>Add Maintenance Notes</span>
            </label>
            {form.hasMaintenanceNotes && (
              <div className="md:col-span-2">
                <textarea name="maintenanceNotes" value={form.maintenanceNotes || ''} onChange={handleChange} rows={3} placeholder="Enter maintenance notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasSafetyNotes" checked={!!form.hasSafetyNotes} onChange={handleToggle} />
              <span>Add Safety Notes</span>
            </label>
            {form.hasSafetyNotes && (
              <div className="md:col-span-2">
                <textarea name="safetyNotes" value={form.safetyNotes || ''} onChange={handleChange} rows={3} placeholder="Enter safety notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">General Notes</label>
              <textarea name="notes" value={(form as any).notes || ''} onChange={handleChange} rows={3} placeholder="Enter any other notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => ({ ...prev, images: imgs }))}
              currentImages={form.images || []}
              disabled={saving}
            />
            {/* Usage Assets */}
            <div className="mt-6">
              <h2 className="text-lg font-semibold text-white mb-2">Usage Assets</h2>
              <DigitalAssetForm
                assets={(form as any).usageAssets || []}
                onChange={assets => setForm(prev => ({ ...prev, usageAssets: assets }))}
                disabled={saving}
              />
            </div>
            {/* Maintenance Assets */}
            <div className="mt-6">
              <h2 className="text-lg font-semibold text-white mb-2">Maintenance Assets</h2>
              <DigitalAssetForm
                assets={(form as any).maintenanceAssets || []}
                onChange={assets => setForm(prev => ({ ...prev, maintenanceAssets: assets }))}
                disabled={saving}
              />
            </div>
            {/* General Digital Assets */}
            <div className="mt-6">
              <h2 className="text-lg font-semibold text-white mb-2">Other Digital Assets</h2>
              <DigitalAssetForm
                assets={form.digitalAssets || []}
                onChange={assets => setForm(prev => ({ ...prev, digitalAssets: assets }))}
                disabled={saving}
              />
            </div>
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Add Prop'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default AddPropPage; 
```

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories } from '../../shared/types/props';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const EditPropPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setForm(doc?.data as PropFormData || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form?.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form?.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => prev ? { ...prev, [name]: type === 'number' ? Number(value) : value } : prev);
  };

  const handleTagsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const tags = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => prev ? { ...prev, tags } : prev);
  };

  const handleMaterialsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const materials = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => prev ? { ...prev, materials } : prev);
  };

  const handleToggle = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, checked } = e.target;
    setForm(prev => prev ? { ...prev, [name]: checked } : prev);
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form || !id) return;
    setSaving(true);
    setError(null);
    try {
      await firebaseService.updateDocument('props', id, form);
      setSaving(false);
      navigate(`/props/${id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to update prop.');
      setSaving(false);
    }
  };

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !form) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Edit Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={(form.price ?? 0)} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
                <option value="available_in_storage">available in storage</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
                <option value="owned">Owned</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
            <div className="md:col-span-3">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
                <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Location</label>
                <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
                <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Condition</label>
                <input name="condition" value={form.condition || ''} onChange={handleChange} placeholder="e.g., New, Used, Needs Repair" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Length</label>
                <input name="length" type="number" step="0.01" value={form.length ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Width</label>
                <input name="width" type="number" step="0.01" value={form.width ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Height</label>
                <input name="height" type="number" step="0.01" value={form.height ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Weight</label>
                <input name="weight" type="number" step="0.01" value={form.weight ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div className="md:col-span-3">
                <label className="block text-pb-gray mb-1 font-medium">Materials (comma-separated)</label>
                <input
                  name="materialsInput"
                  value={(form.materials && form.materials.length > 0) ? form.materials.join(', ') : ''}
                  onChange={handleMaterialsChange}
                  placeholder="e.g., Wood, Metal, Plastic"
                  className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Historical Period</label>
                <input name="period" value={form.period || ''} onChange={handleChange} placeholder="e.g., Victorian, 1920s" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div className="md:col-span-3">
                <label className="block text-pb-gray mb-1 font-medium">Tags (comma separated)</label>
                <input
                  name="tagsInput"
                  value={(form.tags && form.tags.length > 0) ? form.tags.join(', ') : ''}
                  onChange={handleTagsChange}
                  placeholder="e.g., weapon, medieval, stage-left"
                  className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                />
              </div>
            </div>
            {/* Add more fields as needed for full prop coverage */}
          </div>
          {/* Details & Flags */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isConsumable" checked={!!form.isConsumable} onChange={handleToggle} />
              <span>Consumable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresPreShowSetup" checked={!!form.requiresPreShowSetup} onChange={handleToggle} />
              <span>Requires Pre-Show Setup</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isBreakable" checked={!!form.isBreakable} onChange={handleToggle} />
              <span>Breakable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasOwnShippingCrate" checked={!!form.hasOwnShippingCrate} onChange={handleToggle} />
              <span>Has Dedicated Shipping Crate</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresSpecialTransport" checked={!!form.requiresSpecialTransport} onChange={handleToggle} />
              <span>Requires Special Transport</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasBeenModified" checked={!!form.hasBeenModified} onChange={handleToggle} />
              <span>Has Been Modified</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasUsageInstructions" checked={!!form.hasUsageInstructions} onChange={handleToggle} />
              <span>Add Usage Instructions</span>
            </label>
            {form.hasUsageInstructions && (
              <div className="md:col-span-2">
                <textarea name="usageInstructions" value={form.usageInstructions || ''} onChange={handleChange} rows={3} placeholder="Enter usage instructions" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasMaintenanceNotes" checked={!!form.hasMaintenanceNotes} onChange={handleToggle} />
              <span>Add Maintenance Notes</span>
            </label>
            {form.hasMaintenanceNotes && (
              <div className="md:col-span-2">
                <textarea name="maintenanceNotes" value={form.maintenanceNotes || ''} onChange={handleChange} rows={3} placeholder="Enter maintenance notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasSafetyNotes" checked={!!form.hasSafetyNotes} onChange={handleToggle} />
              <span>Add Safety Notes</span>
            </label>
            {form.hasSafetyNotes && (
              <div className="md:col-span-2">
                <textarea name="safetyNotes" value={form.safetyNotes || ''} onChange={handleChange} rows={3} placeholder="Enter safety notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">General Notes</label>
              <textarea name="notes" value={(form as any).notes || ''} onChange={handleChange} rows={3} placeholder="Enter any other notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => prev ? { ...prev, images: imgs } : prev)}
              currentImages={form.images || []}
              disabled={saving}
            />
            {/* Usage Assets */}
            <div className="mt-6">
              <h2 className="text-lg font-semibold text-white mb-2">Usage Assets</h2>
              <DigitalAssetForm
                assets={(form as any).usageAssets || []}
                onChange={assets => setForm(prev => prev ? { ...prev, usageAssets: assets } : prev)}
                disabled={saving}
              />
            </div>
            {/* Maintenance Assets */}
            <div className="mt-6">
              <h2 className="text-lg font-semibold text-white mb-2">Maintenance Assets</h2>
              <DigitalAssetForm
                assets={(form as any).maintenanceAssets || []}
                onChange={assets => setForm(prev => prev ? { ...prev, maintenanceAssets: assets } : prev)}
                disabled={saving}
              />
            </div>
            {/* General Digital Assets */}
            <div className="mt-6">
              <h2 className="text-lg font-semibold text-white mb-2">Other Digital Assets</h2>
              <DigitalAssetForm
                assets={form.digitalAssets || []}
                onChange={assets => setForm(prev => prev ? { ...prev, digitalAssets: assets } : prev)}
                disabled={saving}
              />
            </div>
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Save Changes'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default EditPropPage; 
```

- Added support for attaching images/videos specifically to Usage and Maintenance in the web forms without touching anything outside `web-app`.
  - Types: extended `PropFormData` with `usageAssets?: DigitalAsset[]` and `maintenanceAssets?: DigitalAsset[]` in `web-app/shared/types/props.ts`.
  - AddProp: inserted three asset sections using existing `DigitalAssetForm`:
    - “Usage Assets” → binds to `usageAssets`
    - “Maintenance Assets” → binds to `maintenanceAssets`
    - “Other Digital Assets” → continues to bind `digitalAssets`
  - EditProp: same three sections wired to the corresponding fields.

These sections let users add links to images/videos (Drive or direct URLs) with validation and preview link, matching your existing asset UX. If you want file uploads instead of URLs for those sections, I can wire the `ImageUpload` or a storage upload flow there too.

---

**User**

move the usaage and maintenance assets form inputs to there respective fields

---

**Cursor**

I'll make edits to move the usage and maintenance asset inputs into their respective sections within the add and edit prop forms, and remove the separate sections. Then I'll lint the changed files.

```typescriptreact
import React, { useState, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories, PropCategory, PropImage, DigitalAsset } from '../../shared/types/props';
import { Plus, UploadCloud, Trash2 } from 'lucide-react';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const initialForm: PropFormData = {
  name: '',
  price: 0,
  description: '',
  category: propCategories[0],
  quantity: 1,
  source: 'bought',
  status: 'available_in_storage',
  images: [],
  digitalAssets: [],
  showId: '',
  // Additional fields to mirror mobile create form
  condition: '',
  location: '',
  currentLocation: '',
  statusNotes: '',
  isConsumable: false,
  requiresPreShowSetup: false,
  isBreakable: false,
  hasUsageInstructions: false,
  usageInstructions: '',
  hasMaintenanceNotes: false,
  maintenanceNotes: '',
  hasSafetyNotes: false,
  safetyNotes: '',
  hasOwnShippingCrate: false,
  requiresSpecialTransport: false,
  hasBeenModified: false,
  length: undefined,
  width: undefined,
  height: undefined,
  weight: undefined,
  materials: [],
  period: '',
};

const AddPropPage: React.FC = () => {
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData>(initialForm);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
  };

  const handleTagsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const tags = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => ({ ...prev, tags }));
  };

  const handleMaterialsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const materials = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => ({ ...prev, materials }));
  };

  const handleToggle = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, checked } = e.target;
    setForm(prev => ({ ...prev, [name]: checked } as PropFormData));
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      await firebaseService.addDocument('props', form);
      setSaving(false);
      navigate('/props');
    } catch (err: any) {
      setError(err.message || 'Failed to add prop.');
      setSaving(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Add Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={form.price ?? 0} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
                <option value="owned">Owned</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
                <option value="available_in_storage">available in storage</option>
              </select>
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Condition</label>
              <input name="condition" value={form.condition || ''} onChange={handleChange} placeholder="e.g., New, Used, Needs Repair" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
              <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Location</label>
              <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
              <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            {/* Dimensions & Weight */}
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Length</label>
              <input name="length" type="number" step="0.01" value={form.length ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Width</label>
              <input name="width" type="number" step="0.01" value={form.width ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Height</label>
              <input name="height" type="number" step="0.01" value={form.height ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Weight</label>
              <input name="weight" type="number" step="0.01" value={form.weight ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            {/* Materials & Period */}
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Materials (comma-separated)</label>
              <input name="materialsInput" value={(form.materials && form.materials.length > 0) ? form.materials.join(', ') : ''} onChange={handleMaterialsChange} placeholder="e.g., Wood, Metal, Plastic" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Historical Period</label>
              <input name="period" value={form.period || ''} onChange={handleChange} placeholder="e.g., Victorian, 1920s" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Tags (comma separated)</label>
              <input
                name="tagsInput"
                value={(form.tags && form.tags.length > 0) ? form.tags.join(', ') : ''}
                onChange={handleTagsChange}
                placeholder="e.g., weapon, medieval, stage-left"
                className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
              />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
          </div>
          {/* Details & Flags */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isConsumable" checked={!!form.isConsumable} onChange={handleToggle} />
              <span>Consumable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresPreShowSetup" checked={!!form.requiresPreShowSetup} onChange={handleToggle} />
              <span>Requires Pre-Show Setup</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isBreakable" checked={!!form.isBreakable} onChange={handleToggle} />
              <span>Breakable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasOwnShippingCrate" checked={!!form.hasOwnShippingCrate} onChange={handleToggle} />
              <span>Has Dedicated Shipping Crate</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresSpecialTransport" checked={!!form.requiresSpecialTransport} onChange={handleToggle} />
              <span>Requires Special Transport</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasBeenModified" checked={!!form.hasBeenModified} onChange={handleToggle} />
              <span>Has Been Modified</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasUsageInstructions" checked={!!form.hasUsageInstructions} onChange={handleToggle} />
              <span>Add Usage Instructions</span>
            </label>
            {form.hasUsageInstructions && (
              <div className="md:col-span-2">
                <textarea name="usageInstructions" value={form.usageInstructions || ''} onChange={handleChange} rows={3} placeholder="Enter usage instructions" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasMaintenanceNotes" checked={!!form.hasMaintenanceNotes} onChange={handleToggle} />
              <span>Add Maintenance Notes</span>
            </label>
            {form.hasMaintenanceNotes && (
              <div className="md:col-span-2">
                <textarea name="maintenanceNotes" value={form.maintenanceNotes || ''} onChange={handleChange} rows={3} placeholder="Enter maintenance notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasSafetyNotes" checked={!!form.hasSafetyNotes} onChange={handleToggle} />
              <span>Add Safety Notes</span>
            </label>
            {form.hasSafetyNotes && (
              <div className="md:col-span-2">
                <textarea name="safetyNotes" value={form.safetyNotes || ''} onChange={handleChange} rows={3} placeholder="Enter safety notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">General Notes</label>
              <textarea name="notes" value={(form as any).notes || ''} onChange={handleChange} rows={3} placeholder="Enter any other notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => ({ ...prev, images: imgs }))}
              currentImages={form.images || []}
              disabled={saving}
            />
            {/* General Digital Assets */}
            <div className="mt-6">
              <h2 className="text-lg font-semibold text-white mb-2">Other Digital Assets</h2>
              <DigitalAssetForm
                assets={form.digitalAssets || []}
                onChange={assets => setForm(prev => ({ ...prev, digitalAssets: assets }))}
                disabled={saving}
              />
            </div>
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Add Prop'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default AddPropPage; 
```

```typescriptreact
import React, { useState, useEffect } from 'react';
import { useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories, PropCategory, PropImage, DigitalAsset } from '../../shared/types/props';
import { Plus, UploadCloud, Trash2 } from 'lucide-react';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const initialForm: PropFormData = {
  name: '',
  price: 0,
  description: '',
  category: propCategories[0],
  quantity: 1,
  source: 'bought',
  status: 'available_in_storage',
  images: [],
  digitalAssets: [],
  showId: '',
  // Additional fields to mirror mobile create form
  condition: '',
  location: '',
  currentLocation: '',
  statusNotes: '',
  isConsumable: false,
  requiresPreShowSetup: false,
  isBreakable: false,
  hasUsageInstructions: false,
  usageInstructions: '',
  hasMaintenanceNotes: false,
  maintenanceNotes: '',
  hasSafetyNotes: false,
  safetyNotes: '',
  hasOwnShippingCrate: false,
  requiresSpecialTransport: false,
  hasBeenModified: false,
  length: undefined,
  width: undefined,
  height: undefined,
  weight: undefined,
  materials: [],
  period: '',
};

const AddPropPage: React.FC = () => {
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData>(initialForm);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => ({ ...prev, [name]: type === 'number' ? Number(value) : value }));
  };

  const handleTagsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const tags = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => ({ ...prev, tags }));
  };

  const handleMaterialsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const materials = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => ({ ...prev, materials }));
  };

  const handleToggle = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, checked } = e.target;
    setForm(prev => ({ ...prev, [name]: checked } as PropFormData));
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setSaving(true);
    setError(null);
    try {
      await firebaseService.addDocument('props', form);
      setSaving(false);
      navigate('/props');
    } catch (err: any) {
      setError(err.message || 'Failed to add prop.');
      setSaving(false);
    }
  };

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Add Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={form.price ?? 0} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
                <option value="owned">Owned</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
                <option value="available_in_storage">available in storage</option>
              </select>
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Condition</label>
              <input name="condition" value={form.condition || ''} onChange={handleChange} placeholder="e.g., New, Used, Needs Repair" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
              <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Location</label>
              <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
              <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            {/* Dimensions & Weight */}
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Length</label>
              <input name="length" type="number" step="0.01" value={form.length ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Width</label>
              <input name="width" type="number" step="0.01" value={form.width ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Height</label>
              <input name="height" type="number" step="0.01" value={form.height ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Weight</label>
              <input name="weight" type="number" step="0.01" value={form.weight ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            {/* Materials & Period */}
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Materials (comma-separated)</label>
              <input name="materialsInput" value={(form.materials && form.materials.length > 0) ? form.materials.join(', ') : ''} onChange={handleMaterialsChange} placeholder="e.g., Wood, Metal, Plastic" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Historical Period</label>
              <input name="period" value={form.period || ''} onChange={handleChange} placeholder="e.g., Victorian, 1920s" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">Tags (comma separated)</label>
              <input
                name="tagsInput"
                value={(form.tags && form.tags.length > 0) ? form.tags.join(', ') : ''}
                onChange={handleTagsChange}
                placeholder="e.g., weapon, medieval, stage-left"
                className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
              />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
          </div>
          {/* Details & Flags */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isConsumable" checked={!!form.isConsumable} onChange={handleToggle} />
              <span>Consumable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresPreShowSetup" checked={!!form.requiresPreShowSetup} onChange={handleToggle} />
              <span>Requires Pre-Show Setup</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isBreakable" checked={!!form.isBreakable} onChange={handleToggle} />
              <span>Breakable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasOwnShippingCrate" checked={!!form.hasOwnShippingCrate} onChange={handleToggle} />
              <span>Has Dedicated Shipping Crate</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresSpecialTransport" checked={!!form.requiresSpecialTransport} onChange={handleToggle} />
              <span>Requires Special Transport</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasBeenModified" checked={!!form.hasBeenModified} onChange={handleToggle} />
              <span>Has Been Modified</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasUsageInstructions" checked={!!form.hasUsageInstructions} onChange={handleToggle} />
              <span>Add Usage Instructions</span>
            </label>
            {form.hasUsageInstructions && (
              <div className="md:col-span-2">
                <textarea name="usageInstructions" value={form.usageInstructions || ''} onChange={handleChange} rows={3} placeholder="Enter usage instructions" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white mb-3" />
                <div>
                  <h3 className="text-sm font-medium text-gray-300 mb-2">Usage Assets</h3>
                  <DigitalAssetForm
                    assets={(form as any).usageAssets || []}
                    onChange={assets => setForm(prev => ({ ...prev, usageAssets: assets }))}
                    disabled={saving}
                  />
                </div>
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasMaintenanceNotes" checked={!!form.hasMaintenanceNotes} onChange={handleToggle} />
              <span>Add Maintenance Notes</span>
            </label>
            {form.hasMaintenanceNotes && (
              <div className="md:col-span-2">
                <textarea name="maintenanceNotes" value={form.maintenanceNotes || ''} onChange={handleChange} rows={3} placeholder="Enter maintenance notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white mb-3" />
                <div>
                  <h3 className="text-sm font-medium text-gray-300 mb-2">Maintenance Assets</h3>
                  <DigitalAssetForm
                    assets={(form as any).maintenanceAssets || []}
                    onChange={assets => setForm(prev => ({ ...prev, maintenanceAssets: assets }))}
                    disabled={saving}
                  />
                </div>
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasSafetyNotes" checked={!!form.hasSafetyNotes} onChange={handleToggle} />
              <span>Add Safety Notes</span>
            </label>
            {form.hasSafetyNotes && (
              <div className="md:col-span-2">
                <textarea name="safetyNotes" value={form.safetyNotes || ''} onChange={handleChange} rows={3} placeholder="Enter safety notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">General Notes</label>
              <textarea name="notes" value={(form as any).notes || ''} onChange={handleChange} rows={3} placeholder="Enter any other notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => ({ ...prev, images: imgs }))}
              currentImages={form.images || []}
              disabled={saving}
            />
            {/* General Digital Assets */}
            <div className="mt-6">
              <h2 className="text-lg font-semibold text-white mb-2">Other Digital Assets</h2>
              <DigitalAssetForm
                assets={form.digitalAssets || []}
                onChange={assets => setForm(prev => ({ ...prev, digitalAssets: assets }))}
                disabled={saving}
              />
            </div>
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Add Prop'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default AddPropPage; 
```

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories } from '../../shared/types/props';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const EditPropPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setForm(doc?.data as PropFormData || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form?.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form?.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => prev ? { ...prev, [name]: type === 'number' ? Number(value) : value } : prev);
  };

  const handleTagsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const tags = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => prev ? { ...prev, tags } : prev);
  };

  const handleMaterialsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const materials = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => prev ? { ...prev, materials } : prev);
  };

  const handleToggle = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, checked } = e.target;
    setForm(prev => prev ? { ...prev, [name]: checked } : prev);
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form || !id) return;
    setSaving(true);
    setError(null);
    try {
      await firebaseService.updateDocument('props', id, form);
      setSaving(false);
      navigate(`/props/${id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to update prop.');
      setSaving(false);
    }
  };

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !form) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Edit Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={(form.price ?? 0)} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
                <option value="available_in_storage">available in storage</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
                <option value="owned">Owned</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
            <div className="md:col-span-3">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
                <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Location</label>
                <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
                <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Condition</label>
                <input name="condition" value={form.condition || ''} onChange={handleChange} placeholder="e.g., New, Used, Needs Repair" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Length</label>
                <input name="length" type="number" step="0.01" value={form.length ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Width</label>
                <input name="width" type="number" step="0.01" value={form.width ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Height</label>
                <input name="height" type="number" step="0.01" value={form.height ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Weight</label>
                <input name="weight" type="number" step="0.01" value={form.weight ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div className="md:col-span-3">
                <label className="block text-pb-gray mb-1 font-medium">Materials (comma-separated)</label>
                <input
                  name="materialsInput"
                  value={(form.materials && form.materials.length > 0) ? form.materials.join(', ') : ''}
                  onChange={handleMaterialsChange}
                  placeholder="e.g., Wood, Metal, Plastic"
                  className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Historical Period</label>
                <input name="period" value={form.period || ''} onChange={handleChange} placeholder="e.g., Victorian, 1920s" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div className="md:col-span-3">
                <label className="block text-pb-gray mb-1 font-medium">Tags (comma separated)</label>
                <input
                  name="tagsInput"
                  value={(form.tags && form.tags.length > 0) ? form.tags.join(', ') : ''}
                  onChange={handleTagsChange}
                  placeholder="e.g., weapon, medieval, stage-left"
                  className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                />
              </div>
            </div>
            {/* Add more fields as needed for full prop coverage */}
          </div>
          {/* Details & Flags */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isConsumable" checked={!!form.isConsumable} onChange={handleToggle} />
              <span>Consumable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresPreShowSetup" checked={!!form.requiresPreShowSetup} onChange={handleToggle} />
              <span>Requires Pre-Show Setup</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isBreakable" checked={!!form.isBreakable} onChange={handleToggle} />
              <span>Breakable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasOwnShippingCrate" checked={!!form.hasOwnShippingCrate} onChange={handleToggle} />
              <span>Has Dedicated Shipping Crate</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresSpecialTransport" checked={!!form.requiresSpecialTransport} onChange={handleToggle} />
              <span>Requires Special Transport</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasBeenModified" checked={!!form.hasBeenModified} onChange={handleToggle} />
              <span>Has Been Modified</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasUsageInstructions" checked={!!form.hasUsageInstructions} onChange={handleToggle} />
              <span>Add Usage Instructions</span>
            </label>
            {form.hasUsageInstructions && (
              <div className="md:col-span-2">
                <textarea name="usageInstructions" value={form.usageInstructions || ''} onChange={handleChange} rows={3} placeholder="Enter usage instructions" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasMaintenanceNotes" checked={!!form.hasMaintenanceNotes} onChange={handleToggle} />
              <span>Add Maintenance Notes</span>
            </label>
            {form.hasMaintenanceNotes && (
              <div className="md:col-span-2">
                <textarea name="maintenanceNotes" value={form.maintenanceNotes || ''} onChange={handleChange} rows={3} placeholder="Enter maintenance notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasSafetyNotes" checked={!!form.hasSafetyNotes} onChange={handleToggle} />
              <span>Add Safety Notes</span>
            </label>
            {form.hasSafetyNotes && (
              <div className="md:col-span-2">
                <textarea name="safetyNotes" value={form.safetyNotes || ''} onChange={handleChange} rows={3} placeholder="Enter safety notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">General Notes</label>
              <textarea name="notes" value={(form as any).notes || ''} onChange={handleChange} rows={3} placeholder="Enter any other notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => prev ? { ...prev, images: imgs } : prev)}
              currentImages={form.images || []}
              disabled={saving}
            />
            {/* General Digital Assets */}
            <div className="mt-6">
              <h2 className="text-lg font-semibold text-white mb-2">Other Digital Assets</h2>
              <DigitalAssetForm
                assets={form.digitalAssets || []}
                onChange={assets => setForm(prev => prev ? { ...prev, digitalAssets: assets } : prev)}
                disabled={saving}
              />
            </div>
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Save Changes'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default EditPropPage; 
```

```typescriptreact
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { useFirebase } from '../contexts/FirebaseContext';
import DashboardLayout from '../PropsBibleHomepage';
import { motion } from 'framer-motion';
import { Prop, PropFormData, propCategories } from '../../shared/types/props';
import { ImageUpload } from '../components/ImageUpload';
import { DigitalAssetForm } from '../components/DigitalAssetForm';

const EditPropPage: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const { service: firebaseService } = useFirebase();
  const [form, setForm] = useState<PropFormData | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const navigate = useNavigate();
  const [showOptions, setShowOptions] = useState<{ id: string; name: string }[]>([]);
  const [actOptions, setActOptions] = useState<{ id: string; name: string }[]>([]);
  const [sceneOptions, setSceneOptions] = useState<{ id: string; name: string }[]>([]);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    firebaseService.getDocument('props', id)
      .then(doc => {
        setForm(doc?.data as PropFormData || null);
        setLoading(false);
      })
      .catch(() => {
        setError('Failed to load prop.');
        setLoading(false);
      });
  }, [id, firebaseService]);

  // Fetch shows for assignment
  useEffect(() => {
    firebaseService.getDocuments('shows').then(docs => {
      setShowOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [firebaseService]);

  // Fetch acts/scenes when show changes
  useEffect(() => {
    if (!form?.showId) return;
    firebaseService.getDocuments('acts', { where: [['showId', '==', form.showId]] }).then(docs => {
      setActOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
    firebaseService.getDocuments('scenes', { where: [['showId', '==', form.showId]] }).then(docs => {
      setSceneOptions(docs.map(doc => ({ id: doc.id, name: doc.data.name })));
    });
  }, [form?.showId, firebaseService]);

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    setForm(prev => prev ? { ...prev, [name]: type === 'number' ? Number(value) : value } : prev);
  };

  const handleTagsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const tags = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => prev ? { ...prev, tags } : prev);
  };

  const handleMaterialsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const raw = e.target.value;
    const materials = raw
      .split(',')
      .map(t => t.trim())
      .filter(Boolean);
    setForm(prev => prev ? { ...prev, materials } : prev);
  };

  const handleToggle = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, checked } = e.target;
    setForm(prev => prev ? { ...prev, [name]: checked } : prev);
  };

  // TODO: Implement image and digital asset upload logic

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!form || !id) return;
    setSaving(true);
    setError(null);
    try {
      await firebaseService.updateDocument('props', id, form);
      setSaving(false);
      navigate(`/props/${id}`);
    } catch (err: any) {
      setError(err.message || 'Failed to update prop.');
      setSaving(false);
    }
  };

  if (loading) return <DashboardLayout><div className="text-center text-pb-primary py-16">Loading prop...</div></DashboardLayout>;
  if (error || !form) return <DashboardLayout><div className="text-center text-red-500 py-16">{error || 'Prop not found.'}</div></DashboardLayout>;

  return (
    <DashboardLayout>
      <div className="flex flex-col min-h-screen w-full max-w-none p-6">
        <div className="mb-4 flex justify-end">
          <Link to="/props" className="inline-flex items-center px-4 py-2 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-semibold shadow transition">
            View Props List
          </Link>
        </div>
        <motion.form onSubmit={handleSubmit} initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.3 }} className="bg-pb-darker/60 rounded-xl shadow-lg p-8 space-y-6">
          <h1 className="text-2xl font-bold text-white mb-4">Edit Prop</h1>
          {error && <div className="text-red-500 mb-2">{error}</div>}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Name *</label>
              <input name="name" value={form.name} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Category *</label>
              <select name="category" value={form.category} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                {propCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Quantity *</label>
              <input name="quantity" type="number" min={1} value={form.quantity} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Price</label>
              <input name="price" type="number" min={0} step="0.01" value={(form.price ?? 0)} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Status *</label>
              <select name="status" value={form.status} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="to-be-made">to be made</option>
                <option value="to-be-bought">to be bought</option>
                <option value="awaiting-delivery">awaiting delivery</option>
                <option value="part-of-the-show">part of the show</option>
                <option value="share">share</option>
                <option value="replacement-needed">replacment needed</option>
                <option value="needs-repair-mod">needs repair/mod</option>
                <option value="cut">cut</option>
                <option value="on-hold">on hold</option>
                <option value="available_in_storage">available in storage</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Source</label>
              <select name="source" value={(form as any).source ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Source</option>
                <option value="bought">Bought</option>
                <option value="rented">Rented</option>
                <option value="made">Made</option>
                <option value="borrowed">Borrowed</option>
                <option value="owned">Owned</option>
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Show *</label>
              <select name="showId" value={form.showId} onChange={handleChange} required className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Show</option>
                {showOptions.map(show => <option key={show.id} value={show.id}>{show.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Act</label>
              <select name="act" value={form.act || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Act</option>
                {actOptions.map(act => <option key={act.id} value={act.name}>{act.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-pb-gray mb-1 font-medium">Scene</label>
              <select name="sceneName" value={form.sceneName || ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white">
                <option value="">Select Scene</option>
                {sceneOptions.map(scene => <option key={scene.id} value={scene.name}>{scene.name}</option>)}
              </select>
            </div>
            <div className="md:col-span-3">
              <label className="block text-pb-gray mb-1 font-medium">Description</label>
              <textarea name="description" value={form.description} onChange={handleChange} rows={3} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
            <div className="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Purchase URL</label>
                <input name="purchaseUrl" value={(form as any).purchaseUrl ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Location</label>
                <input name="location" value={(form as any).location ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Current Location</label>
                <input name="currentLocation" value={(form as any).currentLocation ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Condition</label>
                <input name="condition" value={form.condition || ''} onChange={handleChange} placeholder="e.g., New, Used, Needs Repair" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Length</label>
                <input name="length" type="number" step="0.01" value={form.length ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Width</label>
                <input name="width" type="number" step="0.01" value={form.width ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Height</label>
                <input name="height" type="number" step="0.01" value={form.height ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Weight</label>
                <input name="weight" type="number" step="0.01" value={form.weight ?? ''} onChange={handleChange} className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div className="md:col-span-3">
                <label className="block text-pb-gray mb-1 font-medium">Materials (comma-separated)</label>
                <input
                  name="materialsInput"
                  value={(form.materials && form.materials.length > 0) ? form.materials.join(', ') : ''}
                  onChange={handleMaterialsChange}
                  placeholder="e.g., Wood, Metal, Plastic"
                  className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                />
              </div>
              <div>
                <label className="block text-pb-gray mb-1 font-medium">Historical Period</label>
                <input name="period" value={form.period || ''} onChange={handleChange} placeholder="e.g., Victorian, 1920s" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
              <div className="md:col-span-3">
                <label className="block text-pb-gray mb-1 font-medium">Tags (comma separated)</label>
                <input
                  name="tagsInput"
                  value={(form.tags && form.tags.length > 0) ? form.tags.join(', ') : ''}
                  onChange={handleTagsChange}
                  placeholder="e.g., weapon, medieval, stage-left"
                  className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white"
                />
              </div>
            </div>
            {/* Add more fields as needed for full prop coverage */}
          </div>
          {/* Details & Flags */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isConsumable" checked={!!form.isConsumable} onChange={handleToggle} />
              <span>Consumable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresPreShowSetup" checked={!!form.requiresPreShowSetup} onChange={handleToggle} />
              <span>Requires Pre-Show Setup</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="isBreakable" checked={!!form.isBreakable} onChange={handleToggle} />
              <span>Breakable</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasOwnShippingCrate" checked={!!form.hasOwnShippingCrate} onChange={handleToggle} />
              <span>Has Dedicated Shipping Crate</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="requiresSpecialTransport" checked={!!form.requiresSpecialTransport} onChange={handleToggle} />
              <span>Requires Special Transport</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray">
              <input type="checkbox" name="hasBeenModified" checked={!!form.hasBeenModified} onChange={handleToggle} />
              <span>Has Been Modified</span>
            </label>
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasUsageInstructions" checked={!!form.hasUsageInstructions} onChange={handleToggle} />
              <span>Add Usage Instructions</span>
            </label>
            {form.hasUsageInstructions && (
              <div className="md:col-span-2">
                <textarea name="usageInstructions" value={form.usageInstructions || ''} onChange={handleChange} rows={3} placeholder="Enter usage instructions" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white mb-3" />
                <div>
                  <h3 className="text-sm font-medium text-gray-300 mb-2">Usage Assets</h3>
                  <DigitalAssetForm
                    assets={(form as any).usageAssets || []}
                    onChange={assets => setForm(prev => prev ? { ...prev, usageAssets: assets } : prev)}
                    disabled={saving}
                  />
                </div>
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasMaintenanceNotes" checked={!!form.hasMaintenanceNotes} onChange={handleToggle} />
              <span>Add Maintenance Notes</span>
            </label>
            {form.hasMaintenanceNotes && (
              <div className="md:col-span-2">
                <textarea name="maintenanceNotes" value={form.maintenanceNotes || ''} onChange={handleChange} rows={3} placeholder="Enter maintenance notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white mb-3" />
                <div>
                  <h3 className="text-sm font-medium text-gray-300 mb-2">Maintenance Assets</h3>
                  <DigitalAssetForm
                    assets={(form as any).maintenanceAssets || []}
                    onChange={assets => setForm(prev => prev ? { ...prev, maintenanceAssets: assets } : prev)}
                    disabled={saving}
                  />
                </div>
              </div>
            )}
            <label className="inline-flex items-center gap-2 text-pb-gray md:col-span-2">
              <input type="checkbox" name="hasSafetyNotes" checked={!!form.hasSafetyNotes} onChange={handleToggle} />
              <span>Add Safety Notes</span>
            </label>
            {form.hasSafetyNotes && (
              <div className="md:col-span-2">
                <textarea name="safetyNotes" value={form.safetyNotes || ''} onChange={handleChange} rows={3} placeholder="Enter safety notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
              </div>
            )}
            <div className="md:col-span-2">
              <label className="block text-pb-gray mb-1 font-medium">General Notes</label>
              <textarea name="notes" value={(form as any).notes || ''} onChange={handleChange} rows={3} placeholder="Enter any other notes" className="w-full rounded bg-pb-darker border border-pb-primary/30 p-2 text-white" />
            </div>
          </div>
          <div className="space-y-4">
            <ImageUpload
              onImagesChange={imgs => setForm(prev => prev ? { ...prev, images: imgs } : prev)}
              currentImages={form.images || []}
              disabled={saving}
            />
            {/* General Digital Assets */}
            <div className="mt-6">
              <h2 className="text-lg font-semibold text-white mb-2">Other Digital Assets</h2>
              <DigitalAssetForm
                assets={form.digitalAssets || []}
                onChange={assets => setForm(prev => prev ? { ...prev, digitalAssets: assets } : prev)}
                disabled={saving}
              />
            </div>
          </div>
          <button type="submit" disabled={saving} className="w-full py-3 rounded-lg bg-pb-primary hover:bg-pb-accent text-white font-bold text-lg shadow transition disabled:opacity-60 disabled:cursor-not-allowed mt-4">{saving ? 'Saving...' : 'Save Changes'}</button>
        </motion.form>
      </div>
    </DashboardLayout>
  );
};

export default EditPropPage; 
```

- Moved the usage and maintenance asset inputs into their respective sections:
  - When “Add Usage Instructions” is enabled, a “Usage Assets” uploader appears right below the usage textarea and binds to `usageAssets`.
  - When “Add Maintenance Notes” is enabled, a “Maintenance Assets” uploader appears below the maintenance textarea and binds to `maintenanceAssets`.
- Kept the general “Other Digital Assets” section for non-specific files.
- Types updated in `web-app/shared/types/props.ts` to include `usageAssets` and `maintenanceAssets`.

Files edited:
- `web-app/src/pages/AddPropPage.tsx`
- `web-app/src/pages/EditPropPage.tsx`
- `web-app/shared/types/props.ts`

Let me know if you want these asset sections to be shown even when the corresponding toggles are off.

