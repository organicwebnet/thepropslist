name: Monitor Test Failures

on:
  workflow_run:
    workflows: ["Basic Test", "Simple Test"]
    types: [completed]

jobs:
  monitor:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Analyze Failure
      run: |
        echo "üîç Analyzing workflow failure..."
        echo "Workflow: ${{ github.event.workflow_run.name }}"
        echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
        echo "Head Branch: ${{ github.event.workflow_run.head_branch }}"
        echo "Run ID: ${{ github.event.workflow_run.id }}"
        
        # Check if it's a test failure
        if [[ "${{ github.event.workflow_run.name }}" == *"Test"* ]]; then
          echo "üß™ Test failure detected"
          echo "Common test failure causes:"
          echo "1. Firebase configuration issues"
          echo "2. Network connectivity problems"
          echo "3. Test environment setup issues"
          echo "4. Playwright browser issues"
        fi
        
        # Check if it's a build failure
        if [[ "${{ github.event.workflow_run.name }}" == *"CI/CD"* ]]; then
          echo "üî® Build failure detected"
          echo "Common build failure causes:"
          echo "1. TypeScript compilation errors"
          echo "2. Missing dependencies"
          echo "3. Linting errors"
          echo "4. Firebase deployment issues"
        fi

    - name: Log Failure Details
      if: ${{ github.event.workflow_run.conclusion == 'failure' }}
      run: |
        echo "üö® Workflow Failure Detected"
        echo "Workflow: ${{ github.event.workflow_run.name }}"
        echo "Branch: ${{ github.event.workflow_run.head_branch }}"
        echo "Run ID: ${{ github.event.workflow_run.id }}"
        echo "URL: ${{ github.event.workflow_run.html_url }}"
        echo ""
        echo "Please check the workflow logs for detailed error information."
        echo "Common issues:"
        echo "- Firebase configuration problems"
        echo "- Test environment setup issues"
        echo "- Network connectivity problems"
        echo "- Dependency installation failures"

    - name: Notify on Slack (if configured)
      if: ${{ github.event.workflow_run.conclusion == 'failure' }}
      run: |
        echo "üì¢ Would notify Slack about failure (if webhook configured)"
        echo "Workflow: ${{ github.event.workflow_run.name }}"
        echo "Status: Failed"
        echo "Branch: ${{ github.event.workflow_run.head_branch }}"
